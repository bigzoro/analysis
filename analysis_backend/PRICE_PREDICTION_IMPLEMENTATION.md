# 价格预测功能实现说明

## 功能概述

已成功实现价格预测功能，基于技术指标、历史数据和市场趋势，预测币种在未来24小时、7天、30天的价格走势。该功能能够：

1. **多时间周期预测**：24小时、7天、30天
2. **多方法融合**：技术指标、移动平均、统计方法、成交量分析
3. **置信度评估**：为每个预测提供置信度评分
4. **价格区间**：提供预测价格的可能区间
5. **预测依据**：说明预测的主要依据

## 实现文件

### 1. `analysis_backend/internal/server/price_prediction.go`（新建）

核心价格预测模块，包含以下功能：

#### 主要函数

- **`GetPricePrediction`**: 获取价格预测
  - 获取当前价格
  - 获取K线数据（500根1小时K线）
  - 获取技术指标
  - 计算24小时、7天、30天预测
  - 生成预测依据和趋势

- **`predictPrice`**: 预测价格（核心算法）
  - 使用4种方法预测：技术指标、移动平均、统计方法、成交量
  - 加权平均得到最终预测
  - 计算置信度和价格区间

- **`predictByTechnical`**: 基于技术指标预测
- **`predictByMovingAverage`**: 基于移动平均预测
- **`predictByStatistics`**: 基于统计方法预测
- **`predictByVolume`**: 基于成交量预测

#### 数据结构

```go
type PricePrediction struct {
    Symbol          string
    CurrentPrice    float64
    PredictedAt     time.Time
    
    // 24小时预测
    Pred24h         float64
    Change24h       float64   // 涨跌幅 %
    Confidence24h   float64   // 置信度 0-100
    Range24h        PriceRange
    
    // 7天预测
    Pred7d          float64
    Change7d        float64
    Confidence7d    float64
    Range7d         PriceRange
    
    // 30天预测
    Pred30d         float64
    Change30d       float64
    Confidence30d   float64
    Range30d        PriceRange
    
    Factors         []string  // 预测依据
    Trend           string    // "bullish"/"bearish"/"neutral"
}

type PriceRange struct {
    Min float64 // 最低价
    Max float64 // 最高价
    Avg float64 // 平均价
}
```

### 2. `analysis_backend/internal/server/recommendation.go`（修改）

#### 修改内容

1. **在`RecommendationScore`中添加`Prediction`字段**：
   ```go
   Prediction *PricePrediction
   ```

2. **在`GetRecommendations`中集成价格预测**：
   - 为每个推荐结果实时计算价格预测
   - 同步获取预测数据（避免异步问题）

3. **在`formatRecommendations`中返回预测数据**：
   - 预测数据不存储在数据库中，实时计算
   - 在API响应中包含预测结果

## 预测算法详解

### 1. 基于技术指标的预测

**方法**：
- 根据趋势（up/down/sideways）调整预测
- RSI超买/超卖调整
- MACD金叉/死叉调整
- 均线排列调整
- 时间衰减（预测时间越长，趋势影响越小）

**公式**：
```
预测价格 = 当前价格 * 趋势因子 * RSI因子 * MACD因子 * 均线因子 * 时间衰减
```

**置信度**：0.4-0.7（基于指标一致性）

### 2. 基于移动平均的预测

**方法**：
- 计算短期均线（MA5）和长期均线（MA20）的斜率
- 使用斜率预测未来价格

**公式**：
```
斜率 = (短期价格变化 + 长期价格变化) / 2
预测价格 = 当前价格 * (1 + 斜率 * 时间因子 * 0.5)
```

**置信度**：0.3-0.7（均线越接近，置信度越高）

### 3. 基于统计方法的预测

**方法**：
- 计算历史平均收益率
- 使用历史收益率预测未来价格

**公式**：
```
平均收益率 = sum(历史收益率) / 周期数
预测价格 = 当前价格 * (1 + 平均收益率)^时间
```

**置信度**：0.2-0.6（波动率越低，置信度越高）

### 4. 基于成交量的预测

**方法**：
- 分析成交量比率（当前成交量/20日均量）
- 结合价格动量预测

**公式**：
```
成交量因子 = 1.0（如果成交量比率 > 1.2，则 1.01；< 0.8，则 0.99）
价格动量 = 最近5个周期的平均涨跌幅
预测价格 = 当前价格 * (1 + 动量 * 成交量因子)^(时间 * 0.3)
```

**置信度**：0.3-0.6（成交量比率越极端，置信度越高）

### 5. 加权平均

**方法**：
- 使用置信度作为权重，对4种方法的预测结果进行加权平均

**公式**：
```
最终预测 = (技术预测*技术置信度 + 均线预测*均线置信度 + 
           统计预测*统计置信度 + 成交量预测*成交量置信度) / 总权重
最终置信度 = (技术置信度 + 均线置信度 + 统计置信度 + 成交量置信度) / 4
```

### 6. 价格区间计算

**方法**：
- 基于历史波动率计算价格区间

**公式**：
```
波动率 = sqrt(收益率方差)
区间宽度 = 预测价格 * 波动率 * sqrt(时间/24) * 0.5
价格区间 = [预测价格 - 区间宽度, 预测价格 + 区间宽度]
```

## 预测依据生成

系统会根据以下因素生成预测依据：

1. **技术指标**：
   - "技术指标显示上涨趋势"
   - "RSI超买，可能回调"
   - "MACD金叉，技术面看涨"
   - "均线多头排列"

2. **成交量**：
   - "成交量显著放大"
   - "成交量萎缩"

3. **波动率**：
   - "波动率较高，价格波动可能较大"
   - "波动率较低，价格相对稳定"

## 趋势判断

根据24小时、7天、30天的预测涨跌幅，计算加权平均：

```
平均涨跌幅 = 24h涨跌幅 * 0.5 + 7d涨跌幅 * 0.3 + 30d涨跌幅 * 0.2
```

- **bullish**：平均涨跌幅 > 5%
- **bearish**：平均涨跌幅 < -5%
- **neutral**：其他情况

## 使用示例

### API响应示例

```json
{
  "symbol": "BTCUSDT",
  "current_price": 45000.0,
  "predicted_at": "2025-01-20T12:00:00Z",
  "pred_24h": 45500.0,
  "change_24h": 1.11,
  "confidence_24h": 65.5,
  "range_24h": {
    "min": 44800.0,
    "max": 46200.0,
    "avg": 45500.0
  },
  "pred_7d": 47000.0,
  "change_7d": 4.44,
  "confidence_7d": 58.2,
  "range_7d": {
    "min": 45500.0,
    "max": 48500.0,
    "avg": 47000.0
  },
  "pred_30d": 50000.0,
  "change_30d": 11.11,
  "confidence_30d": 45.0,
  "range_30d": {
    "min": 48000.0,
    "max": 52000.0,
    "avg": 50000.0
  },
  "factors": [
    "技术指标显示上涨趋势",
    "MACD金叉，技术面看涨",
    "均线多头排列",
    "成交量显著放大"
  ],
  "trend": "bullish"
}
```

## 数据流程

```
1. 获取当前价格（从Binance API或市场快照）
   ↓
2. 获取K线数据（500根1小时K线）
   ↓
3. 提取价格序列和成交量序列
   ↓
4. 获取技术指标（RSI、MACD、均线等）
   ↓
5. 使用4种方法分别预测：
   - 技术指标方法
   - 移动平均方法
   - 统计方法
   - 成交量方法
   ↓
6. 加权平均得到最终预测
   ↓
7. 计算置信度和价格区间
   ↓
8. 生成预测依据和趋势
   ↓
9. 返回预测结果
```

## 注意事项

1. **数据要求**：需要至少60根K线数据才能进行预测
2. **预测准确性**：短期预测（24小时）通常比长期预测（30天）更准确
3. **置信度**：置信度越高，预测越可靠
4. **价格区间**：实际价格可能在预测区间内波动
5. **市场风险**：加密货币市场波动性大，预测仅供参考

## 后续优化建议

1. **机器学习模型**：使用LSTM、GRU等深度学习模型
2. **更多特征**：加入资金流、情绪、公告等特征
3. **集成学习**：使用随机森林、XGBoost等集成方法
4. **实时更新**：定期更新预测结果
5. **历史验证**：追踪预测准确性，优化模型参数

## 总结

价格预测功能已成功集成到推荐系统中，能够：

- ✅ 多时间周期预测（24h、7d、30d）
- ✅ 多方法融合（技术指标、移动平均、统计、成交量）
- ✅ 置信度评估（0-100分）
- ✅ 价格区间预测（最小、最大、平均）
- ✅ 预测依据说明（技术面、成交量、波动率等）
- ✅ 趋势判断（看涨/看跌/中性）
- ✅ 实时计算（不存储在数据库，每次请求实时计算）

该功能为推荐系统增加了价格预测能力，帮助用户更好地了解币种的未来走势，做出更明智的投资决策。

