# æ•°æ®åŒæ­¥æœåŠ¡ (Data Sync Service)

è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºåŒæ­¥æœŸç°å¥—åˆ©ç­–ç•¥æ‰€éœ€å„ç§å¸‚åœºæ•°æ®çš„æœåŠ¡ã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ”¯æŒçš„æ•°æ®ç±»å‹
- âœ… **å®æ—¶ä»·æ ¼æ•°æ®**ï¼šç°è´§å’ŒæœŸè´§ä»·æ ¼
- âœ… **Kçº¿å†å²æ•°æ®**ï¼šå¤šæ—¶é—´é—´éš”çš„å†å²Kçº¿
- âœ… **æœŸè´§åˆçº¦ä¿¡æ¯**ï¼šåˆ°æœŸæ—¶é—´ã€åˆçº¦ç±»å‹
- âœ… **èµ„é‡‘è´¹ç‡**ï¼šæ°¸ç»­åˆçº¦èµ„é‡‘è´¹ç‡
- âœ… **è®¢å•ç°¿æ·±åº¦**ï¼šä¹°å–æ·±åº¦æ•°æ®
- âœ… **äº¤æ˜“é‡ç»Ÿè®¡**ï¼š24å°æ—¶äº¤æ˜“ç»Ÿè®¡
- ğŸ†• **WebSocketæµæ•°æ®**ï¼šå®æ—¶ä»·æ ¼æµï¼ˆå®éªŒæ€§ï¼‰

### æœåŠ¡ç‰¹æ€§
- ğŸ”„ **å¤šçº¿ç¨‹åŒæ­¥**ï¼šä¸åŒæ•°æ®ç±»å‹ç‹¬ç«‹åŒæ­¥
- ğŸ“Š **å®æ—¶ç›‘æ§**ï¼šåŒæ­¥çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
- ğŸ” **è‡ªåŠ¨é‡è¯•**ï¼šç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•æœºåˆ¶
- âš¡ **é«˜æ€§èƒ½**ï¼šæ‰¹é‡å¤„ç†å’Œè¿æ¥æ± ä¼˜åŒ–
- ğŸ›¡ï¸ **å®¹é”™è®¾è®¡**ï¼šå•ç‚¹å¤±è´¥ä¸å½±å“å…¶ä»–åŒæ­¥
- ğŸ”— **Redisç¼“å­˜**ï¼šè·¨æœåŠ¡å…±äº«æ— æ•ˆç¬¦å·ç¼“å­˜

## å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘æœåŠ¡
```bash
cd analysis_backend
go build -o bin/data_sync ./cmd/data_sync
```

### 2. å¯åŠ¨æœåŠ¡
```bash
# æ–¹å¼1ï¼šä½¿ç”¨ä¸»é…ç½®æ–‡ä»¶ä¸­çš„data_syncæ®µï¼ˆæ¨èï¼‰
./bin/data_sync -config ./config.yaml

# æ–¹å¼2ï¼šä½¿ç”¨ç‹¬ç«‹çš„åŒæ­¥é…ç½®æ–‡ä»¶
./bin/data_sync -config ./config.yaml -config-file ./cmd/data_sync/config.example.yaml

# æ–¹å¼3ï¼šä»…ä½¿ç”¨åŒæ­¥é…ç½®æ–‡ä»¶ï¼ˆä¸åŠ è½½ä¸»é…ç½®ï¼‰
./bin/data_sync -config-file ./cmd/data_sync/config.example.yaml
```

### 3. å•æ¬¡åŒæ­¥æµ‹è¯•
```bash
# åŒæ­¥ä»·æ ¼æ•°æ®
./bin/data_sync -action sync-once -syncer price

# åŒæ­¥Kçº¿æ•°æ®
./bin/data_sync -action sync-once -syncer kline

# åŒæ­¥æœŸè´§ä¿¡æ¯
./bin/data_sync -action sync-once -syncer futures

# åŒæ­¥å¸‚åœºç»Ÿè®¡æ•°æ®
./bin/data_sync -action sync-once -syncer market_stats
```

### 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
./bin/data_sync -action status
```

## é…ç½®è¯´æ˜

### é…ç½®æ–¹å¼

æ•°æ®åŒæ­¥æœåŠ¡æ”¯æŒä¸‰ç§é…ç½®æ–¹å¼ï¼š

1. **ä¸»é…ç½®æ–‡ä»¶é›†æˆ**ï¼ˆæ¨èï¼‰ï¼šåœ¨ä¸» `config.yaml` ä¸­æ·»åŠ  `data_sync` æ®µ
2. **ç‹¬ç«‹é…ç½®æ–‡ä»¶**ï¼šä½¿ç”¨ `-config-file` å‚æ•°æŒ‡å®šå•ç‹¬çš„é…ç½®æ–‡ä»¶
3. **é»˜è®¤é…ç½®**ï¼šä½¿ç”¨ç¨‹åºå†…ç½®çš„é»˜è®¤é…ç½®

### ä¸»é…ç½®æ–‡ä»¶é›†æˆç¤ºä¾‹

åœ¨ä¸» `config.yaml` ä¸­æ·»åŠ ï¼š

```yaml
# æ•°æ®åŒæ­¥æœåŠ¡é…ç½®
data_sync:
  # åŒæ­¥é—´éš”é…ç½®ï¼ˆåˆ†é’Ÿï¼‰- æ”¯æŒå°æ•°ï¼Œå¦‚0.5è¡¨ç¤º30ç§’
  price_sync_interval: 0.5      # ä»·æ ¼åŒæ­¥é—´éš”ï¼ˆ30ç§’ï¼‰
  kline_sync_interval: 3        # Kçº¿åŒæ­¥é—´éš”ï¼ˆ3åˆ†é’Ÿï¼‰
  futures_sync_interval: 10     # æœŸè´§ä¿¡æ¯åŒæ­¥é—´éš”ï¼ˆ10åˆ†é’Ÿï¼‰
  enable_funding_history: true  # æ˜¯å¦å¯ç”¨å†å²èµ„é‡‘è´¹ç‡è·å–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
  funding_history_hours: 4      # å†å²èµ„é‡‘è´¹ç‡è·å–çš„æ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼4å°æ—¶ï¼‰
  depth_sync_interval: 0.5      # æ·±åº¦åŒæ­¥é—´éš”ï¼ˆ30ç§’ï¼‰
  exchange_info_sync_interval: 60  # äº¤æ˜“å¯¹ä¿¡æ¯åŒæ­¥é—´éš”ï¼ˆ1å°æ—¶ï¼‰

  # åŒæ­¥å‚æ•°é…ç½®
  max_retries: 3              # æœ€å¤§é‡è¯•æ¬¡æ•°
  retry_delay: 5              # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
  batch_size: 500             # æ‰¹é‡å¤„ç†å¤§å°
  enable_historical_sync: false # æ˜¯å¦å¯ç”¨å†å²æ•°æ®åŒæ­¥
  enable_incremental_sync: true # æ˜¯å¦å¯ç”¨å¢é‡åŒæ­¥ï¼ˆå¤§å¹…æå‡å¯åŠ¨é€Ÿåº¦ï¼‰

  ## ğŸš€ å¢é‡åŒæ­¥åŠŸèƒ½
  å½“å¯ç”¨ `enable_incremental_sync: true` æ—¶ï¼Œæ•°æ®åŒæ­¥æœåŠ¡ä¼šæ™ºèƒ½åœ°åªåŒæ­¥éœ€è¦æ›´æ–°çš„æ•°æ®ï¼š

  ### æ”¯æŒå¢é‡åŒæ­¥çš„åŒæ­¥å™¨ï¼š
  - **ä»·æ ¼åŒæ­¥å™¨**: åªåŒæ­¥æ•°æ®è¿‡æœŸï¼ˆ>5åˆ†é’Ÿï¼‰æˆ–ç¼ºå¤±çš„äº¤æ˜“å¯¹
  - **Kçº¿åŒæ­¥å™¨**: åªåŒæ­¥Kçº¿æ•°æ®è¿‡æœŸï¼ˆ>1å°æ—¶ï¼‰æˆ–ç¼ºå¤±çš„äº¤æ˜“å¯¹
  - **å¸‚åœºæ·±åº¦åŒæ­¥å™¨**: åªåŒæ­¥æ•°æ®è¿‡æœŸï¼ˆ>30ç§’ï¼‰æˆ–ç¼ºå¤±çš„äº¤æ˜“å¯¹
  - **æˆäº¤é‡åŒæ­¥å™¨**: åªåŒæ­¥æ•°æ®è¿‡æœŸï¼ˆ>10åˆ†é’Ÿï¼‰æˆ–ç¼ºå¤±çš„äº¤æ˜“å¯¹

  ### æ€§èƒ½æå‡ï¼š
  - **å¯åŠ¨é€Ÿåº¦**: é‡å¯æœåŠ¡æ—¶é€šå¸¸åªéœ€å‡ ç§’é’Ÿï¼Œè€Œä¸æ˜¯å‡ åˆ†é’Ÿ
  - **èµ„æºèŠ‚çœ**: å¤§å¹…å‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨å’Œæ•°æ®åº“å†™å…¥
  - **æ™ºèƒ½è°ƒåº¦**: æ ¹æ®æ•°æ®æ–°é²œåº¦è‡ªåŠ¨è°ƒæ•´åŒæ­¥é¢‘ç‡

  å¦‚æœç¦ç”¨å¢é‡åŒæ­¥ï¼ŒæœåŠ¡ä¼šæ‰§è¡Œå…¨é‡åŒæ­¥æ‰€æœ‰é…ç½®çš„äº¤æ˜“å¯¹ã€‚

  ## ğŸ’° èµ„é‡‘è´¹ç‡æ™ºèƒ½è·å–ç­–ç•¥
  æœŸè´§åŒæ­¥å™¨é‡‡ç”¨ä¸‰å±‚ä¼˜å…ˆçº§ç­–ç•¥ï¼Œç¡®ä¿è·å–æœ€æœ‰ä»·å€¼çš„èµ„é‡‘è´¹ç‡æ•°æ®ï¼š

  ### ä¼˜å…ˆçº§é¡ºåºï¼š
  1. **ğŸ¥‡ æœ€æ–°4å°æ—¶å†å²è´¹ç‡** - æœ€ä¼˜å…ˆï¼ˆå®é™…å·²å‘ç”Ÿçš„è´¹ç‡æ•°æ®ï¼‰
  2. **ğŸ¥ˆ å®æ—¶é¢„æµ‹è´¹ç‡** - æ¬¡ä¼˜å…ˆï¼ˆå½“å‰é¢„æµ‹å€¼ï¼‰
  3. **ğŸ¥‰ 8å°æ—¶å·²ç»“ç®—è´¹ç‡** - é™çº§ï¼ˆè¾ƒä¹…è¿œçš„å·²ç¡®è®¤æ•°æ®ï¼‰

  ### ç­–ç•¥ä¼˜åŠ¿ï¼š
  - **æ•°æ®å¯é æ€§**: ä¼˜å…ˆä½¿ç”¨æœ‰å®é™…å‚è€ƒä»·å€¼çš„å†å²æ•°æ®
  - **æ—¶æ•ˆæ€§ä¿è¯**: å®æ—¶é¢„æµ‹ä½œä¸ºæœ‰åŠ›è¡¥å……
  - **è¿ç»­æ€§ä¿éšœ**: å¤šå±‚é™çº§ç¡®ä¿æ•°æ®å¯ç”¨æ€§
  - **ä¸šåŠ¡ä»·å€¼**: å†å²æ•°æ®æ›´é€‚åˆç­–ç•¥åˆ†æå’Œå†³ç­–

  ### é…ç½®æ§åˆ¶ï¼š
  ```yaml
  enable_funding_history: true  # å¯ç”¨å†å²æ•°æ®è·å–
  funding_history_hours: 4      # å†å²æ•°æ®æ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼4å°æ—¶ï¼‰
  ```

  # æ•°æ®æºé…ç½®
  exchanges:
    - binance                  # æ”¯æŒçš„äº¤æ˜“æ‰€

  symbols: []                  # åŒæ­¥çš„äº¤æ˜“å¯¹ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨ä»æ•°æ®åº“è·å–æ‰€æœ‰USDTäº¤æ˜“å¯¹ï¼‰

  kline_intervals:             # Kçº¿æ—¶é—´é—´éš”
    - "1m"
    - "5m"
    - "15m"
    - "1h"
    - "4h"
    - "1d"

  # ç›‘æ§é…ç½®
  enable_metrics: true        # å¯ç”¨ç›‘æ§æŒ‡æ ‡
  metrics_interval: 5         # ç›‘æ§æŠ¥å‘Šé—´éš”ï¼ˆåˆ†é’Ÿï¼‰

  # é«˜çº§é…ç½®
  enable_data_validation: true
  max_data_age_minutes: 5      # æœ€å¤§æ•°æ®å¹´é¾„ï¼ˆåˆ†é’Ÿï¼‰

  # ç½‘ç»œå’Œæ€§èƒ½ä¼˜åŒ–é…ç½®
  timeout_seconds: 10          # è¯·æ±‚è¶…æ—¶æ—¶é—´
  rate_limit_requests: 20      # æ¯ç§’è¯·æ±‚é™åˆ¶
  rate_limit_burst: 40         # è¯·æ±‚çªå‘é™åˆ¶

  # å¹¶å‘æ§åˆ¶ä¼˜åŒ–
  worker_pool_size: 20         # å·¥ä½œæ± å¤§å°
  max_concurrent_symbols: 50   # åŒæ—¶å¤„ç†çš„æœ€å¤§äº¤æ˜“å¯¹æ•°é‡
  api_call_timeout: 5          # APIè°ƒç”¨è¶…æ—¶ï¼ˆç§’ï¼‰

  # ç¼“å­˜é…ç½®ä¼˜åŒ–
  enable_caching: true         # å¯ç”¨ç¼“å­˜
  cache_ttl_seconds: 30        # ç¼“å­˜ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰
  cache_max_size: 1000         # ç¼“å­˜æœ€å¤§æ¡ç›®æ•°

  # Redisç¼“å­˜é…ç½®ï¼ˆè·¨æœåŠ¡å…±äº«æ— æ•ˆç¬¦å·ï¼‰
  enable_redis_cache: false      # æ˜¯å¦å¯ç”¨Redisç¼“å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨ï¼‰
  redis_addr: "localhost:6379"   # RedisæœåŠ¡å™¨åœ°å€
  redis_password: ""             # Rediså¯†ç ï¼ˆç©ºè¡¨ç¤ºæ— å¯†ç ï¼‰
  redis_db: 0                    # Redisæ•°æ®åº“ç¼–å·
  redis_key_prefix: "data_sync:" # Redisé”®å‰ç¼€
```

### ç‹¬ç«‹é…ç½®æ–‡ä»¶æ–¹å¼

ä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼ˆ`config.example.yaml`ï¼‰ï¼š

```yaml
# å®Œæ•´çš„é…ç½®é¡¹ï¼ˆå‚è€ƒ config.example.yamlï¼‰
price_sync_interval: 0.5
kline_sync_interval: 3
batch_size: 500
worker_pool_size: 20
# ... å…¶ä»–é…ç½®é¡¹
```

### åŒæ­¥å™¨è¯´æ˜

#### 1. ä»·æ ¼åŒæ­¥å™¨ (price)
- **æ•°æ®æº**ï¼šBinance å®æ—¶ä»·æ ¼API
- **åŒæ­¥é¢‘ç‡**ï¼š1åˆ†é’Ÿ
- **å­˜å‚¨ä½ç½®**ï¼šprice_cache è¡¨

#### 2. Kçº¿åŒæ­¥å™¨ (kline)
- **æ•°æ®æº**ï¼šBinance Kçº¿API
- **æ—¶é—´é—´éš”**ï¼š1m, 5m, 15m, 1h, 1d
- **å­˜å‚¨ä½ç½®**ï¼šmarket_klines è¡¨

#### 3. æœŸè´§åŒæ­¥å™¨ (futures)
- **æ•°æ®æº**ï¼šBinance Futures API
- **æ•°æ®ç±»å‹**ï¼šåˆçº¦ä¿¡æ¯ã€èµ„é‡‘è´¹ç‡
- **åŒæ­¥é¢‘ç‡**ï¼š10åˆ†é’Ÿ
- **èµ„é‡‘è´¹ç‡ç‰¹æ€§**ï¼š
  - **ğŸ¯ ä¸‰å±‚æ™ºèƒ½ä¼˜å…ˆçº§**ï¼š
    1. ğŸ¥‡ **æœ€æ–°4å°æ—¶å†å²è´¹ç‡** (`/fapi/v1/fundingRate` with time range, limit=1)
    2. ğŸ¥ˆ **å®æ—¶é¢„æµ‹è´¹ç‡** (`/fapi/v1/premiumIndex`)
    3. ğŸ¥‰ **8å°æ—¶å·²ç»“ç®—è´¹ç‡** (`/fapi/v1/fundingRate` limit=1)
  - **ğŸ“Š æ•°æ®ä»·å€¼æ’åº**ï¼šå†å²æ•°æ® > é¢„æµ‹æ•°æ® > ç»“ç®—æ•°æ®
  - **âš™ï¸ å¯é…ç½®æ—¶é—´èŒƒå›´**ï¼š1-720å°æ—¶çš„å†å²æ•°æ®è·å–ï¼ˆåªè·å–æœ€æ–°ä¸€æ¡ï¼‰

#### 4. æ·±åº¦åŒæ­¥å™¨ (depth)
- **æ•°æ®æº**ï¼šBinance è®¢å•ç°¿API
- **æ·±åº¦çº§åˆ«**ï¼šå‰20æ¡£
- **åŒæ­¥é¢‘ç‡**ï¼š1åˆ†é’Ÿ

#### 5. å¸‚åœºç»Ÿè®¡åŒæ­¥å™¨ (market_stats)
- **æ•°æ®æº**ï¼š24å°æ—¶ç»Ÿè®¡API + ä¹°å–ç›˜å£APIï¼ˆæœŸè´§ï¼‰
- **æ•°æ®ç±»å‹**ï¼šå®Œæ•´å¸‚åœºç»Ÿè®¡ï¼ˆä»·æ ¼ã€æˆäº¤é‡ã€ä¹°å–ç›˜å£ã€äº¤æ˜“IDç­‰ï¼‰
- **åŒæ­¥é¢‘ç‡**ï¼š60åˆ†é’Ÿ
- **è¯´æ˜**ï¼šåŸåVolumeSyncerï¼Œç°æ›´åä¸ºMarketStatsSyncerä»¥æ›´å¥½åœ°åæ˜ å…¶åŠŸèƒ½

#### 6. WebSocketåŒæ­¥å™¨ (websocket) ğŸ†•
- **æ•°æ®æº**ï¼šBinance WebSocket å®æ—¶æ•°æ®æµ
- **è¿æ¥ç±»å‹**ï¼šæŒä¹…WebSocketè¿æ¥
- **è®¢é˜…é™åˆ¶**ï¼šæœ€å¤š200ä¸ªäº¤æ˜“å¯¹
- **æ•°æ®ç±»å‹**ï¼šå®æ—¶ä»·æ ¼æ›´æ–°
- **å®æ—¶æ€§**ï¼šæ¯«ç§’çº§æ›´æ–°
- **ç”¨é€”**ï¼šé«˜é¢‘äº¤æ˜“ç­–ç•¥ï¼ˆå®éªŒæ€§åŠŸèƒ½ï¼‰

## ç›‘æ§å’Œè¿ç»´

### å¥åº·æ£€æŸ¥
```bash
# æŸ¥çœ‹åŒæ­¥çŠ¶æ€
curl http://localhost:8080/api/system/status

# æŸ¥çœ‹åŒæ­¥ç»Ÿè®¡
./bin/data_sync -action status
```

### æ—¥å¿—ç›‘æ§
```
[PriceSyncer] Price sync completed: 150 updates
[KlineSyncer] Kline sync completed: 320 updates
[FuturesSyncer] Futures info sync completed: 25 updates
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. æ•°æ®åº“ä¼˜åŒ–
```sql
-- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_price_cache_symbol_kind ON price_cache(symbol, kind);
CREATE INDEX idx_market_klines_symbol_time ON market_klines(symbol, open_time);
```

#### 2. è¿æ¥æ± é…ç½®
```yaml
# æ•°æ®åº“è¿æ¥æ± 
database:
  max_open_conns: 20
  max_idle_conns: 10
  conn_max_lifetime: 30m
```

#### 3. ç¼“å­˜ç­–ç•¥
- ä»·æ ¼æ•°æ®ï¼š30ç§’ç¼“å­˜
- Kçº¿æ•°æ®ï¼šæ ¹æ®æ—¶é—´é—´éš”ç¼“å­˜
- APIå“åº”ï¼š5åˆ†é’Ÿç¼“å­˜

## æ•°æ®è´¨é‡ä¿è¯

### æ•°æ®éªŒè¯
- âœ… **æ—¶é—´æˆ³æ£€æŸ¥**ï¼šç¡®ä¿æ•°æ®æ—¶æ•ˆæ€§
- âœ… **ä»·æ ¼åˆç†æ€§**ï¼šè¿‡æ»¤å¼‚å¸¸ä»·æ ¼
- âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šæ£€æŸ¥å¿…å¡«å­—æ®µ
- âœ… **é‡å¤æ•°æ®**ï¼šé˜²æ­¢æ•°æ®é‡å¤æ’å…¥

### é”™è¯¯å¤„ç†
- ğŸ”„ **è‡ªåŠ¨é‡è¯•**ï¼šç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•3æ¬¡
- ğŸ“ **é”™è¯¯æ—¥å¿—**ï¼šè¯¦ç»†è®°å½•åŒæ­¥å¤±è´¥åŸå› 
- ğŸš¨ **å‘Šè­¦æœºåˆ¶**ï¼šè¿ç»­å¤±è´¥è§¦å‘å‘Šè­¦

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„åŒæ­¥å™¨

1. å®ç° `DataSyncer` æ¥å£ï¼š
```go
type MySyncer struct {
    // ...
}

func (s *MySyncer) Name() string { return "mydata" }
func (s *MySyncer) Sync(ctx context.Context) error { /* å®ç° */ }
func (s *MySyncer) Start(ctx context.Context, interval time.Duration) { /* å®ç° */ }
func (s *MySyncer) Stop() { /* å®ç° */ }
func (s *MySyncer) GetStats() map[string]interface{} { /* å®ç° */ }
```

2. åœ¨ `NewDataSyncService` ä¸­æ³¨å†Œï¼š
```go
service.syncers["mydata"] = NewMySyncer(s.db, s.cfg, &s.config)
```

### æ”¯æŒæ–°çš„äº¤æ˜“æ‰€

1. åˆ›å»ºäº¤æ˜“æ‰€å®¢æˆ·ç«¯
2. å®ç°æ ‡å‡†APIæ¥å£
3. æ·»åŠ åˆ°é…ç½®ä¸­çš„ `exchanges` åˆ—è¡¨

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### Q: åŒæ­¥é€Ÿåº¦æ…¢
A: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œè°ƒæ•´ `batch_size` å’ŒåŒæ­¥é—´éš”

#### Q: æ•°æ®åº“è¿æ¥é”™è¯¯
A: æ£€æŸ¥æ•°æ®åº“é…ç½®ï¼Œå¢åŠ è¿æ¥æ± å¤§å°

#### Q: APIé™æµé”™è¯¯
A: é™ä½åŒæ­¥é¢‘ç‡ï¼Œæ£€æŸ¥APIå¯†é’¥æƒé™

#### Q: æ•°æ®ä¸ä¸€è‡´
A: æ£€æŸ¥æ—¶é’ŸåŒæ­¥ï¼ŒéªŒè¯æ•°æ®æºæ—¶é—´æˆ³

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export LOG_LEVEL=debug
./bin/data_sync -config ./config.yaml
```

## ç”Ÿäº§éƒ¨ç½²

### Docker éƒ¨ç½²
```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o data_sync ./cmd/data_sync

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/bin/data_sync .
COPY --from=builder /app/config.yaml .
CMD ["./data_sync", "-config", "./config.yaml"]
```

### Systemd æœåŠ¡
```ini
[Unit]
Description=Data Sync Service
After=network.target

[Service]
Type=simple
User=data-sync
ExecStart=/opt/data-sync/bin/data_sync -config /opt/data-sync/config.yaml
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

## Redisç¼“å­˜åŠŸèƒ½

### åŠŸèƒ½æ¦‚è¿°

æ•°æ®åŒæ­¥æœåŠ¡æ”¯æŒRedisç¼“å­˜åŠŸèƒ½ï¼Œç”¨äºè·¨æœåŠ¡å…±äº«æ— æ•ˆäº¤æ˜“å¯¹ä¿¡æ¯ï¼Œé¿å…é‡å¤çš„APIè°ƒç”¨å’Œé”™è¯¯æ—¥å¿—ã€‚

### å·¥ä½œåŸç†

1. **æœ¬åœ°ç¼“å­˜**ï¼šæ¯ä¸ªåŒæ­¥å™¨ç»´æŠ¤å†…å­˜ä¸­çš„æ— æ•ˆç¬¦å·ç¼“å­˜
2. **Redisç¼“å­˜**ï¼šå°†æ— æ•ˆç¬¦å·å†™å…¥Redisï¼Œå®ç°è·¨æœåŠ¡å…±äº«
3. **åŒé‡æ£€æŸ¥**ï¼šä¼˜å…ˆæ£€æŸ¥Redisç¼“å­˜ï¼Œå†æ£€æŸ¥æœ¬åœ°ç¼“å­˜
4. **è‡ªåŠ¨è¿‡æœŸ**ï¼šRedisä¸­çš„æ— æ•ˆç¬¦å·ä¼šè‡ªåŠ¨è¿‡æœŸï¼Œé¿å…æ°¸ä¹…ç¼“å­˜

### é…ç½®æ–¹æ³•

åœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­å¯ç”¨Redisç¼“å­˜ï¼š

```yaml
data_sync:
  # Redisç¼“å­˜é…ç½®
  enable_redis_cache: true
  redis_addr: "localhost:6379"
  redis_password: ""             # å¯é€‰
  redis_db: 0
  redis_key_prefix: "data_sync:"
```

### ç¼“å­˜é”®æ ¼å¼

Redisä¸­çš„é”®æ ¼å¼ä¸ºï¼š`{prefix}{symbol}_{kind}`

ä¾‹å¦‚ï¼š
- `data_sync:BTCUSDT_spot`
- `data_sync:ETHUSDT_futures`

### è¿‡æœŸæ—¶é—´

é»˜è®¤è¿‡æœŸæ—¶é—´ä¸º24å°æ—¶ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ã€‚

### æ€§èƒ½ä¼˜åŠ¿

- **å‡å°‘APIè°ƒç”¨**ï¼šé¿å…å¯¹å·²çŸ¥æ— æ•ˆäº¤æ˜“å¯¹çš„é‡å¤è¯·æ±‚
- **é™ä½æ—¥å¿—å™ªéŸ³**ï¼šå‡å°‘æ— æ•ˆç¬¦å·çš„é”™è¯¯æ—¥å¿—è¾“å‡º
- **è·¨æœåŠ¡åŒæ­¥**ï¼šå¤šä¸ªæœåŠ¡å®ä¾‹å…±äº«æ— æ•ˆç¬¦å·ä¿¡æ¯
- **è‡ªåŠ¨æ¸…ç†**ï¼šRedis TTLæœºåˆ¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®

### ç›‘æ§ç¼“å­˜

å¯ä»¥é€šè¿‡Rediså®¢æˆ·ç«¯æŸ¥çœ‹ç¼“å­˜çŠ¶æ€ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜çš„æ— æ•ˆç¬¦å·
KEYS data_sync:*

# æŸ¥çœ‹ç‰¹å®šç¬¦å·
GET data_sync:BTCUSDT_spot
```

## è´¡çŒ®æŒ‡å—

### ä»£ç è§„èŒƒ
- éµå¾ª Go æ ‡å‡†ç¼–ç è§„èŒƒ
- æ·»åŠ è¯¦ç»†çš„æ³¨é‡Šå’Œæ–‡æ¡£
- ç¼–å†™å•å…ƒæµ‹è¯•
- æäº¤å‰è¿è¡Œ `go fmt` å’Œ `go vet`

### æµ‹è¯•
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
go test ./cmd/data_sync/...

# è¿è¡Œé›†æˆæµ‹è¯•
go test -tags=integration ./cmd/data_sync/...
```

## WebSocket å®æ—¶æ•°æ®åŒæ­¥ ğŸ†•

### åŠŸèƒ½æ¦‚è¿°

WebSocketåŒæ­¥å™¨åˆ©ç”¨Binanceçš„å®æ—¶æ•°æ®æµï¼Œæä¾›æ¯«ç§’çº§çš„æ•°æ®æ›´æ–°ï¼Œç‰¹åˆ«é€‚åˆé«˜é¢‘äº¤æ˜“ç­–ç•¥å’Œéœ€è¦å®æ—¶ä»·æ ¼çš„åº”ç”¨åœºæ™¯ã€‚

### æ ¸å¿ƒä¼˜åŠ¿

| ç‰¹æ€§å¯¹æ¯” | REST API | WebSocket |
|----------|----------|-----------|
| **å®æ—¶æ€§** | å‡ ç§’å»¶è¿Ÿ | æ¯«ç§’çº§æ›´æ–° |
| **è¯·æ±‚é™åˆ¶** | 10æ¬¡/ç§’/IP | æ— è¯·æ±‚é™åˆ¶ |
| **è¿æ¥æ•ˆç‡** | æ¯æ¬¡è¯·æ±‚å»ºç«‹è¿æ¥ | æŒä¹…è¿æ¥å¤ç”¨ |
| **æ•°æ®è·å–** | ä¸»åŠ¨æ‹‰å– | è¢«åŠ¨æ¨é€ |
| **é€‚ç”¨åœºæ™¯** | æ‰¹é‡å†å²æ•°æ® | é«˜é¢‘å®æ—¶ç­–ç•¥ |

### å·¥ä½œåŸç†

1. **å»ºç«‹è¿æ¥**: è¿æ¥åˆ° `wss://stream.binance.com:9443/ws`
2. **æ™ºèƒ½è®¢é˜…**: è‡ªåŠ¨é€‰æ‹©æ´»è·ƒäº¤æ˜“å¯¹è¿›è¡Œè®¢é˜…
3. **å®æ—¶æ¥æ”¶**: é€šè¿‡WebSocketæ¥æ”¶ä»·æ ¼æ›´æ–°æ¨é€
4. **æ‰¹é‡ä¿å­˜**: å®šæœŸæ‰¹é‡å†™å…¥æ•°æ®åº“ï¼Œä¼˜åŒ–æ€§èƒ½

### é…ç½®é€‰é¡¹

```yaml
# å¯ç”¨WebSocketåŒæ­¥ï¼ˆå®éªŒæ€§åŠŸèƒ½ï¼‰
enable_websocket_sync: true

# æ‰¹é‡ä¿å­˜é—´éš”ï¼ˆç§’ï¼‰
websocket_batch_interval: 5

# æœ€å¤§è®¢é˜…äº¤æ˜“å¯¹æ•°é‡ï¼ˆé¿å…è¿æ¥è¿‡è½½ï¼‰
websocket_max_symbols: 200
```

### è®¢é˜…æµç±»å‹

- **ç°è´§ä»·æ ¼æµ**: `{symbol}@ticker` - å®æ—¶ç°è´§ä»·æ ¼æ›´æ–°
- **æœŸè´§ä»·æ ¼æµ**: `{symbol}@ticker` - å®æ—¶æœŸè´§ä»·æ ¼æ›´æ–°

### æ™ºèƒ½ç‰¹æ€§

#### è‡ªåŠ¨é‡è¿æœºåˆ¶
```go
// æ£€æµ‹è¿æ¥æ–­å¼€ï¼Œè‡ªåŠ¨é‡è¿
if connectionLost {
    reconnectWithExponentialBackoff()
    resubscribeToStreams()
}
```

#### æ‰¹é‡å¤„ç†ä¼˜åŒ–
```go
// å†…å­˜ç¼“å­˜ + å®šæ—¶æ‰¹é‡ä¿å­˜
receivePriceUpdate(symbol, price)
cache[symbol] = price

// æ¯5ç§’æ‰¹é‡ä¿å­˜ä¸€æ¬¡
if timeToBatch {
    batchSaveToDatabase(cache)
    cache = make(map[string]float64)
}
```

#### è‡ªé€‚åº”è®¢é˜…
```go
// åŸºäºäº¤æ˜“æ´»è·ƒåº¦åŠ¨æ€è°ƒæ•´è®¢é˜…åˆ—è¡¨
activeSymbols := getMostActiveSymbols()
subscribeToSymbols(activeSymbols[:maxSymbols])
```

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | REST API | WebSocket | æå‡å€æ•° |
|------|----------|-----------|----------|
| ä»·æ ¼æ›´æ–°é¢‘ç‡ | æ¯30ç§’ | å®æ—¶ | æ— é™å€ |
| APIè°ƒç”¨æ¬¡æ•° | æ¯ç§’10æ¬¡ | 0æ¬¡ | 100%å‡å°‘ |
| æ•°æ®å»¶è¿Ÿ | 1-3ç§’ | <100ms | 10-30å€ |
| è¿æ¥å¼€é”€ | é«˜ | ä½ | æ˜¾è‘—é™ä½ |

### ä½¿ç”¨å»ºè®®

#### æ¨èåœºæ™¯
- âœ… **é«˜é¢‘äº¤æ˜“ç­–ç•¥**: éœ€è¦æ¯«ç§’çº§ä»·æ ¼æ›´æ–°
- âœ… **å¥—åˆ©ç›‘æ§**: å®æ—¶æ£€æµ‹ä»·å·®æœºä¼š
- âœ… **é£é™©ç®¡ç†**: å®æ—¶ç›‘æ§æŒä»“ä»·æ ¼
- âœ… **ä¿¡å·ç”Ÿæˆ**: åŸºäºå®æ—¶æ•°æ®çš„æŒ‡æ ‡è®¡ç®—

#### æ³¨æ„äº‹é¡¹
- âš ï¸ **å®éªŒæ€§åŠŸèƒ½**: ä»åœ¨å¼€å‘å’Œä¼˜åŒ–ä¸­
- âš ï¸ **è¿æ¥ç¨³å®šæ€§**: éœ€è¦è‰¯å¥½çš„ç½‘ç»œç¯å¢ƒ
- âš ï¸ **èµ„æºæ¶ˆè€—**: WebSocketè¿æ¥ä¼šæŒç»­å ç”¨èµ„æº
- âš ï¸ **è®¢é˜…é™åˆ¶**: å•è¿æ¥æœ€å¤šè®¢é˜…200ä¸ªæµ

### æ•…éšœå¤„ç†

#### è¿æ¥æ–­å¼€
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥
ping stream.binance.com

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/data_sync.log | grep websocket
```

#### é™çº§ç­–ç•¥
```go
// WebSocketå¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°REST API
if websocketFailed {
    log.Printf("WebSocketè¿æ¥å¤±è´¥ï¼Œé™çº§åˆ°REST API")
    enableRESTFallback()
}
```

#### ç›‘æ§æŒ‡æ ‡
```bash
# WebSocketè¿æ¥çŠ¶æ€
curl http://localhost:8080/api/sync/status

# å“åº”ç¤ºä¾‹
{
  "websocket": {
    "is_connected": true,
    "subscribed_count": 150,
    "last_update": "2024-12-24T16:00:00Z"
  }
}
```

### éƒ¨ç½²å»ºè®®

#### ç”Ÿäº§ç¯å¢ƒé…ç½®
```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
enable_websocket_sync: true
websocket_batch_interval: 3      # æ›´é¢‘ç¹çš„ä¿å­˜
websocket_max_symbols: 100       # æ§åˆ¶è®¢é˜…æ•°é‡
enable_redis_cache: true         # é…åˆä½¿ç”¨ç¼“å­˜
```

#### ç›‘æ§å‘Šè­¦
- WebSocketè¿æ¥çŠ¶æ€
- è®¢é˜…æµæ•°é‡
- æ•°æ®æ¥æ”¶å»¶è¿Ÿ
- é‡è¿é¢‘ç‡

### æœªæ¥è§„åˆ’

- **å¤šè¿æ¥æ”¯æŒ**: æ”¯æŒå¤šä¸ªWebSocketè¿æ¥å¹¶è¡Œå¤„ç†
- **æ™ºèƒ½è·¯ç”±**: æ ¹æ®äº¤æ˜“æ´»è·ƒåº¦åŠ¨æ€è°ƒæ•´è®¢é˜…
- **æ•°æ®å‹ç¼©**: å‡å°‘ç½‘ç»œä¼ è¾“é‡
- **æ•…éšœè½¬ç§»**: æ”¯æŒå¤šä¸ªæ•°æ®æºçš„è‡ªåŠ¨åˆ‡æ¢

**WebSocketåŒæ­¥å™¨ä»£è¡¨äº†æ•°æ®åŒæ­¥æŠ€æœ¯çš„å‘å±•æ–¹å‘ï¼Œå°†ä¸ºé«˜é¢‘äº¤æ˜“å’Œå®æ—¶ç­–ç•¥æä¾›å¼ºå¤§çš„æ•°æ®æ”¯æ’‘ï¼** ğŸš€

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚
