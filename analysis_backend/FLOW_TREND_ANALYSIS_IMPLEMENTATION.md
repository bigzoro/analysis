# 资金流趋势分析功能实现说明

## 功能概述

已成功实现资金流趋势分析功能，用于完善推荐系统中的资金流因子评分。该功能能够：

1. **多时间周期分析**：分析24小时、3天、7天、30天的资金流
2. **趋势计算**：计算各时间段的资金流变化率（趋势百分比）
3. **加速度分析**：计算资金流加速度（3天趋势 - 7天趋势）
4. **反转信号检测**：识别资金流反转信号（从流出转为流入或相反）
5. **大额资金识别**：识别大额资金流入（单日>1000万USD）
6. **智能评分**：使用趋势数据计算资金流得分

## 实现文件

### 1. `analysis_backend/internal/server/flow_trend_analysis.go`（新建）

核心资金流趋势分析模块，包含以下功能：

#### 主要函数

- **`GetFlowTrendForSymbol`**: 获取单个币种的资金流趋势分析
  - 查询最近30天的资金流数据
  - 计算24h、3天、7天、30天的净流入
  - 计算各时间段的趋势（变化率）
  - 计算加速度
  - 检测反转信号
  - 识别大额资金流入

- **`GetFlowTrendForSymbols`**: 批量获取多个币种的趋势分析（性能优化）

- **`CalculateFlowScoreWithTrend`**: 使用趋势数据计算资金流得分
  - 公式：`24h净流入得分 * 0.6 + 3天趋势得分 * 0.3 + 7天趋势得分 * 0.1`
  - 最高25分

#### 数据结构

```go
type FlowTrendResult struct {
    Flow24h      float64 // 24小时净流入（USD）
    Flow3d       float64 // 3天净流入（USD）
    Flow7d       float64 // 7天净流入（USD）
    Flow30d      float64 // 30天净流入（USD）
    Trend3d      float64 // 3天趋势（变化率，百分比）
    Trend7d      float64 // 7天趋势（变化率，百分比）
    Trend30d     float64 // 30天趋势（变化率，百分比）
    Acceleration float64 // 资金流加速度（3天趋势 - 7天趋势）
    Reversal     bool    // 是否出现反转信号
    Trend        string  // "increasing"/"decreasing"/"stable"/"reversing"
    LargeFlow    bool    // 是否有大额资金流入（单日>1000万USD）
}
```

### 2. `analysis_backend/internal/server/recommendation.go`（修改）

#### 修改内容

1. **在`generateRecommendations`中集成趋势分析**：
   ```go
   // 3.5. 获取资金流趋势数据
   flowTrendDataMap, err := s.GetFlowTrendForSymbols(ctx, baseSymbolsForFlow)
   ```

2. **更新`calculateScore`函数**：
   - 添加`flowTrendData *FlowTrendResult`参数
   - 使用`CalculateFlowScoreWithTrend`计算资金流得分
   - 大额资金流入额外加分20%
   - 反转信号额外加分15%

3. **更新`RecommendationScore`结构**：
   - 在`Data`字段中添加`FlowTrend *FlowTrendResult`

4. **完善`generateReasons`函数**：
   - 添加资金流趋势相关的推荐理由
   - 根据趋势、反转、大额资金等生成不同理由

## 功能特性

### 1. 多时间周期分析

- **24小时**：当日净流入
- **3天**：最近3天净流入总和
- **7天**：最近7天净流入总和
- **30天**：最近30天净流入总和

### 2. 趋势计算算法

趋势计算公式：
```
趋势 = (当前周期 - 上一周期) / |上一周期| * 100%
```

例如：
- 3天趋势 = (最近3天 - 前3天) / 前3天 * 100%
- 7天趋势 = (最近7天 - 前7天) / 前7天 * 100%

### 3. 加速度分析

```
加速度 = 3天趋势 - 7天趋势
```

- 加速度>20%：资金加速流入
- 加速度<-20%：资金加速流出
- |加速度|<10%：资金流稳定

### 4. 反转信号检测

检测条件：
- 前3天和后3天的资金流符号相反
- 变化幅度>50%

反转信号可能是买入/卖出信号：
- 从流出转为流入：可能是买入信号
- 从流入转为流出：可能是卖出信号

### 5. 大额资金识别

- 单日净流入>1000万USD视为大额资金流入
- 大额资金流入通常表示市场关注度提升

### 6. 智能评分算法

资金流得分计算公式：
```
总得分 = 24h净流入得分 * 0.6 + 3天趋势得分 * 0.3 + 7天趋势得分 * 0.1
```

- **24h净流入得分**（0-15分）：
  - >1000万USD：15分
  - >500万USD：10-15分
  - >100万USD：5-10分
  - >0：0-5分
  - ≤0：0分

- **3天趋势得分**（0-10分）：
  - 趋势>50%：10分
  - 趋势>20%：7-10分
  - 趋势>0%：5-7分
  - 趋势≤0%：0分

- **7天趋势得分**（0-10分）：同3天趋势

- **额外加分**：
  - 大额资金流入：+20%
  - 反转信号（且24h流入>0）：+15%

## 使用示例

### 在推荐系统中使用

```go
// 获取币种的资金流趋势
trend, err := s.GetFlowTrendForSymbol(ctx, "BTC")
if err != nil {
    // 使用默认值
    trend = &FlowTrendResult{Trend: "stable"}
}

// 使用趋势数据计算得分
flowScore := CalculateFlowScoreWithTrend(
    trend.Flow24h,
    trend.Trend3d,
    trend.Trend7d,
)

// 额外加分
if trend.LargeFlow {
    flowScore *= 1.2
}
if trend.Reversal && trend.Flow24h > 0 {
    flowScore *= 1.15
}
```

### 批量查询

```go
symbols := []string{"BTC", "ETH", "SOL"}
trendMap, err := s.GetFlowTrendForSymbols(ctx, symbols)
// trendMap["BTC"] 包含BTC的趋势分析结果
```

## 推荐理由示例

根据趋势分析结果，系统会自动生成推荐理由：

- **趋势增长**："3天资金流增长45.2%，资金加速流入"
- **持续流入**："3天资金流增长15.3%，资金持续流入"
- **反转信号**："资金流出现反转信号，从流出转为流入"
- **大额资金**："出现大额资金流入，市场关注度提升"
- **加速度**："资金流加速度25.5%，流入速度加快"
- **资金流出**："3天资金流下降35.8%，资金加速流出"

## 数据流程

```
1. 推荐系统生成候选币种列表
   ↓
2. 批量查询所有候选币种的资金流趋势
   ↓
3. 从数据库查询最近30天的DailyFlow数据
   ↓
4. 按日期分组并转换为USD
   ↓
5. 计算各时间段的净流入（24h、3d、7d、30d）
   ↓
6. 计算趋势（变化率百分比）
   ↓
7. 计算加速度（3天趋势 - 7天趋势）
   ↓
8. 检测反转信号和大额资金
   ↓
9. 使用趋势数据计算资金流得分
   ↓
10. 应用到推荐评分中（资金流因子25%权重）
   ↓
11. 生成包含趋势信息的推荐理由
```

## 注意事项

1. **数据依赖**：需要定期运行资金流扫描器收集DailyFlow数据
2. **价格转换**：需要获取币种价格将资金流转换为USD
3. **数据完整性**：如果某个时间段数据缺失，趋势计算可能不准确
4. **性能考虑**：批量查询时需要注意数据库查询性能

## 后续优化建议

1. **缓存优化**：缓存趋势分析结果，减少重复计算
2. **实时更新**：支持实时更新资金流数据
3. **更多指标**：添加资金流波动率、资金流集中度等指标
4. **多交易所聚合**：整合多个交易所的资金流数据
5. **预测模型**：基于历史趋势预测未来资金流

## 总结

资金流趋势分析功能已成功集成到推荐系统中，能够：

- ✅ 分析多时间周期的资金流（24h、3d、7d、30d）
- ✅ 计算资金流趋势和加速度
- ✅ 检测反转信号和大额资金流入
- ✅ 使用趋势数据智能计算资金流得分
- ✅ 应用到推荐评分中（25%权重）
- ✅ 生成包含趋势信息的推荐理由

该功能显著提升了推荐系统的资金流因子评分质量，从原来的只看24h净流入变为基于多时间周期趋势的智能评分。

