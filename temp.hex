0000	70 61 63 6b 61 67 65 20  73 65 72 76 65 72 0a 0a   package server..
0010	69 6d 70 6f 72 74 20 28  0a 09 22 63 6f 6e 74 65   import (.."conte
0020	78 74 22 0a 09 22 66 6d  74 22 0a 09 22 6c 6f 67   xt".."fmt".."log
0030	22 0a 09 22 6d 61 74 68  22 0a 09 22 73 6f 72 74   ".."math".."sort
0040	22 0a 09 22 73 74 72 69  6e 67 73 22 0a 09 22 73   ".."strings".."s
0050	79 6e 63 22 0a 09 22 74  69 6d 65 22 0a 29 0a 0a   ync".."time".)..
0060	2f 2f 20 53 79 6d 62 6f  6c 53 74 61 74 65 20 e5   // SymbolState .
0070	8d 95 e4 b8 aa e5 b8 81  e7 a7 8d e7 9a 84 e7 8a   ................
0080	b6 e6 80 81 0a 74 79 70  65 20 53 79 6d 62 6f 6c   .....type Symbol
0090	53 74 61 74 65 20 73 74  72 75 63 74 20 7b 0a 09   State struct {..
00a0	53 79 6d 62 6f 6c 20 20  20 20 20 20 20 20 20 73   Symbol         s
00b0	74 72 69 6e 67 0a 09 50  6f 73 69 74 69 6f 6e 20   tring..Position 
00c0	20 20 20 20 20 20 66 6c  6f 61 74 36 34 20 20 20         float64   
00d0	20 20 20 2f 2f 20 e5 bd  93 e5 89 8d e6 8c 81 e4      // ..........
00e0	bb 93 e6 95 b0 e9 87 8f  0a 09 43 61 73 68 20 20   ..........Cash  
00f0	20 20 20 20 20 20 20 20  20 66 6c 6f 61 74 36 34            float64
0100	20 20 20 20 20 20 2f 2f  20 e5 88 86 e9 85 8d e7         // .......
0110	bb 99 e6 ad a4 e5 b8 81  e7 a7 8d e7 9a 84 e7 8e   ................
0120	b0 e9 87 91 0a 09 48 6f  6c 64 54 69 6d 65 20 20   ......HoldTime  
0130	20 20 20 20 20 69 6e 74  20 20 20 20 20 20 20 20        int        
0140	20 20 2f 2f 20 e6 8c 81  e4 bb 93 e6 97 b6 e9 97     // ...........
0150	b4 0a 09 4c 61 73 74 54  72 61 64 65 49 6e 64 65   ...LastTradeInde
0160	78 20 69 6e 74 20 20 20  20 20 20 20 20 20 20 2f   x int          /
0170	2f 20 e6 9c 80 e5 90 8e  e4 ba a4 e6 98 93 e7 9a   / ..............
0180	84 e7 b4 a2 e5 bc 95 0a  09 44 61 74 61 20 20 20   .........Data   
0190	20 20 20 20 20 20 20 20  5b 5d 4d 61 72 6b 65 74           []Market
01a0	44 61 74 61 20 2f 2f 20  e5 8e 86 e5 8f b2 e6 95   Data // ........
01b0	b0 e6 8d ae 0a 09 52 65  61 73 6f 6e 20 20 20 20   ......Reason    
01c0	20 20 20 20 20 73 74 72  69 6e 67 20 20 20 20 20        string     
01d0	20 20 2f 2f 20 e6 9c 80  e5 90 8e e4 ba a4 e6 98     // ...........
01e0	93 e7 9a 84 e5 8e 9f e5  9b a0 0a 7d 0a 0a 2f 2f   ...........}..//
01f0	20 54 72 61 64 65 4f 70  70 6f 72 74 75 6e 69 74    TradeOpportunit
0200	79 20 e4 ba a4 e6 98 93  e6 9c ba e4 bc 9a 0a 74   y .............t
0210	79 70 65 20 54 72 61 64  65 4f 70 70 6f 72 74 75   ype TradeOpportu
0220	6e 69 74 79 20 73 74 72  75 63 74 20 7b 0a 09 53   nity struct {..S
0230	79 6d 62 6f 6c 20 20 20  20 20 20 20 20 20 73 74   ymbol         st
0240	72 69 6e 67 0a 09 41 63  74 69 6f 6e 20 20 20 20   ring..Action    
0250	20 20 20 20 20 73 74 72  69 6e 67 0a 09 43 6f 6e        string..Con
0260	66 69 64 65 6e 63 65 20  20 20 20 20 66 6c 6f 61   fidence     floa
0270	74 36 34 0a 09 53 63 6f  72 65 20 20 20 20 20 20   t64..Score      
0280	20 20 20 20 66 6c 6f 61  74 36 34 0a 09 50 72 69       float64..Pri
0290	63 65 20 20 20 20 20 20  20 20 20 20 66 6c 6f 61   ce          floa
02a0	74 36 34 0a 09 52 65 61  73 6f 6e 20 20 20 20 20   t64..Reason     
02b0	20 20 20 20 73 74 72 69  6e 67 0a 09 53 74 61 74       string..Stat
02c0	65 20 20 20 20 20 20 20  20 20 20 2a 53 79 6d 62   e          *Symb
02d0	6f 6c 53 74 61 74 65 0a  09 52 69 73 6b 41 64 6a   olState..RiskAdj
02e0	75 73 74 6d 65 6e 74 20  66 6c 6f 61 74 36 34 20   ustment float64 
02f0	2f 2f 20 e9 a3 8e e9 99  a9 e8 b0 83 e6 95 b4 e5   // .............
0300	9b a0 e5 ad 90 0a 7d 0a  0a 2f 2f 20 4d 4c 50 72   ......}..// MLPr
0310	65 64 69 63 74 69 6f 6e  43 61 63 68 65 20 4d 4c   edictionCache ML
0320	e9 a2 84 e6 b5 8b e7 bc  93 e5 ad 98 20 2d 20 e7   ............ - .
0330	94 a8 e4 ba 8e e7 bc 93  e5 ad 98 e6 af 8f e4 b8   ................
0340	aa e5 91 a8 e6 9c 9f e7  9a 84 4d 4c e9 a2 84 e6   ..........ML....
0350	b5 8b e7 bb 93 e6 9e 9c  0a 74 79 70 65 20 4d 4c   .........type ML
0360	50 72 65 64 69 63 74 69  6f 6e 43 61 63 68 65 20   PredictionCache 
0370	73 74 72 75 63 74 20 7b  0a 09 6d 75 20 20 20 20   struct {..mu    
0380	20 20 20 20 20 20 73 79  6e 63 2e 52 57 4d 75 74         sync.RWMut
0390	65 78 0a 09 70 72 65 64  69 63 74 69 6f 6e 73 20   ex..predictions 
03a0	6d 61 70 5b 69 6e 74 5d  2a 50 72 65 64 69 63 74   map[int]*Predict
03b0	69 6f 6e 52 65 73 75 6c  74 20 2f 2f 20 e5 91 a8   ionResult // ...
03c0	e6 9c 9f e7 b4 a2 e5 bc  95 20 2d 3e 20 e9 a2 84   ......... -> ...
03d0	e6 b5 8b e7 bb 93 e6 9e  9c 0a 09 73 79 6d 62 6f   ...........symbo
03e0	6c 20 20 20 20 20 20 73  74 72 69 6e 67 0a 09 73   l      string..s
03f0	74 61 72 74 44 61 74 65  20 20 20 74 69 6d 65 2e   tartDate   time.
0400	54 69 6d 65 0a 09 65 6e  64 44 61 74 65 20 20 20   Time..endDate   
0410	20 20 74 69 6d 65 2e 54  69 6d 65 0a 09 6c 61 73     time.Time..las
0420	74 41 63 63 65 73 73 20  20 74 69 6d 65 2e 54 69   tAccess  time.Ti
0430	6d 65 0a 7d 0a 0a 2f 2f  20 4e 65 77 4d 4c 50 72   me.}..// NewMLPr
0440	65 64 69 63 74 69 6f 6e  43 61 63 68 65 20 e5 88   edictionCache ..
0450	9b e5 bb ba 4d 4c e9 a2  84 e6 b5 8b e7 bc 93 e5   ....ML..........
0460	ad 98 0a 66 75 6e 63 20  4e 65 77 4d 4c 50 72 65   ...func NewMLPre
0470	64 69 63 74 69 6f 6e 43  61 63 68 65 28 73 79 6d   dictionCache(sym
0480	62 6f 6c 20 73 74 72 69  6e 67 2c 20 73 74 61 72   bol string, star
0490	74 44 61 74 65 2c 20 65  6e 64 44 61 74 65 20 74   tDate, endDate t
04a0	69 6d 65 2e 54 69 6d 65  29 20 2a 4d 4c 50 72 65   ime.Time) *MLPre
04b0	64 69 63 74 69 6f 6e 43  61 63 68 65 20 7b 0a 09   dictionCache {..
04c0	72 65 74 75 72 6e 20 26  4d 4c 50 72 65 64 69 63   return &MLPredic
04d0	74 69 6f 6e 43 61 63 68  65 7b 0a 09 09 70 72 65   tionCache{...pre
04e0	64 69 63 74 69 6f 6e 73  3a 20 6d 61 6b 65 28 6d   dictions: make(m
04f0	61 70 5b 69 6e 74 5d 2a  50 72 65 64 69 63 74 69   ap[int]*Predicti
0500	6f 6e 52 65 73 75 6c 74  29 2c 0a 09 09 73 79 6d   onResult),...sym
0510	62 6f 6c 3a 20 20 20 20  20 20 73 79 6d 62 6f 6c   bol:      symbol
0520	2c 0a 09 09 73 74 61 72  74 44 61 74 65 3a 20 20   ,...startDate:  
0530	20 73 74 61 72 74 44 61  74 65 2c 0a 09 09 65 6e    startDate,...en
0540	64 44 61 74 65 3a 20 20  20 20 20 65 6e 64 44 61   dDate:     endDa
0550	74 65 2c 0a 09 09 6c 61  73 74 41 63 63 65 73 73   te,...lastAccess
0560	3a 20 20 74 69 6d 65 2e  4e 6f 77 28 29 2c 0a 09   :  time.Now(),..
0570	7d 0a 7d 0a 0a 2f 2f 20  47 65 74 50 72 65 64 69   }.}..// GetPredi
0580	63 74 69 6f 6e 20 e8 8e  b7 e5 8f 96 e6 8c 87 e5   ction ..........
0590	ae 9a e5 91 a8 e6 9c 9f  e7 9a 84 e9 a2 84 e6 b5   ................
05a0	8b e7 bb 93 e6 9e 9c 0a  66 75 6e 63 20 28 6d 70   ........func (mp
05b0	63 20 2a 4d 4c 50 72 65  64 69 63 74 69 6f 6e 43   c *MLPredictionC
05c0	61 63 68 65 29 20 47 65  74 50 72 65 64 69 63 74   ache) GetPredict
05d0	69 6f 6e 28 69 6e 64 65  78 20 69 6e 74 29 20 28   ion(index int) (
05e0	2a 50 72 65 64 69 63 74  69 6f 6e 52 65 73 75 6c   *PredictionResul
05f0	74 2c 20 62 6f 6f 6c 29  20 7b 0a 09 6d 70 63 2e   t, bool) {..mpc.
0600	6d 75 2e 52 4c 6f 63 6b  28 29 0a 09 64 65 66 65   mu.RLock()..defe
0610	72 20 6d 70 63 2e 6d 75  2e 52 55 6e 6c 6f 63 6b   r mpc.mu.RUnlock
0620	28 29 0a 0a 09 70 72 65  64 69 63 74 69 6f 6e 2c   ()...prediction,
0630	20 65 78 69 73 74 73 20  3a 3d 20 6d 70 63 2e 70    exists := mpc.p
0640	72 65 64 69 63 74 69 6f  6e 73 5b 69 6e 64 65 78   redictions[index
0650	5d 0a 09 69 66 20 65 78  69 73 74 73 20 7b 0a 09   ]..if exists {..
0660	09 6d 70 63 2e 6c 61 73  74 41 63 63 65 73 73 20   .mpc.lastAccess 
0670	3d 20 74 69 6d 65 2e 4e  6f 77 28 29 0a 09 7d 0a   = time.Now()..}.
0680	09 72 65 74 75 72 6e 20  70 72 65 64 69 63 74 69   .return predicti
0690	6f 6e 2c 20 65 78 69 73  74 73 0a 7d 0a 0a 2f 2f   on, exists.}..//
06a0	20 53 65 74 50 72 65 64  69 63 74 69 6f 6e 20 e8    SetPrediction .
06b0	ae be e7 bd ae e6 8c 87  e5 ae 9a e5 91 a8 e6 9c   ................
06c0	9f e7 9a 84 e9 a2 84 e6  b5 8b e7 bb 93 e6 9e 9c   ................
06d0	0a 66 75 6e 63 20 28 6d  70 63 20 2a 4d 4c 50 72   .func (mpc *MLPr
06e0	65 64 69 63 74 69 6f 6e  43 61 63 68 65 29 20 53   edictionCache) S
06f0	65 74 50 72 65 64 69 63  74 69 6f 6e 28 69 6e 64   etPrediction(ind
0700	65 78 20 69 6e 74 2c 20  70 72 65 64 69 63 74 69   ex int, predicti
0710	6f 6e 20 2a 50 72 65 64  69 63 74 69 6f 6e 52 65   on *PredictionRe
0720	73 75 6c 74 29 20 7b 0a  09 6d 70 63 2e 6d 75 2e   sult) {..mpc.mu.
0730	4c 6f 63 6b 28 29 0a 09  64 65 66 65 72 20 6d 70   Lock()..defer mp
0740	63 2e 6d 75 2e 55 6e 6c  6f 63 6b 28 29 0a 0a 09   c.mu.Unlock()...
0750	6d 70 63 2e 70 72 65 64  69 63 74 69 6f 6e 73 5b   mpc.predictions[
0760	69 6e 64 65 78 5d 20 3d  20 70 72 65 64 69 63 74   index] = predict
0770	69 6f 6e 0a 09 6d 70 63  2e 6c 61 73 74 41 63 63   ion..mpc.lastAcc
0780	65 73 73 20 3d 20 74 69  6d 65 2e 4e 6f 77 28 29   ess = time.Now()
0790	0a 7d 0a 0a 2f 2f 20 47  65 74 41 6c 6c 50 72 65   .}..// GetAllPre
07a0	64 69 63 74 69 6f 6e 73  20 e8 8e b7 e5 8f 96 e6   dictions .......
07b0	89 80 e6 9c 89 e7 bc 93  e5 ad 98 e7 9a 84 e9 a2   ................
07c0	84 e6 b5 8b e7 bb 93 e6  9e 9c 0a 66 75 6e 63 20   ...........func 
07d0	28 6d 70 63 20 2a 4d 4c  50 72 65 64 69 63 74 69   (mpc *MLPredicti
07e0	6f 6e 43 61 63 68 65 29  20 47 65 74 41 6c 6c 50   onCache) GetAllP
07f0	72 65 64 69 63 74 69 6f  6e 73 28 29 20 6d 61 70   redictions() map
0800	5b 69 6e 74 5d 2a 50 72  65 64 69 63 74 69 6f 6e   [int]*Prediction
0810	52 65 73 75 6c 74 20 7b  0a 09 6d 70 63 2e 6d 75   Result {..mpc.mu
0820	2e 52 4c 6f 63 6b 28 29  0a 09 64 65 66 65 72 20   .RLock()..defer 
0830	6d 70 63 2e 6d 75 2e 52  55 6e 6c 6f 63 6b 28 29   mpc.mu.RUnlock()
0840	0a 0a 09 72 65 73 75 6c  74 20 3a 3d 20 6d 61 6b   ...result := mak
0850	65 28 6d 61 70 5b 69 6e  74 5d 2a 50 72 65 64 69   e(map[int]*Predi
0860	63 74 69 6f 6e 52 65 73  75 6c 74 29 0a 09 66 6f   ctionResult)..fo
0870	72 20 6b 2c 20 76 20 3a  3d 20 72 61 6e 67 65 20   r k, v := range 
0880	6d 70 63 2e 70 72 65 64  69 63 74 69 6f 6e 73 20   mpc.predictions 
0890	7b 0a 09 09 72 65 73 75  6c 74 5b 6b 5d 20 3d 20   {...result[k] = 
08a0	76 0a 09 7d 0a 09 72 65  74 75 72 6e 20 72 65 73   v..}..return res
08b0	75 6c 74 0a 7d 0a 0a 2f  2f 20 53 69 7a 65 20 e8   ult.}..// Size .
08c0	bf 94 e5 9b 9e e7 bc 93  e5 ad 98 e7 9a 84 e9 a2   ................
08d0	84 e6 b5 8b e6 95 b0 e9  87 8f 0a 66 75 6e 63 20   ...........func 
08e0	28 6d 70 63 20 2a 4d 4c  50 72 65 64 69 63 74 69   (mpc *MLPredicti
08f0	6f 6e 43 61 63 68 65 29  20 53 69 7a 65 28 29 20   onCache) Size() 
0900	69 6e 74 20 7b 0a 09 6d  70 63 2e 6d 75 2e 52 4c   int {..mpc.mu.RL
0910	6f 63 6b 28 29 0a 09 64  65 66 65 72 20 6d 70 63   ock()..defer mpc
0920	2e 6d 75 2e 52 55 6e 6c  6f 63 6b 28 29 0a 09 72   .mu.RUnlock()..r
0930	65 74 75 72 6e 20 6c 65  6e 28 6d 70 63 2e 70 72   eturn len(mpc.pr
0940	65 64 69 63 74 69 6f 6e  73 29 0a 7d 0a 0a 2f 2f   edictions).}..//
0950	20 44 65 63 69 73 69 6f  6e 52 65 73 75 6c 74 20    DecisionResult 
0960	e5 86 b3 e7 ad 96 e7 bb  93 e6 9e 9c 0a 74 79 70   .............typ
0970	65 20 44 65 63 69 73 69  6f 6e 52 65 73 75 6c 74   e DecisionResult
0980	20 73 74 72 75 63 74 20  7b 0a 09 41 63 74 69 6f    struct {..Actio
0990	6e 20 20 20 20 20 73 74  72 69 6e 67 0a 09 43 6f   n     string..Co
09a0	6e 66 69 64 65 6e 63 65  20 66 6c 6f 61 74 36 34   nfidence float64
09b0	0a 09 54 69 6d 65 73 74  61 6d 70 20 20 74 69 6d   ..Timestamp  tim
09c0	65 2e 54 69 6d 65 0a 7d  0a 0a 2f 2f 20 44 65 63   e.Time.}..// Dec
09d0	69 73 69 6f 6e 43 61 63  68 65 20 e5 86 b3 e7 ad   isionCache .....
09e0	96 e7 bc 93 e5 ad 98 20  2d 20 e7 94 a8 e4 ba 8e   ....... - ......
09f0	e7 bc 93 e5 ad 98 e8 a7  84 e5 88 99 e5 86 b3 e7   ................
0a00	ad 96 e7 bb 93 e6 9e 9c  0a 74 79 70 65 20 44 65   .........type De
0a10	63 69 73 69 6f 6e 43 61  63 68 65 20 73 74 72 75   cisionCache stru
0a20	63 74 20 7b 0a 09 6d 75  20 20 20 20 20 20 20 20   ct {..mu        
0a30	20 73 79 6e 63 2e 52 57  4d 75 74 65 78 0a 09 64    sync.RWMutex..d
0a40	65 63 69 73 69 6f 6e 73  20 20 6d 61 70 5b 73 74   ecisions  map[st
0a50	72 69 6e 67 5d 2a 44 65  63 69 73 69 6f 6e 52 65   ring]*DecisionRe
0a60	73 75 6c 74 20 2f 2f 20  e5 86 b3 e7 ad 96 e9 94   sult // ........
0a70	ae 20 2d 3e 20 e5 86 b3  e7 ad 96 e7 bb 93 e6 9e   . -> ...........
0a80	9c 0a 09 73 79 6d 62 6f  6c 20 20 20 20 20 73 74   ...symbol     st
0a90	72 69 6e 67 0a 09 73 74  61 72 74 44 61 74 65 20   ring..startDate 
0aa0	20 74 69 6d 65 2e 54 69  6d 65 0a 09 65 6e 64 44    time.Time..endD
0ab0	61 74 65 20 20 20 20 74  69 6d 65 2e 54 69 6d 65   ate    time.Time
0ac0	0a 09 6c 61 73 74 41 63  63 65 73 73 20 74 69 6d   ..lastAccess tim
0ad0	65 2e 54 69 6d 65 0a 7d  0a 0a 2f 2f 20 4e 65 77   e.Time.}..// New
0ae0	44 65 63 69 73 69 6f 6e  43 61 63 68 65 20 e5 88   DecisionCache ..
0af0	9b e5 bb ba e5 86 b3 e7  ad 96 e7 bc 93 e5 ad 98   ................
0b00	0a 66 75 6e 63 20 4e 65  77 44 65 63 69 73 69 6f   .func NewDecisio
0b10	6e 43 61 63 68 65 28 73  79 6d 62 6f 6c 20 73 74   nCache(symbol st
0b20	72 69 6e 67 2c 20 73 74  61 72 74 44 61 74 65 2c   ring, startDate,
0b30	20 65 6e 64 44 61 74 65  20 74 69 6d 65 2e 54 69    endDate time.Ti
0b40	6d 65 29 20 2a 44 65 63  69 73 69 6f 6e 43 61 63   me) *DecisionCac
0b50	68 65 20 7b 0a 09 72 65  74 75 72 6e 20 26 44 65   he {..return &De
0b60	63 69 73 69 6f 6e 43 61  63 68 65 7b 0a 09 09 64   cisionCache{...d
0b70	65 63 69 73 69 6f 6e 73  3a 20 20 6d 61 6b 65 28   ecisions:  make(
0b80	6d 61 70 5b 73 74 72 69  6e 67 5d 2a 44 65 63 69   map[string]*Deci
0b90	73 69 6f 6e 52 65 73 75  6c 74 29 2c 0a 09 09 73   sionResult),...s
0ba0	79 6d 62 6f 6c 3a 20 20  20 20 20 73 79 6d 62 6f   ymbol:     symbo
0bb0	6c 2c 0a 09 09 73 74 61  72 74 44 61 74 65 3a 20   l,...startDate: 
0bc0	20 73 74 61 72 74 44 61  74 65 2c 0a 09 09 65 6e    startDate,...en
0bd0	64 44 61 74 65 3a 20 20  20 20 65 6e 64 44 61 74   dDate:    endDat
0be0	65 2c 0a 09 09 6c 61 73  74 41 63 63 65 73 73 3a   e,...lastAccess:
0bf0	20 74 69 6d 65 2e 4e 6f  77 28 29 2c 0a 09 7d 0a    time.Now(),..}.
0c00	7d 0a 0a 2f 2f 20 67 65  6e 65 72 61 74 65 44 65   }..// generateDe
0c10	63 69 73 69 6f 6e 4b 65  79 20 e7 94 9f e6 88 90   cisionKey ......
0c20	e5 86 b3 e7 ad 96 e7 bc  93 e5 ad 98 e9 94 ae 0a   ................
0c30	66 75 6e 63 20 28 64 63  20 2a 44 65 63 69 73 69   func (dc *Decisi
0c40	6f 6e 43 61 63 68 65 29  20 67 65 6e 65 72 61 74   onCache) generat
0c50	65 44 65 63 69 73 69 6f  6e 4b 65 79 28 73 74 61   eDecisionKey(sta
0c60	74 65 20 6d 61 70 5b 73  74 72 69 6e 67 5d 66 6c   te map[string]fl
0c70	6f 61 74 36 34 2c 20 61  67 65 6e 74 20 6d 61 70   oat64, agent map
0c80	5b 73 74 72 69 6e 67 5d  69 6e 74 65 72 66 61 63   [string]interfac
0c90	65 7b 7d 2c 20 69 6e 64  65 78 20 69 6e 74 29 20   e{}, index int) 
0ca0	73 74 72 69 6e 67 20 7b  0a 09 2f 2f 20 e4 bd bf   string {..// ...
0cb0	e7 94 a8 e5 85 b3 e9 94  ae e7 8a b6 e6 80 81 e7   ................
0cc0	89 b9 e5 be 81 e5 92 8c  61 67 65 6e 74 e7 8a b6   ........agent...
0cd0	e6 80 81 e7 94 9f e6 88  90 e9 94 ae 0a 09 6b 65   ..............ke
0ce0	79 50 61 72 74 73 20 3a  3d 20 5b 5d 73 74 72 69   yParts := []stri
0cf0	6e 67 7b 0a 09 09 66 6d  74 2e 53 70 72 69 6e 74   ng{...fmt.Sprint
0d00	66 28 22 69 64 78 5f 25  64 22 2c 20 69 6e 64 65   f("idx_%d", inde
0d10	78 29 2c 0a 09 09 66 6d  74 2e 53 70 72 69 6e 74   x),...fmt.Sprint
0d20	66 28 22 70 6f 73 5f 25  76 22 2c 20 61 67 65 6e   f("pos_%v", agen
0d30	74 5b 22 68 61 73 5f 70  6f 73 69 74 69 6f 6e 22   t["has_position"
0d40	5d 29 2c 0a 09 09 66 6d  74 2e 53 70 72 69 6e 74   ]),...fmt.Sprint
0d50	66 28 22 68 74 5f 25 64  22 2c 20 69 6e 74 28 61   f("ht_%d", int(a
0d60	67 65 6e 74 5b 22 68 6f  6c 64 5f 74 69 6d 65 22   gent["hold_time"
0d70	5d 2e 28 69 6e 74 29 29  29 2c 0a 09 09 66 6d 74   ].(int))),...fmt
0d80	2e 53 70 72 69 6e 74 66  28 22 72 73 69 5f 25 2e   .Sprintf("rsi_%.
0d90	32 66 22 2c 20 73 74 61  74 65 5b 22 72 73 69 5f   2f", state["rsi_
0da0	31 34 22 5d 29 2c 0a 09  09 66 6d 74 2e 53 70 72   14"]),...fmt.Spr
0db0	69 6e 74 66 28 22 74 72  65 6e 64 5f 25 2e 33 66   intf("trend_%.3f
0dc0	22 2c 20 73 74 61 74 65  5b 22 74 72 65 6e 64 5f   ", state["trend_
0dd0	35 22 5d 29 2c 0a 09 09  66 6d 74 2e 53 70 72 69   5"]),...fmt.Spri
0de0	6e 74 66 28 22 76 6f 6c  5f 25 2e 33 66 22 2c 20   ntf("vol_%.3f", 
0df0	73 74 61 74 65 5b 22 76  6f 6c 61 74 69 6c 69 74   state["volatilit
0e00	79 5f 32 30 22 5d 29 2c  0a 09 7d 0a 0a 09 2f 2f   y_20"]),..}...//
0e10	20 e5 8c 85 e5 90 ab e4  bb b7 e6 a0 bc e5 92 8c    ...............
0e20	e6 8c 81 e4 bb 93 e7 8a  b6 e6 80 81 0a 09 69 66   ..............if
0e30	20 65 6e 74 72 79 50 72  69 63 65 2c 20 65 78 69    entryPrice, exi
0e40	73 74 73 20 3a 3d 20 61  67 65 6e 74 5b 22 65 6e   sts := agent["en
0e50	74 72 79 5f 70 72 69 63  65 22 5d 2e 28 66 6c 6f   try_price"].(flo
0e60	61 74 36 34 29 3b 20 65  78 69 73 74 73 20 7b 0a   at64); exists {.
0e70	09 09 6b 65 79 50 61 72  74 73 20 3d 20 61 70 70   ..keyParts = app
0e80	65 6e 64 28 6b 65 79 50  61 72 74 73 2c 20 66 6d   end(keyParts, fm
0e90	74 2e 53 70 72 69 6e 74  66 28 22 65 70 5f 25 2e   t.Sprintf("ep_%.
0ea0	32 66 22 2c 20 65 6e 74  72 79 50 72 69 63 65 29   2f", entryPrice)
0eb0	29 0a 09 7d 0a 09 69 66  20 63 75 72 72 65 6e 74   )..}..if current
0ec0	50 72 69 63 65 2c 20 65  78 69 73 74 73 20 3a 3d   Price, exists :=
0ed0	20 61 67 65 6e 74 5b 22  63 75 72 72 65 6e 74 5f    agent["current_
0ee0	70 72 69 63 65 22 5d 2e  28 66 6c 6f 61 74 36 34   price"].(float64
0ef0	29 3b 20 65 78 69 73 74  73 20 7b 0a 09 09 6b 65   ); exists {...ke
0f00	79 50 61 72 74 73 20 3d  20 61 70 70 65 6e 64 28   yParts = append(
0f10	6b 65 79 50 61 72 74 73  2c 20 66 6d 74 2e 53 70   keyParts, fmt.Sp
0f20	72 69 6e 74 66 28 22 63  70 5f 25 2e 32 66 22 2c   rintf("cp_%.2f",
0f30	20 63 75 72 72 65 6e 74  50 72 69 63 65 29 29 0a    currentPrice)).
0f40	09 7d 0a 0a 09 72 65 74  75 72 6e 20 73 74 72 69   .}...return stri
0f50	6e 67 73 2e 4a 6f 69 6e  28 6b 65 79 50 61 72 74   ngs.Join(keyPart
0f60	73 2c 20 22 7c 22 29 0a  7d 0a 0a 2f 2f 20 47 65   s, "|").}..// Ge
0f70	74 44 65 63 69 73 69 6f  6e 20 e8 8e b7 e5 8f 96   tDecision ......
0f80	e7 bc 93 e5 ad 98 e7 9a  84 e5 86 b3 e7 ad 96 e7   ................
0f90	bb 93 e6 9e 9c 0a 66 75  6e 63 20 28 64 63 20 2a   ......func (dc *
0fa0	44 65 63 69 73 69 6f 6e  43 61 63 68 65 29 20 47   DecisionCache) G
0fb0	65 74 44 65 63 69 73 69  6f 6e 28 73 74 61 74 65   etDecision(state
0fc0	20 6d 61 70 5b 73 74 72  69 6e 67 5d 66 6c 6f 61    map[string]floa
0fd0	74 36 34 2c 20 61 67 65  6e 74 20 6d 61 70 5b 73   t64, agent map[s
0fe0	74 72 69 6e 67 5d 69 6e  74 65 72 66 61 63 65 7b   tring]interface{
0ff0	7d 2c 20 69 6e 64 65 78  20 69 6e 74 29 20 28 2a   }, index int) (*
1000	44 65 63 69 73 69 6f 6e  52 65 73 75 6c 74 2c 20   DecisionResult, 
1010	62 6f 6f 6c 29 20 7b 0a  09 64 63 2e 6d 75 2e 52   bool) {..dc.mu.R
1020	4c 6f 63 6b 28 29 0a 09  64 65 66 65 72 20 64 63   Lock()..defer dc
1030	2e 6d 75 2e 52 55 6e 6c  6f 63 6b 28 29 0a 0a 09   .mu.RUnlock()...
1040	6b 65 79 20 3a 3d 20 64  63 2e 67 65 6e 65 72 61   key := dc.genera
1050	74 65 44 65 63 69 73 69  6f 6e 4b 65 79 28 73 74   teDecisionKey(st
1060	61 74 65 2c 20 61 67 65  6e 74 2c 20 69 6e 64 65   ate, agent, inde
1070	78 29 0a 09 64 65 63 69  73 69 6f 6e 2c 20 65 78   x)..decision, ex
1080	69 73 74 73 20 3a 3d 20  64 63 2e 64 65 63 69 73   ists := dc.decis
1090	69 6f 6e 73 5b 6b 65 79  5d 0a 09 69 66 20 65 78   ions[key]..if ex
10a0	69 73 74 73 20 7b 0a 09  09 64 63 2e 6c 61 73 74   ists {...dc.last
10b0	41 63 63 65 73 73 20 3d  20 74 69 6d 65 2e 4e 6f   Access = time.No
10c0	77 28 29 0a 09 7d 0a 09  72 65 74 75 72 6e 20 64   w()..}..return d
10d0	65 63 69 73 69 6f 6e 2c  20 65 78 69 73 74 73 0a   ecision, exists.
10e0	7d 0a 0a 2f 2f 20 53 65  74 44 65 63 69 73 69 6f   }..// SetDecisio
10f0	6e 20 e8 ae be e7 bd ae  e5 86 b3 e7 ad 96 e7 bb   n ..............
1100	93 e6 9e 9c e5 88 b0 e7  bc 93 e5 ad 98 0a 66 75   ..............fu
1110	6e 63 20 28 64 63 20 2a  44 65 63 69 73 69 6f 6e   nc (dc *Decision
1120	43 61 63 68 65 29 20 53  65 74 44 65 63 69 73 69   Cache) SetDecisi
1130	6f 6e 28 73 74 61 74 65  20 6d 61 70 5b 73 74 72   on(state map[str
1140	69 6e 67 5d 66 6c 6f 61  74 36 34 2c 20 61 67 65   ing]float64, age
1150	6e 74 20 6d 61 70 5b 73  74 72 69 6e 67 5d 69 6e   nt map[string]in
1160	74 65 72 66 61 63 65 7b  7d 2c 20 69 6e 64 65 78   terface{}, index
1170	20 69 6e 74 2c 20 61 63  74 69 6f 6e 20 73 74 72    int, action str
1180	69 6e 67 2c 20 63 6f 6e  66 69 64 65 6e 63 65 20   ing, confidence 
1190	66 6c 6f 61 74 36 34 29  20 7b 0a 09 64 63 2e 6d   float64) {..dc.m
11a0	75 2e 4c 6f 63 6b 28 29  0a 09 64 65 66 65 72 20   u.Lock()..defer 
11b0	64 63 2e 6d 75 2e 55 6e  6c 6f 63 6b 28 29 0a 0a   dc.mu.Unlock()..
11c0	09 6b 65 79 20 3a 3d 20  64 63 2e 67 65 6e 65 72   .key := dc.gener
11d0	61 74 65 44 65 63 69 73  69 6f 6e 4b 65 79 28 73   ateDecisionKey(s
11e0	74 61 74 65 2c 20 61 67  65 6e 74 2c 20 69 6e 64   tate, agent, ind
11f0	65 78 29 0a 09 64 63 2e  64 65 63 69 73 69 6f 6e   ex)..dc.decision
1200	73 5b 6b 65 79 5d 20 3d  20 26 44 65 63 69 73 69   s[key] = &Decisi
1210	6f 6e 52 65 73 75 6c 74  7b 0a 09 09 41 63 74 69   onResult{...Acti
1220	6f 6e 3a 20 20 20 20 20  61 63 74 69 6f 6e 2c 0a   on:     action,.
1230	09 09 43 6f 6e 66 69 64  65 6e 63 65 3a 20 63 6f   ..Confidence: co
1240	6e 66 69 64 65 6e 63 65  2c 0a 09 09 54 69 6d 65   nfidence,...Time
1250	73 74 61 6d 70 3a 20 20  74 69 6d 65 2e 4e 6f 77   stamp:  time.Now
1260	28 29 2c 0a 09 7d 0a 09  64 63 2e 6c 61 73 74 41   (),..}..dc.lastA
1270	63 63 65 73 73 20 3d 20  74 69 6d 65 2e 4e 6f 77   ccess = time.Now
1280	28 29 0a 7d 0a 0a 2f 2f  20 53 69 7a 65 20 e8 bf   ().}..// Size ..
1290	94 e5 9b 9e e7 bc 93 e5  ad 98 e7 9a 84 e5 86 b3   ................
12a0	e7 ad 96 e6 95 b0 e9 87  8f 0a 66 75 6e 63 20 28   ..........func (
12b0	64 63 20 2a 44 65 63 69  73 69 6f 6e 43 61 63 68   dc *DecisionCach
12c0	65 29 20 53 69 7a 65 28  29 20 69 6e 74 20 7b 0a   e) Size() int {.
12d0	09 64 63 2e 6d 75 2e 52  4c 6f 63 6b 28 29 0a 09   .dc.mu.RLock()..
12e0	64 65 66 65 72 20 64 63  2e 6d 75 2e 52 55 6e 6c   defer dc.mu.RUnl
12f0	6f 63 6b 28 29 0a 09 72  65 74 75 72 6e 20 6c 65   ock()..return le
1300	6e 28 64 63 2e 64 65 63  69 73 69 6f 6e 73 29 0a   n(dc.decisions).
1310	7d 0a 0a 2f 2f 20 46 65  61 74 75 72 65 43 61 63   }..// FeatureCac
1320	68 65 20 e7 89 b9 e5 be  81 e7 bc 93 e5 ad 98 20   he ............ 
1330	2d 20 e7 94 a8 e4 ba 8e  e7 bc 93 e5 ad 98 e6 af   - ..............
1340	8f e4 b8 aa e5 91 a8 e6  9c 9f e7 9a 84 e7 89 b9   ................
1350	e5 be 81 ef bc 8c e9 81  bf e5 85 8d e9 87 8d e5   ................
1360	a4 8d e8 ae a1 e7 ae 97  0a 74 79 70 65 20 46 65   .........type Fe
1370	61 74 75 72 65 43 61 63  68 65 20 73 74 72 75 63   atureCache struc
1380	74 20 7b 0a 09 6d 75 20  20 20 20 20 20 20 20 20   t {..mu         
1390	73 79 6e 63 2e 52 57 4d  75 74 65 78 0a 09 66 65   sync.RWMutex..fe
13a0	61 74 75 72 65 73 20 20  20 6d 61 70 5b 69 6e 74   atures   map[int
13b0	5d 6d 61 70 5b 73 74 72  69 6e 67 5d 66 6c 6f 61   ]map[string]floa
13c0	74 36 34 20 2f 2f 20 e5  91 a8 e6 9c 9f e7 b4 a2   t64 // .........
13d0	e5 bc 95 20 2d 3e 20 e7  89 b9 e5 be 81 e6 98 a0   ... -> .........
13e0	e5 b0 84 0a 09 73 79 6d  62 6f 6c 20 20 20 20 20   .....symbol     
13f0	73 74 72 69 6e 67 0a 09  73 74 61 72 74 44 61 74   string..startDat
1400	65 20 20 74 69 6d 65 2e  54 69 6d 65 0a 09 65 6e   e  time.Time..en
1410	64 44 61 74 65 20 20 20  20 74 69 6d 65 2e 54 69   dDate    time.Ti
1420	6d 65 0a 09 6c 61 73 74  41 63 63 65 73 73 20 74   me..lastAccess t
1430	69 6d 65 2e 54 69 6d 65  0a 7d 0a 0a 2f 2f 20 4e   ime.Time.}..// N
1440	65 77 46 65 61 74 75 72  65 43 61 63 68 65 20 e5   ewFeatureCache .
1450	88 9b e5 bb ba e7 89 b9  e5 be 81 e7 bc 93 e5 ad   ................
1460	98 0a 66 75 6e 63 20 4e  65 77 46 65 61 74 75 72   ..func NewFeatur
1470	65 43 61 63 68 65 28 73  79 6d 62 6f 6c 20 73 74   eCache(symbol st
1480	72 69 6e 67 2c 20 73 74  61 72 74 44 61 74 65 2c   ring, startDate,
1490	20 65 6e 64 44 61 74 65  20 74 69 6d 65 2e 54 69    endDate time.Ti
14a0	6d 65 29 20 2a 46 65 61  74 75 72 65 43 61 63 68   me) *FeatureCach
14b0	65 20 7b 0a 09 72 65 74  75 72 6e 20 26 46 65 61   e {..return &Fea
14c0	74 75 72 65 43 61 63 68  65 7b 0a 09 09 66 65 61   tureCache{...fea
14d0	74 75 72 65 73 3a 20 20  20 6d 61 6b 65 28 6d 61   tures:   make(ma
14e0	70 5b 69 6e 74 5d 6d 61  70 5b 73 74 72 69 6e 67   p[int]map[string
14f0	5d 66 6c 6f 61 74 36 34  29 2c 0a 09 09 73 79 6d   ]float64),...sym
1500	62 6f 6c 3a 20 20 20 20  20 73 79 6d 62 6f 6c 2c   bol:     symbol,
1510	0a 09 09 73 74 61 72 74  44 61 74 65 3a 20 20 73   ...startDate:  s
1520	74 61 72 74 44 61 74 65  2c 0a 09 09 65 6e 64 44   tartDate,...endD
1530	61 74 65 3a 20 20 20 20  65 6e 64 44 61 74 65 2c   ate:    endDate,
1540	0a 09 09 6c 61 73 74 41  63 63 65 73 73 3a 20 74   ...lastAccess: t
1550	69 6d 65 2e 4e 6f 77 28  29 2c 0a 09 7d 0a 7d 0a   ime.Now(),..}.}.
1560	0a 2f 2f 20 47 65 74 46  65 61 74 75 72 65 20 e8   .// GetFeature .
1570	8e b7 e5 8f 96 e6 8c 87  e5 ae 9a e5 91 a8 e6 9c   ................
1580	9f e7 9a 84 e7 89 b9 e5  be 81 0a 66 75 6e 63 20   ...........func 
1590	28 66 63 20 2a 46 65 61  74 75 72 65 43 61 63 68   (fc *FeatureCach
15a0	65 29 20 47 65 74 46 65  61 74 75 72 65 28 69 6e   e) GetFeature(in
15b0	64 65 78 20 69 6e 74 29  20 28 6d 61 70 5b 73 74   dex int) (map[st
15c0	72 69 6e 67 5d 66 6c 6f  61 74 36 34 2c 20 62 6f   ring]float64, bo
15d0	6f 6c 29 20 7b 0a 09 66  63 2e 6d 75 2e 52 4c 6f   ol) {..fc.mu.RLo
15e0	63 6b 28 29 0a 09 64 65  66 65 72 20 66 63 2e 6d   ck()..defer fc.m
15f0	75 2e 52 55 6e 6c 6f 63  6b 28 29 0a 0a 09 66 65   u.RUnlock()...fe
1600	61 74 75 72 65 2c 20 65  78 69 73 74 73 20 3a 3d   ature, exists :=
1610	20 66 63 2e 66 65 61 74  75 72 65 73 5b 69 6e 64    fc.features[ind
1620	65 78 5d 0a 09 69 66 20  65 78 69 73 74 73 20 7b   ex]..if exists {
1630	0a 09 09 66 63 2e 6c 61  73 74 41 63 63 65 73 73   ...fc.lastAccess
1640	20 3d 20 74 69 6d 65 2e  4e 6f 77 28 29 0a 09 7d    = time.Now()..}
1650	0a 09 72 65 74 75 72 6e  20 66 65 61 74 75 72 65   ..return feature
1660	2c 20 65 78 69 73 74 73  0a 7d 0a 0a 2f 2f 20 53   , exists.}..// S
1670	65 74 46 65 61 74 75 72  65 20 e8 ae be e7 bd ae   etFeature ......
1680	e6 8c 87 e5 ae 9a e5 91  a8 e6 9c 9f e7 9a 84 e7   ................
1690	89 b9 e5 be 81 0a 66 75  6e 63 20 28 66 63 20 2a   ......func (fc *
16a0	46 65 61 74 75 72 65 43  61 63 68 65 29 20 53 65   FeatureCache) Se
16b0	74 46 65 61 74 75 72 65  28 69 6e 64 65 78 20 69   tFeature(index i
16c0	6e 74 2c 20 66 65 61 74  75 72 65 20 6d 61 70 5b   nt, feature map[
16d0	73 74 72 69 6e 67 5d 66  6c 6f 61 74 36 34 29 20   string]float64) 
16e0	7b 0a 09 66 63 2e 6d 75  2e 4c 6f 63 6b 28 29 0a   {..fc.mu.Lock().
16f0	09 64 65 66 65 72 20 66  63 2e 6d 75 2e 55 6e 6c   .defer fc.mu.Unl
1700	6f 63 6b 28 29 0a 0a 09  66 63 2e 66 65 61 74 75   ock()...fc.featu
1710	72 65 73 5b 69 6e 64 65  78 5d 20 3d 20 66 65 61   res[index] = fea
1720	74 75 72 65 0a 09 66 63  2e 6c 61 73 74 41 63 63   ture..fc.lastAcc
1730	65 73 73 20 3d 20 74 69  6d 65 2e 4e 6f 77 28 29   ess = time.Now()
1740	0a 7d 0a 0a 2f 2f 20 47  65 74 41 6c 6c 46 65 61   .}..// GetAllFea
1750	74 75 72 65 73 20 e8 8e  b7 e5 8f 96 e6 89 80 e6   tures ..........
1760	9c 89 e7 bc 93 e5 ad 98  e7 9a 84 e7 89 b9 e5 be   ................
1770	81 0a 66 75 6e 63 20 28  66 63 20 2a 46 65 61 74   ..func (fc *Feat
1780	75 72 65 43 61 63 68 65  29 20 47 65 74 41 6c 6c   ureCache) GetAll
1790	46 65 61 74 75 72 65 73  28 29 20 6d 61 70 5b 69   Features() map[i
17a0	6e 74 5d 6d 61 70 5b 73  74 72 69 6e 67 5d 66 6c   nt]map[string]fl
17b0	6f 61 74 36 34 20 7b 0a  09 66 63 2e 6d 75 2e 52   oat64 {..fc.mu.R
17c0	4c 6f 63 6b 28 29 0a 09  64 65 66 65 72 20 66 63   Lock()..defer fc
17d0	2e 6d 75 2e 52 55 6e 6c  6f 63 6b 28 29 0a 0a 09   .mu.RUnlock()...
17e0	72 65 73 75 6c 74 20 3a  3d 20 6d 61 6b 65 28 6d   result := make(m
17f0	61 70 5b 69 6e 74 5d 6d  61 70 5b 73 74 72 69 6e   ap[int]map[strin
1800	67 5d 66 6c 6f 61 74 36  34 29 0a 09 66 6f 72 20   g]float64)..for 
1810	6b 2c 20 76 20 3a 3d 20  72 61 6e 67 65 20 66 63   k, v := range fc
1820	2e 66 65 61 74 75 72 65  73 20 7b 0a 09 09 72 65   .features {...re
1830	73 75 6c 74 5b 6b 5d 20  3d 20 76 0a 09 7d 0a 09   sult[k] = v..}..
1840	72 65 74 75 72 6e 20 72  65 73 75 6c 74 0a 7d 0a   return result.}.
1850	0a 2f 2f 20 53 69 7a 65  20 e8 bf 94 e5 9b 9e e7   .// Size .......
1860	bc 93 e5 ad 98 e7 9a 84  e7 89 b9 e5 be 81 e6 95   ................
1870	b0 e9 87 8f 0a 66 75 6e  63 20 28 66 63 20 2a 46   .....func (fc *F
1880	65 61 74 75 72 65 43 61  63 68 65 29 20 53 69 7a   eatureCache) Siz
1890	65 28 29 20 69 6e 74 20  7b 0a 09 66 63 2e 6d 75   e() int {..fc.mu
18a0	2e 52 4c 6f 63 6b 28 29  0a 09 64 65 66 65 72 20   .RLock()..defer 
18b0	66 63 2e 6d 75 2e 52 55  6e 6c 6f 63 6b 28 29 0a   fc.mu.RUnlock().
18c0	09 72 65 74 75 72 6e 20  6c 65 6e 28 66 63 2e 66   .return len(fc.f
18d0	65 61 74 75 72 65 73 29  0a 7d 0a 0a 2f 2f 20 42   eatures).}..// B
18e0	61 63 6b 74 65 73 74 45  6e 67 69 6e 65 20 e5 9b   acktestEngine ..
18f0	9e e6 b5 8b e5 bc 95 e6  93 8e 0a 74 79 70 65 20   ...........type 
1900	42 61 63 6b 74 65 73 74  45 6e 67 69 6e 65 20 73   BacktestEngine s
1910	74 72 75 63 74 20 7b 0a  09 64 62 20 20 20 20 20   truct {..db     
1920	20 20 20 20 20 20 20 20  20 44 61 74 61 62 61 73            Databas
1930	65 0a 09 64 61 74 61 4d  61 6e 61 67 65 72 20 20   e..dataManager  
1940	20 20 20 2a 44 61 74 61  4d 61 6e 61 67 65 72 0a      *DataManager.
1950	09 65 6e 73 65 6d 62 6c  65 4d 6f 64 65 6c 73 20   .ensembleModels 
1960	20 6d 61 70 5b 73 74 72  69 6e 67 5d 2a 45 6e 73    map[string]*Ens
1970	65 6d 62 6c 65 50 72 65  64 69 63 74 6f 72 0a 09   emblePredictor..
1980	73 65 72 76 65 72 20 20  20 20 20 20 20 20 20 20   server          
1990	2a 53 65 72 76 65 72 0a  09 6d 61 63 68 69 6e 65   *Server..machine
19a0	4c 65 61 72 6e 69 6e 67  20 2a 4d 61 63 68 69 6e   Learning *Machin
19b0	65 4c 65 61 72 6e 69 6e  67 0a 0a 09 2f 2f 20 e5   eLearning...// .
19c0	b8 82 e5 9c ba e7 8e af  e5 a2 83 e7 bc 93 e5 ad   ................
19d0	98 0a 09 63 75 72 72 65  6e 74 4d 61 72 6b 65 74   ...currentMarket
19e0	52 65 67 69 6d 65 20 73  74 72 69 6e 67 20 2f 2f   Regime string //
19f0	20 e5 bd 93 e5 89 8d e5  b8 82 e5 9c ba e7 8e af    ...............
1a00	e5 a2 83 0a 0a 09 2f 2f  20 e6 96 b0 e5 a2 9e e7   ......// .......
1a10	bb 84 e4 bb b6 0a 09 63  6f 6e 66 69 67 56 61 6c   .......configVal
1a20	69 64 61 74 6f 72 20 20  20 20 20 20 20 20 20 20   idator          
1a30	2a 43 6f 6e 66 69 67 56  61 6c 69 64 61 74 6f 72   *ConfigValidator
1a40	0a 09 65 72 72 6f 72 48  61 6e 64 6c 65 72 20 20   ..errorHandler  
1a50	20 20 20 20 20 20 20 20  20 20 20 2a 45 72 72 6f              *Erro
1a60	72 48 61 6e 64 6c 65 72  0a 09 72 65 63 6f 76 65   rHandler..recove
1a70	72 79 48 61 6e 64 6c 65  72 20 20 20 20 20 20 20   ryHandler       
1a80	20 20 20 2a 52 65 63 6f  76 65 72 79 48 61 6e 64      *RecoveryHand
1a90	6c 65 72 0a 09 64 61 74  61 50 72 65 70 72 6f 63   ler..dataPreproc
1aa0	65 73 73 6f 72 20 20 20  20 20 20 20 20 20 2a 44   essor         *D
1ab0	61 74 61 50 72 65 70 72  6f 63 65 73 73 6f 72 0a   ataPreprocessor.
1ac0	09 63 61 63 68 65 4d 61  6e 61 67 65 72 20 20 20   .cacheManager   
1ad0	20 20 20 20 20 20 20 20  20 20 2a 43 61 63 68 65             *Cache
1ae0	4d 61 6e 61 67 65 72 0a  09 72 65 73 75 6c 74 43   Manager..resultC
1af0	61 63 68 65 20 20 20 20  20 20 20 20 20 20 20 20   ache            
1b00	20 20 2a 52 65 73 75 6c  74 43 61 63 68 65 0a 09     *ResultCache..
1b10	64 61 74 61 43 61 63 68  65 20 20 20 20 20 20 20   dataCache       
1b20	20 20 20 20 20 20 20 20  20 2a 42 61 63 6b 74 65            *Backte
1b30	73 74 44 61 74 61 43 61  63 68 65 0a 09 72 69 73   stDataCache..ris
1b40	6b 43 61 6c 63 75 6c 61  74 6f 72 20 20 20 20 20   kCalculator     
1b50	20 20 20 20 20 20 2a 52  69 73 6b 43 61 6c 63 75         *RiskCalcu
1b60	6c 61 74 6f 72 0a 09 6d  6f 6e 69 74 6f 72 20 20   lator..monitor  
1b70	20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20                   
1b80	2a 4d 6f 6e 69 74 6f 72  0a 09 70 65 72 66 4d 6f   *Monitor..perfMo
1b90	6e 69 74 6f 72 20 20 20  20 20 20 20 20 20 20 20   nitor           
1ba0	20 20 20 2a 50 65 72 66  6f 72 6d 61 6e 63 65 4d      *PerformanceM
1bb0	6f 6e 69 74 6f 72 0a 09  77 65 69 67 68 74 43 6f   onitor..weightCo
1bc0	6e 74 72 6f 6c 6c 65 72  20 20 20 20 20 20 20 20   ntroller        
1bd0	20 2a 41 64 61 70 74 69  76 65 57 65 69 67 68 74    *AdaptiveWeight
1be0	43 6f 6e 74 72 6f 6c 6c  65 72 0a 09 64 79 6e 61   Controller..dyna
1bf0	6d 69 63 54 68 72 65 73  68 6f 6c 64 4d 61 6e 61   micThresholdMana
1c00	67 65 72 20 20 2a 44 79  6e 61 6d 69 63 54 68 72   ger  *DynamicThr
1c10	65 73 68 6f 6c 64 4d 61  6e 61 67 65 72 0a 09 61   esholdManager..a
1c20	64 61 70 74 69 76 65 46  72 65 71 75 65 6e 63 79   daptiveFrequency
1c30	4d 61 6e 61 67 65 72 20  2a 41 64 61 70 74 69 76   Manager *Adaptiv
1c40	65 46 72 65 71 75 65 6e  63 79 4d 61 6e 61 67 65   eFrequencyManage
1c50	72 0a 0a 09 2f 2f 20 e6  80 a7 e8 83 bd e4 bc 98   r...// .........
1c60	e5 8c 96 e7 bb 84 e4 bb  b6 0a 09 66 65 61 74 75   ...........featu
1c70	72 65 43 61 63 68 65 20  20 20 20 20 20 6d 61 70   reCache      map
1c80	5b 73 74 72 69 6e 67 5d  2a 46 65 61 74 75 72 65   [string]*Feature
1c90	43 61 63 68 65 20 20 20  20 20 20 2f 2f 20 e7 89   Cache      // ..
1ca0	b9 e5 be 81 e7 bc 93 e5  ad 98 20 6b 65 79 3a 20   .......... key: 
1cb0	73 79 6d 62 6f 6c 5f 73  74 61 72 74 44 61 74 65   symbol_startDate
1cc0	5f 65 6e 64 44 61 74 65  0a 09 6d 6c 50 72 65 64   _endDate..mlPred
1cd0	69 63 74 69 6f 6e 43 61  63 68 65 20 6d 61 70 5b   ictionCache map[
1ce0	73 74 72 69 6e 67 5d 2a  4d 4c 50 72 65 64 69 63   string]*MLPredic
1cf0	74 69 6f 6e 43 61 63 68  65 20 2f 2f 20 4d 4c e9   tionCache // ML.
1d00	a2 84 e6 b5 8b e7 bc 93  e5 ad 98 20 6b 65 79 3a   ........... key:
1d10	20 73 79 6d 62 6f 6c 5f  73 74 61 72 74 44 61 74    symbol_startDat
1d20	65 5f 65 6e 64 44 61 74  65 0a 09 64 65 63 69 73   e_endDate..decis
1d30	69 6f 6e 43 61 63 68 65  20 20 20 20 20 6d 61 70   ionCache     map
1d40	5b 73 74 72 69 6e 67 5d  2a 44 65 63 69 73 69 6f   [string]*Decisio
1d50	6e 43 61 63 68 65 20 20  20 20 20 2f 2f 20 e5 86   nCache     // ..
1d60	b3 e7 ad 96 e7 bc 93 e5  ad 98 20 6b 65 79 3a 20   .......... key: 
1d70	73 79 6d 62 6f 6c 5f 73  74 61 72 74 44 61 74 65   symbol_startDate
1d80	5f 65 6e 64 44 61 74 65  0a 09 63 61 63 68 65 4d   _endDate..cacheM
1d90	75 74 65 78 20 20 20 20  20 20 20 20 73 79 6e 63   utex        sync
1da0	2e 52 57 4d 75 74 65 78  0a 0a 09 2f 2f 20 e5 bd   .RWMutex...// ..
1db0	93 e5 89 8d e5 9b 9e e6  b5 8b e7 9a 84 e7 bc 93   ................
1dc0	e5 ad 98 e9 94 ae ef bc  8c e9 81 bf e5 85 8d e9   ................
1dd0	87 8d e5 a4 8d e8 ae a1  e7 ae 97 0a 09 63 75 72   .............cur
1de0	72 65 6e 74 42 61 63 6b  74 65 73 74 4b 65 79 20   rentBacktestKey 
1df0	73 74 72 69 6e 67 0a 7d  0a 0a 2f 2f 20 44 79 6e   string.}..// Dyn
1e00	61 6d 69 63 54 68 72 65  73 68 6f 6c 64 4d 61 6e   amicThresholdMan
1e10	61 67 65 72 20 e5 8a a8  e6 80 81 e9 98 88 e5 80   ager ...........
1e20	bc e7 ae a1 e7 90 86 e5  99 a8 0a 74 79 70 65 20   ...........type 
1e30	44 79 6e 61 6d 69 63 54  68 72 65 73 68 6f 6c 64   DynamicThreshold
1e40	4d 61 6e 61 67 65 72 20  73 74 72 75 63 74 20 7b   Manager struct {
1e50	0a 09 6d 75 20 20 20 20  20 20 20 20 20 20 20 73   ..mu           s
1e60	79 6e 63 2e 52 57 4d 75  74 65 78 0a 09 74 68 72   ync.RWMutex..thr
1e70	65 73 68 6f 6c 64 73 20  20 20 6d 61 70 5b 73 74   esholds   map[st
1e80	72 69 6e 67 5d 2a 44 79  6e 61 6d 69 63 54 68 72   ring]*DynamicThr
1e90	65 73 68 6f 6c 64 0a 09  68 69 73 74 6f 72 79 20   eshold..history 
1ea0	20 20 20 20 20 5b 5d 54  68 72 65 73 68 6f 6c 64        []Threshold
1eb0	48 69 73 74 6f 72 79 0a  09 6c 65 61 72 6e 69 6e   History..learnin
1ec0	67 52 61 74 65 20 66 6c  6f 61 74 36 34 0a 09 6d   gRate float64..m
1ed0	65 6d 6f 72 79 53 69 7a  65 20 20 20 69 6e 74 0a   emorySize   int.
1ee0	7d 0a 0a 2f 2f 20 44 79  6e 61 6d 69 63 54 68 72   }..// DynamicThr
1ef0	65 73 68 6f 6c 64 20 e5  8a a8 e6 80 81 e9 98 88   eshold .........
1f00	e5 80 bc 0a 74 79 70 65  20 44 79 6e 61 6d 69 63   ....type Dynamic
1f10	54 68 72 65 73 68 6f 6c  64 20 73 74 72 75 63 74   Threshold struct
1f20	20 7b 0a 09 53 79 6d 62  6f 6c 20 20 20 20 20 20    {..Symbol      
1f30	20 20 73 74 72 69 6e 67  0a 09 42 75 79 54 68 72     string..BuyThr
1f40	65 73 68 6f 6c 64 20 20  66 6c 6f 61 74 36 34 0a   eshold  float64.
1f50	09 53 65 6c 6c 54 68 72  65 73 68 6f 6c 64 20 66   .SellThreshold f
1f60	6c 6f 61 74 36 34 0a 09  4c 61 73 74 55 70 64 61   loat64..LastUpda
1f70	74 65 20 20 20 20 74 69  6d 65 2e 54 69 6d 65 0a   te    time.Time.
1f80	09 43 6f 6e 66 69 64 65  6e 63 65 20 20 20 20 66   .Confidence    f
1f90	6c 6f 61 74 36 34 0a 09  4d 61 72 6b 65 74 52 65   loat64..MarketRe
1fa0	67 69 6d 65 20 20 73 74  72 69 6e 67 0a 7d 0a 0a   gime  string.}..
1fb0	2f 2f 20 54 68 72 65 73  68 6f 6c 64 48 69 73 74   // ThresholdHist
1fc0	6f 72 79 20 e9 98 88 e5  80 bc e5 8e 86 e5 8f b2   ory ............
1fd0	0a 74 79 70 65 20 54 68  72 65 73 68 6f 6c 64 48   .type ThresholdH
1fe0	69 73 74 6f 72 79 20 73  74 72 75 63 74 20 7b 0a   istory struct {.
1ff0	09 54 69 6d 65 73 74 61  6d 70 20 20 20 20 20 74   .Timestamp     t
2000	69 6d 65 2e 54 69 6d 65  0a 09 53 79 6d 62 6f 6c   ime.Time..Symbol
2010	20 20 20 20 20 20 20 20  73 74 72 69 6e 67 0a 09           string..
2020	4f 6c 64 42 75 79 54 68  72 65 73 68 20 20 66 6c   OldBuyThresh  fl
2030	6f 61 74 36 34 0a 09 4e  65 77 42 75 79 54 68 72   oat64..NewBuyThr
2040	65 73 68 20 20 66 6c 6f  61 74 36 34 0a 09 4f 6c   esh  float64..Ol
2050	64 53 65 6c 6c 54 68 72  65 73 68 20 66 6c 6f 61   dSellThresh floa
2060	74 36 34 0a 09 4e 65 77  53 65 6c 6c 54 68 72 65   t64..NewSellThre
2070	73 68 20 66 6c 6f 61 74  36 34 0a 09 52 65 61 73   sh float64..Reas
2080	6f 6e 20 20 20 20 20 20  20 20 73 74 72 69 6e 67   on        string
2090	0a 7d 0a 0a 2f 2f 20 41  64 61 70 74 69 76 65 46   .}..// AdaptiveF
20a0	72 65 71 75 65 6e 63 79  4d 61 6e 61 67 65 72 20   requencyManager 
20b0	e8 87 aa e9 80 82 e5 ba  94 e9 a2 91 e7 8e 87 e7   ................
20c0	ae a1 e7 90 86 e5 99 a8  0a 74 79 70 65 20 41 64   .........type Ad
20d0	61 70 74 69 76 65 46 72  65 71 75 65 6e 63 79 4d   aptiveFrequencyM
20e0	61 6e 61 67 65 72 20 73  74 72 75 63 74 20 7b 0a   anager struct {.
20f0	09 6d 75 20 20 20 20 20  20 20 20 20 20 73 79 6e   .mu          syn
2100	63 2e 52 57 4d 75 74 65  78 0a 09 66 72 65 71 75   c.RWMutex..frequ
2110	65 6e 63 69 65 73 20 6d  61 70 5b 73 74 72 69 6e   encies map[strin
2120	67 5d 2a 41 64 61 70 74  69 76 65 46 72 65 71 75   g]*AdaptiveFrequ
2130	65 6e 63 79 0a 09 68 69  73 74 6f 72 79 20 20 20   ency..history   
2140	20 20 5b 5d 46 72 65 71  75 65 6e 63 79 48 69 73     []FrequencyHis
2150	74 6f 72 79 0a 09 6d 69  6e 49 6e 74 65 72 76 61   tory..minInterva
2160	6c 20 74 69 6d 65 2e 44  75 72 61 74 69 6f 6e 0a   l time.Duration.
2170	09 6d 61 78 49 6e 74 65  72 76 61 6c 20 74 69 6d   .maxInterval tim
2180	65 2e 44 75 72 61 74 69  6f 6e 0a 7d 0a 0a 2f 2f   e.Duration.}..//
2190	20 41 64 61 70 74 69 76  65 46 72 65 71 75 65 6e    AdaptiveFrequen
21a0	63 79 20 e8 87 aa e9 80  82 e5 ba 94 e9 a2 91 e7   cy .............
21b0	8e 87 0a 74 79 70 65 20  41 64 61 70 74 69 76 65   ...type Adaptive
21c0	46 72 65 71 75 65 6e 63  79 20 73 74 72 75 63 74   Frequency struct
21d0	20 7b 0a 09 53 79 6d 62  6f 6c 20 20 20 20 20 20    {..Symbol      
21e0	20 20 20 20 20 73 74 72  69 6e 67 0a 09 49 6e 74        string..Int
21f0	65 72 76 61 6c 20 20 20  20 20 20 20 20 20 74 69   erval         ti
2200	6d 65 2e 44 75 72 61 74  69 6f 6e 0a 09 4c 61 73   me.Duration..Las
2210	74 55 70 64 61 74 65 20  20 20 20 20 20 20 74 69   tUpdate       ti
2220	6d 65 2e 54 69 6d 65 0a  09 50 65 72 66 6f 72 6d   me.Time..Perform
2230	61 6e 63 65 20 20 20 20  20 20 66 6c 6f 61 74 36   ance      float6
2240	34 0a 09 4d 61 72 6b 65  74 56 6f 6c 61 74 69 6c   4..MarketVolatil
2250	69 74 79 20 66 6c 6f 61  74 36 34 0a 7d 0a 0a 2f   ity float64.}../
2260	2f 20 46 72 65 71 75 65  6e 63 79 48 69 73 74 6f   / FrequencyHisto
2270	72 79 20 e9 a2 91 e7 8e  87 e5 8e 86 e5 8f b2 0a   ry .............
2280	74 79 70 65 20 46 72 65  71 75 65 6e 63 79 48 69   type FrequencyHi
2290	73 74 6f 72 79 20 73 74  72 75 63 74 20 7b 0a 09   story struct {..
22a0	54 69 6d 65 73 74 61 6d  70 20 20 20 74 69 6d 65   Timestamp   time
22b0	2e 54 69 6d 65 0a 09 53  79 6d 62 6f 6c 20 20 20   .Time..Symbol   
22c0	20 20 20 73 74 72 69 6e  67 0a 09 4f 6c 64 49 6e      string..OldIn
22d0	74 65 72 76 61 6c 20 74  69 6d 65 2e 44 75 72 61   terval time.Dura
22e0	74 69 6f 6e 0a 09 4e 65  77 49 6e 74 65 72 76 61   tion..NewInterva
22f0	6c 20 74 69 6d 65 2e 44  75 72 61 74 69 6f 6e 0a   l time.Duration.
2300	09 52 65 61 73 6f 6e 20  20 20 20 20 20 73 74 72   .Reason      str
2310	69 6e 67 0a 7d 0a 0a 2f  2f 20 4e 65 77 42 61 63   ing.}..// NewBac
2320	6b 74 65 73 74 45 6e 67  69 6e 65 20 e5 88 9b e5   ktestEngine ....
2330	bb ba e5 9b 9e e6 b5 8b  e5 bc 95 e6 93 8e 0a 66   ...............f
2340	75 6e 63 20 4e 65 77 42  61 63 6b 74 65 73 74 45   unc NewBacktestE
2350	6e 67 69 6e 65 28 64 62  20 44 61 74 61 62 61 73   ngine(db Databas
2360	65 2c 20 64 61 74 61 4d  61 6e 61 67 65 72 20 2a   e, dataManager *
2370	44 61 74 61 4d 61 6e 61  67 65 72 2c 20 65 6e 73   DataManager, ens
2380	65 6d 62 6c 65 4d 6f 64  65 6c 73 20 6d 61 70 5b   embleModels map[
2390	73 74 72 69 6e 67 5d 2a  45 6e 73 65 6d 62 6c 65   string]*Ensemble
23a0	50 72 65 64 69 63 74 6f  72 2c 20 73 65 72 76 65   Predictor, serve
23b0	72 20 2a 53 65 72 76 65  72 2c 20 6d 61 63 68 69   r *Server, machi
23c0	6e 65 4c 65 61 72 6e 69  6e 67 20 2a 4d 61 63 68   neLearning *Mach
23d0	69 6e 65 4c 65 61 72 6e  69 6e 67 29 20 2a 42 61   ineLearning) *Ba
23e0	63 6b 74 65 73 74 45 6e  67 69 6e 65 20 7b 0a 09   cktestEngine {..
23f0	65 6e 67 69 6e 65 20 3a  3d 20 26 42 61 63 6b 74   engine := &Backt
2400	65 73 74 45 6e 67 69 6e  65 7b 0a 09 09 64 62 3a   estEngine{...db:
2410	20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20                   
2420	64 62 2c 0a 09 09 64 61  74 61 4d 61 6e 61 67 65   db,...dataManage
2430	72 3a 20 20 20 20 20 20  20 64 61 74 61 4d 61 6e   r:       dataMan
2440	61 67 65 72 2c 0a 09 09  65 6e 73 65 6d 62 6c 65   ager,...ensemble
2450	4d 6f 64 65 6c 73 3a 20  20 20 20 65 6e 73 65 6d   Models:    ensem
2460	62 6c 65 4d 6f 64 65 6c  73 2c 0a 09 09 73 65 72   bleModels,...ser
2470	76 65 72 3a 20 20 20 20  20 20 20 20 20 20 20 20   ver:            
2480	73 65 72 76 65 72 2c 0a  09 09 6d 61 63 68 69 6e   server,...machin
2490	65 4c 65 61 72 6e 69 6e  67 3a 20 20 20 6d 61 63   eLearning:   mac
24a0	68 69 6e 65 4c 65 61 72  6e 69 6e 67 2c 0a 09 09   hineLearning,...
24b0	66 65 61 74 75 72 65 43  61 63 68 65 3a 20 20 20   featureCache:   
24c0	20 20 20 6d 61 6b 65 28  6d 61 70 5b 73 74 72 69      make(map[stri
24d0	6e 67 5d 2a 46 65 61 74  75 72 65 43 61 63 68 65   ng]*FeatureCache
24e0	29 2c 0a 09 09 6d 6c 50  72 65 64 69 63 74 69 6f   ),...mlPredictio
24f0	6e 43 61 63 68 65 3a 20  6d 61 6b 65 28 6d 61 70   nCache: make(map
2500	5b 73 74 72 69 6e 67 5d  2a 4d 4c 50 72 65 64 69   [string]*MLPredi
2510	63 74 69 6f 6e 43 61 63  68 65 29 2c 0a 09 09 64   ctionCache),...d
2520	65 63 69 73 69 6f 6e 43  61 63 68 65 3a 20 20 20   ecisionCache:   
2530	20 20 6d 61 6b 65 28 6d  61 70 5b 73 74 72 69 6e     make(map[strin
2540	67 5d 2a 44 65 63 69 73  69 6f 6e 43 61 63 68 65   g]*DecisionCache
2550	29 2c 0a 09 7d 0a 0a 09  2f 2f 20 e5 88 9d e5 a7   ),..}...// .....
2560	8b e5 8c 96 e7 bb 84 e4  bb b6 0a 09 65 6e 67 69   ............engi
2570	6e 65 2e 63 6f 6e 66 69  67 56 61 6c 69 64 61 74   ne.configValidat
2580	6f 72 20 3d 20 4e 65 77  43 6f 6e 66 69 67 56 61   or = NewConfigVa
2590	6c 69 64 61 74 6f 72 28  29 0a 09 65 6e 67 69 6e   lidator()..engin
25a0	65 2e 65 72 72 6f 72 48  61 6e 64 6c 65 72 20 3d   e.errorHandler =
25b0	20 4e 65 77 45 72 72 6f  72 48 61 6e 64 6c 65 72    NewErrorHandler
25c0	28 29 0a 09 65 6e 67 69  6e 65 2e 72 65 63 6f 76   ()..engine.recov
25d0	65 72 79 48 61 6e 64 6c  65 72 20 3d 20 4e 65 77   eryHandler = New
25e0	52 65 63 6f 76 65 72 79  48 61 6e 64 6c 65 72 28   RecoveryHandler(
25f0	29 0a 09 65 6e 67 69 6e  65 2e 64 61 74 61 50 72   )..engine.dataPr
2600	65 70 72 6f 63 65 73 73  6f 72 20 3d 20 4e 65 77   eprocessor = New
2610	44 61 74 61 50 72 65 70  72 6f 63 65 73 73 6f 72   DataPreprocessor
2620	28 29 0a 09 65 6e 67 69  6e 65 2e 63 61 63 68 65   ()..engine.cache
2630	4d 61 6e 61 67 65 72 20  3d 20 4e 65 77 43 61 63   Manager = NewCac
2640	68 65 4d 61 6e 61 67 65  72 28 31 30 30 30 29 0a   heManager(1000).
2650	09 65 6e 67 69 6e 65 2e  72 65 73 75 6c 74 43 61   .engine.resultCa
2660	63 68 65 20 3d 20 4e 65  77 52 65 73 75 6c 74 43   che = NewResultC
2670	61 63 68 65 28 35 30 30  2c 20 74 69 6d 65 2e 48   ache(500, time.H
2680	6f 75 72 2a 32 34 29 0a  09 65 6e 67 69 6e 65 2e   our*24)..engine.
2690	64 61 74 61 43 61 63 68  65 20 3d 20 4e 65 77 42   dataCache = NewB
26a0	61 63 6b 74 65 73 74 44  61 74 61 43 61 63 68 65   acktestDataCache
26b0	28 29 0a 09 65 6e 67 69  6e 65 2e 72 69 73 6b 43   ()..engine.riskC
26c0	61 6c 63 75 6c 61 74 6f  72 20 3d 20 4e 65 77 52   alculator = NewR
26d0	69 73 6b 43 61 6c 63 75  6c 61 74 6f 72 28 29 0a   iskCalculator().
26e0	09 65 6e 67 69 6e 65 2e  6d 6f 6e 69 74 6f 72 20   .engine.monitor 
26f0	3d 20 4e 65 77 4d 6f 6e  69 74 6f 72 28 29 0a 09   = NewMonitor()..
2700	65 6e 67 69 6e 65 2e 70  65 72 66 4d 6f 6e 69 74   engine.perfMonit
2710	6f 72 20 3d 20 4e 65 77  50 65 72 66 6f 72 6d 61   or = NewPerforma
2720	6e 63 65 4d 6f 6e 69 74  6f 72 28 29 0a 09 65 6e   nceMonitor()..en
2730	67 69 6e 65 2e 77 65 69  67 68 74 43 6f 6e 74 72   gine.weightContr
2740	6f 6c 6c 65 72 20 3d 20  4e 65 77 41 64 61 70 74   oller = NewAdapt
2750	69 76 65 57 65 69 67 68  74 43 6f 6e 74 72 6f 6c   iveWeightControl
2760	6c 65 72 28 29 0a 0a 09  2f 2f 20 e5 88 9d e5 a7   ler()...// .....
2770	8b e5 8c 96 e6 96 b0 e5  a2 9e e7 9a 84 e7 bb 84   ................
2780	e4 bb b6 0a 09 65 6e 67  69 6e 65 2e 64 79 6e 61   .....engine.dyna
2790	6d 69 63 54 68 72 65 73  68 6f 6c 64 4d 61 6e 61   micThresholdMana
27a0	67 65 72 20 3d 20 4e 65  77 44 79 6e 61 6d 69 63   ger = NewDynamic
27b0	54 68 72 65 73 68 6f 6c  64 4d 61 6e 61 67 65 72   ThresholdManager
27c0	28 29 0a 09 65 6e 67 69  6e 65 2e 61 64 61 70 74   ()..engine.adapt
27d0	69 76 65 46 72 65 71 75  65 6e 63 79 4d 61 6e 61   iveFrequencyMana
27e0	67 65 72 20 3d 20 4e 65  77 41 64 61 70 74 69 76   ger = NewAdaptiv
27f0	65 46 72 65 71 75 65 6e  63 79 4d 61 6e 61 67 65   eFrequencyManage
2800	72 28 29 0a 0a 09 72 65  74 75 72 6e 20 65 6e 67   r()...return eng
2810	69 6e 65 0a 7d 0a 0a 2f  2f 20 4e 65 77 44 79 6e   ine.}..// NewDyn
2820	61 6d 69 63 54 68 72 65  73 68 6f 6c 64 4d 61 6e   amicThresholdMan
2830	61 67 65 72 20 e5 88 9b  e5 bb ba e5 8a a8 e6 80   ager ...........
2840	81 e9 98 88 e5 80 bc e7  ae a1 e7 90 86 e5 99 a8   ................
2850	0a 66 75 6e 63 20 4e 65  77 44 79 6e 61 6d 69 63   .func NewDynamic
2860	54 68 72 65 73 68 6f 6c  64 4d 61 6e 61 67 65 72   ThresholdManager
2870	28 29 20 2a 44 79 6e 61  6d 69 63 54 68 72 65 73   () *DynamicThres
2880	68 6f 6c 64 4d 61 6e 61  67 65 72 20 7b 0a 09 72   holdManager {..r
2890	65 74 75 72 6e 20 26 44  79 6e 61 6d 69 63 54 68   eturn &DynamicTh
28a0	72 65 73 68 6f 6c 64 4d  61 6e 61 67 65 72 7b 0a   resholdManager{.
28b0	09 09 74 68 72 65 73 68  6f 6c 64 73 3a 20 20 20   ..thresholds:   
28c0	6d 61 6b 65 28 6d 61 70  5b 73 74 72 69 6e 67 5d   make(map[string]
28d0	2a 44 79 6e 61 6d 69 63  54 68 72 65 73 68 6f 6c   *DynamicThreshol
28e0	64 29 2c 0a 09 09 68 69  73 74 6f 72 79 3a 20 20   d),...history:  
28f0	20 20 20 20 6d 61 6b 65  28 5b 5d 54 68 72 65 73       make([]Thres
2900	68 6f 6c 64 48 69 73 74  6f 72 79 2c 20 30 29 2c   holdHistory, 0),
2910	0a 09 09 6c 65 61 72 6e  69 6e 67 52 61 74 65 3a   ...learningRate:
2920	20 30 2e 31 2c 0a 09 09  6d 65 6d 6f 72 79 53 69    0.1,...memorySi
2930	7a 65 3a 20 20 20 31 30  30 30 2c 0a 09 7d 0a 7d   ze:   1000,..}.}
2940	0a 0a 2f 2f 20 4e 65 77  41 64 61 70 74 69 76 65   ..// NewAdaptive
2950	46 72 65 71 75 65 6e 63  79 4d 61 6e 61 67 65 72   FrequencyManager
2960	20 e5 88 9b e5 bb ba e8  87 aa e9 80 82 e5 ba 94    ...............
2970	e9 a2 91 e7 8e 87 e7 ae  a1 e7 90 86 e5 99 a8 0a   ................
2980	66 75 6e 63 20 4e 65 77  41 64 61 70 74 69 76 65   func NewAdaptive
2990	46 72 65 71 75 65 6e 63  79 4d 61 6e 61 67 65 72   FrequencyManager
29a0	28 29 20 2a 41 64 61 70  74 69 76 65 46 72 65 71   () *AdaptiveFreq
29b0	75 65 6e 63 79 4d 61 6e  61 67 65 72 20 7b 0a 09   uencyManager {..
29c0	72 65 74 75 72 6e 20 26  41 64 61 70 74 69 76 65   return &Adaptive
29d0	46 72 65 71 75 65 6e 63  79 4d 61 6e 61 67 65 72   FrequencyManager
29e0	7b 0a 09 09 66 72 65 71  75 65 6e 63 69 65 73 3a   {...frequencies:
29f0	20 6d 61 6b 65 28 6d 61  70 5b 73 74 72 69 6e 67    make(map[string
2a00	5d 2a 41 64 61 70 74 69  76 65 46 72 65 71 75 65   ]*AdaptiveFreque
2a10	6e 63 79 29 2c 0a 09 09  68 69 73 74 6f 72 79 3a   ncy),...history:
2a20	20 20 20 20 20 6d 61 6b  65 28 5b 5d 46 72 65 71        make([]Freq
2a30	75 65 6e 63 79 48 69 73  74 6f 72 79 2c 20 30 29   uencyHistory, 0)
2a40	2c 0a 09 09 6d 69 6e 49  6e 74 65 72 76 61 6c 3a   ,...minInterval:
2a50	20 74 69 6d 65 2e 4d 69  6e 75 74 65 20 2a 20 35    time.Minute * 5
2a60	2c 20 2f 2f 20 e6 9c 80  e5 b0 8f 35 e5 88 86 e9   , // ......5....
2a70	92 9f e9 97 b4 e9 9a 94  0a 09 09 6d 61 78 49 6e   ...........maxIn
2a80	74 65 72 76 61 6c 3a 20  74 69 6d 65 2e 48 6f 75   terval: time.Hou
2a90	72 20 2a 20 32 34 2c 20  20 2f 2f 20 e6 9c 80 e5   r * 24,  // ....
2aa0	a4 a7 32 34 e5 b0 8f e6  97 b6 e9 97 b4 e9 9a 94   ..24............
2ab0	0a 09 7d 0a 7d 0a 0a 2f  2f 20 52 75 6e 42 61 63   ..}.}..// RunBac
2ac0	6b 74 65 73 74 20 e8 bf  90 e8 a1 8c e5 9b 9e e6   ktest ..........
2ad0	b5 8b 0a 66 75 6e 63 20  28 62 65 20 2a 42 61 63   ...func (be *Bac
2ae0	6b 74 65 73 74 45 6e 67  69 6e 65 29 20 52 75 6e   ktestEngine) Run
2af0	42 61 63 6b 74 65 73 74  28 63 74 78 20 63 6f 6e   Backtest(ctx con
2b00	74 65 78 74 2e 43 6f 6e  74 65 78 74 2c 20 63 6f   text.Context, co
2b10	6e 66 69 67 20 42 61 63  6b 74 65 73 74 43 6f 6e   nfig BacktestCon
2b20	66 69 67 29 20 28 2a 42  61 63 6b 74 65 73 74 52   fig) (*BacktestR
2b30	65 73 75 6c 74 2c 20 65  72 72 6f 72 29 20 7b 0a   esult, error) {.
2b40	09 2f 2f 20 e7 a1 ae e5  ae 9a e8 a6 81 e7 9b 91   .// ............
2b50	e6 8e a7 e7 9a 84 e5 b8  81 e7 a7 8d e5 88 97 e8   ................
2b60	a1 a8 0a 09 73 79 6d 62  6f 6c 73 20 3a 3d 20 63   ....symbols := c
2b70	6f 6e 66 69 67 2e 53 79  6d 62 6f 6c 73 0a 09 69   onfig.Symbols..i
2b80	66 20 6c 65 6e 28 73 79  6d 62 6f 6c 73 29 20 3d   f len(symbols) =
2b90	3d 20 30 20 7b 0a 09 09  2f 2f 20 e5 90 91 e5 90   = 0 {...// .....
2ba0	8e e5 85 bc e5 ae b9 ef  bc 9a e5 a6 82 e6 9e 9c   ................
2bb0	e6 b2 a1 e6 9c 89 e6 8c  87 e5 ae 9a 53 79 6d 62   ............Symb
2bc0	6f 6c 73 ef bc 8c e4 bd  bf e7 94 a8 e5 8d 95 e4   ols.............
2bd0	b8 aa 53 79 6d 62 6f 6c  0a 09 09 73 79 6d 62 6f   ..Symbol...symbo
2be0	6c 73 20 3d 20 5b 5d 73  74 72 69 6e 67 7b 63 6f   ls = []string{co
2bf0	6e 66 69 67 2e 53 79 6d  62 6f 6c 7d 0a 09 7d 0a   nfig.Symbol}..}.
2c00	0a 09 6c 6f 67 2e 50 72  69 6e 74 66 28 22 5b 52   ..log.Printf("[R
2c10	75 6e 42 61 63 6b 74 65  73 74 5d 20 e5 bc 80 e5   unBacktest] ....
2c20	a7 8b e6 89 a7 e8 a1 8c  e5 a4 9a e5 b8 81 e7 a7   ................
2c30	8d e5 9b 9e e6 b5 8b 3a  20 73 79 6d 62 6f 6c 73   .......: symbols
2c40	3d 25 76 2c 20 73 74 72  61 74 65 67 79 3d 25 73   =%v, strategy=%s
2c50	2c 20 70 65 72 69 6f 64  3d 25 73 20 74 6f 20 25   , period=%s to %
2c60	73 22 2c 0a 09 09 73 79  6d 62 6f 6c 73 2c 20 63   s",...symbols, c
2c70	6f 6e 66 69 67 2e 53 74  72 61 74 65 67 79 2c 20   onfig.Strategy, 
2c80	63 6f 6e 66 69 67 2e 53  74 61 72 74 44 61 74 65   config.StartDate
2c90	2e 46 6f 72 6d 61 74 28  22 32 30 30 36 2d 30 31   .Format("2006-01
2ca0	2d 30 32 22 29 2c 20 63  6f 6e 66 69 67 2e 45 6e   -02"), config.En
2cb0	64 44 61 74 65 2e 46 6f  72 6d 61 74 28 22 32 30   dDate.Format("20
2cc0	30 36 2d 30 31 2d 30 32  22 29 29 0a 0a 09 2f 2f   06-01-02"))...//
2cd0	20 e8 8e b7 e5 8f 96 e6  89 80 e6 9c 89 e5 b8 81    ...............
2ce0	e7 a7 8d e7 9a 84 e5 8e  86 e5 8f b2 e6 95 b0 e6   ................
2cf0	8d ae 0a 09 73 79 6d 62  6f 6c 44 61 74 61 20 3a   ....symbolData :
2d00	3d 20 6d 61 6b 65 28 6d  61 70 5b 73 74 72 69 6e   = make(map[strin
2d10	67 5d 5b 5d 4d 61 72 6b  65 74 44 61 74 61 29 0a   g][]MarketData).
2d20	09 66 6f 72 20 5f 2c 20  73 79 6d 62 6f 6c 20 3a   .for _, symbol :
2d30	3d 20 72 61 6e 67 65 20  73 79 6d 62 6f 6c 73 20   = range symbols 
2d40	7b 0a 09 09 64 61 74 61  2c 20 65 72 72 20 3a 3d   {...data, err :=
2d50	20 62 65 2e 67 65 74 48  69 73 74 6f 72 69 63 61    be.getHistorica
2d60	6c 44 61 74 61 28 63 74  78 2c 20 73 79 6d 62 6f   lData(ctx, symbo
2d70	6c 2c 20 63 6f 6e 66 69  67 2e 53 74 61 72 74 44   l, config.StartD
2d80	61 74 65 2c 20 63 6f 6e  66 69 67 2e 45 6e 64 44   ate, config.EndD
2d90	61 74 65 29 0a 09 09 69  66 20 65 72 72 20 21 3d   ate)...if err !=
2da0	20 6e 69 6c 20 7b 0a 09  09 09 6c 6f 67 2e 50 72    nil {....log.Pr
2db0	69 6e 74 66 28 22 5b 52  75 6e 42 61 63 6b 74 65   intf("[RunBackte
2dc0	73 74 5d 20 e8 8e b7 e5  8f 96 25 73 e5 8e 86 e5   st] ......%s....
2dd0	8f b2 e6 95 b0 e6 8d ae  e5 a4 b1 e8 b4 a5 3a 20   ..............: 
2de0	25 76 ef bc 8c e8 b7 b3  e8 bf 87 e6 ad a4 e5 b8   %v..............
2df0	81 e7 a7 8d 22 2c 20 73  79 6d 62 6f 6c 2c 20 65   ....", symbol, e
2e00	72 72 29 0a 09 09 09 63  6f 6e 74 69 6e 75 65 0a   rr)....continue.
2e10	09 09 7d 0a 0a 09 09 69  66 20 6c 65 6e 28 64 61   ..}....if len(da
2e20	74 61 29 20 3c 20 35 30  20 7b 0a 09 09 09 6c 6f   ta) < 50 {....lo
2e30	67 2e 50 72 69 6e 74 66  28 22 5b 52 75 6e 42 61   g.Printf("[RunBa
2e40	63 6b 74 65 73 74 5d 20  25 73 e5 8e 86 e5 8f b2   cktest] %s......
2e50	e6 95 b0 e6 8d ae e4 b8  8d e8 b6 b3 28 25 64 20   ............(%d 
2e60	3c 20 35 30 29 ef bc 8c  e8 b7 b3 e8 bf 87 e6 ad   < 50)...........
2e70	a4 e5 b8 81 e7 a7 8d 22  2c 20 73 79 6d 62 6f 6c   .......", symbol
2e80	2c 20 6c 65 6e 28 64 61  74 61 29 29 0a 09 09 09   , len(data))....
2e90	63 6f 6e 74 69 6e 75 65  0a 09 09 7d 0a 0a 09 09   continue...}....
2ea0	73 79 6d 62 6f 6c 44 61  74 61 5b 73 79 6d 62 6f   symbolData[symbo
2eb0	6c 5d 20 3d 20 64 61 74  61 0a 09 09 6c 6f 67 2e   l] = data...log.
2ec0	50 72 69 6e 74 66 28 22  5b 52 75 6e 42 61 63 6b   Printf("[RunBack
2ed0	74 65 73 74 5d 20 e8 8e  b7 e5 8f 96 e5 88 b0 25   test] .........%
2ee0	73 e7 9a 84 25 64 e4 b8  aa e5 8e 86 e5 8f b2 e6   s...%d..........
2ef0	95 b0 e6 8d ae e7 82 b9  22 2c 20 73 79 6d 62 6f   ........", symbo
2f00	6c 2c 20 6c 65 6e 28 64  61 74 61 29 29 0a 09 7d   l, len(data))..}
2f10	0a 0a 09 69 66 20 6c 65  6e 28 73 79 6d 62 6f 6c   ...if len(symbol
2f20	44 61 74 61 29 20 3d 3d  20 30 20 7b 0a 09 09 72   Data) == 0 {...r
2f30	65 74 75 72 6e 20 6e 69  6c 2c 20 66 6d 74 2e 45   eturn nil, fmt.E
2f40	72 72 6f 72 66 28 22 e6  b2 a1 e6 9c 89 e6 9c 89   rrorf(".........
2f50	e6 95 88 e7 9a 84 e5 8e  86 e5 8f b2 e6 95 b0 e6   ................
2f60	8d ae ef bc 8c e6 89 80  e6 9c 89 e5 b8 81 e7 a7   ................
2f70	8d e9 83 bd e6 97 a0 e6  b3 95 e8 8e b7 e5 8f 96   ................
2f80	e6 95 b0 e6 8d ae 22 29  0a 09 7d 0a 0a 09 2f 2f   ......")..}...//
2f90	20 e5 88 9d e5 a7 8b e5  8c 96 e5 9b 9e e6 b5 8b    ...............
2fa0	e7 bb 93 e6 9e 9c 0a 09  72 65 73 75 6c 74 20 3a   ........result :
2fb0	3d 20 26 42 61 63 6b 74  65 73 74 52 65 73 75 6c   = &BacktestResul
2fc0	74 7b 0a 09 09 43 6f 6e  66 69 67 3a 20 20 20 20   t{...Config:    
2fd0	20 20 20 20 20 20 63 6f  6e 66 69 67 2c 0a 09 09         config,...
2fe0	53 75 6d 6d 61 72 79 3a  20 20 20 20 20 20 20 20   Summary:        
2ff0	20 42 61 63 6b 74 65 73  74 53 75 6d 6d 61 72 79    BacktestSummary
3000	7b 7d 2c 0a 09 09 54 72  61 64 65 73 3a 20 20 20   {},...Trades:   
3010	20 20 20 20 20 20 20 5b  5d 54 72 61 64 65 52 65          []TradeRe
3020	63 6f 72 64 7b 7d 2c 0a  09 09 44 61 69 6c 79 52   cord{},...DailyR
3030	65 74 75 72 6e 73 3a 20  20 20 20 5b 5d 44 61 69   eturns:    []Dai
3040	6c 79 52 65 74 75 72 6e  7b 7d 2c 0a 09 09 52 69   lyReturn{},...Ri
3050	73 6b 4d 65 74 72 69 63  73 3a 20 20 20 20 20 52   skMetrics:     R
3060	69 73 6b 4d 65 74 72 69  63 73 7b 7d 2c 0a 09 09   iskMetrics{},...
3070	50 65 72 66 6f 72 6d 61  6e 63 65 3a 20 20 20 20   Performance:    
3080	20 50 65 72 66 6f 72 6d  61 6e 63 65 4d 65 74 72    PerformanceMetr
3090	69 63 73 7b 7d 2c 0a 09  09 50 6f 72 74 66 6f 6c   ics{},...Portfol
30a0	69 6f 56 61 6c 75 65 73  3a 20 5b 5d 66 6c 6f 61   ioValues: []floa
30b0	74 36 34 7b 7d 2c 0a 09  09 53 79 6d 62 6f 6c 53   t64{},...SymbolS
30c0	74 61 74 73 3a 20 20 20  20 20 6d 61 6b 65 28 6d   tats:     make(m
30d0	61 70 5b 73 74 72 69 6e  67 5d 2a 53 79 6d 62 6f   ap[string]*Symbo
30e0	6c 50 65 72 66 6f 72 6d  61 6e 63 65 29 2c 0a 09   lPerformance),..
30f0	7d 0a 0a 09 2f 2f 20 e6  a0 b9 e6 8d ae e7 ad 96   }...// .........
3100	e7 95 a5 e7 b1 bb e5 9e  8b e6 89 a7 e8 a1 8c e7   ................
3110	9b b8 e5 ba 94 e7 9a 84  e5 9b 9e e6 b5 8b e9 80   ................
3120	bb e8 be 91 0a 09 76 61  72 20 65 72 72 20 65 72   ......var err er
3130	72 6f 72 0a 09 73 77 69  74 63 68 20 63 6f 6e 66   ror..switch conf
3140	69 67 2e 53 74 72 61 74  65 67 79 20 7b 0a 09 63   ig.Strategy {..c
3150	61 73 65 20 22 62 75 79  5f 61 6e 64 5f 68 6f 6c   ase "buy_and_hol
3160	64 22 3a 0a 09 09 65 72  72 20 3d 20 62 65 2e 72   d":...err = be.r
3170	75 6e 4d 75 6c 74 69 53  79 6d 62 6f 6c 42 75 79   unMultiSymbolBuy
3180	41 6e 64 48 6f 6c 64 53  74 72 61 74 65 67 79 28   AndHoldStrategy(
3190	72 65 73 75 6c 74 2c 20  73 79 6d 62 6f 6c 44 61   result, symbolDa
31a0	74 61 29 0a 09 63 61 73  65 20 22 6d 6c 5f 70 72   ta)..case "ml_pr
31b0	65 64 69 63 74 69 6f 6e  22 3a 0a 09 09 65 72 72   ediction":...err
31c0	20 3d 20 62 65 2e 72 75  6e 4d 75 6c 74 69 53 79    = be.runMultiSy
31d0	6d 62 6f 6c 4d 4c 50 72  65 64 69 63 74 69 6f 6e   mbolMLPrediction
31e0	53 74 72 61 74 65 67 79  28 63 74 78 2c 20 72 65   Strategy(ctx, re
31f0	73 75 6c 74 2c 20 73 79  6d 62 6f 6c 44 61 74 61   sult, symbolData
3200	29 0a 09 63 61 73 65 20  22 65 6e 73 65 6d 62 6c   )..case "ensembl
3210	65 22 3a 0a 09 09 65 72  72 20 3d 20 62 65 2e 72   e":...err = be.r
3220	75 6e 4d 75 6c 74 69 53  79 6d 62 6f 6c 45 6e 73   unMultiSymbolEns
3230	65 6d 62 6c 65 53 74 72  61 74 65 67 79 28 63 74   embleStrategy(ct
3240	78 2c 20 72 65 73 75 6c  74 2c 20 73 79 6d 62 6f   x, result, symbo
3250	6c 44 61 74 61 29 0a 09  63 61 73 65 20 22 64 65   lData)..case "de
3260	65 70 5f 6c 65 61 72 6e  69 6e 67 22 3a 0a 09 09   ep_learning":...
3270	65 72 72 20 3d 20 62 65  2e 72 75 6e 4d 75 6c 74   err = be.runMult
3280	69 53 79 6d 62 6f 6c 44  65 65 70 4c 65 61 72 6e   iSymbolDeepLearn
3290	69 6e 67 53 74 72 61 74  65 67 79 28 63 74 78 2c   ingStrategy(ctx,
32a0	20 72 65 73 75 6c 74 2c  20 73 79 6d 62 6f 6c 44    result, symbolD
32b0	61 74 61 29 0a 09 64 65  66 61 75 6c 74 3a 0a 09   ata)..default:..
32c0	09 72 65 74 75 72 6e 20  6e 69 6c 2c 20 66 6d 74   .return nil, fmt
32d0	2e 45 72 72 6f 72 66 28  22 e4 b8 8d e6 94 af e6   .Errorf(".......
32e0	8c 81 e7 9a 84 e7 ad 96  e7 95 a5 e7 b1 bb e5 9e   ................
32f0	8b 3a 20 25 73 22 2c 20  63 6f 6e 66 69 67 2e 53   .: %s", config.S
3300	74 72 61 74 65 67 79 29  0a 09 7d 0a 0a 09 69 66   trategy)..}...if
3310	20 65 72 72 20 21 3d 20  6e 69 6c 20 7b 0a 09 09    err != nil {...
3320	72 65 74 75 72 6e 20 6e  69 6c 2c 20 66 6d 74 2e   return nil, fmt.
3330	45 72 72 6f 72 66 28 22  e7 ad 96 e7 95 a5 e6 89   Errorf("........
3340	a7 e8 a1 8c e5 a4 b1 e8  b4 a5 3a 20 25 77 22 2c   ..........: %w",
3350	20 65 72 72 29 0a 09 7d  0a 0a 09 2f 2f 20 e8 ae    err)..}...// ..
3360	a1 e7 ae 97 e7 bb a9 e6  95 88 e6 8c 87 e6 a0 87   ................
3370	0a 09 62 65 2e 63 61 6c  63 75 6c 61 74 65 50 65   ..be.calculatePe
3380	72 66 6f 72 6d 61 6e 63  65 4d 65 74 72 69 63 73   rformanceMetrics
3390	28 72 65 73 75 6c 74 29  0a 0a 09 2f 2f 20 e8 ae   (result)...// ..
33a0	a1 e7 ae 97 e6 95 b0 e6  8d ae e7 bb 9f e8 ae a1   ................
33b0	0a 09 74 6f 74 61 6c 44  61 74 61 50 6f 69 6e 74   ..totalDataPoint
33c0	73 20 3a 3d 20 30 0a 09  66 6f 72 20 5f 2c 20 64   s := 0..for _, d
33d0	61 74 61 20 3a 3d 20 72  61 6e 67 65 20 73 79 6d   ata := range sym
33e0	62 6f 6c 44 61 74 61 20  7b 0a 09 09 74 6f 74 61   bolData {...tota
33f0	6c 44 61 74 61 50 6f 69  6e 74 73 20 2b 3d 20 6c   lDataPoints += l
3400	65 6e 28 64 61 74 61 29  0a 09 7d 0a 0a 09 6c 6f   en(data)..}...lo
3410	67 2e 50 72 69 6e 74 66  28 22 5b 52 75 6e 42 61   g.Printf("[RunBa
3420	63 6b 74 65 73 74 5d 20  e5 9b 9e e6 b5 8b e5 ae   cktest] ........
3430	8c e6 88 90 3a 20 e6 97  b6 e9 97 b4 e8 8c 83 e5   ....: ..........
3440	9b b4 3d 25 73 e8 87 b3  25 73 2c 20 e6 95 b0 e6   ..=%s...%s, ....
3450	8d ae e7 82 b9 3d 25 64  2c 20 e6 80 bb e6 94 b6   .....=%d, ......
3460	e7 9b 8a e7 8e 87 3d 25  2e 32 66 25 25 2c 20 e8   ......=%.2f%%, .
3470	83 9c e7 8e 87 3d 25 2e  32 66 25 25 2c 20 e4 ba   .....=%.2f%%, ..
3480	a4 e6 98 93 e6 ac a1 e6  95 b0 3d 25 64 22 2c 0a   ..........=%d",.
3490	09 09 63 6f 6e 66 69 67  2e 53 74 61 72 74 44 61   ..config.StartDa
34a0	74 65 2e 46 6f 72 6d 61  74 28 22 32 30 30 36 2d   te.Format("2006-
34b0	30 31 2d 30 32 20 31 35  3a 30 34 3a 30 35 22 29   01-02 15:04:05")
34c0	2c 20 63 6f 6e 66 69 67  2e 45 6e 64 44 61 74 65   , config.EndDate
34d0	2e 46 6f 72 6d 61 74 28  22 32 30 30 36 2d 30 31   .Format("2006-01
34e0	2d 30 32 20 31 35 3a 30  34 3a 30 35 22 29 2c 0a   -02 15:04:05"),.
34f0	09 09 74 6f 74 61 6c 44  61 74 61 50 6f 69 6e 74   ..totalDataPoint
3500	73 2c 20 72 65 73 75 6c  74 2e 53 75 6d 6d 61 72   s, result.Summar
3510	79 2e 54 6f 74 61 6c 52  65 74 75 72 6e 2a 31 30   y.TotalReturn*10
3520	30 2c 20 72 65 73 75 6c  74 2e 53 75 6d 6d 61 72   0, result.Summar
3530	79 2e 57 69 6e 52 61 74  65 2a 31 30 30 2c 20 6c   y.WinRate*100, l
3540	65 6e 28 72 65 73 75 6c  74 2e 54 72 61 64 65 73   en(result.Trades
3550	29 29 0a 0a 09 72 65 74  75 72 6e 20 72 65 73 75   ))...return resu
3560	6c 74 2c 20 6e 69 6c 0a  7d 0a 0a 2f 2f 20 72 75   lt, nil.}..// ru
3570	6e 4d 75 6c 74 69 53 79  6d 62 6f 6c 44 65 65 70   nMultiSymbolDeep
3580	4c 65 61 72 6e 69 6e 67  53 74 72 61 74 65 67 79   LearningStrategy
3590	20 e5 a4 9a e5 b8 81 e7  a7 8d e6 b7 b1 e5 ba a6    ...............
35a0	e5 ad a6 e4 b9 a0 e7 ad  96 e7 95 a5 0a 66 75 6e   .............fun
35b0	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
35c0	6e 67 69 6e 65 29 20 72  75 6e 4d 75 6c 74 69 53   ngine) runMultiS
35d0	79 6d 62 6f 6c 44 65 65  70 4c 65 61 72 6e 69 6e   ymbolDeepLearnin
35e0	67 53 74 72 61 74 65 67  79 28 63 74 78 20 63 6f   gStrategy(ctx co
35f0	6e 74 65 78 74 2e 43 6f  6e 74 65 78 74 2c 20 72   ntext.Context, r
3600	65 73 75 6c 74 20 2a 42  61 63 6b 74 65 73 74 52   esult *BacktestR
3610	65 73 75 6c 74 2c 20 73  79 6d 62 6f 6c 44 61 74   esult, symbolDat
3620	61 20 6d 61 70 5b 73 74  72 69 6e 67 5d 5b 5d 4d   a map[string][]M
3630	61 72 6b 65 74 44 61 74  61 29 20 65 72 72 6f 72   arketData) error
3640	20 7b 0a 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22    {..log.Printf("
3650	5b 4d 55 4c 54 49 5f 53  59 4d 42 4f 4c 5f 44 45   [MULTI_SYMBOL_DE
3660	45 50 5f 4c 45 41 52 4e  49 4e 47 5d 20 e5 bc 80   EP_LEARNING] ...
3670	e5 a7 8b e6 89 a7 e8 a1  8c e5 a4 9a e5 b8 81 e7   ................
3680	a7 8d e6 b7 b1 e5 ba a6  e5 ad a6 e4 b9 a0 e7 ad   ................
3690	96 e7 95 a5 ef bc 8c e7  9b 91 e6 8e a7 25 64 e4   .............%d.
36a0	b8 aa e5 b8 81 e7 a7 8d  22 2c 20 6c 65 6e 28 73   ........", len(s
36b0	79 6d 62 6f 6c 44 61 74  61 29 29 0a 0a 09 63 6f   ymbolData))...co
36c0	6e 66 69 67 20 3a 3d 20  26 72 65 73 75 6c 74 2e   nfig := &result.
36d0	43 6f 6e 66 69 67 0a 0a  09 2f 2f 20 e5 88 9d e5   Config...// ....
36e0	a7 8b e5 8c 96 e6 af 8f  e4 b8 aa e5 b8 81 e7 a7   ................
36f0	8d e7 9a 84 e7 8a b6 e6  80 81 0a 09 73 79 6d 62   ............symb
3700	6f 6c 53 74 61 74 65 73  20 3a 3d 20 6d 61 6b 65   olStates := make
3710	28 6d 61 70 5b 73 74 72  69 6e 67 5d 2a 53 79 6d   (map[string]*Sym
3720	62 6f 6c 53 74 61 74 65  29 0a 09 66 6f 72 20 73   bolState)..for s
3730	79 6d 62 6f 6c 20 3a 3d  20 72 61 6e 67 65 20 73   ymbol := range s
3740	79 6d 62 6f 6c 44 61 74  61 20 7b 0a 09 09 73 79   ymbolData {...sy
3750	6d 62 6f 6c 53 74 61 74  65 73 5b 73 79 6d 62 6f   mbolStates[symbo
3760	6c 5d 20 3d 20 26 53 79  6d 62 6f 6c 53 74 61 74   l] = &SymbolStat
3770	65 7b 0a 09 09 09 53 79  6d 62 6f 6c 3a 20 20 20   e{....Symbol:   
3780	20 20 20 20 20 20 73 79  6d 62 6f 6c 2c 0a 09 09         symbol,...
3790	09 50 6f 73 69 74 69 6f  6e 3a 20 20 20 20 20 20   .Position:      
37a0	20 30 2e 30 2c 0a 09 09  09 43 61 73 68 3a 20 20    0.0,....Cash:  
37b0	20 20 20 20 20 20 20 20  20 30 2e 30 2c 20 2f 2f            0.0, //
37c0	20 e6 af 8f e4 b8 aa e5  b8 81 e7 a7 8d e5 88 9d    ...............
37d0	e5 a7 8b e7 8e b0 e9 87  91 e4 b8 ba 30 ef bc 8c   ............0...
37e0	e7 94 b1 e6 80 bb e8 b5  84 e9 87 91 e5 88 86 e9   ................
37f0	85 8d 0a 09 09 09 48 6f  6c 64 54 69 6d 65 3a 20   ......HoldTime: 
3800	20 20 20 20 20 20 30 2c  0a 09 09 09 4c 61 73 74         0,....Last
3810	54 72 61 64 65 49 6e 64  65 78 3a 20 2d 31 30 2c   TradeIndex: -10,
3820	0a 09 09 09 44 61 74 61  3a 20 20 20 20 20 20 20   ....Data:       
3830	20 20 20 20 73 79 6d 62  6f 6c 44 61 74 61 5b 73       symbolData[s
3840	79 6d 62 6f 6c 5d 2c 0a  09 09 7d 0a 09 7d 0a 0a   ymbol],...}..}..
3850	09 2f 2f 20 e6 80 bb e8  b5 84 e9 87 91 e5 92 8c   .// ............
3860	e5 8f af e7 94 a8 e8 b5  84 e9 87 91 0a 09 74 6f   ..............to
3870	74 61 6c 43 61 73 68 20  3a 3d 20 63 6f 6e 66 69   talCash := confi
3880	67 2e 49 6e 69 74 69 61  6c 43 61 73 68 0a 09 61   g.InitialCash..a
3890	76 61 69 6c 61 62 6c 65  43 61 73 68 20 3a 3d 20   vailableCash := 
38a0	74 6f 74 61 6c 43 61 73  68 0a 0a 09 2f 2f 20 e6   totalCash...// .
38b0	89 be e5 88 b0 e6 89 80  e6 9c 89 e5 b8 81 e7 a7   ................
38c0	8d e6 95 b0 e6 8d ae e7  9a 84 e6 9c 80 e5 b0 8f   ................
38d0	e9 95 bf e5 ba a6 ef bc  8c e4 bd 9c e4 b8 ba e5   ................
38e0	9b 9e e6 b5 8b e5 91 a8  e6 9c 9f 0a 09 6d 69 6e   .............min
38f0	44 61 74 61 4c 65 6e 67  74 68 20 3a 3d 20 69 6e   DataLength := in
3900	74 28 5e 75 69 6e 74 28  30 29 20 3e 3e 20 31 29   t(^uint(0) >> 1)
3910	20 2f 2f 20 6d 61 78 20  69 6e 74 0a 09 66 6f 72    // max int..for
3920	20 5f 2c 20 64 61 74 61  20 3a 3d 20 72 61 6e 67    _, data := rang
3930	65 20 73 79 6d 62 6f 6c  44 61 74 61 20 7b 0a 09   e symbolData {..
3940	09 69 66 20 6c 65 6e 28  64 61 74 61 29 20 3c 20   .if len(data) < 
3950	6d 69 6e 44 61 74 61 4c  65 6e 67 74 68 20 7b 0a   minDataLength {.
3960	09 09 09 6d 69 6e 44 61  74 61 4c 65 6e 67 74 68   ...minDataLength
3970	20 3d 20 6c 65 6e 28 64  61 74 61 29 0a 09 09 7d    = len(data)...}
3980	0a 09 7d 0a 0a 09 69 66  20 6d 69 6e 44 61 74 61   ..}...if minData
3990	4c 65 6e 67 74 68 20 3c  20 35 30 20 7b 0a 09 09   Length < 50 {...
39a0	72 65 74 75 72 6e 20 66  6d 74 2e 45 72 72 6f 72   return fmt.Error
39b0	66 28 22 e6 95 b0 e6 8d  ae e7 82 b9 e4 b8 8d e8   f(".............
39c0	b6 b3 ef bc 8c e6 97 a0  e6 b3 95 e8 bf 9b e8 a1   ................
39d0	8c e5 a4 9a e5 b8 81 e7  a7 8d e6 b7 b1 e5 ba a6   ................
39e0	e5 ad a6 e4 b9 a0 e7 ad  96 e7 95 a5 22 29 0a 09   ............")..
39f0	7d 0a 0a 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   }...log.Printf("
3a00	5b 4d 55 4c 54 49 5f 53  59 4d 42 4f 4c 5f 44 45   [MULTI_SYMBOL_DE
3a10	45 50 5f 4c 45 41 52 4e  49 4e 47 5d 20 e6 95 b0   EP_LEARNING] ...
3a20	e6 8d ae e5 af b9 e9 bd  90 e5 ae 8c e6 88 90 ef   ................
3a30	bc 8c e5 85 b1 e6 9c 89  25 64 e4 b8 aa e5 91 a8   ........%d......
3a40	e6 9c 9f 22 2c 20 6d 69  6e 44 61 74 61 4c 65 6e   ...", minDataLen
3a50	67 74 68 29 0a 0a 09 2f  2f 20 e9 a2 84 e8 ae a1   gth)...// ......
3a60	e7 ae 97 e7 89 b9 e5 be  81 e4 bb a5 e6 8f 90 e9   ................
3a70	ab 98 e6 80 a7 e8 83 bd  0a 09 66 6f 72 20 73 79   ..........for sy
3a80	6d 62 6f 6c 2c 20 64 61  74 61 20 3a 3d 20 72 61   mbol, data := ra
3a90	6e 67 65 20 73 79 6d 62  6f 6c 44 61 74 61 20 7b   nge symbolData {
3aa0	0a 09 09 65 72 72 20 3a  3d 20 62 65 2e 70 72 65   ...err := be.pre
3ab0	63 6f 6d 70 75 74 65 46  65 61 74 75 72 65 73 28   computeFeatures(
3ac0	63 74 78 2c 20 64 61 74  61 2c 20 42 61 63 6b 74   ctx, data, Backt
3ad0	65 73 74 43 6f 6e 66 69  67 7b 0a 09 09 09 53 79   estConfig{....Sy
3ae0	6d 62 6f 6c 3a 20 20 20  20 20 20 73 79 6d 62 6f   mbol:      symbo
3af0	6c 2c 0a 09 09 09 53 74  61 72 74 44 61 74 65 3a   l,....StartDate:
3b00	20 20 20 63 6f 6e 66 69  67 2e 53 74 61 72 74 44      config.StartD
3b10	61 74 65 2c 0a 09 09 09  45 6e 64 44 61 74 65 3a   ate,....EndDate:
3b20	20 20 20 20 20 63 6f 6e  66 69 67 2e 45 6e 64 44        config.EndD
3b30	61 74 65 2c 0a 09 09 09  53 79 6d 62 6f 6c 73 3a   ate,....Symbols:
3b40	20 20 20 20 20 5b 5d 73  74 72 69 6e 67 7b 73 79        []string{sy
3b50	6d 62 6f 6c 7d 2c 0a 09  09 09 53 74 72 61 74 65   mbol},....Strate
3b60	67 79 3a 20 20 20 20 63  6f 6e 66 69 67 2e 53 74   gy:    config.St
3b70	72 61 74 65 67 79 2c 0a  09 09 09 49 6e 69 74 69   rategy,....Initi
3b80	61 6c 43 61 73 68 3a 20  63 6f 6e 66 69 67 2e 49   alCash: config.I
3b90	6e 69 74 69 61 6c 43 61  73 68 2c 0a 09 09 7d 29   nitialCash,...})
3ba0	0a 09 09 69 66 20 65 72  72 20 21 3d 20 6e 69 6c   ...if err != nil
3bb0	20 7b 0a 09 09 09 6c 6f  67 2e 50 72 69 6e 74 66    {....log.Printf
3bc0	28 22 5b 4d 55 4c 54 49  5f 53 59 4d 42 4f 4c 5f   ("[MULTI_SYMBOL_
3bd0	44 45 45 50 5f 4c 45 41  52 4e 49 4e 47 5d 20 25   DEEP_LEARNING] %
3be0	73 e7 89 b9 e5 be 81 e9  a2 84 e8 ae a1 e7 ae 97   s...............
3bf0	e5 a4 b1 e8 b4 a5 3a 20  25 76 22 2c 20 73 79 6d   ......: %v", sym
3c00	62 6f 6c 2c 20 65 72 72  29 0a 09 09 7d 20 65 6c   bol, err)...} el
3c10	73 65 20 7b 0a 09 09 09  6c 6f 67 2e 50 72 69 6e   se {....log.Prin
3c20	74 66 28 22 5b 4d 55 4c  54 49 5f 53 59 4d 42 4f   tf("[MULTI_SYMBO
3c30	4c 5f 44 45 45 50 5f 4c  45 41 52 4e 49 4e 47 5d   L_DEEP_LEARNING]
3c40	20 25 73 e7 89 b9 e5 be  81 e9 a2 84 e8 ae a1 e7    %s.............
3c50	ae 97 e5 ae 8c e6 88 90  22 2c 20 73 79 6d 62 6f   ........", symbo
3c60	6c 29 0a 09 09 7d 0a 09  7d 0a 0a 09 2f 2f 20 e5   l)...}..}...// .
3c70	88 9d e5 a7 8b e5 8c 96  e5 bc ba e5 8c 96 e5 ad   ................
3c80	a6 e4 b9 a0 e4 bb a3 e7  90 86 ef bc 88 e5 85 b1   ................
3c90	e4 ba ab ef bc 89 0a 09  61 67 65 6e 74 20 3a 3d   ........agent :=
3ca0	20 62 65 2e 69 6e 69 74  69 61 6c 69 7a 65 52 4c    be.initializeRL
3cb0	41 67 65 6e 74 28 63 6f  6e 66 69 67 29 0a 0a 09   Agent(config)...
3cc0	2f 2f 20 e5 9c a8 e5 bc  80 e5 a7 8b e5 9b 9e e6   // .............
3cd0	b5 8b e5 89 8d e8 ae ad  e7 bb 83 e6 9c ba e5 99   ................
3ce0	a8 e5 ad a6 e4 b9 a0 e6  a8 a1 e5 9e 8b ef bc 88   ................
3cf0	e5 af b9 e4 b8 bb e8 a6  81 e5 b8 81 e7 a7 8d ef   ................
3d00	bc 89 0a 09 6d 61 69 6e  53 79 6d 62 6f 6c 20 3a   ....mainSymbol :
3d10	3d 20 22 22 0a 09 66 6f  72 20 73 79 6d 62 6f 6c   = ""..for symbol
3d20	20 3a 3d 20 72 61 6e 67  65 20 73 79 6d 62 6f 6c    := range symbol
3d30	44 61 74 61 20 7b 0a 09  09 6d 61 69 6e 53 79 6d   Data {...mainSym
3d40	62 6f 6c 20 3d 20 73 79  6d 62 6f 6c 0a 09 09 62   bol = symbol...b
3d50	72 65 61 6b 0a 09 7d 0a  0a 09 69 66 20 6c 65 6e   reak..}...if len
3d60	28 73 79 6d 62 6f 6c 44  61 74 61 5b 6d 61 69 6e   (symbolData[main
3d70	53 79 6d 62 6f 6c 5d 29  20 3e 3d 20 31 30 30 20   Symbol]) >= 100 
3d80	7b 0a 09 09 65 72 72 20  3a 3d 20 62 65 2e 74 72   {...err := be.tr
3d90	61 69 6e 4d 4c 4d 6f 64  65 6c 46 6f 72 53 79 6d   ainMLModelForSym
3da0	62 6f 6c 28 63 74 78 2c  20 6d 61 69 6e 53 79 6d   bol(ctx, mainSym
3db0	62 6f 6c 2c 20 73 79 6d  62 6f 6c 44 61 74 61 5b   bol, symbolData[
3dc0	6d 61 69 6e 53 79 6d 62  6f 6c 5d 29 0a 09 09 69   mainSymbol])...i
3dd0	66 20 65 72 72 20 21 3d  20 6e 69 6c 20 7b 0a 09   f err != nil {..
3de0	09 09 6c 6f 67 2e 50 72  69 6e 74 66 28 22 5b 4d   ..log.Printf("[M
3df0	55 4c 54 49 5f 53 59 4d  42 4f 4c 5f 44 45 45 50   ULTI_SYMBOL_DEEP
3e00	5f 4c 45 41 52 4e 49 4e  47 5d 20 4d 4c e8 ae ad   _LEARNING] ML...
3e10	e7 bb 83 e5 a4 b1 e8 b4  a5 ef bc 8c e5 b0 86 e4   ................
3e20	bd bf e7 94 a8 e8 a7 84  e5 88 99 e5 86 b3 e7 ad   ................
3e30	96 3a 20 25 76 22 2c 20  65 72 72 29 0a 09 09 7d   .: %v", err)...}
3e40	20 65 6c 73 65 20 7b 0a  09 09 09 6c 6f 67 2e 50    else {....log.P
3e50	72 69 6e 74 66 28 22 5b  4d 55 4c 54 49 5f 53 59   rintf("[MULTI_SY
3e60	4d 42 4f 4c 5f 44 45 45  50 5f 4c 45 41 52 4e 49   MBOL_DEEP_LEARNI
3e70	4e 47 5d 20 4d 4c e8 ae  ad e7 bb 83 e5 ae 8c e6   NG] ML..........
3e80	88 90 22 29 0a 09 09 7d  0a 09 7d 0a 0a 09 2f 2f   ..")...}..}...//
3e90	20 e5 88 9d e5 a7 8b e5  8c 96 e6 af 8f e6 97 a5    ...............
3ea0	e6 94 b6 e7 9b 8a e8 ae  b0 e5 bd 95 0a 09 69 66   ..............if
3eb0	20 6d 69 6e 44 61 74 61  4c 65 6e 67 74 68 20 3e    minDataLength >
3ec0	20 30 20 7b 0a 09 09 72  65 73 75 6c 74 2e 44 61    0 {...result.Da
3ed0	69 6c 79 52 65 74 75 72  6e 73 20 3d 20 61 70 70   ilyReturns = app
3ee0	65 6e 64 28 72 65 73 75  6c 74 2e 44 61 69 6c 79   end(result.Daily
3ef0	52 65 74 75 72 6e 73 2c  20 44 61 69 6c 79 52 65   Returns, DailyRe
3f00	74 75 72 6e 7b 0a 09 09  09 44 61 74 65 3a 20 20   turn{....Date:  
3f10	20 73 79 6d 62 6f 6c 44  61 74 61 5b 6d 61 69 6e    symbolData[main
3f20	53 79 6d 62 6f 6c 5d 5b  30 5d 2e 4c 61 73 74 55   Symbol][0].LastU
3f30	70 64 61 74 65 64 2c 0a  09 09 09 56 61 6c 75 65   pdated,....Value
3f40	3a 20 20 74 6f 74 61 6c  43 61 73 68 2c 0a 09 09   :  totalCash,...
3f50	09 52 65 74 75 72 6e 3a  20 30 2c 0a 09 09 7d 29   .Return: 0,...})
3f60	0a 09 7d 0a 0a 09 2f 2f  20 e4 b8 bb e5 9b 9e e6   ..}...// .......
3f70	b5 8b e5 be aa e7 8e af  0a 09 66 6f 72 20 69 20   ..........for i 
3f80	3a 3d 20 35 30 3b 20 69  20 3c 20 6d 69 6e 44 61   := 50; i < minDa
3f90	74 61 4c 65 6e 67 74 68  3b 20 69 2b 2b 20 7b 0a   taLength; i++ {.
3fa0	09 09 69 66 20 69 20 3d  3d 20 35 30 20 7b 0a 09   ..if i == 50 {..
3fb0	09 09 6c 6f 67 2e 50 72  69 6e 74 66 28 22 5b 4d   ..log.Printf("[M
3fc0	55 4c 54 49 5f 53 59 4d  42 4f 4c 5f 44 45 45 50   ULTI_SYMBOL_DEEP
3fd0	5f 4c 45 41 52 4e 49 4e  47 5d 20 e9 a2 84 e7 83   _LEARNING] .....
3fe0	ad e5 ae 8c e6 88 90 ef  bc 8c e5 bc 80 e5 a7 8b   ................
3ff0	e6 ad a3 e5 bc 8f e4 ba  a4 e6 98 93 22 29 0a 09   ............")..
4000	09 7d 0a 0a 09 09 63 75  72 72 65 6e 74 44 61 74   .}....currentDat
4010	65 20 3a 3d 20 73 79 6d  62 6f 6c 44 61 74 61 5b   e := symbolData[
4020	6d 61 69 6e 53 79 6d 62  6f 6c 5d 5b 69 5d 2e 4c   mainSymbol][i].L
4030	61 73 74 55 70 64 61 74  65 64 0a 0a 09 09 2f 2f   astUpdated....//
4040	20 31 2e 20 e8 af 84 e4  bc b0 e6 89 80 e6 9c 89    1. ............
4050	e5 b8 81 e7 a7 8d e7 9a  84 e4 ba a4 e6 98 93 e6   ................
4060	9c ba e4 bc 9a 0a 09 09  62 65 73 74 4f 70 70 6f   ........bestOppo
4070	72 74 75 6e 69 74 79 20  3a 3d 20 62 65 2e 65 76   rtunity := be.ev
4080	61 6c 75 61 74 65 4d 75  6c 74 69 53 79 6d 62 6f   aluateMultiSymbo
4090	6c 4f 70 70 6f 72 74 75  6e 69 74 69 65 73 28 63   lOpportunities(c
40a0	74 78 2c 20 73 79 6d 62  6f 6c 53 74 61 74 65 73   tx, symbolStates
40b0	2c 20 61 67 65 6e 74 2c  20 69 2c 20 63 6f 6e 66   , agent, i, conf
40c0	69 67 29 0a 0a 09 09 2f  2f 20 32 2e 20 e6 89 a7   ig)....// 2. ...
40d0	e8 a1 8c e6 9c 80 e4 bd  b3 e4 ba a4 e6 98 93 e6   ................
40e0	9c ba e4 bc 9a 0a 09 09  69 66 20 62 65 73 74 4f   ........if bestO
40f0	70 70 6f 72 74 75 6e 69  74 79 20 21 3d 20 6e 69   pportunity != ni
4100	6c 20 26 26 20 61 76 61  69 6c 61 62 6c 65 43 61   l && availableCa
4110	73 68 20 3e 20 30 20 7b  0a 09 09 09 65 72 72 20   sh > 0 {....err 
4120	3a 3d 20 62 65 2e 65 78  65 63 75 74 65 4d 75 6c   := be.executeMul
4130	74 69 53 79 6d 62 6f 6c  54 72 61 64 65 28 62 65   tiSymbolTrade(be
4140	73 74 4f 70 70 6f 72 74  75 6e 69 74 79 2c 20 73   stOpportunity, s
4150	79 6d 62 6f 6c 53 74 61  74 65 73 2c 20 26 61 76   ymbolStates, &av
4160	61 69 6c 61 62 6c 65 43  61 73 68 2c 20 26 74 6f   ailableCash, &to
4170	74 61 6c 43 61 73 68 2c  20 72 65 73 75 6c 74 2c   talCash, result,
4180	20 63 75 72 72 65 6e 74  44 61 74 65 2c 20 63 6f    currentDate, co
4190	6e 66 69 67 29 0a 09 09  09 69 66 20 65 72 72 20   nfig)....if err 
41a0	21 3d 20 6e 69 6c 20 7b  0a 09 09 09 09 6c 6f 67   != nil {.....log
41b0	2e 50 72 69 6e 74 66 28  22 5b 4d 55 4c 54 49 5f   .Printf("[MULTI_
41c0	53 59 4d 42 4f 4c 5f 44  45 45 50 5f 4c 45 41 52   SYMBOL_DEEP_LEAR
41d0	4e 49 4e 47 5d 20 e6 89  a7 e8 a1 8c e4 ba a4 e6   NING] ..........
41e0	98 93 e5 a4 b1 e8 b4 a5  3a 20 25 76 22 2c 20 65   ........: %v", e
41f0	72 72 29 0a 09 09 09 7d  0a 09 09 7d 0a 0a 09 09   rr)....}...}....
4200	2f 2f 20 33 2e 20 e6 a3  80 e6 9f a5 e6 98 af e5   // 3. ..........
4210	90 a6 e9 9c 80 e8 a6 81  e5 b9 b3 e4 bb 93 0a 09   ................
4220	09 62 65 2e 63 68 65 63  6b 4d 75 6c 74 69 53 79   .be.checkMultiSy
4230	6d 62 6f 6c 45 78 69 74  73 28 73 79 6d 62 6f 6c   mbolExits(symbol
4240	53 74 61 74 65 73 2c 20  26 61 76 61 69 6c 61 62   States, &availab
4250	6c 65 43 61 73 68 2c 20  26 74 6f 74 61 6c 43 61   leCash, &totalCa
4260	73 68 2c 20 72 65 73 75  6c 74 2c 20 63 75 72 72   sh, result, curr
4270	65 6e 74 44 61 74 65 2c  20 63 6f 6e 66 69 67 29   entDate, config)
4280	0a 0a 09 09 2f 2f 20 34  2e 20 e6 9b b4 e6 96 b0   ....// 4. ......
4290	e6 af 8f e6 97 a5 e6 94  b6 e7 9b 8a 0a 09 09 70   ...............p
42a0	6f 72 74 66 6f 6c 69 6f  56 61 6c 75 65 20 3a 3d   ortfolioValue :=
42b0	20 61 76 61 69 6c 61 62  6c 65 43 61 73 68 0a 09    availableCash..
42c0	09 66 6f 72 20 5f 2c 20  73 74 61 74 65 20 3a 3d   .for _, state :=
42d0	20 72 61 6e 67 65 20 73  79 6d 62 6f 6c 53 74 61    range symbolSta
42e0	74 65 73 20 7b 0a 09 09  09 69 66 20 73 74 61 74   tes {....if stat
42f0	65 2e 50 6f 73 69 74 69  6f 6e 20 3e 20 30 20 26   e.Position > 0 &
4300	26 20 69 20 3c 20 6c 65  6e 28 73 74 61 74 65 2e   & i < len(state.
4310	44 61 74 61 29 20 7b 0a  09 09 09 09 70 6f 72 74   Data) {.....port
4320	66 6f 6c 69 6f 56 61 6c  75 65 20 2b 3d 20 73 74   folioValue += st
4330	61 74 65 2e 50 6f 73 69  74 69 6f 6e 20 2a 20 73   ate.Position * s
4340	74 61 74 65 2e 44 61 74  61 5b 69 5d 2e 50 72 69   tate.Data[i].Pri
4350	63 65 0a 09 09 09 7d 0a  09 09 7d 0a 0a 09 09 72   ce....}...}....r
4360	65 73 75 6c 74 2e 50 6f  72 74 66 6f 6c 69 6f 56   esult.PortfolioV
4370	61 6c 75 65 73 20 3d 20  61 70 70 65 6e 64 28 72   alues = append(r
4380	65 73 75 6c 74 2e 50 6f  72 74 66 6f 6c 69 6f 56   esult.PortfolioV
4390	61 6c 75 65 73 2c 20 70  6f 72 74 66 6f 6c 69 6f   alues, portfolio
43a0	56 61 6c 75 65 29 0a 09  09 72 65 73 75 6c 74 2e   Value)...result.
43b0	44 61 69 6c 79 52 65 74  75 72 6e 73 20 3d 20 61   DailyReturns = a
43c0	70 70 65 6e 64 28 72 65  73 75 6c 74 2e 44 61 69   ppend(result.Dai
43d0	6c 79 52 65 74 75 72 6e  73 2c 20 44 61 69 6c 79   lyReturns, Daily
43e0	52 65 74 75 72 6e 7b 0a  09 09 09 44 61 74 65 3a   Return{....Date:
43f0	20 20 20 63 75 72 72 65  6e 74 44 61 74 65 2c 0a      currentDate,.
4400	09 09 09 56 61 6c 75 65  3a 20 20 70 6f 72 74 66   ...Value:  portf
4410	6f 6c 69 6f 56 61 6c 75  65 2c 0a 09 09 09 52 65   olioValue,....Re
4420	74 75 72 6e 3a 20 28 70  6f 72 74 66 6f 6c 69 6f   turn: (portfolio
4430	56 61 6c 75 65 20 2d 20  72 65 73 75 6c 74 2e 44   Value - result.D
4440	61 69 6c 79 52 65 74 75  72 6e 73 5b 6c 65 6e 28   ailyReturns[len(
4450	72 65 73 75 6c 74 2e 44  61 69 6c 79 52 65 74 75   result.DailyRetu
4460	72 6e 73 29 2d 31 5d 2e  56 61 6c 75 65 29 20 2f   rns)-1].Value) /
4470	20 72 65 73 75 6c 74 2e  44 61 69 6c 79 52 65 74    result.DailyRet
4480	75 72 6e 73 5b 6c 65 6e  28 72 65 73 75 6c 74 2e   urns[len(result.
4490	44 61 69 6c 79 52 65 74  75 72 6e 73 29 2d 31 5d   DailyReturns)-1]
44a0	2e 56 61 6c 75 65 2c 0a  09 09 7d 29 0a 0a 09 09   .Value,...})....
44b0	2f 2f 20 35 2e 20 e6 9b  b4 e6 96 b0 e6 8c 81 e4   // 5. ..........
44c0	bb 93 e6 97 b6 e9 97 b4  0a 09 09 66 6f 72 20 5f   ...........for _
44d0	2c 20 73 74 61 74 65 20  3a 3d 20 72 61 6e 67 65   , state := range
44e0	20 73 79 6d 62 6f 6c 53  74 61 74 65 73 20 7b 0a    symbolStates {.
44f0	09 09 09 69 66 20 73 74  61 74 65 2e 50 6f 73 69   ...if state.Posi
4500	74 69 6f 6e 20 3e 20 30  20 7b 0a 09 09 09 09 73   tion > 0 {.....s
4510	74 61 74 65 2e 48 6f 6c  64 54 69 6d 65 2b 2b 0a   tate.HoldTime++.
4520	09 09 09 7d 0a 09 09 7d  0a 09 7d 0a 0a 09 2f 2f   ...}...}..}...//
4530	20 e8 ae a1 e7 ae 97 e6  af 8f e4 b8 aa e5 b8 81    ...............
4540	e7 a7 8d e7 9a 84 e7 bb  9f e8 ae a1 e4 bf a1 e6   ................
4550	81 af 0a 09 62 65 2e 63  61 6c 63 75 6c 61 74 65   ....be.calculate
4560	4d 75 6c 74 69 53 79 6d  62 6f 6c 53 74 61 74 73   MultiSymbolStats
4570	28 72 65 73 75 6c 74 2c  20 73 79 6d 62 6f 6c 53   (result, symbolS
4580	74 61 74 65 73 29 0a 0a  09 6c 6f 67 2e 50 72 69   tates)...log.Pri
4590	6e 74 66 28 22 5b 4d 55  4c 54 49 5f 53 59 4d 42   ntf("[MULTI_SYMB
45a0	4f 4c 5f 44 45 45 50 5f  4c 45 41 52 4e 49 4e 47   OL_DEEP_LEARNING
45b0	5d 20 e5 a4 9a e5 b8 81  e7 a7 8d e6 b7 b1 e5 ba   ] ..............
45c0	a6 e5 ad a6 e4 b9 a0 e7  ad 96 e7 95 a5 e6 89 a7   ................
45d0	e8 a1 8c e5 ae 8c e6 88  90 22 29 0a 09 72 65 74   .........")..ret
45e0	75 72 6e 20 6e 69 6c 0a  7d 0a 0a 2f 2f 20 72 75   urn nil.}..// ru
45f0	6e 4d 75 6c 74 69 53 79  6d 62 6f 6c 42 75 79 41   nMultiSymbolBuyA
4600	6e 64 48 6f 6c 64 53 74  72 61 74 65 67 79 20 e5   ndHoldStrategy .
4610	a4 9a e5 b8 81 e7 a7 8d  e4 b9 b0 e5 85 a5 e6 8c   ................
4620	81 e6 9c 89 e7 ad 96 e7  95 a5 0a 66 75 6e 63 20   ...........func 
4630	28 62 65 20 2a 42 61 63  6b 74 65 73 74 45 6e 67   (be *BacktestEng
4640	69 6e 65 29 20 72 75 6e  4d 75 6c 74 69 53 79 6d   ine) runMultiSym
4650	62 6f 6c 42 75 79 41 6e  64 48 6f 6c 64 53 74 72   bolBuyAndHoldStr
4660	61 74 65 67 79 28 72 65  73 75 6c 74 20 2a 42 61   ategy(result *Ba
4670	63 6b 74 65 73 74 52 65  73 75 6c 74 2c 20 73 79   cktestResult, sy
4680	6d 62 6f 6c 44 61 74 61  20 6d 61 70 5b 73 74 72   mbolData map[str
4690	69 6e 67 5d 5b 5d 4d 61  72 6b 65 74 44 61 74 61   ing][]MarketData
46a0	29 20 65 72 72 6f 72 20  7b 0a 09 6c 6f 67 2e 50   ) error {..log.P
46b0	72 69 6e 74 66 28 22 5b  4d 55 4c 54 49 5f 53 59   rintf("[MULTI_SY
46c0	4d 42 4f 4c 5f 42 55 59  5f 48 4f 4c 44 5d 20 e5   MBOL_BUY_HOLD] .
46d0	a4 9a e5 b8 81 e7 a7 8d  e4 b9 b0 e5 85 a5 e6 8c   ................
46e0	81 e6 9c 89 e7 ad 96 e7  95 a5 e6 9a 82 e4 b8 8d   ................
46f0	e6 94 af e6 8c 81 ef bc  8c e8 af b7 e4 bd bf e7   ................
4700	94 a8 e5 8d 95 e5 b8 81  e7 a7 8d e6 a8 a1 e5 bc   ................
4710	8f 22 29 0a 09 72 65 74  75 72 6e 20 66 6d 74 2e   .")..return fmt.
4720	45 72 72 6f 72 66 28 22  e5 a4 9a e5 b8 81 e7 a7   Errorf("........
4730	8d e4 b9 b0 e5 85 a5 e6  8c 81 e6 9c 89 e7 ad 96   ................
4740	e7 95 a5 e6 9a 82 e6 9c  aa e5 ae 9e e7 8e b0 ef   ................
4750	bc 8c e8 af b7 e4 bd bf  e7 94 a8 e5 8d 95 e5 b8   ................
4760	81 e7 a7 8d e6 a8 a1 e5  bc 8f 22 29 0a 7d 0a 0a   ..........").}..
4770	2f 2f 20 72 75 6e 4d 75  6c 74 69 53 79 6d 62 6f   // runMultiSymbo
4780	6c 4d 4c 50 72 65 64 69  63 74 69 6f 6e 53 74 72   lMLPredictionStr
4790	61 74 65 67 79 20 e5 a4  9a e5 b8 81 e7 a7 8d 4d   ategy .........M
47a0	4c e9 a2 84 e6 b5 8b e7  ad 96 e7 95 a5 0a 66 75   L.............fu
47b0	6e 63 20 28 62 65 20 2a  42 61 63 6b 74 65 73 74   nc (be *Backtest
47c0	45 6e 67 69 6e 65 29 20  72 75 6e 4d 75 6c 74 69   Engine) runMulti
47d0	53 79 6d 62 6f 6c 4d 4c  50 72 65 64 69 63 74 69   SymbolMLPredicti
47e0	6f 6e 53 74 72 61 74 65  67 79 28 63 74 78 20 63   onStrategy(ctx c
47f0	6f 6e 74 65 78 74 2e 43  6f 6e 74 65 78 74 2c 20   ontext.Context, 
4800	72 65 73 75 6c 74 20 2a  42 61 63 6b 74 65 73 74   result *Backtest
4810	52 65 73 75 6c 74 2c 20  73 79 6d 62 6f 6c 44 61   Result, symbolDa
4820	74 61 20 6d 61 70 5b 73  74 72 69 6e 67 5d 5b 5d   ta map[string][]
4830	4d 61 72 6b 65 74 44 61  74 61 29 20 65 72 72 6f   MarketData) erro
4840	72 20 7b 0a 09 6c 6f 67  2e 50 72 69 6e 74 66 28   r {..log.Printf(
4850	22 5b 4d 55 4c 54 49 5f  53 59 4d 42 4f 4c 5f 4d   "[MULTI_SYMBOL_M
4860	4c 5d 20 e5 a4 9a e5 b8  81 e7 a7 8d 4d 4c e9 a2   L] .........ML..
4870	84 e6 b5 8b e7 ad 96 e7  95 a5 e6 9a 82 e4 b8 8d   ................
4880	e6 94 af e6 8c 81 ef bc  8c e8 af b7 e4 bd bf e7   ................
4890	94 a8 e5 8d 95 e5 b8 81  e7 a7 8d e6 a8 a1 e5 bc   ................
48a0	8f 22 29 0a 09 72 65 74  75 72 6e 20 66 6d 74 2e   .")..return fmt.
48b0	45 72 72 6f 72 66 28 22  e5 a4 9a e5 b8 81 e7 a7   Errorf("........
48c0	8d 4d 4c e9 a2 84 e6 b5  8b e7 ad 96 e7 95 a5 e6   .ML.............
48d0	9a 82 e6 9c aa e5 ae 9e  e7 8e b0 ef bc 8c e8 af   ................
48e0	b7 e4 bd bf e7 94 a8 e5  8d 95 e5 b8 81 e7 a7 8d   ................
48f0	e6 a8 a1 e5 bc 8f 22 29  0a 7d 0a 0a 2f 2f 20 72   ......").}..// r
4900	75 6e 4d 75 6c 74 69 53  79 6d 62 6f 6c 45 6e 73   unMultiSymbolEns
4910	65 6d 62 6c 65 53 74 72  61 74 65 67 79 20 e5 a4   embleStrategy ..
4920	9a e5 b8 81 e7 a7 8d e9  9b 86 e6 88 90 e7 ad 96   ................
4930	e7 95 a5 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
4940	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 72 75   cktestEngine) ru
4950	6e 4d 75 6c 74 69 53 79  6d 62 6f 6c 45 6e 73 65   nMultiSymbolEnse
4960	6d 62 6c 65 53 74 72 61  74 65 67 79 28 63 74 78   mbleStrategy(ctx
4970	20 63 6f 6e 74 65 78 74  2e 43 6f 6e 74 65 78 74    context.Context
4980	2c 20 72 65 73 75 6c 74  20 2a 42 61 63 6b 74 65   , result *Backte
4990	73 74 52 65 73 75 6c 74  2c 20 73 79 6d 62 6f 6c   stResult, symbol
49a0	44 61 74 61 20 6d 61 70  5b 73 74 72 69 6e 67 5d   Data map[string]
49b0	5b 5d 4d 61 72 6b 65 74  44 61 74 61 29 20 65 72   []MarketData) er
49c0	72 6f 72 20 7b 0a 09 6c  6f 67 2e 50 72 69 6e 74   ror {..log.Print
49d0	66 28 22 5b 4d 55 4c 54  49 5f 53 59 4d 42 4f 4c   f("[MULTI_SYMBOL
49e0	5f 45 4e 53 45 4d 42 4c  45 5d 20 e5 a4 9a e5 b8   _ENSEMBLE] .....
49f0	81 e7 a7 8d e9 9b 86 e6  88 90 e7 ad 96 e7 95 a5   ................
4a00	e6 9a 82 e4 b8 8d e6 94  af e6 8c 81 ef bc 8c e8   ................
4a10	af b7 e4 bd bf e7 94 a8  e5 8d 95 e5 b8 81 e7 a7   ................
4a20	8d e6 a8 a1 e5 bc 8f 22  29 0a 09 72 65 74 75 72   .......")..retur
4a30	6e 20 66 6d 74 2e 45 72  72 6f 72 66 28 22 e5 a4   n fmt.Errorf("..
4a40	9a e5 b8 81 e7 a7 8d e9  9b 86 e6 88 90 e7 ad 96   ................
4a50	e7 95 a5 e6 9a 82 e6 9c  aa e5 ae 9e e7 8e b0 ef   ................
4a60	bc 8c e8 af b7 e4 bd bf  e7 94 a8 e5 8d 95 e5 b8   ................
4a70	81 e7 a7 8d e6 a8 a1 e5  bc 8f 22 29 0a 7d 0a 0a   ..........").}..
4a80	2f 2f 20 65 76 61 6c 75  61 74 65 4d 75 6c 74 69   // evaluateMulti
4a90	53 79 6d 62 6f 6c 4f 70  70 6f 72 74 75 6e 69 74   SymbolOpportunit
4aa0	69 65 73 20 e8 af 84 e4  bc b0 e5 a4 9a e5 b8 81   ies ............
4ab0	e7 a7 8d e4 ba a4 e6 98  93 e6 9c ba e4 bc 9a ef   ................
4ac0	bc 88 e5 a2 9e e5 bc ba  e7 89 88 ef bc 89 0a 66   ...............f
4ad0	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
4ae0	74 45 6e 67 69 6e 65 29  20 65 76 61 6c 75 61 74   tEngine) evaluat
4af0	65 4d 75 6c 74 69 53 79  6d 62 6f 6c 4f 70 70 6f   eMultiSymbolOppo
4b00	72 74 75 6e 69 74 69 65  73 28 63 74 78 20 63 6f   rtunities(ctx co
4b10	6e 74 65 78 74 2e 43 6f  6e 74 65 78 74 2c 20 73   ntext.Context, s
4b20	79 6d 62 6f 6c 53 74 61  74 65 73 20 6d 61 70 5b   ymbolStates map[
4b30	73 74 72 69 6e 67 5d 2a  53 79 6d 62 6f 6c 53 74   string]*SymbolSt
4b40	61 74 65 2c 20 61 67 65  6e 74 20 6d 61 70 5b 73   ate, agent map[s
4b50	74 72 69 6e 67 5d 69 6e  74 65 72 66 61 63 65 7b   tring]interface{
4b60	7d 2c 20 63 75 72 72 65  6e 74 49 6e 64 65 78 20   }, currentIndex 
4b70	69 6e 74 2c 20 63 6f 6e  66 69 67 20 2a 42 61 63   int, config *Bac
4b80	6b 74 65 73 74 43 6f 6e  66 69 67 29 20 2a 54 72   ktestConfig) *Tr
4b90	61 64 65 4f 70 70 6f 72  74 75 6e 69 74 79 20 7b   adeOpportunity {
4ba0	0a 09 2f 2f 20 31 2e 20  e6 94 b6 e9 9b 86 e6 89   ..// 1. ........
4bb0	80 e6 9c 89 e5 b8 81 e7  a7 8d e7 9a 84 e6 9c ba   ................
4bc0	e4 bc 9a e4 bf a1 e6 81  af 0a 09 73 79 6d 62 6f   ...........symbo
4bd0	6c 4f 70 70 6f 72 74 75  6e 69 74 69 65 73 20 3a   lOpportunities :
4be0	3d 20 62 65 2e 63 6f 6c  6c 65 63 74 53 79 6d 62   = be.collectSymb
4bf0	6f 6c 4f 70 70 6f 72 74  75 6e 69 74 69 65 73 28   olOpportunities(
4c00	63 74 78 2c 20 73 79 6d  62 6f 6c 53 74 61 74 65   ctx, symbolState
4c10	73 2c 20 61 67 65 6e 74  2c 20 63 75 72 72 65 6e   s, agent, curren
4c20	74 49 6e 64 65 78 2c 20  63 6f 6e 66 69 67 29 0a   tIndex, config).
4c30	0a 09 2f 2f 20 32 2e 20  e8 bf 9b e8 a1 8c e5 a4   ..// 2. ........
4c40	9a e5 b8 81 e7 a7 8d e5  b8 82 e5 9c ba e5 88 86   ................
4c50	e6 9e 90 0a 09 6d 61 72  6b 65 74 41 6e 61 6c 79   .....marketAnaly
4c60	73 69 73 20 3a 3d 20 62  65 2e 61 6e 61 6c 79 7a   sis := be.analyz
4c70	65 4d 75 6c 74 69 53 79  6d 62 6f 6c 4d 61 72 6b   eMultiSymbolMark
4c80	65 74 28 73 79 6d 62 6f  6c 4f 70 70 6f 72 74 75   et(symbolOpportu
4c90	6e 69 74 69 65 73 2c 20  73 79 6d 62 6f 6c 53 74   nities, symbolSt
4ca0	61 74 65 73 2c 20 63 75  72 72 65 6e 74 49 6e 64   ates, currentInd
4cb0	65 78 29 0a 0a 09 2f 2f  20 33 2e 20 e8 ae a1 e7   ex)...// 3. ....
4cc0	ae 97 e9 a3 8e e9 99 a9  e8 b0 83 e6 95 b4 e5 90   ................
4cd0	8e e7 9a 84 e6 9c ba e4  bc 9a e8 af 84 e5 88 86   ................
4ce0	0a 09 72 69 73 6b 41 64  6a 75 73 74 65 64 4f 70   ..riskAdjustedOp
4cf0	70 6f 72 74 75 6e 69 74  69 65 73 20 3a 3d 20 62   portunities := b
4d00	65 2e 63 61 6c 63 75 6c  61 74 65 52 69 73 6b 41   e.calculateRiskA
4d10	64 6a 75 73 74 65 64 53  63 6f 72 65 73 28 73 79   djustedScores(sy
4d20	6d 62 6f 6c 4f 70 70 6f  72 74 75 6e 69 74 69 65   mbolOpportunitie
4d30	73 2c 20 6d 61 72 6b 65  74 41 6e 61 6c 79 73 69   s, marketAnalysi
4d40	73 2c 20 73 79 6d 62 6f  6c 53 74 61 74 65 73 29   s, symbolStates)
4d50	0a 0a 09 2f 2f 20 34 2e  20 e6 a3 80 e6 b5 8b e5   ...// 4. .......
4d60	a5 97 e5 88 a9 e6 9c ba  e4 bc 9a 0a 09 61 72 62   .............arb
4d70	69 74 72 61 67 65 4f 70  70 6f 72 74 75 6e 69 74   itrageOpportunit
4d80	69 65 73 20 3a 3d 20 62  65 2e 64 65 74 65 63 74   ies := be.detect
4d90	41 72 62 69 74 72 61 67  65 4f 70 70 6f 72 74 75   ArbitrageOpportu
4da0	6e 69 74 69 65 73 28 73  79 6d 62 6f 6c 53 74 61   nities(symbolSta
4db0	74 65 73 2c 20 6d 61 72  6b 65 74 41 6e 61 6c 79   tes, marketAnaly
4dc0	73 69 73 2e 43 6f 72 72  65 6c 61 74 69 6f 6e 4d   sis.CorrelationM
4dd0	61 74 72 69 78 2c 20 63  75 72 72 65 6e 74 49 6e   atrix, currentIn
4de0	64 65 78 29 0a 0a 09 2f  2f 20 35 2e 20 e5 b0 86   dex)...// 5. ...
4df0	e5 a5 97 e5 88 a9 e6 9c  ba e4 bc 9a e8 bd ac e6   ................
4e00	8d a2 e4 b8 ba e4 ba a4  e6 98 93 e6 9c ba e4 bc   ................
4e10	9a 0a 09 74 72 61 64 65  4f 70 70 6f 72 74 75 6e   ...tradeOpportun
4e20	69 74 69 65 73 20 3a 3d  20 62 65 2e 63 6f 6e 76   ities := be.conv
4e30	65 72 74 41 72 62 69 74  72 61 67 65 54 6f 54 72   ertArbitrageToTr
4e40	61 64 65 4f 70 70 6f 72  74 75 6e 69 74 69 65 73   adeOpportunities
4e50	28 61 72 62 69 74 72 61  67 65 4f 70 70 6f 72 74   (arbitrageOpport
4e60	75 6e 69 74 69 65 73 2c  20 73 79 6d 62 6f 6c 53   unities, symbolS
4e70	74 61 74 65 73 2c 20 63  75 72 72 65 6e 74 49 6e   tates, currentIn
4e80	64 65 78 29 0a 0a 09 2f  2f 20 36 2e 20 e5 90 88   dex)...// 6. ...
4e90	e5 b9 b6 e6 89 80 e6 9c  89 e6 9c ba e4 bc 9a e5   ................
4ea0	b9 b6 e9 80 89 e6 8b a9  e6 9c 80 e4 bd b3 0a 09   ................
4eb0	61 6c 6c 4f 70 70 6f 72  74 75 6e 69 74 69 65 73   allOpportunities
4ec0	20 3a 3d 20 61 70 70 65  6e 64 28 72 69 73 6b 41    := append(riskA
4ed0	64 6a 75 73 74 65 64 4f  70 70 6f 72 74 75 6e 69   djustedOpportuni
4ee0	74 69 65 73 2c 20 74 72  61 64 65 4f 70 70 6f 72   ties, tradeOppor
4ef0	74 75 6e 69 74 69 65 73  2e 2e 2e 29 0a 09 62 65   tunities...)..be
4f00	73 74 4f 70 70 6f 72 74  75 6e 69 74 79 20 3a 3d   stOpportunity :=
4f10	20 62 65 2e 73 65 6c 65  63 74 42 65 73 74 4f 76    be.selectBestOv
4f20	65 72 61 6c 6c 4f 70 70  6f 72 74 75 6e 69 74 79   erallOpportunity
4f30	28 61 6c 6c 4f 70 70 6f  72 74 75 6e 69 74 69 65   (allOpportunitie
4f40	73 2c 20 73 79 6d 62 6f  6c 53 74 61 74 65 73 2c   s, symbolStates,
4f50	20 63 6f 6e 66 69 67 29  0a 0a 09 69 66 20 62 65    config)...if be
4f60	73 74 4f 70 70 6f 72 74  75 6e 69 74 79 20 21 3d   stOpportunity !=
4f70	20 6e 69 6c 20 7b 0a 09  09 6c 6f 67 2e 50 72 69    nil {...log.Pri
4f80	6e 74 66 28 22 5b 4d 55  4c 54 49 5f 53 59 4d 42   ntf("[MULTI_SYMB
4f90	4f 4c 5f 4f 50 50 4f 52  54 55 4e 49 54 59 5d 20   OL_OPPORTUNITY] 
4fa0	e9 80 89 e4 b8 ad e6 9c  80 e4 bd b3 e6 9c ba e4   ................
4fb0	bc 9a 3a 20 25 73 20 25  73 2c 20 e5 88 86 e6 95   ..: %s %s, .....
4fc0	b0 3d 25 2e 33 66 2c 20  e7 bd ae e4 bf a1 e5 ba   .=%.3f, ........
4fd0	a6 3d 25 2e 33 66 2c 20  e7 b1 bb e5 9e 8b 3d 25   .=%.3f, ......=%
4fe0	73 22 2c 0a 09 09 09 62  65 73 74 4f 70 70 6f 72   s",....bestOppor
4ff0	74 75 6e 69 74 79 2e 53  79 6d 62 6f 6c 2c 20 62   tunity.Symbol, b
5000	65 73 74 4f 70 70 6f 72  74 75 6e 69 74 79 2e 41   estOpportunity.A
5010	63 74 69 6f 6e 2c 20 62  65 73 74 4f 70 70 6f 72   ction, bestOppor
5020	74 75 6e 69 74 79 2e 53  63 6f 72 65 2c 20 62 65   tunity.Score, be
5030	73 74 4f 70 70 6f 72 74  75 6e 69 74 79 2e 43 6f   stOpportunity.Co
5040	6e 66 69 64 65 6e 63 65  2c 20 62 65 73 74 4f 70   nfidence, bestOp
5050	70 6f 72 74 75 6e 69 74  79 2e 52 65 61 73 6f 6e   portunity.Reason
5060	29 0a 09 7d 0a 0a 09 72  65 74 75 72 6e 20 62 65   )..}...return be
5070	73 74 4f 70 70 6f 72 74  75 6e 69 74 79 0a 7d 0a   stOpportunity.}.
5080	0a 2f 2f 20 63 61 6c 63  75 6c 61 74 65 4f 70 70   .// calculateOpp
5090	6f 72 74 75 6e 69 74 79  53 63 6f 72 65 20 e8 ae   ortunityScore ..
50a0	a1 e7 ae 97 e4 ba a4 e6  98 93 e6 9c ba e4 bc 9a   ................
50b0	e8 af 84 e5 88 86 ef bc  88 e5 a2 9e e5 bc ba e7   ................
50c0	89 88 ef bc 89 0a 66 75  6e 63 20 28 62 65 20 2a   ......func (be *
50d0	42 61 63 6b 74 65 73 74  45 6e 67 69 6e 65 29 20   BacktestEngine) 
50e0	63 61 6c 63 75 6c 61 74  65 4f 70 70 6f 72 74 75   calculateOpportu
50f0	6e 69 74 79 53 63 6f 72  65 28 73 74 61 74 65 20   nityScore(state 
5100	6d 61 70 5b 73 74 72 69  6e 67 5d 66 6c 6f 61 74   map[string]float
5110	36 34 2c 20 73 79 6d 62  6f 6c 20 73 74 72 69 6e   64, symbol strin
5120	67 29 20 66 6c 6f 61 74  36 34 20 7b 0a 09 73 63   g) float64 {..sc
5130	6f 72 65 20 3a 3d 20 30  2e 30 0a 09 66 61 63 74   ore := 0.0..fact
5140	6f 72 73 20 3a 3d 20 6d  61 6b 65 28 6d 61 70 5b   ors := make(map[
5150	73 74 72 69 6e 67 5d 66  6c 6f 61 74 36 34 29 0a   string]float64).
5160	0a 09 2f 2f 20 31 2e 20  e8 b6 8b e5 8a bf e5 bc   ..// 1. ........
5170	ba e5 ba a6 e8 af 84 e5  88 86 ef bc 88 33 30 25   .............30%
5180	e6 9d 83 e9 87 8d ef bc  89 0a 09 74 72 65 6e 64   ...........trend
5190	53 63 6f 72 65 20 3a 3d  20 30 2e 30 0a 09 69 66   Score := 0.0..if
51a0	20 74 72 65 6e 64 53 6c  6f 70 65 2c 20 65 78 69    trendSlope, exi
51b0	73 74 73 20 3a 3d 20 73  74 61 74 65 5b 22 74 72   sts := state["tr
51c0	65 6e 64 5f 32 30 22 5d  3b 20 65 78 69 73 74 73   end_20"]; exists
51d0	20 7b 0a 09 09 2f 2f 20  e4 bc 98 e5 85 88 e4 bd    {...// ........
51e0	bf e7 94 a8 e4 bc a0 e7  bb 9f e8 b6 8b e5 8a bf   ................
51f0	e6 8c 87 e6 a0 87 ef bc  88 e5 ae 9e e6 97 b6 e8   ................
5200	ae a1 e7 ae 97 ef bc 89  0a 09 09 74 72 65 6e 64   ...........trend
5210	53 63 6f 72 65 20 3d 20  6d 61 74 68 2e 4d 61 78   Score = math.Max
5220	28 30 2e 30 2c 20 6d 61  74 68 2e 4d 69 6e 28 6d   (0.0, math.Min(m
5230	61 74 68 2e 41 62 73 28  74 72 65 6e 64 53 6c 6f   ath.Abs(trendSlo
5240	70 65 29 2a 35 2c 20 31  2e 30 29 29 20 2f 2f 20   pe)*5, 1.0)) // 
5250	e6 a0 87 e5 87 86 e5 8c  96 e8 b6 8b e5 8a bf e5   ................
5260	80 bc 0a 09 09 2f 2f 20  e5 87 8f e5 b0 91 e8 af   .....// ........
5270	a6 e7 bb 86 e7 9a 84 e8  b0 83 e8 af 95 e6 97 a5   ................
5280	e5 bf 97 0a 09 09 2f 2f  20 6c 6f 67 2e 50 72 69   ......// log.Pri
5290	6e 74 66 28 22 5b 4f 50  50 4f 52 54 55 4e 49 54   ntf("[OPPORTUNIT
52a0	59 5f 44 45 42 55 47 5d  20 e4 bd bf e7 94 a8 e4   Y_DEBUG] .......
52b0	bc a0 e7 bb 9f e8 b6 8b  e5 8a bf 3a 20 25 2e 34   ...........: %.4
52c0	66 20 2d 3e 20 e5 88 86  e6 95 b0 3a 20 25 2e 34   f -> ......: %.4
52d0	66 22 2c 20 74 72 65 6e  64 53 6c 6f 70 65 2c 20   f", trendSlope, 
52e0	74 72 65 6e 64 53 63 6f  72 65 29 0a 09 7d 20 65   trendScore)..} e
52f0	6c 73 65 20 69 66 20 74  72 65 6e 64 53 74 72 65   lse if trendStre
5300	6e 67 74 68 2c 20 65 78  69 73 74 73 20 3a 3d 20   ngth, exists := 
5310	73 74 61 74 65 5b 22 66  65 5f 74 72 65 6e 64 5f   state["fe_trend_
5320	73 74 72 65 6e 67 74 68  5f 32 30 22 5d 3b 20 65   strength_20"]; e
5330	78 69 73 74 73 20 7b 0a  09 09 2f 2f 20 e5 9b 9e   xists {...// ...
5340	e9 80 80 e5 88 b0 e7 89  b9 e5 be 81 e5 b7 a5 e7   ................
5350	a8 8b e8 b6 8b e5 8a bf  e7 89 b9 e5 be 81 0a 09   ................
5360	09 74 72 65 6e 64 53 63  6f 72 65 20 3d 20 6d 61   .trendScore = ma
5370	74 68 2e 4d 61 78 28 30  2e 30 2c 20 6d 61 74 68   th.Max(0.0, math
5380	2e 4d 69 6e 28 74 72 65  6e 64 53 74 72 65 6e 67   .Min(trendStreng
5390	74 68 2c 20 31 2e 30 29  29 0a 09 09 2f 2f 20 6c   th, 1.0))...// l
53a0	6f 67 2e 50 72 69 6e 74  66 28 22 5b 4f 50 50 4f   og.Printf("[OPPO
53b0	52 54 55 4e 49 54 59 5f  44 45 42 55 47 5d 20 e4   RTUNITY_DEBUG] .
53c0	bd bf e7 94 a8 46 45 e8  b6 8b e5 8a bf e5 bc ba   .....FE.........
53d0	e5 ba a6 3a 20 25 2e 34  66 20 2d 3e 20 e5 88 86   ...: %.4f -> ...
53e0	e6 95 b0 3a 20 25 2e 34  66 22 2c 20 74 72 65 6e   ...: %.4f", tren
53f0	64 53 74 72 65 6e 67 74  68 2c 20 74 72 65 6e 64   dStrength, trend
5400	53 63 6f 72 65 29 0a 09  7d 20 65 6c 73 65 20 7b   Score)..} else {
5410	0a 09 09 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   ...log.Printf("[
5420	4f 50 50 4f 52 54 55 4e  49 54 59 5f 44 45 42 55   OPPORTUNITY_DEBU
5430	47 5d 20 e6 9c aa e6 89  be e5 88 b0 e8 b6 8b e5   G] .............
5440	8a bf e6 8c 87 e6 a0 87  22 29 0a 09 7d 0a 0a 09   ........")..}...
5450	69 66 20 74 72 65 6e 64  44 69 72 65 63 74 69 6f   if trendDirectio
5460	6e 2c 20 65 78 69 73 74  73 20 3a 3d 20 73 74 61   n, exists := sta
5470	74 65 5b 22 74 72 65 6e  64 5f 64 69 72 65 63 74   te["trend_direct
5480	69 6f 6e 5f 32 30 22 5d  3b 20 65 78 69 73 74 73   ion_20"]; exists
5490	20 26 26 20 74 72 65 6e  64 44 69 72 65 63 74 69    && trendDirecti
54a0	6f 6e 20 3e 20 30 20 7b  0a 09 09 2f 2f 20 e4 b8   on > 0 {...// ..
54b0	8a e6 b6 a8 e8 b6 8b e5  8a bf e7 bb 99 e4 ba 88   ................
54c0	e9 a2 9d e5 a4 96 e5 a5  96 e5 8a b1 0a 09 09 74   ...............t
54d0	72 65 6e 64 53 63 6f 72  65 20 2a 3d 20 31 2e 32   rendScore *= 1.2
54e0	0a 09 7d 0a 0a 09 66 61  63 74 6f 72 73 5b 22 74   ..}...factors["t
54f0	72 65 6e 64 22 5d 20 3d  20 6d 61 74 68 2e 4d 69   rend"] = math.Mi
5500	6e 28 74 72 65 6e 64 53  63 6f 72 65 2c 20 31 2e   n(trendScore, 1.
5510	30 29 20 2a 20 30 2e 33  35 20 2f 2f 20 e6 8f 90   0) * 0.35 // ...
5520	e9 ab 98 e8 b6 8b e5 8a  bf e6 9d 83 e9 87 8d e4   ................
5530	bb 8e 30 2e 33 e5 88 b0  30 2e 33 35 0a 09 73 63   ..0.3...0.35..sc
5540	6f 72 65 20 2b 3d 20 66  61 63 74 6f 72 73 5b 22   ore += factors["
5550	74 72 65 6e 64 22 5d 0a  0a 09 2f 2f 20 32 2e 20   trend"]...// 2. 
5560	e5 8a a8 e9 87 8f e8 af  84 e5 88 86 ef bc 88 32   ...............2
5570	30 25 e6 9d 83 e9 87 8d  ef bc 89 0a 09 6d 6f 6d   0%...........mom
5580	65 6e 74 75 6d 53 63 6f  72 65 20 3a 3d 20 30 2e   entumScore := 0.
5590	30 0a 09 69 66 20 6d 6f  6d 65 6e 74 75 6d 31 30   0..if momentum10
55a0	2c 20 65 78 69 73 74 73  20 3a 3d 20 73 74 61 74   , exists := stat
55b0	65 5b 22 6d 6f 6d 65 6e  74 75 6d 5f 31 30 22 5d   e["momentum_10"]
55c0	3b 20 65 78 69 73 74 73  20 7b 0a 09 09 2f 2f 20   ; exists {...// 
55d0	e4 bc 98 e5 85 88 e4 bd  bf e7 94 a8 e4 bc a0 e7   ................
55e0	bb 9f e5 8a a8 e9 87 8f  e6 8c 87 e6 a0 87 ef bc   ................
55f0	88 e5 ae 9e e6 97 b6 e8  ae a1 e7 ae 97 ef bc 89   ................
5600	0a 09 09 6d 6f 6d 65 6e  74 75 6d 53 63 6f 72 65   ...momentumScore
5610	20 3d 20 6d 61 74 68 2e  4d 61 78 28 30 2c 20 6d    = math.Max(0, m
5620	61 74 68 2e 4d 69 6e 28  6d 61 74 68 2e 41 62 73   ath.Min(math.Abs
5630	28 6d 6f 6d 65 6e 74 75  6d 31 30 29 2f 30 2e 31   (momentum10)/0.1
5640	2c 20 31 2e 30 29 29 20  2f 2f 20 e6 a0 87 e5 87   , 1.0)) // .....
5650	86 e5 8c 96 e5 8a a8 e9  87 8f e5 80 bc 0a 09 09   ................
5660	2f 2f 20 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   // log.Printf("[
5670	4f 50 50 4f 52 54 55 4e  49 54 59 5f 44 45 42 55   OPPORTUNITY_DEBU
5680	47 5d 20 e4 bd bf e7 94  a8 e4 bc a0 e7 bb 9f e5   G] .............
5690	8a a8 e9 87 8f 3a 20 25  2e 34 66 20 2d 3e 20 e5   .....: %.4f -> .
56a0	88 86 e6 95 b0 3a 20 25  2e 34 66 22 2c 20 6d 6f   .....: %.4f", mo
56b0	6d 65 6e 74 75 6d 31 30  2c 20 6d 6f 6d 65 6e 74   mentum10, moment
56c0	75 6d 53 63 6f 72 65 29  0a 09 7d 20 65 6c 73 65   umScore)..} else
56d0	20 69 66 20 6d 6f 6d 65  6e 74 75 6d 35 2c 20 65    if momentum5, e
56e0	78 69 73 74 73 20 3a 3d  20 73 74 61 74 65 5b 22   xists := state["
56f0	66 65 5f 6d 6f 6d 65 6e  74 75 6d 5f 35 22 5d 3b   fe_momentum_5"];
5700	20 65 78 69 73 74 73 20  7b 0a 09 09 2f 2f 20 e5    exists {...// .
5710	9b 9e e9 80 80 e5 88 b0  e7 89 b9 e5 be 81 e5 b7   ................
5720	a5 e7 a8 8b e5 8a a8 e9  87 8f e7 89 b9 e5 be 81   ................
5730	0a 09 09 6d 6f 6d 65 6e  74 75 6d 53 63 6f 72 65   ...momentumScore
5740	20 3d 20 6d 61 74 68 2e  4d 61 78 28 30 2c 20 6d    = math.Max(0, m
5750	61 74 68 2e 4d 69 6e 28  6d 61 74 68 2e 41 62 73   ath.Min(math.Abs
5760	28 6d 6f 6d 65 6e 74 75  6d 35 29 2c 20 31 2e 30   (momentum5), 1.0
5770	29 29 0a 09 09 6c 6f 67  2e 50 72 69 6e 74 66 28   ))...log.Printf(
5780	22 5b 4f 50 50 4f 52 54  55 4e 49 54 59 5f 44 45   "[OPPORTUNITY_DE
5790	42 55 47 5d 20 e4 bd bf  e7 94 a8 46 45 e5 8a a8   BUG] ......FE...
57a0	e9 87 8f 35 e6 97 a5 3a  20 25 2e 34 66 20 2d 3e   ...5...: %.4f ->
57b0	20 e5 88 86 e6 95 b0 3a  20 25 2e 34 66 22 2c 20    ......: %.4f", 
57c0	6d 6f 6d 65 6e 74 75 6d  35 2c 20 6d 6f 6d 65 6e   momentum5, momen
57d0	74 75 6d 53 63 6f 72 65  29 0a 09 7d 20 65 6c 73   tumScore)..} els
57e0	65 20 7b 0a 09 09 6c 6f  67 2e 50 72 69 6e 74 66   e {...log.Printf
57f0	28 22 5b 4f 50 50 4f 52  54 55 4e 49 54 59 5f 44   ("[OPPORTUNITY_D
5800	45 42 55 47 5d 20 e6 9c  aa e6 89 be e5 88 b0 e5   EBUG] ..........
5810	8a a8 e9 87 8f e6 8c 87  e6 a0 87 22 29 0a 09 7d   ...........")..}
5820	0a 0a 09 66 61 63 74 6f  72 73 5b 22 6d 6f 6d 65   ...factors["mome
5830	6e 74 75 6d 22 5d 20 3d  20 6d 6f 6d 65 6e 74 75   ntum"] = momentu
5840	6d 53 63 6f 72 65 20 2a  20 30 2e 31 38 20 2f 2f   mScore * 0.18 //
5850	20 e9 99 8d e4 bd 8e e5  8a a8 e9 87 8f e6 9d 83    ...............
5860	e9 87 8d e4 bb 8e 30 2e  32 e5 88 b0 30 2e 31 38   ......0.2...0.18
5870	0a 09 73 63 6f 72 65 20  2b 3d 20 66 61 63 74 6f   ..score += facto
5880	72 73 5b 22 6d 6f 6d 65  6e 74 75 6d 22 5d 0a 0a   rs["momentum"]..
5890	09 2f 2f 20 33 2e 20 52  53 49 e5 8f 8d e8 bd ac   .// 3. RSI......
58a0	e4 bf a1 e5 8f b7 e8 af  84 e5 88 86 ef bc 88 31   ...............1
58b0	35 25 e6 9d 83 e9 87 8d  ef bc 89 0a 09 72 73 69   5%...........rsi
58c0	53 63 6f 72 65 20 3a 3d  20 30 2e 30 0a 09 69 66   Score := 0.0..if
58d0	20 72 73 69 2c 20 65 78  69 73 74 73 20 3a 3d 20    rsi, exists := 
58e0	73 74 61 74 65 5b 22 72  73 69 5f 31 34 22 5d 3b   state["rsi_14"];
58f0	20 65 78 69 73 74 73 20  7b 0a 09 09 2f 2f 20 e4    exists {...// .
5900	bc 98 e5 85 88 e4 bd bf  e7 94 a8 e4 bc a0 e7 bb   ................
5910	9f 52 53 49 e6 8c 87 e6  a0 87 ef bc 88 e5 ae 9e   .RSI............
5920	e6 97 b6 e8 ae a1 e7 ae  97 ef bc 89 0a 09 09 69   ...............i
5930	66 20 72 73 69 20 3c 20  33 30 20 7b 0a 09 09 09   f rsi < 30 {....
5940	2f 2f 20 52 53 49 e8 b6  85 e5 8d 96 ef bc 8c e4   // RSI..........
5950	b9 b0 e5 85 a5 e4 bf a1  e5 8f b7 0a 09 09 09 72   ...............r
5960	73 69 53 63 6f 72 65 20  3d 20 28 33 30 20 2d 20   siScore = (30 - 
5970	72 73 69 29 20 2f 20 33  30 20 2a 20 30 2e 38 0a   rsi) / 30 * 0.8.
5980	09 09 7d 20 65 6c 73 65  20 69 66 20 72 73 69 20   ..} else if rsi 
5990	3e 20 37 30 20 7b 0a 09  09 09 2f 2f 20 52 53 49   > 70 {....// RSI
59a0	e8 b6 85 e4 b9 b0 ef bc  8c e4 bd 86 e6 88 91 e4   ................
59b0	bb ac e6 98 af e5 81 9a  e5 a4 9a e7 ad 96 e7 95   ................
59c0	a5 ef bc 8c e6 89 80 e4  bb a5 e8 bd bb e5 be ae   ................
59d0	e6 83 a9 e7 bd 9a 0a 09  09 09 72 73 69 53 63 6f   ..........rsiSco
59e0	72 65 20 3d 20 28 72 73  69 20 2d 20 37 30 29 20   re = (rsi - 70) 
59f0	2f 20 33 30 20 2a 20 2d  30 2e 33 0a 09 09 7d 0a   / 30 * -0.3...}.
5a00	09 09 2f 2f 20 6c 6f 67  2e 50 72 69 6e 74 66 28   ..// log.Printf(
5a10	22 5b 4f 50 50 4f 52 54  55 4e 49 54 59 5f 44 45   "[OPPORTUNITY_DE
5a20	42 55 47 5d 20 e4 bd bf  e7 94 a8 e4 bc a0 e7 bb   BUG] ...........
5a30	9f 52 53 49 3a 20 25 2e  34 66 20 2d 3e 20 e5 88   .RSI: %.4f -> ..
5a40	86 e6 95 b0 3a 20 25 2e  34 66 22 2c 20 72 73 69   ....: %.4f", rsi
5a50	2c 20 72 73 69 53 63 6f  72 65 29 0a 09 7d 20 65   , rsiScore)..} e
5a60	6c 73 65 20 69 66 20 72  73 69 41 6c 74 2c 20 65   lse if rsiAlt, e
5a70	78 69 73 74 73 20 3a 3d  20 73 74 61 74 65 5b 22   xists := state["
5a80	66 65 5f 72 73 69 5f 31  34 22 5d 3b 20 65 78 69   fe_rsi_14"]; exi
5a90	73 74 73 20 7b 0a 09 09  2f 2f 20 e5 9b 9e e9 80   sts {...// .....
5aa0	80 e5 88 b0 e7 89 b9 e5  be 81 e5 b7 a5 e7 a8 8b   ................
5ab0	52 53 49 e7 89 b9 e5 be  81 0a 09 09 69 66 20 72   RSI.........if r
5ac0	73 69 41 6c 74 20 3c 20  33 30 20 7b 0a 09 09 09   siAlt < 30 {....
5ad0	72 73 69 53 63 6f 72 65  20 3d 20 28 33 30 20 2d   rsiScore = (30 -
5ae0	20 72 73 69 41 6c 74 29  20 2f 20 33 30 20 2a 20    rsiAlt) / 30 * 
5af0	30 2e 38 0a 09 09 7d 20  65 6c 73 65 20 69 66 20   0.8...} else if 
5b00	72 73 69 41 6c 74 20 3e  20 37 30 20 7b 0a 09 09   rsiAlt > 70 {...
5b10	09 72 73 69 53 63 6f 72  65 20 3d 20 28 72 73 69   .rsiScore = (rsi
5b20	41 6c 74 20 2d 20 37 30  29 20 2f 20 33 30 20 2a   Alt - 70) / 30 *
5b30	20 2d 30 2e 33 0a 09 09  7d 0a 09 09 6c 6f 67 2e    -0.3...}...log.
5b40	50 72 69 6e 74 66 28 22  5b 4f 50 50 4f 52 54 55   Printf("[OPPORTU
5b50	4e 49 54 59 5f 44 45 42  55 47 5d 20 e4 bd bf e7   NITY_DEBUG] ....
5b60	94 a8 46 45 20 52 53 49  3a 20 25 2e 34 66 20 2d   ..FE RSI: %.4f -
5b70	3e 20 e5 88 86 e6 95 b0  3a 20 25 2e 34 66 22 2c   > ......: %.4f",
5b80	20 72 73 69 41 6c 74 2c  20 72 73 69 53 63 6f 72    rsiAlt, rsiScor
5b90	65 29 0a 09 7d 20 65 6c  73 65 20 7b 0a 09 09 6c   e)..} else {...l
5ba0	6f 67 2e 50 72 69 6e 74  66 28 22 5b 4f 50 50 4f   og.Printf("[OPPO
5bb0	52 54 55 4e 49 54 59 5f  44 45 42 55 47 5d 20 e6   RTUNITY_DEBUG] .
5bc0	9c aa e6 89 be e5 88 b0  52 53 49 e6 8c 87 e6 a0   ........RSI.....
5bd0	87 22 29 0a 09 09 2f 2f  20 e5 a6 82 e6 9e 9c e6   .")...// .......
5be0	b2 a1 e6 9c 89 52 53 49  ef bc 8c e4 bd bf e7 94   .....RSI........
5bf0	a8 e5 8a a8 e9 87 8f e6  8c af e8 8d a1 e5 99 a8   ................
5c00	e4 bd 9c e4 b8 ba e6 9b  bf e4 bb a3 0a 09 09 69   ...............i
5c10	66 20 6d 6f 6d 65 6e 74  75 6d 4f 73 63 2c 20 65   f momentumOsc, e
5c20	78 69 73 74 73 20 3a 3d  20 73 74 61 74 65 5b 22   xists := state["
5c30	66 65 5f 6d 6f 6d 65 6e  74 75 6d 5f 6f 73 63 69   fe_momentum_osci
5c40	6c 6c 61 74 6f 72 22 5d  3b 20 65 78 69 73 74 73   llator"]; exists
5c50	20 7b 0a 09 09 09 69 66  20 6d 6f 6d 65 6e 74 75    {....if momentu
5c60	6d 4f 73 63 20 3c 20 33  30 20 7b 0a 09 09 09 09   mOsc < 30 {.....
5c70	72 73 69 53 63 6f 72 65  20 3d 20 28 33 30 20 2d   rsiScore = (30 -
5c80	20 6d 6f 6d 65 6e 74 75  6d 4f 73 63 29 20 2f 20    momentumOsc) / 
5c90	33 30 20 2a 20 30 2e 36  20 2f 2f 20 e4 bd bf e7   30 * 0.6 // ....
5ca0	94 a8 e8 be 83 e4 bd 8e  e6 9d 83 e9 87 8d 0a 09   ................
5cb0	09 09 7d 0a 09 09 09 6c  6f 67 2e 50 72 69 6e 74   ..}....log.Print
5cc0	66 28 22 5b 4f 50 50 4f  52 54 55 4e 49 54 59 5f   f("[OPPORTUNITY_
5cd0	44 45 42 55 47 5d 20 e4  bd bf e7 94 a8 e5 8a a8   DEBUG] .........
5ce0	e9 87 8f e6 8c af e8 8d  a1 e5 99 a8 e6 9b bf e4   ................
5cf0	bb a3 3a 20 25 2e 34 66  20 2d 3e 20 e5 88 86 e6   ..: %.4f -> ....
5d00	95 b0 3a 20 25 2e 34 66  22 2c 20 6d 6f 6d 65 6e   ..: %.4f", momen
5d10	74 75 6d 4f 73 63 2c 20  72 73 69 53 63 6f 72 65   tumOsc, rsiScore
5d20	29 0a 09 09 7d 0a 09 7d  0a 09 66 61 63 74 6f 72   )...}..}..factor
5d30	73 5b 22 72 73 69 22 5d  20 3d 20 6d 61 74 68 2e   s["rsi"] = math.
5d40	4d 61 78 28 30 2c 20 72  73 69 53 63 6f 72 65 29   Max(0, rsiScore)
5d50	20 2a 20 30 2e 31 32 20  2f 2f 20 e9 99 8d e4 bd    * 0.12 // .....
5d60	8e 52 53 49 e6 9d 83 e9  87 8d e4 bb 8e 30 2e 31   .RSI.........0.1
5d70	35 e5 88 b0 30 2e 31 32  0a 09 73 63 6f 72 65 20   5...0.12..score 
5d80	2b 3d 20 66 61 63 74 6f  72 73 5b 22 72 73 69 22   += factors["rsi"
5d90	5d 0a 0a 09 2f 2f 20 34  2e 20 e6 b3 a2 e5 8a a8   ]...// 4. ......
5da0	e7 8e 87 e8 b0 83 e6 95  b4 ef bc 88 31 35 25 e6   ............15%.
5db0	9d 83 e9 87 8d ef bc 89  2d 20 e5 b9 b3 e8 a1 a1   ........- ......
5dc0	e9 a3 8e e9 99 a9 e4 b8  8e e6 94 b6 e7 9b 8a 0a   ................
5dd0	09 69 66 20 76 6f 6c 2c  20 65 78 69 73 74 73 20   .if vol, exists 
5de0	3a 3d 20 73 74 61 74 65  5b 22 66 65 5f 76 6f 6c   := state["fe_vol
5df0	61 74 69 6c 69 74 79 5f  32 30 22 5d 3b 20 65 78   atility_20"]; ex
5e00	69 73 74 73 20 7b 0a 09  09 76 6f 6c 53 63 6f 72   ists {...volScor
5e10	65 20 3a 3d 20 30 2e 30  0a 09 09 69 66 20 76 6f   e := 0.0...if vo
5e20	6c 20 3c 20 30 2e 30 31  35 20 7b 0a 09 09 09 2f   l < 0.015 {..../
5e30	2f 20 e6 9e 81 e4 bd 8e  e6 b3 a2 e5 8a a8 e7 8e   / ..............
5e40	87 ef bc 8c e9 80 82 e5  ba a6 e5 8a a0 e5 88 86   ................
5e50	e4 bd 86 e4 b8 8d e8 bf  87 e9 ab 98 0a 09 09 09   ................
5e60	76 6f 6c 53 63 6f 72 65  20 3d 20 30 2e 34 0a 09   volScore = 0.4..
5e70	09 7d 20 65 6c 73 65 20  69 66 20 76 6f 6c 20 3c   .} else if vol <
5e80	20 30 2e 30 33 20 7b 0a  09 09 09 2f 2f 20 e9 80    0.03 {....// ..
5e90	82 e4 b8 ad e6 b3 a2 e5  8a a8 e7 8e 87 ef bc 8c   ................
5ea0	e6 9c 80 e4 bc 98 e9 80  89 e6 8b a9 0a 09 09 09   ................
5eb0	76 6f 6c 53 63 6f 72 65  20 3d 20 30 2e 37 0a 09   volScore = 0.7..
5ec0	09 7d 20 65 6c 73 65 20  69 66 20 76 6f 6c 20 3c   .} else if vol <
5ed0	20 30 2e 30 35 20 7b 0a  09 09 09 2f 2f 20 e8 be    0.05 {....// ..
5ee0	83 e9 ab 98 e6 b3 a2 e5  8a a8 e7 8e 87 ef bc 8c   ................
5ef0	e4 bb 8d e7 84 b6 e5 8f  af e6 8e a5 e5 8f 97 0a   ................
5f00	09 09 09 76 6f 6c 53 63  6f 72 65 20 3d 20 30 2e   ...volScore = 0.
5f10	33 0a 09 09 7d 20 65 6c  73 65 20 7b 0a 09 09 09   3...} else {....
5f20	2f 2f 20 e6 9e 81 e9 ab  98 e6 b3 a2 e5 8a a8 e7   // .............
5f30	8e 87 ef bc 8c e5 a4 a7  e5 b9 85 e6 83 a9 e7 bd   ................
5f40	9a 0a 09 09 09 76 6f 6c  53 63 6f 72 65 20 3d 20   .....volScore = 
5f50	2d 30 2e 35 0a 09 09 7d  0a 09 09 66 61 63 74 6f   -0.5...}...facto
5f60	72 73 5b 22 76 6f 6c 61  74 69 6c 69 74 79 22 5d   rs["volatility"]
5f70	20 3d 20 76 6f 6c 53 63  6f 72 65 20 2a 20 30 2e    = volScore * 0.
5f80	31 32 20 2f 2f 20 e9 99  8d e4 bd 8e e6 b3 a2 e5   12 // ..........
5f90	8a a8 e7 8e 87 e6 9d 83  e9 87 8d e4 bb 8e 30 2e   ..............0.
5fa0	31 35 e5 88 b0 30 2e 31  32 0a 09 09 73 63 6f 72   15...0.12...scor
5fb0	65 20 2b 3d 20 66 61 63  74 6f 72 73 5b 22 76 6f   e += factors["vo
5fc0	6c 61 74 69 6c 69 74 79  22 5d 0a 09 7d 20 65 6c   latility"]..} el
5fd0	73 65 20 69 66 20 76 6f  6c 41 6c 74 2c 20 65 78   se if volAlt, ex
5fe0	69 73 74 73 20 3a 3d 20  73 74 61 74 65 5b 22 76   ists := state["v
5ff0	6f 6c 61 74 69 6c 69 74  79 5f 32 30 22 5d 3b 20   olatility_20"]; 
6000	65 78 69 73 74 73 20 7b  0a 09 09 2f 2f 20 e5 9b   exists {...// ..
6010	9e e9 80 80 e5 88 b0 e4  bc a0 e7 bb 9f e6 b3 a2   ................
6020	e5 8a a8 e7 8e 87 e7 89  b9 e5 be 81 0a 09 09 76   ...............v
6030	6f 6c 53 63 6f 72 65 20  3a 3d 20 30 2e 30 0a 09   olScore := 0.0..
6040	09 69 66 20 76 6f 6c 41  6c 74 20 3c 20 30 2e 30   .if volAlt < 0.0
6050	31 35 20 7b 0a 09 09 09  76 6f 6c 53 63 6f 72 65   15 {....volScore
6060	20 3d 20 30 2e 34 0a 09  09 7d 20 65 6c 73 65 20    = 0.4...} else 
6070	69 66 20 76 6f 6c 41 6c  74 20 3c 20 30 2e 30 33   if volAlt < 0.03
6080	20 7b 0a 09 09 09 76 6f  6c 53 63 6f 72 65 20 3d    {....volScore =
6090	20 30 2e 37 0a 09 09 7d  20 65 6c 73 65 20 69 66    0.7...} else if
60a0	20 76 6f 6c 41 6c 74 20  3c 20 30 2e 30 35 20 7b    volAlt < 0.05 {
60b0	0a 09 09 09 76 6f 6c 53  63 6f 72 65 20 3d 20 30   ....volScore = 0
60c0	2e 33 0a 09 09 7d 20 65  6c 73 65 20 7b 0a 09 09   .3...} else {...
60d0	09 76 6f 6c 53 63 6f 72  65 20 3d 20 2d 30 2e 35   .volScore = -0.5
60e0	0a 09 09 7d 0a 09 09 66  61 63 74 6f 72 73 5b 22   ...}...factors["
60f0	76 6f 6c 61 74 69 6c 69  74 79 22 5d 20 3d 20 76   volatility"] = v
6100	6f 6c 53 63 6f 72 65 20  2a 20 30 2e 31 32 20 2f   olScore * 0.12 /
6110	2f 20 e9 99 8d e4 bd 8e  e6 b3 a2 e5 8a a8 e7 8e   / ..............
6120	87 e6 9d 83 e9 87 8d e4  bb 8e 30 2e 31 35 e5 88   ..........0.15..
6130	b0 30 2e 31 32 0a 09 09  73 63 6f 72 65 20 2b 3d   .0.12...score +=
6140	20 66 61 63 74 6f 72 73  5b 22 76 6f 6c 61 74 69    factors["volati
6150	6c 69 74 79 22 5d 0a 09  7d 0a 0a 09 2f 2f 20 35   lity"]..}...// 5
6160	2e 20 e6 88 90 e4 ba a4  e9 87 8f e7 a1 ae e8 ae   . ..............
6170	a4 ef bc 88 31 30 25 e6  9d 83 e9 87 8d ef bc 89   ....10%.........
6180	0a 09 76 6f 6c 75 6d 65  53 63 6f 72 65 20 3a 3d   ..volumeScore :=
6190	20 30 2e 35 20 2f 2f 20  e9 bb 98 e8 ae a4 e4 b8    0.5 // ........
61a0	ad e7 ad 89 e8 af 84 e5  88 86 0a 09 69 66 20 76   ............if v
61b0	6f 6c 75 6d 65 52 4f 43  2c 20 65 78 69 73 74 73   olumeROC, exists
61c0	20 3a 3d 20 73 74 61 74  65 5b 22 66 65 5f 76 6f    := state["fe_vo
61d0	6c 75 6d 65 5f 72 6f 63  5f 35 22 5d 3b 20 65 78   lume_roc_5"]; ex
61e0	69 73 74 73 20 7b 0a 09  09 76 6f 6c 75 6d 65 53   ists {...volumeS
61f0	63 6f 72 65 20 3d 20 6d  61 74 68 2e 4d 69 6e 28   core = math.Min(
6200	6d 61 74 68 2e 41 62 73  28 76 6f 6c 75 6d 65 52   math.Abs(volumeR
6210	4f 43 29 2f 31 30 30 2e  30 2b 30 2e 35 2c 20 31   OC)/100.0+0.5, 1
6220	2e 30 29 20 2f 2f 20 e6  88 90 e4 ba a4 e9 87 8f   .0) // .........
6230	e5 8f 98 e5 8c 96 e5 8a  a0 e5 88 86 0a 09 7d 20   ..............} 
6240	65 6c 73 65 20 69 66 20  76 6f 6c 75 6d 65 4d 6f   else if volumeMo
6250	6d 65 6e 74 75 6d 2c 20  65 78 69 73 74 73 20 3a   mentum, exists :
6260	3d 20 73 74 61 74 65 5b  22 66 65 5f 76 6f 6c 75   = state["fe_volu
6270	6d 65 5f 6d 6f 6d 65 6e  74 75 6d 5f 35 22 5d 3b   me_momentum_5"];
6280	20 65 78 69 73 74 73 20  7b 0a 09 09 76 6f 6c 75    exists {...volu
6290	6d 65 53 63 6f 72 65 20  3d 20 6d 61 74 68 2e 4d   meScore = math.M
62a0	69 6e 28 6d 61 74 68 2e  41 62 73 28 76 6f 6c 75   in(math.Abs(volu
62b0	6d 65 4d 6f 6d 65 6e 74  75 6d 29 2b 30 2e 35 2c   meMomentum)+0.5,
62c0	20 31 2e 30 29 0a 09 7d  20 65 6c 73 65 20 69 66    1.0)..} else if
62d0	20 76 6f 6c 75 6d 65 52  4f 43 41 6c 74 2c 20 65    volumeROCAlt, e
62e0	78 69 73 74 73 20 3a 3d  20 73 74 61 74 65 5b 22   xists := state["
62f0	76 6f 6c 75 6d 65 5f 72  6f 63 5f 35 22 5d 3b 20   volume_roc_5"]; 
6300	65 78 69 73 74 73 20 7b  0a 09 09 2f 2f 20 e5 9b   exists {...// ..
6310	9e e9 80 80 e5 88 b0 e4  bc a0 e7 bb 9f e6 88 90   ................
6320	e4 ba a4 e9 87 8f e7 89  b9 e5 be 81 0a 09 09 76   ...............v
6330	6f 6c 75 6d 65 53 63 6f  72 65 20 3d 20 6d 61 74   olumeScore = mat
6340	68 2e 4d 69 6e 28 6d 61  74 68 2e 41 62 73 28 76   h.Min(math.Abs(v
6350	6f 6c 75 6d 65 52 4f 43  41 6c 74 29 2f 31 30 30   olumeROCAlt)/100
6360	2e 30 2b 30 2e 35 2c 20  31 2e 30 29 0a 09 7d 0a   .0+0.5, 1.0)..}.
6370	09 66 61 63 74 6f 72 73  5b 22 76 6f 6c 75 6d 65   .factors["volume
6380	22 5d 20 3d 20 76 6f 6c  75 6d 65 53 63 6f 72 65   "] = volumeScore
6390	20 2a 20 30 2e 30 38 20  2f 2f 20 e9 99 8d e4 bd    * 0.08 // .....
63a0	8e e6 88 90 e4 ba a4 e9  87 8f e6 9d 83 e9 87 8d   ................
63b0	e4 bb 8e 30 2e 31 e5 88  b0 30 2e 30 38 0a 09 73   ...0.1...0.08..s
63c0	63 6f 72 65 20 2b 3d 20  66 61 63 74 6f 72 73 5b   core += factors[
63d0	22 76 6f 6c 75 6d 65 22  5d 0a 0a 09 2f 2f 20 36   "volume"]...// 6
63e0	2e 20 e6 8a 80 e6 9c af  e6 8c 87 e6 a0 87 e4 b8   . ..............
63f0	80 e8 87 b4 e6 80 a7 e8  af 84 e5 88 86 ef bc 88   ................
6400	31 30 25 e6 9d 83 e9 87  8d ef bc 89 0a 09 63 6f   10%...........co
6410	6e 73 69 73 74 65 6e 63  79 53 63 6f 72 65 20 3a   nsistencyScore :
6420	3d 20 62 65 2e 63 61 6c  63 75 6c 61 74 65 54 65   = be.calculateTe
6430	63 68 6e 69 63 61 6c 43  6f 6e 73 69 73 74 65 6e   chnicalConsisten
6440	63 79 28 73 74 61 74 65  29 0a 09 66 61 63 74 6f   cy(state)..facto
6450	72 73 5b 22 63 6f 6e 73  69 73 74 65 6e 63 79 22   rs["consistency"
6460	5d 20 3d 20 63 6f 6e 73  69 73 74 65 6e 63 79 53   ] = consistencyS
6470	63 6f 72 65 20 2a 20 30  2e 30 38 20 2f 2f 20 e9   core * 0.08 // .
6480	99 8d e4 bd 8e e4 b8 80  e8 87 b4 e6 80 a7 e6 9d   ................
6490	83 e9 87 8d e4 bb 8e 30  2e 31 e5 88 b0 30 2e 30   .......0.1...0.0
64a0	38 0a 09 73 63 6f 72 65  20 2b 3d 20 66 61 63 74   8..score += fact
64b0	6f 72 73 5b 22 63 6f 6e  73 69 73 74 65 6e 63 79   ors["consistency
64c0	22 5d 0a 0a 09 2f 2f 20  37 2e 20 e5 b8 82 e5 9c   "]...// 7. .....
64d0	ba e7 8e af e5 a2 83 e8  b0 83 e6 95 b4 ef bc 88   ................
64e0	e7 86 8a e5 b8 82 e8 bd  bb e5 be ae e6 83 a9 e7   ................
64f0	bd 9a ef bc 8c e7 89 9b  e5 b8 82 e5 a5 96 e5 8a   ................
6500	b1 ef bc 89 2d 20 e8 bf  9b e4 b8 80 e6 ad a5 e4   ....- ..........
6510	bc 98 e5 8c 96 ef bc 9a  e5 87 8f e5 b0 91 e7 86   ................
6520	8a e5 b8 82 e6 83 a9 e7  bd 9a 0a 09 6d 61 72 6b   ............mark
6530	65 74 41 64 6a 75 73 74  6d 65 6e 74 20 3a 3d 20   etAdjustment := 
6540	31 2e 30 0a 09 69 66 20  74 72 65 6e 64 44 69 72   1.0..if trendDir
6550	65 63 74 69 6f 6e 2c 20  65 78 69 73 74 73 20 3a   ection, exists :
6560	3d 20 73 74 61 74 65 5b  22 74 72 65 6e 64 5f 64   = state["trend_d
6570	69 72 65 63 74 69 6f 6e  5f 32 30 22 5d 3b 20 65   irection_20"]; e
6580	78 69 73 74 73 20 7b 0a  09 09 69 66 20 74 72 65   xists {...if tre
6590	6e 64 44 69 72 65 63 74  69 6f 6e 20 3c 20 30 20   ndDirection < 0 
65a0	7b 0a 09 09 09 2f 2f 20  e7 86 8a e5 b8 82 e7 8e   {....// ........
65b0	af e5 a2 83 e4 b8 8b e5  be ae e5 bc b1 e6 83 a9   ................
65c0	e7 bd 9a ef bc 8c e4 bb  8e 30 2e 39 e6 8f 90 e9   .........0.9....
65d0	ab 98 e5 88 b0 30 2e 39  35 0a 09 09 09 6d 61 72   .....0.95....mar
65e0	6b 65 74 41 64 6a 75 73  74 6d 65 6e 74 20 3d 20   ketAdjustment = 
65f0	30 2e 39 35 0a 09 09 7d  20 65 6c 73 65 20 69 66   0.95...} else if
6600	20 74 72 65 6e 64 44 69  72 65 63 74 69 6f 6e 20    trendDirection 
6610	3e 20 30 20 7b 0a 09 09  09 2f 2f 20 e7 89 9b e5   > 0 {....// ....
6620	b8 82 e7 8e af e5 a2 83  e4 b8 8b e9 80 82 e5 bd   ................
6630	93 e6 8f 90 e9 ab 98 e8  af 84 e5 88 86 0a 09 09   ................
6640	09 6d 61 72 6b 65 74 41  64 6a 75 73 74 6d 65 6e   .marketAdjustmen
6650	74 20 3d 20 31 2e 31 0a  09 09 7d 0a 09 7d 0a 0a   t = 1.1...}..}..
6660	09 73 63 6f 72 65 20 2a  3d 20 6d 61 72 6b 65 74   .score *= market
6670	41 64 6a 75 73 74 6d 65  6e 74 0a 0a 09 2f 2f 20   Adjustment...// 
6680	e8 ae b0 e5 bd 95 e8 af  a6 e7 bb 86 e8 af 84 e5   ................
6690	88 86 e5 9b a0 e7 b4 a0  ef bc 88 e7 94 a8 e4 ba   ................
66a0	8e e8 b0 83 e8 af 95 ef  bc 89 0a 09 6c 6f 67 2e   ............log.
66b0	50 72 69 6e 74 66 28 22  5b 4f 50 50 4f 52 54 55   Printf("[OPPORTU
66c0	4e 49 54 59 5f 53 43 4f  52 45 5d 20 25 73 e8 af   NITY_SCORE] %s..
66d0	84 e5 88 86 e8 af a6 e6  83 85 3a 20 e8 b6 8b e5   ..........: ....
66e0	8a bf 3d 25 2e 33 66 2c  20 e5 8a a8 e9 87 8f 3d   ..=%.3f, ......=
66f0	25 2e 33 66 2c 20 52 53  49 3d 25 2e 33 66 2c 20   %.3f, RSI=%.3f, 
6700	e6 b3 a2 e5 8a a8 e7 8e  87 3d 25 2e 33 66 2c 20   .........=%.3f, 
6710	e6 88 90 e4 ba a4 e9 87  8f 3d 25 2e 33 66 2c 20   .........=%.3f, 
6720	e4 b8 80 e8 87 b4 e6 80  a7 3d 25 2e 33 66 2c 20   .........=%.3f, 
6730	e5 b8 82 e5 9c ba e8 b0  83 e6 95 b4 3d 25 2e 31   ............=%.1
6740	66 2c 20 e6 80 bb e5 88  86 3d 25 2e 33 66 22 2c   f, ......=%.3f",
6750	0a 09 09 73 79 6d 62 6f  6c 2c 0a 09 09 66 61 63   ...symbol,...fac
6760	74 6f 72 73 5b 22 74 72  65 6e 64 22 5d 2c 20 66   tors["trend"], f
6770	61 63 74 6f 72 73 5b 22  6d 6f 6d 65 6e 74 75 6d   actors["momentum
6780	22 5d 2c 20 66 61 63 74  6f 72 73 5b 22 72 73 69   "], factors["rsi
6790	22 5d 2c 0a 09 09 66 61  63 74 6f 72 73 5b 22 76   "],...factors["v
67a0	6f 6c 61 74 69 6c 69 74  79 22 5d 2c 20 66 61 63   olatility"], fac
67b0	74 6f 72 73 5b 22 76 6f  6c 75 6d 65 22 5d 2c 20   tors["volume"], 
67c0	66 61 63 74 6f 72 73 5b  22 63 6f 6e 73 69 73 74   factors["consist
67d0	65 6e 63 79 22 5d 2c 0a  09 09 6d 61 72 6b 65 74   ency"],...market
67e0	41 64 6a 75 73 74 6d 65  6e 74 2c 20 73 63 6f 72   Adjustment, scor
67f0	65 29 0a 0a 09 72 65 74  75 72 6e 20 6d 61 74 68   e)...return math
6800	2e 4d 61 78 28 30 2e 30  2c 20 6d 61 74 68 2e 4d   .Max(0.0, math.M
6810	69 6e 28 31 2e 30 2c 20  73 63 6f 72 65 29 29 20   in(1.0, score)) 
6820	2f 2f 20 e7 a1 ae e4 bf  9d e8 af 84 e5 88 86 e5   // .............
6830	9c a8 30 2d 31 e8 8c 83  e5 9b b4 e5 86 85 0a 7d   ..0-1..........}
6840	0a 0a 2f 2f 20 63 61 6c  63 75 6c 61 74 65 54 65   ..// calculateTe
6850	63 68 6e 69 63 61 6c 43  6f 6e 73 69 73 74 65 6e   chnicalConsisten
6860	63 79 20 e8 ae a1 e7 ae  97 e6 8a 80 e6 9c af e6   cy .............
6870	8c 87 e6 a0 87 e4 b8 80  e8 87 b4 e6 80 a7 0a 66   ...............f
6880	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
6890	74 45 6e 67 69 6e 65 29  20 63 61 6c 63 75 6c 61   tEngine) calcula
68a0	74 65 54 65 63 68 6e 69  63 61 6c 43 6f 6e 73 69   teTechnicalConsi
68b0	73 74 65 6e 63 79 28 73  74 61 74 65 20 6d 61 70   stency(state map
68c0	5b 73 74 72 69 6e 67 5d  66 6c 6f 61 74 36 34 29   [string]float64)
68d0	20 66 6c 6f 61 74 36 34  20 7b 0a 09 2f 2f 20 e4    float64 {..// .
68e0	bc 98 e5 85 88 e4 bd bf  e7 94 a8 e7 89 b9 e5 be   ................
68f0	81 e5 b7 a5 e7 a8 8b e7  9a 84 e6 8c 87 e6 a0 87   ................
6900	ef bc 8c e7 84 b6 e5 90  8e e5 9b 9e e9 80 80 e5   ................
6910	88 b0 e4 bc a0 e7 bb 9f  e6 8c 87 e6 a0 87 0a 09   ................
6920	69 6e 64 69 63 61 74 6f  72 73 20 3a 3d 20 5b 5d   indicators := []
6930	73 74 72 75 63 74 20 7b  0a 09 09 70 72 69 6d 61   struct {...prima
6940	72 79 20 20 20 73 74 72  69 6e 67 20 20 2f 2f 20   ry   string  // 
6950	e7 89 b9 e5 be 81 e5 b7  a5 e7 a8 8b e6 8c 87 e6   ................
6960	a0 87 ef bc 88 e5 b8 a6  66 65 5f e5 89 8d e7 bc   ........fe_.....
6970	80 ef bc 89 0a 09 09 66  61 6c 6c 62 61 63 6b 20   .......fallback 
6980	20 73 74 72 69 6e 67 20  20 2f 2f 20 e4 bc a0 e7    string  // ....
6990	bb 9f e6 8c 87 e6 a0 87  0a 09 09 74 68 72 65 73   ...........thres
69a0	68 6f 6c 64 20 66 6c 6f  61 74 36 34 20 2f 2f 20   hold float64 // 
69b0	e5 88 a4 e6 96 ad e4 b8  ba e7 a7 af e6 9e 81 e4   ................
69c0	bf a1 e5 8f b7 e7 9a 84  e9 98 88 e5 80 bc 0a 09   ................
69d0	09 64 69 72 65 63 74 69  6f 6e 20 69 6e 74 20 20   .direction int  
69e0	20 20 20 2f 2f 20 31 e8  a1 a8 e7 a4 ba e5 a4 a7      // 1.........
69f0	e4 ba 8e e9 98 88 e5 80  bc e4 b8 ba e7 a7 af e6   ................
6a00	9e 81 ef bc 8c 2d 31 e8  a1 a8 e7 a4 ba e5 b0 8f   .....-1.........
6a10	e4 ba 8e e9 98 88 e5 80  bc e4 b8 ba e7 a7 af e6   ................
6a20	9e 81 0a 09 7d 7b 0a 09  09 7b 22 66 65 5f 72 73   ....}{...{"fe_rs
6a30	69 5f 31 34 22 2c 20 22  72 73 69 5f 31 34 22 2c   i_14", "rsi_14",
6a40	20 34 30 2c 20 2d 31 7d  2c 20 20 20 20 20 20 20    40, -1},       
6a50	20 20 20 2f 2f 20 52 53  49 20 3c 20 34 30 20 e4      // RSI < 40 .
6a60	b8 ba e7 a7 af e6 9e 81  0a 09 09 7b 22 66 65 5f   ...........{"fe_
6a70	6d 61 63 64 5f 73 69 67  6e 61 6c 22 2c 20 22 6d   macd_signal", "m
6a80	61 63 64 5f 73 69 67 6e  61 6c 22 2c 20 30 2c 20   acd_signal", 0, 
6a90	31 7d 2c 20 20 2f 2f 20  4d 41 43 44 20 3e 20 30   1},  // MACD > 0
6aa0	20 e4 b8 ba e7 a7 af e6  9e 81 0a 09 09 7b 22 66    ............{"f
6ab0	65 5f 73 74 6f 63 68 5f  6b 22 2c 20 22 73 74 6f   e_stoch_k", "sto
6ac0	63 68 5f 6b 22 2c 20 32  30 2c 20 2d 31 7d 2c 20   ch_k", 20, -1}, 
6ad0	20 20 20 20 20 20 20 2f  2f 20 53 74 6f 63 68 20          // Stoch 
6ae0	3c 20 32 30 20 e4 b8 ba  e7 a7 af e6 9e 81 0a 09   < 20 ...........
6af0	09 7b 22 66 65 5f 63 63  69 5f 32 30 22 2c 20 22   .{"fe_cci_20", "
6b00	63 63 69 5f 32 30 22 2c  20 2d 31 30 30 2c 20 2d   cci_20", -100, -
6b10	31 7d 2c 20 20 20 20 20  20 20 20 2f 2f 20 43 43   1},        // CC
6b20	49 20 3c 20 2d 31 30 30  20 e4 b8 ba e7 a7 af e6   I < -100 .......
6b30	9e 81 0a 09 09 7b 22 66  65 5f 77 69 6c 6c 69 61   .....{"fe_willia
6b40	6d 73 5f 72 22 2c 20 22  77 69 6c 6c 69 61 6d 73   ms_r", "williams
6b50	5f 72 22 2c 20 2d 38 30  2c 20 2d 31 7d 2c 20 2f   _r", -80, -1}, /
6b60	2f 20 57 69 6c 6c 69 61  6d 73 20 25 52 20 3c 20   / Williams %R < 
6b70	2d 38 30 20 e4 b8 ba e7  a7 af e6 9e 81 0a 09 7d   -80 ...........}
6b80	0a 0a 09 70 6f 73 69 74  69 76 65 53 69 67 6e 61   ...positiveSigna
6b90	6c 73 20 3a 3d 20 30 0a  09 74 6f 74 61 6c 49 6e   ls := 0..totalIn
6ba0	64 69 63 61 74 6f 72 73  20 3a 3d 20 30 0a 0a 09   dicators := 0...
6bb0	66 6f 72 20 5f 2c 20 69  6e 64 69 63 61 74 6f 72   for _, indicator
6bc0	20 3a 3d 20 72 61 6e 67  65 20 69 6e 64 69 63 61    := range indica
6bd0	74 6f 72 73 20 7b 0a 09  09 76 61 6c 75 65 20 3a   tors {...value :
6be0	3d 20 30 2e 30 0a 09 09  66 6f 75 6e 64 20 3a 3d   = 0.0...found :=
6bf0	20 66 61 6c 73 65 0a 0a  09 09 2f 2f 20 e4 bc 98    false....// ...
6c00	e5 85 88 e6 9f a5 e6 89  be e7 89 b9 e5 be 81 e5   ................
6c10	b7 a5 e7 a8 8b e6 8c 87  e6 a0 87 0a 09 09 69 66   ..............if
6c20	20 76 2c 20 65 78 69 73  74 73 20 3a 3d 20 73 74    v, exists := st
6c30	61 74 65 5b 69 6e 64 69  63 61 74 6f 72 2e 70 72   ate[indicator.pr
6c40	69 6d 61 72 79 5d 3b 20  65 78 69 73 74 73 20 7b   imary]; exists {
6c50	0a 09 09 09 76 61 6c 75  65 20 3d 20 76 0a 09 09   ....value = v...
6c60	09 66 6f 75 6e 64 20 3d  20 74 72 75 65 0a 09 09   .found = true...
6c70	7d 20 65 6c 73 65 20 69  66 20 76 2c 20 65 78 69   } else if v, exi
6c80	73 74 73 20 3a 3d 20 73  74 61 74 65 5b 69 6e 64   sts := state[ind
6c90	69 63 61 74 6f 72 2e 66  61 6c 6c 62 61 63 6b 5d   icator.fallback]
6ca0	3b 20 65 78 69 73 74 73  20 7b 0a 09 09 09 2f 2f   ; exists {....//
6cb0	20 e5 9b 9e e9 80 80 e5  88 b0 e4 bc a0 e7 bb 9f    ...............
6cc0	e6 8c 87 e6 a0 87 0a 09  09 09 76 61 6c 75 65 20   ..........value 
6cd0	3d 20 76 0a 09 09 09 66  6f 75 6e 64 20 3d 20 74   = v....found = t
6ce0	72 75 65 0a 09 09 7d 0a  0a 09 09 69 66 20 66 6f   rue...}....if fo
6cf0	75 6e 64 20 7b 0a 09 09  09 74 6f 74 61 6c 49 6e   und {....totalIn
6d00	64 69 63 61 74 6f 72 73  2b 2b 0a 0a 09 09 09 2f   dicators++...../
6d10	2f 20 e6 a0 b9 e6 8d ae  e6 96 b9 e5 90 91 e5 88   / ..............
6d20	a4 e6 96 ad e4 bf a1 e5  8f b7 0a 09 09 09 69 73   ..............is
6d30	50 6f 73 69 74 69 76 65  20 3a 3d 20 66 61 6c 73   Positive := fals
6d40	65 0a 09 09 09 69 66 20  69 6e 64 69 63 61 74 6f   e....if indicato
6d50	72 2e 64 69 72 65 63 74  69 6f 6e 20 3d 3d 20 31   r.direction == 1
6d60	20 26 26 20 76 61 6c 75  65 20 3e 20 69 6e 64 69    && value > indi
6d70	63 61 74 6f 72 2e 74 68  72 65 73 68 6f 6c 64 20   cator.threshold 
6d80	7b 0a 09 09 09 09 69 73  50 6f 73 69 74 69 76 65   {.....isPositive
6d90	20 3d 20 74 72 75 65 20  2f 2f 20 e5 a4 a7 e4 ba    = true // .....
6da0	8e e9 98 88 e5 80 bc e4  b8 ba e7 a7 af e6 9e 81   ................
6db0	e4 bf a1 e5 8f b7 0a 09  09 09 7d 20 65 6c 73 65   ..........} else
6dc0	20 69 66 20 69 6e 64 69  63 61 74 6f 72 2e 64 69    if indicator.di
6dd0	72 65 63 74 69 6f 6e 20  3d 3d 20 2d 31 20 26 26   rection == -1 &&
6de0	20 76 61 6c 75 65 20 3c  20 69 6e 64 69 63 61 74    value < indicat
6df0	6f 72 2e 74 68 72 65 73  68 6f 6c 64 20 7b 0a 09   or.threshold {..
6e00	09 09 09 69 73 50 6f 73  69 74 69 76 65 20 3d 20   ...isPositive = 
6e10	74 72 75 65 20 2f 2f 20  e5 b0 8f e4 ba 8e e9 98   true // ........
6e20	88 e5 80 bc e4 b8 ba e7  a7 af e6 9e 81 e4 bf a1   ................
6e30	e5 8f b7 0a 09 09 09 7d  0a 0a 09 09 09 69 66 20   .......}.....if 
6e40	69 73 50 6f 73 69 74 69  76 65 20 7b 0a 09 09 09   isPositive {....
6e50	09 70 6f 73 69 74 69 76  65 53 69 67 6e 61 6c 73   .positiveSignals
6e60	2b 2b 0a 09 09 09 7d 0a  09 09 7d 0a 09 7d 0a 0a   ++....}...}..}..
6e70	09 2f 2f 20 e5 a6 82 e6  9e 9c e6 b2 a1 e6 9c 89   .// ............
6e80	e4 bb bb e4 bd 95 e6 8c  87 e6 a0 87 ef bc 8c e7   ................
6e90	bb 99 e4 ba 88 e4 b8 ad  e7 ad 89 e4 b8 80 e8 87   ................
6ea0	b4 e6 80 a7 e8 af 84 e5  88 86 0a 09 69 66 20 74   ............if t
6eb0	6f 74 61 6c 49 6e 64 69  63 61 74 6f 72 73 20 3d   otalIndicators =
6ec0	3d 20 30 20 7b 0a 09 09  72 65 74 75 72 6e 20 30   = 0 {...return 0
6ed0	2e 35 0a 09 7d 0a 0a 09  2f 2f 20 e8 ae a1 e7 ae   .5..}...// .....
6ee0	97 e4 b8 80 e8 87 b4 e6  80 a7 ef bc 9a e7 a7 af   ................
6ef0	e6 9e 81 e4 bf a1 e5 8f  b7 e6 af 94 e4 be 8b 0a   ................
6f00	09 63 6f 6e 73 69 73 74  65 6e 63 79 20 3a 3d 20   .consistency := 
6f10	66 6c 6f 61 74 36 34 28  70 6f 73 69 74 69 76 65   float64(positive
6f20	53 69 67 6e 61 6c 73 29  20 2f 20 66 6c 6f 61 74   Signals) / float
6f30	36 34 28 74 6f 74 61 6c  49 6e 64 69 63 61 74 6f   64(totalIndicato
6f40	72 73 29 0a 0a 09 2f 2f  20 e4 b8 80 e8 87 b4 e6   rs)...// .......
6f50	80 a7 e8 af 84 e5 88 86  ef bc 9a e5 ae 8c e5 85   ................
6f60	a8 e4 b8 80 e8 87 b4 3d  31 2e 30 ef bc 8c e9 9a   .......=1.0.....
6f70	8f e6 9c ba 3d 30 2e 35  ef bc 8c e5 ae 8c e5 85   ....=0.5........
6f80	a8 e7 9b b8 e5 8f 8d 3d  30 2e 30 0a 09 2f 2f 20   .......=0.0..// 
6f90	e4 bd bf e7 94 a8 73 69  67 6d 6f 69 64 e5 87 bd   ......sigmoid...
6fa0	e6 95 b0 e4 bd bf e8 af  84 e5 88 86 e6 9b b4 e5   ................
6fb0	b9 b3 e6 bb 91 0a 09 72  65 74 75 72 6e 20 31 2e   .......return 1.
6fc0	30 20 2f 20 28 31 2e 30  20 2b 20 6d 61 74 68 2e   0 / (1.0 + math.
6fd0	45 78 70 28 2d 32 2e 30  2a 28 63 6f 6e 73 69 73   Exp(-2.0*(consis
6fe0	74 65 6e 63 79 2d 30 2e  35 29 29 29 0a 7d 0a 0a   tency-0.5))).}..
6ff0	2f 2f 20 65 78 65 63 75  74 65 4d 75 6c 74 69 53   // executeMultiS
7000	79 6d 62 6f 6c 54 72 61  64 65 20 e6 89 a7 e8 a1   ymbolTrade .....
7010	8c e5 a4 9a e5 b8 81 e7  a7 8d e4 ba a4 e6 98 93   ................
7020	0a 66 75 6e 63 20 28 62  65 20 2a 42 61 63 6b 74   .func (be *Backt
7030	65 73 74 45 6e 67 69 6e  65 29 20 65 78 65 63 75   estEngine) execu
7040	74 65 4d 75 6c 74 69 53  79 6d 62 6f 6c 54 72 61   teMultiSymbolTra
7050	64 65 28 6f 70 70 6f 72  74 75 6e 69 74 79 20 2a   de(opportunity *
7060	54 72 61 64 65 4f 70 70  6f 72 74 75 6e 69 74 79   TradeOpportunity
7070	2c 20 73 79 6d 62 6f 6c  53 74 61 74 65 73 20 6d   , symbolStates m
7080	61 70 5b 73 74 72 69 6e  67 5d 2a 53 79 6d 62 6f   ap[string]*Symbo
7090	6c 53 74 61 74 65 2c 20  61 76 61 69 6c 61 62 6c   lState, availabl
70a0	65 43 61 73 68 20 2a 66  6c 6f 61 74 36 34 2c 20   eCash *float64, 
70b0	74 6f 74 61 6c 43 61 73  68 20 2a 66 6c 6f 61 74   totalCash *float
70c0	36 34 2c 20 72 65 73 75  6c 74 20 2a 42 61 63 6b   64, result *Back
70d0	74 65 73 74 52 65 73 75  6c 74 2c 20 74 69 6d 65   testResult, time
70e0	73 74 61 6d 70 20 74 69  6d 65 2e 54 69 6d 65 2c   stamp time.Time,
70f0	20 63 6f 6e 66 69 67 20  2a 42 61 63 6b 74 65 73    config *Backtes
7100	74 43 6f 6e 66 69 67 29  20 65 72 72 6f 72 20 7b   tConfig) error {
7110	0a 09 2f 2f 20 e6 9c 80  e5 a4 a7 e5 9b 9e e6 92   ..// ...........
7120	a4 e6 8e a7 e5 88 b6 ef  bc 9a e5 9c a8 e6 89 a7   ................
7130	e8 a1 8c e4 ba a4 e6 98  93 e5 89 8d e6 a3 80 e6   ................
7140	9f a5 e6 98 af e5 90 a6  e8 b6 85 e8 bf 87 e5 9b   ................
7150	9e e6 92 a4 e9 99 90 e5  88 b6 0a 09 69 66 20 62   ............if b
7160	65 2e 73 68 6f 75 6c 64  42 6c 6f 63 6b 54 72 61   e.shouldBlockTra
7170	64 65 44 75 65 54 6f 44  72 61 77 64 6f 77 6e 28   deDueToDrawdown(
7180	72 65 73 75 6c 74 2c 20  63 6f 6e 66 69 67 29 20   result, config) 
7190	7b 0a 09 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   {...log.Printf("
71a0	5b 44 52 41 57 44 4f 57  4e 5f 43 4f 4e 54 52 4f   [DRAWDOWN_CONTRO
71b0	4c 5d 20 e5 9b a0 e5 9b  9e e6 92 a4 e9 99 90 e5   L] .............
71c0	88 b6 e8 b7 b3 e8 bf 87  e4 ba a4 e6 98 93 3a 20   ..............: 
71d0	25 73 22 2c 20 6f 70 70  6f 72 74 75 6e 69 74 79   %s", opportunity
71e0	2e 53 79 6d 62 6f 6c 29  0a 09 09 72 65 74 75 72   .Symbol)...retur
71f0	6e 20 6e 69 6c 20 2f 2f  20 e4 b8 8d e6 89 a7 e8   n nil // .......
7200	a1 8c e4 ba a4 e6 98 93  ef bc 8c e4 bd 86 e4 b8   ................
7210	8d e6 8a a5 e9 94 99 0a  09 7d 0a 0a 09 2f 2f 20   .........}...// 
7220	e4 bd bf e7 94 a8 e6 8a  95 e8 b5 84 e7 bb 84 e5   ................
7230	90 88 e4 bc 98 e5 8c 96  e8 ae a1 e7 ae 97 e4 bb   ................
7240	93 e4 bd 8d e5 a4 a7 e5  b0 8f 0a 09 70 6f 73 69   ............posi
7250	74 69 6f 6e 53 69 7a 65  20 3a 3d 20 62 65 2e 63   tionSize := be.c
7260	61 6c 63 75 6c 61 74 65  4f 70 74 69 6d 69 7a 65   alculateOptimize
7270	64 50 6f 73 69 74 69 6f  6e 53 69 7a 65 28 6f 70   dPositionSize(op
7280	70 6f 72 74 75 6e 69 74  79 2c 20 73 79 6d 62 6f   portunity, symbo
7290	6c 53 74 61 74 65 73 2c  20 2a 61 76 61 69 6c 61   lStates, *availa
72a0	62 6c 65 43 61 73 68 2c  20 63 6f 6e 66 69 67 29   bleCash, config)
72b0	0a 0a 09 69 66 20 70 6f  73 69 74 69 6f 6e 53 69   ...if positionSi
72c0	7a 65 20 3c 3d 20 30 20  7b 0a 09 09 6c 6f 67 2e   ze <= 0 {...log.
72d0	50 72 69 6e 74 66 28 22  5b 50 4f 52 54 46 4f 4c   Printf("[PORTFOL
72e0	49 4f 5f 4f 50 54 49 4d  49 5a 41 54 49 4f 4e 5d   IO_OPTIMIZATION]
72f0	20 e8 b7 b3 e8 bf 87 e4  ba a4 e6 98 93 3a 20 e4    ............: .
7300	bc 98 e5 8c 96 e5 90 8e  e7 9a 84 e4 bb 93 e4 bd   ................
7310	8d e5 a4 a7 e5 b0 8f e6  97 a0 e6 95 88 20 25 2e   ............. %.
7320	36 66 22 2c 20 70 6f 73  69 74 69 6f 6e 53 69 7a   6f", positionSiz
7330	65 29 0a 09 09 72 65 74  75 72 6e 20 6e 69 6c 20   e)...return nil 
7340	2f 2f 20 e8 b7 b3 e8 bf  87 e4 ba a4 e6 98 93 ef   // .............
7350	bc 8c e4 b8 8d e6 8a a5  e9 94 99 0a 09 7d 0a 0a   .............}..
7360	09 2f 2f 20 e6 89 a7 e8  a1 8c e4 b9 b0 e5 85 a5   .// ............
7370	0a 09 63 6f 6d 6d 69 73  73 69 6f 6e 20 3a 3d 20   ..commission := 
7380	70 6f 73 69 74 69 6f 6e  53 69 7a 65 20 2a 20 6f   positionSize * o
7390	70 70 6f 72 74 75 6e 69  74 79 2e 50 72 69 63 65   pportunity.Price
73a0	20 2a 20 63 6f 6e 66 69  67 2e 43 6f 6d 6d 69 73    * config.Commis
73b0	73 69 6f 6e 0a 0a 09 6f  70 70 6f 72 74 75 6e 69   sion...opportuni
73c0	74 79 2e 53 74 61 74 65  2e 50 6f 73 69 74 69 6f   ty.State.Positio
73d0	6e 20 3d 20 70 6f 73 69  74 69 6f 6e 53 69 7a 65   n = positionSize
73e0	0a 09 2a 61 76 61 69 6c  61 62 6c 65 43 61 73 68   ..*availableCash
73f0	20 2d 3d 20 28 70 6f 73  69 74 69 6f 6e 53 69 7a    -= (positionSiz
7400	65 2a 6f 70 70 6f 72 74  75 6e 69 74 79 2e 50 72   e*opportunity.Pr
7410	69 63 65 20 2b 20 63 6f  6d 6d 69 73 73 69 6f 6e   ice + commission
7420	29 0a 09 6f 70 70 6f 72  74 75 6e 69 74 79 2e 53   )..opportunity.S
7430	74 61 74 65 2e 4c 61 73  74 54 72 61 64 65 49 6e   tate.LastTradeIn
7440	64 65 78 20 3d 20 6c 65  6e 28 6f 70 70 6f 72 74   dex = len(opport
7450	75 6e 69 74 79 2e 53 74  61 74 65 2e 44 61 74 61   unity.State.Data
7460	29 20 2d 20 31 20 2f 2f  20 e7 ae 80 e5 8c 96 e5   ) - 1 // .......
7470	a4 84 e7 90 86 0a 09 6f  70 70 6f 72 74 75 6e 69   .......opportuni
7480	74 79 2e 53 74 61 74 65  2e 48 6f 6c 64 54 69 6d   ty.State.HoldTim
7490	65 20 3d 20 30 0a 0a 09  2f 2f 20 e8 ae b0 e5 bd   e = 0...// .....
74a0	95 e4 ba a4 e6 98 93 0a  09 72 65 73 75 6c 74 2e   .........result.
74b0	54 72 61 64 65 73 20 3d  20 61 70 70 65 6e 64 28   Trades = append(
74c0	72 65 73 75 6c 74 2e 54  72 61 64 65 73 2c 20 54   result.Trades, T
74d0	72 61 64 65 52 65 63 6f  72 64 7b 0a 09 09 53 79   radeRecord{...Sy
74e0	6d 62 6f 6c 3a 20 20 20  20 20 20 20 6f 70 70 6f   mbol:       oppo
74f0	72 74 75 6e 69 74 79 2e  53 79 6d 62 6f 6c 2c 0a   rtunity.Symbol,.
7500	09 09 53 69 64 65 3a 20  20 20 20 20 20 20 20 20   ..Side:         
7510	22 62 75 79 22 2c 0a 09  09 51 75 61 6e 74 69 74   "buy",...Quantit
7520	79 3a 20 20 20 20 20 70  6f 73 69 74 69 6f 6e 53   y:     positionS
7530	69 7a 65 2c 0a 09 09 50  72 69 63 65 3a 20 20 20   ize,...Price:   
7540	20 20 20 20 20 6f 70 70  6f 72 74 75 6e 69 74 79        opportunity
7550	2e 50 72 69 63 65 2c 0a  09 09 54 69 6d 65 73 74   .Price,...Timest
7560	61 6d 70 3a 20 20 20 20  74 69 6d 65 73 74 61 6d   amp:    timestam
7570	70 2c 0a 09 09 43 6f 6d  6d 69 73 73 69 6f 6e 3a   p,...Commission:
7580	20 20 20 63 6f 6d 6d 69  73 73 69 6f 6e 2c 0a 09      commission,..
7590	09 50 6e 4c 3a 20 20 20  20 20 20 20 20 20 20 30   .PnL:          0
75a0	2c 0a 09 09 41 49 43 6f  6e 66 69 64 65 6e 63 65   ,...AIConfidence
75b0	3a 20 6f 70 70 6f 72 74  75 6e 69 74 79 2e 43 6f   : opportunity.Co
75c0	6e 66 69 64 65 6e 63 65  2c 0a 09 09 52 65 61 73   nfidence,...Reas
75d0	6f 6e 3a 20 20 20 20 20  20 20 6f 70 70 6f 72 74   on:       opport
75e0	75 6e 69 74 79 2e 52 65  61 73 6f 6e 2c 0a 09 7d   unity.Reason,..}
75f0	29 0a 0a 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   )...log.Printf("
7600	5b 4d 55 4c 54 49 5f 53  59 4d 42 4f 4c 5f 54 52   [MULTI_SYMBOL_TR
7610	41 44 45 5d 20 e6 89 a7  e8 a1 8c e4 b9 b0 e5 85   ADE] ...........
7620	a5 3a 20 25 73 2c 20 e4  bb b7 e6 a0 bc 3d 25 2e   .: %s, ......=%.
7630	34 66 2c 20 e6 95 b0 e9  87 8f 3d 25 2e 34 66 2c   4f, ......=%.4f,
7640	20 e6 80 bb e4 bb b7 e5  80 bc 3d 25 2e 32 66 2c    .........=%.2f,
7650	20 e5 89 a9 e4 bd 99 e7  8e b0 e9 87 91 3d 25 2e    ............=%.
7660	32 66 22 2c 0a 09 09 6f  70 70 6f 72 74 75 6e 69   2f",...opportuni
7670	74 79 2e 53 79 6d 62 6f  6c 2c 20 6f 70 70 6f 72   ty.Symbol, oppor
7680	74 75 6e 69 74 79 2e 50  72 69 63 65 2c 20 70 6f   tunity.Price, po
7690	73 69 74 69 6f 6e 53 69  7a 65 2c 20 70 6f 73 69   sitionSize, posi
76a0	74 69 6f 6e 53 69 7a 65  2a 6f 70 70 6f 72 74 75   tionSize*opportu
76b0	6e 69 74 79 2e 50 72 69  63 65 2c 20 2a 61 76 61   nity.Price, *ava
76c0	69 6c 61 62 6c 65 43 61  73 68 29 0a 0a 09 72 65   ilableCash)...re
76d0	74 75 72 6e 20 6e 69 6c  0a 7d 0a 0a 2f 2f 20 63   turn nil.}..// c
76e0	61 6c 63 75 6c 61 74 65  4f 70 74 69 6d 69 7a 65   alculateOptimize
76f0	64 50 6f 73 69 74 69 6f  6e 53 69 7a 65 20 e8 ae   dPositionSize ..
7700	a1 e7 ae 97 e4 bc 98 e5  8c 96 e5 90 8e e7 9a 84   ................
7710	e4 bb 93 e4 bd 8d e5 a4  a7 e5 b0 8f 0a 66 75 6e   .............fun
7720	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
7730	6e 67 69 6e 65 29 20 63  61 6c 63 75 6c 61 74 65   ngine) calculate
7740	4f 70 74 69 6d 69 7a 65  64 50 6f 73 69 74 69 6f   OptimizedPositio
7750	6e 53 69 7a 65 28 6f 70  70 6f 72 74 75 6e 69 74   nSize(opportunit
7760	79 20 2a 54 72 61 64 65  4f 70 70 6f 72 74 75 6e   y *TradeOpportun
7770	69 74 79 2c 20 73 79 6d  62 6f 6c 53 74 61 74 65   ity, symbolState
7780	73 20 6d 61 70 5b 73 74  72 69 6e 67 5d 2a 53 79   s map[string]*Sy
7790	6d 62 6f 6c 53 74 61 74  65 2c 20 61 76 61 69 6c   mbolState, avail
77a0	61 62 6c 65 43 61 73 68  20 66 6c 6f 61 74 36 34   ableCash float64
77b0	2c 20 63 6f 6e 66 69 67  20 2a 42 61 63 6b 74 65   , config *Backte
77c0	73 74 43 6f 6e 66 69 67  29 20 66 6c 6f 61 74 36   stConfig) float6
77d0	34 20 7b 0a 09 2f 2f 20  31 2e 20 e8 ae a1 e7 ae   4 {..// 1. .....
77e0	97 e5 9f ba e7 a1 80 e4  bb 93 e4 bd 8d e5 a4 a7   ................
77f0	e5 b0 8f 0a 09 62 61 73  65 50 6f 73 69 74 69 6f   .....basePositio
7800	6e 53 69 7a 65 20 3a 3d  20 62 65 2e 63 61 6c 63   nSize := be.calc
7810	75 6c 61 74 65 4d 75 6c  74 69 53 79 6d 62 6f 6c   ulateMultiSymbol
7820	50 6f 73 69 74 69 6f 6e  53 69 7a 65 28 61 76 61   PositionSize(ava
7830	69 6c 61 62 6c 65 43 61  73 68 2c 20 6f 70 70 6f   ilableCash, oppo
7840	72 74 75 6e 69 74 79 2e  50 72 69 63 65 2c 20 63   rtunity.Price, c
7850	6f 6e 66 69 67 29 0a 0a  09 2f 2f 20 32 2e 20 e5   onfig)...// 2. .
7860	ba 94 e7 94 a8 e6 8a 95  e8 b5 84 e7 bb 84 e5 90   ................
7870	88 e5 b1 82 e9 9d a2 e7  9a 84 e4 bc 98 e5 8c 96   ................
7880	0a 09 70 6f 72 74 66 6f  6c 69 6f 4f 70 74 69 6d   ..portfolioOptim
7890	69 7a 65 64 53 69 7a 65  20 3a 3d 20 62 65 2e 61   izedSize := be.a
78a0	70 70 6c 79 50 6f 72 74  66 6f 6c 69 6f 4f 70 74   pplyPortfolioOpt
78b0	69 6d 69 7a 61 74 69 6f  6e 28 6f 70 70 6f 72 74   imization(opport
78c0	75 6e 69 74 79 2c 20 73  79 6d 62 6f 6c 53 74 61   unity, symbolSta
78d0	74 65 73 2c 20 62 61 73  65 50 6f 73 69 74 69 6f   tes, basePositio
78e0	6e 53 69 7a 65 2c 20 61  76 61 69 6c 61 62 6c 65   nSize, available
78f0	43 61 73 68 29 0a 0a 09  2f 2f 20 33 2e 20 e5 ba   Cash)...// 3. ..
7900	94 e7 94 a8 e9 a3 8e e9  99 a9 e7 ae a1 e7 90 86   ................
7910	e5 92 8c e8 b5 84 e9 87  91 e9 99 90 e5 88 b6 0a   ................
7920	09 72 69 73 6b 41 64 6a  75 73 74 65 64 53 69 7a   .riskAdjustedSiz
7930	65 20 3a 3d 20 62 65 2e  61 70 70 6c 79 52 69 73   e := be.applyRis
7940	6b 4d 61 6e 61 67 65 6d  65 6e 74 43 6f 6e 73 74   kManagementConst
7950	72 61 69 6e 74 73 28 6f  70 70 6f 72 74 75 6e 69   raints(opportuni
7960	74 79 2c 20 73 79 6d 62  6f 6c 53 74 61 74 65 73   ty, symbolStates
7970	2c 20 70 6f 72 74 66 6f  6c 69 6f 4f 70 74 69 6d   , portfolioOptim
7980	69 7a 65 64 53 69 7a 65  2c 20 61 76 61 69 6c 61   izedSize, availa
7990	62 6c 65 43 61 73 68 29  0a 0a 09 6c 6f 67 2e 50   bleCash)...log.P
79a0	72 69 6e 74 66 28 22 5b  50 4f 53 49 54 49 4f 4e   rintf("[POSITION
79b0	5f 4f 50 54 49 4d 49 5a  41 54 49 4f 4e 5d 20 25   _OPTIMIZATION] %
79c0	73 e4 bb 93 e4 bd 8d e4  bc 98 e5 8c 96 3a 20 e5   s............: .
79d0	9f ba e7 a1 80 3d 25 2e  34 66 2c 20 e7 bb 84 e5   .....=%.4f, ....
79e0	90 88 e4 bc 98 e5 8c 96  3d 25 2e 34 66 2c 20 e9   ........=%.4f, .
79f0	a3 8e e9 99 a9 e8 b0 83  e6 95 b4 3d 25 2e 34 66   ...........=%.4f
7a00	22 2c 0a 09 09 6f 70 70  6f 72 74 75 6e 69 74 79   ",...opportunity
7a10	2e 53 79 6d 62 6f 6c 2c  20 62 61 73 65 50 6f 73   .Symbol, basePos
7a20	69 74 69 6f 6e 53 69 7a  65 2c 20 70 6f 72 74 66   itionSize, portf
7a30	6f 6c 69 6f 4f 70 74 69  6d 69 7a 65 64 53 69 7a   olioOptimizedSiz
7a40	65 2c 20 72 69 73 6b 41  64 6a 75 73 74 65 64 53   e, riskAdjustedS
7a50	69 7a 65 29 0a 0a 09 72  65 74 75 72 6e 20 72 69   ize)...return ri
7a60	73 6b 41 64 6a 75 73 74  65 64 53 69 7a 65 0a 7d   skAdjustedSize.}
7a70	0a 0a 2f 2f 20 63 61 6c  63 75 6c 61 74 65 4d 75   ..// calculateMu
7a80	6c 74 69 53 79 6d 62 6f  6c 50 6f 73 69 74 69 6f   ltiSymbolPositio
7a90	6e 53 69 7a 65 20 e8 ae  a1 e7 ae 97 e5 a4 9a e5   nSize ..........
7aa0	b8 81 e7 a7 8d e4 bb 93  e4 bd 8d e5 a4 a7 e5 b0   ................
7ab0	8f 20 2d 20 e5 8a a8 e6  80 81 e4 bb 93 e4 bd 8d   . - ............
7ac0	e7 ae a1 e7 90 86 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
7ad0	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
7ae0	20 63 61 6c 63 75 6c 61  74 65 4d 75 6c 74 69 53    calculateMultiS
7af0	79 6d 62 6f 6c 50 6f 73  69 74 69 6f 6e 53 69 7a   ymbolPositionSiz
7b00	65 28 61 76 61 69 6c 61  62 6c 65 43 61 73 68 20   e(availableCash 
7b10	66 6c 6f 61 74 36 34 2c  20 70 72 69 63 65 20 66   float64, price f
7b20	6c 6f 61 74 36 34 2c 20  63 6f 6e 66 69 67 20 2a   loat64, config *
7b30	42 61 63 6b 74 65 73 74  43 6f 6e 66 69 67 29 20   BacktestConfig) 
7b40	66 6c 6f 61 74 36 34 20  7b 0a 09 2f 2f 20 e5 9f   float64 {..// ..
7b50	ba e7 a1 80 e4 bb 93 e4  bd 8d e6 af 94 e4 be 8b   ................
7b60	ef bc 88 e5 8f af e9 85  8d e7 bd ae ef bc 89 0a   ................
7b70	09 62 61 73 65 50 6f 73  69 74 69 6f 6e 52 61 74   .basePositionRat
7b80	69 6f 20 3a 3d 20 63 6f  6e 66 69 67 2e 50 6f 73   io := config.Pos
7b90	69 74 69 6f 6e 53 69 7a  65 0a 0a 09 2f 2f 20 e5   itionSize...// .
7ba0	ba 94 e7 94 a8 e5 8a a8  e6 80 81 e4 bb 93 e4 bd   ................
7bb0	8d e8 b0 83 e6 95 b4 0a  09 61 64 6a 75 73 74 65   .........adjuste
7bc0	64 52 61 74 69 6f 20 3a  3d 20 62 65 2e 63 61 6c   dRatio := be.cal
7bd0	63 75 6c 61 74 65 44 79  6e 61 6d 69 63 50 6f 73   culateDynamicPos
7be0	69 74 69 6f 6e 52 61 74  69 6f 28 62 61 73 65 50   itionRatio(baseP
7bf0	6f 73 69 74 69 6f 6e 52  61 74 69 6f 2c 20 63 6f   ositionRatio, co
7c00	6e 66 69 67 29 0a 0a 09  2f 2f 20 e8 ae a1 e7 ae   nfig)...// .....
7c10	97 e5 ae 9e e9 99 85 e4  bb 93 e4 bd 8d e4 bb b7   ................
7c20	e5 80 bc 0a 09 70 6f 73  69 74 69 6f 6e 56 61 6c   .....positionVal
7c30	75 65 20 3a 3d 20 61 76  61 69 6c 61 62 6c 65 43   ue := availableC
7c40	61 73 68 20 2a 20 61 64  6a 75 73 74 65 64 52 61   ash * adjustedRa
7c50	74 69 6f 0a 0a 09 2f 2f  20 e8 bd ac e6 8d a2 e4   tio...// .......
7c60	b8 ba e6 95 b0 e9 87 8f  0a 09 70 6f 73 69 74 69   ..........positi
7c70	6f 6e 53 69 7a 65 20 3a  3d 20 70 6f 73 69 74 69   onSize := positi
7c80	6f 6e 56 61 6c 75 65 20  2f 20 70 72 69 63 65 0a   onValue / price.
7c90	0a 09 6c 6f 67 2e 50 72  69 6e 74 66 28 22 5b 44   ..log.Printf("[D
7ca0	59 4e 41 4d 49 43 5f 50  4f 53 49 54 49 4f 4e 5d   YNAMIC_POSITION]
7cb0	20 e5 8a a8 e6 80 81 e4  bb 93 e4 bd 8d e8 ae a1    ...............
7cc0	e7 ae 97 3a 20 e5 9f ba  e7 a1 80 e6 af 94 e4 be   ...: ...........
7cd0	8b 3d 25 2e 32 66 25 25  2c 20 e8 b0 83 e6 95 b4   .=%.2f%%, ......
7ce0	e5 90 8e e6 af 94 e4 be  8b 3d 25 2e 32 66 25 25   .........=%.2f%%
7cf0	2c 20 e5 8f af e7 94 a8  e7 8e b0 e9 87 91 3d 25   , ............=%
7d00	2e 32 66 2c 20 e4 bb b7  e6 a0 bc 3d 25 2e 34 66   .2f, ......=%.4f
7d10	2c 20 e4 bb 93 e4 bd 8d  e5 a4 a7 e5 b0 8f 3d 25   , ............=%
7d20	2e 34 66 22 2c 0a 09 09  62 61 73 65 50 6f 73 69   .4f",...basePosi
7d30	74 69 6f 6e 52 61 74 69  6f 2a 31 30 30 2c 20 61   tionRatio*100, a
7d40	64 6a 75 73 74 65 64 52  61 74 69 6f 2a 31 30 30   djustedRatio*100
7d50	2c 20 61 76 61 69 6c 61  62 6c 65 43 61 73 68 2c   , availableCash,
7d60	20 70 72 69 63 65 2c 20  70 6f 73 69 74 69 6f 6e    price, position
7d70	53 69 7a 65 29 0a 0a 09  72 65 74 75 72 6e 20 70   Size)...return p
7d80	6f 73 69 74 69 6f 6e 53  69 7a 65 0a 7d 0a 0a 2f   ositionSize.}../
7d90	2f 20 61 70 70 6c 79 50  6f 72 74 66 6f 6c 69 6f   / applyPortfolio
7da0	4f 70 74 69 6d 69 7a 61  74 69 6f 6e 20 e5 ba 94   Optimization ...
7db0	e7 94 a8 e6 8a 95 e8 b5  84 e7 bb 84 e5 90 88 e4   ................
7dc0	bc 98 e5 8c 96 0a 66 75  6e 63 20 28 62 65 20 2a   ......func (be *
7dd0	42 61 63 6b 74 65 73 74  45 6e 67 69 6e 65 29 20   BacktestEngine) 
7de0	61 70 70 6c 79 50 6f 72  74 66 6f 6c 69 6f 4f 70   applyPortfolioOp
7df0	74 69 6d 69 7a 61 74 69  6f 6e 28 6f 70 70 6f 72   timization(oppor
7e00	74 75 6e 69 74 79 20 2a  54 72 61 64 65 4f 70 70   tunity *TradeOpp
7e10	6f 72 74 75 6e 69 74 79  2c 20 73 79 6d 62 6f 6c   ortunity, symbol
7e20	53 74 61 74 65 73 20 6d  61 70 5b 73 74 72 69 6e   States map[strin
7e30	67 5d 2a 53 79 6d 62 6f  6c 53 74 61 74 65 2c 20   g]*SymbolState, 
7e40	62 61 73 65 50 6f 73 69  74 69 6f 6e 53 69 7a 65   basePositionSize
7e50	20 66 6c 6f 61 74 36 34  2c 20 61 76 61 69 6c 61    float64, availa
7e60	62 6c 65 43 61 73 68 20  66 6c 6f 61 74 36 34 29   bleCash float64)
7e70	20 66 6c 6f 61 74 36 34  20 7b 0a 09 2f 2f 20 e8    float64 {..// .
7e80	ae a1 e7 ae 97 e5 bd 93  e5 89 8d e6 8a 95 e8 b5   ................
7e90	84 e7 bb 84 e5 90 88 e7  9a 84 e6 9d 83 e9 87 8d   ................
7ea0	0a 09 63 75 72 72 65 6e  74 57 65 69 67 68 74 73   ..currentWeights
7eb0	20 3a 3d 20 6d 61 6b 65  28 6d 61 70 5b 73 74 72    := make(map[str
7ec0	69 6e 67 5d 66 6c 6f 61  74 36 34 29 0a 09 74 6f   ing]float64)..to
7ed0	74 61 6c 50 6f 72 74 66  6f 6c 69 6f 56 61 6c 75   talPortfolioValu
7ee0	65 20 3a 3d 20 30 2e 30  0a 0a 09 66 6f 72 20 73   e := 0.0...for s
7ef0	79 6d 62 6f 6c 2c 20 73  74 61 74 65 20 3a 3d 20   ymbol, state := 
7f00	72 61 6e 67 65 20 73 79  6d 62 6f 6c 53 74 61 74   range symbolStat
7f10	65 73 20 7b 0a 09 09 69  66 20 73 74 61 74 65 2e   es {...if state.
7f20	50 6f 73 69 74 69 6f 6e  20 3e 20 30 20 7b 0a 09   Position > 0 {..
7f30	09 09 63 75 72 72 65 6e  74 50 72 69 63 65 20 3a   ..currentPrice :
7f40	3d 20 73 74 61 74 65 2e  44 61 74 61 5b 6c 65 6e   = state.Data[len
7f50	28 73 74 61 74 65 2e 44  61 74 61 29 2d 31 5d 2e   (state.Data)-1].
7f60	50 72 69 63 65 0a 09 09  09 70 6f 73 69 74 69 6f   Price....positio
7f70	6e 56 61 6c 75 65 20 3a  3d 20 73 74 61 74 65 2e   nValue := state.
7f80	50 6f 73 69 74 69 6f 6e  20 2a 20 63 75 72 72 65   Position * curre
7f90	6e 74 50 72 69 63 65 0a  09 09 09 63 75 72 72 65   ntPrice....curre
7fa0	6e 74 57 65 69 67 68 74  73 5b 73 79 6d 62 6f 6c   ntWeights[symbol
7fb0	5d 20 3d 20 70 6f 73 69  74 69 6f 6e 56 61 6c 75   ] = positionValu
7fc0	65 0a 09 09 09 74 6f 74  61 6c 50 6f 72 74 66 6f   e....totalPortfo
7fd0	6c 69 6f 56 61 6c 75 65  20 2b 3d 20 70 6f 73 69   lioValue += posi
7fe0	74 69 6f 6e 56 61 6c 75  65 0a 09 09 7d 0a 09 7d   tionValue...}..}
7ff0	0a 0a 09 2f 2f 20 e6 b7  bb e5 8a a0 e7 8e b0 e9   ...// ..........
8000	87 91 e5 88 b0 e6 80 bb  e4 bb b7 e5 80 bc 0a 09   ................
8010	74 6f 74 61 6c 50 6f 72  74 66 6f 6c 69 6f 56 61   totalPortfolioVa
8020	6c 75 65 20 2b 3d 20 61  76 61 69 6c 61 62 6c 65   lue += available
8030	43 61 73 68 0a 0a 09 2f  2f 20 e5 b0 86 e5 bd 93   Cash...// ......
8040	e5 89 8d e6 9d 83 e9 87  8d e5 bd 92 e4 b8 80 e5   ................
8050	8c 96 0a 09 66 6f 72 20  73 79 6d 62 6f 6c 20 3a   ....for symbol :
8060	3d 20 72 61 6e 67 65 20  63 75 72 72 65 6e 74 57   = range currentW
8070	65 69 67 68 74 73 20 7b  0a 09 09 63 75 72 72 65   eights {...curre
8080	6e 74 57 65 69 67 68 74  73 5b 73 79 6d 62 6f 6c   ntWeights[symbol
8090	5d 20 2f 3d 20 74 6f 74  61 6c 50 6f 72 74 66 6f   ] /= totalPortfo
80a0	6c 69 6f 56 61 6c 75 65  0a 09 7d 0a 0a 09 2f 2f   lioValue..}...//
80b0	20 e4 bc b0 e7 ae 97 e6  96 b0 e4 bb 93 e4 bd 8d    ...............
80c0	e5 af b9 e6 8a 95 e8 b5  84 e7 bb 84 e5 90 88 e7   ................
80d0	9a 84 e5 bd b1 e5 93 8d  0a 09 6e 65 77 50 6f 73   ..........newPos
80e0	69 74 69 6f 6e 56 61 6c  75 65 20 3a 3d 20 62 61   itionValue := ba
80f0	73 65 50 6f 73 69 74 69  6f 6e 53 69 7a 65 20 2a   sePositionSize *
8100	20 6f 70 70 6f 72 74 75  6e 69 74 79 2e 50 72 69    opportunity.Pri
8110	63 65 0a 09 74 61 72 67  65 74 57 65 69 67 68 74   ce..targetWeight
8120	20 3a 3d 20 6e 65 77 50  6f 73 69 74 69 6f 6e 56    := newPositionV
8130	61 6c 75 65 20 2f 20 28  74 6f 74 61 6c 50 6f 72   alue / (totalPor
8140	74 66 6f 6c 69 6f 56 61  6c 75 65 20 2b 20 6e 65   tfolioValue + ne
8150	77 50 6f 73 69 74 69 6f  6e 56 61 6c 75 65 29 0a   wPositionValue).
8160	0a 09 2f 2f 20 e6 a3 80  e6 9f a5 e6 98 af e5 90   ..// ...........
8170	a6 e8 b6 85 e8 bf 87 e6  9c 80 e5 a4 a7 e5 8d 95   ................
8180	e4 b8 aa e8 b5 84 e4 ba  a7 e6 9d 83 e9 87 8d e9   ................
8190	99 90 e5 88 b6 ef bc 88  e4 bc 98 e5 8c 96 e7 89   ................
81a0	88 ef bc 89 0a 09 6d 61  72 6b 65 74 52 65 67 69   ......marketRegi
81b0	6d 65 20 3a 3d 20 62 65  2e 67 65 74 43 75 72 72   me := be.getCurr
81c0	65 6e 74 4d 61 72 6b 65  74 52 65 67 69 6d 65 28   entMarketRegime(
81d0	29 0a 09 6d 61 78 53 69  6e 67 6c 65 41 73 73 65   )..maxSingleAsse
81e0	74 57 65 69 67 68 74 20  3a 3d 20 30 2e 32 35 20   tWeight := 0.25 
81f0	2f 2f 20 e9 bb 98 e8 ae  a4 e6 9c 80 e5 a4 a7 32   // ............2
8200	35 25 e5 8d 95 e4 b8 aa  e8 b5 84 e4 ba a7 e6 9d   5%..............
8210	83 e9 87 8d 0a 0a 09 2f  2f 20 e6 a0 b9 e6 8d ae   .......// ......
8220	e5 b8 82 e5 9c ba e7 8e  af e5 a2 83 e8 b0 83 e6   ................
8230	95 b4 e6 9d 83 e9 87 8d  e9 99 90 e5 88 b6 0a 09   ................
8240	73 77 69 74 63 68 20 6d  61 72 6b 65 74 52 65 67   switch marketReg
8250	69 6d 65 20 7b 0a 09 63  61 73 65 20 22 73 74 72   ime {..case "str
8260	6f 6e 67 5f 62 75 6c 6c  22 3a 0a 09 09 6d 61 78   ong_bull":...max
8270	53 69 6e 67 6c 65 41 73  73 65 74 57 65 69 67 68   SingleAssetWeigh
8280	74 20 3d 20 30 2e 33 35  20 2f 2f 20 e5 bc ba e7   t = 0.35 // ....
8290	89 9b e5 b8 82 ef bc 9a  e5 85 81 e8 ae b8 e6 9b   ................
82a0	b4 e9 ab 98 e6 9d 83 e9  87 8d 0a 09 63 61 73 65   ............case
82b0	20 22 77 65 61 6b 5f 62  75 6c 6c 22 3a 0a 09 09    "weak_bull":...
82c0	6d 61 78 53 69 6e 67 6c  65 41 73 73 65 74 57 65   maxSingleAssetWe
82d0	69 67 68 74 20 3d 20 30  2e 33 20 2f 2f 20 e5 bc   ight = 0.3 // ..
82e0	b1 e7 89 9b e5 b8 82 ef  bc 9a e8 be 83 e9 ab 98   ................
82f0	e6 9d 83 e9 87 8d 0a 09  63 61 73 65 20 22 73 74   ........case "st
8300	72 6f 6e 67 5f 62 65 61  72 22 3a 0a 09 09 6d 61   rong_bear":...ma
8310	78 53 69 6e 67 6c 65 41  73 73 65 74 57 65 69 67   xSingleAssetWeig
8320	68 74 20 3d 20 30 2e 31  35 20 2f 2f 20 e5 bc ba   ht = 0.15 // ...
8330	e7 86 8a e5 b8 82 ef bc  9a e9 99 8d e4 bd 8e e6   ................
8340	9d 83 e9 87 8d e9 99 90  e5 88 b6 0a 09 63 61 73   .............cas
8350	65 20 22 77 65 61 6b 5f  62 65 61 72 22 3a 0a 09   e "weak_bear":..
8360	09 6d 61 78 53 69 6e 67  6c 65 41 73 73 65 74 57   .maxSingleAssetW
8370	65 69 67 68 74 20 3d 20  30 2e 32 20 2f 2f 20 e5   eight = 0.2 // .
8380	bc b1 e7 86 8a e5 b8 82  ef bc 9a e9 80 82 e4 b8   ................
8390	ad e6 9d 83 e9 87 8d 0a  09 63 61 73 65 20 22 73   .........case "s
83a0	69 64 65 77 61 79 73 22  3a 0a 09 09 6d 61 78 53   ideways":...maxS
83b0	69 6e 67 6c 65 41 73 73  65 74 57 65 69 67 68 74   ingleAssetWeight
83c0	20 3d 20 30 2e 32 35 20  2f 2f 20 e6 a8 aa e7 9b    = 0.25 // .....
83d0	98 ef bc 9a e6 a0 87 e5  87 86 e6 9d 83 e9 87 8d   ................
83e0	0a 09 64 65 66 61 75 6c  74 3a 0a 09 09 6d 61 78   ..default:...max
83f0	53 69 6e 67 6c 65 41 73  73 65 74 57 65 69 67 68   SingleAssetWeigh
8400	74 20 3d 20 30 2e 32 35  20 2f 2f 20 e9 bb 98 e8   t = 0.25 // ....
8410	ae a4 e6 9d 83 e9 87 8d  0a 09 7d 0a 09 69 66 20   ..........}..if 
8420	74 61 72 67 65 74 57 65  69 67 68 74 20 3e 20 6d   targetWeight > m
8430	61 78 53 69 6e 67 6c 65  41 73 73 65 74 57 65 69   axSingleAssetWei
8440	67 68 74 20 7b 0a 09 09  2f 2f 20 e8 b0 83 e6 95   ght {...// .....
8450	b4 e4 bb 93 e4 bd 8d e5  a4 a7 e5 b0 8f e4 bb a5   ................
8460	e7 ac a6 e5 90 88 e6 9d  83 e9 87 8d e9 99 90 e5   ................
8470	88 b6 0a 09 09 6d 61 78  41 6c 6c 6f 77 65 64 56   .....maxAllowedV
8480	61 6c 75 65 20 3a 3d 20  74 6f 74 61 6c 50 6f 72   alue := totalPor
8490	74 66 6f 6c 69 6f 56 61  6c 75 65 20 2a 20 6d 61   tfolioValue * ma
84a0	78 53 69 6e 67 6c 65 41  73 73 65 74 57 65 69 67   xSingleAssetWeig
84b0	68 74 20 2f 20 28 31 20  2d 20 6d 61 78 53 69 6e   ht / (1 - maxSin
84c0	67 6c 65 41 73 73 65 74  57 65 69 67 68 74 29 0a   gleAssetWeight).
84d0	09 09 61 64 6a 75 73 74  65 64 53 69 7a 65 20 3a   ..adjustedSize :
84e0	3d 20 6d 61 78 41 6c 6c  6f 77 65 64 56 61 6c 75   = maxAllowedValu
84f0	65 20 2f 20 6f 70 70 6f  72 74 75 6e 69 74 79 2e   e / opportunity.
8500	50 72 69 63 65 0a 0a 09  09 6c 6f 67 2e 50 72 69   Price....log.Pri
8510	6e 74 66 28 22 5b 50 4f  52 54 46 4f 4c 49 4f 5f   ntf("[PORTFOLIO_
8520	43 4f 4e 53 54 52 41 49  4e 54 5d 20 25 73 e6 9d   CONSTRAINT] %s..
8530	83 e9 87 8d e9 99 90 e5  88 b6 3a 20 e7 9b ae e6   ..........: ....
8540	a0 87 e6 9d 83 e9 87 8d  25 2e 33 66 20 3e 20 e6   ........%.3f > .
8550	9c 80 e5 a4 a7 25 2e 33  66 2c 20 e8 b0 83 e6 95   .....%.3f, .....
8560	b4 e4 bb 93 e4 bd 8d 25  2e 34 66 20 2d 3e 20 25   .......%.4f -> %
8570	2e 34 66 22 2c 0a 09 09  09 6f 70 70 6f 72 74 75   .4f",....opportu
8580	6e 69 74 79 2e 53 79 6d  62 6f 6c 2c 20 74 61 72   nity.Symbol, tar
8590	67 65 74 57 65 69 67 68  74 2c 20 6d 61 78 53 69   getWeight, maxSi
85a0	6e 67 6c 65 41 73 73 65  74 57 65 69 67 68 74 2c   ngleAssetWeight,
85b0	20 62 61 73 65 50 6f 73  69 74 69 6f 6e 53 69 7a    basePositionSiz
85c0	65 2c 20 61 64 6a 75 73  74 65 64 53 69 7a 65 29   e, adjustedSize)
85d0	0a 0a 09 09 72 65 74 75  72 6e 20 61 64 6a 75 73   ....return adjus
85e0	74 65 64 53 69 7a 65 0a  09 7d 0a 0a 09 2f 2f 20   tedSize..}...// 
85f0	e6 a3 80 e6 9f a5 e6 8a  95 e8 b5 84 e7 bb 84 e5   ................
8600	90 88 e5 a4 9a e6 a0 b7  e6 80 a7 0a 09 64 69 76   .............div
8610	65 72 73 69 74 79 53 63  6f 72 65 20 3a 3d 20 62   ersityScore := b
8620	65 2e 63 61 6c 63 75 6c  61 74 65 50 6f 72 74 66   e.calculatePortf
8630	6f 6c 69 6f 44 69 76 65  72 73 69 74 79 28 63 75   olioDiversity(cu
8640	72 72 65 6e 74 57 65 69  67 68 74 73 29 0a 09 6d   rrentWeights)..m
8650	69 6e 44 69 76 65 72 73  69 74 79 54 68 72 65 73   inDiversityThres
8660	68 6f 6c 64 20 3a 3d 20  30 2e 36 0a 0a 09 69 66   hold := 0.6...if
8670	20 64 69 76 65 72 73 69  74 79 53 63 6f 72 65 20    diversityScore 
8680	3c 20 6d 69 6e 44 69 76  65 72 73 69 74 79 54 68   < minDiversityTh
8690	72 65 73 68 6f 6c 64 20  26 26 20 6c 65 6e 28 63   reshold && len(c
86a0	75 72 72 65 6e 74 57 65  69 67 68 74 73 29 20 3e   urrentWeights) >
86b0	3d 20 33 20 7b 0a 09 09  2f 2f 20 e5 a6 82 e6 9e   = 3 {...// .....
86c0	9c e5 a4 9a e6 a0 b7 e6  80 a7 e4 b8 8d e8 b6 b3   ................
86d0	ef bc 8c e5 87 8f e5 b0  91 e6 96 b0 e4 bb 93 e4   ................
86e0	bd 8d 0a 09 09 64 69 76  65 72 73 69 74 79 4d 75   .....diversityMu
86f0	6c 74 69 70 6c 69 65 72  20 3a 3d 20 64 69 76 65   ltiplier := dive
8700	72 73 69 74 79 53 63 6f  72 65 20 2f 20 6d 69 6e   rsityScore / min
8710	44 69 76 65 72 73 69 74  79 54 68 72 65 73 68 6f   DiversityThresho
8720	6c 64 0a 09 09 61 64 6a  75 73 74 65 64 53 69 7a   ld...adjustedSiz
8730	65 20 3a 3d 20 62 61 73  65 50 6f 73 69 74 69 6f   e := basePositio
8740	6e 53 69 7a 65 20 2a 20  64 69 76 65 72 73 69 74   nSize * diversit
8750	79 4d 75 6c 74 69 70 6c  69 65 72 0a 0a 09 09 6c   yMultiplier....l
8760	6f 67 2e 50 72 69 6e 74  66 28 22 5b 50 4f 52 54   og.Printf("[PORT
8770	46 4f 4c 49 4f 5f 44 49  56 45 52 53 49 54 59 5d   FOLIO_DIVERSITY]
8780	20 25 73 e5 a4 9a e6 a0  b7 e6 80 a7 e8 b0 83 e6    %s.............
8790	95 b4 3a 20 e5 88 86 e6  95 b0 25 2e 33 66 20 3c   ..: ......%.3f <
87a0	20 e9 98 88 e5 80 bc 25  2e 33 66 2c 20 e4 bb 93    ......%.3f, ...
87b0	e4 bd 8d e8 b0 83 e6 95  b4 25 2e 34 66 20 2d 3e   .........%.4f ->
87c0	20 25 2e 34 66 22 2c 0a  09 09 09 6f 70 70 6f 72    %.4f",....oppor
87d0	74 75 6e 69 74 79 2e 53  79 6d 62 6f 6c 2c 20 64   tunity.Symbol, d
87e0	69 76 65 72 73 69 74 79  53 63 6f 72 65 2c 20 6d   iversityScore, m
87f0	69 6e 44 69 76 65 72 73  69 74 79 54 68 72 65 73   inDiversityThres
8800	68 6f 6c 64 2c 20 62 61  73 65 50 6f 73 69 74 69   hold, basePositi
8810	6f 6e 53 69 7a 65 2c 20  61 64 6a 75 73 74 65 64   onSize, adjusted
8820	53 69 7a 65 29 0a 0a 09  09 72 65 74 75 72 6e 20   Size)....return 
8830	61 64 6a 75 73 74 65 64  53 69 7a 65 0a 09 7d 0a   adjustedSize..}.
8840	0a 09 72 65 74 75 72 6e  20 62 61 73 65 50 6f 73   ..return basePos
8850	69 74 69 6f 6e 53 69 7a  65 0a 7d 0a 0a 2f 2f 20   itionSize.}..// 
8860	63 61 6c 63 75 6c 61 74  65 50 6f 72 74 66 6f 6c   calculatePortfol
8870	69 6f 44 69 76 65 72 73  69 74 79 20 e8 ae a1 e7   ioDiversity ....
8880	ae 97 e6 8a 95 e8 b5 84  e7 bb 84 e5 90 88 e5 a4   ................
8890	9a e6 a0 b7 e6 80 a7 0a  66 75 6e 63 20 28 62 65   ........func (be
88a0	20 2a 42 61 63 6b 74 65  73 74 45 6e 67 69 6e 65    *BacktestEngine
88b0	29 20 63 61 6c 63 75 6c  61 74 65 50 6f 72 74 66   ) calculatePortf
88c0	6f 6c 69 6f 44 69 76 65  72 73 69 74 79 28 77 65   olioDiversity(we
88d0	69 67 68 74 73 20 6d 61  70 5b 73 74 72 69 6e 67   ights map[string
88e0	5d 66 6c 6f 61 74 36 34  29 20 66 6c 6f 61 74 36   ]float64) float6
88f0	34 20 7b 0a 09 69 66 20  6c 65 6e 28 77 65 69 67   4 {..if len(weig
8900	68 74 73 29 20 3c 3d 20  31 20 7b 0a 09 09 72 65   hts) <= 1 {...re
8910	74 75 72 6e 20 30 2e 30  0a 09 7d 0a 0a 09 2f 2f   turn 0.0..}...//
8920	20 e8 ae a1 e7 ae 97 e6  9d 83 e9 87 8d e7 86 b5    ...............
8930	ef bc 88 e5 a4 9a e6 a0  b7 e6 80 a7 e5 ba a6 e9   ................
8940	87 8f ef bc 89 0a 09 65  6e 74 72 6f 70 79 20 3a   .......entropy :
8950	3d 20 30 2e 30 0a 09 66  6f 72 20 5f 2c 20 77 65   = 0.0..for _, we
8960	69 67 68 74 20 3a 3d 20  72 61 6e 67 65 20 77 65   ight := range we
8970	69 67 68 74 73 20 7b 0a  09 09 69 66 20 77 65 69   ights {...if wei
8980	67 68 74 20 3e 20 30 20  7b 0a 09 09 09 65 6e 74   ght > 0 {....ent
8990	72 6f 70 79 20 2d 3d 20  77 65 69 67 68 74 20 2a   ropy -= weight *
89a0	20 6d 61 74 68 2e 4c 6f  67 32 28 77 65 69 67 68    math.Log2(weigh
89b0	74 29 0a 09 09 7d 0a 09  7d 0a 0a 09 2f 2f 20 e5   t)...}..}...// .
89c0	bd 92 e4 b8 80 e5 8c 96  e7 86 b5 e5 80 bc ef bc   ................
89d0	88 30 2d 31 e8 8c 83 e5  9b b4 ef bc 89 0a 09 6d   .0-1...........m
89e0	61 78 45 6e 74 72 6f 70  79 20 3a 3d 20 6d 61 74   axEntropy := mat
89f0	68 2e 4c 6f 67 32 28 66  6c 6f 61 74 36 34 28 6c   h.Log2(float64(l
8a00	65 6e 28 77 65 69 67 68  74 73 29 29 29 0a 09 69   en(weights)))..i
8a10	66 20 6d 61 78 45 6e 74  72 6f 70 79 20 3e 20 30   f maxEntropy > 0
8a20	20 7b 0a 09 09 72 65 74  75 72 6e 20 65 6e 74 72    {...return entr
8a30	6f 70 79 20 2f 20 6d 61  78 45 6e 74 72 6f 70 79   opy / maxEntropy
8a40	0a 09 7d 0a 0a 09 72 65  74 75 72 6e 20 30 2e 30   ..}...return 0.0
8a50	0a 7d 0a 0a 2f 2f 20 61  70 70 6c 79 52 69 73 6b   .}..// applyRisk
8a60	4d 61 6e 61 67 65 6d 65  6e 74 43 6f 6e 73 74 72   ManagementConstr
8a70	61 69 6e 74 73 20 e5 ba  94 e7 94 a8 e9 a3 8e e9   aints ..........
8a80	99 a9 e7 ae a1 e7 90 86  e7 ba a6 e6 9d 9f 0a 66   ...............f
8a90	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
8aa0	74 45 6e 67 69 6e 65 29  20 61 70 70 6c 79 52 69   tEngine) applyRi
8ab0	73 6b 4d 61 6e 61 67 65  6d 65 6e 74 43 6f 6e 73   skManagementCons
8ac0	74 72 61 69 6e 74 73 28  6f 70 70 6f 72 74 75 6e   traints(opportun
8ad0	69 74 79 20 2a 54 72 61  64 65 4f 70 70 6f 72 74   ity *TradeOpport
8ae0	75 6e 69 74 79 2c 20 73  79 6d 62 6f 6c 53 74 61   unity, symbolSta
8af0	74 65 73 20 6d 61 70 5b  73 74 72 69 6e 67 5d 2a   tes map[string]*
8b00	53 79 6d 62 6f 6c 53 74  61 74 65 2c 20 70 6f 73   SymbolState, pos
8b10	69 74 69 6f 6e 53 69 7a  65 20 66 6c 6f 61 74 36   itionSize float6
8b20	34 2c 20 61 76 61 69 6c  61 62 6c 65 43 61 73 68   4, availableCash
8b30	20 66 6c 6f 61 74 36 34  29 20 66 6c 6f 61 74 36    float64) float6
8b40	34 20 7b 0a 09 70 6f 73  69 74 69 6f 6e 56 61 6c   4 {..positionVal
8b50	75 65 20 3a 3d 20 70 6f  73 69 74 69 6f 6e 53 69   ue := positionSi
8b60	7a 65 20 2a 20 6f 70 70  6f 72 74 75 6e 69 74 79   ze * opportunity
8b70	2e 50 72 69 63 65 0a 0a  09 2f 2f 20 31 2e 20 e6   .Price...// 1. .
8b80	9c 80 e5 a4 a7 e5 8d 95  e6 ac a1 e4 ba a4 e6 98   ................
8b90	93 e9 87 91 e9 a2 9d e9  99 90 e5 88 b6 0a 09 2f   .............../
8ba0	2f 20 e5 8d 95 e6 ac a1  e4 ba a4 e6 98 93 e9 87   / ..............
8bb0	91 e9 a2 9d e9 99 90 e5  88 b6 ef bc 88 e4 bc 98   ................
8bc0	e5 8c 96 e7 89 88 ef bc  89 0a 09 6d 61 72 6b 65   ...........marke
8bd0	74 52 65 67 69 6d 65 20  3a 3d 20 62 65 2e 67 65   tRegime := be.ge
8be0	74 43 75 72 72 65 6e 74  4d 61 72 6b 65 74 52 65   tCurrentMarketRe
8bf0	67 69 6d 65 28 29 0a 09  6d 61 78 54 72 61 64 65   gime()..maxTrade
8c00	52 61 74 69 6f 20 3a 3d  20 30 2e 32 35 20 2f 2f   Ratio := 0.25 //
8c10	20 e9 bb 98 e8 ae a4 e6  9c 80 e5 a4 a7 32 35 25    ............25%
8c20	e5 8f af e7 94 a8 e8 b5  84 e9 87 91 e5 8d 95 e6   ................
8c30	ac a1 e4 ba a4 e6 98 93  0a 0a 09 2f 2f 20 e6 a0   ...........// ..
8c40	b9 e6 8d ae e5 b8 82 e5  9c ba e7 8e af e5 a2 83   ................
8c50	e8 b0 83 e6 95 b4 e4 ba  a4 e6 98 93 e9 87 91 e9   ................
8c60	a2 9d e9 99 90 e5 88 b6  0a 09 73 77 69 74 63 68   ..........switch
8c70	20 6d 61 72 6b 65 74 52  65 67 69 6d 65 20 7b 0a    marketRegime {.
8c80	09 63 61 73 65 20 22 73  74 72 6f 6e 67 5f 62 75   .case "strong_bu
8c90	6c 6c 22 3a 0a 09 09 6d  61 78 54 72 61 64 65 52   ll":...maxTradeR
8ca0	61 74 69 6f 20 3d 20 30  2e 33 35 20 2f 2f 20 e5   atio = 0.35 // .
8cb0	bc ba e7 89 9b e5 b8 82  ef bc 9a e5 85 81 e8 ae   ................
8cc0	b8 e6 9b b4 e5 a4 a7 e4  ba a4 e6 98 93 0a 09 63   ...............c
8cd0	61 73 65 20 22 77 65 61  6b 5f 62 75 6c 6c 22 3a   ase "weak_bull":
8ce0	0a 09 09 6d 61 78 54 72  61 64 65 52 61 74 69 6f   ...maxTradeRatio
8cf0	20 3d 20 30 2e 33 20 2f  2f 20 e5 bc b1 e7 89 9b    = 0.3 // ......
8d00	e5 b8 82 ef bc 9a e8 be  83 e5 a4 a7 e4 ba a4 e6   ................
8d10	98 93 0a 09 63 61 73 65  20 22 73 74 72 6f 6e 67   ....case "strong
8d20	5f 62 65 61 72 22 3a 0a  09 09 6d 61 78 54 72 61   _bear":...maxTra
8d30	64 65 52 61 74 69 6f 20  3d 20 30 2e 31 35 20 2f   deRatio = 0.15 /
8d40	2f 20 e5 bc ba e7 86 8a  e5 b8 82 ef bc 9a e9 99   / ..............
8d50	90 e5 88 b6 e4 ba a4 e6  98 93 e9 87 91 e9 a2 9d   ................
8d60	0a 09 63 61 73 65 20 22  77 65 61 6b 5f 62 65 61   ..case "weak_bea
8d70	72 22 3a 0a 09 09 6d 61  78 54 72 61 64 65 52 61   r":...maxTradeRa
8d80	74 69 6f 20 3d 20 30 2e  32 20 2f 2f 20 e5 bc b1   tio = 0.2 // ...
8d90	e7 86 8a e5 b8 82 ef bc  9a e9 80 82 e4 b8 ad e4   ................
8da0	ba a4 e6 98 93 0a 09 63  61 73 65 20 22 73 69 64   .......case "sid
8db0	65 77 61 79 73 22 3a 0a  09 09 6d 61 78 54 72 61   eways":...maxTra
8dc0	64 65 52 61 74 69 6f 20  3d 20 30 2e 32 35 20 2f   deRatio = 0.25 /
8dd0	2f 20 e6 a8 aa e7 9b 98  ef bc 9a e6 a0 87 e5 87   / ..............
8de0	86 e4 ba a4 e6 98 93 0a  09 64 65 66 61 75 6c 74   .........default
8df0	3a 0a 09 09 6d 61 78 54  72 61 64 65 52 61 74 69   :...maxTradeRati
8e00	6f 20 3d 20 30 2e 32 35  20 2f 2f 20 e9 bb 98 e8   o = 0.25 // ....
8e10	ae a4 e4 ba a4 e6 98 93  e6 af 94 e4 be 8b 0a 09   ................
8e20	7d 0a 0a 09 6d 61 78 53  69 6e 67 6c 65 54 72 61   }...maxSingleTra
8e30	64 65 56 61 6c 75 65 20  3a 3d 20 61 76 61 69 6c   deValue := avail
8e40	61 62 6c 65 43 61 73 68  20 2a 20 6d 61 78 54 72   ableCash * maxTr
8e50	61 64 65 52 61 74 69 6f  0a 09 69 66 20 70 6f 73   adeRatio..if pos
8e60	69 74 69 6f 6e 56 61 6c  75 65 20 3e 20 6d 61 78   itionValue > max
8e70	53 69 6e 67 6c 65 54 72  61 64 65 56 61 6c 75 65   SingleTradeValue
8e80	20 7b 0a 09 09 61 64 6a  75 73 74 65 64 53 69 7a    {...adjustedSiz
8e90	65 20 3a 3d 20 28 6d 61  78 53 69 6e 67 6c 65 54   e := (maxSingleT
8ea0	72 61 64 65 56 61 6c 75  65 29 20 2f 20 6f 70 70   radeValue) / opp
8eb0	6f 72 74 75 6e 69 74 79  2e 50 72 69 63 65 0a 09   ortunity.Price..
8ec0	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 52 49   .log.Printf("[RI
8ed0	53 4b 5f 43 4f 4e 53 54  52 41 49 4e 54 5d 20 25   SK_CONSTRAINT] %
8ee0	73 e5 8d 95 e6 ac a1 e4  ba a4 e6 98 93 e9 99 90   s...............
8ef0	e5 88 b6 3a 20 25 2e 32  66 20 3e 20 25 2e 32 66   ...: %.2f > %.2f
8f00	2c 20 e8 b0 83 e6 95 b4  e4 bb 93 e4 bd 8d 25 2e   , ............%.
8f10	34 66 20 2d 3e 20 25 2e  34 66 22 2c 0a 09 09 09   4f -> %.4f",....
8f20	6f 70 70 6f 72 74 75 6e  69 74 79 2e 53 79 6d 62   opportunity.Symb
8f30	6f 6c 2c 20 70 6f 73 69  74 69 6f 6e 56 61 6c 75   ol, positionValu
8f40	65 2c 20 6d 61 78 53 69  6e 67 6c 65 54 72 61 64   e, maxSingleTrad
8f50	65 56 61 6c 75 65 2c 20  70 6f 73 69 74 69 6f 6e   eValue, position
8f60	53 69 7a 65 2c 20 61 64  6a 75 73 74 65 64 53 69   Size, adjustedSi
8f70	7a 65 29 0a 09 09 70 6f  73 69 74 69 6f 6e 53 69   ze)...positionSi
8f80	7a 65 20 3d 20 61 64 6a  75 73 74 65 64 53 69 7a   ze = adjustedSiz
8f90	65 0a 09 09 70 6f 73 69  74 69 6f 6e 56 61 6c 75   e...positionValu
8fa0	65 20 3d 20 70 6f 73 69  74 69 6f 6e 53 69 7a 65   e = positionSize
8fb0	20 2a 20 6f 70 70 6f 72  74 75 6e 69 74 79 2e 50    * opportunity.P
8fc0	72 69 63 65 0a 09 7d 0a  0a 09 2f 2f 20 32 2e 20   rice..}...// 2. 
8fd0	e6 b3 a2 e5 8a a8 e7 8e  87 e8 b0 83 e6 95 b4 0a   ................
8fe0	09 76 6f 6c 61 74 69 6c  69 74 79 20 3a 3d 20 62   .volatility := b
8ff0	65 2e 63 61 6c 63 75 6c  61 74 65 52 65 63 65 6e   e.calculateRecen
9000	74 56 6f 6c 61 74 69 6c  69 74 79 28 6f 70 70 6f   tVolatility(oppo
9010	72 74 75 6e 69 74 79 2e  53 74 61 74 65 2e 44 61   rtunity.State.Da
9020	74 61 2c 20 6c 65 6e 28  6f 70 70 6f 72 74 75 6e   ta, len(opportun
9030	69 74 79 2e 53 74 61 74  65 2e 44 61 74 61 29 2d   ity.State.Data)-
9040	31 29 0a 0a 09 2f 2f 20  e9 ab 98 e6 b3 a2 e5 8a   1)...// ........
9050	a8 e6 97 b6 e5 87 8f e5  b0 91 e4 bb 93 e4 bd 8d   ................
9060	0a 09 69 66 20 76 6f 6c  61 74 69 6c 69 74 79 20   ..if volatility 
9070	3e 20 30 2e 30 38 20 7b  0a 09 09 76 6f 6c 61 74   > 0.08 {...volat
9080	69 6c 69 74 79 4d 75 6c  74 69 70 6c 69 65 72 20   ilityMultiplier 
9090	3a 3d 20 30 2e 36 20 2f  2f 20 e9 ab 98 e6 b3 a2   := 0.6 // ......
90a0	e5 8a a8 e5 87 8f e5 b0  91 e5 88 b0 36 30 25 0a   ............60%.
90b0	09 09 70 6f 73 69 74 69  6f 6e 53 69 7a 65 20 2a   ..positionSize *
90c0	3d 20 76 6f 6c 61 74 69  6c 69 74 79 4d 75 6c 74   = volatilityMult
90d0	69 70 6c 69 65 72 0a 09  09 6c 6f 67 2e 50 72 69   iplier...log.Pri
90e0	6e 74 66 28 22 5b 56 4f  4c 41 54 49 4c 49 54 59   ntf("[VOLATILITY
90f0	5f 41 44 4a 55 53 54 4d  45 4e 54 5d 20 25 73 e9   _ADJUSTMENT] %s.
9100	ab 98 e6 b3 a2 e5 8a a8  e8 b0 83 e6 95 b4 3a 20   ..............: 
9110	e6 b3 a2 e5 8a a8 e7 8e  87 25 2e 33 66 2c 20 e4   .........%.3f, .
9120	bb 93 e4 bd 8d e4 b9 98  e6 95 b0 25 2e 32 66 22   ...........%.2f"
9130	2c 0a 09 09 09 6f 70 70  6f 72 74 75 6e 69 74 79   ,....opportunity
9140	2e 53 79 6d 62 6f 6c 2c  20 76 6f 6c 61 74 69 6c   .Symbol, volatil
9150	69 74 79 2c 20 76 6f 6c  61 74 69 6c 69 74 79 4d   ity, volatilityM
9160	75 6c 74 69 70 6c 69 65  72 29 0a 09 7d 20 65 6c   ultiplier)..} el
9170	73 65 20 69 66 20 76 6f  6c 61 74 69 6c 69 74 79   se if volatility
9180	20 3e 20 30 2e 30 35 20  7b 0a 09 09 76 6f 6c 61    > 0.05 {...vola
9190	74 69 6c 69 74 79 4d 75  6c 74 69 70 6c 69 65 72   tilityMultiplier
91a0	20 3a 3d 20 30 2e 38 20  2f 2f 20 e4 b8 ad e9 ab    := 0.8 // .....
91b0	98 e6 b3 a2 e5 8a a8 e5  87 8f e5 b0 91 e5 88 b0   ................
91c0	38 30 25 0a 09 09 70 6f  73 69 74 69 6f 6e 53 69   80%...positionSi
91d0	7a 65 20 2a 3d 20 76 6f  6c 61 74 69 6c 69 74 79   ze *= volatility
91e0	4d 75 6c 74 69 70 6c 69  65 72 0a 09 7d 0a 0a 09   Multiplier..}...
91f0	2f 2f 20 33 2e 20 e6 9c  ba e4 bc 9a e8 b4 a8 e9   // 3. ..........
9200	87 8f e8 b0 83 e6 95 b4  0a 09 63 6f 6e 66 69 64   ..........confid
9210	65 6e 63 65 4d 75 6c 74  69 70 6c 69 65 72 20 3a   enceMultiplier :
9220	3d 20 30 2e 35 20 2b 20  6f 70 70 6f 72 74 75 6e   = 0.5 + opportun
9230	69 74 79 2e 43 6f 6e 66  69 64 65 6e 63 65 2a 30   ity.Confidence*0
9240	2e 35 20 2f 2f 20 e7 bd  ae e4 bf a1 e5 ba a6 30   .5 // .........0
9250	2e 35 2d 31 2e 30 e6 98  a0 e5 b0 84 e5 88 b0 e4   .5-1.0..........
9260	b9 98 e6 95 b0 30 2e 35  2d 31 2e 30 0a 09 70 6f   .....0.5-1.0..po
9270	73 69 74 69 6f 6e 53 69  7a 65 20 2a 3d 20 63 6f   sitionSize *= co
9280	6e 66 69 64 65 6e 63 65  4d 75 6c 74 69 70 6c 69   nfidenceMultipli
9290	65 72 0a 0a 09 2f 2f 20  34 2e 20 e6 9c 80 e7 bb   er...// 4. .....
92a0	88 e5 ae 89 e5 85 a8 e6  a3 80 e6 9f a5 0a 09 6d   ...............m
92b0	69 6e 50 6f 73 69 74 69  6f 6e 56 61 6c 75 65 20   inPositionValue 
92c0	3a 3d 20 61 76 61 69 6c  61 62 6c 65 43 61 73 68   := availableCash
92d0	20 2a 20 30 2e 30 30 35  20 2f 2f 20 e6 9c 80 e5    * 0.005 // ....
92e0	b0 8f 30 2e 35 25 e8 b5  84 e9 87 91 e4 ba a4 e6   ..0.5%..........
92f0	98 93 0a 09 2f 2f 20 e6  9c 80 e5 a4 a7 e4 bb 93   ....// .........
9300	e4 bd 8d e9 87 91 e9 a2  9d e9 99 90 e5 88 b6 ef   ................
9310	bc 88 e4 bc 98 e5 8c 96  e7 89 88 ef bc 89 0a 09   ................
9320	6d 61 78 50 6f 73 69 74  69 6f 6e 52 61 74 69 6f   maxPositionRatio
9330	20 3a 3d 20 30 2e 34 20  2f 2f 20 e9 bb 98 e8 ae    := 0.4 // .....
9340	a4 e6 9c 80 e5 a4 a7 34  30 25 e8 b5 84 e9 87 91   .......40%......
9350	e4 ba a4 e6 98 93 0a 0a  09 2f 2f 20 e6 a0 b9 e6   .........// ....
9360	8d ae e5 b8 82 e5 9c ba  e7 8e af e5 a2 83 e8 b0   ................
9370	83 e6 95 b4 e6 9c 80 e5  a4 a7 e4 bb 93 e4 bd 8d   ................
9380	e6 af 94 e4 be 8b 0a 09  73 77 69 74 63 68 20 6d   ........switch m
9390	61 72 6b 65 74 52 65 67  69 6d 65 20 7b 0a 09 63   arketRegime {..c
93a0	61 73 65 20 22 73 74 72  6f 6e 67 5f 62 75 6c 6c   ase "strong_bull
93b0	22 3a 0a 09 09 6d 61 78  50 6f 73 69 74 69 6f 6e   ":...maxPosition
93c0	52 61 74 69 6f 20 3d 20  30 2e 35 20 2f 2f 20 e5   Ratio = 0.5 // .
93d0	bc ba e7 89 9b e5 b8 82  ef bc 9a e5 85 81 e8 ae   ................
93e0	b8 e6 9b b4 e5 a4 a7 e4  bb 93 e4 bd 8d 0a 09 63   ...............c
93f0	61 73 65 20 22 77 65 61  6b 5f 62 75 6c 6c 22 3a   ase "weak_bull":
9400	0a 09 09 6d 61 78 50 6f  73 69 74 69 6f 6e 52 61   ...maxPositionRa
9410	74 69 6f 20 3d 20 30 2e  34 35 20 2f 2f 20 e5 bc   tio = 0.45 // ..
9420	b1 e7 89 9b e5 b8 82 ef  bc 9a e8 be 83 e5 a4 a7   ................
9430	e4 bb 93 e4 bd 8d 0a 09  63 61 73 65 20 22 73 74   ........case "st
9440	72 6f 6e 67 5f 62 65 61  72 22 3a 0a 09 09 6d 61   rong_bear":...ma
9450	78 50 6f 73 69 74 69 6f  6e 52 61 74 69 6f 20 3d   xPositionRatio =
9460	20 30 2e 32 35 20 2f 2f  20 e5 bc ba e7 86 8a e5    0.25 // .......
9470	b8 82 ef bc 9a e9 99 90  e5 88 b6 e4 bb 93 e4 bd   ................
9480	8d 0a 09 63 61 73 65 20  22 77 65 61 6b 5f 62 65   ...case "weak_be
9490	61 72 22 3a 0a 09 09 6d  61 78 50 6f 73 69 74 69   ar":...maxPositi
94a0	6f 6e 52 61 74 69 6f 20  3d 20 30 2e 33 20 2f 2f   onRatio = 0.3 //
94b0	20 e5 bc b1 e7 86 8a e5  b8 82 ef bc 9a e9 80 82    ...............
94c0	e4 b8 ad e4 bb 93 e4 bd  8d 0a 09 63 61 73 65 20   ...........case 
94d0	22 73 69 64 65 77 61 79  73 22 3a 0a 09 09 6d 61   "sideways":...ma
94e0	78 50 6f 73 69 74 69 6f  6e 52 61 74 69 6f 20 3d   xPositionRatio =
94f0	20 30 2e 33 35 20 2f 2f  20 e6 a8 aa e7 9b 98 ef    0.35 // .......
9500	bc 9a e4 b8 ad e7 ad 89  e4 bb 93 e4 bd 8d 0a 09   ................
9510	64 65 66 61 75 6c 74 3a  0a 09 09 6d 61 78 50 6f   default:...maxPo
9520	73 69 74 69 6f 6e 52 61  74 69 6f 20 3d 20 30 2e   sitionRatio = 0.
9530	34 20 2f 2f 20 e9 bb 98  e8 ae a4 e6 af 94 e4 be   4 // ...........
9540	8b 0a 09 7d 0a 0a 09 6d  61 78 50 6f 73 69 74 69   ...}...maxPositi
9550	6f 6e 56 61 6c 75 65 20  3a 3d 20 61 76 61 69 6c   onValue := avail
9560	61 62 6c 65 43 61 73 68  20 2a 20 6d 61 78 50 6f   ableCash * maxPo
9570	73 69 74 69 6f 6e 52 61  74 69 6f 0a 0a 09 66 69   sitionRatio...fi
9580	6e 61 6c 56 61 6c 75 65  20 3a 3d 20 70 6f 73 69   nalValue := posi
9590	74 69 6f 6e 53 69 7a 65  20 2a 20 6f 70 70 6f 72   tionSize * oppor
95a0	74 75 6e 69 74 79 2e 50  72 69 63 65 0a 09 69 66   tunity.Price..if
95b0	20 66 69 6e 61 6c 56 61  6c 75 65 20 3c 20 6d 69    finalValue < mi
95c0	6e 50 6f 73 69 74 69 6f  6e 56 61 6c 75 65 20 7b   nPositionValue {
95d0	0a 09 09 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   ...log.Printf("[
95e0	4d 49 4e 5f 53 49 5a 45  5f 43 4f 4e 53 54 52 41   MIN_SIZE_CONSTRA
95f0	49 4e 54 5d 20 25 73 e6  9c 80 e5 b0 8f e4 ba a4   INT] %s.........
9600	e6 98 93 e9 87 91 e9 a2  9d 3a 20 25 2e 32 66 20   .........: %.2f 
9610	3c 20 25 2e 32 66 2c 20  e8 b7 b3 e8 bf 87 e4 ba   < %.2f, ........
9620	a4 e6 98 93 22 2c 0a 09  09 09 6f 70 70 6f 72 74   ....",....opport
9630	75 6e 69 74 79 2e 53 79  6d 62 6f 6c 2c 20 66 69   unity.Symbol, fi
9640	6e 61 6c 56 61 6c 75 65  2c 20 6d 69 6e 50 6f 73   nalValue, minPos
9650	69 74 69 6f 6e 56 61 6c  75 65 29 0a 09 09 72 65   itionValue)...re
9660	74 75 72 6e 20 30 0a 09  7d 0a 0a 09 69 66 20 66   turn 0..}...if f
9670	69 6e 61 6c 56 61 6c 75  65 20 3e 20 6d 61 78 50   inalValue > maxP
9680	6f 73 69 74 69 6f 6e 56  61 6c 75 65 20 7b 0a 09   ositionValue {..
9690	09 61 64 6a 75 73 74 65  64 53 69 7a 65 20 3a 3d   .adjustedSize :=
96a0	20 6d 61 78 50 6f 73 69  74 69 6f 6e 56 61 6c 75    maxPositionValu
96b0	65 20 2f 20 6f 70 70 6f  72 74 75 6e 69 74 79 2e   e / opportunity.
96c0	50 72 69 63 65 0a 09 09  6c 6f 67 2e 50 72 69 6e   Price...log.Prin
96d0	74 66 28 22 5b 4d 41 58  5f 53 49 5a 45 5f 43 4f   tf("[MAX_SIZE_CO
96e0	4e 53 54 52 41 49 4e 54  5d 20 25 73 e6 9c 80 e5   NSTRAINT] %s....
96f0	a4 a7 e4 ba a4 e6 98 93  e9 87 91 e9 a2 9d 3a 20   ..............: 
9700	25 2e 32 66 20 3e 20 25  2e 32 66 2c 20 e8 b0 83   %.2f > %.2f, ...
9710	e6 95 b4 e5 88 b0 25 2e  34 66 22 2c 0a 09 09 09   ......%.4f",....
9720	6f 70 70 6f 72 74 75 6e  69 74 79 2e 53 79 6d 62   opportunity.Symb
9730	6f 6c 2c 20 66 69 6e 61  6c 56 61 6c 75 65 2c 20   ol, finalValue, 
9740	6d 61 78 50 6f 73 69 74  69 6f 6e 56 61 6c 75 65   maxPositionValue
9750	2c 20 61 64 6a 75 73 74  65 64 53 69 7a 65 29 0a   , adjustedSize).
9760	09 09 70 6f 73 69 74 69  6f 6e 53 69 7a 65 20 3d   ..positionSize =
9770	20 61 64 6a 75 73 74 65  64 53 69 7a 65 0a 09 7d    adjustedSize..}
9780	0a 0a 09 72 65 74 75 72  6e 20 70 6f 73 69 74 69   ...return positi
9790	6f 6e 53 69 7a 65 0a 7d  0a 0a 2f 2f 20 63 61 6c   onSize.}..// cal
97a0	63 75 6c 61 74 65 44 79  6e 61 6d 69 63 50 6f 73   culateDynamicPos
97b0	69 74 69 6f 6e 52 61 74  69 6f 20 e8 ae a1 e7 ae   itionRatio .....
97c0	97 e5 8a a8 e6 80 81 e4  bb 93 e4 bd 8d e6 af 94   ................
97d0	e4 be 8b 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
97e0	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 63 61   cktestEngine) ca
97f0	6c 63 75 6c 61 74 65 44  79 6e 61 6d 69 63 50 6f   lculateDynamicPo
9800	73 69 74 69 6f 6e 52 61  74 69 6f 28 62 61 73 65   sitionRatio(base
9810	52 61 74 69 6f 20 66 6c  6f 61 74 36 34 2c 20 63   Ratio float64, c
9820	6f 6e 66 69 67 20 2a 42  61 63 6b 74 65 73 74 43   onfig *BacktestC
9830	6f 6e 66 69 67 29 20 66  6c 6f 61 74 36 34 20 7b   onfig) float64 {
9840	0a 09 2f 2f 20 e5 9f ba  e7 a1 80 e9 a3 8e e9 99   ..// ...........
9850	a9 e7 ae a1 e7 90 86 e5  9b a0 e5 ad 90 0a 09 72   ...............r
9860	69 73 6b 4d 75 6c 74 69  70 6c 69 65 72 20 3a 3d   iskMultiplier :=
9870	20 31 2e 30 0a 0a 09 2f  2f 20 31 2e 20 4b 65 6c    1.0...// 1. Kel
9880	6c 79 e5 85 ac e5 bc 8f  e8 b0 83 e6 95 b4 ef bc   ly..............
9890	9a e5 9f ba e4 ba 8e e8  83 9c e7 8e 87 e5 92 8c   ................
98a0	e8 b5 94 e7 8e 87 e7 9a  84 e6 9c 80 e4 bc 98 e4   ................
98b0	bb 93 e4 bd 8d 0a 09 6b  65 6c 6c 79 41 64 6a 75   .......kellyAdju
98c0	73 74 6d 65 6e 74 20 3a  3d 20 62 65 2e 63 61 6c   stment := be.cal
98d0	63 75 6c 61 74 65 4b 65  6c 6c 79 41 64 6a 75 73   culateKellyAdjus
98e0	74 6d 65 6e 74 28 29 0a  09 72 69 73 6b 4d 75 6c   tment()..riskMul
98f0	74 69 70 6c 69 65 72 20  2a 3d 20 6b 65 6c 6c 79   tiplier *= kelly
9900	41 64 6a 75 73 74 6d 65  6e 74 0a 0a 09 2f 2f 20   Adjustment...// 
9910	32 2e 20 e6 b3 a2 e5 8a  a8 e7 8e 87 e8 b0 83 e6   2. .............
9920	95 b4 ef bc 9a e9 ab 98  e6 b3 a2 e5 8a a8 e5 87   ................
9930	8f e5 b0 91 e4 bb 93 e4  bd 8d ef bc 8c e4 bd 8e   ................
9940	e6 b3 a2 e5 8a a8 e5 a2  9e e5 8a a0 e4 bb 93 e4   ................
9950	bd 8d 0a 09 76 6f 6c 61  74 69 6c 69 74 79 41 64   ....volatilityAd
9960	6a 75 73 74 6d 65 6e 74  20 3a 3d 20 62 65 2e 63   justment := be.c
9970	61 6c 63 75 6c 61 74 65  56 6f 6c 61 74 69 6c 69   alculateVolatili
9980	74 79 41 64 6a 75 73 74  6d 65 6e 74 28 29 0a 09   tyAdjustment()..
9990	72 69 73 6b 4d 75 6c 74  69 70 6c 69 65 72 20 2a   riskMultiplier *
99a0	3d 20 76 6f 6c 61 74 69  6c 69 74 79 41 64 6a 75   = volatilityAdju
99b0	73 74 6d 65 6e 74 0a 0a  09 2f 2f 20 33 2e 20 e5   stment...// 3. .
99c0	b8 82 e5 9c ba e7 8e af  e5 a2 83 e8 b0 83 e6 95   ................
99d0	b4 ef bc 9a e7 86 8a e5  b8 82 e5 87 8f e5 b0 91   ................
99e0	e4 bb 93 e4 bd 8d ef bc  8c e7 89 9b e5 b8 82 e5   ................
99f0	8f af e9 80 82 e5 bd 93  e5 a2 9e e5 8a a0 0a 09   ................
9a00	6d 61 72 6b 65 74 41 64  6a 75 73 74 6d 65 6e 74   marketAdjustment
9a10	20 3a 3d 20 62 65 2e 63  61 6c 63 75 6c 61 74 65    := be.calculate
9a20	4d 61 72 6b 65 74 45 6e  76 69 72 6f 6e 6d 65 6e   MarketEnvironmen
9a30	74 41 64 6a 75 73 74 6d  65 6e 74 28 29 0a 09 72   tAdjustment()..r
9a40	69 73 6b 4d 75 6c 74 69  70 6c 69 65 72 20 2a 3d   iskMultiplier *=
9a50	20 6d 61 72 6b 65 74 41  64 6a 75 73 74 6d 65 6e    marketAdjustmen
9a60	74 0a 0a 09 2f 2f 20 34  2e 20 e8 bf 91 e6 9c 9f   t...// 4. ......
9a70	e8 a1 a8 e7 8e b0 e8 b0  83 e6 95 b4 ef bc 9a e8   ................
9a80	bf 9e e7 bb ad e4 ba 8f  e6 8d 9f e5 87 8f e5 b0   ................
9a90	91 e4 bb 93 e4 bd 8d ef  bc 8c e8 bf 9e e7 bb ad   ................
9aa0	e7 9b 88 e5 88 a9 e8 b0  a8 e6 85 8e e5 a2 9e e5   ................
9ab0	8a a0 0a 09 70 65 72 66  6f 72 6d 61 6e 63 65 41   ....performanceA
9ac0	64 6a 75 73 74 6d 65 6e  74 20 3a 3d 20 62 65 2e   djustment := be.
9ad0	63 61 6c 63 75 6c 61 74  65 50 65 72 66 6f 72 6d   calculatePerform
9ae0	61 6e 63 65 41 64 6a 75  73 74 6d 65 6e 74 28 29   anceAdjustment()
9af0	0a 09 72 69 73 6b 4d 75  6c 74 69 70 6c 69 65 72   ..riskMultiplier
9b00	20 2a 3d 20 70 65 72 66  6f 72 6d 61 6e 63 65 41    *= performanceA
9b10	64 6a 75 73 74 6d 65 6e  74 0a 0a 09 2f 2f 20 35   djustment...// 5
9b20	2e 20 e8 b5 84 e9 87 91  e6 b0 b4 e5 b9 b3 e8 b0   . ..............
9b30	83 e6 95 b4 ef bc 9a e8  b5 84 e9 87 91 e5 85 85   ................
9b40	e8 b6 b3 e6 97 b6 e5 8f  af e5 a2 9e e5 8a a0 e4   ................
9b50	bb 93 e4 bd 8d ef bc 8c  e8 b5 84 e9 87 91 e7 b4   ................
9b60	a7 e5 bc a0 e6 97 b6 e5  87 8f e5 b0 91 e4 bb 93   ................
9b70	e4 bd 8d 0a 09 63 61 73  68 41 64 6a 75 73 74 6d   .....cashAdjustm
9b80	65 6e 74 20 3a 3d 20 62  65 2e 63 61 6c 63 75 6c   ent := be.calcul
9b90	61 74 65 43 61 73 68 4c  65 76 65 6c 41 64 6a 75   ateCashLevelAdju
9ba0	73 74 6d 65 6e 74 28 29  0a 09 72 69 73 6b 4d 75   stment()..riskMu
9bb0	6c 74 69 70 6c 69 65 72  20 2a 3d 20 63 61 73 68   ltiplier *= cash
9bc0	41 64 6a 75 73 74 6d 65  6e 74 0a 0a 09 2f 2f 20   Adjustment...// 
9bd0	e5 ba 94 e7 94 a8 e9 a3  8e e9 99 a9 e4 b9 98 e6   ................
9be0	95 b0 0a 09 61 64 6a 75  73 74 65 64 52 61 74 69   ....adjustedRati
9bf0	6f 20 3a 3d 20 62 61 73  65 52 61 74 69 6f 20 2a   o := baseRatio *
9c00	20 72 69 73 6b 4d 75 6c  74 69 70 6c 69 65 72 0a    riskMultiplier.
9c10	0a 09 2f 2f 20 e9 99 90  e5 88 b6 e4 bb 93 e4 bd   ..// ...........
9c20	8d e6 af 94 e4 be 8b e5  9c a8 e5 90 88 e7 90 86   ................
9c30	e8 8c 83 e5 9b b4 e5 86  85 0a 09 6d 61 78 52 61   ...........maxRa
9c40	74 69 6f 20 3a 3d 20 30  2e 34 20 20 20 2f 2f 20   tio := 0.4   // 
9c50	e6 9c 80 e5 a4 a7 34 30  25 e5 8d 95 e6 ac a1 e4   ......40%.......
9c60	bb 93 e4 bd 8d ef bc 88  4b 65 6c 6c 79 e5 85 ac   ........Kelly...
9c70	e5 bc 8f e5 8f af e8 83  bd e5 bb ba e8 ae ae e6   ................
9c80	9b b4 e9 ab 98 e4 bb 93  e4 bd 8d ef bc 89 0a 09   ................
9c90	6d 69 6e 52 61 74 69 6f  20 3a 3d 20 30 2e 30 30   minRatio := 0.00
9ca0	35 20 2f 2f 20 e6 9c 80  e5 b0 8f 30 2e 35 25 e4   5 // ......0.5%.
9cb0	bb 93 e4 bd 8d 0a 0a 09  61 64 6a 75 73 74 65 64   ........adjusted
9cc0	52 61 74 69 6f 20 3d 20  6d 61 74 68 2e 4d 61 78   Ratio = math.Max
9cd0	28 6d 69 6e 52 61 74 69  6f 2c 20 6d 61 74 68 2e   (minRatio, math.
9ce0	4d 69 6e 28 6d 61 78 52  61 74 69 6f 2c 20 61 64   Min(maxRatio, ad
9cf0	6a 75 73 74 65 64 52 61  74 69 6f 29 29 0a 0a 09   justedRatio))...
9d00	6c 6f 67 2e 50 72 69 6e  74 66 28 22 5b 50 4f 53   log.Printf("[POS
9d10	49 54 49 4f 4e 5f 41 44  4a 55 53 54 4d 45 4e 54   ITION_ADJUSTMENT
9d20	5d 20 e4 bb 93 e4 bd 8d  e8 b0 83 e6 95 b4 e8 af   ] ..............
9d30	a6 e6 83 85 3a 20 e5 9f  ba e7 a1 80 e6 af 94 e4   ....: ..........
9d40	be 8b 3d 25 2e 32 66 25  25 2c 20 4b 65 6c 6c 79   ..=%.2f%%, Kelly
9d50	e8 b0 83 e6 95 b4 3d 25  2e 32 66 78 2c 20 e6 b3   ......=%.2fx, ..
9d60	a2 e5 8a a8 e7 8e 87 e8  b0 83 e6 95 b4 3d 25 2e   .............=%.
9d70	32 66 78 2c 20 e5 b8 82  e5 9c ba e8 b0 83 e6 95   2fx, ...........
9d80	b4 3d 25 2e 32 66 78 2c  20 e8 a1 a8 e7 8e b0 e8   .=%.2fx, .......
9d90	b0 83 e6 95 b4 3d 25 2e  32 66 78 2c 20 e8 b5 84   .....=%.2fx, ...
9da0	e9 87 91 e8 b0 83 e6 95  b4 3d 25 2e 32 66 78 2c   .........=%.2fx,
9db0	20 e6 9c 80 e7 bb 88 e6  af 94 e4 be 8b 3d 25 2e    ............=%.
9dc0	32 66 25 25 22 2c 0a 09  09 62 61 73 65 52 61 74   2f%%",...baseRat
9dd0	69 6f 2a 31 30 30 2c 20  6b 65 6c 6c 79 41 64 6a   io*100, kellyAdj
9de0	75 73 74 6d 65 6e 74 2c  20 76 6f 6c 61 74 69 6c   ustment, volatil
9df0	69 74 79 41 64 6a 75 73  74 6d 65 6e 74 2c 20 6d   ityAdjustment, m
9e00	61 72 6b 65 74 41 64 6a  75 73 74 6d 65 6e 74 2c   arketAdjustment,
9e10	20 70 65 72 66 6f 72 6d  61 6e 63 65 41 64 6a 75    performanceAdju
9e20	73 74 6d 65 6e 74 2c 20  63 61 73 68 41 64 6a 75   stment, cashAdju
9e30	73 74 6d 65 6e 74 2c 20  61 64 6a 75 73 74 65 64   stment, adjusted
9e40	52 61 74 69 6f 2a 31 30  30 29 0a 0a 09 72 65 74   Ratio*100)...ret
9e50	75 72 6e 20 61 64 6a 75  73 74 65 64 52 61 74 69   urn adjustedRati
9e60	6f 0a 7d 0a 0a 2f 2f 20  63 61 6c 63 75 6c 61 74   o.}..// calculat
9e70	65 4b 65 6c 6c 79 41 64  6a 75 73 74 6d 65 6e 74   eKellyAdjustment
9e80	20 e5 9f ba e4 ba 8e 4b  65 6c 6c 79 e5 85 ac e5    ......Kelly....
9e90	bc 8f e7 9a 84 e4 bb 93  e4 bd 8d e8 b0 83 e6 95   ................
9ea0	b4 0a 66 75 6e 63 20 28  62 65 20 2a 42 61 63 6b   ..func (be *Back
9eb0	74 65 73 74 45 6e 67 69  6e 65 29 20 63 61 6c 63   testEngine) calc
9ec0	75 6c 61 74 65 4b 65 6c  6c 79 41 64 6a 75 73 74   ulateKellyAdjust
9ed0	6d 65 6e 74 28 29 20 66  6c 6f 61 74 36 34 20 7b   ment() float64 {
9ee0	0a 09 2f 2f 20 e8 ae a1  e7 ae 97 e5 8e 86 e5 8f   ..// ...........
9ef0	b2 e8 83 9c e7 8e 87 e5  92 8c e5 b9 b3 e5 9d 87   ................
9f00	e8 b5 94 e7 8e 87 0a 09  77 69 6e 52 61 74 65 2c   ........winRate,
9f10	20 61 76 67 57 69 6e 2c  20 61 76 67 4c 6f 73 73    avgWin, avgLoss
9f20	20 3a 3d 20 62 65 2e 63  61 6c 63 75 6c 61 74 65    := be.calculate
9f30	48 69 73 74 6f 72 69 63  61 6c 50 65 72 66 6f 72   HistoricalPerfor
9f40	6d 61 6e 63 65 28 29 0a  0a 09 69 66 20 77 69 6e   mance()...if win
9f50	52 61 74 65 20 3c 3d 20  30 20 7c 7c 20 77 69 6e   Rate <= 0 || win
9f60	52 61 74 65 20 3e 3d 20  31 20 7c 7c 20 61 76 67   Rate >= 1 || avg
9f70	57 69 6e 20 3c 3d 20 30  20 7c 7c 20 61 76 67 4c   Win <= 0 || avgL
9f80	6f 73 73 20 3c 3d 20 30  20 7b 0a 09 09 2f 2f 20   oss <= 0 {...// 
9f90	e6 95 b0 e6 8d ae e4 b8  8d e8 b6 b3 e6 88 96 e5   ................
9fa0	bc 82 e5 b8 b8 ef bc 8c  e8 bf 94 e5 9b 9e e4 bf   ................
9fb0	9d e5 ae 88 e7 9a 84 30  2e 35 e5 80 8d 0a 09 09   .......0.5......
9fc0	72 65 74 75 72 6e 20 30  2e 35 0a 09 7d 0a 0a 09   return 0.5..}...
9fd0	2f 2f 20 e8 ae a1 e7 ae  97 e8 b5 94 e7 8e 87 20   // ............ 
9fe0	28 e5 b9 b3 e5 9d 87 e7  9b 88 e5 88 a9 2f e5 b9   (............/..
9ff0	b3 e5 9d 87 e4 ba 8f e6  8d 9f 29 0a 09 6f 64 64   ..........)..odd
a000	73 20 3a 3d 20 61 76 67  57 69 6e 20 2f 20 61 76   s := avgWin / av
a010	67 4c 6f 73 73 0a 0a 09  2f 2f 20 4b 65 6c 6c 79   gLoss...// Kelly
a020	e5 85 ac e5 bc 8f 3a 20  66 20 3d 20 28 62 70 20   ......: f = (bp 
a030	2d 20 71 29 20 2f 20 62  0a 09 2f 2f 20 e5 85 b6   - q) / b..// ...
a040	e4 b8 ad 3a 20 62 20 3d  20 e8 b5 94 e7 8e 87 2c   ...: b = ......,
a050	20 70 20 3d 20 e8 83 9c  e7 8e 87 2c 20 71 20 3d    p = ......, q =
a060	20 e8 b4 a5 e7 8e 87 0a  09 6b 65 6c 6c 79 46 72    ........kellyFr
a070	61 63 74 69 6f 6e 20 3a  3d 20 28 6f 64 64 73 2a   action := (odds*
a080	77 69 6e 52 61 74 65 20  2d 20 28 31 20 2d 20 77   winRate - (1 - w
a090	69 6e 52 61 74 65 29 29  20 2f 20 6f 64 64 73 0a   inRate)) / odds.
a0a0	0a 09 2f 2f 20 e9 99 90  e5 88 b6 4b 65 6c 6c 79   ..// ......Kelly
a0b0	e5 88 86 e6 95 b0 e5 9c  a8 e5 90 88 e7 90 86 e8   ................
a0c0	8c 83 e5 9b b4 e5 86 85  0a 09 69 66 20 6b 65 6c   ..........if kel
a0d0	6c 79 46 72 61 63 74 69  6f 6e 20 3c 20 30 20 7b   lyFraction < 0 {
a0e0	0a 09 09 2f 2f 20 e6 9c  9f e6 9c 9b e5 80 bc e4   ...// ..........
a0f0	b8 ba e8 b4 9f ef bc 8c  e4 bd bf e7 94 a8 e5 8d   ................
a100	8a 4b 65 6c 6c 79 e5 85  ac e5 bc 8f 0a 09 09 6b   .Kelly.........k
a110	65 6c 6c 79 46 72 61 63  74 69 6f 6e 20 3d 20 30   ellyFraction = 0
a120	2e 35 20 2a 20 6b 65 6c  6c 79 46 72 61 63 74 69   .5 * kellyFracti
a130	6f 6e 0a 09 7d 0a 0a 09  2f 2f 20 4b 65 6c 6c 79   on..}...// Kelly
a140	e5 88 86 e6 95 b0 e5 8f  af e8 83 bd e5 be 88 e5   ................
a150	a4 a7 ef bc 8c e9 9c 80  e8 a6 81 e9 99 90 e5 88   ................
a160	b6 0a 09 6d 61 78 4b 65  6c 6c 79 46 72 61 63 74   ...maxKellyFract
a170	69 6f 6e 20 3a 3d 20 32  2e 30 20 2f 2f 20 e6 9c   ion := 2.0 // ..
a180	80 e5 a4 a7 32 e5 80 8d  e5 9f ba e7 a1 80 e4 bb   ....2...........
a190	93 e4 bd 8d 0a 09 6d 69  6e 4b 65 6c 6c 79 46 72   ......minKellyFr
a1a0	61 63 74 69 6f 6e 20 3a  3d 20 30 2e 31 20 2f 2f   action := 0.1 //
a1b0	20 e6 9c 80 e5 b0 8f 30  2e 31 e5 80 8d e5 9f ba    ......0.1......
a1c0	e7 a1 80 e4 bb 93 e4 bd  8d 0a 0a 09 6b 65 6c 6c   ............kell
a1d0	79 46 72 61 63 74 69 6f  6e 20 3d 20 6d 61 74 68   yFraction = math
a1e0	2e 4d 61 78 28 6d 69 6e  4b 65 6c 6c 79 46 72 61   .Max(minKellyFra
a1f0	63 74 69 6f 6e 2c 20 6d  61 74 68 2e 4d 69 6e 28   ction, math.Min(
a200	6d 61 78 4b 65 6c 6c 79  46 72 61 63 74 69 6f 6e   maxKellyFraction
a210	2c 20 6b 65 6c 6c 79 46  72 61 63 74 69 6f 6e 29   , kellyFraction)
a220	29 0a 0a 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   )...log.Printf("
a230	5b 4b 45 4c 4c 59 5f 41  44 4a 55 53 54 4d 45 4e   [KELLY_ADJUSTMEN
a240	54 5d 20 4b 65 6c 6c 79  e4 bb 93 e4 bd 8d e8 ae   T] Kelly........
a250	a1 e7 ae 97 3a 20 e8 83  9c e7 8e 87 3d 25 2e 32   ....: ......=%.2
a260	66 25 25 2c 20 e8 b5 94  e7 8e 87 3d 25 2e 32 66   f%%, ......=%.2f
a270	2c 20 4b 65 6c 6c 79 e5  88 86 e6 95 b0 3d 25 2e   , Kelly......=%.
a280	32 66 22 2c 0a 09 09 77  69 6e 52 61 74 65 2a 31   2f",...winRate*1
a290	30 30 2c 20 6f 64 64 73  2c 20 6b 65 6c 6c 79 46   00, odds, kellyF
a2a0	72 61 63 74 69 6f 6e 29  0a 0a 09 72 65 74 75 72   raction)...retur
a2b0	6e 20 6b 65 6c 6c 79 46  72 61 63 74 69 6f 6e 0a   n kellyFraction.
a2c0	7d 0a 0a 2f 2f 20 63 61  6c 63 75 6c 61 74 65 48   }..// calculateH
a2d0	69 73 74 6f 72 69 63 61  6c 50 65 72 66 6f 72 6d   istoricalPerform
a2e0	61 6e 63 65 20 e8 ae a1  e7 ae 97 e5 8e 86 e5 8f   ance ...........
a2f0	b2 e8 a1 a8 e7 8e b0 0a  66 75 6e 63 20 28 62 65   ........func (be
a300	20 2a 42 61 63 6b 74 65  73 74 45 6e 67 69 6e 65    *BacktestEngine
a310	29 20 63 61 6c 63 75 6c  61 74 65 48 69 73 74 6f   ) calculateHisto
a320	72 69 63 61 6c 50 65 72  66 6f 72 6d 61 6e 63 65   ricalPerformance
a330	28 29 20 28 66 6c 6f 61  74 36 34 2c 20 66 6c 6f   () (float64, flo
a340	61 74 36 34 2c 20 66 6c  6f 61 74 36 34 29 20 7b   at64, float64) {
a350	0a 09 2f 2f 20 e7 ae 80  e5 8c 96 e7 9a 84 e5 8e   ..// ...........
a360	86 e5 8f b2 e8 a1 a8 e7  8e b0 e8 ae a1 e7 ae 97   ................
a370	0a 09 2f 2f 20 e5 ae 9e  e9 99 85 e5 ba 94 e8 af   ..// ...........
a380	a5 e5 9f ba e4 ba 8e e7  9c 9f e5 ae 9e e7 9a 84   ................
a390	e4 ba a4 e6 98 93 e5 8e  86 e5 8f b2 0a 0a 09 2f   .............../
a3a0	2f 20 e5 81 87 e8 ae be  e5 9f ba e4 ba 8e e6 9c   / ..............
a3b0	80 e8 bf 91 e7 9a 84 e8  a1 a8 e7 8e b0 e8 ae a1   ................
a3c0	e7 ae 97 0a 09 2f 2f 20  e8 bf 99 e9 87 8c e4 bd   .....// ........
a3d0	bf e7 94 a8 e7 ae 80 e5  8c 96 e7 9a 84 e4 bc b0   ................
a3e0	e7 ae 97 ef bc 8c e5 ae  9e e9 99 85 e5 ba 94 e8   ................
a3f0	af a5 e4 bb 8e e4 ba a4  e6 98 93 e8 ae b0 e5 bd   ................
a400	95 e4 b8 ad e8 ae a1 e7  ae 97 0a 0a 09 2f 2f 20   .............// 
a410	e9 bb 98 e8 ae a4 e5 80  bc ef bc 9a 35 30 25 e8   ............50%.
a420	83 9c e7 8e 87 ef bc 8c  e7 9b 88 e5 88 a9 31 2e   ..............1.
a430	35 e5 80 8d ef bc 8c e4  ba 8f e6 8d 9f 31 e5 80   5............1..
a440	8d 0a 09 64 65 66 61 75  6c 74 57 69 6e 52 61 74   ...defaultWinRat
a450	65 20 3a 3d 20 30 2e 35  0a 09 64 65 66 61 75 6c   e := 0.5..defaul
a460	74 41 76 67 57 69 6e 20  3a 3d 20 31 2e 35 0a 09   tAvgWin := 1.5..
a470	64 65 66 61 75 6c 74 41  76 67 4c 6f 73 73 20 3a   defaultAvgLoss :
a480	3d 20 31 2e 30 0a 0a 09  2f 2f 20 e5 a6 82 e6 9e   = 1.0...// .....
a490	9c e6 9c 89 e5 ae 9e e9  99 85 e7 9a 84 e4 ba a4   ................
a4a0	e6 98 93 e8 ae b0 e5 bd  95 ef bc 8c e5 8f af e4   ................
a4b0	bb a5 e5 9c a8 e8 bf 99  e9 87 8c e8 ae a1 e7 ae   ................
a4c0	97 e7 9c 9f e5 ae 9e e7  9a 84 e8 83 9c e7 8e 87   ................
a4d0	e5 92 8c e8 b5 94 e7 8e  87 0a 09 2f 2f 20 e6 9a   ...........// ..
a4e0	82 e6 97 b6 e8 bf 94 e5  9b 9e e9 bb 98 e8 ae a4   ................
a4f0	e5 80 bc 0a 09 72 65 74  75 72 6e 20 64 65 66 61   .....return defa
a500	75 6c 74 57 69 6e 52 61  74 65 2c 20 64 65 66 61   ultWinRate, defa
a510	75 6c 74 41 76 67 57 69  6e 2c 20 64 65 66 61 75   ultAvgWin, defau
a520	6c 74 41 76 67 4c 6f 73  73 0a 7d 0a 0a 2f 2f 20   ltAvgLoss.}..// 
a530	63 61 6c 63 75 6c 61 74  65 56 6f 6c 61 74 69 6c   calculateVolatil
a540	69 74 79 41 64 6a 75 73  74 6d 65 6e 74 20 e5 9f   ityAdjustment ..
a550	ba e4 ba 8e e6 b3 a2 e5  8a a8 e7 8e 87 e7 9a 84   ................
a560	e4 bb 93 e4 bd 8d e8 b0  83 e6 95 b4 0a 66 75 6e   .............fun
a570	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
a580	6e 67 69 6e 65 29 20 63  61 6c 63 75 6c 61 74 65   ngine) calculate
a590	56 6f 6c 61 74 69 6c 69  74 79 41 64 6a 75 73 74   VolatilityAdjust
a5a0	6d 65 6e 74 28 29 20 66  6c 6f 61 74 36 34 20 7b   ment() float64 {
a5b0	0a 09 2f 2f 20 e7 ae 80  e5 8c 96 e7 9a 84 e6 b3   ..// ...........
a5c0	a2 e5 8a a8 e7 8e 87 e8  b0 83 e6 95 b4 e9 80 bb   ................
a5d0	e8 be 91 0a 09 2f 2f 20  e5 ae 9e e9 99 85 e5 ae   .....// ........
a5e0	9e e7 8e b0 e5 ba 94 e8  af a5 e5 9f ba e4 ba 8e   ................
a5f0	e5 bd 93 e5 89 8d e5 b8  82 e5 9c ba e6 b3 a2 e5   ................
a600	8a a8 e7 8e 87 0a 09 61  76 67 56 6f 6c 61 74 69   .......avgVolati
a610	6c 69 74 79 20 3a 3d 20  30 2e 30 33 20 2f 2f 20   lity := 0.03 // 
a620	e5 81 87 e8 ae be 33 25  e7 9a 84 e5 b9 b3 e5 9d   ......3%........
a630	87 e6 b3 a2 e5 8a a8 e7  8e 87 0a 0a 09 69 66 20   .............if 
a640	61 76 67 56 6f 6c 61 74  69 6c 69 74 79 20 3e 20   avgVolatility > 
a650	30 2e 30 38 20 7b 0a 09  09 72 65 74 75 72 6e 20   0.08 {...return 
a660	30 2e 35 20 2f 2f 20 e9  ab 98 e6 b3 a2 e5 8a a8   0.5 // .........
a670	ef bc 9a e5 87 8f e5 b0  91 e5 88 b0 35 30 25 0a   ............50%.
a680	09 7d 20 65 6c 73 65 20  69 66 20 61 76 67 56 6f   .} else if avgVo
a690	6c 61 74 69 6c 69 74 79  20 3e 20 30 2e 30 35 20   latility > 0.05 
a6a0	7b 0a 09 09 72 65 74 75  72 6e 20 30 2e 37 20 2f   {...return 0.7 /
a6b0	2f 20 e4 b8 ad e9 ab 98  e6 b3 a2 e5 8a a8 ef bc   / ..............
a6c0	9a e5 87 8f e5 b0 91 e5  88 b0 37 30 25 0a 09 7d   ..........70%..}
a6d0	20 65 6c 73 65 20 69 66  20 61 76 67 56 6f 6c 61    else if avgVola
a6e0	74 69 6c 69 74 79 20 3e  20 30 2e 30 32 20 7b 0a   tility > 0.02 {.
a6f0	09 09 72 65 74 75 72 6e  20 31 2e 30 20 2f 2f 20   ..return 1.0 // 
a700	e6 ad a3 e5 b8 b8 e6 b3  a2 e5 8a a8 ef bc 9a e4   ................
a710	bf 9d e6 8c 81 31 30 30  25 0a 09 7d 20 65 6c 73   .....100%..} els
a720	65 20 7b 0a 09 09 72 65  74 75 72 6e 20 31 2e 32   e {...return 1.2
a730	20 2f 2f 20 e4 bd 8e e6  b3 a2 e5 8a a8 ef bc 9a    // ............
a740	e5 a2 9e e5 8a a0 e5 88  b0 31 32 30 25 0a 09 7d   .........120%..}
a750	0a 7d 0a 0a 2f 2f 20 67  65 74 43 75 72 72 65 6e   .}..// getCurren
a760	74 4d 61 72 6b 65 74 52  65 67 69 6d 65 20 e8 8e   tMarketRegime ..
a770	b7 e5 8f 96 e5 bd 93 e5  89 8d e5 b8 82 e5 9c ba   ................
a780	e7 8e af e5 a2 83 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
a790	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
a7a0	20 67 65 74 43 75 72 72  65 6e 74 4d 61 72 6b 65    getCurrentMarke
a7b0	74 52 65 67 69 6d 65 28  29 20 73 74 72 69 6e 67   tRegime() string
a7c0	20 7b 0a 09 2f 2f 20 e5  a6 82 e6 9e 9c e6 9c 89    {..// .........
a7d0	e7 bc 93 e5 ad 98 e7 9a  84 e5 b8 82 e5 9c ba e7   ................
a7e0	8e af e5 a2 83 ef bc 8c  e8 bf 94 e5 9b 9e e5 ae   ................
a7f0	83 0a 09 69 66 20 62 65  2e 63 75 72 72 65 6e 74   ...if be.current
a800	4d 61 72 6b 65 74 52 65  67 69 6d 65 20 21 3d 20   MarketRegime != 
a810	22 22 20 7b 0a 09 09 72  65 74 75 72 6e 20 62 65   "" {...return be
a820	2e 63 75 72 72 65 6e 74  4d 61 72 6b 65 74 52 65   .currentMarketRe
a830	67 69 6d 65 0a 09 7d 0a  0a 09 2f 2f 20 e9 bb 98   gime..}...// ...
a840	e8 ae a4 e8 bf 94 e5 9b  9e e6 b7 b7 e5 90 88 e5   ................
a850	b8 82 e5 9c ba e7 8e af  e5 a2 83 0a 09 72 65 74   .............ret
a860	75 72 6e 20 22 6d 69 78  65 64 22 0a 7d 0a 0a 2f   urn "mixed".}../
a870	2f 20 63 61 6c 63 75 6c  61 74 65 44 79 6e 61 6d   / calculateDynam
a880	69 63 4f 70 70 6f 72 74  75 6e 69 74 79 54 68 72   icOpportunityThr
a890	65 73 68 6f 6c 64 20 e6  a0 b9 e6 8d ae e5 b8 82   eshold .........
a8a0	e5 9c ba e7 8e af e5 a2  83 e8 ae a1 e7 ae 97 e5   ................
a8b0	8a a8 e6 80 81 e6 9c ba  e4 bc 9a e9 98 88 e5 80   ................
a8c0	bc 0a 66 75 6e 63 20 28  62 65 20 2a 42 61 63 6b   ..func (be *Back
a8d0	74 65 73 74 45 6e 67 69  6e 65 29 20 63 61 6c 63   testEngine) calc
a8e0	75 6c 61 74 65 44 79 6e  61 6d 69 63 4f 70 70 6f   ulateDynamicOppo
a8f0	72 74 75 6e 69 74 79 54  68 72 65 73 68 6f 6c 64   rtunityThreshold
a900	28 29 20 66 6c 6f 61 74  36 34 20 7b 0a 09 6d 61   () float64 {..ma
a910	72 6b 65 74 52 65 67 69  6d 65 20 3a 3d 20 62 65   rketRegime := be
a920	2e 67 65 74 43 75 72 72  65 6e 74 4d 61 72 6b 65   .getCurrentMarke
a930	74 52 65 67 69 6d 65 28  29 0a 0a 09 76 61 72 20   tRegime()...var 
a940	74 68 72 65 73 68 6f 6c  64 20 66 6c 6f 61 74 36   threshold float6
a950	34 0a 09 73 77 69 74 63  68 20 6d 61 72 6b 65 74   4..switch market
a960	52 65 67 69 6d 65 20 7b  0a 09 63 61 73 65 20 22   Regime {..case "
a970	73 74 72 6f 6e 67 5f 62  75 6c 6c 22 3a 0a 09 09   strong_bull":...
a980	74 68 72 65 73 68 6f 6c  64 20 3d 20 30 2e 30 37   threshold = 0.07
a990	20 2f 2f 20 e5 bc ba e7  89 9b e5 b8 82 ef bc 9a    // ............
a9a0	e8 a6 81 e6 b1 82 e8 be  83 e9 ab 98 e5 88 86 e6   ................
a9b0	95 b0 ef bc 8c e7 a1 ae  e4 bf 9d e8 b4 a8 e9 87   ................
a9c0	8f 0a 09 63 61 73 65 20  22 77 65 61 6b 5f 62 75   ...case "weak_bu
a9d0	6c 6c 22 3a 0a 09 09 74  68 72 65 73 68 6f 6c 64   ll":...threshold
a9e0	20 3d 20 30 2e 30 35 20  2f 2f 20 e5 bc b1 e7 89    = 0.05 // .....
a9f0	9b e5 b8 82 ef bc 9a e4  b8 ad e7 ad 89 e8 a6 81   ................
aa00	e6 b1 82 0a 09 63 61 73  65 20 22 73 69 64 65 77   .....case "sidew
aa10	61 79 73 22 3a 0a 09 09  74 68 72 65 73 68 6f 6c   ays":...threshol
aa20	64 20 3d 20 30 2e 30 33  20 2f 2f 20 e6 a8 aa e7   d = 0.03 // ....
aa30	9b 98 e5 b8 82 ef bc 9a  e5 a4 a7 e5 b9 85 e9 99   ................
aa40	8d e4 bd 8e e8 a6 81 e6  b1 82 ef bc 8c e5 a2 9e   ................
aa50	e5 8a a0 e4 ba a4 e6 98  93 e6 9c ba e4 bc 9a 0a   ................
aa60	09 63 61 73 65 20 22 77  65 61 6b 5f 62 65 61 72   .case "weak_bear
aa70	22 3a 0a 09 09 74 68 72  65 73 68 6f 6c 64 20 3d   ":...threshold =
aa80	20 30 2e 30 36 20 2f 2f  20 e5 bc b1 e7 86 8a e5    0.06 // .......
aa90	b8 82 ef bc 9a e6 8f 90  e9 ab 98 e8 a6 81 e6 b1   ................
aaa0	82 ef bc 8c e8 b0 a8 e6  85 8e e4 ba a4 e6 98 93   ................
aab0	0a 09 63 61 73 65 20 22  73 74 72 6f 6e 67 5f 62   ..case "strong_b
aac0	65 61 72 22 3a 0a 09 09  74 68 72 65 73 68 6f 6c   ear":...threshol
aad0	64 20 3d 20 30 2e 31 32  20 2f 2f 20 e5 bc ba e7   d = 0.12 // ....
aae0	86 8a e5 b8 82 ef bc 9a  e6 9e 81 e9 ab 98 e8 a6   ................
aaf0	81 e6 b1 82 ef bc 8c e5  87 a0 e4 b9 8e e4 b8 8d   ................
ab00	e4 ba a4 e6 98 93 0a 09  64 65 66 61 75 6c 74 3a   ........default:
ab10	0a 09 09 74 68 72 65 73  68 6f 6c 64 20 3d 20 30   ...threshold = 0
ab20	2e 30 34 20 2f 2f 20 e9  bb 98 e8 ae a4 e5 80 bc   .04 // .........
ab30	e9 99 8d e4 bd 8e 0a 09  7d 0a 0a 09 6c 6f 67 2e   ........}...log.
ab40	50 72 69 6e 74 66 28 22  5b 44 59 4e 41 4d 49 43   Printf("[DYNAMIC
ab50	5f 54 48 52 45 53 48 4f  4c 44 5d 20 e5 b8 82 e5   _THRESHOLD] ....
ab60	9c ba e7 8e af e5 a2 83  3a 20 25 73 2c 20 e5 8a   ........: %s, ..
ab70	a8 e6 80 81 e6 9c ba e4  bc 9a e9 98 88 e5 80 bc   ................
ab80	3a 20 25 2e 33 66 22 2c  20 6d 61 72 6b 65 74 52   : %.3f", marketR
ab90	65 67 69 6d 65 2c 20 74  68 72 65 73 68 6f 6c 64   egime, threshold
aba0	29 0a 09 72 65 74 75 72  6e 20 74 68 72 65 73 68   )..return thresh
abb0	6f 6c 64 0a 7d 0a 0a 2f  2f 20 75 70 64 61 74 65   old.}..// update
abc0	43 75 72 72 65 6e 74 4d  61 72 6b 65 74 52 65 67   CurrentMarketReg
abd0	69 6d 65 20 e6 9b b4 e6  96 b0 e5 bd 93 e5 89 8d   ime ............
abe0	e5 b8 82 e5 9c ba e7 8e  af e5 a2 83 0a 66 75 6e   .............fun
abf0	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
ac00	6e 67 69 6e 65 29 20 75  70 64 61 74 65 43 75 72   ngine) updateCur
ac10	72 65 6e 74 4d 61 72 6b  65 74 52 65 67 69 6d 65   rentMarketRegime
ac20	28 72 65 67 69 6d 65 20  73 74 72 69 6e 67 29 20   (regime string) 
ac30	7b 0a 09 62 65 2e 63 75  72 72 65 6e 74 4d 61 72   {..be.currentMar
ac40	6b 65 74 52 65 67 69 6d  65 20 3d 20 72 65 67 69   ketRegime = regi
ac50	6d 65 0a 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   me..log.Printf("
ac60	5b 4d 41 52 4b 45 54 5f  52 45 47 49 4d 45 5f 55   [MARKET_REGIME_U
ac70	50 44 41 54 45 5d 20 e5  b8 82 e5 9c ba e7 8e af   PDATE] .........
ac80	e5 a2 83 e6 9b b4 e6 96  b0 e4 b8 ba 3a 20 25 73   ............: %s
ac90	22 2c 20 72 65 67 69 6d  65 29 0a 7d 0a 0a 2f 2f   ", regime).}..//
aca0	20 63 61 6c 63 75 6c 61  74 65 4d 61 72 6b 65 74    calculateMarket
acb0	45 6e 76 69 72 6f 6e 6d  65 6e 74 41 64 6a 75 73   EnvironmentAdjus
acc0	74 6d 65 6e 74 20 e5 9f  ba e4 ba 8e e5 b8 82 e5   tment ..........
acd0	9c ba e7 8e af e5 a2 83  e7 9a 84 e4 bb 93 e4 bd   ................
ace0	8d e8 b0 83 e6 95 b4 ef  bc 88 e4 bc 98 e5 8c 96   ................
acf0	e7 89 88 ef bc 89 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
ad00	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
ad10	20 63 61 6c 63 75 6c 61  74 65 4d 61 72 6b 65 74    calculateMarket
ad20	45 6e 76 69 72 6f 6e 6d  65 6e 74 41 64 6a 75 73   EnvironmentAdjus
ad30	74 6d 65 6e 74 28 29 20  66 6c 6f 61 74 36 34 20   tment() float64 
ad40	7b 0a 09 2f 2f 20 e8 8e  b7 e5 8f 96 e5 bd 93 e5   {..// ..........
ad50	89 8d e5 b8 82 e5 9c ba  e7 8e af e5 a2 83 0a 09   ................
ad60	6d 61 72 6b 65 74 52 65  67 69 6d 65 20 3a 3d 20   marketRegime := 
ad70	62 65 2e 67 65 74 43 75  72 72 65 6e 74 4d 61 72   be.getCurrentMar
ad80	6b 65 74 52 65 67 69 6d  65 28 29 0a 0a 09 6c 6f   ketRegime()...lo
ad90	67 2e 50 72 69 6e 74 66  28 22 5b 4d 41 52 4b 45   g.Printf("[MARKE
ada0	54 5f 41 44 4a 55 53 54  4d 45 4e 54 5d 20 e5 bd   T_ADJUSTMENT] ..
adb0	93 e5 89 8d e5 b8 82 e5  9c ba e7 8e af e5 a2 83   ................
adc0	3a 20 25 73 22 2c 20 6d  61 72 6b 65 74 52 65 67   : %s", marketReg
add0	69 6d 65 29 0a 0a 09 73  77 69 74 63 68 20 6d 61   ime)...switch ma
ade0	72 6b 65 74 52 65 67 69  6d 65 20 7b 0a 09 63 61   rketRegime {..ca
adf0	73 65 20 22 73 74 72 6f  6e 67 5f 62 75 6c 6c 22   se "strong_bull"
ae00	3a 0a 09 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   :...log.Printf("
ae10	5b 42 55 4c 4c 5f 50 4f  53 49 54 49 4f 4e 5f 41   [BULL_POSITION_A
ae20	44 4a 55 53 54 5d 20 e5  bc ba e7 89 9b e5 b8 82   DJUST] .........
ae30	e7 8e af e5 a2 83 ef bc  8c e9 80 82 e5 ba a6 e5   ................
ae40	a2 9e e5 8a a0 e4 bb 93  e4 bd 8d 22 29 0a 09 09   ...........")...
ae50	72 65 74 75 72 6e 20 31  2e 33 20 2f 2f 20 e5 bc   return 1.3 // ..
ae60	ba e7 89 9b e5 b8 82 ef  bc 9a e5 a2 9e e5 8a a0   ................
ae70	e5 88 b0 31 33 30 25 0a  09 63 61 73 65 20 22 77   ...130%..case "w
ae80	65 61 6b 5f 62 75 6c 6c  22 3a 0a 09 09 6c 6f 67   eak_bull":...log
ae90	2e 50 72 69 6e 74 66 28  22 5b 42 55 4c 4c 5f 50   .Printf("[BULL_P
aea0	4f 53 49 54 49 4f 4e 5f  41 44 4a 55 53 54 5d 20   OSITION_ADJUST] 
aeb0	e5 bc b1 e7 89 9b e5 b8  82 e7 8e af e5 a2 83 ef   ................
aec0	bc 8c e7 95 a5 e5 be ae  e5 a2 9e e5 8a a0 e4 bb   ................
aed0	93 e4 bd 8d 22 29 0a 09  09 72 65 74 75 72 6e 20   ....")...return 
aee0	31 2e 31 20 2f 2f 20 e5  bc b1 e7 89 9b e5 b8 82   1.1 // .........
aef0	ef bc 9a e5 a2 9e e5 8a  a0 e5 88 b0 31 31 30 25   ............110%
af00	0a 09 63 61 73 65 20 22  73 74 72 6f 6e 67 5f 62   ..case "strong_b
af10	65 61 72 22 3a 0a 09 09  6c 6f 67 2e 50 72 69 6e   ear":...log.Prin
af20	74 66 28 22 5b 42 45 41  52 5f 50 4f 53 49 54 49   tf("[BEAR_POSITI
af30	4f 4e 5f 41 44 4a 55 53  54 5d 20 e5 bc ba e7 86   ON_ADJUST] .....
af40	8a e5 b8 82 e7 8e af e5  a2 83 ef bc 8c e5 87 8f   ................
af50	e5 b0 91 e4 bb 93 e4 bd  8d e4 bd 86 e4 bf 9d e6   ................
af60	8c 81 e9 80 82 e5 ba a6  e4 ba a4 e6 98 93 22 29   ..............")
af70	0a 09 09 72 65 74 75 72  6e 20 30 2e 36 20 2f 2f   ...return 0.6 //
af80	20 e5 bc ba e7 86 8a e5  b8 82 ef bc 9a e5 87 8f    ...............
af90	e5 b0 91 e5 88 b0 36 30  25 ef bc 88 e4 bb 8e 35   ......60%......5
afa0	30 25 e6 8f 90 e9 ab 98  ef bc 8c e9 81 bf e5 85   0%..............
afb0	8d e8 bf 87 e5 ba a6 e4  bf 9d e5 ae 88 ef bc 89   ................
afc0	0a 09 63 61 73 65 20 22  77 65 61 6b 5f 62 65 61   ..case "weak_bea
afd0	72 22 3a 0a 09 09 6c 6f  67 2e 50 72 69 6e 74 66   r":...log.Printf
afe0	28 22 5b 42 45 41 52 5f  50 4f 53 49 54 49 4f 4e   ("[BEAR_POSITION
aff0	5f 41 44 4a 55 53 54 5d  20 e5 bc b1 e7 86 8a e5   _ADJUST] .......
b000	b8 82 e7 8e af e5 a2 83  ef bc 8c e8 bd bb e5 be   ................
b010	ae e5 87 8f e5 b0 91 e4  bb 93 e4 bd 8d 22 29 0a   .............").
b020	09 09 72 65 74 75 72 6e  20 30 2e 38 20 2f 2f 20   ..return 0.8 // 
b030	e5 bc b1 e7 86 8a e5 b8  82 ef bc 9a e5 87 8f e5   ................
b040	b0 91 e5 88 b0 38 30 25  ef bc 88 e4 bb 8e 37 30   .....80%......70
b050	25 e6 8f 90 e9 ab 98 ef  bc 8c e9 bc 93 e5 8a b1   %...............
b060	e9 80 82 e5 ba a6 e4 ba  a4 e6 98 93 ef bc 89 0a   ................
b070	09 63 61 73 65 20 22 73  69 64 65 77 61 79 73 22   .case "sideways"
b080	3a 0a 09 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   :...log.Printf("
b090	5b 53 49 44 45 57 41 59  53 5f 50 4f 53 49 54 49   [SIDEWAYS_POSITI
b0a0	4f 4e 5f 41 44 4a 55 53  54 5d 20 e6 a8 aa e7 9b   ON_ADJUST] .....
b0b0	98 e5 b8 82 e5 9c ba e7  8e af e5 a2 83 ef bc 8c   ................
b0c0	e4 bf 9d e6 8c 81 e9 80  82 e4 b8 ad e4 bb 93 e4   ................
b0d0	bd 8d 22 29 0a 09 09 72  65 74 75 72 6e 20 30 2e   ..")...return 0.
b0e0	39 20 2f 2f 20 e6 a8 aa  e7 9b 98 ef bc 9a e5 87   9 // ...........
b0f0	8f e5 b0 91 e5 88 b0 39  30 25 0a 09 63 61 73 65   .......90%..case
b100	20 22 6c 6f 77 5f 76 6f  6c 61 74 69 6c 69 74 79    "low_volatility
b110	22 3a 0a 09 09 6c 6f 67  2e 50 72 69 6e 74 66 28   ":...log.Printf(
b120	22 5b 4c 4f 57 5f 56 4f  4c 5f 50 4f 53 49 54 49   "[LOW_VOL_POSITI
b130	4f 4e 5f 41 44 4a 55 53  54 5d 20 e4 bd 8e e6 b3   ON_ADJUST] .....
b140	a2 e5 8a a8 e7 8e af e5  a2 83 ef bc 8c e5 8f af   ................
b150	e9 80 82 e5 bd 93 e5 a2  9e e5 8a a0 e4 bb 93 e4   ................
b160	bd 8d 22 29 0a 09 09 72  65 74 75 72 6e 20 31 2e   ..")...return 1.
b170	32 20 2f 2f 20 e4 bd 8e  e6 b3 a2 e5 8a a8 ef bc   2 // ...........
b180	9a e5 a2 9e e5 8a a0 e5  88 b0 31 32 30 25 0a 09   ..........120%..
b190	63 61 73 65 20 22 6d 69  78 65 64 22 3a 0a 09 09   case "mixed":...
b1a0	6c 6f 67 2e 50 72 69 6e  74 66 28 22 5b 4d 49 58   log.Printf("[MIX
b1b0	45 44 5f 50 4f 53 49 54  49 4f 4e 5f 41 44 4a 55   ED_POSITION_ADJU
b1c0	53 54 5d 20 e6 b7 b7 e5  90 88 e5 b8 82 e5 9c ba   ST] ............
b1d0	e7 8e af e5 a2 83 ef bc  8c e4 bf 9d e6 8c 81 e5   ................
b1e0	9d 87 e8 a1 a1 e4 bb 93  e4 bd 8d 22 29 0a 09 09   ...........")...
b1f0	72 65 74 75 72 6e 20 31  2e 30 20 2f 2f 20 e6 b7   return 1.0 // ..
b200	b7 e5 90 88 ef bc 9a e4  bf 9d e6 8c 81 31 30 30   .............100
b210	25 0a 09 64 65 66 61 75  6c 74 3a 0a 09 09 6c 6f   %..default:...lo
b220	67 2e 50 72 69 6e 74 66  28 22 5b 55 4e 4b 4e 4f   g.Printf("[UNKNO
b230	57 4e 5f 50 4f 53 49 54  49 4f 4e 5f 41 44 4a 55   WN_POSITION_ADJU
b240	53 54 5d 20 e6 9c aa e7  9f a5 e5 b8 82 e5 9c ba   ST] ............
b250	e7 8e af e5 a2 83 ef bc  8c e4 bd bf e7 94 a8 e4   ................
b260	bf 9d e5 ae 88 e7 ad 96  e7 95 a5 22 29 0a 09 09   ...........")...
b270	72 65 74 75 72 6e 20 30  2e 38 20 2f 2f 20 e6 9c   return 0.8 // ..
b280	aa e7 9f a5 ef bc 9a e4  bf 9d e5 ae 88 e7 ad 96   ................
b290	e7 95 a5 38 30 25 0a 09  7d 0a 7d 0a 0a 2f 2f 20   ...80%..}.}..// 
b2a0	63 61 6c 63 75 6c 61 74  65 50 65 72 66 6f 72 6d   calculatePerform
b2b0	61 6e 63 65 41 64 6a 75  73 74 6d 65 6e 74 20 e5   anceAdjustment .
b2c0	9f ba e4 ba 8e e8 bf 91  e6 9c 9f e8 a1 a8 e7 8e   ................
b2d0	b0 e7 9a 84 e4 bb 93 e4  bd 8d e8 b0 83 e6 95 b4   ................
b2e0	0a 66 75 6e 63 20 28 62  65 20 2a 42 61 63 6b 74   .func (be *Backt
b2f0	65 73 74 45 6e 67 69 6e  65 29 20 63 61 6c 63 75   estEngine) calcu
b300	6c 61 74 65 50 65 72 66  6f 72 6d 61 6e 63 65 41   latePerformanceA
b310	64 6a 75 73 74 6d 65 6e  74 28 29 20 66 6c 6f 61   djustment() floa
b320	74 36 34 20 7b 0a 09 2f  2f 20 e7 ae 80 e5 8c 96   t64 {..// ......
b330	e7 9a 84 e8 a1 a8 e7 8e  b0 e8 b0 83 e6 95 b4 e9   ................
b340	80 bb e8 be 91 0a 09 2f  2f 20 e5 ae 9e e9 99 85   .......// ......
b350	e5 ae 9e e7 8e b0 e5 ba  94 e8 af a5 e5 9f ba e4   ................
b360	ba 8e e6 9c 80 e8 bf 91  e7 9a 84 e4 ba a4 e6 98   ................
b370	93 e8 a1 a8 e7 8e b0 0a  0a 09 72 65 63 65 6e 74   ..........recent
b380	57 69 6e 52 61 74 65 20  3a 3d 20 30 2e 35 20 2f   WinRate := 0.5 /
b390	2f 20 e5 81 87 e8 ae be  35 30 25 e7 9a 84 e8 83   / ......50%.....
b3a0	9c e7 8e 87 0a 0a 09 69  66 20 72 65 63 65 6e 74   .......if recent
b3b0	57 69 6e 52 61 74 65 20  3e 20 30 2e 37 20 7b 0a   WinRate > 0.7 {.
b3c0	09 09 72 65 74 75 72 6e  20 31 2e 32 20 2f 2f 20   ..return 1.2 // 
b3d0	e9 ab 98 e8 83 9c e7 8e  87 ef bc 9a e5 a2 9e e5   ................
b3e0	8a a0 e5 88 b0 31 32 30  25 0a 09 7d 20 65 6c 73   .....120%..} els
b3f0	65 20 69 66 20 72 65 63  65 6e 74 57 69 6e 52 61   e if recentWinRa
b400	74 65 20 3e 20 30 2e 35  20 7b 0a 09 09 72 65 74   te > 0.5 {...ret
b410	75 72 6e 20 31 2e 30 20  2f 2f 20 e6 ad a3 e5 b8   urn 1.0 // .....
b420	b8 e8 83 9c e7 8e 87 ef  bc 9a e4 bf 9d e6 8c 81   ................
b430	31 30 30 25 0a 09 7d 20  65 6c 73 65 20 69 66 20   100%..} else if 
b440	72 65 63 65 6e 74 57 69  6e 52 61 74 65 20 3e 20   recentWinRate > 
b450	30 2e 33 20 7b 0a 09 09  72 65 74 75 72 6e 20 30   0.3 {...return 0
b460	2e 38 20 2f 2f 20 e4 bd  8e e8 83 9c e7 8e 87 ef   .8 // ..........
b470	bc 9a e5 87 8f e5 b0 91  e5 88 b0 38 30 25 0a 09   ...........80%..
b480	7d 20 65 6c 73 65 20 7b  0a 09 09 72 65 74 75 72   } else {...retur
b490	6e 20 30 2e 35 20 2f 2f  20 e6 9e 81 e4 bd 8e e8   n 0.5 // .......
b4a0	83 9c e7 8e 87 ef bc 9a  e5 87 8f e5 b0 91 e5 88   ................
b4b0	b0 35 30 25 0a 09 7d 0a  7d 0a 0a 2f 2f 20 63 61   .50%..}.}..// ca
b4c0	6c 63 75 6c 61 74 65 43  61 73 68 4c 65 76 65 6c   lculateCashLevel
b4d0	41 64 6a 75 73 74 6d 65  6e 74 20 e5 9f ba e4 ba   Adjustment .....
b4e0	8e e8 b5 84 e9 87 91 e6  b0 b4 e5 b9 b3 e7 9a 84   ................
b4f0	e4 bb 93 e4 bd 8d e8 b0  83 e6 95 b4 0a 66 75 6e   .............fun
b500	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
b510	6e 67 69 6e 65 29 20 63  61 6c 63 75 6c 61 74 65   ngine) calculate
b520	43 61 73 68 4c 65 76 65  6c 41 64 6a 75 73 74 6d   CashLevelAdjustm
b530	65 6e 74 28 29 20 66 6c  6f 61 74 36 34 20 7b 0a   ent() float64 {.
b540	09 2f 2f 20 e7 ae 80 e5  8c 96 e7 9a 84 e8 b5 84   .// ............
b550	e9 87 91 e6 b0 b4 e5 b9  b3 e8 b0 83 e6 95 b4 0a   ................
b560	09 2f 2f 20 e5 ae 9e e9  99 85 e5 ae 9e e7 8e b0   .// ............
b570	e5 ba 94 e8 af a5 e5 9f  ba e4 ba 8e e5 bd 93 e5   ................
b580	89 8d e5 8f af e7 94 a8  e8 b5 84 e9 87 91 e6 af   ................
b590	94 e4 be 8b 0a 0a 09 63  61 73 68 52 61 74 69 6f   .......cashRatio
b5a0	20 3a 3d 20 30 2e 38 20  2f 2f 20 e5 81 87 e8 ae    := 0.8 // .....
b5b0	be 38 30 25 e7 9a 84 e8  b5 84 e9 87 91 e5 8f af   .80%............
b5c0	e7 94 a8 0a 0a 09 69 66  20 63 61 73 68 52 61 74   ......if cashRat
b5d0	69 6f 20 3e 20 30 2e 38  20 7b 0a 09 09 72 65 74   io > 0.8 {...ret
b5e0	75 72 6e 20 31 2e 32 20  2f 2f 20 e8 b5 84 e9 87   urn 1.2 // .....
b5f0	91 e5 85 85 e8 b6 b3 ef  bc 9a e5 a2 9e e5 8a a0   ................
b600	e5 88 b0 31 32 30 25 0a  09 7d 20 65 6c 73 65 20   ...120%..} else 
b610	69 66 20 63 61 73 68 52  61 74 69 6f 20 3e 20 30   if cashRatio > 0
b620	2e 35 20 7b 0a 09 09 72  65 74 75 72 6e 20 31 2e   .5 {...return 1.
b630	30 20 2f 2f 20 e8 b5 84  e9 87 91 e6 ad a3 e5 b8   0 // ...........
b640	b8 ef bc 9a e4 bf 9d e6  8c 81 31 30 30 25 0a 09   ..........100%..
b650	7d 20 65 6c 73 65 20 69  66 20 63 61 73 68 52 61   } else if cashRa
b660	74 69 6f 20 3e 20 30 2e  32 20 7b 0a 09 09 72 65   tio > 0.2 {...re
b670	74 75 72 6e 20 30 2e 38  20 2f 2f 20 e8 b5 84 e9   turn 0.8 // ....
b680	87 91 e7 b4 a7 e5 bc a0  ef bc 9a e5 87 8f e5 b0   ................
b690	91 e5 88 b0 38 30 25 0a  09 7d 20 65 6c 73 65 20   ....80%..} else 
b6a0	7b 0a 09 09 72 65 74 75  72 6e 20 30 2e 35 20 2f   {...return 0.5 /
b6b0	2f 20 e8 b5 84 e9 87 91  e6 9e 81 e5 b0 91 ef bc   / ..............
b6c0	9a e5 87 8f e5 b0 91 e5  88 b0 35 30 25 0a 09 7d   ..........50%..}
b6d0	0a 7d 0a 0a 2f 2f 20 63  68 65 63 6b 4d 75 6c 74   .}..// checkMult
b6e0	69 53 79 6d 62 6f 6c 45  78 69 74 73 20 e6 a3 80   iSymbolExits ...
b6f0	e6 9f a5 e5 a4 9a e5 b8  81 e7 a7 8d e5 b9 b3 e4   ................
b700	bb 93 0a 66 75 6e 63 20  28 62 65 20 2a 42 61 63   ...func (be *Bac
b710	6b 74 65 73 74 45 6e 67  69 6e 65 29 20 63 68 65   ktestEngine) che
b720	63 6b 4d 75 6c 74 69 53  79 6d 62 6f 6c 45 78 69   ckMultiSymbolExi
b730	74 73 28 73 79 6d 62 6f  6c 53 74 61 74 65 73 20   ts(symbolStates 
b740	6d 61 70 5b 73 74 72 69  6e 67 5d 2a 53 79 6d 62   map[string]*Symb
b750	6f 6c 53 74 61 74 65 2c  20 61 76 61 69 6c 61 62   olState, availab
b760	6c 65 43 61 73 68 20 2a  66 6c 6f 61 74 36 34 2c   leCash *float64,
b770	20 74 6f 74 61 6c 43 61  73 68 20 2a 66 6c 6f 61    totalCash *floa
b780	74 36 34 2c 20 72 65 73  75 6c 74 20 2a 42 61 63   t64, result *Bac
b790	6b 74 65 73 74 52 65 73  75 6c 74 2c 20 74 69 6d   ktestResult, tim
b7a0	65 73 74 61 6d 70 20 74  69 6d 65 2e 54 69 6d 65   estamp time.Time
b7b0	2c 20 63 6f 6e 66 69 67  20 2a 42 61 63 6b 74 65   , config *Backte
b7c0	73 74 43 6f 6e 66 69 67  29 20 7b 0a 09 66 6f 72   stConfig) {..for
b7d0	20 73 79 6d 62 6f 6c 2c  20 73 74 61 74 65 20 3a    symbol, state :
b7e0	3d 20 72 61 6e 67 65 20  73 79 6d 62 6f 6c 53 74   = range symbolSt
b7f0	61 74 65 73 20 7b 0a 09  09 69 66 20 73 74 61 74   ates {...if stat
b800	65 2e 50 6f 73 69 74 69  6f 6e 20 3c 3d 20 30 20   e.Position <= 0 
b810	7b 0a 09 09 09 63 6f 6e  74 69 6e 75 65 0a 09 09   {....continue...
b820	7d 0a 0a 09 09 63 75 72  72 65 6e 74 49 6e 64 65   }....currentInde
b830	78 20 3a 3d 20 6c 65 6e  28 73 74 61 74 65 2e 44   x := len(state.D
b840	61 74 61 29 20 2d 20 31  0a 09 09 69 66 20 63 75   ata) - 1...if cu
b850	72 72 65 6e 74 49 6e 64  65 78 20 3c 20 30 20 7c   rrentIndex < 0 |
b860	7c 20 63 75 72 72 65 6e  74 49 6e 64 65 78 20 3e   | currentIndex >
b870	3d 20 6c 65 6e 28 73 74  61 74 65 2e 44 61 74 61   = len(state.Data
b880	29 20 7b 0a 09 09 09 63  6f 6e 74 69 6e 75 65 0a   ) {....continue.
b890	09 09 7d 0a 0a 09 09 63  75 72 72 65 6e 74 50 72   ..}....currentPr
b8a0	69 63 65 20 3a 3d 20 73  74 61 74 65 2e 44 61 74   ice := state.Dat
b8b0	61 5b 63 75 72 72 65 6e  74 49 6e 64 65 78 5d 2e   a[currentIndex].
b8c0	50 72 69 63 65 0a 09 09  65 6e 74 72 79 50 72 69   Price...entryPri
b8d0	63 65 20 3a 3d 20 30 2e  30 0a 0a 09 09 2f 2f 20   ce := 0.0....// 
b8e0	e6 89 be e5 88 b0 e4 b9  b0 e5 85 a5 e4 bb b7 e6   ................
b8f0	a0 bc ef bc 88 e7 ae 80  e5 8c 96 e5 a4 84 e7 90   ................
b900	86 ef bc 8c e4 bb 8e e4  ba a4 e6 98 93 e8 ae b0   ................
b910	e5 bd 95 e4 b8 ad e6 9f  a5 e6 89 be ef bc 89 0a   ................
b920	09 09 66 6f 72 20 69 20  3a 3d 20 6c 65 6e 28 72   ..for i := len(r
b930	65 73 75 6c 74 2e 54 72  61 64 65 73 29 20 2d 20   esult.Trades) - 
b940	31 3b 20 69 20 3e 3d 20  30 3b 20 69 2d 2d 20 7b   1; i >= 0; i-- {
b950	0a 09 09 09 69 66 20 72  65 73 75 6c 74 2e 54 72   ....if result.Tr
b960	61 64 65 73 5b 69 5d 2e  53 79 6d 62 6f 6c 20 3d   ades[i].Symbol =
b970	3d 20 73 79 6d 62 6f 6c  20 26 26 20 72 65 73 75   = symbol && resu
b980	6c 74 2e 54 72 61 64 65  73 5b 69 5d 2e 53 69 64   lt.Trades[i].Sid
b990	65 20 3d 3d 20 22 62 75  79 22 20 26 26 20 72 65   e == "buy" && re
b9a0	73 75 6c 74 2e 54 72 61  64 65 73 5b 69 5d 2e 51   sult.Trades[i].Q
b9b0	75 61 6e 74 69 74 79 20  3d 3d 20 73 74 61 74 65   uantity == state
b9c0	2e 50 6f 73 69 74 69 6f  6e 20 7b 0a 09 09 09 09   .Position {.....
b9d0	65 6e 74 72 79 50 72 69  63 65 20 3d 20 72 65 73   entryPrice = res
b9e0	75 6c 74 2e 54 72 61 64  65 73 5b 69 5d 2e 50 72   ult.Trades[i].Pr
b9f0	69 63 65 0a 09 09 09 09  62 72 65 61 6b 0a 09 09   ice.....break...
ba00	09 7d 0a 09 09 7d 0a 0a  09 09 69 66 20 65 6e 74   .}...}....if ent
ba10	72 79 50 72 69 63 65 20  3c 3d 20 30 20 7b 0a 09   ryPrice <= 0 {..
ba20	09 09 63 6f 6e 74 69 6e  75 65 0a 09 09 7d 0a 0a   ..continue...}..
ba30	09 09 2f 2f 20 e6 a3 80  e6 9f a5 e6 ad a2 e6 8d   ..// ...........
ba40	9f 2f e6 ad a2 e7 9b 88  e6 9d a1 e4 bb b6 0a 09   ./..............
ba50	09 70 6e 6c 20 3a 3d 20  28 63 75 72 72 65 6e 74   .pnl := (current
ba60	50 72 69 63 65 20 2d 20  65 6e 74 72 79 50 72 69   Price - entryPri
ba70	63 65 29 20 2f 20 65 6e  74 72 79 50 72 69 63 65   ce) / entryPrice
ba80	0a 0a 09 09 73 68 6f 75  6c 64 45 78 69 74 20 3a   ....shouldExit :
ba90	3d 20 66 61 6c 73 65 0a  09 09 65 78 69 74 52 65   = false...exitRe
baa0	61 73 6f 6e 20 3a 3d 20  22 22 0a 0a 09 09 2f 2f   ason := ""....//
bab0	20 e5 8a a8 e6 80 81 e6  ad a2 e6 8d 9f ef bc 9a    ...............
bac0	e5 9f ba e4 ba 8e e5 b8  82 e5 9c ba e6 b3 a2 e5   ................
bad0	8a a8 e7 8e 87 e3 80 81  e6 8c 81 e4 bb 93 e6 97   ................
bae0	b6 e9 97 b4 e5 92 8c e5  b8 82 e5 9c ba e7 8e af   ................
baf0	e5 a2 83 e8 b0 83 e6 95  b4 0a 09 09 64 79 6e 61   ............dyna
bb00	6d 69 63 53 74 6f 70 4c  6f 73 73 20 3a 3d 20 63   micStopLoss := c
bb10	6f 6e 66 69 67 2e 53 74  6f 70 4c 6f 73 73 0a 0a   onfig.StopLoss..
bb20	09 09 2f 2f 20 3d 3d 3d  20 e5 b8 82 e5 9c ba e7   ..// === .......
bb30	8e af e5 a2 83 e6 a3 80  e6 b5 8b ef bc 88 e5 b7   ................
bb40	b2 e7 a7 bb e8 87 b3 e5  90 8e e9 9d a2 e7 bb 9f   ................
bb50	e4 b8 80 e5 a4 84 e7 90  86 ef bc 89 20 3d 3d 3d   ............ ===
bb60	0a 0a 09 09 2f 2f 20 e5  9f ba e4 ba 8e e6 8c 81   ....// .........
bb70	e4 bb 93 e6 97 b6 e9 97  b4 e8 b0 83 e6 95 b4 e6   ................
bb80	ad a2 e6 8d 9f ef bc 88  e9 81 bf e5 85 8d e8 bf   ................
bb90	87 e6 97 a9 e6 ad a2 e6  8d 9f ef bc 89 0a 09 09   ................
bba0	69 66 20 73 74 61 74 65  2e 48 6f 6c 64 54 69 6d   if state.HoldTim
bbb0	65 20 3e 20 37 32 20 7b  20 2f 2f 20 e6 8c 81 e6   e > 72 { // ....
bbc0	9c 89 e8 b6 85 e8 bf 87  37 32 e5 91 a8 e6 9c 9f   ........72......
bbd0	ef bc 88 e7 ba a6 33 e5  a4 a9 ef bc 89 0a 09 09   ......3.........
bbe0	09 64 79 6e 61 6d 69 63  53 74 6f 70 4c 6f 73 73   .dynamicStopLoss
bbf0	20 2a 3d 20 31 2e 35 20  2f 2f 20 e9 80 82 e5 ba    *= 1.5 // .....
bc00	a6 e6 94 be e5 ae bd e6  ad a2 e6 8d 9f ef bc 8c   ................
bc10	e7 bb 99 e6 9b b4 e5 a4  9a e6 97 b6 e9 97 b4 0a   ................
bc20	09 09 7d 20 65 6c 73 65  20 69 66 20 73 74 61 74   ..} else if stat
bc30	65 2e 48 6f 6c 64 54 69  6d 65 20 3e 20 34 38 20   e.HoldTime > 48 
bc40	7b 20 2f 2f 20 e6 8c 81  e6 9c 89 e8 b6 85 e8 bf   { // ...........
bc50	87 34 38 e5 91 a8 e6 9c  9f ef bc 88 e7 ba a6 32   .48............2
bc60	e5 a4 a9 ef bc 89 0a 09  09 09 64 79 6e 61 6d 69   ..........dynami
bc70	63 53 74 6f 70 4c 6f 73  73 20 2a 3d 20 31 2e 33   cStopLoss *= 1.3
bc80	20 2f 2f 20 e8 bd bb e5  be ae e6 94 be e5 ae bd    // ............
bc90	e6 ad a2 e6 8d 9f 0a 09  09 7d 20 65 6c 73 65 20   .........} else 
bca0	69 66 20 73 74 61 74 65  2e 48 6f 6c 64 54 69 6d   if state.HoldTim
bcb0	65 20 3e 20 32 34 20 7b  20 2f 2f 20 e6 8c 81 e6   e > 24 { // ....
bcc0	9c 89 e8 b6 85 e8 bf 87  32 34 e5 91 a8 e6 9c 9f   ........24......
bcd0	0a 09 09 09 64 79 6e 61  6d 69 63 53 74 6f 70 4c   ....dynamicStopL
bce0	6f 73 73 20 2a 3d 20 31  2e 32 20 2f 2f 20 e5 b0   oss *= 1.2 // ..
bcf0	91 e9 87 8f e6 94 be e5  ae bd e6 ad a2 e6 8d 9f   ................
bd00	0a 09 09 7d 20 65 6c 73  65 20 69 66 20 73 74 61   ...} else if sta
bd10	74 65 2e 48 6f 6c 64 54  69 6d 65 20 3c 20 36 20   te.HoldTime < 6 
bd20	7b 20 2f 2f 20 e6 8c 81  e6 9c 89 e5 b0 91 e4 ba   { // ...........
bd30	8e 36 e5 91 a8 e6 9c 9f  0a 09 09 09 64 79 6e 61   .6..........dyna
bd40	6d 69 63 53 74 6f 70 4c  6f 73 73 20 2a 3d 20 30   micStopLoss *= 0
bd50	2e 38 20 2f 2f 20 e7 a8  8d e5 be ae e6 94 b6 e7   .8 // ..........
bd60	b4 a7 e6 ad a2 e6 8d 9f  0a 09 09 7d 0a 0a 09 09   ...........}....
bd70	2f 2f 20 3d 3d 3d 20 e5  b8 82 e5 9c ba e7 8e af   // === .........
bd80	e5 a2 83 e6 99 ba e8 83  bd e6 ad a2 e6 8d 9f e8   ................
bd90	b0 83 e6 95 b4 20 3d 3d  3d 0a 09 09 6d 61 72 6b   ..... ===...mark
bda0	65 74 52 65 67 69 6d 65  20 3a 3d 20 62 65 2e 67   etRegime := be.g
bdb0	65 74 43 75 72 72 65 6e  74 4d 61 72 6b 65 74 52   etCurrentMarketR
bdc0	65 67 69 6d 65 28 29 0a  0a 09 09 73 77 69 74 63   egime()....switc
bdd0	68 20 6d 61 72 6b 65 74  52 65 67 69 6d 65 20 7b   h marketRegime {
bde0	0a 09 09 63 61 73 65 20  22 73 74 72 6f 6e 67 5f   ...case "strong_
bdf0	62 65 61 72 22 3a 0a 09  09 09 64 79 6e 61 6d 69   bear":....dynami
be00	63 53 74 6f 70 4c 6f 73  73 20 2a 3d 20 30 2e 35   cStopLoss *= 0.5
be10	20 2f 2f 20 e5 bc ba e7  86 8a e5 b8 82 ef bc 9a    // ............
be20	e6 94 b6 e7 b4 a7 e6 ad  a2 e6 8d 9f e5 88 b0 35   ...............5
be30	30 25 ef bc 8c e9 98 b2  e6 ad a2 e7 81 be e9 9a   0%..............
be40	be e6 80 a7 e4 ba 8f e6  8d 9f 0a 09 09 09 6c 6f   ..............lo
be50	67 2e 50 72 69 6e 74 66  28 22 5b 4d 41 52 4b 45   g.Printf("[MARKE
be60	54 5f 53 54 4f 50 4c 4f  53 53 5d 20 25 73 e5 bc   T_STOPLOSS] %s..
be70	ba e7 86 8a e5 b8 82 e7  8e af e5 a2 83 ef bc 8c   ................
be80	e6 ad a2 e6 8d 9f e4 bb  8e 25 2e 33 66 25 25 e6   .........%.3f%%.
be90	94 b6 e7 b4 a7 e5 88 b0  25 2e 33 66 25 25 22 2c   ........%.3f%%",
bea0	0a 09 09 09 09 73 79 6d  62 6f 6c 2c 20 63 6f 6e   .....symbol, con
beb0	66 69 67 2e 53 74 6f 70  4c 6f 73 73 2a 31 30 30   fig.StopLoss*100
bec0	2c 20 64 79 6e 61 6d 69  63 53 74 6f 70 4c 6f 73   , dynamicStopLos
bed0	73 2a 31 30 30 29 0a 09  09 63 61 73 65 20 22 77   s*100)...case "w
bee0	65 61 6b 5f 62 65 61 72  22 3a 0a 09 09 09 64 79   eak_bear":....dy
bef0	6e 61 6d 69 63 53 74 6f  70 4c 6f 73 73 20 2a 3d   namicStopLoss *=
bf00	20 30 2e 38 20 2f 2f 20  e5 bc b1 e7 86 8a e5 b8    0.8 // ........
bf10	82 ef bc 9a e6 94 b6 e7  b4 a7 e6 ad a2 e6 8d 9f   ................
bf20	e5 88 b0 38 30 25 ef bc  8c e9 99 8d e4 bd 8e e9   ...80%..........
bf30	a3 8e e9 99 a9 0a 09 09  09 6c 6f 67 2e 50 72 69   .........log.Pri
bf40	6e 74 66 28 22 5b 4d 41  52 4b 45 54 5f 53 54 4f   ntf("[MARKET_STO
bf50	50 4c 4f 53 53 5d 20 25  73 e5 bc b1 e7 86 8a e5   PLOSS] %s.......
bf60	b8 82 e7 8e af e5 a2 83  ef bc 8c e6 ad a2 e6 8d   ................
bf70	9f e4 bb 8e 25 2e 33 66  25 25 e6 94 b6 e7 b4 a7   ....%.3f%%......
bf80	e5 88 b0 25 2e 33 66 25  25 22 2c 0a 09 09 09 09   ...%.3f%%",.....
bf90	73 79 6d 62 6f 6c 2c 20  63 6f 6e 66 69 67 2e 53   symbol, config.S
bfa0	74 6f 70 4c 6f 73 73 2a  31 30 30 2c 20 64 79 6e   topLoss*100, dyn
bfb0	61 6d 69 63 53 74 6f 70  4c 6f 73 73 2a 31 30 30   amicStopLoss*100
bfc0	29 0a 09 09 63 61 73 65  20 22 73 69 64 65 77 61   )...case "sidewa
bfd0	79 73 22 3a 0a 09 09 09  64 79 6e 61 6d 69 63 53   ys":....dynamicS
bfe0	74 6f 70 4c 6f 73 73 20  2a 3d 20 30 2e 38 20 2f   topLoss *= 0.8 /
bff0	2f 20 e6 a8 aa e7 9b 98  e5 b8 82 e5 9c ba ef bc   / ..............
c000	9a e6 94 b6 e7 b4 a7 e6  ad a2 e6 8d 9f ef bc 8c   ................
c010	e9 81 bf e5 85 8d e8 a2  ab e9 9c 87 e8 8d a1 e6   ................
c020	b4 97 e5 87 ba 0a 09 09  09 6c 6f 67 2e 50 72 69   .........log.Pri
c030	6e 74 66 28 22 5b 4d 41  52 4b 45 54 5f 53 54 4f   ntf("[MARKET_STO
c040	50 4c 4f 53 53 5d 20 25  73 e6 a8 aa e7 9b 98 e5   PLOSS] %s.......
c050	b8 82 e5 9c ba e7 8e af  e5 a2 83 ef bc 8c e6 ad   ................
c060	a2 e6 8d 9f e4 bb 8e 25  2e 33 66 25 25 e6 94 b6   .......%.3f%%...
c070	e7 b4 a7 e5 88 b0 25 2e  33 66 25 25 22 2c 0a 09   ......%.3f%%",..
c080	09 09 09 73 79 6d 62 6f  6c 2c 20 63 6f 6e 66 69   ...symbol, confi
c090	67 2e 53 74 6f 70 4c 6f  73 73 2a 31 30 30 2c 20   g.StopLoss*100, 
c0a0	64 79 6e 61 6d 69 63 53  74 6f 70 4c 6f 73 73 2a   dynamicStopLoss*
c0b0	31 30 30 29 0a 09 09 63  61 73 65 20 22 6c 6f 77   100)...case "low
c0c0	5f 76 6f 6c 61 74 69 6c  69 74 79 22 3a 0a 09 09   _volatility":...
c0d0	09 64 79 6e 61 6d 69 63  53 74 6f 70 4c 6f 73 73   .dynamicStopLoss
c0e0	20 2a 3d 20 30 2e 37 20  2f 2f 20 e4 bd 8e e6 b3    *= 0.7 // .....
c0f0	a2 e5 8a a8 e7 8e af e5  a2 83 ef bc 9a e8 bf 9b   ................
c100	e4 b8 80 e6 ad a5 e6 94  b6 e7 b4 a7 e6 ad a2 e6   ................
c110	8d 9f 0a 09 09 09 6c 6f  67 2e 50 72 69 6e 74 66   ......log.Printf
c120	28 22 5b 4d 41 52 4b 45  54 5f 53 54 4f 50 4c 4f   ("[MARKET_STOPLO
c130	53 53 5d 20 25 73 e4 bd  8e e6 b3 a2 e5 8a a8 e7   SS] %s..........
c140	8e af e5 a2 83 ef bc 8c  e6 ad a2 e6 8d 9f e4 bb   ................
c150	8e 25 2e 33 66 25 25 e6  94 b6 e7 b4 a7 e5 88 b0   .%.3f%%.........
c160	25 2e 33 66 25 25 22 2c  0a 09 09 09 09 73 79 6d   %.3f%%",.....sym
c170	62 6f 6c 2c 20 63 6f 6e  66 69 67 2e 53 74 6f 70   bol, config.Stop
c180	4c 6f 73 73 2a 31 30 30  2c 20 64 79 6e 61 6d 69   Loss*100, dynami
c190	63 53 74 6f 70 4c 6f 73  73 2a 31 30 30 29 0a 09   cStopLoss*100)..
c1a0	09 63 61 73 65 20 22 73  74 72 6f 6e 67 5f 62 75   .case "strong_bu
c1b0	6c 6c 22 3a 0a 09 09 09  64 79 6e 61 6d 69 63 53   ll":....dynamicS
c1c0	74 6f 70 4c 6f 73 73 20  2a 3d 20 31 2e 32 20 2f   topLoss *= 1.2 /
c1d0	2f 20 e5 bc ba e7 89 9b  e5 b8 82 ef bc 9a e8 bd   / ..............
c1e0	bb e5 be ae e6 94 be e5  ae bd ef bc 8c e7 bb 99   ................
c1f0	e6 9b b4 e5 a4 9a e4 b8  8a e6 b6 a8 e7 a9 ba e9   ................
c200	97 b4 0a 09 09 09 6c 6f  67 2e 50 72 69 6e 74 66   ......log.Printf
c210	28 22 5b 4d 41 52 4b 45  54 5f 53 54 4f 50 4c 4f   ("[MARKET_STOPLO
c220	53 53 5d 20 25 73 e5 bc  ba e7 89 9b e5 b8 82 e7   SS] %s..........
c230	8e af e5 a2 83 ef bc 8c  e6 ad a2 e6 8d 9f e4 bb   ................
c240	8e 25 2e 33 66 25 25 e6  94 be e5 ae bd e5 88 b0   .%.3f%%.........
c250	25 2e 33 66 25 25 22 2c  0a 09 09 09 09 73 79 6d   %.3f%%",.....sym
c260	62 6f 6c 2c 20 63 6f 6e  66 69 67 2e 53 74 6f 70   bol, config.Stop
c270	4c 6f 73 73 2a 31 30 30  2c 20 64 79 6e 61 6d 69   Loss*100, dynami
c280	63 53 74 6f 70 4c 6f 73  73 2a 31 30 30 29 0a 09   cStopLoss*100)..
c290	09 63 61 73 65 20 22 77  65 61 6b 5f 62 75 6c 6c   .case "weak_bull
c2a0	22 3a 0a 09 09 09 64 79  6e 61 6d 69 63 53 74 6f   ":....dynamicSto
c2b0	70 4c 6f 73 73 20 2a 3d  20 31 2e 31 20 2f 2f 20   pLoss *= 1.1 // 
c2c0	e5 bc b1 e7 89 9b e5 b8  82 ef bc 9a e5 b0 8f e5   ................
c2d0	b9 85 e6 94 be e5 ae bd  0a 09 09 09 6c 6f 67 2e   ............log.
c2e0	50 72 69 6e 74 66 28 22  5b 4d 41 52 4b 45 54 5f   Printf("[MARKET_
c2f0	53 54 4f 50 4c 4f 53 53  5d 20 25 73 e5 bc b1 e7   STOPLOSS] %s....
c300	89 9b e5 b8 82 e7 8e af  e5 a2 83 ef bc 8c e6 ad   ................
c310	a2 e6 8d 9f e4 bb 8e 25  2e 33 66 25 25 e6 94 be   .......%.3f%%...
c320	e5 ae bd e5 88 b0 25 2e  33 66 25 25 22 2c 0a 09   ......%.3f%%",..
c330	09 09 09 73 79 6d 62 6f  6c 2c 20 63 6f 6e 66 69   ...symbol, confi
c340	67 2e 53 74 6f 70 4c 6f  73 73 2a 31 30 30 2c 20   g.StopLoss*100, 
c350	64 79 6e 61 6d 69 63 53  74 6f 70 4c 6f 73 73 2a   dynamicStopLoss*
c360	31 30 30 29 0a 09 09 63  61 73 65 20 22 6d 69 78   100)...case "mix
c370	65 64 22 3a 0a 09 09 09  2f 2f 20 e6 b7 b7 e5 90   ed":....// .....
c380	88 e5 b8 82 e5 9c ba ef  bc 9a e4 bf 9d e6 8c 81   ................
c390	e5 9f ba e7 a1 80 e6 ad  a2 e6 8d 9f 0a 09 09 09   ................
c3a0	6c 6f 67 2e 50 72 69 6e  74 66 28 22 5b 4d 41 52   log.Printf("[MAR
c3b0	4b 45 54 5f 53 54 4f 50  4c 4f 53 53 5d 20 25 73   KET_STOPLOSS] %s
c3c0	e6 b7 b7 e5 90 88 e5 b8  82 e5 9c ba e7 8e af e5   ................
c3d0	a2 83 ef bc 8c e4 bf 9d  e6 8c 81 e5 9f ba e7 a1   ................
c3e0	80 e6 ad a2 e6 8d 9f 25  2e 33 66 25 25 22 2c 0a   .......%.3f%%",.
c3f0	09 09 09 09 73 79 6d 62  6f 6c 2c 20 64 79 6e 61   ....symbol, dyna
c400	6d 69 63 53 74 6f 70 4c  6f 73 73 2a 31 30 30 29   micStopLoss*100)
c410	0a 09 09 64 65 66 61 75  6c 74 3a 0a 09 09 09 6c   ...default:....l
c420	6f 67 2e 50 72 69 6e 74  66 28 22 5b 4d 41 52 4b   og.Printf("[MARK
c430	45 54 5f 53 54 4f 50 4c  4f 53 53 5d 20 25 73 e6   ET_STOPLOSS] %s.
c440	9c aa e7 9f a5 e5 b8 82  e5 9c ba e7 8e af e5 a2   ................
c450	83 ef bc 8c e4 bd bf e7  94 a8 e4 bf 9d e5 ae 88   ................
c460	e6 ad a2 e6 8d 9f 25 2e  33 66 25 25 22 2c 0a 09   ......%.3f%%",..
c470	09 09 09 73 79 6d 62 6f  6c 2c 20 64 79 6e 61 6d   ...symbol, dynam
c480	69 63 53 74 6f 70 4c 6f  73 73 2a 31 30 30 29 0a   icStopLoss*100).
c490	09 09 7d 0a 0a 09 09 2f  2f 20 e5 9f ba e4 ba 8e   ..}....// ......
c4a0	e5 b8 82 e5 9c ba e6 b3  a2 e5 8a a8 e7 8e 87 e8   ................
c4b0	b0 83 e6 95 b4 ef bc 88  e5 a6 82 e6 9e 9c e6 9c   ................
c4c0	89 e8 b6 b3 e5 a4 9f e7  9a 84 e5 8e 86 e5 8f b2   ................
c4d0	e6 95 b0 e6 8d ae ef bc  89 0a 09 09 69 66 20 6c   ............if l
c4e0	65 6e 28 73 74 61 74 65  2e 44 61 74 61 29 20 3e   en(state.Data) >
c4f0	20 31 30 20 7b 0a 09 09  09 72 65 63 65 6e 74 50    10 {....recentP
c500	72 69 63 65 73 20 3a 3d  20 6d 61 6b 65 28 5b 5d   rices := make([]
c510	66 6c 6f 61 74 36 34 2c  20 30 2c 20 32 30 29 20   float64, 0, 20) 
c520	2f 2f 20 e5 a2 9e e5 8a  a0 e5 8e 86 e5 8f b2 e6   // .............
c530	95 b0 e6 8d ae e9 95 bf  e5 ba a6 0a 09 09 09 73   ...............s
c540	74 61 72 74 49 64 78 20  3a 3d 20 63 75 72 72 65   tartIdx := curre
c550	6e 74 49 6e 64 65 78 20  2d 20 31 39 0a 09 09 09   ntIndex - 19....
c560	69 66 20 73 74 61 72 74  49 64 78 20 3c 20 30 20   if startIdx < 0 
c570	7b 0a 09 09 09 09 73 74  61 72 74 49 64 78 20 3d   {.....startIdx =
c580	20 30 0a 09 09 09 7d 0a  09 09 09 66 6f 72 20 69    0....}....for i
c590	20 3a 3d 20 73 74 61 72  74 49 64 78 3b 20 69 20    := startIdx; i 
c5a0	3c 3d 20 63 75 72 72 65  6e 74 49 6e 64 65 78 3b   <= currentIndex;
c5b0	20 69 2b 2b 20 7b 0a 09  09 09 09 72 65 63 65 6e    i++ {.....recen
c5c0	74 50 72 69 63 65 73 20  3d 20 61 70 70 65 6e 64   tPrices = append
c5d0	28 72 65 63 65 6e 74 50  72 69 63 65 73 2c 20 73   (recentPrices, s
c5e0	74 61 74 65 2e 44 61 74  61 5b 69 5d 2e 50 72 69   tate.Data[i].Pri
c5f0	63 65 29 0a 09 09 09 7d  0a 0a 09 09 09 69 66 20   ce)....}.....if 
c600	6c 65 6e 28 72 65 63 65  6e 74 50 72 69 63 65 73   len(recentPrices
c610	29 20 3e 3d 20 31 30 20  7b 0a 09 09 09 09 76 6f   ) >= 10 {.....vo
c620	6c 61 74 69 6c 69 74 79  20 3a 3d 20 63 61 6c 63   latility := calc
c630	75 6c 61 74 65 50 72 69  63 65 56 6f 6c 61 74 69   ulatePriceVolati
c640	6c 69 74 79 28 72 65 63  65 6e 74 50 72 69 63 65   lity(recentPrice
c650	73 29 0a 09 09 09 09 69  66 20 76 6f 6c 61 74 69   s).....if volati
c660	6c 69 74 79 20 3e 20 30  2e 30 35 20 7b 20 2f 2f   lity > 0.05 { //
c670	20 e9 ab 98 e6 b3 a2 e5  8a a8 e7 8e af e5 a2 83    ...............
c680	ef bc 88 e5 8a a0 e5 af  86 e8 b4 a7 e5 b8 81 e5   ................
c690	b8 b8 e8 a7 81 ef bc 89  0a 09 09 09 09 09 64 79   ..............dy
c6a0	6e 61 6d 69 63 53 74 6f  70 4c 6f 73 73 20 2a 3d   namicStopLoss *=
c6b0	20 31 2e 33 20 2f 2f 20  e9 80 82 e5 ba a6 e6 94    1.3 // ........
c6c0	be e5 ae bd e6 ad a2 e6  8d 9f ef bc 8c e9 81 bf   ................
c6d0	e5 85 8d e8 bf 87 e5 ba  a6 e5 ae bd e6 9d be 0a   ................
c6e0	09 09 09 09 7d 20 65 6c  73 65 20 69 66 20 76 6f   ....} else if vo
c6f0	6c 61 74 69 6c 69 74 79  20 3e 20 30 2e 30 33 20   latility > 0.03 
c700	7b 20 2f 2f 20 e4 b8 ad  e7 ad 89 e6 b3 a2 e5 8a   { // ...........
c710	a8 e7 8e af e5 a2 83 0a  09 09 09 09 09 64 79 6e   .............dyn
c720	61 6d 69 63 53 74 6f 70  4c 6f 73 73 20 2a 3d 20   amicStopLoss *= 
c730	31 2e 32 20 2f 2f 20 e8  bd bb e5 be ae e6 94 be   1.2 // .........
c740	e5 ae bd e6 ad a2 e6 8d  9f 0a 09 09 09 09 7d 20   ..............} 
c750	65 6c 73 65 20 69 66 20  76 6f 6c 61 74 69 6c 69   else if volatili
c760	74 79 20 3c 20 30 2e 30  31 20 7b 20 2f 2f 20 e6   ty < 0.01 { // .
c770	9e 81 e4 bd 8e e6 b3 a2  e5 8a a8 e7 8e af e5 a2   ................
c780	83 0a 09 09 09 09 09 64  79 6e 61 6d 69 63 53 74   .......dynamicSt
c790	6f 70 4c 6f 73 73 20 2a  3d 20 30 2e 37 20 2f 2f   opLoss *= 0.7 //
c7a0	20 e6 94 b6 e7 b4 a7 e6  ad a2 e6 8d 9f 0a 09 09    ...............
c7b0	09 09 7d 0a 09 09 09 7d  0a 09 09 7d 0a 0a 09 09   ..}....}...}....
c7c0	2f 2f 20 e7 a1 ae e4 bf  9d e6 ad a2 e6 8d 9f e9   // .............
c7d0	98 88 e5 80 bc e5 9c a8  e5 90 88 e7 90 86 e8 8c   ................
c7e0	83 e5 9b b4 e5 86 85 ef  bc 88 35 25 2d 31 35 25   ..........5%-15%
c7f0	ef bc 89 0a 09 09 6d 69  6e 53 74 6f 70 4c 6f 73   ......minStopLos
c800	73 20 3a 3d 20 30 2e 30  35 20 2f 2f 20 35 25 e7   s := 0.05 // 5%.
c810	9a 84 e6 9c 80 e5 b0 8f  e6 ad a2 e6 8d 9f e9 98   ................
c820	88 e5 80 bc 0a 09 09 6d  61 78 53 74 6f 70 4c 6f   .......maxStopLo
c830	73 73 20 3a 3d 20 30 2e  31 35 20 2f 2f 20 31 35   ss := 0.15 // 15
c840	25 e7 9a 84 e6 9c 80 e5  a4 a7 e6 ad a2 e6 8d 9f   %...............
c850	e9 98 88 e5 80 bc ef bc  8c e9 98 b2 e6 ad a2 e7   ................
c860	81 be e9 9a be e6 80 a7  e4 ba 8f e6 8d 9f 0a 0a   ................
c870	09 09 69 66 20 6d 61 74  68 2e 41 62 73 28 64 79   ..if math.Abs(dy
c880	6e 61 6d 69 63 53 74 6f  70 4c 6f 73 73 29 20 3c   namicStopLoss) <
c890	20 6d 69 6e 53 74 6f 70  4c 6f 73 73 20 7b 0a 09    minStopLoss {..
c8a0	09 09 69 66 20 64 79 6e  61 6d 69 63 53 74 6f 70   ..if dynamicStop
c8b0	4c 6f 73 73 20 3c 20 30  20 7b 0a 09 09 09 09 64   Loss < 0 {.....d
c8c0	79 6e 61 6d 69 63 53 74  6f 70 4c 6f 73 73 20 3d   ynamicStopLoss =
c8d0	20 2d 6d 69 6e 53 74 6f  70 4c 6f 73 73 0a 09 09    -minStopLoss...
c8e0	09 7d 20 65 6c 73 65 20  7b 0a 09 09 09 09 64 79   .} else {.....dy
c8f0	6e 61 6d 69 63 53 74 6f  70 4c 6f 73 73 20 3d 20   namicStopLoss = 
c900	6d 69 6e 53 74 6f 70 4c  6f 73 73 0a 09 09 09 7d   minStopLoss....}
c910	0a 09 09 7d 20 65 6c 73  65 20 69 66 20 6d 61 74   ...} else if mat
c920	68 2e 41 62 73 28 64 79  6e 61 6d 69 63 53 74 6f   h.Abs(dynamicSto
c930	70 4c 6f 73 73 29 20 3e  20 6d 61 78 53 74 6f 70   pLoss) > maxStop
c940	4c 6f 73 73 20 7b 0a 09  09 09 69 66 20 64 79 6e   Loss {....if dyn
c950	61 6d 69 63 53 74 6f 70  4c 6f 73 73 20 3c 20 30   amicStopLoss < 0
c960	20 7b 0a 09 09 09 09 64  79 6e 61 6d 69 63 53 74    {.....dynamicSt
c970	6f 70 4c 6f 73 73 20 3d  20 2d 6d 61 78 53 74 6f   opLoss = -maxSto
c980	70 4c 6f 73 73 0a 09 09  09 7d 20 65 6c 73 65 20   pLoss....} else 
c990	7b 0a 09 09 09 09 64 79  6e 61 6d 69 63 53 74 6f   {.....dynamicSto
c9a0	70 4c 6f 73 73 20 3d 20  6d 61 78 53 74 6f 70 4c   pLoss = maxStopL
c9b0	6f 73 73 0a 09 09 09 7d  0a 09 09 7d 0a 0a 09 09   oss....}...}....
c9c0	2f 2f 20 e6 a3 80 e6 9f  a5 e6 9c 80 e5 b0 8f e6   // .............
c9d0	8c 81 e4 bb 93 e6 97 b6  e9 97 b4 ef bc 88 e9 81   ................
c9e0	bf e5 85 8d e8 bf 87 e4  ba 8e e9 a2 91 e7 b9 81   ................
c9f0	e7 9a 84 e4 ba a4 e6 98  93 ef bc 89 0a 09 09 6d   ...............m
ca00	69 6e 48 6f 6c 64 54 69  6d 65 20 3a 3d 20 36 20   inHoldTime := 6 
ca10	20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20                   
ca20	20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20                   
ca30	2f 2f 20 e6 9c 80 e5 b0  91 e6 8c 81 e6 9c 89 36   // ............6
ca40	e4 b8 aa e5 91 a8 e6 9c  9f ef bc 88 e7 ba a6 36   ...............6
ca50	e5 b0 8f e6 97 b6 ef bc  89 0a 09 09 69 66 20 73   ............if s
ca60	74 61 74 65 2e 48 6f 6c  64 54 69 6d 65 20 3c 20   tate.HoldTime < 
ca70	6d 69 6e 48 6f 6c 64 54  69 6d 65 20 26 26 20 70   minHoldTime && p
ca80	6e 6c 20 3e 20 2d 30 2e  30 32 20 7b 20 2f 2f 20   nl > -0.02 { // 
ca90	e5 a6 82 e6 9e 9c e4 ba  8f e6 8d 9f e8 b6 85 e8   ................
caa0	bf 87 32 25 ef bc 8c e4  b8 8d e5 8f 97 e6 9c 80   ..2%............
cab0	e5 b0 8f e6 8c 81 e4 bb  93 e6 97 b6 e9 97 b4 e9   ................
cac0	99 90 e5 88 b6 0a 09 09  09 63 6f 6e 74 69 6e 75   .........continu
cad0	65 20 2f 2f 20 e8 b7 b3  e8 bf 87 e8 bf 99 e6 ac   e // ...........
cae0	a1 e6 a3 80 e6 9f a5 ef  bc 8c e7 bb a7 e7 bb ad   ................
caf0	e6 8c 81 e6 9c 89 0a 09  09 7d 0a 0a 09 09 69 66   .........}....if
cb00	20 70 6e 6c 20 3c 3d 20  2d 6d 61 74 68 2e 41 62    pnl <= -math.Ab
cb10	73 28 64 79 6e 61 6d 69  63 53 74 6f 70 4c 6f 73   s(dynamicStopLos
cb20	73 29 20 7b 0a 09 09 09  73 68 6f 75 6c 64 45 78   s) {....shouldEx
cb30	69 74 20 3d 20 74 72 75  65 0a 09 09 09 65 78 69   it = true....exi
cb40	74 52 65 61 73 6f 6e 20  3d 20 66 6d 74 2e 53 70   tReason = fmt.Sp
cb50	72 69 6e 74 66 28 22 e5  a4 9a e5 b8 81 e7 a7 8d   rintf(".........
cb60	e6 ad a2 e6 8d 9f 28 e5  8a a8 e6 80 81 e9 98 88   ......(.........
cb70	e5 80 bc 3a 25 2e 33 66  25 25 29 22 2c 20 64 79   ...:%.3f%%)", dy
cb80	6e 61 6d 69 63 53 74 6f  70 4c 6f 73 73 2a 31 30   namicStopLoss*10
cb90	30 29 0a 09 09 7d 20 65  6c 73 65 20 69 66 20 70   0)...} else if p
cba0	6e 6c 20 3e 3d 20 63 6f  6e 66 69 67 2e 54 61 6b   nl >= config.Tak
cbb0	65 50 72 6f 66 69 74 20  7b 0a 09 09 09 73 68 6f   eProfit {....sho
cbc0	75 6c 64 45 78 69 74 20  3d 20 74 72 75 65 0a 09   uldExit = true..
cbd0	09 09 65 78 69 74 52 65  61 73 6f 6e 20 3d 20 22   ..exitReason = "
cbe0	e5 a4 9a e5 b8 81 e7 a7  8d e6 ad a2 e7 9b 88 22   ..............."
cbf0	0a 09 09 7d 20 65 6c 73  65 20 69 66 20 73 74 61   ...} else if sta
cc00	74 65 2e 48 6f 6c 64 54  69 6d 65 20 3e 3d 20 63   te.HoldTime >= c
cc10	6f 6e 66 69 67 2e 4d 61  78 48 6f 6c 64 54 69 6d   onfig.MaxHoldTim
cc20	65 20 7b 0a 09 09 09 2f  2f 20 e6 a0 b9 e6 8d ae   e {....// ......
cc30	e4 ba a4 e6 98 93 e7 b1  bb e5 9e 8b e8 b0 83 e6   ................
cc40	95 b4 e8 b6 85 e6 97 b6  e5 b9 b3 e4 bb 93 e7 ad   ................
cc50	96 e7 95 a5 0a 09 09 09  69 73 41 72 62 69 74 72   ........isArbitr
cc60	61 67 65 54 72 61 64 65  20 3a 3d 20 73 74 72 69   ageTrade := stri
cc70	6e 67 73 2e 43 6f 6e 74  61 69 6e 73 28 73 74 61   ngs.Contains(sta
cc80	74 65 2e 52 65 61 73 6f  6e 2c 20 22 e5 a5 97 e5   te.Reason, "....
cc90	88 a9 22 29 20 7c 7c 0a  09 09 09 09 73 74 72 69   ..") ||.....stri
cca0	6e 67 73 2e 43 6f 6e 74  61 69 6e 73 28 73 74 61   ngs.Contains(sta
ccb0	74 65 2e 52 65 61 73 6f  6e 2c 20 22 73 74 61 74   te.Reason, "stat
ccc0	69 73 74 69 63 61 6c 22  29 20 7c 7c 0a 09 09 09   istical") ||....
ccd0	09 73 74 72 69 6e 67 73  2e 43 6f 6e 74 61 69 6e   .strings.Contain
cce0	73 28 73 74 61 74 65 2e  52 65 61 73 6f 6e 2c 20   s(state.Reason, 
ccf0	22 63 6f 72 72 65 6c 61  74 69 6f 6e 22 29 0a 0a   "correlation")..
cd00	09 09 09 2f 2f 20 e5 af  b9 e4 ba 8e e5 a5 97 e5   ...// ..........
cd10	88 a9 e4 ba a4 e6 98 93  ef bc 8c e5 85 81 e8 ae   ................
cd20	b8 e6 9b b4 e9 95 bf e7  9a 84 e6 8c 81 e6 9c 89   ................
cd30	e6 97 b6 e9 97 b4 0a 09  09 09 65 66 66 65 63 74   ..........effect
cd40	69 76 65 4d 61 78 48 6f  6c 64 54 69 6d 65 20 3a   iveMaxHoldTime :
cd50	3d 20 63 6f 6e 66 69 67  2e 4d 61 78 48 6f 6c 64   = config.MaxHold
cd60	54 69 6d 65 0a 09 09 09  69 66 20 69 73 41 72 62   Time....if isArb
cd70	69 74 72 61 67 65 54 72  61 64 65 20 7b 0a 09 09   itrageTrade {...
cd80	09 09 65 66 66 65 63 74  69 76 65 4d 61 78 48 6f   ..effectiveMaxHo
cd90	6c 64 54 69 6d 65 20 3d  20 69 6e 74 28 66 6c 6f   ldTime = int(flo
cda0	61 74 36 34 28 63 6f 6e  66 69 67 2e 4d 61 78 48   at64(config.MaxH
cdb0	6f 6c 64 54 69 6d 65 29  20 2a 20 31 2e 35 29 20   oldTime) * 1.5) 
cdc0	2f 2f 20 e5 a5 97 e5 88  a9 e4 ba a4 e6 98 93 e5   // .............
cdd0	bb b6 e9 95 bf 35 30 25  e6 97 b6 e9 97 b4 0a 09   .....50%........
cde0	09 09 7d 0a 0a 09 09 09  2f 2f 20 e5 8f aa e6 9c   ..}.....// .....
cdf0	89 e5 9c a8 e4 ba 8f e6  8d 9f e7 9a 84 e6 83 85   ................
ce00	e5 86 b5 e4 b8 8b e6 89  8d e8 b6 85 e6 97 b6 e5   ................
ce10	b9 b3 e4 bb 93 0a 09 09  09 69 66 20 70 6e 6c 20   .........if pnl 
ce20	3c 20 2d 30 2e 30 31 20  26 26 20 73 74 61 74 65   < -0.01 && state
ce30	2e 48 6f 6c 64 54 69 6d  65 20 3e 3d 20 65 66 66   .HoldTime >= eff
ce40	65 63 74 69 76 65 4d 61  78 48 6f 6c 64 54 69 6d   ectiveMaxHoldTim
ce50	65 20 7b 20 2f 2f 20 e4  ba 8f e6 8d 9f e8 b6 85   e { // .........
ce60	e8 bf 87 31 25 e4 b8 94  e8 b6 85 e6 97 b6 e9 97   ...1%...........
ce70	b4 0a 09 09 09 09 73 68  6f 75 6c 64 45 78 69 74   ......shouldExit
ce80	20 3d 20 74 72 75 65 0a  09 09 09 09 65 78 69 74    = true.....exit
ce90	52 65 61 73 6f 6e 20 3d  20 22 e5 a4 9a e5 b8 81   Reason = "......
cea0	e7 a7 8d e8 b6 85 e6 97  b6 e5 b9 b3 e4 bb 93 22   ..............."
ceb0	0a 09 09 09 7d 0a 09 09  09 2f 2f 20 e5 a6 82 e6   ....}....// ....
cec0	9e 9c e6 9c 89 e5 b0 8f  e5 b9 85 e7 9b 88 e5 88   ................
ced0	a9 ef bc 8c e7 bb 99 e6  9b b4 e5 a4 9a e6 97 b6   ................
cee0	e9 97 b4 e6 8c 81 e6 9c  89 ef bc 88 e8 87 b3 e5   ................
cef0	b0 91 e7 ad 89 e5 88 b0  e9 a2 84 e6 9c 9f e6 94   ................
cf00	b6 e7 9b 8a ef bc 89 0a  09 09 7d 0a 0a 09 09 69   ..........}....i
cf10	66 20 73 68 6f 75 6c 64  45 78 69 74 20 7b 0a 09   f shouldExit {..
cf20	09 09 2f 2f 20 e6 89 a7  e8 a1 8c e5 b9 b3 e4 bb   ..// ...........
cf30	93 0a 09 09 09 63 6f 6d  6d 69 73 73 69 6f 6e 20   .....commission 
cf40	3a 3d 20 73 74 61 74 65  2e 50 6f 73 69 74 69 6f   := state.Positio
cf50	6e 20 2a 20 63 75 72 72  65 6e 74 50 72 69 63 65   n * currentPrice
cf60	20 2a 20 63 6f 6e 66 69  67 2e 43 6f 6d 6d 69 73    * config.Commis
cf70	73 69 6f 6e 0a 09 09 09  2a 61 76 61 69 6c 61 62   sion....*availab
cf80	6c 65 43 61 73 68 20 2b  3d 20 28 73 74 61 74 65   leCash += (state
cf90	2e 50 6f 73 69 74 69 6f  6e 2a 63 75 72 72 65 6e   .Position*curren
cfa0	74 50 72 69 63 65 20 2d  20 63 6f 6d 6d 69 73 73   tPrice - commiss
cfb0	69 6f 6e 29 0a 0a 09 09  09 2f 2f 20 e6 9b b4 e6   ion).....// ....
cfc0	96 b0 e4 ba a4 e6 98 93  e8 ae b0 e5 bd 95 0a 09   ................
cfd0	09 09 66 6f 72 20 69 20  3a 3d 20 6c 65 6e 28 72   ..for i := len(r
cfe0	65 73 75 6c 74 2e 54 72  61 64 65 73 29 20 2d 20   esult.Trades) - 
cff0	31 3b 20 69 20 3e 3d 20  30 3b 20 69 2d 2d 20 7b   1; i >= 0; i-- {
d000	0a 09 09 09 09 69 66 20  72 65 73 75 6c 74 2e 54   .....if result.T
d010	72 61 64 65 73 5b 69 5d  2e 53 79 6d 62 6f 6c 20   rades[i].Symbol 
d020	3d 3d 20 73 79 6d 62 6f  6c 20 26 26 20 72 65 73   == symbol && res
d030	75 6c 74 2e 54 72 61 64  65 73 5b 69 5d 2e 53 69   ult.Trades[i].Si
d040	64 65 20 3d 3d 20 22 62  75 79 22 20 26 26 20 72   de == "buy" && r
d050	65 73 75 6c 74 2e 54 72  61 64 65 73 5b 69 5d 2e   esult.Trades[i].
d060	50 6e 4c 20 3d 3d 20 30  20 7b 0a 09 09 09 09 09   PnL == 0 {......
d070	72 65 73 75 6c 74 2e 54  72 61 64 65 73 5b 69 5d   result.Trades[i]
d080	2e 50 6e 4c 20 3d 20 70  6e 6c 0a 09 09 09 09 09   .PnL = pnl......
d090	62 72 65 61 6b 0a 09 09  09 09 7d 0a 09 09 09 7d   break.....}....}
d0a0	0a 0a 09 09 09 2f 2f 20  e8 ae b0 e5 bd 95 e5 8d   .....// ........
d0b0	96 e5 87 ba e4 ba a4 e6  98 93 0a 09 09 09 72 65   ..............re
d0c0	73 75 6c 74 2e 54 72 61  64 65 73 20 3d 20 61 70   sult.Trades = ap
d0d0	70 65 6e 64 28 72 65 73  75 6c 74 2e 54 72 61 64   pend(result.Trad
d0e0	65 73 2c 20 54 72 61 64  65 52 65 63 6f 72 64 7b   es, TradeRecord{
d0f0	0a 09 09 09 09 53 79 6d  62 6f 6c 3a 20 20 20 20   .....Symbol:    
d100	20 20 20 73 79 6d 62 6f  6c 2c 0a 09 09 09 09 53      symbol,.....S
d110	69 64 65 3a 20 20 20 20  20 20 20 20 20 22 73 65   ide:         "se
d120	6c 6c 22 2c 0a 09 09 09  09 51 75 61 6e 74 69 74   ll",.....Quantit
d130	79 3a 20 20 20 20 20 73  74 61 74 65 2e 50 6f 73   y:     state.Pos
d140	69 74 69 6f 6e 2c 0a 09  09 09 09 50 72 69 63 65   ition,.....Price
d150	3a 20 20 20 20 20 20 20  20 63 75 72 72 65 6e 74   :        current
d160	50 72 69 63 65 2c 0a 09  09 09 09 54 69 6d 65 73   Price,.....Times
d170	74 61 6d 70 3a 20 20 20  20 74 69 6d 65 73 74 61   tamp:    timesta
d180	6d 70 2c 0a 09 09 09 09  43 6f 6d 6d 69 73 73 69   mp,.....Commissi
d190	6f 6e 3a 20 20 20 63 6f  6d 6d 69 73 73 69 6f 6e   on:   commission
d1a0	2c 0a 09 09 09 09 50 6e  4c 3a 20 20 20 20 20 20   ,.....PnL:      
d1b0	20 20 20 20 70 6e 6c 2c  0a 09 09 09 09 41 49 43       pnl,.....AIC
d1c0	6f 6e 66 69 64 65 6e 63  65 3a 20 30 2e 38 2c 20   onfidence: 0.8, 
d1d0	2f 2f 20 e5 b9 b3 e4 bb  93 e5 86 b3 e7 ad 96 e7   // .............
d1e0	bd ae e4 bf a1 e5 ba a6  0a 09 09 09 09 52 65 61   .............Rea
d1f0	73 6f 6e 3a 20 20 20 20  20 20 20 65 78 69 74 52   son:       exitR
d200	65 61 73 6f 6e 2c 0a 09  09 09 7d 29 0a 0a 09 09   eason,....})....
d210	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 4d 55   .log.Printf("[MU
d220	4c 54 49 5f 53 59 4d 42  4f 4c 5f 45 58 49 54 5d   LTI_SYMBOL_EXIT]
d230	20 e6 89 a7 e8 a1 8c e5  b9 b3 e4 bb 93 3a 20 25    ............: %
d240	73 2c 20 e4 bb b7 e6 a0  bc 3d 25 2e 34 66 2c 20   s, ......=%.4f, 
d250	e6 95 b0 e9 87 8f 3d 25  2e 34 66 2c 20 e7 9b 88   ......=%.4f, ...
d260	e4 ba 8f 3d 25 2e 32 66  25 25 2c 20 e5 8e 9f e5   ...=%.2f%%, ....
d270	9b a0 3d 25 73 22 2c 0a  09 09 09 09 73 79 6d 62   ..=%s",.....symb
d280	6f 6c 2c 20 63 75 72 72  65 6e 74 50 72 69 63 65   ol, currentPrice
d290	2c 20 73 74 61 74 65 2e  50 6f 73 69 74 69 6f 6e   , state.Position
d2a0	2c 20 70 6e 6c 2a 31 30  30 2c 20 65 78 69 74 52   , pnl*100, exitR
d2b0	65 61 73 6f 6e 29 0a 0a  09 09 09 2f 2f 20 e9 87   eason).....// ..
d2c0	8d e7 bd ae e7 8a b6 e6  80 81 0a 09 09 09 73 74   ..............st
d2d0	61 74 65 2e 50 6f 73 69  74 69 6f 6e 20 3d 20 30   ate.Position = 0
d2e0	0a 09 09 09 73 74 61 74  65 2e 48 6f 6c 64 54 69   ....state.HoldTi
d2f0	6d 65 20 3d 20 30 0a 09  09 7d 0a 09 7d 0a 7d 0a   me = 0...}..}.}.
d300	0a 2f 2f 20 63 61 6c 63  75 6c 61 74 65 4d 75 6c   .// calculateMul
d310	74 69 53 79 6d 62 6f 6c  53 74 61 74 73 20 e8 ae   tiSymbolStats ..
d320	a1 e7 ae 97 e5 a4 9a e5  b8 81 e7 a7 8d e7 bb 9f   ................
d330	e8 ae a1 e4 bf a1 e6 81  af ef bc 88 e5 a2 9e e5   ................
d340	bc ba e7 89 88 ef bc 89  0a 66 75 6e 63 20 28 62   .........func (b
d350	65 20 2a 42 61 63 6b 74  65 73 74 45 6e 67 69 6e   e *BacktestEngin
d360	65 29 20 63 61 6c 63 75  6c 61 74 65 4d 75 6c 74   e) calculateMult
d370	69 53 79 6d 62 6f 6c 53  74 61 74 73 28 72 65 73   iSymbolStats(res
d380	75 6c 74 20 2a 42 61 63  6b 74 65 73 74 52 65 73   ult *BacktestRes
d390	75 6c 74 2c 20 73 79 6d  62 6f 6c 53 74 61 74 65   ult, symbolState
d3a0	73 20 6d 61 70 5b 73 74  72 69 6e 67 5d 2a 53 79   s map[string]*Sy
d3b0	6d 62 6f 6c 53 74 61 74  65 29 20 7b 0a 09 66 6f   mbolState) {..fo
d3c0	72 20 73 79 6d 62 6f 6c  20 3a 3d 20 72 61 6e 67   r symbol := rang
d3d0	65 20 73 79 6d 62 6f 6c  53 74 61 74 65 73 20 7b   e symbolStates {
d3e0	0a 09 09 73 74 61 74 73  20 3a 3d 20 26 53 79 6d   ...stats := &Sym
d3f0	62 6f 6c 50 65 72 66 6f  72 6d 61 6e 63 65 7b 0a   bolPerformance{.
d400	09 09 09 53 79 6d 62 6f  6c 3a 20 73 79 6d 62 6f   ...Symbol: symbo
d410	6c 2c 0a 09 09 7d 0a 0a  09 09 2f 2f 20 e6 94 b6   l,...}....// ...
d420	e9 9b 86 e8 af a5 e5 b8  81 e7 a7 8d e7 9a 84 e6   ................
d430	89 80 e6 9c 89 e4 ba a4  e6 98 93 0a 09 09 76 61   ..............va
d440	72 20 74 72 61 64 65 73  20 5b 5d 54 72 61 64 65   r trades []Trade
d450	52 65 63 6f 72 64 0a 09  09 76 61 72 20 72 65 74   Record...var ret
d460	75 72 6e 73 20 5b 5d 66  6c 6f 61 74 36 34 0a 09   urns []float64..
d470	09 76 61 72 20 63 75 6d  75 6c 61 74 69 76 65 52   .var cumulativeR
d480	65 74 75 72 6e 73 20 5b  5d 66 6c 6f 61 74 36 34   eturns []float64
d490	0a 09 09 72 75 6e 6e 69  6e 67 54 6f 74 61 6c 20   ...runningTotal 
d4a0	3a 3d 20 30 2e 30 0a 09  09 74 6f 74 61 6c 57 69   := 0.0...totalWi
d4b0	6e 73 20 3a 3d 20 30 0a  09 09 74 6f 74 61 6c 4c   ns := 0...totalL
d4c0	6f 73 73 65 73 20 3a 3d  20 30 0a 09 09 74 6f 74   osses := 0...tot
d4d0	61 6c 43 6f 6d 70 6c 65  74 65 64 54 72 61 64 65   alCompletedTrade
d4e0	73 20 3a 3d 20 30 0a 0a  09 09 66 6f 72 20 5f 2c   s := 0....for _,
d4f0	20 74 72 61 64 65 20 3a  3d 20 72 61 6e 67 65 20    trade := range 
d500	72 65 73 75 6c 74 2e 54  72 61 64 65 73 20 7b 0a   result.Trades {.
d510	09 09 09 69 66 20 74 72  61 64 65 2e 53 79 6d 62   ...if trade.Symb
d520	6f 6c 20 3d 3d 20 73 79  6d 62 6f 6c 20 7b 0a 09   ol == symbol {..
d530	09 09 09 74 72 61 64 65  73 20 3d 20 61 70 70 65   ...trades = appe
d540	6e 64 28 74 72 61 64 65  73 2c 20 74 72 61 64 65   nd(trades, trade
d550	29 0a 0a 09 09 09 09 2f  2f 20 e5 8f aa e7 bb 9f   )......// ......
d560	e8 ae a1 e5 ae 9e e9 99  85 e7 9a 84 e4 ba a4 e6   ................
d570	98 93 e5 af b9 ef bc 88  e4 b9 b0 e5 85 a5 2b e5   ..............+.
d580	af b9 e5 ba 94 e7 9a 84  e5 8d 96 e5 87 ba e7 ae   ................
d590	97 e4 b8 80 e7 ac 94 e5  ae 8c e6 95 b4 e4 ba a4   ................
d5a0	e6 98 93 ef bc 89 0a 09  09 09 09 2f 2f 20 e6 88   ...........// ..
d5b0	96 e8 80 85 e7 ae 80 e5  8c 96 ef bc 9a e6 89 80   ................
d5c0	e6 9c 89 e4 ba a4 e6 98  93 e9 83 bd e7 ae 97 e4   ................
d5d0	bd 9c e6 80 bb e4 ba a4  e6 98 93 ef bc 8c e4 bd   ................
d5e0	86 e8 83 9c e7 8e 87 e5  8f aa e5 9f ba e4 ba 8e   ................
d5f0	e6 9c 89 50 6e 4c e7 9a  84 e4 ba a4 e6 98 93 0a   ...PnL..........
d600	09 09 09 09 73 74 61 74  73 2e 54 6f 74 61 6c 54   ....stats.TotalT
d610	72 61 64 65 73 2b 2b 0a  0a 09 09 09 09 2f 2f 20   rades++......// 
d620	e8 ae b0 e5 bd 95 e6 af  8f e7 ac 94 e4 ba a4 e6   ................
d630	98 93 e7 9a 84 e6 94 b6  e7 9b 8a ef bc 88 e5 8f   ................
d640	aa e7 bb 9f e8 ae a1 e6  9c 89 e5 ae 9e e9 99 85   ................
d650	e7 9b 88 e4 ba 8f e7 9a  84 e4 ba a4 e6 98 93 ef   ................
d660	bc 89 0a 09 09 09 09 69  66 20 74 72 61 64 65 2e   .......if trade.
d670	50 6e 4c 20 21 3d 20 30  20 7b 0a 09 09 09 09 09   PnL != 0 {......
d680	74 6f 74 61 6c 43 6f 6d  70 6c 65 74 65 64 54 72   totalCompletedTr
d690	61 64 65 73 2b 2b 0a 09  09 09 09 09 72 65 74 75   ades++......retu
d6a0	72 6e 73 20 3d 20 61 70  70 65 6e 64 28 72 65 74   rns = append(ret
d6b0	75 72 6e 73 2c 20 74 72  61 64 65 2e 50 6e 4c 29   urns, trade.PnL)
d6c0	0a 09 09 09 09 09 72 75  6e 6e 69 6e 67 54 6f 74   ......runningTot
d6d0	61 6c 20 2b 3d 20 74 72  61 64 65 2e 50 6e 4c 0a   al += trade.PnL.
d6e0	09 09 09 09 09 63 75 6d  75 6c 61 74 69 76 65 52   .....cumulativeR
d6f0	65 74 75 72 6e 73 20 3d  20 61 70 70 65 6e 64 28   eturns = append(
d700	63 75 6d 75 6c 61 74 69  76 65 52 65 74 75 72 6e   cumulativeReturn
d710	73 2c 20 72 75 6e 6e 69  6e 67 54 6f 74 61 6c 29   s, runningTotal)
d720	0a 0a 09 09 09 09 09 69  66 20 74 72 61 64 65 2e   .......if trade.
d730	50 6e 4c 20 3e 20 30 20  7b 0a 09 09 09 09 09 09   PnL > 0 {.......
d740	74 6f 74 61 6c 57 69 6e  73 2b 2b 0a 09 09 09 09   totalWins++.....
d750	09 7d 20 65 6c 73 65 20  69 66 20 74 72 61 64 65   .} else if trade
d760	2e 50 6e 4c 20 3c 20 30  20 7b 0a 09 09 09 09 09   .PnL < 0 {......
d770	09 74 6f 74 61 6c 4c 6f  73 73 65 73 2b 2b 0a 09   .totalLosses++..
d780	09 09 09 09 7d 0a 09 09  09 09 7d 0a 09 09 09 7d   ....}.....}....}
d790	0a 09 09 7d 0a 0a 09 09  2f 2f 20 e8 ae be e7 bd   ...}....// .....
d7a0	ae e8 83 9c e8 b4 9f e4  ba a4 e6 98 93 e6 ac a1   ................
d7b0	e6 95 b0 0a 09 09 73 74  61 74 73 2e 57 69 6e 6e   ......stats.Winn
d7c0	69 6e 67 54 72 61 64 65  73 20 3d 20 74 6f 74 61   ingTrades = tota
d7d0	6c 57 69 6e 73 0a 09 09  73 74 61 74 73 2e 4c 6f   lWins...stats.Lo
d7e0	73 69 6e 67 54 72 61 64  65 73 20 3d 20 74 6f 74   singTrades = tot
d7f0	61 6c 4c 6f 73 73 65 73  0a 0a 09 09 2f 2f 20 e8   alLosses....// .
d800	ae a1 e7 ae 97 e8 83 9c  e7 8e 87 0a 09 09 69 66   ..............if
d810	20 74 6f 74 61 6c 43 6f  6d 70 6c 65 74 65 64 54    totalCompletedT
d820	72 61 64 65 73 20 3e 20  30 20 7b 0a 09 09 09 73   rades > 0 {....s
d830	74 61 74 73 2e 57 69 6e  52 61 74 65 20 3d 20 66   tats.WinRate = f
d840	6c 6f 61 74 36 34 28 73  74 61 74 73 2e 57 69 6e   loat64(stats.Win
d850	6e 69 6e 67 54 72 61 64  65 73 29 20 2f 20 66 6c   ningTrades) / fl
d860	6f 61 74 36 34 28 74 6f  74 61 6c 43 6f 6d 70 6c   oat64(totalCompl
d870	65 74 65 64 54 72 61 64  65 73 29 0a 09 09 7d 0a   etedTrades)...}.
d880	0a 09 09 2f 2f 20 e8 ae  a1 e7 ae 97 e5 b9 b3 e5   ...// ..........
d890	9d 87 e7 9b 88 e4 ba 8f  0a 09 09 69 66 20 6c 65   ...........if le
d8a0	6e 28 72 65 74 75 72 6e  73 29 20 3e 20 30 20 7b   n(returns) > 0 {
d8b0	0a 09 09 09 74 6f 74 61  6c 52 65 74 75 72 6e 20   ....totalReturn 
d8c0	3a 3d 20 30 2e 30 0a 09  09 09 74 6f 74 61 6c 57   := 0.0....totalW
d8d0	69 6e 41 6d 6f 75 6e 74  20 3a 3d 20 30 2e 30 0a   inAmount := 0.0.
d8e0	09 09 09 74 6f 74 61 6c  4c 6f 73 73 41 6d 6f 75   ...totalLossAmou
d8f0	6e 74 20 3a 3d 20 30 2e  30 0a 0a 09 09 09 66 6f   nt := 0.0.....fo
d900	72 20 5f 2c 20 72 65 74  20 3a 3d 20 72 61 6e 67   r _, ret := rang
d910	65 20 72 65 74 75 72 6e  73 20 7b 0a 09 09 09 09   e returns {.....
d920	74 6f 74 61 6c 52 65 74  75 72 6e 20 2b 3d 20 72   totalReturn += r
d930	65 74 0a 09 09 09 09 69  66 20 72 65 74 20 3e 20   et.....if ret > 
d940	30 20 7b 0a 09 09 09 09  09 74 6f 74 61 6c 57 69   0 {......totalWi
d950	6e 41 6d 6f 75 6e 74 20  2b 3d 20 72 65 74 0a 09   nAmount += ret..
d960	09 09 09 7d 20 65 6c 73  65 20 7b 0a 09 09 09 09   ...} else {.....
d970	09 74 6f 74 61 6c 4c 6f  73 73 41 6d 6f 75 6e 74   .totalLossAmount
d980	20 2b 3d 20 6d 61 74 68  2e 41 62 73 28 72 65 74    += math.Abs(ret
d990	29 0a 09 09 09 09 7d 0a  09 09 09 7d 0a 0a 09 09   ).....}....}....
d9a0	09 73 74 61 74 73 2e 54  6f 74 61 6c 52 65 74 75   .stats.TotalRetu
d9b0	72 6e 20 3d 20 74 6f 74  61 6c 52 65 74 75 72 6e   rn = totalReturn
d9c0	0a 0a 09 09 09 69 66 20  73 74 61 74 73 2e 57 69   .....if stats.Wi
d9d0	6e 6e 69 6e 67 54 72 61  64 65 73 20 3e 20 30 20   nningTrades > 0 
d9e0	7b 0a 09 09 09 09 73 74  61 74 73 2e 41 76 67 57   {.....stats.AvgW
d9f0	69 6e 20 3d 20 74 6f 74  61 6c 57 69 6e 41 6d 6f   in = totalWinAmo
da00	75 6e 74 20 2f 20 66 6c  6f 61 74 36 34 28 73 74   unt / float64(st
da10	61 74 73 2e 57 69 6e 6e  69 6e 67 54 72 61 64 65   ats.WinningTrade
da20	73 29 0a 09 09 09 7d 0a  09 09 09 69 66 20 73 74   s)....}....if st
da30	61 74 73 2e 4c 6f 73 69  6e 67 54 72 61 64 65 73   ats.LosingTrades
da40	20 3e 20 30 20 7b 0a 09  09 09 09 73 74 61 74 73    > 0 {.....stats
da50	2e 41 76 67 4c 6f 73 73  20 3d 20 74 6f 74 61 6c   .AvgLoss = total
da60	4c 6f 73 73 41 6d 6f 75  6e 74 20 2f 20 66 6c 6f   LossAmount / flo
da70	61 74 36 34 28 73 74 61  74 73 2e 4c 6f 73 69 6e   at64(stats.Losin
da80	67 54 72 61 64 65 73 29  0a 09 09 09 7d 0a 0a 09   gTrades)....}...
da90	09 09 2f 2f 20 e8 ae a1  e7 ae 97 e8 83 9c e4 ba   ..// ...........
daa0	8f e6 af 94 0a 09 09 09  69 66 20 73 74 61 74 73   ........if stats
dab0	2e 41 76 67 4c 6f 73 73  20 3e 20 30 20 7b 0a 09   .AvgLoss > 0 {..
dac0	09 09 09 77 69 6e 4c 6f  73 73 52 61 74 69 6f 20   ...winLossRatio 
dad0	3a 3d 20 73 74 61 74 73  2e 41 76 67 57 69 6e 20   := stats.AvgWin 
dae0	2f 20 73 74 61 74 73 2e  41 76 67 4c 6f 73 73 0a   / stats.AvgLoss.
daf0	09 09 09 09 2f 2f 20 e5  ad 98 e5 82 a8 e5 9c a8   ....// .........
db00	50 72 6f 66 69 74 46 61  63 74 6f 72 e4 b8 ad e4   ProfitFactor....
db10	bd 9c e4 b8 ba e8 83 9c  e4 ba 8f e6 af 94 0a 09   ................
db20	09 09 09 69 66 20 73 74  61 74 73 2e 50 72 6f 66   ...if stats.Prof
db30	69 74 46 61 63 74 6f 72  20 3d 3d 20 30 20 7b 0a   itFactor == 0 {.
db40	09 09 09 09 09 73 74 61  74 73 2e 50 72 6f 66 69   .....stats.Profi
db50	74 46 61 63 74 6f 72 20  3d 20 77 69 6e 4c 6f 73   tFactor = winLos
db60	73 52 61 74 69 6f 0a 09  09 09 09 7d 0a 09 09 09   sRatio.....}....
db70	7d 0a 0a 09 09 09 2f 2f  20 e8 ae a1 e7 ae 97 e5   }.....// .......
db80	88 a9 e6 b6 a6 e5 9b a0  e5 ad 90 ef bc 88 e7 9b   ................
db90	88 e5 88 a9 e6 80 bb e9  a2 9d 2f e4 ba 8f e6 8d   ........../.....
dba0	9f e6 80 bb e9 a2 9d ef  bc 89 0a 09 09 09 69 66   ..............if
dbb0	20 74 6f 74 61 6c 4c 6f  73 73 41 6d 6f 75 6e 74    totalLossAmount
dbc0	20 3e 20 30 20 7b 0a 09  09 09 09 74 72 75 65 50    > 0 {.....trueP
dbd0	72 6f 66 69 74 46 61 63  74 6f 72 20 3a 3d 20 74   rofitFactor := t
dbe0	6f 74 61 6c 57 69 6e 41  6d 6f 75 6e 74 20 2f 20   otalWinAmount / 
dbf0	74 6f 74 61 6c 4c 6f 73  73 41 6d 6f 75 6e 74 0a   totalLossAmount.
dc00	09 09 09 09 69 66 20 73  74 61 74 73 2e 50 72 6f   ....if stats.Pro
dc10	66 69 74 46 61 63 74 6f  72 20 3d 3d 20 30 20 7b   fitFactor == 0 {
dc20	0a 09 09 09 09 09 73 74  61 74 73 2e 50 72 6f 66   ......stats.Prof
dc30	69 74 46 61 63 74 6f 72  20 3d 20 74 72 75 65 50   itFactor = trueP
dc40	72 6f 66 69 74 46 61 63  74 6f 72 0a 09 09 09 09   rofitFactor.....
dc50	7d 0a 09 09 09 7d 20 65  6c 73 65 20 69 66 20 74   }....} else if t
dc60	6f 74 61 6c 57 69 6e 41  6d 6f 75 6e 74 20 3e 20   otalWinAmount > 
dc70	30 20 7b 0a 09 09 09 09  73 74 61 74 73 2e 50 72   0 {.....stats.Pr
dc80	6f 66 69 74 46 61 63 74  6f 72 20 3d 20 31 30 2e   ofitFactor = 10.
dc90	30 20 2f 2f 20 e5 a6 82  e6 9e 9c e6 b2 a1 e6 9c   0 // ...........
dca0	89 e4 ba 8f e6 8d 9f ef  bc 8c e8 ae be e7 bd ae   ................
dcb0	e5 be 88 e9 ab 98 e7 9a  84 e5 88 a9 e6 b6 a6 e5   ................
dcc0	9b a0 e5 ad 90 0a 09 09  09 7d 0a 0a 09 09 09 2f   .........}...../
dcd0	2f 20 e8 ae a1 e7 ae 97  e6 9c 80 e5 a4 a7 e5 9b   / ..............
dce0	9e e6 92 a4 0a 09 09 09  73 74 61 74 73 2e 4d 61   ........stats.Ma
dcf0	78 44 72 61 77 64 6f 77  6e 20 3d 20 62 65 2e 63   xDrawdown = be.c
dd00	61 6c 63 75 6c 61 74 65  4d 61 78 44 72 61 77 64   alculateMaxDrawd
dd10	6f 77 6e 45 6e 68 61 6e  63 65 64 28 63 75 6d 75   ownEnhanced(cumu
dd20	6c 61 74 69 76 65 52 65  74 75 72 6e 73 29 0a 0a   lativeReturns)..
dd30	09 09 09 2f 2f 20 e8 ae  a1 e7 ae 97 e5 a4 8f e6   ...// ..........
dd40	99 ae e6 af 94 e7 8e 87  ef bc 88 e7 ae 80 e5 8c   ................
dd50	96 e7 9a 84 e5 b9 b4 e5  8c 96 e7 89 88 e6 9c ac   ................
dd60	ef bc 89 0a 09 09 09 69  66 20 6c 65 6e 28 72 65   .......if len(re
dd70	74 75 72 6e 73 29 20 3e  20 31 20 7b 0a 09 09 09   turns) > 1 {....
dd80	09 73 74 61 74 73 2e 53  68 61 72 70 65 52 61 74   .stats.SharpeRat
dd90	69 6f 20 3d 20 62 65 2e  63 61 6c 63 75 6c 61 74   io = be.calculat
dda0	65 53 68 61 72 70 65 52  61 74 69 6f 45 6e 68 61   eSharpeRatioEnha
ddb0	6e 63 65 64 28 72 65 74  75 72 6e 73 29 0a 09 09   nced(returns)...
ddc0	09 7d 0a 09 09 7d 0a 0a  09 09 72 65 73 75 6c 74   .}...}....result
ddd0	2e 53 79 6d 62 6f 6c 53  74 61 74 73 5b 73 79 6d   .SymbolStats[sym
dde0	62 6f 6c 5d 20 3d 20 73  74 61 74 73 0a 0a 09 09   bol] = stats....
ddf0	2f 2f 20 e5 a2 9e e5 bc  ba e7 9a 84 e7 bb 9f e8   // .............
de00	ae a1 e6 97 a5 e5 bf 97  e8 be 93 e5 87 ba 0a 09   ................
de10	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 4d 55   .log.Printf("[MU
de20	4c 54 49 5f 53 59 4d 42  4f 4c 5f 53 54 41 54 53   LTI_SYMBOL_STATS
de30	5f 45 4e 48 41 4e 43 45  44 5d 20 25 73 e8 af a6   _ENHANCED] %s...
de40	e7 bb 86 e7 bb 9f e8 ae  a1 3a 22 2c 0a 09 09 09   .........:",....
de50	73 79 6d 62 6f 6c 29 0a  09 09 6c 6f 67 2e 50 72   symbol)...log.Pr
de60	69 6e 74 66 28 22 20 20  e4 ba a4 e6 98 93 e7 bb   intf("  ........
de70	9f e8 ae a1 3a 20 e6 80  bb e4 ba a4 e6 98 93 3d   ....: .........=
de80	25 64 2c 20 e5 ae 8c e6  88 90 e4 ba a4 e6 98 93   %d, ............
de90	3d 25 64 2c 20 e8 83 9c  e7 8e 87 3d 25 2e 32 66   =%d, ......=%.2f
dea0	25 25 22 2c 0a 09 09 09  73 74 61 74 73 2e 54 6f   %%",....stats.To
deb0	74 61 6c 54 72 61 64 65  73 2c 20 74 6f 74 61 6c   talTrades, total
dec0	43 6f 6d 70 6c 65 74 65  64 54 72 61 64 65 73 2c   CompletedTrades,
ded0	20 73 74 61 74 73 2e 57  69 6e 52 61 74 65 2a 31    stats.WinRate*1
dee0	30 30 29 0a 09 09 2f 2f  20 e8 ae a1 e7 ae 97 e6   00)...// .......
def0	80 bb e6 94 b6 e7 9b 8a  e7 99 be e5 88 86 e6 af   ................
df00	94 ef bc 88 e5 9f ba e4  ba 8e e5 88 9d e5 a7 8b   ................
df10	e8 b5 84 e9 87 91 ef bc  89 0a 09 09 69 6e 69 74   ............init
df20	69 61 6c 43 61 73 68 20  3a 3d 20 72 65 73 75 6c   ialCash := resul
df30	74 2e 43 6f 6e 66 69 67  2e 49 6e 69 74 69 61 6c   t.Config.Initial
df40	43 61 73 68 0a 09 09 69  66 20 69 6e 69 74 69 61   Cash...if initia
df50	6c 43 61 73 68 20 3c 3d  20 30 20 7b 0a 09 09 09   lCash <= 0 {....
df60	69 6e 69 74 69 61 6c 43  61 73 68 20 3d 20 31 30   initialCash = 10
df70	30 30 30 2e 30 20 2f 2f  20 e9 bb 98 e8 ae a4 e5   000.0 // .......
df80	80 bc 0a 09 09 7d 0a 09  09 74 6f 74 61 6c 52 65   .....}...totalRe
df90	74 75 72 6e 50 65 72 63  65 6e 74 20 3a 3d 20 30   turnPercent := 0
dfa0	2e 30 0a 09 09 69 66 20  69 6e 69 74 69 61 6c 43   .0...if initialC
dfb0	61 73 68 20 3e 20 30 20  7b 0a 09 09 09 74 6f 74   ash > 0 {....tot
dfc0	61 6c 52 65 74 75 72 6e  50 65 72 63 65 6e 74 20   alReturnPercent 
dfd0	3d 20 28 73 74 61 74 73  2e 54 6f 74 61 6c 52 65   = (stats.TotalRe
dfe0	74 75 72 6e 20 2f 20 69  6e 69 74 69 61 6c 43 61   turn / initialCa
dff0	73 68 29 20 2a 20 31 30  30 0a 09 09 7d 0a 0a 09   sh) * 100...}...
e000	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 20 20 e6   .log.Printf("  .
e010	94 b6 e7 9b 8a e7 bb 9f  e8 ae a1 3a 20 e6 80 bb   ...........: ...
e020	e6 94 b6 e7 9b 8a 3d 25  2e 32 66 25 25 28 25 2e   ......=%.2f%%(%.
e030	32 66 29 2c 20 e5 b9 b3  e5 9d 87 e7 9b 88 e5 88   2f), ...........
e040	a9 3d 25 2e 34 66 2c 20  e5 b9 b3 e5 9d 87 e4 ba   .=%.4f, ........
e050	8f e6 8d 9f 3d 25 2e 34  66 22 2c 0a 09 09 09 74   ....=%.4f",....t
e060	6f 74 61 6c 52 65 74 75  72 6e 50 65 72 63 65 6e   otalReturnPercen
e070	74 2c 20 73 74 61 74 73  2e 54 6f 74 61 6c 52 65   t, stats.TotalRe
e080	74 75 72 6e 2c 20 73 74  61 74 73 2e 41 76 67 57   turn, stats.AvgW
e090	69 6e 2c 20 73 74 61 74  73 2e 41 76 67 4c 6f 73   in, stats.AvgLos
e0a0	73 29 0a 09 09 6c 6f 67  2e 50 72 69 6e 74 66 28   s)...log.Printf(
e0b0	22 20 20 e9 a3 8e e9 99  a9 e6 8c 87 e6 a0 87 3a   "  ............:
e0c0	20 e6 9c 80 e5 a4 a7 e5  9b 9e e6 92 a4 3d 25 2e    ............=%.
e0d0	32 66 25 25 2c 20 e5 a4  8f e6 99 ae e6 af 94 e7   2f%%, ..........
e0e0	8e 87 3d 25 2e 32 66 2c  20 e5 88 a9 e6 b6 a6 e5   ..=%.2f, .......
e0f0	9b a0 e5 ad 90 3d 25 2e  32 66 22 2c 0a 09 09 09   .....=%.2f",....
e100	73 74 61 74 73 2e 4d 61  78 44 72 61 77 64 6f 77   stats.MaxDrawdow
e110	6e 2a 31 30 30 2c 20 73  74 61 74 73 2e 53 68 61   n*100, stats.Sha
e120	72 70 65 52 61 74 69 6f  2c 20 73 74 61 74 73 2e   rpeRatio, stats.
e130	50 72 6f 66 69 74 46 61  63 74 6f 72 29 0a 09 7d   ProfitFactor)..}
e140	0a 0a 09 2f 2f 20 e6 b1  87 e6 80 bb e6 89 80 e6   ...// ..........
e150	9c 89 e5 b8 81 e7 a7 8d  e7 9a 84 e6 80 bb e6 94   ................
e160	b6 e7 9b 8a e5 88 b0 53  75 6d 6d 61 72 79 e4 b8   .......Summary..
e170	ad 0a 09 62 65 2e 61 67  67 72 65 67 61 74 65 4d   ...be.aggregateM
e180	75 6c 74 69 53 79 6d 62  6f 6c 52 65 73 75 6c 74   ultiSymbolResult
e190	73 28 72 65 73 75 6c 74  29 0a 7d 0a 0a 2f 2f 20   s(result).}..// 
e1a0	61 67 67 72 65 67 61 74  65 4d 75 6c 74 69 53 79   aggregateMultiSy
e1b0	6d 62 6f 6c 52 65 73 75  6c 74 73 20 e6 b1 87 e6   mbolResults ....
e1c0	80 bb e5 a4 9a e5 b8 81  e7 a7 8d e7 bb 93 e6 9e   ................
e1d0	9c e5 88 b0 e6 80 bb 53  75 6d 6d 61 72 79 0a 66   .......Summary.f
e1e0	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
e1f0	74 45 6e 67 69 6e 65 29  20 61 67 67 72 65 67 61   tEngine) aggrega
e200	74 65 4d 75 6c 74 69 53  79 6d 62 6f 6c 52 65 73   teMultiSymbolRes
e210	75 6c 74 73 28 72 65 73  75 6c 74 20 2a 42 61 63   ults(result *Bac
e220	6b 74 65 73 74 52 65 73  75 6c 74 29 20 7b 0a 09   ktestResult) {..
e230	74 6f 74 61 6c 50 6e 4c  20 3a 3d 20 30 2e 30 0a   totalPnL := 0.0.
e240	09 74 6f 74 61 6c 57 69  6e 6e 69 6e 67 54 72 61   .totalWinningTra
e250	64 65 73 20 3a 3d 20 30  0a 09 74 6f 74 61 6c 4c   des := 0..totalL
e260	6f 73 69 6e 67 54 72 61  64 65 73 20 3a 3d 20 30   osingTrades := 0
e270	0a 09 74 6f 74 61 6c 54  72 61 64 65 73 20 3a 3d   ..totalTrades :=
e280	20 30 0a 09 74 6f 74 61  6c 57 65 69 67 68 74 65    0..totalWeighte
e290	64 52 65 74 75 72 6e 20  3a 3d 20 30 2e 30 0a 09   dReturn := 0.0..
e2a0	74 6f 74 61 6c 57 65 69  67 68 74 20 3a 3d 20 30   totalWeight := 0
e2b0	2e 30 0a 0a 09 2f 2f 20  e6 b1 87 e6 80 bb e6 89   .0...// ........
e2c0	80 e6 9c 89 e5 b8 81 e7  a7 8d e7 9a 84 e6 94 b6   ................
e2d0	e7 9b 8a 20 2d 20 e6 ad  a3 e7 a1 ae e7 9a 84 e5   ... - ..........
e2e0	8a a0 e6 9d 83 e5 b9 b3  e5 9d 87 e8 ae a1 e7 ae   ................
e2f0	97 0a 09 66 6f 72 20 5f  2c 20 73 74 61 74 73 20   ...for _, stats 
e300	3a 3d 20 72 61 6e 67 65  20 72 65 73 75 6c 74 2e   := range result.
e310	53 79 6d 62 6f 6c 53 74  61 74 73 20 7b 0a 09 09   SymbolStats {...
e320	2f 2f 20 e7 b4 af e5 8a  a0 e7 bb 9d e5 af b9 e6   // .............
e330	94 b6 e7 9b 8a e7 94 a8  e4 ba 8e e6 98 be e7 a4   ................
e340	ba 0a 09 09 74 6f 74 61  6c 50 6e 4c 20 2b 3d 20   ....totalPnL += 
e350	73 74 61 74 73 2e 54 6f  74 61 6c 52 65 74 75 72   stats.TotalRetur
e360	6e 0a 09 09 74 6f 74 61  6c 57 69 6e 6e 69 6e 67   n...totalWinning
e370	54 72 61 64 65 73 20 2b  3d 20 73 74 61 74 73 2e   Trades += stats.
e380	57 69 6e 6e 69 6e 67 54  72 61 64 65 73 0a 09 09   WinningTrades...
e390	74 6f 74 61 6c 4c 6f 73  69 6e 67 54 72 61 64 65   totalLosingTrade
e3a0	73 20 2b 3d 20 73 74 61  74 73 2e 4c 6f 73 69 6e   s += stats.Losin
e3b0	67 54 72 61 64 65 73 0a  09 09 74 6f 74 61 6c 54   gTrades...totalT
e3c0	72 61 64 65 73 20 2b 3d  20 73 74 61 74 73 2e 54   rades += stats.T
e3d0	6f 74 61 6c 54 72 61 64  65 73 0a 0a 09 09 2f 2f   otalTrades....//
e3e0	20 e8 ae a1 e7 ae 97 e6  af 8f e4 b8 aa e5 b8 81    ...............
e3f0	e7 a7 8d e7 9a 84 e6 94  b6 e7 9b 8a e7 8e 87 e6   ................
e400	9d 83 e9 87 8d ef bc 88  e5 9f ba e4 ba 8e e4 ba   ................
e410	a4 e6 98 93 e6 ac a1 e6  95 b0 e6 88 96 e8 b5 84   ................
e420	e9 87 91 e5 88 86 e9 85  8d ef bc 89 0a 09 09 77   ...............w
e430	65 69 67 68 74 20 3a 3d  20 31 2e 30 20 2f 2f 20   eight := 1.0 // 
e440	e9 bb 98 e8 ae a4 e6 9d  83 e9 87 8d 0a 09 09 69   ...............i
e450	66 20 73 74 61 74 73 2e  54 6f 74 61 6c 54 72 61   f stats.TotalTra
e460	64 65 73 20 3e 20 30 20  7b 0a 09 09 09 77 65 69   des > 0 {....wei
e470	67 68 74 20 3d 20 66 6c  6f 61 74 36 34 28 73 74   ght = float64(st
e480	61 74 73 2e 54 6f 74 61  6c 54 72 61 64 65 73 29   ats.TotalTrades)
e490	20 2f 2f 20 e6 8c 89 e4  ba a4 e6 98 93 e6 ac a1    // ............
e4a0	e6 95 b0 e5 8a a0 e6 9d  83 0a 09 09 7d 0a 0a 09   ............}...
e4b0	09 2f 2f 20 e8 ae a1 e7  ae 97 e6 94 b6 e7 9b 8a   .// ............
e4c0	e7 8e 87 ef bc 88 e5 9f  ba e4 ba 8e e5 88 9d e5   ................
e4d0	a7 8b e8 b5 84 e9 87 91  ef bc 89 0a 09 09 69 6e   ..............in
e4e0	69 74 69 61 6c 43 61 73  68 20 3a 3d 20 72 65 73   itialCash := res
e4f0	75 6c 74 2e 43 6f 6e 66  69 67 2e 49 6e 69 74 69   ult.Config.Initi
e500	61 6c 43 61 73 68 0a 09  09 69 66 20 69 6e 69 74   alCash...if init
e510	69 61 6c 43 61 73 68 20  3c 3d 20 30 20 7b 0a 09   ialCash <= 0 {..
e520	09 09 69 6e 69 74 69 61  6c 43 61 73 68 20 3d 20   ..initialCash = 
e530	31 30 30 30 30 2e 30 20  2f 2f 20 e9 bb 98 e8 ae   10000.0 // .....
e540	a4 e5 80 bc 0a 09 09 7d  0a 09 09 73 79 6d 62 6f   .......}...symbo
e550	6c 52 65 74 75 72 6e 20  3a 3d 20 30 2e 30 0a 09   lReturn := 0.0..
e560	09 69 66 20 69 6e 69 74  69 61 6c 43 61 73 68 20   .if initialCash 
e570	3e 20 30 20 7b 0a 09 09  09 73 79 6d 62 6f 6c 52   > 0 {....symbolR
e580	65 74 75 72 6e 20 3d 20  73 74 61 74 73 2e 54 6f   eturn = stats.To
e590	74 61 6c 52 65 74 75 72  6e 20 2f 20 69 6e 69 74   talReturn / init
e5a0	69 61 6c 43 61 73 68 0a  09 09 7d 0a 0a 09 09 2f   ialCash...}..../
e5b0	2f 20 e5 8a a0 e6 9d 83  e7 b4 af e5 8a a0 e6 94   / ..............
e5c0	b6 e7 9b 8a e7 8e 87 0a  09 09 74 6f 74 61 6c 57   ..........totalW
e5d0	65 69 67 68 74 65 64 52  65 74 75 72 6e 20 2b 3d   eightedReturn +=
e5e0	20 73 79 6d 62 6f 6c 52  65 74 75 72 6e 20 2a 20    symbolReturn * 
e5f0	77 65 69 67 68 74 0a 09  09 74 6f 74 61 6c 57 65   weight...totalWe
e600	69 67 68 74 20 2b 3d 20  77 65 69 67 68 74 0a 09   ight += weight..
e610	7d 0a 0a 09 2f 2f 20 e8  ae a1 e7 ae 97 e6 b1 87   }...// .........
e620	e6 80 bb e8 83 9c e7 8e  87 0a 09 74 6f 74 61 6c   ...........total
e630	43 6f 6d 70 6c 65 74 65  64 54 72 61 64 65 73 20   CompletedTrades 
e640	3a 3d 20 74 6f 74 61 6c  57 69 6e 6e 69 6e 67 54   := totalWinningT
e650	72 61 64 65 73 20 2b 20  74 6f 74 61 6c 4c 6f 73   rades + totalLos
e660	69 6e 67 54 72 61 64 65  73 0a 09 77 69 6e 52 61   ingTrades..winRa
e670	74 65 20 3a 3d 20 30 2e  30 0a 09 69 66 20 74 6f   te := 0.0..if to
e680	74 61 6c 43 6f 6d 70 6c  65 74 65 64 54 72 61 64   talCompletedTrad
e690	65 73 20 3e 20 30 20 7b  0a 09 09 77 69 6e 52 61   es > 0 {...winRa
e6a0	74 65 20 3d 20 66 6c 6f  61 74 36 34 28 74 6f 74   te = float64(tot
e6b0	61 6c 57 69 6e 6e 69 6e  67 54 72 61 64 65 73 29   alWinningTrades)
e6c0	20 2f 20 66 6c 6f 61 74  36 34 28 74 6f 74 61 6c    / float64(total
e6d0	43 6f 6d 70 6c 65 74 65  64 54 72 61 64 65 73 29   CompletedTrades)
e6e0	0a 09 7d 0a 0a 09 2f 2f  20 e8 ae a1 e7 ae 97 e6   ..}...// .......
e6f0	80 bb e6 94 b6 e7 9b 8a  e7 8e 87 20 2d 20 e4 bd   ........... - ..
e700	bf e7 94 a8 e5 8a a0 e6  9d 83 e5 b9 b3 e5 9d 87   ................
e710	0a 09 74 6f 74 61 6c 52  65 74 75 72 6e 20 3a 3d   ..totalReturn :=
e720	20 30 2e 30 0a 09 69 66  20 74 6f 74 61 6c 57 65    0.0..if totalWe
e730	69 67 68 74 20 3e 20 30  20 7b 0a 09 09 74 6f 74   ight > 0 {...tot
e740	61 6c 52 65 74 75 72 6e  20 3d 20 74 6f 74 61 6c   alReturn = total
e750	57 65 69 67 68 74 65 64  52 65 74 75 72 6e 20 2f   WeightedReturn /
e760	20 74 6f 74 61 6c 57 65  69 67 68 74 0a 09 7d 0a    totalWeight..}.
e770	0a 09 2f 2f 20 e6 9b b4  e6 96 b0 53 75 6d 6d 61   ..// ......Summa
e780	72 79 0a 09 72 65 73 75  6c 74 2e 53 75 6d 6d 61   ry..result.Summa
e790	72 79 2e 54 6f 74 61 6c  54 72 61 64 65 73 20 3d   ry.TotalTrades =
e7a0	20 74 6f 74 61 6c 54 72  61 64 65 73 0a 09 72 65    totalTrades..re
e7b0	73 75 6c 74 2e 53 75 6d  6d 61 72 79 2e 57 69 6e   sult.Summary.Win
e7c0	6e 69 6e 67 54 72 61 64  65 73 20 3d 20 74 6f 74   ningTrades = tot
e7d0	61 6c 57 69 6e 6e 69 6e  67 54 72 61 64 65 73 0a   alWinningTrades.
e7e0	09 72 65 73 75 6c 74 2e  53 75 6d 6d 61 72 79 2e   .result.Summary.
e7f0	4c 6f 73 69 6e 67 54 72  61 64 65 73 20 3d 20 74   LosingTrades = t
e800	6f 74 61 6c 4c 6f 73 69  6e 67 54 72 61 64 65 73   otalLosingTrades
e810	0a 09 72 65 73 75 6c 74  2e 53 75 6d 6d 61 72 79   ..result.Summary
e820	2e 57 69 6e 52 61 74 65  20 3d 20 77 69 6e 52 61   .WinRate = winRa
e830	74 65 0a 09 72 65 73 75  6c 74 2e 53 75 6d 6d 61   te..result.Summa
e840	72 79 2e 54 6f 74 61 6c  52 65 74 75 72 6e 20 3d   ry.TotalReturn =
e850	20 74 6f 74 61 6c 52 65  74 75 72 6e 0a 0a 09 2f    totalReturn.../
e860	2f 20 e8 8e b7 e5 8f 96  e6 9c 80 e7 bb 88 e8 b5   / ..............
e870	84 e9 87 91 e4 bd 99 e9  a2 9d 0a 09 66 69 6e 61   ............fina
e880	6c 42 61 6c 61 6e 63 65  20 3a 3d 20 72 65 73 75   lBalance := resu
e890	6c 74 2e 43 6f 6e 66 69  67 2e 49 6e 69 74 69 61   lt.Config.Initia
e8a0	6c 43 61 73 68 0a 09 69  66 20 6c 65 6e 28 72 65   lCash..if len(re
e8b0	73 75 6c 74 2e 50 6f 72  74 66 6f 6c 69 6f 56 61   sult.PortfolioVa
e8c0	6c 75 65 73 29 20 3e 20  30 20 7b 0a 09 09 66 69   lues) > 0 {...fi
e8d0	6e 61 6c 42 61 6c 61 6e  63 65 20 3d 20 72 65 73   nalBalance = res
e8e0	75 6c 74 2e 50 6f 72 74  66 6f 6c 69 6f 56 61 6c   ult.PortfolioVal
e8f0	75 65 73 5b 6c 65 6e 28  72 65 73 75 6c 74 2e 50   ues[len(result.P
e900	6f 72 74 66 6f 6c 69 6f  56 61 6c 75 65 73 29 2d   ortfolioValues)-
e910	31 5d 0a 09 7d 0a 0a 09  2f 2f 20 e8 ae a1 e7 ae   1]..}...// .....
e920	97 e5 ae 9e e9 99 85 e6  80 bb e6 94 b6 e7 9b 8a   ................
e930	e7 8e 87 ef bc 88 e5 9f  ba e4 ba 8e e8 b5 84 e9   ................
e940	87 91 e5 8f 98 e5 8c 96  ef bc 89 0a 09 61 63 74   .............act
e950	75 61 6c 54 6f 74 61 6c  52 65 74 75 72 6e 20 3a   ualTotalReturn :
e960	3d 20 30 2e 30 0a 09 69  66 20 72 65 73 75 6c 74   = 0.0..if result
e970	2e 43 6f 6e 66 69 67 2e  49 6e 69 74 69 61 6c 43   .Config.InitialC
e980	61 73 68 20 3e 20 30 20  7b 0a 09 09 61 63 74 75   ash > 0 {...actu
e990	61 6c 54 6f 74 61 6c 52  65 74 75 72 6e 20 3d 20   alTotalReturn = 
e9a0	28 66 69 6e 61 6c 42 61  6c 61 6e 63 65 20 2d 20   (finalBalance - 
e9b0	72 65 73 75 6c 74 2e 43  6f 6e 66 69 67 2e 49 6e   result.Config.In
e9c0	69 74 69 61 6c 43 61 73  68 29 20 2f 20 72 65 73   itialCash) / res
e9d0	75 6c 74 2e 43 6f 6e 66  69 67 2e 49 6e 69 74 69   ult.Config.Initi
e9e0	61 6c 43 61 73 68 0a 09  7d 0a 0a 09 6c 6f 67 2e   alCash..}...log.
e9f0	50 72 69 6e 74 66 28 22  5b 4d 55 4c 54 49 5f 53   Printf("[MULTI_S
ea00	59 4d 42 4f 4c 5f 41 47  47 52 45 47 41 54 49 4f   YMBOL_AGGREGATIO
ea10	4e 5d 20 e6 b1 87 e6 80  bb e5 ae 8c e6 88 90 3a   N] ............:
ea20	20 e6 80 bb e4 ba a4 e6  98 93 3d 25 64 2c 20 e8    .........=%d, .
ea30	83 9c e7 8e 87 3d 25 2e  32 66 25 25 2c 20 e6 80   .....=%.2f%%, ..
ea40	bb e6 94 b6 e7 9b 8a e7  8e 87 3d 25 2e 34 66 25   ..........=%.4f%
ea50	25 2c 20 e6 9c 80 e7 bb  88 e4 bd 99 e9 a2 9d 3d   %, ............=
ea60	25 2e 32 66 20 28 e5 88  9d e5 a7 8b e8 b5 84 e9   %.2f (..........
ea70	87 91 3d 25 2e 32 66 29  22 2c 0a 09 09 74 6f 74   ..=%.2f)",...tot
ea80	61 6c 54 72 61 64 65 73  2c 20 77 69 6e 52 61 74   alTrades, winRat
ea90	65 2a 31 30 30 2c 20 61  63 74 75 61 6c 54 6f 74   e*100, actualTot
eaa0	61 6c 52 65 74 75 72 6e  2a 31 30 30 2c 20 66 69   alReturn*100, fi
eab0	6e 61 6c 42 61 6c 61 6e  63 65 2c 20 72 65 73 75   nalBalance, resu
eac0	6c 74 2e 43 6f 6e 66 69  67 2e 49 6e 69 74 69 61   lt.Config.Initia
ead0	6c 43 61 73 68 29 0a 7d  0a 0a 2f 2f 20 63 61 6c   lCash).}..// cal
eae0	63 75 6c 61 74 65 4d 61  78 44 72 61 77 64 6f 77   culateMaxDrawdow
eaf0	6e 45 6e 68 61 6e 63 65  64 20 e8 ae a1 e7 ae 97   nEnhanced ......
eb00	e6 9c 80 e5 a4 a7 e5 9b  9e e6 92 a4 ef bc 88 e5   ................
eb10	a2 9e e5 bc ba e7 89 88  ef bc 89 0a 66 75 6e 63   ............func
eb20	20 28 62 65 20 2a 42 61  63 6b 74 65 73 74 45 6e    (be *BacktestEn
eb30	67 69 6e 65 29 20 63 61  6c 63 75 6c 61 74 65 4d   gine) calculateM
eb40	61 78 44 72 61 77 64 6f  77 6e 45 6e 68 61 6e 63   axDrawdownEnhanc
eb50	65 64 28 63 75 6d 75 6c  61 74 69 76 65 52 65 74   ed(cumulativeRet
eb60	75 72 6e 73 20 5b 5d 66  6c 6f 61 74 36 34 29 20   urns []float64) 
eb70	66 6c 6f 61 74 36 34 20  7b 0a 09 69 66 20 6c 65   float64 {..if le
eb80	6e 28 63 75 6d 75 6c 61  74 69 76 65 52 65 74 75   n(cumulativeRetu
eb90	72 6e 73 29 20 3c 20 32  20 7b 0a 09 09 72 65 74   rns) < 2 {...ret
eba0	75 72 6e 20 30 2e 30 0a  09 7d 0a 0a 09 6d 61 78   urn 0.0..}...max
ebb0	44 72 61 77 64 6f 77 6e  20 3a 3d 20 30 2e 30 0a   Drawdown := 0.0.
ebc0	09 70 65 61 6b 20 3a 3d  20 63 75 6d 75 6c 61 74   .peak := cumulat
ebd0	69 76 65 52 65 74 75 72  6e 73 5b 30 5d 0a 0a 09   iveReturns[0]...
ebe0	66 6f 72 20 5f 2c 20 72  65 74 20 3a 3d 20 72 61   for _, ret := ra
ebf0	6e 67 65 20 63 75 6d 75  6c 61 74 69 76 65 52 65   nge cumulativeRe
ec00	74 75 72 6e 73 5b 31 3a  5d 20 7b 0a 09 09 69 66   turns[1:] {...if
ec10	20 72 65 74 20 3e 20 70  65 61 6b 20 7b 0a 09 09    ret > peak {...
ec20	09 70 65 61 6b 20 3d 20  72 65 74 0a 09 09 7d 0a   .peak = ret...}.
ec30	09 09 64 72 61 77 64 6f  77 6e 20 3a 3d 20 28 70   ..drawdown := (p
ec40	65 61 6b 20 2d 20 72 65  74 29 20 2f 20 28 70 65   eak - ret) / (pe
ec50	61 6b 20 2b 20 31 65 2d  38 29 20 2f 2f 20 e9 81   ak + 1e-8) // ..
ec60	bf e5 85 8d e9 99 a4 e9  9b b6 0a 09 09 69 66 20   .............if 
ec70	64 72 61 77 64 6f 77 6e  20 3e 20 6d 61 78 44 72   drawdown > maxDr
ec80	61 77 64 6f 77 6e 20 7b  0a 09 09 09 6d 61 78 44   awdown {....maxD
ec90	72 61 77 64 6f 77 6e 20  3d 20 64 72 61 77 64 6f   rawdown = drawdo
eca0	77 6e 0a 09 09 7d 0a 09  7d 0a 0a 09 72 65 74 75   wn...}..}...retu
ecb0	72 6e 20 6d 61 78 44 72  61 77 64 6f 77 6e 0a 7d   rn maxDrawdown.}
ecc0	0a 0a 2f 2f 20 63 61 6c  63 75 6c 61 74 65 53 68   ..// calculateSh
ecd0	61 72 70 65 52 61 74 69  6f 45 6e 68 61 6e 63 65   arpeRatioEnhance
ece0	64 20 e8 ae a1 e7 ae 97  e5 a4 8f e6 99 ae e6 af   d ..............
ecf0	94 e7 8e 87 ef bc 88 e7  ae 80 e5 8c 96 e7 9a 84   ................
ed00	e6 97 a5 e6 94 b6 e7 9b  8a e7 8e 87 e7 89 88 e6   ................
ed10	9c ac ef bc 89 0a 66 75  6e 63 20 28 62 65 20 2a   ......func (be *
ed20	42 61 63 6b 74 65 73 74  45 6e 67 69 6e 65 29 20   BacktestEngine) 
ed30	63 61 6c 63 75 6c 61 74  65 53 68 61 72 70 65 52   calculateSharpeR
ed40	61 74 69 6f 45 6e 68 61  6e 63 65 64 28 72 65 74   atioEnhanced(ret
ed50	75 72 6e 73 20 5b 5d 66  6c 6f 61 74 36 34 29 20   urns []float64) 
ed60	66 6c 6f 61 74 36 34 20  7b 0a 09 69 66 20 6c 65   float64 {..if le
ed70	6e 28 72 65 74 75 72 6e  73 29 20 3c 20 32 20 7b   n(returns) < 2 {
ed80	0a 09 09 72 65 74 75 72  6e 20 30 2e 30 0a 09 7d   ...return 0.0..}
ed90	0a 0a 09 2f 2f 20 e8 ae  a1 e7 ae 97 e5 b9 b3 e5   ...// ..........
eda0	9d 87 e6 94 b6 e7 9b 8a  e7 8e 87 0a 09 6d 65 61   .............mea
edb0	6e 20 3a 3d 20 30 2e 30  0a 09 66 6f 72 20 5f 2c   n := 0.0..for _,
edc0	20 72 65 74 20 3a 3d 20  72 61 6e 67 65 20 72 65    ret := range re
edd0	74 75 72 6e 73 20 7b 0a  09 09 6d 65 61 6e 20 2b   turns {...mean +
ede0	3d 20 72 65 74 0a 09 7d  0a 09 6d 65 61 6e 20 2f   = ret..}..mean /
edf0	3d 20 66 6c 6f 61 74 36  34 28 6c 65 6e 28 72 65   = float64(len(re
ee00	74 75 72 6e 73 29 29 0a  0a 09 2f 2f 20 e8 ae a1   turns))...// ...
ee10	e7 ae 97 e6 94 b6 e7 9b  8a e7 8e 87 e6 a0 87 e5   ................
ee20	87 86 e5 b7 ae ef bc 88  e6 b3 a2 e5 8a a8 e7 8e   ................
ee30	87 ef bc 89 0a 09 76 61  72 69 61 6e 63 65 20 3a   ......variance :
ee40	3d 20 30 2e 30 0a 09 66  6f 72 20 5f 2c 20 72 65   = 0.0..for _, re
ee50	74 20 3a 3d 20 72 61 6e  67 65 20 72 65 74 75 72   t := range retur
ee60	6e 73 20 7b 0a 09 09 76  61 72 69 61 6e 63 65 20   ns {...variance 
ee70	2b 3d 20 28 72 65 74 20  2d 20 6d 65 61 6e 29 20   += (ret - mean) 
ee80	2a 20 28 72 65 74 20 2d  20 6d 65 61 6e 29 0a 09   * (ret - mean)..
ee90	7d 0a 09 76 61 72 69 61  6e 63 65 20 2f 3d 20 66   }..variance /= f
eea0	6c 6f 61 74 36 34 28 6c  65 6e 28 72 65 74 75 72   loat64(len(retur
eeb0	6e 73 29 20 2d 20 31 29  0a 09 73 74 64 20 3a 3d   ns) - 1)..std :=
eec0	20 6d 61 74 68 2e 53 71  72 74 28 76 61 72 69 61    math.Sqrt(varia
eed0	6e 63 65 29 0a 0a 09 2f  2f 20 e7 ae 80 e5 8c 96   nce)...// ......
eee0	e7 9a 84 e5 a4 8f e6 99  ae e6 af 94 e7 8e 87 ef   ................
eef0	bc 88 e5 81 87 e8 ae be  e6 97 a0 e9 a3 8e e9 99   ................
ef00	a9 e5 88 a9 e7 8e 87 e4  b8 ba 30 ef bc 89 0a 09   ..........0.....
ef10	69 66 20 73 74 64 20 3e  20 30 20 7b 0a 09 09 72   if std > 0 {...r
ef20	65 74 75 72 6e 20 6d 65  61 6e 20 2f 20 73 74 64   eturn mean / std
ef30	20 2a 20 6d 61 74 68 2e  53 71 72 74 28 32 35 32    * math.Sqrt(252
ef40	29 20 2f 2f 20 e5 b9 b4  e5 8c 96 ef bc 88 e5 81   ) // ...........
ef50	87 e8 ae be 32 35 32 e4  b8 aa e4 ba a4 e6 98 93   ....252.........
ef60	e6 97 a5 ef bc 89 0a 09  7d 0a 0a 09 72 65 74 75   ........}...retu
ef70	72 6e 20 30 2e 30 0a 7d  0a 0a 2f 2f 20 67 65 74   rn 0.0.}..// get
ef80	46 65 61 74 75 72 65 43  61 63 68 65 4b 65 79 20   FeatureCacheKey 
ef90	e7 94 9f e6 88 90 e7 89  b9 e5 be 81 e7 bc 93 e5   ................
efa0	ad 98 e9 94 ae 0a 66 75  6e 63 20 28 62 65 20 2a   ......func (be *
efb0	42 61 63 6b 74 65 73 74  45 6e 67 69 6e 65 29 20   BacktestEngine) 
efc0	67 65 74 46 65 61 74 75  72 65 43 61 63 68 65 4b   getFeatureCacheK
efd0	65 79 28 73 79 6d 62 6f  6c 20 73 74 72 69 6e 67   ey(symbol string
efe0	2c 20 73 74 61 72 74 44  61 74 65 2c 20 65 6e 64   , startDate, end
eff0	44 61 74 65 20 74 69 6d  65 2e 54 69 6d 65 29 20   Date time.Time) 
f000	73 74 72 69 6e 67 20 7b  0a 09 72 65 74 75 72 6e   string {..return
f010	20 66 6d 74 2e 53 70 72  69 6e 74 66 28 22 25 73    fmt.Sprintf("%s
f020	5f 25 73 5f 25 73 22 2c  20 73 79 6d 62 6f 6c 2c   _%s_%s", symbol,
f030	20 73 74 61 72 74 44 61  74 65 2e 46 6f 72 6d 61    startDate.Forma
f040	74 28 22 32 30 30 36 2d  30 31 2d 30 32 22 29 2c   t("2006-01-02"),
f050	20 65 6e 64 44 61 74 65  2e 46 6f 72 6d 61 74 28    endDate.Format(
f060	22 32 30 30 36 2d 30 31  2d 30 32 22 29 29 0a 7d   "2006-01-02")).}
f070	0a 0a 2f 2f 20 67 65 74  4d 4c 50 72 65 64 69 63   ..// getMLPredic
f080	74 69 6f 6e 43 61 63 68  65 4b 65 79 20 e7 94 9f   tionCacheKey ...
f090	e6 88 90 4d 4c e9 a2 84  e6 b5 8b e7 bc 93 e5 ad   ...ML...........
f0a0	98 e9 94 ae 0a 66 75 6e  63 20 28 62 65 20 2a 42   .....func (be *B
f0b0	61 63 6b 74 65 73 74 45  6e 67 69 6e 65 29 20 67   acktestEngine) g
f0c0	65 74 4d 4c 50 72 65 64  69 63 74 69 6f 6e 43 61   etMLPredictionCa
f0d0	63 68 65 4b 65 79 28 73  79 6d 62 6f 6c 20 73 74   cheKey(symbol st
f0e0	72 69 6e 67 2c 20 73 74  61 72 74 44 61 74 65 2c   ring, startDate,
f0f0	20 65 6e 64 44 61 74 65  20 74 69 6d 65 2e 54 69    endDate time.Ti
f100	6d 65 29 20 73 74 72 69  6e 67 20 7b 0a 09 72 65   me) string {..re
f110	74 75 72 6e 20 66 6d 74  2e 53 70 72 69 6e 74 66   turn fmt.Sprintf
f120	28 22 25 73 5f 25 73 5f  25 73 22 2c 20 73 79 6d   ("%s_%s_%s", sym
f130	62 6f 6c 2c 20 73 74 61  72 74 44 61 74 65 2e 46   bol, startDate.F
f140	6f 72 6d 61 74 28 22 32  30 30 36 2d 30 31 2d 30   ormat("2006-01-0
f150	32 22 29 2c 20 65 6e 64  44 61 74 65 2e 46 6f 72   2"), endDate.For
f160	6d 61 74 28 22 32 30 30  36 2d 30 31 2d 30 32 22   mat("2006-01-02"
f170	29 29 0a 7d 0a 0a 2f 2f  20 67 65 74 4f 72 43 72   )).}..// getOrCr
f180	65 61 74 65 46 65 61 74  75 72 65 43 61 63 68 65   eateFeatureCache
f190	20 e8 8e b7 e5 8f 96 e6  88 96 e5 88 9b e5 bb ba    ...............
f1a0	e7 89 b9 e5 be 81 e7 bc  93 e5 ad 98 0a 66 75 6e   .............fun
f1b0	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
f1c0	6e 67 69 6e 65 29 20 67  65 74 4f 72 43 72 65 61   ngine) getOrCrea
f1d0	74 65 46 65 61 74 75 72  65 43 61 63 68 65 28 73   teFeatureCache(s
f1e0	79 6d 62 6f 6c 20 73 74  72 69 6e 67 2c 20 73 74   ymbol string, st
f1f0	61 72 74 44 61 74 65 2c  20 65 6e 64 44 61 74 65   artDate, endDate
f200	20 74 69 6d 65 2e 54 69  6d 65 29 20 2a 46 65 61    time.Time) *Fea
f210	74 75 72 65 43 61 63 68  65 20 7b 0a 09 62 65 2e   tureCache {..be.
f220	63 61 63 68 65 4d 75 74  65 78 2e 4c 6f 63 6b 28   cacheMutex.Lock(
f230	29 0a 09 64 65 66 65 72  20 62 65 2e 63 61 63 68   )..defer be.cach
f240	65 4d 75 74 65 78 2e 55  6e 6c 6f 63 6b 28 29 0a   eMutex.Unlock().
f250	0a 09 6b 65 79 20 3a 3d  20 62 65 2e 67 65 74 46   ..key := be.getF
f260	65 61 74 75 72 65 43 61  63 68 65 4b 65 79 28 73   eatureCacheKey(s
f270	79 6d 62 6f 6c 2c 20 73  74 61 72 74 44 61 74 65   ymbol, startDate
f280	2c 20 65 6e 64 44 61 74  65 29 0a 09 69 66 20 63   , endDate)..if c
f290	61 63 68 65 2c 20 65 78  69 73 74 73 20 3a 3d 20   ache, exists := 
f2a0	62 65 2e 66 65 61 74 75  72 65 43 61 63 68 65 5b   be.featureCache[
f2b0	6b 65 79 5d 3b 20 65 78  69 73 74 73 20 7b 0a 09   key]; exists {..
f2c0	09 72 65 74 75 72 6e 20  63 61 63 68 65 0a 09 7d   .return cache..}
f2d0	0a 0a 09 63 61 63 68 65  20 3a 3d 20 4e 65 77 46   ...cache := NewF
f2e0	65 61 74 75 72 65 43 61  63 68 65 28 73 79 6d 62   eatureCache(symb
f2f0	6f 6c 2c 20 73 74 61 72  74 44 61 74 65 2c 20 65   ol, startDate, e
f300	6e 64 44 61 74 65 29 0a  09 62 65 2e 66 65 61 74   ndDate)..be.feat
f310	75 72 65 43 61 63 68 65  5b 6b 65 79 5d 20 3d 20   ureCache[key] = 
f320	63 61 63 68 65 0a 09 72  65 74 75 72 6e 20 63 61   cache..return ca
f330	63 68 65 0a 7d 0a 0a 2f  2f 20 70 72 65 63 6f 6d   che.}..// precom
f340	70 75 74 65 46 65 61 74  75 72 65 73 20 e9 a2 84   puteFeatures ...
f350	e8 ae a1 e7 ae 97 e6 89  80 e6 9c 89 e5 91 a8 e6   ................
f360	9c 9f e7 9a 84 e7 89 b9  e5 be 81 e5 b9 b6 e7 bc   ................
f370	93 e5 ad 98 0a 66 75 6e  63 20 28 62 65 20 2a 42   .....func (be *B
f380	61 63 6b 74 65 73 74 45  6e 67 69 6e 65 29 20 70   acktestEngine) p
f390	72 65 63 6f 6d 70 75 74  65 46 65 61 74 75 72 65   recomputeFeature
f3a0	73 28 63 74 78 20 63 6f  6e 74 65 78 74 2e 43 6f   s(ctx context.Co
f3b0	6e 74 65 78 74 2c 20 64  61 74 61 20 5b 5d 4d 61   ntext, data []Ma
f3c0	72 6b 65 74 44 61 74 61  2c 20 63 6f 6e 66 69 67   rketData, config
f3d0	20 42 61 63 6b 74 65 73  74 43 6f 6e 66 69 67 29    BacktestConfig)
f3e0	20 65 72 72 6f 72 20 7b  0a 09 6c 6f 67 2e 50 72    error {..log.Pr
f3f0	69 6e 74 66 28 22 5b 46  45 41 54 55 52 45 5f 50   intf("[FEATURE_P
f400	52 45 43 4f 4d 50 55 54  45 5d 20 e5 bc 80 e5 a7   RECOMPUTE] .....
f410	8b e9 a2 84 e8 ae a1 e7  ae 97 e7 89 b9 e5 be 81   ................
f420	ef bc 8c e6 95 b0 e6 8d  ae e7 82 b9 e6 95 b0 e9   ................
f430	87 8f 3a 20 25 64 22 2c  20 6c 65 6e 28 64 61 74   ..: %d", len(dat
f440	61 29 29 0a 0a 09 2f 2f  20 e8 8e b7 e5 8f 96 e7   a))...// .......
f450	89 b9 e5 be 81 e7 bc 93  e5 ad 98 0a 09 66 65 61   .............fea
f460	74 75 72 65 43 61 63 68  65 20 3a 3d 20 62 65 2e   tureCache := be.
f470	67 65 74 4f 72 43 72 65  61 74 65 46 65 61 74 75   getOrCreateFeatu
f480	72 65 43 61 63 68 65 28  63 6f 6e 66 69 67 2e 53   reCache(config.S
f490	79 6d 62 6f 6c 2c 20 63  6f 6e 66 69 67 2e 53 74   ymbol, config.St
f4a0	61 72 74 44 61 74 65 2c  20 63 6f 6e 66 69 67 2e   artDate, config.
f4b0	45 6e 64 44 61 74 65 29  0a 0a 09 2f 2f 20 e5 a6   EndDate)...// ..
f4c0	82 e6 9e 9c e5 b7 b2 e7  bb 8f e9 a2 84 e8 ae a1   ................
f4d0	e7 ae 97 e8 bf 87 ef bc  8c e7 9b b4 e6 8e a5 e8   ................
f4e0	bf 94 e5 9b 9e 0a 09 69  66 20 66 65 61 74 75 72   .......if featur
f4f0	65 43 61 63 68 65 2e 53  69 7a 65 28 29 20 3e 3d   eCache.Size() >=
f500	20 6c 65 6e 28 64 61 74  61 29 2d 35 30 20 7b 0a    len(data)-50 {.
f510	09 09 6c 6f 67 2e 50 72  69 6e 74 66 28 22 5b 46   ..log.Printf("[F
f520	45 41 54 55 52 45 5f 50  52 45 43 4f 4d 50 55 54   EATURE_PRECOMPUT
f530	45 5d 20 e7 89 b9 e5 be  81 e5 b7 b2 e7 bc 93 e5   E] .............
f540	ad 98 ef bc 8c e8 b7 b3  e8 bf 87 e9 a2 84 e8 ae   ................
f550	a1 e7 ae 97 20 28 e7 bc  93 e5 ad 98 e5 a4 a7 e5   .... (..........
f560	b0 8f 3a 20 25 64 29 22  2c 20 66 65 61 74 75 72   ..: %d)", featur
f570	65 43 61 63 68 65 2e 53  69 7a 65 28 29 29 0a 09   eCache.Size())..
f580	09 72 65 74 75 72 6e 20  6e 69 6c 0a 09 7d 0a 0a   .return nil..}..
f590	09 73 74 61 72 74 54 69  6d 65 20 3a 3d 20 74 69   .startTime := ti
f5a0	6d 65 2e 4e 6f 77 28 29  0a 0a 09 2f 2f 20 e6 89   me.Now()...// ..
f5b0	b9 e9 87 8f e9 a2 84 e8  ae a1 e7 ae 97 e7 89 b9   ................
f5c0	e5 be 81 0a 09 66 6f 72  20 69 20 3a 3d 20 35 30   .....for i := 50
f5d0	3b 20 69 20 3c 20 6c 65  6e 28 64 61 74 61 29 3b   ; i < len(data);
f5e0	20 69 2b 2b 20 7b 0a 09  09 63 75 72 72 65 6e 74    i++ {...current
f5f0	44 61 74 61 20 3a 3d 20  64 61 74 61 5b 69 5d 0a   Data := data[i].
f600	0a 09 09 2f 2f 20 e6 a3  80 e6 9f a5 e6 98 af e5   ...// ..........
f610	90 a6 e5 b7 b2 e7 bb 8f  e7 bc 93 e5 ad 98 0a 09   ................
f620	09 69 66 20 5f 2c 20 65  78 69 73 74 73 20 3a 3d   .if _, exists :=
f630	20 66 65 61 74 75 72 65  43 61 63 68 65 2e 47 65    featureCache.Ge
f640	74 46 65 61 74 75 72 65  28 69 29 3b 20 65 78 69   tFeature(i); exi
f650	73 74 73 20 7b 0a 09 09  09 63 6f 6e 74 69 6e 75   sts {....continu
f660	65 0a 09 09 7d 0a 0a 09  09 2f 2f 20 e6 9e 84 e5   e...}....// ....
f670	bb ba e7 8a b6 e6 80 81  e7 89 b9 e5 be 81 0a 09   ................
f680	09 73 74 61 74 65 20 3a  3d 20 62 65 2e 62 75 69   .state := be.bui
f690	6c 64 41 64 76 61 6e 63  65 64 53 74 61 74 65 28   ldAdvancedState(
f6a0	63 74 78 2c 20 64 61 74  61 5b 3a 69 2b 31 5d 2c   ctx, data[:i+1],
f6b0	20 63 75 72 72 65 6e 74  44 61 74 61 2c 20 63 6f    currentData, co
f6c0	6e 66 69 67 2e 53 79 6d  62 6f 6c 29 0a 0a 09 09   nfig.Symbol)....
f6d0	2f 2f 20 e7 bc 93 e5 ad  98 e7 89 b9 e5 be 81 0a   // .............
f6e0	09 09 66 65 61 74 75 72  65 43 61 63 68 65 2e 53   ..featureCache.S
f6f0	65 74 46 65 61 74 75 72  65 28 69 2c 20 73 74 61   etFeature(i, sta
f700	74 65 29 0a 0a 09 09 2f  2f 20 e6 af 8f 31 30 30   te)....// ...100
f710	e4 b8 aa e5 91 a8 e6 9c  9f e8 be 93 e5 87 ba e4   ................
f720	b8 80 e6 ac a1 e8 bf 9b  e5 ba a6 0a 09 09 69 66   ..............if
f730	20 69 25 31 30 30 20 3d  3d 20 30 20 7b 0a 09 09    i%100 == 0 {...
f740	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 46 45   .log.Printf("[FE
f750	41 54 55 52 45 5f 50 52  45 43 4f 4d 50 55 54 45   ATURE_PRECOMPUTE
f760	5d 20 e8 bf 9b e5 ba a6  3a 20 25 64 2f 25 64 20   ] ......: %d/%d 
f770	28 25 2e 31 66 25 25 29  22 2c 20 69 2c 20 6c 65   (%.1f%%)", i, le
f780	6e 28 64 61 74 61 29 2c  20 66 6c 6f 61 74 36 34   n(data), float64
f790	28 69 29 2f 66 6c 6f 61  74 36 34 28 6c 65 6e 28   (i)/float64(len(
f7a0	64 61 74 61 29 29 2a 31  30 30 29 0a 09 09 7d 0a   data))*100)...}.
f7b0	09 7d 0a 0a 09 6c 6f 67  2e 50 72 69 6e 74 66 28   .}...log.Printf(
f7c0	22 5b 46 45 41 54 55 52  45 5f 50 52 45 43 4f 4d   "[FEATURE_PRECOM
f7d0	50 55 54 45 5d 20 e7 89  b9 e5 be 81 e9 a2 84 e8   PUTE] ..........
f7e0	ae a1 e7 ae 97 e5 ae 8c  e6 88 90 ef bc 8c e8 80   ................
f7f0	97 e6 97 b6 3a 20 25 2e  32 66 73 ef bc 8c e7 bc   ....: %.2fs.....
f800	93 e5 ad 98 e5 a4 a7 e5  b0 8f 3a 20 25 64 22 2c   ..........: %d",
f810	0a 09 09 74 69 6d 65 2e  53 69 6e 63 65 28 73 74   ...time.Since(st
f820	61 72 74 54 69 6d 65 29  2e 53 65 63 6f 6e 64 73   artTime).Seconds
f830	28 29 2c 20 66 65 61 74  75 72 65 43 61 63 68 65   (), featureCache
f840	2e 53 69 7a 65 28 29 29  0a 0a 09 72 65 74 75 72   .Size())...retur
f850	6e 20 6e 69 6c 0a 7d 0a  0a 2f 2f 20 67 65 74 43   n nil.}..// getC
f860	61 63 68 65 64 46 65 61  74 75 72 65 20 e8 8e b7   achedFeature ...
f870	e5 8f 96 e7 bc 93 e5 ad  98 e7 9a 84 e7 89 b9 e5   ................
f880	be 81 ef bc 8c e5 a6 82  e6 9e 9c e4 b8 8d e5 ad   ................
f890	98 e5 9c a8 e5 88 99 e5  ae 9e e6 97 b6 e8 ae a1   ................
f8a0	e7 ae 97 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
f8b0	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 67 65   cktestEngine) ge
f8c0	74 43 61 63 68 65 64 46  65 61 74 75 72 65 28 63   tCachedFeature(c
f8d0	74 78 20 63 6f 6e 74 65  78 74 2e 43 6f 6e 74 65   tx context.Conte
f8e0	78 74 2c 20 64 61 74 61  20 5b 5d 4d 61 72 6b 65   xt, data []Marke
f8f0	74 44 61 74 61 2c 20 63  75 72 72 65 6e 74 44 61   tData, currentDa
f900	74 61 20 4d 61 72 6b 65  74 44 61 74 61 2c 20 69   ta MarketData, i
f910	6e 64 65 78 20 69 6e 74  2c 20 73 79 6d 62 6f 6c   ndex int, symbol
f920	20 73 74 72 69 6e 67 2c  20 73 74 61 72 74 44 61    string, startDa
f930	74 65 2c 20 65 6e 64 44  61 74 65 20 74 69 6d 65   te, endDate time
f940	2e 54 69 6d 65 29 20 6d  61 70 5b 73 74 72 69 6e   .Time) map[strin
f950	67 5d 66 6c 6f 61 74 36  34 20 7b 0a 09 66 65 61   g]float64 {..fea
f960	74 75 72 65 43 61 63 68  65 20 3a 3d 20 62 65 2e   tureCache := be.
f970	67 65 74 4f 72 43 72 65  61 74 65 46 65 61 74 75   getOrCreateFeatu
f980	72 65 43 61 63 68 65 28  73 79 6d 62 6f 6c 2c 20   reCache(symbol, 
f990	73 74 61 72 74 44 61 74  65 2c 20 65 6e 64 44 61   startDate, endDa
f9a0	74 65 29 0a 0a 09 2f 2f  20 e5 b0 9d e8 af 95 e4   te)...// .......
f9b0	bb 8e e7 bc 93 e5 ad 98  e8 8e b7 e5 8f 96 0a 09   ................
f9c0	69 66 20 66 65 61 74 75  72 65 2c 20 65 78 69 73   if feature, exis
f9d0	74 73 20 3a 3d 20 66 65  61 74 75 72 65 43 61 63   ts := featureCac
f9e0	68 65 2e 47 65 74 46 65  61 74 75 72 65 28 69 6e   he.GetFeature(in
f9f0	64 65 78 29 3b 20 65 78  69 73 74 73 20 7b 0a 09   dex); exists {..
fa00	09 72 65 74 75 72 6e 20  66 65 61 74 75 72 65 0a   .return feature.
fa10	09 7d 0a 0a 09 2f 2f 20  e7 bc 93 e5 ad 98 e4 b8   .}...// ........
fa20	8d e5 ad 98 e5 9c a8 ef  bc 8c e5 ae 9e e6 97 b6   ................
fa30	e8 ae a1 e7 ae 97 e5 b9  b6 e7 bc 93 e5 ad 98 0a   ................
fa40	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 46 45   .log.Printf("[FE
fa50	41 54 55 52 45 5f 43 41  43 48 45 5f 4d 49 53 53   ATURE_CACHE_MISS
fa60	5d 20 e7 bc 93 e5 ad 98  e6 9c aa e5 91 bd e4 b8   ] ..............
fa70	ad ef bc 8c e5 ae 9e e6  97 b6 e8 ae a1 e7 ae 97   ................
fa80	e7 89 b9 e5 be 81 20 28  73 79 6d 62 6f 6c 3d 25   ...... (symbol=%
fa90	73 2c 20 69 6e 64 65 78  3d 25 64 29 22 2c 20 73   s, index=%d)", s
faa0	79 6d 62 6f 6c 2c 20 69  6e 64 65 78 29 0a 09 73   ymbol, index)..s
fab0	74 61 74 65 20 3a 3d 20  62 65 2e 62 75 69 6c 64   tate := be.build
fac0	41 64 76 61 6e 63 65 64  53 74 61 74 65 28 63 74   AdvancedState(ct
fad0	78 2c 20 64 61 74 61 5b  3a 69 6e 64 65 78 2b 31   x, data[:index+1
fae0	5d 2c 20 63 75 72 72 65  6e 74 44 61 74 61 2c 20   ], currentData, 
faf0	73 79 6d 62 6f 6c 29 0a  09 66 65 61 74 75 72 65   symbol)..feature
fb00	43 61 63 68 65 2e 53 65  74 46 65 61 74 75 72 65   Cache.SetFeature
fb10	28 69 6e 64 65 78 2c 20  73 74 61 74 65 29 0a 0a   (index, state)..
fb20	09 72 65 74 75 72 6e 20  73 74 61 74 65 0a 7d 0a   .return state.}.
fb30	0a 2f 2f 20 67 65 74 4f  72 43 72 65 61 74 65 4d   .// getOrCreateM
fb40	4c 50 72 65 64 69 63 74  69 6f 6e 43 61 63 68 65   LPredictionCache
fb50	20 e8 8e b7 e5 8f 96 e6  88 96 e5 88 9b e5 bb ba    ...............
fb60	4d 4c e9 a2 84 e6 b5 8b  e7 bc 93 e5 ad 98 0a 66   ML.............f
fb70	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
fb80	74 45 6e 67 69 6e 65 29  20 67 65 74 4f 72 43 72   tEngine) getOrCr
fb90	65 61 74 65 4d 4c 50 72  65 64 69 63 74 69 6f 6e   eateMLPrediction
fba0	43 61 63 68 65 28 73 79  6d 62 6f 6c 20 73 74 72   Cache(symbol str
fbb0	69 6e 67 2c 20 73 74 61  72 74 44 61 74 65 2c 20   ing, startDate, 
fbc0	65 6e 64 44 61 74 65 20  74 69 6d 65 2e 54 69 6d   endDate time.Tim
fbd0	65 29 20 2a 4d 4c 50 72  65 64 69 63 74 69 6f 6e   e) *MLPrediction
fbe0	43 61 63 68 65 20 7b 0a  09 62 65 2e 63 61 63 68   Cache {..be.cach
fbf0	65 4d 75 74 65 78 2e 4c  6f 63 6b 28 29 0a 09 64   eMutex.Lock()..d
fc00	65 66 65 72 20 62 65 2e  63 61 63 68 65 4d 75 74   efer be.cacheMut
fc10	65 78 2e 55 6e 6c 6f 63  6b 28 29 0a 0a 09 6b 65   ex.Unlock()...ke
fc20	79 20 3a 3d 20 62 65 2e  67 65 74 46 65 61 74 75   y := be.getFeatu
fc30	72 65 43 61 63 68 65 4b  65 79 28 73 79 6d 62 6f   reCacheKey(symbo
fc40	6c 2c 20 73 74 61 72 74  44 61 74 65 2c 20 65 6e   l, startDate, en
fc50	64 44 61 74 65 29 0a 09  69 66 20 63 61 63 68 65   dDate)..if cache
fc60	2c 20 65 78 69 73 74 73  20 3a 3d 20 62 65 2e 6d   , exists := be.m
fc70	6c 50 72 65 64 69 63 74  69 6f 6e 43 61 63 68 65   lPredictionCache
fc80	5b 6b 65 79 5d 3b 20 65  78 69 73 74 73 20 7b 0a   [key]; exists {.
fc90	09 09 72 65 74 75 72 6e  20 63 61 63 68 65 0a 09   ..return cache..
fca0	7d 0a 0a 09 63 61 63 68  65 20 3a 3d 20 4e 65 77   }...cache := New
fcb0	4d 4c 50 72 65 64 69 63  74 69 6f 6e 43 61 63 68   MLPredictionCach
fcc0	65 28 73 79 6d 62 6f 6c  2c 20 73 74 61 72 74 44   e(symbol, startD
fcd0	61 74 65 2c 20 65 6e 64  44 61 74 65 29 0a 09 62   ate, endDate)..b
fce0	65 2e 6d 6c 50 72 65 64  69 63 74 69 6f 6e 43 61   e.mlPredictionCa
fcf0	63 68 65 5b 6b 65 79 5d  20 3d 20 63 61 63 68 65   che[key] = cache
fd00	0a 09 72 65 74 75 72 6e  20 63 61 63 68 65 0a 7d   ..return cache.}
fd10	0a 0a 2f 2f 20 70 72 65  63 6f 6d 70 75 74 65 4d   ..// precomputeM
fd20	4c 50 72 65 64 69 63 74  69 6f 6e 73 20 e9 a2 84   LPredictions ...
fd30	e8 ae a1 e7 ae 97 e6 89  80 e6 9c 89 e5 91 a8 e6   ................
fd40	9c 9f e7 9a 84 4d 4c e9  a2 84 e6 b5 8b e5 b9 b6   .....ML.........
fd50	e7 bc 93 e5 ad 98 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
fd60	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
fd70	20 70 72 65 63 6f 6d 70  75 74 65 4d 4c 50 72 65    precomputeMLPre
fd80	64 69 63 74 69 6f 6e 73  28 63 74 78 20 63 6f 6e   dictions(ctx con
fd90	74 65 78 74 2e 43 6f 6e  74 65 78 74 2c 20 64 61   text.Context, da
fda0	74 61 20 5b 5d 4d 61 72  6b 65 74 44 61 74 61 2c   ta []MarketData,
fdb0	20 63 6f 6e 66 69 67 20  42 61 63 6b 74 65 73 74    config Backtest
fdc0	43 6f 6e 66 69 67 29 20  65 72 72 6f 72 20 7b 0a   Config) error {.
fdd0	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 4d 4c   .log.Printf("[ML
fde0	5f 50 52 45 43 4f 4d 50  55 54 45 5d 20 e5 bc 80   _PRECOMPUTE] ...
fdf0	e5 a7 8b e9 a2 84 e8 ae  a1 e7 ae 97 4d 4c e9 a2   ............ML..
fe00	84 e6 b5 8b ef bc 8c e6  95 b0 e6 8d ae e7 82 b9   ................
fe10	e6 95 b0 e9 87 8f 3a 20  25 64 22 2c 20 6c 65 6e   ......: %d", len
fe20	28 64 61 74 61 29 29 0a  0a 09 2f 2f 20 e8 8e b7   (data))...// ...
fe30	e5 8f 96 4d 4c e9 a2 84  e6 b5 8b e7 bc 93 e5 ad   ...ML...........
fe40	98 0a 09 6d 6c 43 61 63  68 65 20 3a 3d 20 62 65   ...mlCache := be
fe50	2e 67 65 74 4f 72 43 72  65 61 74 65 4d 4c 50 72   .getOrCreateMLPr
fe60	65 64 69 63 74 69 6f 6e  43 61 63 68 65 28 63 6f   edictionCache(co
fe70	6e 66 69 67 2e 53 79 6d  62 6f 6c 2c 20 63 6f 6e   nfig.Symbol, con
fe80	66 69 67 2e 53 74 61 72  74 44 61 74 65 2c 20 63   fig.StartDate, c
fe90	6f 6e 66 69 67 2e 45 6e  64 44 61 74 65 29 0a 0a   onfig.EndDate)..
fea0	09 2f 2f 20 e5 a6 82 e6  9e 9c e5 b7 b2 e7 bb 8f   .// ............
feb0	e9 a2 84 e8 ae a1 e7 ae  97 e8 bf 87 ef bc 8c e7   ................
fec0	9b b4 e6 8e a5 e8 bf 94  e5 9b 9e 0a 09 69 66 20   .............if 
fed0	6d 6c 43 61 63 68 65 2e  53 69 7a 65 28 29 20 3e   mlCache.Size() >
fee0	3d 20 6c 65 6e 28 64 61  74 61 29 2d 35 30 20 7b   = len(data)-50 {
fef0	0a 09 09 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   ...log.Printf("[
ff00	4d 4c 5f 50 52 45 43 4f  4d 50 55 54 45 5d 20 4d   ML_PRECOMPUTE] M
ff10	4c e9 a2 84 e6 b5 8b e5  b7 b2 e7 bc 93 e5 ad 98   L...............
ff20	ef bc 8c e8 b7 b3 e8 bf  87 e9 a2 84 e8 ae a1 e7   ................
ff30	ae 97 20 28 e7 bc 93 e5  ad 98 e5 a4 a7 e5 b0 8f   .. (............
ff40	3a 20 25 64 29 22 2c 20  6d 6c 43 61 63 68 65 2e   : %d)", mlCache.
ff50	53 69 7a 65 28 29 29 0a  09 09 72 65 74 75 72 6e   Size())...return
ff60	20 6e 69 6c 0a 09 7d 0a  0a 09 73 74 61 72 74 54    nil..}...startT
ff70	69 6d 65 20 3a 3d 20 74  69 6d 65 2e 4e 6f 77 28   ime := time.Now(
ff80	29 0a 0a 09 2f 2f 20 e6  a3 80 e6 9f a5 e6 9c ba   )...// .........
ff90	e5 99 a8 e5 ad a6 e4 b9  a0 e6 9c 8d e5 8a a1 e6   ................
ffa0	98 af e5 90 a6 e5 8f af  e7 94 a8 0a 09 69 66 20   .............if 
ffb0	62 65 2e 73 65 72 76 65  72 20 3d 3d 20 6e 69 6c   be.server == nil
ffc0	20 7c 7c 20 62 65 2e 73  65 72 76 65 72 2e 6d 61    || be.server.ma
ffd0	63 68 69 6e 65 4c 65 61  72 6e 69 6e 67 20 3d 3d   chineLearning ==
ffe0	20 6e 69 6c 20 7b 0a 09  09 6c 6f 67 2e 50 72 69    nil {...log.Pri
fff0	6e 74 66 28 22 5b 4d 4c  5f 50 52 45 43 4f 4d 50   ntf("[ML_PRECOMP
10000	55 54 45 5d 20 e6 9c ba  e5 99 a8 e5 ad a6 e4 b9   UTE] ...........
10010	a0 e6 9c 8d e5 8a a1 e4  b8 8d e5 8f af e7 94 a8   ................
10020	ef bc 8c e8 b7 b3 e8 bf  87 4d 4c e9 a2 84 e6 b5   .........ML.....
10030	8b e9 a2 84 e8 ae a1 e7  ae 97 22 29 0a 09 09 72   ..........")...r
10040	65 74 75 72 6e 20 6e 69  6c 0a 09 7d 0a 0a 09 2f   eturn nil..}.../
10050	2f 20 e6 89 b9 e9 87 8f  e9 a2 84 e8 ae a1 e7 ae   / ..............
10060	97 4d 4c e9 a2 84 e6 b5  8b 0a 09 62 61 74 63 68   .ML........batch
10070	53 69 7a 65 20 3a 3d 20  31 30 20 20 20 20 20 20   Size := 10      
10080	20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20                   
10090	20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20                   
100a0	20 20 20 20 20 20 20 20  2f 2f 20 e6 af 8f e6 89           // .....
100b0	b9 e5 a4 84 e7 90 86 31  30 e4 b8 aa e5 91 a8 e6   .......10.......
100c0	9c 9f 0a 09 74 6f 74 61  6c 42 61 74 63 68 65 73   ....totalBatches
100d0	20 3a 3d 20 28 6c 65 6e  28 64 61 74 61 29 20 2d    := (len(data) -
100e0	20 35 30 20 2b 20 62 61  74 63 68 53 69 7a 65 20    50 + batchSize 
100f0	2d 20 31 29 20 2f 20 62  61 74 63 68 53 69 7a 65   - 1) / batchSize
10100	20 2f 2f 20 e8 ae a1 e7  ae 97 e6 89 b9 e6 ac a1    // ............
10110	e6 95 b0 0a 0a 09 66 6f  72 20 62 61 74 63 68 20   ......for batch 
10120	3a 3d 20 30 3b 20 62 61  74 63 68 20 3c 20 74 6f   := 0; batch < to
10130	74 61 6c 42 61 74 63 68  65 73 3b 20 62 61 74 63   talBatches; batc
10140	68 2b 2b 20 7b 0a 09 09  73 74 61 72 74 49 64 78   h++ {...startIdx
10150	20 3a 3d 20 35 30 20 2b  20 62 61 74 63 68 2a 62    := 50 + batch*b
10160	61 74 63 68 53 69 7a 65  0a 09 09 65 6e 64 49 64   atchSize...endId
10170	78 20 3a 3d 20 73 74 61  72 74 49 64 78 20 2b 20   x := startIdx + 
10180	62 61 74 63 68 53 69 7a  65 0a 09 09 69 66 20 65   batchSize...if e
10190	6e 64 49 64 78 20 3e 20  6c 65 6e 28 64 61 74 61   ndIdx > len(data
101a0	29 20 7b 0a 09 09 09 65  6e 64 49 64 78 20 3d 20   ) {....endIdx = 
101b0	6c 65 6e 28 64 61 74 61  29 0a 09 09 7d 0a 0a 09   len(data)...}...
101c0	09 2f 2f 20 e5 b9 b6 e8  a1 8c e5 a4 84 e7 90 86   .// ............
101d0	e4 b8 80 e6 89 b9 e9 a2  84 e6 b5 8b 0a 09 09 76   ...............v
101e0	61 72 20 77 67 20 73 79  6e 63 2e 57 61 69 74 47   ar wg sync.WaitG
101f0	72 6f 75 70 0a 09 09 72  65 73 75 6c 74 73 20 3a   roup...results :
10200	3d 20 6d 61 6b 65 28 63  68 61 6e 20 73 74 72 75   = make(chan stru
10210	63 74 20 7b 0a 09 09 09  69 6e 64 65 78 20 20 20   ct {....index   
10220	20 20 20 69 6e 74 0a 09  09 09 70 72 65 64 69 63      int....predic
10230	74 69 6f 6e 20 2a 50 72  65 64 69 63 74 69 6f 6e   tion *Prediction
10240	52 65 73 75 6c 74 0a 09  09 09 65 72 72 20 20 20   Result....err   
10250	20 20 20 20 20 65 72 72  6f 72 0a 09 09 7d 2c 20        error...}, 
10260	65 6e 64 49 64 78 2d 73  74 61 72 74 49 64 78 29   endIdx-startIdx)
10270	0a 0a 09 09 66 6f 72 20  69 20 3a 3d 20 73 74 61   ....for i := sta
10280	72 74 49 64 78 3b 20 69  20 3c 20 65 6e 64 49 64   rtIdx; i < endId
10290	78 3b 20 69 2b 2b 20 7b  0a 09 09 09 2f 2f 20 e6   x; i++ {....// .
102a0	a3 80 e6 9f a5 e6 98 af  e5 90 a6 e5 b7 b2 e7 bb   ................
102b0	8f e7 bc 93 e5 ad 98 0a  09 09 09 69 66 20 5f 2c   ...........if _,
102c0	20 65 78 69 73 74 73 20  3a 3d 20 6d 6c 43 61 63    exists := mlCac
102d0	68 65 2e 47 65 74 50 72  65 64 69 63 74 69 6f 6e   he.GetPrediction
102e0	28 69 29 3b 20 65 78 69  73 74 73 20 7b 0a 09 09   (i); exists {...
102f0	09 09 63 6f 6e 74 69 6e  75 65 0a 09 09 09 7d 0a   ..continue....}.
10300	0a 09 09 09 77 67 2e 41  64 64 28 31 29 0a 09 09   ....wg.Add(1)...
10310	09 67 6f 20 66 75 6e 63  28 69 6e 64 65 78 20 69   .go func(index i
10320	6e 74 29 20 7b 0a 09 09  09 09 64 65 66 65 72 20   nt) {.....defer 
10330	77 67 2e 44 6f 6e 65 28  29 0a 0a 09 09 09 09 2f   wg.Done()....../
10340	2f 20 e4 bd bf e7 94 a8  e5 a4 9a e6 a8 a1 e5 9e   / ..............
10350	8b e9 9b 86 e6 88 90 e8  bf 9b e8 a1 8c e9 a2 84   ................
10360	e6 b5 8b 0a 09 09 09 09  70 72 65 64 69 63 74 69   ........predicti
10370	6f 6e 2c 20 65 72 72 20  3a 3d 20 62 65 2e 70 72   on, err := be.pr
10380	65 64 69 63 74 57 69 74  68 45 6e 73 65 6d 62 6c   edictWithEnsembl
10390	65 4d 6f 64 65 6c 73 28  63 74 78 2c 20 63 6f 6e   eModels(ctx, con
103a0	66 69 67 2e 53 79 6d 62  6f 6c 29 0a 09 09 09 09   fig.Symbol).....
103b0	69 66 20 65 72 72 20 21  3d 20 6e 69 6c 20 7b 0a   if err != nil {.
103c0	09 09 09 09 09 72 65 73  75 6c 74 73 20 3c 2d 20   .....results <- 
103d0	73 74 72 75 63 74 20 7b  0a 09 09 09 09 09 09 69   struct {.......i
103e0	6e 64 65 78 20 20 20 20  20 20 69 6e 74 0a 09 09   ndex      int...
103f0	09 09 09 09 70 72 65 64  69 63 74 69 6f 6e 20 2a   ....prediction *
10400	50 72 65 64 69 63 74 69  6f 6e 52 65 73 75 6c 74   PredictionResult
10410	0a 09 09 09 09 09 09 65  72 72 20 20 20 20 20 20   .......err      
10420	20 20 65 72 72 6f 72 0a  09 09 09 09 09 7d 7b 69     error......}{i
10430	6e 64 65 78 2c 20 6e 69  6c 2c 20 65 72 72 7d 0a   ndex, nil, err}.
10440	09 09 09 09 09 72 65 74  75 72 6e 0a 09 09 09 09   .....return.....
10450	7d 0a 0a 09 09 09 09 72  65 73 75 6c 74 73 20 3c   }......results <
10460	2d 20 73 74 72 75 63 74  20 7b 0a 09 09 09 09 09   - struct {......
10470	69 6e 64 65 78 20 20 20  20 20 20 69 6e 74 0a 09   index      int..
10480	09 09 09 09 70 72 65 64  69 63 74 69 6f 6e 20 2a   ....prediction *
10490	50 72 65 64 69 63 74 69  6f 6e 52 65 73 75 6c 74   PredictionResult
104a0	0a 09 09 09 09 09 65 72  72 20 20 20 20 20 20 20   ......err       
104b0	20 65 72 72 6f 72 0a 09  09 09 09 7d 7b 69 6e 64    error.....}{ind
104c0	65 78 2c 20 70 72 65 64  69 63 74 69 6f 6e 2c 20   ex, prediction, 
104d0	6e 69 6c 7d 0a 09 09 09  7d 28 69 29 0a 09 09 7d   nil}....}(i)...}
104e0	0a 0a 09 09 2f 2f 20 e7  ad 89 e5 be 85 e6 89 b9   ....// .........
104f0	e6 ac a1 e5 ae 8c e6 88  90 0a 09 09 67 6f 20 66   ............go f
10500	75 6e 63 28 29 20 7b 0a  09 09 09 77 67 2e 57 61   unc() {....wg.Wa
10510	69 74 28 29 0a 09 09 09  63 6c 6f 73 65 28 72 65   it()....close(re
10520	73 75 6c 74 73 29 0a 09  09 7d 28 29 0a 0a 09 09   sults)...}()....
10530	2f 2f 20 e5 a4 84 e7 90  86 e7 bb 93 e6 9e 9c 0a   // .............
10540	09 09 66 6f 72 20 72 65  73 75 6c 74 20 3a 3d 20   ..for result := 
10550	72 61 6e 67 65 20 72 65  73 75 6c 74 73 20 7b 0a   range results {.
10560	09 09 09 69 66 20 72 65  73 75 6c 74 2e 65 72 72   ...if result.err
10570	20 21 3d 20 6e 69 6c 20  7b 0a 09 09 09 09 6c 6f    != nil {.....lo
10580	67 2e 50 72 69 6e 74 66  28 22 5b 4d 4c 5f 50 52   g.Printf("[ML_PR
10590	45 43 4f 4d 50 55 54 45  5d 20 e5 91 a8 e6 9c 9f   ECOMPUTE] ......
105a0	25 64 20 4d 4c e9 a2 84  e6 b5 8b e5 a4 b1 e8 b4   %d ML...........
105b0	a5 3a 20 25 76 22 2c 20  72 65 73 75 6c 74 2e 69   .: %v", result.i
105c0	6e 64 65 78 2c 20 72 65  73 75 6c 74 2e 65 72 72   ndex, result.err
105d0	29 0a 09 09 09 09 63 6f  6e 74 69 6e 75 65 0a 09   ).....continue..
105e0	09 09 7d 0a 0a 09 09 09  2f 2f 20 e7 bc 93 e5 ad   ..}.....// .....
105f0	98 e9 a2 84 e6 b5 8b e7  bb 93 e6 9e 9c 0a 09 09   ................
10600	09 6d 6c 43 61 63 68 65  2e 53 65 74 50 72 65 64   .mlCache.SetPred
10610	69 63 74 69 6f 6e 28 72  65 73 75 6c 74 2e 69 6e   iction(result.in
10620	64 65 78 2c 20 72 65 73  75 6c 74 2e 70 72 65 64   dex, result.pred
10630	69 63 74 69 6f 6e 29 0a  09 09 7d 0a 0a 09 09 2f   iction)...}..../
10640	2f 20 e8 be 93 e5 87 ba  e8 bf 9b e5 ba a6 0a 09   / ..............
10650	09 70 72 6f 67 72 65 73  73 20 3a 3d 20 66 6c 6f   .progress := flo
10660	61 74 36 34 28 65 6e 64  49 64 78 29 20 2f 20 66   at64(endIdx) / f
10670	6c 6f 61 74 36 34 28 6c  65 6e 28 64 61 74 61 29   loat64(len(data)
10680	29 20 2a 20 31 30 30 0a  09 09 6c 6f 67 2e 50 72   ) * 100...log.Pr
10690	69 6e 74 66 28 22 5b 4d  4c 5f 50 52 45 43 4f 4d   intf("[ML_PRECOM
106a0	50 55 54 45 5d 20 e8 bf  9b e5 ba a6 3a 20 25 2e   PUTE] ......: %.
106b0	31 66 25 25 20 28 25 64  2f 25 64 29 22 2c 20 70   1f%% (%d/%d)", p
106c0	72 6f 67 72 65 73 73 2c  20 65 6e 64 49 64 78 2c   rogress, endIdx,
106d0	20 6c 65 6e 28 64 61 74  61 29 29 0a 09 7d 0a 0a    len(data))..}..
106e0	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 4d 4c   .log.Printf("[ML
106f0	5f 50 52 45 43 4f 4d 50  55 54 45 5d 20 4d 4c e9   _PRECOMPUTE] ML.
10700	a2 84 e6 b5 8b e9 a2 84  e8 ae a1 e7 ae 97 e5 ae   ................
10710	8c e6 88 90 ef bc 8c e8  80 97 e6 97 b6 3a 20 25   .............: %
10720	2e 32 66 73 ef bc 8c e7  bc 93 e5 ad 98 e5 a4 a7   .2fs............
10730	e5 b0 8f 3a 20 25 64 22  2c 0a 09 09 74 69 6d 65   ...: %d",...time
10740	2e 53 69 6e 63 65 28 73  74 61 72 74 54 69 6d 65   .Since(startTime
10750	29 2e 53 65 63 6f 6e 64  73 28 29 2c 20 6d 6c 43   ).Seconds(), mlC
10760	61 63 68 65 2e 53 69 7a  65 28 29 29 0a 0a 09 72   ache.Size())...r
10770	65 74 75 72 6e 20 6e 69  6c 0a 7d 0a 0a 2f 2f 20   eturn nil.}..// 
10780	67 65 74 43 61 63 68 65  64 4d 4c 50 72 65 64 69   getCachedMLPredi
10790	63 74 69 6f 6e 20 e8 8e  b7 e5 8f 96 e7 bc 93 e5   ction ..........
107a0	ad 98 e7 9a 84 4d 4c e9  a2 84 e6 b5 8b ef bc 8c   .....ML.........
107b0	e5 a6 82 e6 9e 9c e4 b8  8d e5 ad 98 e5 9c a8 e5   ................
107c0	88 99 e5 ae 9e e6 97 b6  e8 ae a1 e7 ae 97 0a 66   ...............f
107d0	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
107e0	74 45 6e 67 69 6e 65 29  20 67 65 74 43 61 63 68   tEngine) getCach
107f0	65 64 4d 4c 50 72 65 64  69 63 74 69 6f 6e 28 63   edMLPrediction(c
10800	74 78 20 63 6f 6e 74 65  78 74 2e 43 6f 6e 74 65   tx context.Conte
10810	78 74 2c 20 69 6e 64 65  78 20 69 6e 74 2c 20 73   xt, index int, s
10820	79 6d 62 6f 6c 20 73 74  72 69 6e 67 2c 20 73 74   ymbol string, st
10830	61 72 74 44 61 74 65 2c  20 65 6e 64 44 61 74 65   artDate, endDate
10840	20 74 69 6d 65 2e 54 69  6d 65 29 20 28 2a 50 72    time.Time) (*Pr
10850	65 64 69 63 74 69 6f 6e  52 65 73 75 6c 74 2c 20   edictionResult, 
10860	65 72 72 6f 72 29 20 7b  0a 09 6d 6c 43 61 63 68   error) {..mlCach
10870	65 20 3a 3d 20 62 65 2e  67 65 74 4f 72 43 72 65   e := be.getOrCre
10880	61 74 65 4d 4c 50 72 65  64 69 63 74 69 6f 6e 43   ateMLPredictionC
10890	61 63 68 65 28 73 79 6d  62 6f 6c 2c 20 73 74 61   ache(symbol, sta
108a0	72 74 44 61 74 65 2c 20  65 6e 64 44 61 74 65 29   rtDate, endDate)
108b0	0a 0a 09 2f 2f 20 e5 b0  9d e8 af 95 e4 bb 8e e7   ...// ..........
108c0	bc 93 e5 ad 98 e8 8e b7  e5 8f 96 0a 09 69 66 20   .............if 
108d0	70 72 65 64 69 63 74 69  6f 6e 2c 20 65 78 69 73   prediction, exis
108e0	74 73 20 3a 3d 20 6d 6c  43 61 63 68 65 2e 47 65   ts := mlCache.Ge
108f0	74 50 72 65 64 69 63 74  69 6f 6e 28 69 6e 64 65   tPrediction(inde
10900	78 29 3b 20 65 78 69 73  74 73 20 7b 0a 09 09 72   x); exists {...r
10910	65 74 75 72 6e 20 70 72  65 64 69 63 74 69 6f 6e   eturn prediction
10920	2c 20 6e 69 6c 0a 09 7d  0a 0a 09 2f 2f 20 e7 bc   , nil..}...// ..
10930	93 e5 ad 98 e4 b8 8d e5  ad 98 e5 9c a8 ef bc 8c   ................
10940	e5 ae 9e e6 97 b6 e8 ae  a1 e7 ae 97 e5 b9 b6 e7   ................
10950	bc 93 e5 ad 98 0a 09 6c  6f 67 2e 50 72 69 6e 74   .......log.Print
10960	66 28 22 5b 4d 4c 5f 43  41 43 48 45 5f 4d 49 53   f("[ML_CACHE_MIS
10970	53 5d 20 e7 bc 93 e5 ad  98 e6 9c aa e5 91 bd e4   S] .............
10980	b8 ad ef bc 8c e5 ae 9e  e6 97 b6 e8 ae a1 e7 ae   ................
10990	97 4d 4c e9 a2 84 e6 b5  8b 20 28 69 6e 64 65 78   .ML...... (index
109a0	3d 25 64 29 22 2c 20 69  6e 64 65 78 29 0a 09 70   =%d)", index)..p
109b0	72 65 64 69 63 74 69 6f  6e 2c 20 65 72 72 20 3a   rediction, err :
109c0	3d 20 62 65 2e 70 72 65  64 69 63 74 57 69 74 68   = be.predictWith
109d0	45 6e 73 65 6d 62 6c 65  4d 6f 64 65 6c 73 28 63   EnsembleModels(c
109e0	74 78 2c 20 73 79 6d 62  6f 6c 29 0a 09 69 66 20   tx, symbol)..if 
109f0	65 72 72 20 21 3d 20 6e  69 6c 20 7b 0a 09 09 72   err != nil {...r
10a00	65 74 75 72 6e 20 6e 69  6c 2c 20 65 72 72 0a 09   eturn nil, err..
10a10	7d 0a 0a 09 6d 6c 43 61  63 68 65 2e 53 65 74 50   }...mlCache.SetP
10a20	72 65 64 69 63 74 69 6f  6e 28 69 6e 64 65 78 2c   rediction(index,
10a30	20 70 72 65 64 69 63 74  69 6f 6e 29 0a 09 72 65    prediction)..re
10a40	74 75 72 6e 20 70 72 65  64 69 63 74 69 6f 6e 2c   turn prediction,
10a50	20 6e 69 6c 0a 7d 0a 0a  2f 2f 20 67 65 74 4f 72    nil.}..// getOr
10a60	43 72 65 61 74 65 44 65  63 69 73 69 6f 6e 43 61   CreateDecisionCa
10a70	63 68 65 20 e8 8e b7 e5  8f 96 e6 88 96 e5 88 9b   che ............
10a80	e5 bb ba e5 86 b3 e7 ad  96 e7 bc 93 e5 ad 98 0a   ................
10a90	66 75 6e 63 20 28 62 65  20 2a 42 61 63 6b 74 65   func (be *Backte
10aa0	73 74 45 6e 67 69 6e 65  29 20 67 65 74 4f 72 43   stEngine) getOrC
10ab0	72 65 61 74 65 44 65 63  69 73 69 6f 6e 43 61 63   reateDecisionCac
10ac0	68 65 28 73 79 6d 62 6f  6c 20 73 74 72 69 6e 67   he(symbol string
10ad0	2c 20 73 74 61 72 74 44  61 74 65 2c 20 65 6e 64   , startDate, end
10ae0	44 61 74 65 20 74 69 6d  65 2e 54 69 6d 65 29 20   Date time.Time) 
10af0	2a 44 65 63 69 73 69 6f  6e 43 61 63 68 65 20 7b   *DecisionCache {
10b00	0a 09 62 65 2e 63 61 63  68 65 4d 75 74 65 78 2e   ..be.cacheMutex.
10b10	4c 6f 63 6b 28 29 0a 09  64 65 66 65 72 20 62 65   Lock()..defer be
10b20	2e 63 61 63 68 65 4d 75  74 65 78 2e 55 6e 6c 6f   .cacheMutex.Unlo
10b30	63 6b 28 29 0a 0a 09 6b  65 79 20 3a 3d 20 62 65   ck()...key := be
10b40	2e 67 65 74 46 65 61 74  75 72 65 43 61 63 68 65   .getFeatureCache
10b50	4b 65 79 28 73 79 6d 62  6f 6c 2c 20 73 74 61 72   Key(symbol, star
10b60	74 44 61 74 65 2c 20 65  6e 64 44 61 74 65 29 0a   tDate, endDate).
10b70	09 69 66 20 63 61 63 68  65 2c 20 65 78 69 73 74   .if cache, exist
10b80	73 20 3a 3d 20 62 65 2e  64 65 63 69 73 69 6f 6e   s := be.decision
10b90	43 61 63 68 65 5b 6b 65  79 5d 3b 20 65 78 69 73   Cache[key]; exis
10ba0	74 73 20 7b 0a 09 09 72  65 74 75 72 6e 20 63 61   ts {...return ca
10bb0	63 68 65 0a 09 7d 0a 0a  09 63 61 63 68 65 20 3a   che..}...cache :
10bc0	3d 20 4e 65 77 44 65 63  69 73 69 6f 6e 43 61 63   = NewDecisionCac
10bd0	68 65 28 73 79 6d 62 6f  6c 2c 20 73 74 61 72 74   he(symbol, start
10be0	44 61 74 65 2c 20 65 6e  64 44 61 74 65 29 0a 09   Date, endDate)..
10bf0	62 65 2e 64 65 63 69 73  69 6f 6e 43 61 63 68 65   be.decisionCache
10c00	5b 6b 65 79 5d 20 3d 20  63 61 63 68 65 0a 09 72   [key] = cache..r
10c10	65 74 75 72 6e 20 63 61  63 68 65 0a 7d 0a 0a 2f   eturn cache.}../
10c20	2f 20 67 65 74 43 61 63  68 65 64 44 65 63 69 73   / getCachedDecis
10c30	69 6f 6e 20 e8 8e b7 e5  8f 96 e7 bc 93 e5 ad 98   ion ............
10c40	e7 9a 84 e5 86 b3 e7 ad  96 e7 bb 93 e6 9e 9c ef   ................
10c50	bc 8c e5 a6 82 e6 9e 9c  e4 b8 8d e5 ad 98 e5 9c   ................
10c60	a8 e5 88 99 e5 ae 9e e6  97 b6 e8 ae a1 e7 ae 97   ................
10c70	0a 66 75 6e 63 20 28 62  65 20 2a 42 61 63 6b 74   .func (be *Backt
10c80	65 73 74 45 6e 67 69 6e  65 29 20 67 65 74 43 61   estEngine) getCa
10c90	63 68 65 64 44 65 63 69  73 69 6f 6e 28 73 74 61   chedDecision(sta
10ca0	74 65 20 6d 61 70 5b 73  74 72 69 6e 67 5d 66 6c   te map[string]fl
10cb0	6f 61 74 36 34 2c 20 61  67 65 6e 74 20 6d 61 70   oat64, agent map
10cc0	5b 73 74 72 69 6e 67 5d  69 6e 74 65 72 66 61 63   [string]interfac
10cd0	65 7b 7d 2c 20 69 6e 64  65 78 20 69 6e 74 2c 20   e{}, index int, 
10ce0	73 79 6d 62 6f 6c 20 73  74 72 69 6e 67 2c 20 64   symbol string, d
10cf0	61 74 61 20 5b 5d 4d 61  72 6b 65 74 44 61 74 61   ata []MarketData
10d00	2c 20 73 74 61 72 74 44  61 74 65 2c 20 65 6e 64   , startDate, end
10d10	44 61 74 65 20 74 69 6d  65 2e 54 69 6d 65 29 20   Date time.Time) 
10d20	28 73 74 72 69 6e 67 2c  20 66 6c 6f 61 74 36 34   (string, float64
10d30	29 20 7b 0a 09 64 65 63  69 73 69 6f 6e 43 61 63   ) {..decisionCac
10d40	68 65 20 3a 3d 20 62 65  2e 67 65 74 4f 72 43 72   he := be.getOrCr
10d50	65 61 74 65 44 65 63 69  73 69 6f 6e 43 61 63 68   eateDecisionCach
10d60	65 28 73 79 6d 62 6f 6c  2c 20 73 74 61 72 74 44   e(symbol, startD
10d70	61 74 65 2c 20 65 6e 64  44 61 74 65 29 0a 0a 09   ate, endDate)...
10d80	2f 2f 20 e5 b0 9d e8 af  95 e4 bb 8e e7 bc 93 e5   // .............
10d90	ad 98 e8 8e b7 e5 8f 96  0a 09 69 66 20 64 65 63   ..........if dec
10da0	69 73 69 6f 6e 2c 20 65  78 69 73 74 73 20 3a 3d   ision, exists :=
10db0	20 64 65 63 69 73 69 6f  6e 43 61 63 68 65 2e 47    decisionCache.G
10dc0	65 74 44 65 63 69 73 69  6f 6e 28 73 74 61 74 65   etDecision(state
10dd0	2c 20 61 67 65 6e 74 2c  20 69 6e 64 65 78 29 3b   , agent, index);
10de0	20 65 78 69 73 74 73 20  7b 0a 09 09 72 65 74 75    exists {...retu
10df0	72 6e 20 64 65 63 69 73  69 6f 6e 2e 41 63 74 69   rn decision.Acti
10e00	6f 6e 2c 20 64 65 63 69  73 69 6f 6e 2e 43 6f 6e   on, decision.Con
10e10	66 69 64 65 6e 63 65 0a  09 7d 0a 0a 09 2f 2f 20   fidence..}...// 
10e20	e7 bc 93 e5 ad 98 e4 b8  8d e5 ad 98 e5 9c a8 ef   ................
10e30	bc 8c e5 ae 9e e6 97 b6  e8 ae a1 e7 ae 97 e5 b9   ................
10e40	b6 e7 bc 93 e5 ad 98 0a  09 61 63 74 69 6f 6e 2c   .........action,
10e50	20 63 6f 6e 66 69 64 65  6e 63 65 20 3a 3d 20 62    confidence := b
10e60	65 2e 72 75 6c 65 42 61  73 65 64 44 65 63 69 73   e.ruleBasedDecis
10e70	69 6f 6e 28 73 74 61 74  65 2c 20 61 67 65 6e 74   ion(state, agent
10e80	29 0a 09 64 65 63 69 73  69 6f 6e 43 61 63 68 65   )..decisionCache
10e90	2e 53 65 74 44 65 63 69  73 69 6f 6e 28 73 74 61   .SetDecision(sta
10ea0	74 65 2c 20 61 67 65 6e  74 2c 20 69 6e 64 65 78   te, agent, index
10eb0	2c 20 61 63 74 69 6f 6e  2c 20 63 6f 6e 66 69 64   , action, confid
10ec0	65 6e 63 65 29 0a 0a 09  72 65 74 75 72 6e 20 61   ence)...return a
10ed0	63 74 69 6f 6e 2c 20 63  6f 6e 66 69 64 65 6e 63   ction, confidenc
10ee0	65 0a 7d 0a 0a 2f 2f 20  73 68 6f 75 6c 64 42 6c   e.}..// shouldBl
10ef0	6f 63 6b 54 72 61 64 65  44 75 65 54 6f 44 72 61   ockTradeDueToDra
10f00	77 64 6f 77 6e 20 e6 a3  80 e6 9f a5 e6 98 af e5   wdown ..........
10f10	90 a6 e5 9b a0 e5 9b 9e  e6 92 a4 e9 99 90 e5 88   ................
10f20	b6 e8 80 8c e9 98 bb e6  ad a2 e4 ba a4 e6 98 93   ................
10f30	0a 66 75 6e 63 20 28 62  65 20 2a 42 61 63 6b 74   .func (be *Backt
10f40	65 73 74 45 6e 67 69 6e  65 29 20 73 68 6f 75 6c   estEngine) shoul
10f50	64 42 6c 6f 63 6b 54 72  61 64 65 44 75 65 54 6f   dBlockTradeDueTo
10f60	44 72 61 77 64 6f 77 6e  28 72 65 73 75 6c 74 20   Drawdown(result 
10f70	2a 42 61 63 6b 74 65 73  74 52 65 73 75 6c 74 2c   *BacktestResult,
10f80	20 63 6f 6e 66 69 67 20  2a 42 61 63 6b 74 65 73    config *Backtes
10f90	74 43 6f 6e 66 69 67 29  20 62 6f 6f 6c 20 7b 0a   tConfig) bool {.
10fa0	09 2f 2f 20 e8 ae a1 e7  ae 97 e5 bd 93 e5 89 8d   .// ............
10fb0	e6 9c 80 e5 a4 a7 e5 9b  9e e6 92 a4 0a 09 63 75   ..............cu
10fc0	72 72 65 6e 74 44 72 61  77 64 6f 77 6e 20 3a 3d   rrentDrawdown :=
10fd0	20 62 65 2e 63 61 6c 63  75 6c 61 74 65 43 75 72    be.calculateCur
10fe0	72 65 6e 74 4d 61 78 44  72 61 77 64 6f 77 6e 28   rentMaxDrawdown(
10ff0	72 65 73 75 6c 74 29 0a  0a 09 2f 2f 20 e6 9c 80   result)...// ...
11000	e5 a4 a7 e5 9b 9e e6 92  a4 e9 98 88 e5 80 bc 20   ............... 
11010	2d 20 e6 a0 b9 e6 8d ae  e5 b8 82 e5 9c ba e6 b3   - ..............
11020	a2 e5 8a a8 e6 80 a7 e5  8a a8 e6 80 81 e8 b0 83   ................
11030	e6 95 b4 0a 09 6d 61 78  44 72 61 77 64 6f 77 6e   .....maxDrawdown
11040	4c 69 6d 69 74 20 3a 3d  20 62 65 2e 63 61 6c 63   Limit := be.calc
11050	75 6c 61 74 65 41 64 61  70 74 69 76 65 44 72 61   ulateAdaptiveDra
11060	77 64 6f 77 6e 4c 69 6d  69 74 28 29 0a 0a 09 2f   wdownLimit().../
11070	2f 20 e5 a6 82 e6 9e 9c  e8 b6 85 e8 bf 87 e9 99   / ..............
11080	90 e5 88 b6 ef bc 8c e9  98 bb e6 ad a2 e6 96 b0   ................
11090	e4 ba a4 e6 98 93 0a 09  69 66 20 63 75 72 72 65   ........if curre
110a0	6e 74 44 72 61 77 64 6f  77 6e 20 3e 20 6d 61 78   ntDrawdown > max
110b0	44 72 61 77 64 6f 77 6e  4c 69 6d 69 74 20 7b 0a   DrawdownLimit {.
110c0	09 09 6c 6f 67 2e 50 72  69 6e 74 66 28 22 5b 44   ..log.Printf("[D
110d0	52 41 57 44 4f 57 4e 5f  43 4f 4e 54 52 4f 4c 5d   RAWDOWN_CONTROL]
110e0	20 e5 bd 93 e5 89 8d e5  9b 9e e6 92 a4 25 2e 32    ............%.2
110f0	66 25 25 e8 b6 85 e8 bf  87 e9 99 90 e5 88 b6 25   f%%............%
11100	2e 32 66 25 25 ef bc 8c  e6 9a 82 e5 81 9c e6 96   .2f%%...........
11110	b0 e4 ba a4 e6 98 93 22  2c 0a 09 09 09 63 75 72   .......",....cur
11120	72 65 6e 74 44 72 61 77  64 6f 77 6e 2a 31 30 30   rentDrawdown*100
11130	2c 20 6d 61 78 44 72 61  77 64 6f 77 6e 4c 69 6d   , maxDrawdownLim
11140	69 74 2a 31 30 30 29 0a  09 09 72 65 74 75 72 6e   it*100)...return
11150	20 74 72 75 65 0a 09 7d  0a 0a 09 2f 2f 20 e6 a3    true..}...// ..
11160	80 e6 9f a5 e8 bf 91 e6  9c 9f e5 9b 9e e6 92 a4   ................
11170	e8 b6 8b e5 8a bf 0a 09  72 65 63 65 6e 74 44 72   ........recentDr
11180	61 77 64 6f 77 6e 54 72  65 6e 64 20 3a 3d 20 62   awdownTrend := b
11190	65 2e 63 61 6c 63 75 6c  61 74 65 52 65 63 65 6e   e.calculateRecen
111a0	74 44 72 61 77 64 6f 77  6e 54 72 65 6e 64 28 72   tDrawdownTrend(r
111b0	65 73 75 6c 74 29 0a 09  69 66 20 72 65 63 65 6e   esult)..if recen
111c0	74 44 72 61 77 64 6f 77  6e 54 72 65 6e 64 20 3e   tDrawdownTrend >
111d0	20 30 2e 30 35 20 7b 20  2f 2f 20 e5 9b 9e e6 92    0.05 { // .....
111e0	a4 e5 91 88 e4 b8 8a e5  8d 87 e8 b6 8b e5 8a bf   ................
111f0	0a 09 09 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   ...log.Printf("[
11200	44 52 41 57 44 4f 57 4e  5f 43 4f 4e 54 52 4f 4c   DRAWDOWN_CONTROL
11210	5d 20 e5 9b 9e e6 92 a4  e5 91 88 e4 b8 8a e5 8d   ] ..............
11220	87 e8 b6 8b e5 8a bf 25  2e 32 66 25 25 ef bc 8c   .......%.2f%%...
11230	e8 b0 a8 e6 85 8e e6 8e  a7 e5 88 b6 e4 ba a4 e6   ................
11240	98 93 22 2c 0a 09 09 09  72 65 63 65 6e 74 44 72   ..",....recentDr
11250	61 77 64 6f 77 6e 54 72  65 6e 64 2a 31 30 30 29   awdownTrend*100)
11260	0a 09 09 2f 2f 20 e5 8f  af e4 bb a5 e9 80 89 e6   ...// ..........
11270	8b a9 e9 99 8d e4 bd 8e  e4 bb 93 e4 bd 8d e8 80   ................
11280	8c e4 b8 8d e6 98 af e5  ae 8c e5 85 a8 e5 81 9c   ................
11290	e6 ad a2 0a 09 7d 0a 0a  09 72 65 74 75 72 6e 20   .....}...return 
112a0	66 61 6c 73 65 0a 7d 0a  0a 2f 2f 20 63 61 6c 63   false.}..// calc
112b0	75 6c 61 74 65 41 64 61  70 74 69 76 65 44 72 61   ulateAdaptiveDra
112c0	77 64 6f 77 6e 4c 69 6d  69 74 20 e8 ae a1 e7 ae   wdownLimit .....
112d0	97 e8 87 aa e9 80 82 e5  ba 94 e7 9a 84 e5 9b 9e   ................
112e0	e6 92 a4 e9 99 90 e5 88  b6 0a 66 75 6e 63 20 28   ..........func (
112f0	62 65 20 2a 42 61 63 6b  74 65 73 74 45 6e 67 69   be *BacktestEngi
11300	6e 65 29 20 63 61 6c 63  75 6c 61 74 65 41 64 61   ne) calculateAda
11310	70 74 69 76 65 44 72 61  77 64 6f 77 6e 4c 69 6d   ptiveDrawdownLim
11320	69 74 28 29 20 66 6c 6f  61 74 36 34 20 7b 0a 09   it() float64 {..
11330	2f 2f 20 e5 9f ba e7 a1  80 e5 9b 9e e6 92 a4 e9   // .............
11340	99 90 e5 88 b6 ef bc 9a  e5 af b9 e4 ba 8e e5 8a   ................
11350	a0 e5 af 86 e8 b4 a7 e5  b8 81 ef bc 8c e8 ae be   ................
11360	e7 bd ae e5 9c a8 32 30  2d 33 30 25 e4 b9 8b e9   ......20-30%....
11370	97 b4 0a 09 62 61 73 65  4c 69 6d 69 74 20 3a 3d   ....baseLimit :=
11380	20 30 2e 32 35 20 2f 2f  20 32 35 25 0a 0a 09 2f    0.25 // 25%.../
11390	2f 20 e6 a0 b9 e6 8d ae  e5 b8 82 e5 9c ba e6 b3   / ..............
113a0	a2 e5 8a a8 e6 80 a7 e8  b0 83 e6 95 b4 0a 09 2f   .............../
113b0	2f 20 e8 bf 99 e9 87 8c  e5 8f af e4 bb a5 e6 a0   / ..............
113c0	b9 e6 8d ae e5 8e 86 e5  8f b2 e6 b3 a2 e5 8a a8   ................
113d0	e7 8e 87 e3 80 81 e5 b8  82 e5 9c ba e7 8e af e5   ................
113e0	a2 83 e7 ad 89 e5 8a a8  e6 80 81 e8 b0 83 e6 95   ................
113f0	b4 0a 09 2f 2f 20 e6 9a  82 e6 97 b6 e8 bf 94 e5   ...// ..........
11400	9b 9e e5 9f ba e7 a1 80  e9 99 90 e5 88 b6 0a 09   ................
11410	72 65 74 75 72 6e 20 62  61 73 65 4c 69 6d 69 74   return baseLimit
11420	0a 7d 0a 0a 2f 2f 20 63  61 6c 63 75 6c 61 74 65   .}..// calculate
11430	43 75 72 72 65 6e 74 4d  61 78 44 72 61 77 64 6f   CurrentMaxDrawdo
11440	77 6e 20 e8 ae a1 e7 ae  97 e5 bd 93 e5 89 8d e6   wn .............
11450	9c 80 e5 a4 a7 e5 9b 9e  e6 92 a4 0a 66 75 6e 63   ............func
11460	20 28 62 65 20 2a 42 61  63 6b 74 65 73 74 45 6e    (be *BacktestEn
11470	67 69 6e 65 29 20 63 61  6c 63 75 6c 61 74 65 43   gine) calculateC
11480	75 72 72 65 6e 74 4d 61  78 44 72 61 77 64 6f 77   urrentMaxDrawdow
11490	6e 28 72 65 73 75 6c 74  20 2a 42 61 63 6b 74 65   n(result *Backte
114a0	73 74 52 65 73 75 6c 74  29 20 66 6c 6f 61 74 36   stResult) float6
114b0	34 20 7b 0a 09 69 66 20  6c 65 6e 28 72 65 73 75   4 {..if len(resu
114c0	6c 74 2e 50 6f 72 74 66  6f 6c 69 6f 56 61 6c 75   lt.PortfolioValu
114d0	65 73 29 20 3c 20 32 20  7b 0a 09 09 72 65 74 75   es) < 2 {...retu
114e0	72 6e 20 30 2e 30 0a 09  7d 0a 0a 09 2f 2f 20 e6   rn 0.0..}...// .
114f0	89 be e5 88 b0 e5 8e 86  e5 8f b2 e6 9c 80 e9 ab   ................
11500	98 e7 82 b9 0a 09 70 65  61 6b 20 3a 3d 20 72 65   ......peak := re
11510	73 75 6c 74 2e 50 6f 72  74 66 6f 6c 69 6f 56 61   sult.PortfolioVa
11520	6c 75 65 73 5b 30 5d 0a  09 66 6f 72 20 5f 2c 20   lues[0]..for _, 
11530	76 61 6c 75 65 20 3a 3d  20 72 61 6e 67 65 20 72   value := range r
11540	65 73 75 6c 74 2e 50 6f  72 74 66 6f 6c 69 6f 56   esult.PortfolioV
11550	61 6c 75 65 73 20 7b 0a  09 09 69 66 20 76 61 6c   alues {...if val
11560	75 65 20 3e 20 70 65 61  6b 20 7b 0a 09 09 09 70   ue > peak {....p
11570	65 61 6b 20 3d 20 76 61  6c 75 65 0a 09 09 7d 0a   eak = value...}.
11580	09 7d 0a 0a 09 2f 2f 20  e8 ae a1 e7 ae 97 e5 bd   .}...// ........
11590	93 e5 89 8d e5 9b 9e e6  92 a4 0a 09 63 75 72 72   ............curr
115a0	65 6e 74 56 61 6c 75 65  20 3a 3d 20 72 65 73 75   entValue := resu
115b0	6c 74 2e 50 6f 72 74 66  6f 6c 69 6f 56 61 6c 75   lt.PortfolioValu
115c0	65 73 5b 6c 65 6e 28 72  65 73 75 6c 74 2e 50 6f   es[len(result.Po
115d0	72 74 66 6f 6c 69 6f 56  61 6c 75 65 73 29 2d 31   rtfolioValues)-1
115e0	5d 0a 09 69 66 20 70 65  61 6b 20 3c 3d 20 30 20   ]..if peak <= 0 
115f0	7b 0a 09 09 72 65 74 75  72 6e 20 30 2e 30 0a 09   {...return 0.0..
11600	7d 0a 0a 09 64 72 61 77  64 6f 77 6e 20 3a 3d 20   }...drawdown := 
11610	28 70 65 61 6b 20 2d 20  63 75 72 72 65 6e 74 56   (peak - currentV
11620	61 6c 75 65 29 20 2f 20  70 65 61 6b 0a 09 72 65   alue) / peak..re
11630	74 75 72 6e 20 6d 61 74  68 2e 4d 61 78 28 30 2e   turn math.Max(0.
11640	30 2c 20 64 72 61 77 64  6f 77 6e 29 0a 7d 0a 0a   0, drawdown).}..
11650	2f 2f 20 63 61 6c 63 75  6c 61 74 65 52 65 63 65   // calculateRece
11660	6e 74 44 72 61 77 64 6f  77 6e 54 72 65 6e 64 20   ntDrawdownTrend 
11670	e8 ae a1 e7 ae 97 e8 bf  91 e6 9c 9f e5 9b 9e e6   ................
11680	92 a4 e8 b6 8b e5 8a bf  0a 66 75 6e 63 20 28 62   .........func (b
11690	65 20 2a 42 61 63 6b 74  65 73 74 45 6e 67 69 6e   e *BacktestEngin
116a0	65 29 20 63 61 6c 63 75  6c 61 74 65 52 65 63 65   e) calculateRece
116b0	6e 74 44 72 61 77 64 6f  77 6e 54 72 65 6e 64 28   ntDrawdownTrend(
116c0	72 65 73 75 6c 74 20 2a  42 61 63 6b 74 65 73 74   result *Backtest
116d0	52 65 73 75 6c 74 29 20  66 6c 6f 61 74 36 34 20   Result) float64 
116e0	7b 0a 09 69 66 20 6c 65  6e 28 72 65 73 75 6c 74   {..if len(result
116f0	2e 50 6f 72 74 66 6f 6c  69 6f 56 61 6c 75 65 73   .PortfolioValues
11700	29 20 3c 20 31 30 20 7b  0a 09 09 72 65 74 75 72   ) < 10 {...retur
11710	6e 20 30 2e 30 0a 09 7d  0a 0a 09 2f 2f 20 e5 8f   n 0.0..}...// ..
11720	96 e6 9c 80 e8 bf 91 31  30 e4 b8 aa e7 82 b9 e7   .......10.......
11730	9a 84 e5 9b 9e e6 92 a4  e5 8f 98 e5 8c 96 0a 09   ................
11740	72 65 63 65 6e 74 20 3a  3d 20 72 65 73 75 6c 74   recent := result
11750	2e 50 6f 72 74 66 6f 6c  69 6f 56 61 6c 75 65 73   .PortfolioValues
11760	5b 6c 65 6e 28 72 65 73  75 6c 74 2e 50 6f 72 74   [len(result.Port
11770	66 6f 6c 69 6f 56 61 6c  75 65 73 29 2d 31 30 3a   folioValues)-10:
11780	5d 0a 09 70 65 61 6b 20  3a 3d 20 72 65 63 65 6e   ]..peak := recen
11790	74 5b 30 5d 0a 0a 09 74  72 65 6e 64 53 75 6d 20   t[0]...trendSum 
117a0	3a 3d 20 30 2e 30 0a 09  63 6f 75 6e 74 20 3a 3d   := 0.0..count :=
117b0	20 30 0a 0a 09 66 6f 72  20 69 20 3a 3d 20 31 3b    0...for i := 1;
117c0	20 69 20 3c 20 6c 65 6e  28 72 65 63 65 6e 74 29    i < len(recent)
117d0	3b 20 69 2b 2b 20 7b 0a  09 09 69 66 20 72 65 63   ; i++ {...if rec
117e0	65 6e 74 5b 69 5d 20 3e  20 70 65 61 6b 20 7b 0a   ent[i] > peak {.
117f0	09 09 09 70 65 61 6b 20  3d 20 72 65 63 65 6e 74   ...peak = recent
11800	5b 69 5d 0a 09 09 7d 0a  0a 09 09 69 66 20 70 65   [i]...}....if pe
11810	61 6b 20 3e 20 30 20 7b  0a 09 09 09 63 75 72 72   ak > 0 {....curr
11820	65 6e 74 44 72 61 77 64  6f 77 6e 20 3a 3d 20 28   entDrawdown := (
11830	70 65 61 6b 20 2d 20 72  65 63 65 6e 74 5b 69 5d   peak - recent[i]
11840	29 20 2f 20 70 65 61 6b  0a 09 09 09 70 72 65 76   ) / peak....prev
11850	69 6f 75 73 44 72 61 77  64 6f 77 6e 20 3a 3d 20   iousDrawdown := 
11860	30 2e 30 0a 09 09 09 69  66 20 69 20 3e 20 31 20   0.0....if i > 1 
11870	7b 0a 09 09 09 09 70 72  65 76 69 6f 75 73 44 72   {.....previousDr
11880	61 77 64 6f 77 6e 20 3d  20 28 70 65 61 6b 20 2d   awdown = (peak -
11890	20 72 65 63 65 6e 74 5b  69 2d 31 5d 29 20 2f 20    recent[i-1]) / 
118a0	70 65 61 6b 0a 09 09 09  7d 0a 0a 09 09 09 2f 2f   peak....}.....//
118b0	20 e8 ae a1 e7 ae 97 e5  9b 9e e6 92 a4 e5 8f 98    ...............
118c0	e5 8c 96 e8 b6 8b e5 8a  bf 0a 09 09 09 74 72 65   .............tre
118d0	6e 64 53 75 6d 20 2b 3d  20 63 75 72 72 65 6e 74   ndSum += current
118e0	44 72 61 77 64 6f 77 6e  20 2d 20 70 72 65 76 69   Drawdown - previ
118f0	6f 75 73 44 72 61 77 64  6f 77 6e 0a 09 09 09 63   ousDrawdown....c
11900	6f 75 6e 74 2b 2b 0a 09  09 7d 0a 09 7d 0a 0a 09   ount++...}..}...
11910	69 66 20 63 6f 75 6e 74  20 3d 3d 20 30 20 7b 0a   if count == 0 {.
11920	09 09 72 65 74 75 72 6e  20 30 2e 30 0a 09 7d 0a   ..return 0.0..}.
11930	0a 09 72 65 74 75 72 6e  20 74 72 65 6e 64 53 75   ..return trendSu
11940	6d 20 2f 20 66 6c 6f 61  74 36 34 28 63 6f 75 6e   m / float64(coun
11950	74 29 0a 7d 0a 0a 2f 2f  20 61 70 70 6c 79 45 6d   t).}..// applyEm
11960	65 72 67 65 6e 63 79 52  69 73 6b 43 6f 6e 74 72   ergencyRiskContr
11970	6f 6c 73 20 e5 ba 94 e7  94 a8 e7 b4 a7 e6 80 a5   ols ............
11980	e9 a3 8e e9 99 a9 e6 8e  a7 e5 88 b6 0a 66 75 6e   .............fun
11990	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
119a0	6e 67 69 6e 65 29 20 61  70 70 6c 79 45 6d 65 72   ngine) applyEmer
119b0	67 65 6e 63 79 52 69 73  6b 43 6f 6e 74 72 6f 6c   gencyRiskControl
119c0	73 28 72 65 73 75 6c 74  20 2a 42 61 63 6b 74 65   s(result *Backte
119d0	73 74 52 65 73 75 6c 74  2c 20 63 6f 6e 66 69 67   stResult, config
119e0	20 2a 42 61 63 6b 74 65  73 74 43 6f 6e 66 69 67    *BacktestConfig
119f0	29 20 7b 0a 09 63 75 72  72 65 6e 74 44 72 61 77   ) {..currentDraw
11a00	64 6f 77 6e 20 3a 3d 20  62 65 2e 63 61 6c 63 75   down := be.calcu
11a10	6c 61 74 65 43 75 72 72  65 6e 74 4d 61 78 44 72   lateCurrentMaxDr
11a20	61 77 64 6f 77 6e 28 72  65 73 75 6c 74 29 0a 0a   awdown(result)..
11a30	09 2f 2f 20 e7 b4 a7 e6  80 a5 e5 9b 9e e6 92 a4   .// ............
11a40	e6 8e a7 e5 88 b6 e9 98  88 e5 80 bc 0a 09 63 72   ..............cr
11a50	69 74 69 63 61 6c 44 72  61 77 64 6f 77 6e 20 3a   iticalDrawdown :
11a60	3d 20 30 2e 32 35 20 2f  2f 20 32 35 25 e7 b4 a7   = 0.25 // 25%...
11a70	e6 80 a5 e9 98 88 e5 80  bc 0a 09 73 65 76 65 72   ...........sever
11a80	65 44 72 61 77 64 6f 77  6e 20 3a 3d 20 30 2e 32   eDrawdown := 0.2
11a90	30 20 20 20 2f 2f 20 32  30 25 e4 b8 a5 e9 87 8d   0   // 20%......
11aa0	e9 98 88 e5 80 bc 0a 0a  09 69 66 20 63 75 72 72   .........if curr
11ab0	65 6e 74 44 72 61 77 64  6f 77 6e 20 3e 20 63 72   entDrawdown > cr
11ac0	69 74 69 63 61 6c 44 72  61 77 64 6f 77 6e 20 7b   iticalDrawdown {
11ad0	0a 09 09 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   ...log.Printf("[
11ae0	45 4d 45 52 47 45 4e 43  59 5f 43 4f 4e 54 52 4f   EMERGENCY_CONTRO
11af0	4c 5d 20 f0 9f 9a a8 20  e7 b4 a7 e6 80 a5 e7 8a   L] .... ........
11b00	b6 e6 80 81 ef bc 81 e5  9b 9e e6 92 a4 e8 be be   ................
11b10	25 2e 32 66 25 25 ef bc  8c e6 89 a7 e8 a1 8c e7   %.2f%%..........
11b20	b4 a7 e6 80 a5 e9 a3 8e  e9 99 a9 e6 8e a7 e5 88   ................
11b30	b6 22 2c 20 63 75 72 72  65 6e 74 44 72 61 77 64   .", currentDrawd
11b40	6f 77 6e 2a 31 30 30 29  0a 09 09 2f 2f 20 e5 8f   own*100)...// ..
11b50	af e4 bb a5 e5 9c a8 e8  bf 99 e9 87 8c e6 89 a7   ................
11b60	e8 a1 8c ef bc 9a e5 bc  ba e5 88 b6 e5 b9 b3 e4   ................
11b70	bb 93 e3 80 81 e6 9a 82  e5 81 9c e4 ba a4 e6 98   ................
11b80	93 e3 80 81 e9 99 8d e4  bd 8e e4 bb 93 e4 bd 8d   ................
11b90	e7 ad 89 e7 b4 a7 e6 80  a5 e6 8e aa e6 96 bd 0a   ................
11ba0	09 7d 20 65 6c 73 65 20  69 66 20 63 75 72 72 65   .} else if curre
11bb0	6e 74 44 72 61 77 64 6f  77 6e 20 3e 20 73 65 76   ntDrawdown > sev
11bc0	65 72 65 44 72 61 77 64  6f 77 6e 20 7b 0a 09 09   ereDrawdown {...
11bd0	6c 6f 67 2e 50 72 69 6e  74 66 28 22 5b 53 45 56   log.Printf("[SEV
11be0	45 52 45 5f 43 4f 4e 54  52 4f 4c 5d 20 e2 9a a0   ERE_CONTROL] ...
11bf0	ef b8 8f 20 e4 b8 a5 e9  87 8d e8 ad a6 e5 91 8a   ... ............
11c00	ef bc 81 e5 9b 9e e6 92  a4 e8 be be 25 2e 32 66   ............%.2f
11c10	25 25 ef bc 8c e6 89 a7  e8 a1 8c e4 b8 a5 e6 a0   %%..............
11c20	bc e9 a3 8e e9 99 a9 e6  8e a7 e5 88 b6 22 2c 20   .............", 
11c30	63 75 72 72 65 6e 74 44  72 61 77 64 6f 77 6e 2a   currentDrawdown*
11c40	31 30 30 29 0a 09 09 2f  2f 20 e6 89 a7 e8 a1 8c   100)...// ......
11c50	e4 b8 a5 e6 a0 bc e6 8e  a7 e5 88 b6 ef bc 9a e5   ................
11c60	a4 a7 e5 b9 85 e9 99 8d  e4 bd 8e e4 bb 93 e4 bd   ................
11c70	8d e3 80 81 e6 94 b6 e7  b4 a7 e6 ad a2 e6 8d 9f   ................
11c80	e7 ad 89 0a 09 7d 0a 7d  0a 0a 2f 2f 20 3d 3d 3d   .....}.}..// ===
11c90	3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d   ================
11ca0	20 e5 a4 9a e5 b8 81 e7  a7 8d e7 ad 96 e7 95 a5    ...............
11cb0	e4 bc 98 e5 8c 96 20 3d  3d 3d 3d 3d 3d 3d 3d 3d   ...... =========
11cc0	3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 0a 0a 2f 2f 20 53   ==========..// S
11cd0	79 6d 62 6f 6c 4f 70 70  6f 72 74 75 6e 69 74 79   ymbolOpportunity
11ce0	20 e5 b8 81 e7 a7 8d e4  ba a4 e6 98 93 e6 9c ba    ...............
11cf0	e4 bc 9a 0a 74 79 70 65  20 53 79 6d 62 6f 6c 4f   ....type SymbolO
11d00	70 70 6f 72 74 75 6e 69  74 79 20 73 74 72 75 63   pportunity struc
11d10	74 20 7b 0a 09 53 79 6d  62 6f 6c 20 20 20 20 20   t {..Symbol     
11d20	20 20 20 20 73 74 72 69  6e 67 0a 09 41 63 74 69       string..Acti
11d30	6f 6e 20 20 20 20 20 20  20 20 20 73 74 72 69 6e   on         strin
11d40	67 0a 09 43 6f 6e 66 69  64 65 6e 63 65 20 20 20   g..Confidence   
11d50	20 20 66 6c 6f 61 74 36  34 0a 09 42 61 73 65 53     float64..BaseS
11d60	63 6f 72 65 20 20 20 20  20 20 66 6c 6f 61 74 36   core      float6
11d70	34 0a 09 53 63 6f 72 65  20 20 20 20 20 20 20 20   4..Score        
11d80	20 20 66 6c 6f 61 74 36  34 20 2f 2f 20 e6 9c 80     float64 // ...
11d90	e7 bb 88 e9 a3 8e e9 99  a9 e8 b0 83 e6 95 b4 e5   ................
11da0	88 86 e6 95 b0 0a 09 50  72 69 63 65 20 20 20 20   .......Price    
11db0	20 20 20 20 20 20 66 6c  6f 61 74 36 34 0a 09 53         float64..S
11dc0	74 61 74 65 20 20 20 20  20 20 20 20 20 20 2a 53   tate          *S
11dd0	79 6d 62 6f 6c 53 74 61  74 65 0a 09 46 65 61 74   ymbolState..Feat
11de0	75 72 65 73 20 20 20 20  20 20 20 6d 61 70 5b 73   ures       map[s
11df0	74 72 69 6e 67 5d 66 6c  6f 61 74 36 34 0a 09 52   tring]float64..R
11e00	69 73 6b 53 63 6f 72 65  20 20 20 20 20 20 66 6c   iskScore      fl
11e10	6f 61 74 36 34 0a 09 4d  61 72 6b 65 74 53 63 6f   oat64..MarketSco
11e20	72 65 20 20 20 20 66 6c  6f 61 74 36 34 0a 09 52   re    float64..R
11e30	69 73 6b 41 64 6a 75 73  74 6d 65 6e 74 20 66 6c   iskAdjustment fl
11e40	6f 61 74 36 34 20 2f 2f  20 e9 a3 8e e9 99 a9 e8   oat64 // .......
11e50	b0 83 e6 95 b4 e5 9b a0  e5 ad 90 0a 09 52 65 61   .............Rea
11e60	73 6f 6e 20 20 20 20 20  20 20 20 20 73 74 72 69   son         stri
11e70	6e 67 20 20 2f 2f 20 e6  9c ba e4 bc 9a e7 b1 bb   ng  // .........
11e80	e5 9e 8b e5 8e 9f e5 9b  a0 0a 7d 0a 0a 2f 2f 20   ..........}..// 
11e90	4d 75 6c 74 69 53 79 6d  62 6f 6c 4d 61 72 6b 65   MultiSymbolMarke
11ea0	74 41 6e 61 6c 79 73 69  73 20 e5 a4 9a e5 b8 81   tAnalysis ......
11eb0	e7 a7 8d e5 b8 82 e5 9c  ba e5 88 86 e6 9e 90 0a   ................
11ec0	74 79 70 65 20 4d 75 6c  74 69 53 79 6d 62 6f 6c   type MultiSymbol
11ed0	4d 61 72 6b 65 74 41 6e  61 6c 79 73 69 73 20 73   MarketAnalysis s
11ee0	74 72 75 63 74 20 7b 0a  09 4d 61 72 6b 65 74 52   truct {..MarketR
11ef0	65 67 69 6d 65 20 20 20  20 20 20 20 20 20 73 74   egime         st
11f00	72 69 6e 67 0a 09 56 6f  6c 61 74 69 6c 69 74 79   ring..Volatility
11f10	49 6e 64 65 78 20 20 20  20 20 20 66 6c 6f 61 74   Index      float
11f20	36 34 0a 09 43 6f 72 72  65 6c 61 74 69 6f 6e 4d   64..CorrelationM
11f30	61 74 72 69 78 20 20 20  20 6d 61 70 5b 73 74 72   atrix    map[str
11f40	69 6e 67 5d 6d 61 70 5b  73 74 72 69 6e 67 5d 66   ing]map[string]f
11f50	6c 6f 61 74 36 34 0a 09  44 69 76 65 72 73 69 66   loat64..Diversif
11f60	69 63 61 74 69 6f 6e 53  63 6f 72 65 20 66 6c 6f   icationScore flo
11f70	61 74 36 34 0a 09 52 69  73 6b 43 6f 6e 63 65 6e   at64..RiskConcen
11f80	74 72 61 74 69 6f 6e 20  20 20 20 66 6c 6f 61 74   tration    float
11f90	36 34 0a 09 4f 70 70 6f  72 74 75 6e 69 74 79 44   64..OpportunityD
11fa0	65 6e 73 69 74 79 20 20  20 66 6c 6f 61 74 36 34   ensity   float64
11fb0	0a 7d 0a 0a 2f 2f 20 63  6f 6c 6c 65 63 74 53 79   .}..// collectSy
11fc0	6d 62 6f 6c 4f 70 70 6f  72 74 75 6e 69 74 69 65   mbolOpportunitie
11fd0	73 20 e6 94 b6 e9 9b 86  e6 89 80 e6 9c 89 e5 b8   s ..............
11fe0	81 e7 a7 8d e7 9a 84 e6  9c ba e4 bc 9a e4 bf a1   ................
11ff0	e6 81 af 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
12000	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 63 6f   cktestEngine) co
12010	6c 6c 65 63 74 53 79 6d  62 6f 6c 4f 70 70 6f 72   llectSymbolOppor
12020	74 75 6e 69 74 69 65 73  28 63 74 78 20 63 6f 6e   tunities(ctx con
12030	74 65 78 74 2e 43 6f 6e  74 65 78 74 2c 20 73 79   text.Context, sy
12040	6d 62 6f 6c 53 74 61 74  65 73 20 6d 61 70 5b 73   mbolStates map[s
12050	74 72 69 6e 67 5d 2a 53  79 6d 62 6f 6c 53 74 61   tring]*SymbolSta
12060	74 65 2c 20 61 67 65 6e  74 20 6d 61 70 5b 73 74   te, agent map[st
12070	72 69 6e 67 5d 69 6e 74  65 72 66 61 63 65 7b 7d   ring]interface{}
12080	2c 20 63 75 72 72 65 6e  74 49 6e 64 65 78 20 69   , currentIndex i
12090	6e 74 2c 20 63 6f 6e 66  69 67 20 2a 42 61 63 6b   nt, config *Back
120a0	74 65 73 74 43 6f 6e 66  69 67 29 20 5b 5d 2a 53   testConfig) []*S
120b0	79 6d 62 6f 6c 4f 70 70  6f 72 74 75 6e 69 74 79   ymbolOpportunity
120c0	20 7b 0a 09 76 61 72 20  6f 70 70 6f 72 74 75 6e    {..var opportun
120d0	69 74 69 65 73 20 5b 5d  2a 53 79 6d 62 6f 6c 4f   ities []*SymbolO
120e0	70 70 6f 72 74 75 6e 69  74 79 0a 0a 09 66 6f 72   pportunity...for
120f0	20 73 79 6d 62 6f 6c 2c  20 73 74 61 74 65 20 3a    symbol, state :
12100	3d 20 72 61 6e 67 65 20  73 79 6d 62 6f 6c 53 74   = range symbolSt
12110	61 74 65 73 20 7b 0a 09  09 69 66 20 63 75 72 72   ates {...if curr
12120	65 6e 74 49 6e 64 65 78  20 3e 3d 20 6c 65 6e 28   entIndex >= len(
12130	73 74 61 74 65 2e 44 61  74 61 29 20 7b 0a 09 09   state.Data) {...
12140	09 63 6f 6e 74 69 6e 75  65 0a 09 09 7d 0a 0a 09   .continue...}...
12150	09 63 75 72 72 65 6e 74  50 72 69 63 65 20 3a 3d   .currentPrice :=
12160	20 73 74 61 74 65 2e 44  61 74 61 5b 63 75 72 72    state.Data[curr
12170	65 6e 74 49 6e 64 65 78  5d 2e 50 72 69 63 65 0a   entIndex].Price.
12180	0a 09 09 2f 2f 20 e8 8e  b7 e5 8f 96 e7 bc 93 e5   ...// ..........
12190	ad 98 e7 9a 84 e7 89 b9  e5 be 81 0a 09 09 73 74   ..............st
121a0	61 74 65 46 65 61 74 75  72 65 73 20 3a 3d 20 62   ateFeatures := b
121b0	65 2e 67 65 74 43 61 63  68 65 64 46 65 61 74 75   e.getCachedFeatu
121c0	72 65 28 63 74 78 2c 20  73 74 61 74 65 2e 44 61   re(ctx, state.Da
121d0	74 61 2c 20 73 74 61 74  65 2e 44 61 74 61 5b 63   ta, state.Data[c
121e0	75 72 72 65 6e 74 49 6e  64 65 78 5d 2c 20 63 75   urrentIndex], cu
121f0	72 72 65 6e 74 49 6e 64  65 78 2c 20 73 79 6d 62   rrentIndex, symb
12200	6f 6c 2c 20 63 6f 6e 66  69 67 2e 53 74 61 72 74   ol, config.Start
12210	44 61 74 65 2c 20 63 6f  6e 66 69 67 2e 45 6e 64   Date, config.End
12220	44 61 74 65 29 0a 0a 09  09 2f 2f 20 e6 9b b4 e6   Date)....// ....
12230	96 b0 61 67 65 6e 74 e7  8a b6 e6 80 81 0a 09 09   ..agent.........
12240	61 67 65 6e 74 5b 22 73  79 6d 62 6f 6c 22 5d 20   agent["symbol"] 
12250	3d 20 73 79 6d 62 6f 6c  0a 09 09 61 67 65 6e 74   = symbol...agent
12260	5b 22 68 61 73 5f 70 6f  73 69 74 69 6f 6e 22 5d   ["has_position"]
12270	20 3d 20 73 74 61 74 65  2e 50 6f 73 69 74 69 6f    = state.Positio
12280	6e 20 3e 20 30 0a 09 09  61 67 65 6e 74 5b 22 68   n > 0...agent["h
12290	6f 6c 64 5f 74 69 6d 65  22 5d 20 3d 20 73 74 61   old_time"] = sta
122a0	74 65 2e 48 6f 6c 64 54  69 6d 65 0a 09 09 61 67   te.HoldTime...ag
122b0	65 6e 74 5b 22 63 75 72  72 65 6e 74 5f 70 72 69   ent["current_pri
122c0	63 65 22 5d 20 3d 20 63  75 72 72 65 6e 74 50 72   ce"] = currentPr
122d0	69 63 65 0a 0a 09 09 2f  2f 20 e5 86 b3 e7 ad 96   ice....// ......
122e0	e9 a2 91 e7 8e 87 e6 8e  a7 e5 88 b6 0a 09 09 74   ...............t
122f0	69 6d 65 53 69 6e 63 65  4c 61 73 74 54 72 61 64   imeSinceLastTrad
12300	65 20 3a 3d 20 63 75 72  72 65 6e 74 49 6e 64 65   e := currentInde
12310	78 20 2d 20 73 74 61 74  65 2e 4c 61 73 74 54 72   x - state.LastTr
12320	61 64 65 49 6e 64 65 78  0a 09 09 69 66 20 74 69   adeIndex...if ti
12330	6d 65 53 69 6e 63 65 4c  61 73 74 54 72 61 64 65   meSinceLastTrade
12340	20 3c 20 32 20 7b 0a 09  09 09 63 6f 6e 74 69 6e    < 2 {....contin
12350	75 65 0a 09 09 7d 0a 0a  09 09 2f 2f 20 e8 8e b7   ue...}....// ...
12360	e5 8f 96 e4 ba a4 e6 98  93 e5 86 b3 e7 ad 96 0a   ................
12370	09 09 61 63 74 69 6f 6e  2c 20 63 6f 6e 66 69 64   ..action, confid
12380	65 6e 63 65 20 3a 3d 20  62 65 2e 65 6e 68 61 6e   ence := be.enhan
12390	63 65 64 54 72 61 64 69  6e 67 44 65 63 69 73 69   cedTradingDecisi
123a0	6f 6e 28 73 74 61 74 65  46 65 61 74 75 72 65 73   on(stateFeatures
123b0	2c 20 61 67 65 6e 74 2c  20 63 75 72 72 65 6e 74   , agent, current
123c0	49 6e 64 65 78 2c 20 73  74 61 74 65 2e 44 61 74   Index, state.Dat
123d0	61 5b 3a 63 75 72 72 65  6e 74 49 6e 64 65 78 2b   a[:currentIndex+
123e0	31 5d 29 0a 0a 09 09 2f  2f 20 e5 8f aa e8 80 83   1])....// ......
123f0	e8 99 91 e4 b9 b0 e5 85  a5 e6 9c ba e4 bc 9a ef   ................
12400	bc 88 e6 97 a0 e6 8c 81  e4 bb 93 e6 97 b6 ef bc   ................
12410	89 0a 09 09 69 66 20 61  63 74 69 6f 6e 20 3d 3d   ....if action ==
12420	20 22 62 75 79 22 20 26  26 20 73 74 61 74 65 2e    "buy" && state.
12430	50 6f 73 69 74 69 6f 6e  20 3d 3d 20 30 20 26 26   Position == 0 &&
12440	20 63 6f 6e 66 69 64 65  6e 63 65 20 3e 20 30 2e    confidence > 0.
12450	31 20 7b 0a 09 09 09 62  61 73 65 53 63 6f 72 65   1 {....baseScore
12460	20 3a 3d 20 63 6f 6e 66  69 64 65 6e 63 65 20 2a    := confidence *
12470	20 62 65 2e 63 61 6c 63  75 6c 61 74 65 4f 70 70    be.calculateOpp
12480	6f 72 74 75 6e 69 74 79  53 63 6f 72 65 28 73 74   ortunityScore(st
12490	61 74 65 46 65 61 74 75  72 65 73 2c 20 73 79 6d   ateFeatures, sym
124a0	62 6f 6c 29 0a 0a 09 09  09 6f 70 70 6f 72 74 75   bol).....opportu
124b0	6e 69 74 79 20 3a 3d 20  26 53 79 6d 62 6f 6c 4f   nity := &SymbolO
124c0	70 70 6f 72 74 75 6e 69  74 79 7b 0a 09 09 09 09   pportunity{.....
124d0	53 79 6d 62 6f 6c 3a 20  20 20 20 20 73 79 6d 62   Symbol:     symb
124e0	6f 6c 2c 0a 09 09 09 09  41 63 74 69 6f 6e 3a 20   ol,.....Action: 
124f0	20 20 20 20 22 62 75 79  22 2c 0a 09 09 09 09 43       "buy",.....C
12500	6f 6e 66 69 64 65 6e 63  65 3a 20 63 6f 6e 66 69   onfidence: confi
12510	64 65 6e 63 65 2c 0a 09  09 09 09 42 61 73 65 53   dence,.....BaseS
12520	63 6f 72 65 3a 20 20 62  61 73 65 53 63 6f 72 65   core:  baseScore
12530	2c 0a 09 09 09 09 50 72  69 63 65 3a 20 20 20 20   ,.....Price:    
12540	20 20 63 75 72 72 65 6e  74 50 72 69 63 65 2c 0a     currentPrice,.
12550	09 09 09 09 53 74 61 74  65 3a 20 20 20 20 20 20   ....State:      
12560	73 74 61 74 65 2c 0a 09  09 09 09 46 65 61 74 75   state,.....Featu
12570	72 65 73 3a 20 20 20 73  74 61 74 65 46 65 61 74   res:   stateFeat
12580	75 72 65 73 2c 0a 09 09  09 09 52 65 61 73 6f 6e   ures,.....Reason
12590	3a 20 20 20 20 20 22 74  72 61 64 69 6e 67 5f 73   :     "trading_s
125a0	69 67 6e 61 6c 22 2c 0a  09 09 09 7d 0a 0a 09 09   ignal",....}....
125b0	09 6f 70 70 6f 72 74 75  6e 69 74 69 65 73 20 3d   .opportunities =
125c0	20 61 70 70 65 6e 64 28  6f 70 70 6f 72 74 75 6e    append(opportun
125d0	69 74 69 65 73 2c 20 6f  70 70 6f 72 74 75 6e 69   ities, opportuni
125e0	74 79 29 0a 09 09 7d 0a  09 7d 0a 0a 09 72 65 74   ty)...}..}...ret
125f0	75 72 6e 20 6f 70 70 6f  72 74 75 6e 69 74 69 65   urn opportunitie
12600	73 0a 7d 0a 0a 2f 2f 20  61 6e 61 6c 79 7a 65 4d   s.}..// analyzeM
12610	75 6c 74 69 53 79 6d 62  6f 6c 4d 61 72 6b 65 74   ultiSymbolMarket
12620	20 e8 bf 9b e8 a1 8c e5  a4 9a e5 b8 81 e7 a7 8d    ...............
12630	e5 b8 82 e5 9c ba e5 88  86 e6 9e 90 0a 66 75 6e   .............fun
12640	63 20 28 62 65 20 2a 42  61 63 6b 74 65 73 74 45   c (be *BacktestE
12650	6e 67 69 6e 65 29 20 61  6e 61 6c 79 7a 65 4d 75   ngine) analyzeMu
12660	6c 74 69 53 79 6d 62 6f  6c 4d 61 72 6b 65 74 28   ltiSymbolMarket(
12670	6f 70 70 6f 72 74 75 6e  69 74 69 65 73 20 5b 5d   opportunities []
12680	2a 53 79 6d 62 6f 6c 4f  70 70 6f 72 74 75 6e 69   *SymbolOpportuni
12690	74 79 2c 20 73 79 6d 62  6f 6c 53 74 61 74 65 73   ty, symbolStates
126a0	20 6d 61 70 5b 73 74 72  69 6e 67 5d 2a 53 79 6d    map[string]*Sym
126b0	62 6f 6c 53 74 61 74 65  2c 20 63 75 72 72 65 6e   bolState, curren
126c0	74 49 6e 64 65 78 20 69  6e 74 29 20 2a 4d 75 6c   tIndex int) *Mul
126d0	74 69 53 79 6d 62 6f 6c  4d 61 72 6b 65 74 41 6e   tiSymbolMarketAn
126e0	61 6c 79 73 69 73 20 7b  0a 09 61 6e 61 6c 79 73   alysis {..analys
126f0	69 73 20 3a 3d 20 26 4d  75 6c 74 69 53 79 6d 62   is := &MultiSymb
12700	6f 6c 4d 61 72 6b 65 74  41 6e 61 6c 79 73 69 73   olMarketAnalysis
12710	7b 0a 09 09 43 6f 72 72  65 6c 61 74 69 6f 6e 4d   {...CorrelationM
12720	61 74 72 69 78 3a 20 6d  61 6b 65 28 6d 61 70 5b   atrix: make(map[
12730	73 74 72 69 6e 67 5d 6d  61 70 5b 73 74 72 69 6e   string]map[strin
12740	67 5d 66 6c 6f 61 74 36  34 29 2c 0a 09 7d 0a 0a   g]float64),..}..
12750	09 2f 2f 20 31 2e 20 e7  a1 ae e5 ae 9a e6 95 b4   .// 1. .........
12760	e4 bd 93 e5 b8 82 e5 9c  ba e7 8e af e5 a2 83 0a   ................
12770	09 61 6e 61 6c 79 73 69  73 2e 4d 61 72 6b 65 74   .analysis.Market
12780	52 65 67 69 6d 65 20 3d  20 62 65 2e 64 65 74 65   Regime = be.dete
12790	72 6d 69 6e 65 4d 75 6c  74 69 53 79 6d 62 6f 6c   rmineMultiSymbol
127a0	4d 61 72 6b 65 74 52 65  67 69 6d 65 28 73 79 6d   MarketRegime(sym
127b0	62 6f 6c 53 74 61 74 65  73 2c 20 63 75 72 72 65   bolStates, curre
127c0	6e 74 49 6e 64 65 78 29  0a 0a 09 2f 2f 20 32 2e   ntIndex)...// 2.
127d0	20 e8 ae a1 e7 ae 97 e6  b3 a2 e5 8a a8 e7 8e 87    ...............
127e0	e6 8c 87 e6 95 b0 0a 09  61 6e 61 6c 79 73 69 73   ........analysis
127f0	2e 56 6f 6c 61 74 69 6c  69 74 79 49 6e 64 65 78   .VolatilityIndex
12800	20 3d 20 62 65 2e 63 61  6c 63 75 6c 61 74 65 4d    = be.calculateM
12810	75 6c 74 69 53 79 6d 62  6f 6c 56 6f 6c 61 74 69   ultiSymbolVolati
12820	6c 69 74 79 49 6e 64 65  78 28 73 79 6d 62 6f 6c   lityIndex(symbol
12830	53 74 61 74 65 73 2c 20  63 75 72 72 65 6e 74 49   States, currentI
12840	6e 64 65 78 29 0a 0a 09  2f 2f 20 33 2e 20 e8 ae   ndex)...// 3. ..
12850	a1 e7 ae 97 e5 b8 81 e7  a7 8d e9 97 b4 e7 9b b8   ................
12860	e5 85 b3 e6 80 a7 e7 9f  a9 e9 98 b5 0a 09 61 6e   ..............an
12870	61 6c 79 73 69 73 2e 43  6f 72 72 65 6c 61 74 69   alysis.Correlati
12880	6f 6e 4d 61 74 72 69 78  20 3d 20 62 65 2e 63 61   onMatrix = be.ca
12890	6c 63 75 6c 61 74 65 53  79 6d 62 6f 6c 43 6f 72   lculateSymbolCor
128a0	72 65 6c 61 74 69 6f 6e  4d 61 74 72 69 78 28 73   relationMatrix(s
128b0	79 6d 62 6f 6c 53 74 61  74 65 73 2c 20 63 75 72   ymbolStates, cur
128c0	72 65 6e 74 49 6e 64 65  78 29 0a 0a 09 2f 2f 20   rentIndex)...// 
128d0	34 2e 20 e8 ae a1 e7 ae  97 e5 a4 9a e6 a0 b7 e5   4. .............
128e0	8c 96 e8 af 84 e5 88 86  0a 09 61 6e 61 6c 79 73   ..........analys
128f0	69 73 2e 44 69 76 65 72  73 69 66 69 63 61 74 69   is.Diversificati
12900	6f 6e 53 63 6f 72 65 20  3d 20 62 65 2e 63 61 6c   onScore = be.cal
12910	63 75 6c 61 74 65 44 69  76 65 72 73 69 66 69 63   culateDiversific
12920	61 74 69 6f 6e 53 63 6f  72 65 28 61 6e 61 6c 79   ationScore(analy
12930	73 69 73 2e 43 6f 72 72  65 6c 61 74 69 6f 6e 4d   sis.CorrelationM
12940	61 74 72 69 78 29 0a 0a  09 2f 2f 20 35 2e 20 e8   atrix)...// 5. .
12950	ae a1 e7 ae 97 e9 a3 8e  e9 99 a9 e9 9b 86 e4 b8   ................
12960	ad e5 ba a6 0a 09 61 6e  61 6c 79 73 69 73 2e 52   ......analysis.R
12970	69 73 6b 43 6f 6e 63 65  6e 74 72 61 74 69 6f 6e   iskConcentration
12980	20 3d 20 62 65 2e 63 61  6c 63 75 6c 61 74 65 52    = be.calculateR
12990	69 73 6b 43 6f 6e 63 65  6e 74 72 61 74 69 6f 6e   iskConcentration
129a0	28 73 79 6d 62 6f 6c 53  74 61 74 65 73 29 0a 0a   (symbolStates)..
129b0	09 2f 2f 20 36 2e 20 e8  ae a1 e7 ae 97 e6 9c ba   .// 6. .........
129c0	e4 bc 9a e5 af 86 e5 ba  a6 0a 09 61 6e 61 6c 79   ...........analy
129d0	73 69 73 2e 4f 70 70 6f  72 74 75 6e 69 74 79 44   sis.OpportunityD
129e0	65 6e 73 69 74 79 20 3d  20 66 6c 6f 61 74 36 34   ensity = float64
129f0	28 6c 65 6e 28 6f 70 70  6f 72 74 75 6e 69 74 69   (len(opportuniti
12a00	65 73 29 29 20 2f 20 66  6c 6f 61 74 36 34 28 6c   es)) / float64(l
12a10	65 6e 28 73 79 6d 62 6f  6c 53 74 61 74 65 73 29   en(symbolStates)
12a20	29 0a 0a 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   )...log.Printf("
12a30	5b 4d 55 4c 54 49 5f 53  59 4d 42 4f 4c 5f 41 4e   [MULTI_SYMBOL_AN
12a40	41 4c 59 53 49 53 5d 20  e5 b8 82 e5 9c ba e5 88   ALYSIS] ........
12a50	86 e6 9e 90 e5 ae 8c e6  88 90 20 2d 20 e7 8e af   .......... - ...
12a60	e5 a2 83 3a 25 73 2c 20  e6 b3 a2 e5 8a a8 e7 8e   ...:%s, ........
12a70	87 3a 25 2e 33 66 2c 20  e5 a4 9a e6 a0 b7 e5 8c   .:%.3f, ........
12a80	96 3a 25 2e 33 66 2c 20  e6 9c ba e4 bc 9a e5 af   .:%.3f, ........
12a90	86 e5 ba a6 3a 25 2e 33  66 22 2c 0a 09 09 61 6e   ....:%.3f",...an
12aa0	61 6c 79 73 69 73 2e 4d  61 72 6b 65 74 52 65 67   alysis.MarketReg
12ab0	69 6d 65 2c 20 61 6e 61  6c 79 73 69 73 2e 56 6f   ime, analysis.Vo
12ac0	6c 61 74 69 6c 69 74 79  49 6e 64 65 78 2c 20 61   latilityIndex, a
12ad0	6e 61 6c 79 73 69 73 2e  44 69 76 65 72 73 69 66   nalysis.Diversif
12ae0	69 63 61 74 69 6f 6e 53  63 6f 72 65 2c 20 61 6e   icationScore, an
12af0	61 6c 79 73 69 73 2e 4f  70 70 6f 72 74 75 6e 69   alysis.Opportuni
12b00	74 79 44 65 6e 73 69 74  79 29 0a 0a 09 2f 2f 20   tyDensity)...// 
12b10	e6 9b b4 e6 96 b0 e5 bd  93 e5 89 8d e5 b8 82 e5   ................
12b20	9c ba e7 8e af e5 a2 83  e7 bc 93 e5 ad 98 0a 09   ................
12b30	62 65 2e 75 70 64 61 74  65 43 75 72 72 65 6e 74   be.updateCurrent
12b40	4d 61 72 6b 65 74 52 65  67 69 6d 65 28 61 6e 61   MarketRegime(ana
12b50	6c 79 73 69 73 2e 4d 61  72 6b 65 74 52 65 67 69   lysis.MarketRegi
12b60	6d 65 29 0a 0a 09 72 65  74 75 72 6e 20 61 6e 61   me)...return ana
12b70	6c 79 73 69 73 0a 7d 0a  0a 2f 2f 20 64 65 74 65   lysis.}..// dete
12b80	72 6d 69 6e 65 4d 75 6c  74 69 53 79 6d 62 6f 6c   rmineMultiSymbol
12b90	4d 61 72 6b 65 74 52 65  67 69 6d 65 20 e7 a1 ae   MarketRegime ...
12ba0	e5 ae 9a e5 a4 9a e5 b8  81 e7 a7 8d e5 b8 82 e5   ................
12bb0	9c ba e7 8e af e5 a2 83  ef bc 88 e4 bc 98 e5 8c   ................
12bc0	96 e7 89 88 ef bc 89 0a  66 75 6e 63 20 28 62 65   ........func (be
12bd0	20 2a 42 61 63 6b 74 65  73 74 45 6e 67 69 6e 65    *BacktestEngine
12be0	29 20 64 65 74 65 72 6d  69 6e 65 4d 75 6c 74 69   ) determineMulti
12bf0	53 79 6d 62 6f 6c 4d 61  72 6b 65 74 52 65 67 69   SymbolMarketRegi
12c00	6d 65 28 73 79 6d 62 6f  6c 53 74 61 74 65 73 20   me(symbolStates 
12c10	6d 61 70 5b 73 74 72 69  6e 67 5d 2a 53 79 6d 62   map[string]*Symb
12c20	6f 6c 53 74 61 74 65 2c  20 63 75 72 72 65 6e 74   olState, current
12c30	49 6e 64 65 78 20 69 6e  74 29 20 73 74 72 69 6e   Index int) strin
12c40	67 20 7b 0a 09 76 61 72  20 62 75 6c 6c 69 73 68   g {..var bullish
12c50	43 6f 75 6e 74 2c 20 62  65 61 72 69 73 68 43 6f   Count, bearishCo
12c60	75 6e 74 2c 20 73 69 64  65 77 61 79 73 43 6f 75   unt, sidewaysCou
12c70	6e 74 20 69 6e 74 0a 09  76 61 72 20 74 6f 74 61   nt int..var tota
12c80	6c 53 74 72 65 6e 67 74  68 20 66 6c 6f 61 74 36   lStrength float6
12c90	34 0a 0a 09 66 6f 72 20  5f 2c 20 73 74 61 74 65   4...for _, state
12ca0	20 3a 3d 20 72 61 6e 67  65 20 73 79 6d 62 6f 6c    := range symbol
12cb0	53 74 61 74 65 73 20 7b  0a 09 09 69 66 20 63 75   States {...if cu
12cc0	72 72 65 6e 74 49 6e 64  65 78 20 3e 3d 20 6c 65   rrentIndex >= le
12cd0	6e 28 73 74 61 74 65 2e  44 61 74 61 29 20 7b 0a   n(state.Data) {.
12ce0	09 09 09 63 6f 6e 74 69  6e 75 65 0a 09 09 7d 0a   ...continue...}.
12cf0	0a 09 09 2f 2f 20 e5 9f  ba e4 ba 8e e4 bb b7 e6   ...// ..........
12d00	a0 bc e8 b6 8b e5 8a bf  e5 88 a4 e6 96 ad e5 b8   ................
12d10	82 e5 9c ba e7 8e af e5  a2 83 0a 09 09 69 66 20   .............if 
12d20	63 75 72 72 65 6e 74 49  6e 64 65 78 20 3e 3d 20   currentIndex >= 
12d30	32 30 20 7b 0a 09 09 09  72 65 63 65 6e 74 50 72   20 {....recentPr
12d40	69 63 65 73 20 3a 3d 20  73 74 61 74 65 2e 44 61   ices := state.Da
12d50	74 61 5b 63 75 72 72 65  6e 74 49 6e 64 65 78 2d   ta[currentIndex-
12d60	32 30 20 3a 20 63 75 72  72 65 6e 74 49 6e 64 65   20 : currentInde
12d70	78 2b 31 5d 0a 09 09 09  69 66 20 6c 65 6e 28 72   x+1]....if len(r
12d80	65 63 65 6e 74 50 72 69  63 65 73 29 20 3e 3d 20   ecentPrices) >= 
12d90	31 30 20 7b 0a 09 09 09  09 74 72 65 6e 64 20 3a   10 {.....trend :
12da0	3d 20 62 65 2e 63 61 6c  63 75 6c 61 74 65 50 72   = be.calculatePr
12db0	69 63 65 54 72 65 6e 64  28 72 65 63 65 6e 74 50   iceTrend(recentP
12dc0	72 69 63 65 73 29 0a 09  09 09 09 74 72 65 6e 64   rices).....trend
12dd0	53 74 72 65 6e 67 74 68  20 3a 3d 20 6d 61 74 68   Strength := math
12de0	2e 41 62 73 28 74 72 65  6e 64 29 0a 09 09 09 09   .Abs(trend).....
12df0	74 6f 74 61 6c 53 74 72  65 6e 67 74 68 20 2b 3d   totalStrength +=
12e00	20 74 72 65 6e 64 53 74  72 65 6e 67 74 68 0a 0a    trendStrength..
12e10	09 09 09 09 2f 2f 20 e4  bd bf e7 94 a8 e6 9b b4   ....// .........
12e20	e5 90 88 e7 90 86 e7 9a  84 e8 b6 8b e5 8a bf e9   ................
12e30	98 88 e5 80 bc ef bc 8c  e8 80 83 e8 99 91 e6 b3   ................
12e40	a2 e5 8a a8 e7 8e 87 20  2d 20 e8 bf 9b e4 b8 80   ....... - ......
12e50	e6 ad a5 e6 94 be e5 ae  bd e4 bb a5 e9 81 bf e5   ................
12e60	85 8d e8 bf 87 e5 ba a6  e7 86 8a e5 b8 82 e5 88   ................
12e70	a4 e6 96 ad 0a 09 09 09  09 69 66 20 74 72 65 6e   .........if tren
12e80	64 20 3e 20 30 2e 30 30  31 35 20 7b 20 2f 2f 20   d > 0.0015 { // 
12e90	e7 89 9b e5 b8 82 ef bc  9a e8 bf 9b e4 b8 80 e6   ................
12ea0	ad a5 e6 94 be e5 ae bd  e9 98 88 e5 80 bc 0a 09   ................
12eb0	09 09 09 09 62 75 6c 6c  69 73 68 43 6f 75 6e 74   ....bullishCount
12ec0	2b 2b 0a 09 09 09 09 7d  20 65 6c 73 65 20 69 66   ++.....} else if
12ed0	20 74 72 65 6e 64 20 3c  20 2d 30 2e 30 30 31 35    trend < -0.0015
12ee0	20 7b 20 2f 2f 20 e7 86  8a e5 b8 82 ef bc 9a e8    { // ..........
12ef0	bf 9b e4 b8 80 e6 ad a5  e6 94 be e5 ae bd e9 98   ................
12f00	88 e5 80 bc ef bc 8c e9  81 bf e5 85 8d e8 bf 87   ................
12f10	e5 ba a6 e6 95 8f e6 84  9f 0a 09 09 09 09 09 62   ...............b
12f20	65 61 72 69 73 68 43 6f  75 6e 74 2b 2b 0a 09 09   earishCount++...
12f30	09 09 7d 20 65 6c 73 65  20 7b 0a 09 09 09 09 09   ..} else {......
12f40	73 69 64 65 77 61 79 73  43 6f 75 6e 74 2b 2b 0a   sidewaysCount++.
12f50	09 09 09 09 7d 0a 09 09  09 7d 0a 09 09 7d 0a 09   ....}....}...}..
12f60	7d 0a 0a 09 74 6f 74 61  6c 20 3a 3d 20 62 75 6c   }...total := bul
12f70	6c 69 73 68 43 6f 75 6e  74 20 2b 20 62 65 61 72   lishCount + bear
12f80	69 73 68 43 6f 75 6e 74  20 2b 20 73 69 64 65 77   ishCount + sidew
12f90	61 79 73 43 6f 75 6e 74  0a 09 69 66 20 74 6f 74   aysCount..if tot
12fa0	61 6c 20 3d 3d 20 30 20  7b 0a 09 09 72 65 74 75   al == 0 {...retu
12fb0	72 6e 20 22 75 6e 6b 6e  6f 77 6e 22 0a 09 7d 0a   rn "unknown"..}.
12fc0	0a 09 62 75 6c 6c 52 61  74 69 6f 20 3a 3d 20 66   ..bullRatio := f
12fd0	6c 6f 61 74 36 34 28 62  75 6c 6c 69 73 68 43 6f   loat64(bullishCo
12fe0	75 6e 74 29 20 2f 20 66  6c 6f 61 74 36 34 28 74   unt) / float64(t
12ff0	6f 74 61 6c 29 0a 09 62  65 61 72 52 61 74 69 6f   otal)..bearRatio
13000	20 3a 3d 20 66 6c 6f 61  74 36 34 28 62 65 61 72    := float64(bear
13010	69 73 68 43 6f 75 6e 74  29 20 2f 20 66 6c 6f 61   ishCount) / floa
13020	74 36 34 28 74 6f 74 61  6c 29 0a 09 73 69 64 65   t64(total)..side
13030	77 61 79 73 52 61 74 69  6f 20 3a 3d 20 66 6c 6f   waysRatio := flo
13040	61 74 36 34 28 73 69 64  65 77 61 79 73 43 6f 75   at64(sidewaysCou
13050	6e 74 29 20 2f 20 66 6c  6f 61 74 36 34 28 74 6f   nt) / float64(to
13060	74 61 6c 29 0a 09 61 76  67 53 74 72 65 6e 67 74   tal)..avgStrengt
13070	68 20 3a 3d 20 74 6f 74  61 6c 53 74 72 65 6e 67   h := totalStreng
13080	74 68 20 2f 20 66 6c 6f  61 74 36 34 28 74 6f 74   th / float64(tot
13090	61 6c 29 0a 0a 09 6c 6f  67 2e 50 72 69 6e 74 66   al)...log.Printf
130a0	28 22 5b 4d 41 52 4b 45  54 5f 52 45 47 49 4d 45   ("[MARKET_REGIME
130b0	5f 44 45 54 41 49 4c 5d  20 e5 b8 82 e5 9c ba e7   _DETAIL] .......
130c0	8e af e5 a2 83 e5 88 86  e6 9e 90 3a 20 e7 89 9b   ...........: ...
130d0	e5 b8 82 e5 b8 81 e7 a7  8d 3d 25 64 2c 20 e7 86   .........=%d, ..
130e0	8a e5 b8 82 e5 b8 81 e7  a7 8d 3d 25 64 2c 20 e6   ..........=%d, .
130f0	a8 aa e7 9b 98 e5 b8 81  e7 a7 8d 3d 25 64 2c 20   ...........=%d, 
13100	e5 b9 b3 e5 9d 87 e8 b6  8b e5 8a bf e5 bc ba e5   ................
13110	ba a6 3d 25 2e 34 66 22  2c 0a 09 09 62 75 6c 6c   ..=%.4f",...bull
13120	69 73 68 43 6f 75 6e 74  2c 20 62 65 61 72 69 73   ishCount, bearis
13130	68 43 6f 75 6e 74 2c 20  73 69 64 65 77 61 79 73   hCount, sideways
13140	43 6f 75 6e 74 2c 20 61  76 67 53 74 72 65 6e 67   Count, avgStreng
13150	74 68 29 0a 0a 09 2f 2f  20 e4 bc 98 e5 8c 96 e5   th)...// .......
13160	b8 82 e5 9c ba e7 8e af  e5 a2 83 e5 88 a4 e6 96   ................
13170	ad e9 80 bb e8 be 91 20  2d 20 e8 80 83 e8 99 91   ....... - ......
13180	e5 b8 81 e7 a7 8d e6 95  b0 e9 87 8f e7 9a 84 e5   ................
13190	8a a8 e6 80 81 e9 98 88  e5 80 bc 0a 09 74 6f 74   .............tot
131a0	61 6c 53 79 6d 62 6f 6c  73 20 3a 3d 20 66 6c 6f   alSymbols := flo
131b0	61 74 36 34 28 74 6f 74  61 6c 29 0a 0a 09 2f 2f   at64(total)...//
131c0	20 e6 a0 b9 e6 8d ae e5  b8 81 e7 a7 8d e6 95 b0    ...............
131d0	e9 87 8f e5 8a a8 e6 80  81 e8 b0 83 e6 95 b4 e9   ................
131e0	98 88 e5 80 bc 0a 09 76  61 72 20 73 74 72 6f 6e   .......var stron
131f0	67 42 75 6c 6c 54 68 72  65 73 68 6f 6c 64 2c 20   gBullThreshold, 
13200	77 65 61 6b 42 75 6c 6c  54 68 72 65 73 68 6f 6c   weakBullThreshol
13210	64 2c 20 73 74 72 6f 6e  67 42 65 61 72 54 68 72   d, strongBearThr
13220	65 73 68 6f 6c 64 2c 20  77 65 61 6b 42 65 61 72   eshold, weakBear
13230	54 68 72 65 73 68 6f 6c  64 20 66 6c 6f 61 74 36   Threshold float6
13240	34 0a 0a 09 69 66 20 74  6f 74 61 6c 53 79 6d 62   4...if totalSymb
13250	6f 6c 73 20 3c 3d 20 33  20 7b 0a 09 09 2f 2f 20   ols <= 3 {...// 
13260	e5 b0 91 e9 87 8f e5 b8  81 e7 a7 8d e6 83 85 e5   ................
13270	86 b5 ef bc 9a e9 99 8d  e4 bd 8e e9 98 88 e5 80   ................
13280	bc ef bc 8c e9 81 bf e5  85 8d e8 bf 87 e5 ba a6   ................
13290	e7 86 8a e5 b8 82 e5 88  a4 e6 96 ad 0a 09 09 73   ...............s
132a0	74 72 6f 6e 67 42 75 6c  6c 54 68 72 65 73 68 6f   trongBullThresho
132b0	6c 64 20 3d 20 30 2e 35  20 2f 2f 20 35 30 25 20   ld = 0.5 // 50% 
132c0	76 73 20 36 30 25 0a 09  09 77 65 61 6b 42 75 6c   vs 60%...weakBul
132d0	6c 54 68 72 65 73 68 6f  6c 64 20 3d 20 30 2e 32   lThreshold = 0.2
132e0	35 20 20 2f 2f 20 32 35  25 20 76 73 20 33 30 25   5  // 25% vs 30%
132f0	0a 09 09 73 74 72 6f 6e  67 42 65 61 72 54 68 72   ...strongBearThr
13300	65 73 68 6f 6c 64 20 3d  20 30 2e 36 20 2f 2f 20   eshold = 0.6 // 
13310	36 30 25 20 76 73 20 37  30 25 0a 09 09 77 65 61   60% vs 70%...wea
13320	6b 42 65 61 72 54 68 72  65 73 68 6f 6c 64 20 3d   kBearThreshold =
13330	20 30 2e 33 35 20 20 2f  2f 20 33 35 25 20 76 73    0.35  // 35% vs
13340	20 34 30 25 0a 09 7d 20  65 6c 73 65 20 69 66 20    40%..} else if 
13350	74 6f 74 61 6c 53 79 6d  62 6f 6c 73 20 3c 3d 20   totalSymbols <= 
13360	35 20 7b 0a 09 09 2f 2f  20 e4 b8 ad e7 ad 89 e6   5 {...// .......
13370	95 b0 e9 87 8f e5 b8 81  e7 a7 8d 0a 09 09 73 74   ..............st
13380	72 6f 6e 67 42 75 6c 6c  54 68 72 65 73 68 6f 6c   rongBullThreshol
13390	64 20 3d 20 30 2e 35 35  0a 09 09 77 65 61 6b 42   d = 0.55...weakB
133a0	75 6c 6c 54 68 72 65 73  68 6f 6c 64 20 3d 20 30   ullThreshold = 0
133b0	2e 32 37 0a 09 09 73 74  72 6f 6e 67 42 65 61 72   .27...strongBear
133c0	54 68 72 65 73 68 6f 6c  64 20 3d 20 30 2e 36 35   Threshold = 0.65
133d0	0a 09 09 77 65 61 6b 42  65 61 72 54 68 72 65 73   ...weakBearThres
133e0	68 6f 6c 64 20 3d 20 30  2e 33 37 0a 09 7d 20 65   hold = 0.37..} e
133f0	6c 73 65 20 7b 0a 09 09  2f 2f 20 e5 a4 a7 e9 87   lse {...// .....
13400	8f e5 b8 81 e7 a7 8d e6  83 85 e5 86 b5 ef bc 9a   ................
13410	e4 bd bf e7 94 a8 e5 8e  9f e6 9c 89 e9 98 88 e5   ................
13420	80 bc 0a 09 09 73 74 72  6f 6e 67 42 75 6c 6c 54   .....strongBullT
13430	68 72 65 73 68 6f 6c 64  20 3d 20 30 2e 36 0a 09   hreshold = 0.6..
13440	09 77 65 61 6b 42 75 6c  6c 54 68 72 65 73 68 6f   .weakBullThresho
13450	6c 64 20 3d 20 30 2e 33  0a 09 09 73 74 72 6f 6e   ld = 0.3...stron
13460	67 42 65 61 72 54 68 72  65 73 68 6f 6c 64 20 3d   gBearThreshold =
13470	20 30 2e 37 0a 09 09 77  65 61 6b 42 65 61 72 54    0.7...weakBearT
13480	68 72 65 73 68 6f 6c 64  20 3d 20 30 2e 34 0a 09   hreshold = 0.4..
13490	7d 0a 0a 09 2f 2f 20 e5  9f ba e4 ba 8e e5 8a a8   }...// .........
134a0	e6 80 81 e9 98 88 e5 80  bc e5 88 a4 e6 96 ad e5   ................
134b0	b8 82 e5 9c ba e7 8e af  e5 a2 83 0a 09 69 66 20   .............if 
134c0	62 75 6c 6c 52 61 74 69  6f 20 3e 20 73 74 72 6f   bullRatio > stro
134d0	6e 67 42 75 6c 6c 54 68  72 65 73 68 6f 6c 64 20   ngBullThreshold 
134e0	7b 0a 09 09 72 65 74 75  72 6e 20 22 73 74 72 6f   {...return "stro
134f0	6e 67 5f 62 75 6c 6c 22  0a 09 7d 20 65 6c 73 65   ng_bull"..} else
13500	20 69 66 20 62 75 6c 6c  52 61 74 69 6f 20 3e 20    if bullRatio > 
13510	77 65 61 6b 42 75 6c 6c  54 68 72 65 73 68 6f 6c   weakBullThreshol
13520	64 20 7b 0a 09 09 72 65  74 75 72 6e 20 22 77 65   d {...return "we
13530	61 6b 5f 62 75 6c 6c 22  0a 09 7d 20 65 6c 73 65   ak_bull"..} else
13540	20 69 66 20 62 65 61 72  52 61 74 69 6f 20 3e 20    if bearRatio > 
13550	73 74 72 6f 6e 67 42 65  61 72 54 68 72 65 73 68   strongBearThresh
13560	6f 6c 64 20 7b 0a 09 09  72 65 74 75 72 6e 20 22   old {...return "
13570	73 74 72 6f 6e 67 5f 62  65 61 72 22 0a 09 7d 20   strong_bear"..} 
13580	65 6c 73 65 20 69 66 20  62 65 61 72 52 61 74 69   else if bearRati
13590	6f 20 3e 20 77 65 61 6b  42 65 61 72 54 68 72 65   o > weakBearThre
135a0	73 68 6f 6c 64 20 7b 0a  09 09 72 65 74 75 72 6e   shold {...return
135b0	20 22 77 65 61 6b 5f 62  65 61 72 22 0a 09 7d 20    "weak_bear"..} 
135c0	65 6c 73 65 20 69 66 20  73 69 64 65 77 61 79 73   else if sideways
135d0	52 61 74 69 6f 20 3e 20  30 2e 35 20 7b 0a 09 09   Ratio > 0.5 {...
135e0	72 65 74 75 72 6e 20 22  73 69 64 65 77 61 79 73   return "sideways
135f0	22 0a 09 7d 20 65 6c 73  65 20 69 66 20 61 76 67   "..} else if avg
13600	53 74 72 65 6e 67 74 68  20 3c 20 30 2e 30 30 33   Strength < 0.003
13610	20 7b 0a 09 09 72 65 74  75 72 6e 20 22 6c 6f 77    {...return "low
13620	5f 76 6f 6c 61 74 69 6c  69 74 79 22 0a 09 7d 20   _volatility"..} 
13630	65 6c 73 65 20 7b 0a 09  09 72 65 74 75 72 6e 20   else {...return 
13640	22 6d 69 78 65 64 22 0a  09 7d 0a 7d 0a 0a 2f 2f   "mixed"..}.}..//
13650	20 63 61 6c 63 75 6c 61  74 65 50 72 69 63 65 54    calculatePriceT
13660	72 65 6e 64 20 e8 ae a1  e7 ae 97 e4 bb b7 e6 a0   rend ...........
13670	bc e8 b6 8b e5 8a bf ef  bc 88 e4 bc 98 e5 8c 96   ................
13680	e7 89 88 ef bc 89 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
13690	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
136a0	20 63 61 6c 63 75 6c 61  74 65 50 72 69 63 65 54    calculatePriceT
136b0	72 65 6e 64 28 70 72 69  63 65 73 20 5b 5d 4d 61   rend(prices []Ma
136c0	72 6b 65 74 44 61 74 61  29 20 66 6c 6f 61 74 36   rketData) float6
136d0	34 20 7b 0a 09 69 66 20  6c 65 6e 28 70 72 69 63   4 {..if len(pric
136e0	65 73 29 20 3c 20 32 20  7b 0a 09 09 72 65 74 75   es) < 2 {...retu
136f0	72 6e 20 30 2e 30 0a 09  7d 0a 0a 09 2f 2f 20 e6   rn 0.0..}...// .
13700	96 b9 e6 b3 95 31 ef bc  9a e7 ba bf e6 80 a7 e5   .....1..........
13710	9b 9e e5 bd 92 e8 b6 8b  e5 8a bf 0a 09 69 66 20   .............if 
13720	6c 65 6e 28 70 72 69 63  65 73 29 20 3e 3d 20 35   len(prices) >= 5
13730	20 7b 0a 09 09 72 65 74  75 72 6e 20 62 65 2e 63    {...return be.c
13740	61 6c 63 75 6c 61 74 65  4c 69 6e 65 61 72 54 72   alculateLinearTr
13750	65 6e 64 28 70 72 69 63  65 73 29 0a 09 7d 0a 0a   end(prices)..}..
13760	09 2f 2f 20 e6 96 b9 e6  b3 95 32 ef bc 9a e5 8a   .// ......2.....
13770	a0 e6 9d 83 e5 b9 b3 e5  9d 87 e8 b6 8b e5 8a bf   ................
13780	ef bc 88 e5 af b9 e8 bf  91 e6 9c 9f e4 bb b7 e6   ................
13790	a0 bc e8 b5 8b e4 ba 88  e6 9b b4 e9 ab 98 e6 9d   ................
137a0	83 e9 87 8d ef bc 89 0a  09 72 65 74 75 72 6e 20   .........return 
137b0	62 65 2e 63 61 6c 63 75  6c 61 74 65 57 65 69 67   be.calculateWeig
137c0	68 74 65 64 54 72 65 6e  64 28 70 72 69 63 65 73   htedTrend(prices
137d0	29 0a 7d 0a 0a 2f 2f 20  63 61 6c 63 75 6c 61 74   ).}..// calculat
137e0	65 4c 69 6e 65 61 72 54  72 65 6e 64 20 e4 bd bf   eLinearTrend ...
137f0	e7 94 a8 e7 ba bf e6 80  a7 e5 9b 9e e5 bd 92 e8   ................
13800	ae a1 e7 ae 97 e8 b6 8b  e5 8a bf 0a 66 75 6e 63   ............func
13810	20 28 62 65 20 2a 42 61  63 6b 74 65 73 74 45 6e    (be *BacktestEn
13820	67 69 6e 65 29 20 63 61  6c 63 75 6c 61 74 65 4c   gine) calculateL
13830	69 6e 65 61 72 54 72 65  6e 64 28 70 72 69 63 65   inearTrend(price
13840	73 20 5b 5d 4d 61 72 6b  65 74 44 61 74 61 29 20   s []MarketData) 
13850	66 6c 6f 61 74 36 34 20  7b 0a 09 6e 20 3a 3d 20   float64 {..n := 
13860	6c 65 6e 28 70 72 69 63  65 73 29 0a 09 69 66 20   len(prices)..if 
13870	6e 20 3c 20 32 20 7b 0a  09 09 72 65 74 75 72 6e   n < 2 {...return
13880	20 30 2e 30 0a 09 7d 0a  0a 09 2f 2f 20 e8 ae a1    0.0..}...// ...
13890	e7 ae 97 e7 ba bf e6 80  a7 e5 9b 9e e5 bd 92 e6   ................
138a0	96 9c e7 8e 87 0a 09 73  75 6d 58 20 3a 3d 20 30   .......sumX := 0
138b0	2e 30 0a 09 73 75 6d 59  20 3a 3d 20 30 2e 30 0a   .0..sumY := 0.0.
138c0	09 73 75 6d 58 59 20 3a  3d 20 30 2e 30 0a 09 73   .sumXY := 0.0..s
138d0	75 6d 58 58 20 3a 3d 20  30 2e 30 0a 0a 09 66 6f   umXX := 0.0...fo
138e0	72 20 69 2c 20 70 72 69  63 65 20 3a 3d 20 72 61   r i, price := ra
138f0	6e 67 65 20 70 72 69 63  65 73 20 7b 0a 09 09 78   nge prices {...x
13900	20 3a 3d 20 66 6c 6f 61  74 36 34 28 69 29 0a 09    := float64(i)..
13910	09 79 20 3a 3d 20 70 72  69 63 65 2e 50 72 69 63   .y := price.Pric
13920	65 0a 09 09 73 75 6d 58  20 2b 3d 20 78 0a 09 09   e...sumX += x...
13930	73 75 6d 59 20 2b 3d 20  79 0a 09 09 73 75 6d 58   sumY += y...sumX
13940	59 20 2b 3d 20 78 20 2a  20 79 0a 09 09 73 75 6d   Y += x * y...sum
13950	58 58 20 2b 3d 20 78 20  2a 20 78 0a 09 7d 0a 0a   XX += x * x..}..
13960	09 6e 75 6d 65 72 61 74  6f 72 20 3a 3d 20 66 6c   .numerator := fl
13970	6f 61 74 36 34 28 6e 29  2a 73 75 6d 58 59 20 2d   oat64(n)*sumXY -
13980	20 73 75 6d 58 2a 73 75  6d 59 0a 09 64 65 6e 6f    sumX*sumY..deno
13990	6d 69 6e 61 74 6f 72 20  3a 3d 20 66 6c 6f 61 74   minator := float
139a0	36 34 28 6e 29 2a 73 75  6d 58 58 20 2d 20 73 75   64(n)*sumXX - su
139b0	6d 58 2a 73 75 6d 58 0a  0a 09 69 66 20 64 65 6e   mX*sumX...if den
139c0	6f 6d 69 6e 61 74 6f 72  20 3d 3d 20 30 20 7b 0a   ominator == 0 {.
139d0	09 09 72 65 74 75 72 6e  20 30 2e 30 0a 09 7d 0a   ..return 0.0..}.
139e0	0a 09 73 6c 6f 70 65 20  3a 3d 20 6e 75 6d 65 72   ..slope := numer
139f0	61 74 6f 72 20 2f 20 64  65 6e 6f 6d 69 6e 61 74   ator / denominat
13a00	6f 72 0a 0a 09 2f 2f 20  e5 b0 86 e6 96 9c e7 8e   or...// ........
13a10	87 e6 a0 87 e5 87 86 e5  8c 96 e4 b8 ba e7 99 be   ................
13a20	e5 88 86 e6 af 94 e5 8f  98 e5 8c 96 0a 09 61 76   ..............av
13a30	67 50 72 69 63 65 20 3a  3d 20 73 75 6d 59 20 2f   gPrice := sumY /
13a40	20 66 6c 6f 61 74 36 34  28 6e 29 0a 09 69 66 20    float64(n)..if 
13a50	61 76 67 50 72 69 63 65  20 3d 3d 20 30 20 7b 0a   avgPrice == 0 {.
13a60	09 09 72 65 74 75 72 6e  20 30 2e 30 0a 09 7d 0a   ..return 0.0..}.
13a70	0a 09 2f 2f 20 e6 96 9c  e7 8e 87 e7 9b b8 e5 af   ..// ...........
13a80	b9 e4 ba 8e e5 b9 b3 e5  9d 87 e4 bb b7 e6 a0 bc   ................
13a90	e7 9a 84 e6 a0 87 e5 87  86 e5 8c 96 0a 09 6e 6f   ..............no
13aa0	72 6d 61 6c 69 7a 65 64  53 6c 6f 70 65 20 3a 3d   rmalizedSlope :=
13ab0	20 73 6c 6f 70 65 20 2f  20 61 76 67 50 72 69 63    slope / avgPric
13ac0	65 0a 0a 09 2f 2f 20 e9  99 90 e5 88 b6 e5 9c a8   e...// .........
13ad0	e5 90 88 e7 90 86 e8 8c  83 e5 9b b4 e5 86 85 0a   ................
13ae0	09 72 65 74 75 72 6e 20  6d 61 74 68 2e 4d 61 78   .return math.Max
13af0	28 2d 30 2e 31 2c 20 6d  61 74 68 2e 4d 69 6e 28   (-0.1, math.Min(
13b00	30 2e 31 2c 20 6e 6f 72  6d 61 6c 69 7a 65 64 53   0.1, normalizedS
13b10	6c 6f 70 65 29 29 0a 7d  0a 0a 2f 2f 20 63 61 6c   lope)).}..// cal
13b20	63 75 6c 61 74 65 57 65  69 67 68 74 65 64 54 72   culateWeightedTr
13b30	65 6e 64 20 e8 ae a1 e7  ae 97 e5 8a a0 e6 9d 83   end ............
13b40	e8 b6 8b e5 8a bf ef bc  88 e8 bf 91 e6 9c 9f e6   ................
13b50	9d 83 e9 87 8d e6 9b b4  e9 ab 98 ef bc 89 0a 66   ...............f
13b60	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
13b70	74 45 6e 67 69 6e 65 29  20 63 61 6c 63 75 6c 61   tEngine) calcula
13b80	74 65 57 65 69 67 68 74  65 64 54 72 65 6e 64 28   teWeightedTrend(
13b90	70 72 69 63 65 73 20 5b  5d 4d 61 72 6b 65 74 44   prices []MarketD
13ba0	61 74 61 29 20 66 6c 6f  61 74 36 34 20 7b 0a 09   ata) float64 {..
13bb0	69 66 20 6c 65 6e 28 70  72 69 63 65 73 29 20 3c   if len(prices) <
13bc0	20 32 20 7b 0a 09 09 72  65 74 75 72 6e 20 30 2e    2 {...return 0.
13bd0	30 0a 09 7d 0a 0a 09 6e  20 3a 3d 20 6c 65 6e 28   0..}...n := len(
13be0	70 72 69 63 65 73 29 0a  09 74 6f 74 61 6c 57 65   prices)..totalWe
13bf0	69 67 68 74 20 3a 3d 20  30 2e 30 0a 09 77 65 69   ight := 0.0..wei
13c00	67 68 74 65 64 43 68 61  6e 67 65 20 3a 3d 20 30   ghtedChange := 0
13c10	2e 30 0a 0a 09 2f 2f 20  e5 af b9 e6 af 8f e4 b8   .0...// ........
13c20	aa e4 bb b7 e6 a0 bc e7  82 b9 e8 ae a1 e7 ae 97   ................
13c30	e6 9d 83 e9 87 8d ef bc  88 e6 8c 87 e6 95 b0 e8   ................
13c40	a1 b0 e5 87 8f ef bc 89  0a 09 66 6f 72 20 69 20   ..........for i 
13c50	3a 3d 20 31 3b 20 69 20  3c 20 6e 3b 20 69 2b 2b   := 1; i < n; i++
13c60	20 7b 0a 09 09 77 65 69  67 68 74 20 3a 3d 20 6d    {...weight := m
13c70	61 74 68 2e 50 6f 77 28  30 2e 39 2c 20 66 6c 6f   ath.Pow(0.9, flo
13c80	61 74 36 34 28 6e 2d 69  29 29 20 2f 2f 20 e6 8c   at64(n-i)) // ..
13c90	87 e6 95 b0 e8 a1 b0 e5  87 8f e6 9d 83 e9 87 8d   ................
13ca0	0a 09 09 63 68 61 6e 67  65 20 3a 3d 20 28 70 72   ...change := (pr
13cb0	69 63 65 73 5b 69 5d 2e  50 72 69 63 65 20 2d 20   ices[i].Price - 
13cc0	70 72 69 63 65 73 5b 69  2d 31 5d 2e 50 72 69 63   prices[i-1].Pric
13cd0	65 29 20 2f 20 70 72 69  63 65 73 5b 69 2d 31 5d   e) / prices[i-1]
13ce0	2e 50 72 69 63 65 0a 0a  09 09 77 65 69 67 68 74   .Price....weight
13cf0	65 64 43 68 61 6e 67 65  20 2b 3d 20 63 68 61 6e   edChange += chan
13d00	67 65 20 2a 20 77 65 69  67 68 74 0a 09 09 74 6f   ge * weight...to
13d10	74 61 6c 57 65 69 67 68  74 20 2b 3d 20 77 65 69   talWeight += wei
13d20	67 68 74 0a 09 7d 0a 0a  09 69 66 20 74 6f 74 61   ght..}...if tota
13d30	6c 57 65 69 67 68 74 20  3d 3d 20 30 20 7b 0a 09   lWeight == 0 {..
13d40	09 72 65 74 75 72 6e 20  30 2e 30 0a 09 7d 0a 0a   .return 0.0..}..
13d50	09 61 76 67 43 68 61 6e  67 65 20 3a 3d 20 77 65   .avgChange := we
13d60	69 67 68 74 65 64 43 68  61 6e 67 65 20 2f 20 74   ightedChange / t
13d70	6f 74 61 6c 57 65 69 67  68 74 0a 0a 09 2f 2f 20   otalWeight...// 
13d80	e5 b0 86 e6 97 a5 e5 8f  98 e5 8c 96 e7 8e 87 e8   ................
13d90	bd ac e6 8d a2 e4 b8 ba  e6 80 bb e8 b6 8b e5 8a   ................
13da0	bf 0a 09 74 72 65 6e 64  20 3a 3d 20 61 76 67 43   ...trend := avgC
13db0	68 61 6e 67 65 20 2a 20  66 6c 6f 61 74 36 34 28   hange * float64(
13dc0	6e 29 0a 0a 09 2f 2f 20  e9 99 90 e5 88 b6 e5 9c   n)...// ........
13dd0	a8 e5 90 88 e7 90 86 e8  8c 83 e5 9b b4 e5 86 85   ................
13de0	0a 09 72 65 74 75 72 6e  20 6d 61 74 68 2e 4d 61   ..return math.Ma
13df0	78 28 2d 30 2e 30 35 2c  20 6d 61 74 68 2e 4d 69   x(-0.05, math.Mi
13e00	6e 28 30 2e 30 35 2c 20  74 72 65 6e 64 29 29 0a   n(0.05, trend)).
13e10	7d 0a 0a 2f 2f 20 63 61  6c 63 75 6c 61 74 65 4d   }..// calculateM
13e20	75 6c 74 69 53 79 6d 62  6f 6c 56 6f 6c 61 74 69   ultiSymbolVolati
13e30	6c 69 74 79 49 6e 64 65  78 20 e8 ae a1 e7 ae 97   lityIndex ......
13e40	e5 a4 9a e5 b8 81 e7 a7  8d e6 b3 a2 e5 8a a8 e7   ................
13e50	8e 87 e6 8c 87 e6 95 b0  0a 66 75 6e 63 20 28 62   .........func (b
13e60	65 20 2a 42 61 63 6b 74  65 73 74 45 6e 67 69 6e   e *BacktestEngin
13e70	65 29 20 63 61 6c 63 75  6c 61 74 65 4d 75 6c 74   e) calculateMult
13e80	69 53 79 6d 62 6f 6c 56  6f 6c 61 74 69 6c 69 74   iSymbolVolatilit
13e90	79 49 6e 64 65 78 28 73  79 6d 62 6f 6c 53 74 61   yIndex(symbolSta
13ea0	74 65 73 20 6d 61 70 5b  73 74 72 69 6e 67 5d 2a   tes map[string]*
13eb0	53 79 6d 62 6f 6c 53 74  61 74 65 2c 20 63 75 72   SymbolState, cur
13ec0	72 65 6e 74 49 6e 64 65  78 20 69 6e 74 29 20 66   rentIndex int) f
13ed0	6c 6f 61 74 36 34 20 7b  0a 09 76 61 72 20 76 6f   loat64 {..var vo
13ee0	6c 61 74 69 6c 69 74 69  65 73 20 5b 5d 66 6c 6f   latilities []flo
13ef0	61 74 36 34 0a 0a 09 66  6f 72 20 5f 2c 20 73 74   at64...for _, st
13f00	61 74 65 20 3a 3d 20 72  61 6e 67 65 20 73 79 6d   ate := range sym
13f10	62 6f 6c 53 74 61 74 65  73 20 7b 0a 09 09 69 66   bolStates {...if
13f20	20 63 75 72 72 65 6e 74  49 6e 64 65 78 20 3e 3d    currentIndex >=
13f30	20 6c 65 6e 28 73 74 61  74 65 2e 44 61 74 61 29    len(state.Data)
13f40	20 7c 7c 20 63 75 72 72  65 6e 74 49 6e 64 65 78    || currentIndex
13f50	20 3c 20 32 30 20 7b 0a  09 09 09 63 6f 6e 74 69    < 20 {....conti
13f60	6e 75 65 0a 09 09 7d 0a  0a 09 09 2f 2f 20 e8 ae   nue...}....// ..
13f70	a1 e7 ae 97 e6 9c 80 e8  bf 91 32 30 e5 a4 a9 e7   ..........20....
13f80	9a 84 e6 b3 a2 e5 8a a8  e7 8e 87 0a 09 09 72 65   ..............re
13f90	63 65 6e 74 50 72 69 63  65 73 20 3a 3d 20 73 74   centPrices := st
13fa0	61 74 65 2e 44 61 74 61  5b 63 75 72 72 65 6e 74   ate.Data[current
13fb0	49 6e 64 65 78 2d 32 30  20 3a 20 63 75 72 72 65   Index-20 : curre
13fc0	6e 74 49 6e 64 65 78 2b  31 5d 0a 09 09 76 6f 6c   ntIndex+1]...vol
13fd0	61 74 69 6c 69 74 79 20  3a 3d 20 62 65 2e 63 61   atility := be.ca
13fe0	6c 63 75 6c 61 74 65 50  72 69 63 65 56 6f 6c 61   lculatePriceVola
13ff0	74 69 6c 69 74 79 28 72  65 63 65 6e 74 50 72 69   tility(recentPri
14000	63 65 73 29 0a 09 09 76  6f 6c 61 74 69 6c 69 74   ces)...volatilit
14010	69 65 73 20 3d 20 61 70  70 65 6e 64 28 76 6f 6c   ies = append(vol
14020	61 74 69 6c 69 74 69 65  73 2c 20 76 6f 6c 61 74   atilities, volat
14030	69 6c 69 74 79 29 0a 09  7d 0a 0a 09 69 66 20 6c   ility)..}...if l
14040	65 6e 28 76 6f 6c 61 74  69 6c 69 74 69 65 73 29   en(volatilities)
14050	20 3d 3d 20 30 20 7b 0a  09 09 72 65 74 75 72 6e    == 0 {...return
14060	20 30 2e 30 32 20 2f 2f  20 e9 bb 98 e8 ae a4 e4    0.02 // .......
14070	b8 ad e7 ad 89 e6 b3 a2  e5 8a a8 0a 09 7d 0a 0a   .............}..
14080	09 2f 2f 20 e8 ae a1 e7  ae 97 e5 b9 b3 e5 9d 87   .// ............
14090	e6 b3 a2 e5 8a a8 e7 8e  87 0a 09 73 75 6d 20 3a   ...........sum :
140a0	3d 20 30 2e 30 0a 09 66  6f 72 20 5f 2c 20 76 20   = 0.0..for _, v 
140b0	3a 3d 20 72 61 6e 67 65  20 76 6f 6c 61 74 69 6c   := range volatil
140c0	69 74 69 65 73 20 7b 0a  09 09 73 75 6d 20 2b 3d   ities {...sum +=
140d0	20 76 0a 09 7d 0a 0a 09  72 65 74 75 72 6e 20 73    v..}...return s
140e0	75 6d 20 2f 20 66 6c 6f  61 74 36 34 28 6c 65 6e   um / float64(len
140f0	28 76 6f 6c 61 74 69 6c  69 74 69 65 73 29 29 0a   (volatilities)).
14100	7d 0a 0a 2f 2f 20 63 61  6c 63 75 6c 61 74 65 50   }..// calculateP
14110	72 69 63 65 56 6f 6c 61  74 69 6c 69 74 79 20 e8   riceVolatility .
14120	ae a1 e7 ae 97 e4 bb b7  e6 a0 bc e6 b3 a2 e5 8a   ................
14130	a8 e7 8e 87 0a 66 75 6e  63 20 28 62 65 20 2a 42   .....func (be *B
14140	61 63 6b 74 65 73 74 45  6e 67 69 6e 65 29 20 63   acktestEngine) c
14150	61 6c 63 75 6c 61 74 65  50 72 69 63 65 56 6f 6c   alculatePriceVol
14160	61 74 69 6c 69 74 79 28  70 72 69 63 65 73 20 5b   atility(prices [
14170	5d 4d 61 72 6b 65 74 44  61 74 61 29 20 66 6c 6f   ]MarketData) flo
14180	61 74 36 34 20 7b 0a 09  69 66 20 6c 65 6e 28 70   at64 {..if len(p
14190	72 69 63 65 73 29 20 3c  20 32 20 7b 0a 09 09 72   rices) < 2 {...r
141a0	65 74 75 72 6e 20 30 2e  30 0a 09 7d 0a 0a 09 76   eturn 0.0..}...v
141b0	61 72 20 72 65 74 75 72  6e 73 20 5b 5d 66 6c 6f   ar returns []flo
141c0	61 74 36 34 0a 09 66 6f  72 20 69 20 3a 3d 20 31   at64..for i := 1
141d0	3b 20 69 20 3c 20 6c 65  6e 28 70 72 69 63 65 73   ; i < len(prices
141e0	29 3b 20 69 2b 2b 20 7b  0a 09 09 72 65 74 20 3a   ); i++ {...ret :
141f0	3d 20 28 70 72 69 63 65  73 5b 69 5d 2e 50 72 69   = (prices[i].Pri
14200	63 65 20 2d 20 70 72 69  63 65 73 5b 69 2d 31 5d   ce - prices[i-1]
14210	2e 50 72 69 63 65 29 20  2f 20 70 72 69 63 65 73   .Price) / prices
14220	5b 69 2d 31 5d 2e 50 72  69 63 65 0a 09 09 72 65   [i-1].Price...re
14230	74 75 72 6e 73 20 3d 20  61 70 70 65 6e 64 28 72   turns = append(r
14240	65 74 75 72 6e 73 2c 20  72 65 74 29 0a 09 7d 0a   eturns, ret)..}.
14250	0a 09 69 66 20 6c 65 6e  28 72 65 74 75 72 6e 73   ..if len(returns
14260	29 20 3d 3d 20 30 20 7b  0a 09 09 72 65 74 75 72   ) == 0 {...retur
14270	6e 20 30 2e 30 0a 09 7d  0a 0a 09 2f 2f 20 e8 ae   n 0.0..}...// ..
14280	a1 e7 ae 97 e6 a0 87 e5  87 86 e5 b7 ae e4 bd 9c   ................
14290	e4 b8 ba e6 b3 a2 e5 8a  a8 e7 8e 87 e5 ba a6 e9   ................
142a0	87 8f 0a 09 6d 65 61 6e  20 3a 3d 20 30 2e 30 0a   ....mean := 0.0.
142b0	09 66 6f 72 20 5f 2c 20  72 20 3a 3d 20 72 61 6e   .for _, r := ran
142c0	67 65 20 72 65 74 75 72  6e 73 20 7b 0a 09 09 6d   ge returns {...m
142d0	65 61 6e 20 2b 3d 20 72  0a 09 7d 0a 09 6d 65 61   ean += r..}..mea
142e0	6e 20 2f 3d 20 66 6c 6f  61 74 36 34 28 6c 65 6e   n /= float64(len
142f0	28 72 65 74 75 72 6e 73  29 29 0a 0a 09 76 61 72   (returns))...var
14300	69 61 6e 63 65 20 3a 3d  20 30 2e 30 0a 09 66 6f   iance := 0.0..fo
14310	72 20 5f 2c 20 72 20 3a  3d 20 72 61 6e 67 65 20   r _, r := range 
14320	72 65 74 75 72 6e 73 20  7b 0a 09 09 76 61 72 69   returns {...vari
14330	61 6e 63 65 20 2b 3d 20  28 72 20 2d 20 6d 65 61   ance += (r - mea
14340	6e 29 20 2a 20 28 72 20  2d 20 6d 65 61 6e 29 0a   n) * (r - mean).
14350	09 7d 0a 09 76 61 72 69  61 6e 63 65 20 2f 3d 20   .}..variance /= 
14360	66 6c 6f 61 74 36 34 28  6c 65 6e 28 72 65 74 75   float64(len(retu
14370	72 6e 73 29 20 2d 20 31  29 0a 0a 09 72 65 74 75   rns) - 1)...retu
14380	72 6e 20 6d 61 74 68 2e  53 71 72 74 28 76 61 72   rn math.Sqrt(var
14390	69 61 6e 63 65 29 0a 7d  0a 0a 2f 2f 20 63 61 6c   iance).}..// cal
143a0	63 75 6c 61 74 65 53 79  6d 62 6f 6c 43 6f 72 72   culateSymbolCorr
143b0	65 6c 61 74 69 6f 6e 4d  61 74 72 69 78 20 e8 ae   elationMatrix ..
143c0	a1 e7 ae 97 e5 b8 81 e7  a7 8d e7 9b b8 e5 85 b3   ................
143d0	e6 80 a7 e7 9f a9 e9 98  b5 0a 66 75 6e 63 20 28   ..........func (
143e0	62 65 20 2a 42 61 63 6b  74 65 73 74 45 6e 67 69   be *BacktestEngi
143f0	6e 65 29 20 63 61 6c 63  75 6c 61 74 65 53 79 6d   ne) calculateSym
14400	62 6f 6c 43 6f 72 72 65  6c 61 74 69 6f 6e 4d 61   bolCorrelationMa
14410	74 72 69 78 28 73 79 6d  62 6f 6c 53 74 61 74 65   trix(symbolState
14420	73 20 6d 61 70 5b 73 74  72 69 6e 67 5d 2a 53 79   s map[string]*Sy
14430	6d 62 6f 6c 53 74 61 74  65 2c 20 63 75 72 72 65   mbolState, curre
14440	6e 74 49 6e 64 65 78 20  69 6e 74 29 20 6d 61 70   ntIndex int) map
14450	5b 73 74 72 69 6e 67 5d  6d 61 70 5b 73 74 72 69   [string]map[stri
14460	6e 67 5d 66 6c 6f 61 74  36 34 20 7b 0a 09 63 6f   ng]float64 {..co
14470	72 72 65 6c 61 74 69 6f  6e 4d 61 74 72 69 78 20   rrelationMatrix 
14480	3a 3d 20 6d 61 6b 65 28  6d 61 70 5b 73 74 72 69   := make(map[stri
14490	6e 67 5d 6d 61 70 5b 73  74 72 69 6e 67 5d 66 6c   ng]map[string]fl
144a0	6f 61 74 36 34 29 0a 0a  09 2f 2f 20 e8 8e b7 e5   oat64)...// ....
144b0	8f 96 e6 89 80 e6 9c 89  e5 b8 81 e7 a7 8d e7 9a   ................
144c0	84 e6 94 b6 e7 9b 8a e7  8e 87 e5 ba 8f e5 88 97   ................
144d0	0a 09 72 65 74 75 72 6e  53 65 72 69 65 73 20 3a   ..returnSeries :
144e0	3d 20 6d 61 6b 65 28 6d  61 70 5b 73 74 72 69 6e   = make(map[strin
144f0	67 5d 5b 5d 66 6c 6f 61  74 36 34 29 0a 09 73 79   g][]float64)..sy
14500	6d 62 6f 6c 73 20 3a 3d  20 6d 61 6b 65 28 5b 5d   mbols := make([]
14510	73 74 72 69 6e 67 2c 20  30 2c 20 6c 65 6e 28 73   string, 0, len(s
14520	79 6d 62 6f 6c 53 74 61  74 65 73 29 29 0a 0a 09   ymbolStates))...
14530	66 6f 72 20 73 79 6d 62  6f 6c 2c 20 73 74 61 74   for symbol, stat
14540	65 20 3a 3d 20 72 61 6e  67 65 20 73 79 6d 62 6f   e := range symbo
14550	6c 53 74 61 74 65 73 20  7b 0a 09 09 69 66 20 63   lStates {...if c
14560	75 72 72 65 6e 74 49 6e  64 65 78 20 3e 3d 20 6c   urrentIndex >= l
14570	65 6e 28 73 74 61 74 65  2e 44 61 74 61 29 20 7c   en(state.Data) |
14580	7c 20 63 75 72 72 65 6e  74 49 6e 64 65 78 20 3c   | currentIndex <
14590	20 33 30 20 7b 0a 09 09  09 63 6f 6e 74 69 6e 75    30 {....continu
145a0	65 0a 09 09 7d 0a 0a 09  09 2f 2f 20 e8 ae a1 e7   e...}....// ....
145b0	ae 97 e6 9c 80 e8 bf 91  33 30 e5 a4 a9 e7 9a 84   ........30......
145c0	e6 97 a5 e6 94 b6 e7 9b  8a e7 8e 87 0a 09 09 72   ...............r
145d0	65 74 75 72 6e 73 20 3a  3d 20 6d 61 6b 65 28 5b   eturns := make([
145e0	5d 66 6c 6f 61 74 36 34  2c 20 33 30 29 0a 09 09   ]float64, 30)...
145f0	66 6f 72 20 69 20 3a 3d  20 30 3b 20 69 20 3c 20   for i := 0; i < 
14600	33 30 3b 20 69 2b 2b 20  7b 0a 09 09 09 69 64 78   30; i++ {....idx
14610	20 3a 3d 20 63 75 72 72  65 6e 74 49 6e 64 65 78    := currentIndex
14620	20 2d 20 32 39 20 2b 20  69 0a 09 09 09 69 66 20    - 29 + i....if 
14630	69 64 78 2b 31 20 3c 20  6c 65 6e 28 73 74 61 74   idx+1 < len(stat
14640	65 2e 44 61 74 61 29 20  7b 0a 09 09 09 09 72 65   e.Data) {.....re
14650	74 20 3a 3d 20 28 73 74  61 74 65 2e 44 61 74 61   t := (state.Data
14660	5b 69 64 78 2b 31 5d 2e  50 72 69 63 65 20 2d 20   [idx+1].Price - 
14670	73 74 61 74 65 2e 44 61  74 61 5b 69 64 78 5d 2e   state.Data[idx].
14680	50 72 69 63 65 29 20 2f  20 73 74 61 74 65 2e 44   Price) / state.D
14690	61 74 61 5b 69 64 78 5d  2e 50 72 69 63 65 0a 09   ata[idx].Price..
146a0	09 09 09 72 65 74 75 72  6e 73 5b 69 5d 20 3d 20   ...returns[i] = 
146b0	72 65 74 0a 09 09 09 7d  0a 09 09 7d 0a 0a 09 09   ret....}...}....
146c0	72 65 74 75 72 6e 53 65  72 69 65 73 5b 73 79 6d   returnSeries[sym
146d0	62 6f 6c 5d 20 3d 20 72  65 74 75 72 6e 73 0a 09   bol] = returns..
146e0	09 73 79 6d 62 6f 6c 73  20 3d 20 61 70 70 65 6e   .symbols = appen
146f0	64 28 73 79 6d 62 6f 6c  73 2c 20 73 79 6d 62 6f   d(symbols, symbo
14700	6c 29 0a 09 7d 0a 0a 09  2f 2f 20 e8 ae a1 e7 ae   l)..}...// .....
14710	97 e7 9b b8 e5 85 b3 e6  80 a7 0a 09 66 6f 72 20   ............for 
14720	5f 2c 20 73 79 6d 62 6f  6c 31 20 3a 3d 20 72 61   _, symbol1 := ra
14730	6e 67 65 20 73 79 6d 62  6f 6c 73 20 7b 0a 09 09   nge symbols {...
14740	63 6f 72 72 65 6c 61 74  69 6f 6e 4d 61 74 72 69   correlationMatri
14750	78 5b 73 79 6d 62 6f 6c  31 5d 20 3d 20 6d 61 6b   x[symbol1] = mak
14760	65 28 6d 61 70 5b 73 74  72 69 6e 67 5d 66 6c 6f   e(map[string]flo
14770	61 74 36 34 29 0a 09 09  66 6f 72 20 5f 2c 20 73   at64)...for _, s
14780	79 6d 62 6f 6c 32 20 3a  3d 20 72 61 6e 67 65 20   ymbol2 := range 
14790	73 79 6d 62 6f 6c 73 20  7b 0a 09 09 09 69 66 20   symbols {....if 
147a0	73 79 6d 62 6f 6c 31 20  3d 3d 20 73 79 6d 62 6f   symbol1 == symbo
147b0	6c 32 20 7b 0a 09 09 09  09 63 6f 72 72 65 6c 61   l2 {.....correla
147c0	74 69 6f 6e 4d 61 74 72  69 78 5b 73 79 6d 62 6f   tionMatrix[symbo
147d0	6c 31 5d 5b 73 79 6d 62  6f 6c 32 5d 20 3d 20 31   l1][symbol2] = 1
147e0	2e 30 0a 09 09 09 7d 20  65 6c 73 65 20 7b 0a 09   .0....} else {..
147f0	09 09 09 63 6f 72 72 20  3a 3d 20 62 65 2e 63 61   ...corr := be.ca
14800	6c 63 75 6c 61 74 65 50  72 69 63 65 43 6f 72 72   lculatePriceCorr
14810	65 6c 61 74 69 6f 6e 28  72 65 74 75 72 6e 53 65   elation(returnSe
14820	72 69 65 73 5b 73 79 6d  62 6f 6c 31 5d 2c 20 72   ries[symbol1], r
14830	65 74 75 72 6e 53 65 72  69 65 73 5b 73 79 6d 62   eturnSeries[symb
14840	6f 6c 32 5d 29 0a 09 09  09 09 63 6f 72 72 65 6c   ol2]).....correl
14850	61 74 69 6f 6e 4d 61 74  72 69 78 5b 73 79 6d 62   ationMatrix[symb
14860	6f 6c 31 5d 5b 73 79 6d  62 6f 6c 32 5d 20 3d 20   ol1][symbol2] = 
14870	63 6f 72 72 0a 09 09 09  7d 0a 09 09 7d 0a 09 7d   corr....}...}..}
14880	0a 0a 09 72 65 74 75 72  6e 20 63 6f 72 72 65 6c   ...return correl
14890	61 74 69 6f 6e 4d 61 74  72 69 78 0a 7d 0a 0a 2f   ationMatrix.}../
148a0	2f 20 61 6e 61 6c 79 7a  65 43 6f 72 72 65 6c 61   / analyzeCorrela
148b0	74 69 6f 6e 43 6c 75 73  74 65 72 73 20 e5 88 86   tionClusters ...
148c0	e6 9e 90 e7 9b b8 e5 85  b3 e6 80 a7 e8 81 9a e7   ................
148d0	b1 bb 0a 66 75 6e 63 20  28 62 65 20 2a 42 61 63   ...func (be *Bac
148e0	6b 74 65 73 74 45 6e 67  69 6e 65 29 20 61 6e 61   ktestEngine) ana
148f0	6c 79 7a 65 43 6f 72 72  65 6c 61 74 69 6f 6e 43   lyzeCorrelationC
14900	6c 75 73 74 65 72 73 28  63 6f 72 72 65 6c 61 74   lusters(correlat
14910	69 6f 6e 4d 61 74 72 69  78 20 6d 61 70 5b 73 74   ionMatrix map[st
14920	72 69 6e 67 5d 6d 61 70  5b 73 74 72 69 6e 67 5d   ring]map[string]
14930	66 6c 6f 61 74 36 34 29  20 2a 43 6f 72 72 65 6c   float64) *Correl
14940	61 74 69 6f 6e 43 6c 75  73 74 65 72 73 20 7b 0a   ationClusters {.
14950	09 63 6c 75 73 74 65 72  73 20 3a 3d 20 26 43 6f   .clusters := &Co
14960	72 72 65 6c 61 74 69 6f  6e 43 6c 75 73 74 65 72   rrelationCluster
14970	73 7b 0a 09 09 48 69 67  68 43 6f 72 72 65 6c 61   s{...HighCorrela
14980	74 69 6f 6e 43 6c 75 73  74 65 72 73 3a 20 6d 61   tionClusters: ma
14990	6b 65 28 5b 5d 5b 5d 73  74 72 69 6e 67 2c 20 30   ke([][]string, 0
149a0	29 2c 0a 09 09 4c 6f 77  43 6f 72 72 65 6c 61 74   ),...LowCorrelat
149b0	69 6f 6e 43 6c 75 73 74  65 72 73 3a 20 20 6d 61   ionClusters:  ma
149c0	6b 65 28 5b 5d 5b 5d 73  74 72 69 6e 67 2c 20 30   ke([][]string, 0
149d0	29 2c 0a 09 09 43 6c 75  73 74 65 72 53 74 61 74   ),...ClusterStat
149e0	73 3a 20 20 20 20 20 20  20 20 20 20 20 20 6d 61   s:            ma
149f0	6b 65 28 6d 61 70 5b 73  74 72 69 6e 67 5d 43 6c   ke(map[string]Cl
14a00	75 73 74 65 72 53 74 61  74 73 29 2c 0a 09 7d 0a   usterStats),..}.
14a10	0a 09 73 79 6d 62 6f 6c  73 20 3a 3d 20 6d 61 6b   ..symbols := mak
14a20	65 28 5b 5d 73 74 72 69  6e 67 2c 20 30 2c 20 6c   e([]string, 0, l
14a30	65 6e 28 63 6f 72 72 65  6c 61 74 69 6f 6e 4d 61   en(correlationMa
14a40	74 72 69 78 29 29 0a 09  66 6f 72 20 73 79 6d 62   trix))..for symb
14a50	6f 6c 20 3a 3d 20 72 61  6e 67 65 20 63 6f 72 72   ol := range corr
14a60	65 6c 61 74 69 6f 6e 4d  61 74 72 69 78 20 7b 0a   elationMatrix {.
14a70	09 09 73 79 6d 62 6f 6c  73 20 3d 20 61 70 70 65   ..symbols = appe
14a80	6e 64 28 73 79 6d 62 6f  6c 73 2c 20 73 79 6d 62   nd(symbols, symb
14a90	6f 6c 29 0a 09 7d 0a 0a  09 2f 2f 20 e4 bd bf e7   ol)..}...// ....
14aa0	94 a8 e7 ae 80 e5 8d 95  e7 9a 84 e5 b1 82 e6 ac   ................
14ab0	a1 e8 81 9a e7 b1 bb e7  ae 97 e6 b3 95 0a 09 76   ...............v
14ac0	69 73 69 74 65 64 20 3a  3d 20 6d 61 6b 65 28 6d   isited := make(m
14ad0	61 70 5b 73 74 72 69 6e  67 5d 62 6f 6f 6c 29 0a   ap[string]bool).
14ae0	09 66 6f 72 20 5f 2c 20  73 79 6d 62 6f 6c 20 3a   .for _, symbol :
14af0	3d 20 72 61 6e 67 65 20  73 79 6d 62 6f 6c 73 20   = range symbols 
14b00	7b 0a 09 09 69 66 20 76  69 73 69 74 65 64 5b 73   {...if visited[s
14b10	79 6d 62 6f 6c 5d 20 7b  0a 09 09 09 63 6f 6e 74   ymbol] {....cont
14b20	69 6e 75 65 0a 09 09 7d  0a 0a 09 09 2f 2f 20 e5   inue...}....// .
14b30	af bb e6 89 be e9 ab 98  e7 9b b8 e5 85 b3 e6 80   ................
14b40	a7 e8 81 9a e7 b1 bb ef  bc 88 e7 9b b8 e5 85 b3   ................
14b50	e7 b3 bb e6 95 b0 20 3e  20 30 2e 37 ef bc 89 0a   ...... > 0.7....
14b60	09 09 68 69 67 68 43 6f  72 72 43 6c 75 73 74 65   ..highCorrCluste
14b70	72 20 3a 3d 20 62 65 2e  66 69 6e 64 43 6f 72 72   r := be.findCorr
14b80	65 6c 61 74 69 6f 6e 43  6c 75 73 74 65 72 28 73   elationCluster(s
14b90	79 6d 62 6f 6c 2c 20 63  6f 72 72 65 6c 61 74 69   ymbol, correlati
14ba0	6f 6e 4d 61 74 72 69 78  2c 20 76 69 73 69 74 65   onMatrix, visite
14bb0	64 2c 20 30 2e 37 29 0a  09 09 69 66 20 6c 65 6e   d, 0.7)...if len
14bc0	28 68 69 67 68 43 6f 72  72 43 6c 75 73 74 65 72   (highCorrCluster
14bd0	29 20 3e 20 31 20 7b 0a  09 09 09 63 6c 75 73 74   ) > 1 {....clust
14be0	65 72 73 2e 48 69 67 68  43 6f 72 72 65 6c 61 74   ers.HighCorrelat
14bf0	69 6f 6e 43 6c 75 73 74  65 72 73 20 3d 20 61 70   ionClusters = ap
14c00	70 65 6e 64 28 63 6c 75  73 74 65 72 73 2e 48 69   pend(clusters.Hi
14c10	67 68 43 6f 72 72 65 6c  61 74 69 6f 6e 43 6c 75   ghCorrelationClu
14c20	73 74 65 72 73 2c 20 68  69 67 68 43 6f 72 72 43   sters, highCorrC
14c30	6c 75 73 74 65 72 29 0a  09 09 09 63 6c 75 73 74   luster)....clust
14c40	65 72 73 2e 43 6c 75 73  74 65 72 53 74 61 74 73   ers.ClusterStats
14c50	5b 66 6d 74 2e 53 70 72  69 6e 74 66 28 22 68 69   [fmt.Sprintf("hi
14c60	67 68 5f 25 64 22 2c 20  6c 65 6e 28 63 6c 75 73   gh_%d", len(clus
14c70	74 65 72 73 2e 48 69 67  68 43 6f 72 72 65 6c 61   ters.HighCorrela
14c80	74 69 6f 6e 43 6c 75 73  74 65 72 73 29 29 5d 20   tionClusters))] 
14c90	3d 20 62 65 2e 63 61 6c  63 75 6c 61 74 65 43 6c   = be.calculateCl
14ca0	75 73 74 65 72 53 74 61  74 73 28 68 69 67 68 43   usterStats(highC
14cb0	6f 72 72 43 6c 75 73 74  65 72 2c 20 63 6f 72 72   orrCluster, corr
14cc0	65 6c 61 74 69 6f 6e 4d  61 74 72 69 78 29 0a 09   elationMatrix)..
14cd0	09 7d 0a 09 7d 0a 0a 09  2f 2f 20 e9 87 8d e7 bd   .}..}...// .....
14ce0	ae e8 ae bf e9 97 ae e6  a0 87 e8 ae b0 0a 09 76   ...............v
14cf0	69 73 69 74 65 64 20 3d  20 6d 61 6b 65 28 6d 61   isited = make(ma
14d00	70 5b 73 74 72 69 6e 67  5d 62 6f 6f 6c 29 0a 0a   p[string]bool)..
14d10	09 2f 2f 20 e5 af bb e6  89 be e4 bd 8e e7 9b b8   .// ............
14d20	e5 85 b3 e6 80 a7 e7 bb  84 e5 90 88 ef bc 88 e7   ................
14d30	9b b8 e5 85 b3 e7 b3 bb  e6 95 b0 20 3c 20 30 2e   ........... < 0.
14d40	33 ef bc 89 0a 09 66 6f  72 20 5f 2c 20 73 79 6d   3.....for _, sym
14d50	62 6f 6c 20 3a 3d 20 72  61 6e 67 65 20 73 79 6d   bol := range sym
14d60	62 6f 6c 73 20 7b 0a 09  09 69 66 20 76 69 73 69   bols {...if visi
14d70	74 65 64 5b 73 79 6d 62  6f 6c 5d 20 7b 0a 09 09   ted[symbol] {...
14d80	09 63 6f 6e 74 69 6e 75  65 0a 09 09 7d 0a 0a 09   .continue...}...
14d90	09 2f 2f 20 e5 af bb e6  89 be e4 bd 8e e7 9b b8   .// ............
14da0	e5 85 b3 e6 80 a7 e8 81  9a e7 b1 bb 0a 09 09 6c   ...............l
14db0	6f 77 43 6f 72 72 43 6c  75 73 74 65 72 20 3a 3d   owCorrCluster :=
14dc0	20 62 65 2e 66 69 6e 64  4c 6f 77 43 6f 72 72 65    be.findLowCorre
14dd0	6c 61 74 69 6f 6e 47 72  6f 75 70 28 73 79 6d 62   lationGroup(symb
14de0	6f 6c 2c 20 63 6f 72 72  65 6c 61 74 69 6f 6e 4d   ol, correlationM
14df0	61 74 72 69 78 2c 20 76  69 73 69 74 65 64 2c 20   atrix, visited, 
14e00	73 79 6d 62 6f 6c 73 2c  20 30 2e 33 29 0a 09 09   symbols, 0.3)...
14e10	69 66 20 6c 65 6e 28 6c  6f 77 43 6f 72 72 43 6c   if len(lowCorrCl
14e20	75 73 74 65 72 29 20 3e  20 31 20 7b 0a 09 09 09   uster) > 1 {....
14e30	63 6c 75 73 74 65 72 73  2e 4c 6f 77 43 6f 72 72   clusters.LowCorr
14e40	65 6c 61 74 69 6f 6e 43  6c 75 73 74 65 72 73 20   elationClusters 
14e50	3d 20 61 70 70 65 6e 64  28 63 6c 75 73 74 65 72   = append(cluster
14e60	73 2e 4c 6f 77 43 6f 72  72 65 6c 61 74 69 6f 6e   s.LowCorrelation
14e70	43 6c 75 73 74 65 72 73  2c 20 6c 6f 77 43 6f 72   Clusters, lowCor
14e80	72 43 6c 75 73 74 65 72  29 0a 09 09 09 63 6c 75   rCluster)....clu
14e90	73 74 65 72 73 2e 43 6c  75 73 74 65 72 53 74 61   sters.ClusterSta
14ea0	74 73 5b 66 6d 74 2e 53  70 72 69 6e 74 66 28 22   ts[fmt.Sprintf("
14eb0	6c 6f 77 5f 25 64 22 2c  20 6c 65 6e 28 63 6c 75   low_%d", len(clu
14ec0	73 74 65 72 73 2e 4c 6f  77 43 6f 72 72 65 6c 61   sters.LowCorrela
14ed0	74 69 6f 6e 43 6c 75 73  74 65 72 73 29 29 5d 20   tionClusters))] 
14ee0	3d 20 62 65 2e 63 61 6c  63 75 6c 61 74 65 43 6c   = be.calculateCl
14ef0	75 73 74 65 72 53 74 61  74 73 28 6c 6f 77 43 6f   usterStats(lowCo
14f00	72 72 43 6c 75 73 74 65  72 2c 20 63 6f 72 72 65   rrCluster, corre
14f10	6c 61 74 69 6f 6e 4d 61  74 72 69 78 29 0a 09 09   lationMatrix)...
14f20	7d 0a 09 7d 0a 0a 09 6c  6f 67 2e 50 72 69 6e 74   }..}...log.Print
14f30	66 28 22 5b 43 4f 52 52  45 4c 41 54 49 4f 4e 5f   f("[CORRELATION_
14f40	41 4e 41 4c 59 53 49 53  5d 20 e5 8f 91 e7 8e b0   ANALYSIS] ......
14f50	25 64 e4 b8 aa e9 ab 98  e7 9b b8 e5 85 b3 e6 80   %d..............
14f60	a7 e8 81 9a e7 b1 bb ef  bc 8c 25 64 e4 b8 aa e4   ..........%d....
14f70	bd 8e e7 9b b8 e5 85 b3  e6 80 a7 e7 bb 84 e5 90   ................
14f80	88 22 2c 0a 09 09 6c 65  6e 28 63 6c 75 73 74 65   .",...len(cluste
14f90	72 73 2e 48 69 67 68 43  6f 72 72 65 6c 61 74 69   rs.HighCorrelati
14fa0	6f 6e 43 6c 75 73 74 65  72 73 29 2c 20 6c 65 6e   onClusters), len
14fb0	28 63 6c 75 73 74 65 72  73 2e 4c 6f 77 43 6f 72   (clusters.LowCor
14fc0	72 65 6c 61 74 69 6f 6e  43 6c 75 73 74 65 72 73   relationClusters
14fd0	29 29 0a 0a 09 72 65 74  75 72 6e 20 63 6c 75 73   ))...return clus
14fe0	74 65 72 73 0a 7d 0a 0a  2f 2f 20 66 69 6e 64 43   ters.}..// findC
14ff0	6f 72 72 65 6c 61 74 69  6f 6e 43 6c 75 73 74 65   orrelationCluste
15000	72 20 e5 af bb e6 89 be  e7 9b b8 e5 85 b3 e6 80   r ..............
15010	a7 e8 81 9a e7 b1 bb 0a  66 75 6e 63 20 28 62 65   ........func (be
15020	20 2a 42 61 63 6b 74 65  73 74 45 6e 67 69 6e 65    *BacktestEngine
15030	29 20 66 69 6e 64 43 6f  72 72 65 6c 61 74 69 6f   ) findCorrelatio
15040	6e 43 6c 75 73 74 65 72  28 73 74 61 72 74 53 79   nCluster(startSy
15050	6d 62 6f 6c 20 73 74 72  69 6e 67 2c 20 63 6f 72   mbol string, cor
15060	72 65 6c 61 74 69 6f 6e  4d 61 74 72 69 78 20 6d   relationMatrix m
15070	61 70 5b 73 74 72 69 6e  67 5d 6d 61 70 5b 73 74   ap[string]map[st
15080	72 69 6e 67 5d 66 6c 6f  61 74 36 34 2c 20 76 69   ring]float64, vi
15090	73 69 74 65 64 20 6d 61  70 5b 73 74 72 69 6e 67   sited map[string
150a0	5d 62 6f 6f 6c 2c 20 74  68 72 65 73 68 6f 6c 64   ]bool, threshold
150b0	20 66 6c 6f 61 74 36 34  29 20 5b 5d 73 74 72 69    float64) []stri
150c0	6e 67 20 7b 0a 09 63 6c  75 73 74 65 72 20 3a 3d   ng {..cluster :=
150d0	20 5b 5d 73 74 72 69 6e  67 7b 73 74 61 72 74 53    []string{startS
150e0	79 6d 62 6f 6c 7d 0a 09  76 69 73 69 74 65 64 5b   ymbol}..visited[
150f0	73 74 61 72 74 53 79 6d  62 6f 6c 5d 20 3d 20 74   startSymbol] = t
15100	72 75 65 0a 09 71 75 65  75 65 20 3a 3d 20 5b 5d   rue..queue := []
15110	73 74 72 69 6e 67 7b 73  74 61 72 74 53 79 6d 62   string{startSymb
15120	6f 6c 7d 0a 0a 09 66 6f  72 20 6c 65 6e 28 71 75   ol}...for len(qu
15130	65 75 65 29 20 3e 20 30  20 7b 0a 09 09 63 75 72   eue) > 0 {...cur
15140	72 65 6e 74 20 3a 3d 20  71 75 65 75 65 5b 30 5d   rent := queue[0]
15150	0a 09 09 71 75 65 75 65  20 3d 20 71 75 65 75 65   ...queue = queue
15160	5b 31 3a 5d 0a 0a 09 09  66 6f 72 20 73 79 6d 62   [1:]....for symb
15170	6f 6c 2c 20 63 6f 72 72  20 3a 3d 20 72 61 6e 67   ol, corr := rang
15180	65 20 63 6f 72 72 65 6c  61 74 69 6f 6e 4d 61 74   e correlationMat
15190	72 69 78 5b 63 75 72 72  65 6e 74 5d 20 7b 0a 09   rix[current] {..
151a0	09 09 69 66 20 21 76 69  73 69 74 65 64 5b 73 79   ..if !visited[sy
151b0	6d 62 6f 6c 5d 20 26 26  20 6d 61 74 68 2e 41 62   mbol] && math.Ab
151c0	73 28 63 6f 72 72 29 20  3e 3d 20 74 68 72 65 73   s(corr) >= thres
151d0	68 6f 6c 64 20 7b 0a 09  09 09 09 76 69 73 69 74   hold {.....visit
151e0	65 64 5b 73 79 6d 62 6f  6c 5d 20 3d 20 74 72 75   ed[symbol] = tru
151f0	65 0a 09 09 09 09 63 6c  75 73 74 65 72 20 3d 20   e.....cluster = 
15200	61 70 70 65 6e 64 28 63  6c 75 73 74 65 72 2c 20   append(cluster, 
15210	73 79 6d 62 6f 6c 29 0a  09 09 09 09 71 75 65 75   symbol).....queu
15220	65 20 3d 20 61 70 70 65  6e 64 28 71 75 65 75 65   e = append(queue
15230	2c 20 73 79 6d 62 6f 6c  29 0a 09 09 09 7d 0a 09   , symbol)....}..
15240	09 7d 0a 09 7d 0a 0a 09  72 65 74 75 72 6e 20 63   .}..}...return c
15250	6c 75 73 74 65 72 0a 7d  0a 0a 2f 2f 20 66 69 6e   luster.}..// fin
15260	64 4c 6f 77 43 6f 72 72  65 6c 61 74 69 6f 6e 47   dLowCorrelationG
15270	72 6f 75 70 20 e5 af bb  e6 89 be e4 bd 8e e7 9b   roup ...........
15280	b8 e5 85 b3 e6 80 a7 e7  bb 84 e5 90 88 0a 66 75   ..............fu
15290	6e 63 20 28 62 65 20 2a  42 61 63 6b 74 65 73 74   nc (be *Backtest
152a0	45 6e 67 69 6e 65 29 20  66 69 6e 64 4c 6f 77 43   Engine) findLowC
152b0	6f 72 72 65 6c 61 74 69  6f 6e 47 72 6f 75 70 28   orrelationGroup(
152c0	73 74 61 72 74 53 79 6d  62 6f 6c 20 73 74 72 69   startSymbol stri
152d0	6e 67 2c 20 63 6f 72 72  65 6c 61 74 69 6f 6e 4d   ng, correlationM
152e0	61 74 72 69 78 20 6d 61  70 5b 73 74 72 69 6e 67   atrix map[string
152f0	5d 6d 61 70 5b 73 74 72  69 6e 67 5d 66 6c 6f 61   ]map[string]floa
15300	74 36 34 2c 20 76 69 73  69 74 65 64 20 6d 61 70   t64, visited map
15310	5b 73 74 72 69 6e 67 5d  62 6f 6f 6c 2c 20 61 6c   [string]bool, al
15320	6c 53 79 6d 62 6f 6c 73  20 5b 5d 73 74 72 69 6e   lSymbols []strin
15330	67 2c 20 74 68 72 65 73  68 6f 6c 64 20 66 6c 6f   g, threshold flo
15340	61 74 36 34 29 20 5b 5d  73 74 72 69 6e 67 20 7b   at64) []string {
15350	0a 09 67 72 6f 75 70 20  3a 3d 20 5b 5d 73 74 72   ..group := []str
15360	69 6e 67 7b 73 74 61 72  74 53 79 6d 62 6f 6c 7d   ing{startSymbol}
15370	0a 09 76 69 73 69 74 65  64 5b 73 74 61 72 74 53   ..visited[startS
15380	79 6d 62 6f 6c 5d 20 3d  20 74 72 75 65 0a 0a 09   ymbol] = true...
15390	2f 2f 20 e5 af bb e6 89  be e4 b8 8e e8 b5 b7 e5   // .............
153a0	a7 8b e5 b8 81 e7 a7 8d  e7 9b b8 e5 85 b3 e6 80   ................
153b0	a7 e6 9c 80 e4 bd 8e e7  9a 84 e5 85 b6 e4 bb 96   ................
153c0	e5 b8 81 e7 a7 8d 0a 09  74 79 70 65 20 53 79 6d   ........type Sym
153d0	62 6f 6c 43 6f 72 72 20  73 74 72 75 63 74 20 7b   bolCorr struct {
153e0	0a 09 09 53 79 6d 62 6f  6c 20 73 74 72 69 6e 67   ...Symbol string
153f0	0a 09 09 43 6f 72 72 20  20 20 66 6c 6f 61 74 36   ...Corr   float6
15400	34 0a 09 7d 0a 0a 09 76  61 72 20 63 61 6e 64 69   4..}...var candi
15410	64 61 74 65 73 20 5b 5d  53 79 6d 62 6f 6c 43 6f   dates []SymbolCo
15420	72 72 0a 09 66 6f 72 20  5f 2c 20 73 79 6d 62 6f   rr..for _, symbo
15430	6c 20 3a 3d 20 72 61 6e  67 65 20 61 6c 6c 53 79   l := range allSy
15440	6d 62 6f 6c 73 20 7b 0a  09 09 69 66 20 73 79 6d   mbols {...if sym
15450	62 6f 6c 20 3d 3d 20 73  74 61 72 74 53 79 6d 62   bol == startSymb
15460	6f 6c 20 7b 0a 09 09 09  63 6f 6e 74 69 6e 75 65   ol {....continue
15470	0a 09 09 7d 0a 09 09 63  6f 72 72 20 3a 3d 20 6d   ...}...corr := m
15480	61 74 68 2e 41 62 73 28  63 6f 72 72 65 6c 61 74   ath.Abs(correlat
15490	69 6f 6e 4d 61 74 72 69  78 5b 73 74 61 72 74 53   ionMatrix[startS
154a0	79 6d 62 6f 6c 5d 5b 73  79 6d 62 6f 6c 5d 29 0a   ymbol][symbol]).
154b0	09 09 63 61 6e 64 69 64  61 74 65 73 20 3d 20 61   ..candidates = a
154c0	70 70 65 6e 64 28 63 61  6e 64 69 64 61 74 65 73   ppend(candidates
154d0	2c 20 53 79 6d 62 6f 6c  43 6f 72 72 7b 53 79 6d   , SymbolCorr{Sym
154e0	62 6f 6c 3a 20 73 79 6d  62 6f 6c 2c 20 43 6f 72   bol: symbol, Cor
154f0	72 3a 20 63 6f 72 72 7d  29 0a 09 7d 0a 0a 09 2f   r: corr})..}.../
15500	2f 20 e6 8c 89 e7 9b b8  e5 85 b3 e6 80 a7 e5 8d   / ..............
15510	87 e5 ba 8f e6 8e 92 e5  ba 8f ef bc 88 e4 bd 8e   ................
15520	e7 9b b8 e5 85 b3 e6 80  a7 e4 bc 98 e5 85 88 ef   ................
15530	bc 89 0a 09 73 6f 72 74  2e 53 6c 69 63 65 28 63   ....sort.Slice(c
15540	61 6e 64 69 64 61 74 65  73 2c 20 66 75 6e 63 28   andidates, func(
15550	69 2c 20 6a 20 69 6e 74  29 20 62 6f 6f 6c 20 7b   i, j int) bool {
15560	0a 09 09 72 65 74 75 72  6e 20 63 61 6e 64 69 64   ...return candid
15570	61 74 65 73 5b 69 5d 2e  43 6f 72 72 20 3c 20 63   ates[i].Corr < c
15580	61 6e 64 69 64 61 74 65  73 5b 6a 5d 2e 43 6f 72   andidates[j].Cor
15590	72 0a 09 7d 29 0a 0a 09  2f 2f 20 e9 80 89 e6 8b   r..})...// .....
155a0	a9 e7 9b b8 e5 85 b3 e6  80 a7 e6 9c 80 e4 bd 8e   ................
155b0	e7 9a 84 e5 87 a0 e4 b8  aa e5 b8 81 e7 a7 8d 0a   ................
155c0	09 6d 61 78 47 72 6f 75  70 53 69 7a 65 20 3a 3d   .maxGroupSize :=
155d0	20 35 0a 09 66 6f 72 20  69 2c 20 63 61 6e 64 69    5..for i, candi
155e0	64 61 74 65 20 3a 3d 20  72 61 6e 67 65 20 63 61   date := range ca
155f0	6e 64 69 64 61 74 65 73  20 7b 0a 09 09 69 66 20   ndidates {...if 
15600	69 20 3e 3d 20 6d 61 78  47 72 6f 75 70 53 69 7a   i >= maxGroupSiz
15610	65 20 7c 7c 20 63 61 6e  64 69 64 61 74 65 2e 43   e || candidate.C
15620	6f 72 72 20 3e 20 74 68  72 65 73 68 6f 6c 64 20   orr > threshold 
15630	7b 0a 09 09 09 62 72 65  61 6b 0a 09 09 7d 0a 09   {....break...}..
15640	09 69 66 20 21 76 69 73  69 74 65 64 5b 63 61 6e   .if !visited[can
15650	64 69 64 61 74 65 2e 53  79 6d 62 6f 6c 5d 20 7b   didate.Symbol] {
15660	0a 09 09 09 67 72 6f 75  70 20 3d 20 61 70 70 65   ....group = appe
15670	6e 64 28 67 72 6f 75 70  2c 20 63 61 6e 64 69 64   nd(group, candid
15680	61 74 65 2e 53 79 6d 62  6f 6c 29 0a 09 09 09 76   ate.Symbol)....v
15690	69 73 69 74 65 64 5b 63  61 6e 64 69 64 61 74 65   isited[candidate
156a0	2e 53 79 6d 62 6f 6c 5d  20 3d 20 74 72 75 65 0a   .Symbol] = true.
156b0	09 09 7d 0a 09 7d 0a 0a  09 72 65 74 75 72 6e 20   ..}..}...return 
156c0	67 72 6f 75 70 0a 7d 0a  0a 2f 2f 20 63 61 6c 63   group.}..// calc
156d0	75 6c 61 74 65 43 6c 75  73 74 65 72 53 74 61 74   ulateClusterStat
156e0	73 20 e8 ae a1 e7 ae 97  e8 81 9a e7 b1 bb e7 bb   s ..............
156f0	9f e8 ae a1 0a 66 75 6e  63 20 28 62 65 20 2a 42   .....func (be *B
15700	61 63 6b 74 65 73 74 45  6e 67 69 6e 65 29 20 63   acktestEngine) c
15710	61 6c 63 75 6c 61 74 65  43 6c 75 73 74 65 72 53   alculateClusterS
15720	74 61 74 73 28 63 6c 75  73 74 65 72 20 5b 5d 73   tats(cluster []s
15730	74 72 69 6e 67 2c 20 63  6f 72 72 65 6c 61 74 69   tring, correlati
15740	6f 6e 4d 61 74 72 69 78  20 6d 61 70 5b 73 74 72   onMatrix map[str
15750	69 6e 67 5d 6d 61 70 5b  73 74 72 69 6e 67 5d 66   ing]map[string]f
15760	6c 6f 61 74 36 34 29 20  43 6c 75 73 74 65 72 53   loat64) ClusterS
15770	74 61 74 73 20 7b 0a 09  69 66 20 6c 65 6e 28 63   tats {..if len(c
15780	6c 75 73 74 65 72 29 20  3c 3d 20 31 20 7b 0a 09   luster) <= 1 {..
15790	09 72 65 74 75 72 6e 20  43 6c 75 73 74 65 72 53   .return ClusterS
157a0	74 61 74 73 7b 7d 0a 09  7d 0a 0a 09 76 61 72 20   tats{}..}...var 
157b0	63 6f 72 72 65 6c 61 74  69 6f 6e 73 20 5b 5d 66   correlations []f
157c0	6c 6f 61 74 36 34 0a 09  66 6f 72 20 69 20 3a 3d   loat64..for i :=
157d0	20 30 3b 20 69 20 3c 20  6c 65 6e 28 63 6c 75 73    0; i < len(clus
157e0	74 65 72 29 3b 20 69 2b  2b 20 7b 0a 09 09 66 6f   ter); i++ {...fo
157f0	72 20 6a 20 3a 3d 20 69  20 2b 20 31 3b 20 6a 20   r j := i + 1; j 
15800	3c 20 6c 65 6e 28 63 6c  75 73 74 65 72 29 3b 20   < len(cluster); 
15810	6a 2b 2b 20 7b 0a 09 09  09 73 79 6d 62 6f 6c 31   j++ {....symbol1
15820	20 3a 3d 20 63 6c 75 73  74 65 72 5b 69 5d 0a 09    := cluster[i]..
15830	09 09 73 79 6d 62 6f 6c  32 20 3a 3d 20 63 6c 75   ..symbol2 := clu
15840	73 74 65 72 5b 6a 5d 0a  09 09 09 69 66 20 63 6f   ster[j]....if co
15850	72 72 2c 20 65 78 69 73  74 73 20 3a 3d 20 63 6f   rr, exists := co
15860	72 72 65 6c 61 74 69 6f  6e 4d 61 74 72 69 78 5b   rrelationMatrix[
15870	73 79 6d 62 6f 6c 31 5d  5b 73 79 6d 62 6f 6c 32   symbol1][symbol2
15880	5d 3b 20 65 78 69 73 74  73 20 7b 0a 09 09 09 09   ]; exists {.....
15890	63 6f 72 72 65 6c 61 74  69 6f 6e 73 20 3d 20 61   correlations = a
158a0	70 70 65 6e 64 28 63 6f  72 72 65 6c 61 74 69 6f   ppend(correlatio
158b0	6e 73 2c 20 6d 61 74 68  2e 41 62 73 28 63 6f 72   ns, math.Abs(cor
158c0	72 29 29 0a 09 09 09 7d  0a 09 09 7d 0a 09 7d 0a   r))....}...}..}.
158d0	0a 09 73 74 61 74 73 20  3a 3d 20 43 6c 75 73 74   ..stats := Clust
158e0	65 72 53 74 61 74 73 7b  0a 09 09 53 69 7a 65 3a   erStats{...Size:
158f0	20 6c 65 6e 28 63 6c 75  73 74 65 72 29 2c 0a 09    len(cluster),..
15900	7d 0a 0a 09 69 66 20 6c  65 6e 28 63 6f 72 72 65   }...if len(corre
15910	6c 61 74 69 6f 6e 73 29  20 3e 20 30 20 7b 0a 09   lations) > 0 {..
15920	09 2f 2f 20 e8 ae a1 e7  ae 97 e5 b9 b3 e5 9d 87   .// ............
15930	e7 9b b8 e5 85 b3 e6 80  a7 e5 92 8c e6 a0 87 e5   ................
15940	87 86 e5 b7 ae 0a 09 09  73 75 6d 20 3a 3d 20 30   ........sum := 0
15950	2e 30 0a 09 09 66 6f 72  20 5f 2c 20 63 6f 72 72   .0...for _, corr
15960	20 3a 3d 20 72 61 6e 67  65 20 63 6f 72 72 65 6c    := range correl
15970	61 74 69 6f 6e 73 20 7b  0a 09 09 09 73 75 6d 20   ations {....sum 
15980	2b 3d 20 63 6f 72 72 0a  09 09 7d 0a 09 09 73 74   += corr...}...st
15990	61 74 73 2e 41 76 67 43  6f 72 72 65 6c 61 74 69   ats.AvgCorrelati
159a0	6f 6e 20 3d 20 73 75 6d  20 2f 20 66 6c 6f 61 74   on = sum / float
159b0	36 34 28 6c 65 6e 28 63  6f 72 72 65 6c 61 74 69   64(len(correlati
159c0	6f 6e 73 29 29 0a 0a 09  09 2f 2f 20 e8 ae a1 e7   ons))....// ....
159d0	ae 97 e6 a0 87 e5 87 86  e5 b7 ae 0a 09 09 73 75   ..............su
159e0	6d 53 71 20 3a 3d 20 30  2e 30 0a 09 09 66 6f 72   mSq := 0.0...for
159f0	20 5f 2c 20 63 6f 72 72  20 3a 3d 20 72 61 6e 67    _, corr := rang
15a00	65 20 63 6f 72 72 65 6c  61 74 69 6f 6e 73 20 7b   e correlations {
15a10	0a 09 09 09 64 69 66 66  20 3a 3d 20 63 6f 72 72   ....diff := corr
15a20	20 2d 20 73 74 61 74 73  2e 41 76 67 43 6f 72 72    - stats.AvgCorr
15a30	65 6c 61 74 69 6f 6e 0a  09 09 09 73 75 6d 53 71   elation....sumSq
15a40	20 2b 3d 20 64 69 66 66  20 2a 20 64 69 66 66 0a    += diff * diff.
15a50	09 09 7d 0a 09 09 73 74  61 74 73 2e 43 6f 72 72   ..}...stats.Corr
15a60	65 6c 61 74 69 6f 6e 53  74 64 44 65 76 20 3d 20   elationStdDev = 
15a70	6d 61 74 68 2e 53 71 72  74 28 73 75 6d 53 71 20   math.Sqrt(sumSq 
15a80	2f 20 66 6c 6f 61 74 36  34 28 6c 65 6e 28 63 6f   / float64(len(co
15a90	72 72 65 6c 61 74 69 6f  6e 73 29 29 29 0a 0a 09   rrelations)))...
15aa0	09 2f 2f 20 e8 ae a1 e7  ae 97 e5 a4 9a e6 a0 b7   .// ............
15ab0	e5 8c 96 e6 bd 9c e5 8a  9b 0a 09 09 73 74 61 74   ............stat
15ac0	73 2e 44 69 76 65 72 73  69 66 69 63 61 74 69 6f   s.Diversificatio
15ad0	6e 50 6f 74 65 6e 74 69  61 6c 20 3d 20 31 2e 30   nPotential = 1.0
15ae0	20 2d 20 73 74 61 74 73  2e 41 76 67 43 6f 72 72    - stats.AvgCorr
15af0	65 6c 61 74 69 6f 6e 0a  09 7d 0a 0a 09 72 65 74   elation..}...ret
15b00	75 72 6e 20 73 74 61 74  73 0a 7d 0a 0a 2f 2f 20   urn stats.}..// 
15b10	63 61 6c 63 75 6c 61 74  65 43 6f 72 72 65 6c 61   calculateCorrela
15b20	74 69 6f 6e 42 61 73 65  64 52 69 73 6b 20 e8 ae   tionBasedRisk ..
15b30	a1 e7 ae 97 e5 9f ba e4  ba 8e e7 9b b8 e5 85 b3   ................
15b40	e6 80 a7 e7 9a 84 e9 a3  8e e9 99 a9 e5 ba a6 e9   ................
15b50	87 8f 0a 66 75 6e 63 20  28 62 65 20 2a 42 61 63   ...func (be *Bac
15b60	6b 74 65 73 74 45 6e 67  69 6e 65 29 20 63 61 6c   ktestEngine) cal
15b70	63 75 6c 61 74 65 43 6f  72 72 65 6c 61 74 69 6f   culateCorrelatio
15b80	6e 42 61 73 65 64 52 69  73 6b 28 63 6f 72 72 65   nBasedRisk(corre
15b90	6c 61 74 69 6f 6e 4d 61  74 72 69 78 20 6d 61 70   lationMatrix map
15ba0	5b 73 74 72 69 6e 67 5d  6d 61 70 5b 73 74 72 69   [string]map[stri
15bb0	6e 67 5d 66 6c 6f 61 74  36 34 2c 20 73 79 6d 62   ng]float64, symb
15bc0	6f 6c 53 74 61 74 65 73  20 6d 61 70 5b 73 74 72   olStates map[str
15bd0	69 6e 67 5d 2a 53 79 6d  62 6f 6c 53 74 61 74 65   ing]*SymbolState
15be0	29 20 2a 43 6f 72 72 65  6c 61 74 69 6f 6e 52 69   ) *CorrelationRi
15bf0	73 6b 4d 65 74 72 69 63  73 20 7b 0a 09 6d 65 74   skMetrics {..met
15c00	72 69 63 73 20 3a 3d 20  26 43 6f 72 72 65 6c 61   rics := &Correla
15c10	74 69 6f 6e 52 69 73 6b  4d 65 74 72 69 63 73 7b   tionRiskMetrics{
15c20	0a 09 09 50 6f 72 74 66  6f 6c 69 6f 43 6f 72 72   ...PortfolioCorr
15c30	65 6c 61 74 69 6f 6e 52  69 73 6b 3a 20 30 2e 30   elationRisk: 0.0
15c40	2c 0a 09 09 43 6f 6e 63  65 6e 74 72 61 74 69 6f   ,...Concentratio
15c50	6e 52 69 73 6b 3a 20 20  20 20 20 20 20 20 30 2e   nRisk:        0.
15c60	30 2c 0a 09 09 44 69 76  65 72 73 69 66 69 63 61   0,...Diversifica
15c70	74 69 6f 6e 42 65 6e 65  66 69 74 3a 20 20 20 30   tionBenefit:   0
15c80	2e 30 2c 0a 09 09 53 79  73 74 65 6d 69 63 52 69   .0,...SystemicRi
15c90	73 6b 3a 20 20 20 20 20  20 20 20 20 20 20 20 20   sk:             
15ca0	30 2e 30 2c 0a 09 7d 0a  0a 09 2f 2f 20 e8 8e b7   0.0,..}...// ...
15cb0	e5 8f 96 e5 bd 93 e5 89  8d e6 8c 81 e4 bb 93 0a   ................
15cc0	09 76 61 72 20 70 6f 73  69 74 69 6f 6e 73 20 5b   .var positions [
15cd0	5d 50 6f 73 69 74 69 6f  6e 49 6e 66 6f 0a 09 74   ]PositionInfo..t
15ce0	6f 74 61 6c 56 61 6c 75  65 20 3a 3d 20 30 2e 30   otalValue := 0.0
15cf0	0a 0a 09 66 6f 72 20 73  79 6d 62 6f 6c 2c 20 73   ...for symbol, s
15d00	74 61 74 65 20 3a 3d 20  72 61 6e 67 65 20 73 79   tate := range sy
15d10	6d 62 6f 6c 53 74 61 74  65 73 20 7b 0a 09 09 69   mbolStates {...i
15d20	66 20 73 74 61 74 65 2e  50 6f 73 69 74 69 6f 6e   f state.Position
15d30	20 3e 20 30 20 7b 0a 09  09 09 70 72 69 63 65 20    > 0 {....price 
15d40	3a 3d 20 73 74 61 74 65  2e 44 61 74 61 5b 6c 65   := state.Data[le
15d50	6e 28 73 74 61 74 65 2e  44 61 74 61 29 2d 31 5d   n(state.Data)-1]
15d60	2e 50 72 69 63 65 0a 09  09 09 76 61 6c 75 65 20   .Price....value 
15d70	3a 3d 20 73 74 61 74 65  2e 50 6f 73 69 74 69 6f   := state.Positio
15d80	6e 20 2a 20 70 72 69 63  65 0a 09 09 09 70 6f 73   n * price....pos
15d90	69 74 69 6f 6e 73 20 3d  20 61 70 70 65 6e 64 28   itions = append(
15da0	70 6f 73 69 74 69 6f 6e  73 2c 20 50 6f 73 69 74   positions, Posit
15db0	69 6f 6e 49 6e 66 6f 7b  0a 09 09 09 09 53 79 6d   ionInfo{.....Sym
15dc0	62 6f 6c 3a 20 73 79 6d  62 6f 6c 2c 0a 09 09 09   bol: symbol,....
15dd0	09 56 61 6c 75 65 3a 20  20 76 61 6c 75 65 2c 0a   .Value:  value,.
15de0	09 09 09 09 57 65 69 67  68 74 3a 20 30 2e 30 2c   ....Weight: 0.0,
15df0	20 2f 2f 20 e7 a8 8d e5  90 8e e8 ae a1 e7 ae 97    // ............
15e00	0a 09 09 09 7d 29 0a 09  09 09 74 6f 74 61 6c 56   ....})....totalV
15e10	61 6c 75 65 20 2b 3d 20  76 61 6c 75 65 0a 09 09   alue += value...
15e20	7d 0a 09 7d 0a 0a 09 69  66 20 74 6f 74 61 6c 56   }..}...if totalV
15e30	61 6c 75 65 20 3d 3d 20  30 20 7c 7c 20 6c 65 6e   alue == 0 || len
15e40	28 70 6f 73 69 74 69 6f  6e 73 29 20 3d 3d 20 30   (positions) == 0
15e50	20 7b 0a 09 09 72 65 74  75 72 6e 20 6d 65 74 72    {...return metr
15e60	69 63 73 0a 09 7d 0a 0a  09 2f 2f 20 e8 ae a1 e7   ics..}...// ....
15e70	ae 97 e6 9d 83 e9 87 8d  0a 09 66 6f 72 20 69 20   ..........for i 
15e80	3a 3d 20 72 61 6e 67 65  20 70 6f 73 69 74 69 6f   := range positio
15e90	6e 73 20 7b 0a 09 09 70  6f 73 69 74 69 6f 6e 73   ns {...positions
15ea0	5b 69 5d 2e 57 65 69 67  68 74 20 3d 20 70 6f 73   [i].Weight = pos
15eb0	69 74 69 6f 6e 73 5b 69  5d 2e 56 61 6c 75 65 20   itions[i].Value 
15ec0	2f 20 74 6f 74 61 6c 56  61 6c 75 65 0a 09 7d 0a   / totalValue..}.
15ed0	0a 09 2f 2f 20 e8 ae a1  e7 ae 97 e6 8a 95 e8 b5   ..// ...........
15ee0	84 e7 bb 84 e5 90 88 e7  9b b8 e5 85 b3 e6 80 a7   ................
15ef0	e9 a3 8e e9 99 a9 0a 09  70 6f 72 74 66 6f 6c 69   ........portfoli
15f00	6f 43 6f 72 72 52 69 73  6b 20 3a 3d 20 30 2e 30   oCorrRisk := 0.0
15f10	0a 09 66 6f 72 20 69 20  3a 3d 20 30 3b 20 69 20   ..for i := 0; i 
15f20	3c 20 6c 65 6e 28 70 6f  73 69 74 69 6f 6e 73 29   < len(positions)
15f30	3b 20 69 2b 2b 20 7b 0a  09 09 66 6f 72 20 6a 20   ; i++ {...for j 
15f40	3a 3d 20 69 20 2b 20 31  3b 20 6a 20 3c 20 6c 65   := i + 1; j < le
15f50	6e 28 70 6f 73 69 74 69  6f 6e 73 29 3b 20 6a 2b   n(positions); j+
15f60	2b 20 7b 0a 09 09 09 73  79 6d 62 6f 6c 31 20 3a   + {....symbol1 :
15f70	3d 20 70 6f 73 69 74 69  6f 6e 73 5b 69 5d 2e 53   = positions[i].S
15f80	79 6d 62 6f 6c 0a 09 09  09 73 79 6d 62 6f 6c 32   ymbol....symbol2
15f90	20 3a 3d 20 70 6f 73 69  74 69 6f 6e 73 5b 6a 5d    := positions[j]
15fa0	2e 53 79 6d 62 6f 6c 0a  09 09 09 69 66 20 63 6f   .Symbol....if co
15fb0	72 72 2c 20 65 78 69 73  74 73 20 3a 3d 20 63 6f   rr, exists := co
15fc0	72 72 65 6c 61 74 69 6f  6e 4d 61 74 72 69 78 5b   rrelationMatrix[
15fd0	73 79 6d 62 6f 6c 31 5d  5b 73 79 6d 62 6f 6c 32   symbol1][symbol2
15fe0	5d 3b 20 65 78 69 73 74  73 20 7b 0a 09 09 09 09   ]; exists {.....
15ff0	77 65 69 67 68 74 50 72  6f 64 75 63 74 20 3a 3d   weightProduct :=
16000	20 70 6f 73 69 74 69 6f  6e 73 5b 69 5d 2e 57 65    positions[i].We
16010	69 67 68 74 20 2a 20 70  6f 73 69 74 69 6f 6e 73   ight * positions
16020	5b 6a 5d 2e 57 65 69 67  68 74 0a 09 09 09 09 70   [j].Weight.....p
16030	6f 72 74 66 6f 6c 69 6f  43 6f 72 72 52 69 73 6b   ortfolioCorrRisk
16040	20 2b 3d 20 77 65 69 67  68 74 50 72 6f 64 75 63    += weightProduc
16050	74 20 2a 20 63 6f 72 72  20 2a 20 63 6f 72 72 20   t * corr * corr 
16060	2f 2f 20 e7 9b b8 e5 85  b3 e6 80 a7 e8 b4 a1 e7   // .............
16070	8c ae 0a 09 09 09 7d 0a  09 09 7d 0a 09 7d 0a 09   ......}...}..}..
16080	6d 65 74 72 69 63 73 2e  50 6f 72 74 66 6f 6c 69   metrics.Portfoli
16090	6f 43 6f 72 72 65 6c 61  74 69 6f 6e 52 69 73 6b   oCorrelationRisk
160a0	20 3d 20 70 6f 72 74 66  6f 6c 69 6f 43 6f 72 72    = portfolioCorr
160b0	52 69 73 6b 0a 0a 09 2f  2f 20 e8 ae a1 e7 ae 97   Risk...// ......
160c0	e9 9b 86 e4 b8 ad e9 a3  8e e9 99 a9 ef bc 88 e5   ................
160d0	9f ba e4 ba 8e e6 9c 80  e5 a4 a7 e6 8c 81 e4 bb   ................
160e0	93 e6 9d 83 e9 87 8d ef  bc 89 0a 09 6d 61 78 57   ............maxW
160f0	65 69 67 68 74 20 3a 3d  20 30 2e 30 0a 09 66 6f   eight := 0.0..fo
16100	72 20 5f 2c 20 70 6f 73  20 3a 3d 20 72 61 6e 67   r _, pos := rang
16110	65 20 70 6f 73 69 74 69  6f 6e 73 20 7b 0a 09 09   e positions {...
16120	69 66 20 70 6f 73 2e 57  65 69 67 68 74 20 3e 20   if pos.Weight > 
16130	6d 61 78 57 65 69 67 68  74 20 7b 0a 09 09 09 6d   maxWeight {....m
16140	61 78 57 65 69 67 68 74  20 3d 20 70 6f 73 2e 57   axWeight = pos.W
16150	65 69 67 68 74 0a 09 09  7d 0a 09 7d 0a 09 6d 65   eight...}..}..me
16160	74 72 69 63 73 2e 43 6f  6e 63 65 6e 74 72 61 74   trics.Concentrat
16170	69 6f 6e 52 69 73 6b 20  3d 20 6d 61 78 57 65 69   ionRisk = maxWei
16180	67 68 74 0a 0a 09 2f 2f  20 e8 ae a1 e7 ae 97 e5   ght...// .......
16190	a4 9a e6 a0 b7 e5 8c 96  e6 94 b6 e7 9b 8a 0a 09   ................
161a0	61 76 67 50 61 69 72 77  69 73 65 43 6f 72 72 20   avgPairwiseCorr 
161b0	3a 3d 20 30 2e 30 0a 09  70 61 69 72 43 6f 75 6e   := 0.0..pairCoun
161c0	74 20 3a 3d 20 30 0a 09  66 6f 72 20 69 20 3a 3d   t := 0..for i :=
161d0	20 30 3b 20 69 20 3c 20  6c 65 6e 28 70 6f 73 69    0; i < len(posi
161e0	74 69 6f 6e 73 29 3b 20  69 2b 2b 20 7b 0a 09 09   tions); i++ {...
161f0	66 6f 72 20 6a 20 3a 3d  20 69 20 2b 20 31 3b 20   for j := i + 1; 
16200	6a 20 3c 20 6c 65 6e 28  70 6f 73 69 74 69 6f 6e   j < len(position
16210	73 29 3b 20 6a 2b 2b 20  7b 0a 09 09 09 73 79 6d   s); j++ {....sym
16220	62 6f 6c 31 20 3a 3d 20  70 6f 73 69 74 69 6f 6e   bol1 := position
16230	73 5b 69 5d 2e 53 79 6d  62 6f 6c 0a 09 09 09 73   s[i].Symbol....s
16240	79 6d 62 6f 6c 32 20 3a  3d 20 70 6f 73 69 74 69   ymbol2 := positi
16250	6f 6e 73 5b 6a 5d 2e 53  79 6d 62 6f 6c 0a 09 09   ons[j].Symbol...
16260	09 69 66 20 63 6f 72 72  2c 20 65 78 69 73 74 73   .if corr, exists
16270	20 3a 3d 20 63 6f 72 72  65 6c 61 74 69 6f 6e 4d    := correlationM
16280	61 74 72 69 78 5b 73 79  6d 62 6f 6c 31 5d 5b 73   atrix[symbol1][s
16290	79 6d 62 6f 6c 32 5d 3b  20 65 78 69 73 74 73 20   ymbol2]; exists 
162a0	7b 0a 09 09 09 09 61 76  67 50 61 69 72 77 69 73   {.....avgPairwis
162b0	65 43 6f 72 72 20 2b 3d  20 6d 61 74 68 2e 41 62   eCorr += math.Ab
162c0	73 28 63 6f 72 72 29 0a  09 09 09 09 70 61 69 72   s(corr).....pair
162d0	43 6f 75 6e 74 2b 2b 0a  09 09 09 7d 0a 09 09 7d   Count++....}...}
162e0	0a 09 7d 0a 0a 09 69 66  20 70 61 69 72 43 6f 75   ..}...if pairCou
162f0	6e 74 20 3e 20 30 20 7b  0a 09 09 61 76 67 50 61   nt > 0 {...avgPa
16300	69 72 77 69 73 65 43 6f  72 72 20 2f 3d 20 66 6c   irwiseCorr /= fl
16310	6f 61 74 36 34 28 70 61  69 72 43 6f 75 6e 74 29   oat64(pairCount)
16320	0a 09 09 6d 65 74 72 69  63 73 2e 44 69 76 65 72   ...metrics.Diver
16330	73 69 66 69 63 61 74 69  6f 6e 42 65 6e 65 66 69   sificationBenefi
16340	74 20 3d 20 31 2e 30 20  2d 20 61 76 67 50 61 69   t = 1.0 - avgPai
16350	72 77 69 73 65 43 6f 72  72 0a 09 7d 0a 0a 09 2f   rwiseCorr..}.../
16360	2f 20 e8 ae a1 e7 ae 97  e7 b3 bb e7 bb 9f e6 80   / ..............
16370	a7 e9 a3 8e e9 99 a9 ef  bc 88 e5 9f ba e4 ba 8e   ................
16380	e5 b8 82 e5 9c ba e6 95  b4 e4 bd 93 e7 9b b8 e5   ................
16390	85 b3 e6 80 a7 ef bc 89  0a 09 73 79 73 74 65 6d   ..........system
163a0	69 63 43 6f 72 72 53 75  6d 20 3a 3d 20 30 2e 30   icCorrSum := 0.0
163b0	0a 09 73 79 73 74 65 6d  69 63 43 6f 72 72 43 6f   ..systemicCorrCo
163c0	75 6e 74 20 3a 3d 20 30  0a 0a 09 66 6f 72 20 5f   unt := 0...for _
163d0	2c 20 63 6f 72 72 65 6c  61 74 69 6f 6e 73 20 3a   , correlations :
163e0	3d 20 72 61 6e 67 65 20  63 6f 72 72 65 6c 61 74   = range correlat
163f0	69 6f 6e 4d 61 74 72 69  78 20 7b 0a 09 09 66 6f   ionMatrix {...fo
16400	72 20 5f 2c 20 63 6f 72  72 20 3a 3d 20 72 61 6e   r _, corr := ran
16410	67 65 20 63 6f 72 72 65  6c 61 74 69 6f 6e 73 20   ge correlations 
16420	7b 0a 09 09 09 69 66 20  63 6f 72 72 20 3c 20 31   {....if corr < 1
16430	2e 30 20 7b 20 2f 2f 20  e6 8e 92 e9 99 a4 e8 87   .0 { // ........
16440	aa e7 9b b8 e5 85 b3 0a  09 09 09 09 73 79 73 74   ............syst
16450	65 6d 69 63 43 6f 72 72  53 75 6d 20 2b 3d 20 6d   emicCorrSum += m
16460	61 74 68 2e 41 62 73 28  63 6f 72 72 29 0a 09 09   ath.Abs(corr)...
16470	09 09 73 79 73 74 65 6d  69 63 43 6f 72 72 43 6f   ..systemicCorrCo
16480	75 6e 74 2b 2b 0a 09 09  09 7d 0a 09 09 7d 0a 09   unt++....}...}..
16490	7d 0a 0a 09 69 66 20 73  79 73 74 65 6d 69 63 43   }...if systemicC
164a0	6f 72 72 43 6f 75 6e 74  20 3e 20 30 20 7b 0a 09   orrCount > 0 {..
164b0	09 6d 65 74 72 69 63 73  2e 53 79 73 74 65 6d 69   .metrics.Systemi
164c0	63 52 69 73 6b 20 3d 20  73 79 73 74 65 6d 69 63   cRisk = systemic
164d0	43 6f 72 72 53 75 6d 20  2f 20 66 6c 6f 61 74 36   CorrSum / float6
164e0	34 28 73 79 73 74 65 6d  69 63 43 6f 72 72 43 6f   4(systemicCorrCo
164f0	75 6e 74 29 0a 09 7d 0a  0a 09 6c 6f 67 2e 50 72   unt)..}...log.Pr
16500	69 6e 74 66 28 22 5b 43  4f 52 52 45 4c 41 54 49   intf("[CORRELATI
16510	4f 4e 5f 52 49 53 4b 5d  20 e6 8a 95 e8 b5 84 e7   ON_RISK] .......
16520	bb 84 e5 90 88 e7 9b b8  e5 85 b3 e6 80 a7 e9 a3   ................
16530	8e e9 99 a9 3a 20 25 2e  33 66 2c 20 e9 9b 86 e4   ....: %.3f, ....
16540	b8 ad e9 a3 8e e9 99 a9  3a 20 25 2e 33 66 2c 20   ........: %.3f, 
16550	e5 a4 9a e6 a0 b7 e5 8c  96 e6 94 b6 e7 9b 8a 3a   ...............:
16560	20 25 2e 33 66 2c 20 e7  b3 bb e7 bb 9f e6 80 a7    %.3f, .........
16570	e9 a3 8e e9 99 a9 3a 20  25 2e 33 66 22 2c 0a 09   ......: %.3f",..
16580	09 6d 65 74 72 69 63 73  2e 50 6f 72 74 66 6f 6c   .metrics.Portfol
16590	69 6f 43 6f 72 72 65 6c  61 74 69 6f 6e 52 69 73   ioCorrelationRis
165a0	6b 2c 20 6d 65 74 72 69  63 73 2e 43 6f 6e 63 65   k, metrics.Conce
165b0	6e 74 72 61 74 69 6f 6e  52 69 73 6b 2c 20 6d 65   ntrationRisk, me
165c0	74 72 69 63 73 2e 44 69  76 65 72 73 69 66 69 63   trics.Diversific
165d0	61 74 69 6f 6e 42 65 6e  65 66 69 74 2c 20 6d 65   ationBenefit, me
165e0	74 72 69 63 73 2e 53 79  73 74 65 6d 69 63 52 69   trics.SystemicRi
165f0	73 6b 29 0a 0a 09 72 65  74 75 72 6e 20 6d 65 74   sk)...return met
16600	72 69 63 73 0a 7d 0a 0a  2f 2f 20 6f 70 74 69 6d   rics.}..// optim
16610	69 7a 65 50 6f 72 74 66  6f 6c 69 6f 57 65 69 67   izePortfolioWeig
16620	68 74 73 20 e5 9f ba e4  ba 8e e7 9b b8 e5 85 b3   hts ............
16630	e6 80 a7 e4 bc 98 e5 8c  96 e6 8a 95 e8 b5 84 e7   ................
16640	bb 84 e5 90 88 e6 9d 83  e9 87 8d 0a 66 75 6e 63   ............func
16650	20 28 62 65 20 2a 42 61  63 6b 74 65 73 74 45 6e    (be *BacktestEn
16660	67 69 6e 65 29 20 6f 70  74 69 6d 69 7a 65 50 6f   gine) optimizePo
16670	72 74 66 6f 6c 69 6f 57  65 69 67 68 74 73 28 6f   rtfolioWeights(o
16680	70 70 6f 72 74 75 6e 69  74 69 65 73 20 5b 5d 2a   pportunities []*
16690	53 79 6d 62 6f 6c 4f 70  70 6f 72 74 75 6e 69 74   SymbolOpportunit
166a0	79 2c 20 63 6f 72 72 65  6c 61 74 69 6f 6e 4d 61   y, correlationMa
166b0	74 72 69 78 20 6d 61 70  5b 73 74 72 69 6e 67 5d   trix map[string]
166c0	6d 61 70 5b 73 74 72 69  6e 67 5d 66 6c 6f 61 74   map[string]float
166d0	36 34 2c 20 74 6f 74 61  6c 43 61 70 69 74 61 6c   64, totalCapital
166e0	20 66 6c 6f 61 74 36 34  29 20 6d 61 70 5b 73 74    float64) map[st
166f0	72 69 6e 67 5d 66 6c 6f  61 74 36 34 20 7b 0a 09   ring]float64 {..
16700	6f 70 74 69 6d 69 7a 65  64 57 65 69 67 68 74 73   optimizedWeights
16710	20 3a 3d 20 6d 61 6b 65  28 6d 61 70 5b 73 74 72    := make(map[str
16720	69 6e 67 5d 66 6c 6f 61  74 36 34 29 0a 0a 09 69   ing]float64)...i
16730	66 20 6c 65 6e 28 6f 70  70 6f 72 74 75 6e 69 74   f len(opportunit
16740	69 65 73 29 20 3d 3d 20  30 20 7b 0a 09 09 72 65   ies) == 0 {...re
16750	74 75 72 6e 20 6f 70 74  69 6d 69 7a 65 64 57 65   turn optimizedWe
16760	69 67 68 74 73 0a 09 7d  0a 0a 09 2f 2f 20 e4 bd   ights..}...// ..
16770	bf e7 94 a8 e9 a3 8e e9  99 a9 e5 b9 b3 e4 bb b7   ................
16780	e6 96 b9 e6 b3 95 e4 bc  98 e5 8c 96 e6 9d 83 e9   ................
16790	87 8d 0a 09 2f 2f 20 e7  9b ae e6 a0 87 ef bc 9a   ....// .........
167a0	e6 af 8f e4 b8 aa e8 b5  84 e4 ba a7 e5 af b9 e6   ................
167b0	8a 95 e8 b5 84 e7 bb 84  e5 90 88 e9 a3 8e e9 99   ................
167c0	a9 e7 9a 84 e8 b4 a1 e7  8c ae e7 9b b8 e7 ad 89   ................
167d0	0a 0a 09 2f 2f 20 e8 ae  a1 e7 ae 97 e7 9b ae e6   ...// ..........
167e0	a0 87 e6 9d 83 e9 87 8d  ef bc 88 e5 9f ba e4 ba   ................
167f0	8e e6 9c ba e4 bc 9a e8  af 84 e5 88 86 e5 92 8c   ................
16800	e9 a3 8e e9 99 a9 e8 b0  83 e6 95 b4 ef bc 89 0a   ................
16810	09 76 61 72 20 76 61 6c  69 64 4f 70 70 6f 72 74   .var validOpport
16820	75 6e 69 74 69 65 73 20  5b 5d 2a 53 79 6d 62 6f   unities []*Symbo
16830	6c 4f 70 70 6f 72 74 75  6e 69 74 79 0a 09 66 6f   lOpportunity..fo
16840	72 20 5f 2c 20 6f 70 70  20 3a 3d 20 72 61 6e 67   r _, opp := rang
16850	65 20 6f 70 70 6f 72 74  75 6e 69 74 69 65 73 20   e opportunities 
16860	7b 0a 09 09 69 66 20 6f  70 70 2e 53 63 6f 72 65   {...if opp.Score
16870	20 3e 20 30 2e 32 20 7b  20 2f 2f 20 e5 8f aa e8    > 0.2 { // ....
16880	80 83 e8 99 91 e6 9c 89  e8 b6 b3 e5 a4 9f e5 90   ................
16890	b8 e5 bc 95 e5 8a 9b e7  9a 84 e6 9c ba e4 bc 9a   ................
168a0	0a 09 09 09 76 61 6c 69  64 4f 70 70 6f 72 74 75   ....validOpportu
168b0	6e 69 74 69 65 73 20 3d  20 61 70 70 65 6e 64 28   nities = append(
168c0	76 61 6c 69 64 4f 70 70  6f 72 74 75 6e 69 74 69   validOpportuniti
168d0	65 73 2c 20 6f 70 70 29  0a 09 09 7d 0a 09 7d 0a   es, opp)...}..}.
168e0	0a 09 69 66 20 6c 65 6e  28 76 61 6c 69 64 4f 70   ..if len(validOp
168f0	70 6f 72 74 75 6e 69 74  69 65 73 29 20 3d 3d 20   portunities) == 
16900	30 20 7b 0a 09 09 72 65  74 75 72 6e 20 6f 70 74   0 {...return opt
16910	69 6d 69 7a 65 64 57 65  69 67 68 74 73 0a 09 7d   imizedWeights..}
16920	0a 0a 09 2f 2f 20 e5 9f  ba e4 ba 8e e8 af 84 e5   ...// ..........
16930	88 86 e8 ae a1 e7 ae 97  e5 9f ba e7 a1 80 e6 9d   ................
16940	83 e9 87 8d 0a 09 74 6f  74 61 6c 53 63 6f 72 65   ......totalScore
16950	20 3a 3d 20 30 2e 30 0a  09 66 6f 72 20 5f 2c 20    := 0.0..for _, 
16960	6f 70 70 20 3a 3d 20 72  61 6e 67 65 20 76 61 6c   opp := range val
16970	69 64 4f 70 70 6f 72 74  75 6e 69 74 69 65 73 20   idOpportunities 
16980	7b 0a 09 09 74 6f 74 61  6c 53 63 6f 72 65 20 2b   {...totalScore +
16990	3d 20 6f 70 70 2e 53 63  6f 72 65 0a 09 7d 0a 0a   = opp.Score..}..
169a0	09 2f 2f 20 e8 ae a1 e7  ae 97 e5 88 9d e5 a7 8b   .// ............
169b0	e6 9d 83 e9 87 8d 0a 09  62 61 73 65 57 65 69 67   ........baseWeig
169c0	68 74 73 20 3a 3d 20 6d  61 6b 65 28 6d 61 70 5b   hts := make(map[
169d0	73 74 72 69 6e 67 5d 66  6c 6f 61 74 36 34 29 0a   string]float64).
169e0	09 66 6f 72 20 5f 2c 20  6f 70 70 20 3a 3d 20 72   .for _, opp := r
169f0	61 6e 67 65 20 76 61 6c  69 64 4f 70 70 6f 72 74   ange validOpport
16a00	75 6e 69 74 69 65 73 20  7b 0a 09 09 62 61 73 65   unities {...base
16a10	57 65 69 67 68 74 73 5b  6f 70 70 2e 53 79 6d 62   Weights[opp.Symb
16a20	6f 6c 5d 20 3d 20 6f 70  70 2e 53 63 6f 72 65 20   ol] = opp.Score 
16a30	2f 20 74 6f 74 61 6c 53  63 6f 72 65 0a 09 7d 0a   / totalScore..}.
16a40	0a 09 2f 2f 20 e5 ba 94  e7 94 a8 e7 9b b8 e5 85   ..// ...........
16a50	b3 e6 80 a7 e8 b0 83 e6  95 b4 0a 09 61 64 6a 75   ............adju
16a60	73 74 65 64 57 65 69 67  68 74 73 20 3a 3d 20 62   stedWeights := b
16a70	65 2e 61 64 6a 75 73 74  57 65 69 67 68 74 73 46   e.adjustWeightsF
16a80	6f 72 43 6f 72 72 65 6c  61 74 69 6f 6e 28 62 61   orCorrelation(ba
16a90	73 65 57 65 69 67 68 74  73 2c 20 63 6f 72 72 65   seWeights, corre
16aa0	6c 61 74 69 6f 6e 4d 61  74 72 69 78 2c 20 76 61   lationMatrix, va
16ab0	6c 69 64 4f 70 70 6f 72  74 75 6e 69 74 69 65 73   lidOpportunities
16ac0	29 0a 0a 09 2f 2f 20 e8  bd ac e6 8d a2 e4 b8 ba   )...// .........
16ad0	e5 ae 9e e9 99 85 e8 b5  84 e9 87 91 e5 88 86 e9   ................
16ae0	85 8d 0a 09 66 6f 72 20  73 79 6d 62 6f 6c 2c 20   ....for symbol, 
16af0	77 65 69 67 68 74 20 3a  3d 20 72 61 6e 67 65 20   weight := range 
16b00	61 64 6a 75 73 74 65 64  57 65 69 67 68 74 73 20   adjustedWeights 
16b10	7b 0a 09 09 6f 70 74 69  6d 69 7a 65 64 57 65 69   {...optimizedWei
16b20	67 68 74 73 5b 73 79 6d  62 6f 6c 5d 20 3d 20 77   ghts[symbol] = w
16b30	65 69 67 68 74 20 2a 20  74 6f 74 61 6c 43 61 70   eight * totalCap
16b40	69 74 61 6c 0a 09 7d 0a  0a 09 6c 6f 67 2e 50 72   ital..}...log.Pr
16b50	69 6e 74 66 28 22 5b 50  4f 52 54 46 4f 4c 49 4f   intf("[PORTFOLIO
16b60	5f 4f 50 54 49 4d 49 5a  41 54 49 4f 4e 5d 20 e4   _OPTIMIZATION] .
16b70	bc 98 e5 8c 96 e4 ba 86  25 64 e4 b8 aa e5 b8 81   ........%d......
16b80	e7 a7 8d e7 9a 84 e6 9d  83 e9 87 8d e5 88 86 e9   ................
16b90	85 8d 22 2c 20 6c 65 6e  28 6f 70 74 69 6d 69 7a   ..", len(optimiz
16ba0	65 64 57 65 69 67 68 74  73 29 29 0a 0a 09 72 65   edWeights))...re
16bb0	74 75 72 6e 20 6f 70 74  69 6d 69 7a 65 64 57 65   turn optimizedWe
16bc0	69 67 68 74 73 0a 7d 0a  0a 2f 2f 20 61 64 6a 75   ights.}..// adju
16bd0	73 74 57 65 69 67 68 74  73 46 6f 72 43 6f 72 72   stWeightsForCorr
16be0	65 6c 61 74 69 6f 6e 20  e5 9f ba e4 ba 8e e7 9b   elation ........
16bf0	b8 e5 85 b3 e6 80 a7 e8  b0 83 e6 95 b4 e6 9d 83   ................
16c00	e9 87 8d 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
16c10	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 61 64   cktestEngine) ad
16c20	6a 75 73 74 57 65 69 67  68 74 73 46 6f 72 43 6f   justWeightsForCo
16c30	72 72 65 6c 61 74 69 6f  6e 28 62 61 73 65 57 65   rrelation(baseWe
16c40	69 67 68 74 73 20 6d 61  70 5b 73 74 72 69 6e 67   ights map[string
16c50	5d 66 6c 6f 61 74 36 34  2c 20 63 6f 72 72 65 6c   ]float64, correl
16c60	61 74 69 6f 6e 4d 61 74  72 69 78 20 6d 61 70 5b   ationMatrix map[
16c70	73 74 72 69 6e 67 5d 6d  61 70 5b 73 74 72 69 6e   string]map[strin
16c80	67 5d 66 6c 6f 61 74 36  34 2c 20 6f 70 70 6f 72   g]float64, oppor
16c90	74 75 6e 69 74 69 65 73  20 5b 5d 2a 53 79 6d 62   tunities []*Symb
16ca0	6f 6c 4f 70 70 6f 72 74  75 6e 69 74 79 29 20 6d   olOpportunity) m
16cb0	61 70 5b 73 74 72 69 6e  67 5d 66 6c 6f 61 74 36   ap[string]float6
16cc0	34 20 7b 0a 09 61 64 6a  75 73 74 65 64 57 65 69   4 {..adjustedWei
16cd0	67 68 74 73 20 3a 3d 20  6d 61 6b 65 28 6d 61 70   ghts := make(map
16ce0	5b 73 74 72 69 6e 67 5d  66 6c 6f 61 74 36 34 29   [string]float64)
16cf0	0a 0a 09 2f 2f 20 e9 a3  8e e9 99 a9 e5 b9 b3 e4   ...// ..........
16d00	bb b7 e8 b0 83 e6 95 b4  ef bc 9a e9 99 8d e4 bd   ................
16d10	8e e9 ab 98 e7 9b b8 e5  85 b3 e8 b5 84 e4 ba a7   ................
16d20	e7 9a 84 e6 9d 83 e9 87  8d 0a 09 72 69 73 6b 43   ...........riskC
16d30	6f 6e 74 72 69 62 75 74  69 6f 6e 73 20 3a 3d 20   ontributions := 
16d40	6d 61 6b 65 28 6d 61 70  5b 73 74 72 69 6e 67 5d   make(map[string]
16d50	66 6c 6f 61 74 36 34 29  0a 0a 09 66 6f 72 20 73   float64)...for s
16d60	79 6d 62 6f 6c 31 20 3a  3d 20 72 61 6e 67 65 20   ymbol1 := range 
16d70	62 61 73 65 57 65 69 67  68 74 73 20 7b 0a 09 09   baseWeights {...
16d80	72 69 73 6b 43 6f 6e 74  72 69 62 75 74 69 6f 6e   riskContribution
16d90	20 3a 3d 20 30 2e 30 0a  09 09 66 6f 72 20 73 79    := 0.0...for sy
16da0	6d 62 6f 6c 32 20 3a 3d  20 72 61 6e 67 65 20 62   mbol2 := range b
16db0	61 73 65 57 65 69 67 68  74 73 20 7b 0a 09 09 09   aseWeights {....
16dc0	69 66 20 73 79 6d 62 6f  6c 31 20 3d 3d 20 73 79   if symbol1 == sy
16dd0	6d 62 6f 6c 32 20 7b 0a  09 09 09 09 63 6f 6e 74   mbol2 {.....cont
16de0	69 6e 75 65 0a 09 09 09  7d 0a 09 09 09 69 66 20   inue....}....if 
16df0	63 6f 72 72 2c 20 65 78  69 73 74 73 20 3a 3d 20   corr, exists := 
16e00	63 6f 72 72 65 6c 61 74  69 6f 6e 4d 61 74 72 69   correlationMatri
16e10	78 5b 73 79 6d 62 6f 6c  31 5d 5b 73 79 6d 62 6f   x[symbol1][symbo
16e20	6c 32 5d 3b 20 65 78 69  73 74 73 20 7b 0a 09 09   l2]; exists {...
16e30	09 09 77 65 69 67 68 74  50 72 6f 64 75 63 74 20   ..weightProduct 
16e40	3a 3d 20 62 61 73 65 57  65 69 67 68 74 73 5b 73   := baseWeights[s
16e50	79 6d 62 6f 6c 31 5d 20  2a 20 62 61 73 65 57 65   ymbol1] * baseWe
16e60	69 67 68 74 73 5b 73 79  6d 62 6f 6c 32 5d 0a 09   ights[symbol2]..
16e70	09 09 09 72 69 73 6b 43  6f 6e 74 72 69 62 75 74   ...riskContribut
16e80	69 6f 6e 20 2b 3d 20 77  65 69 67 68 74 50 72 6f   ion += weightPro
16e90	64 75 63 74 20 2a 20 63  6f 72 72 20 2a 20 63 6f   duct * corr * co
16ea0	72 72 0a 09 09 09 7d 0a  09 09 7d 0a 09 09 72 69   rr....}...}...ri
16eb0	73 6b 43 6f 6e 74 72 69  62 75 74 69 6f 6e 73 5b   skContributions[
16ec0	73 79 6d 62 6f 6c 31 5d  20 3d 20 72 69 73 6b 43   symbol1] = riskC
16ed0	6f 6e 74 72 69 62 75 74  69 6f 6e 0a 09 7d 0a 0a   ontribution..}..
16ee0	09 2f 2f 20 e5 bd 92 e4  b8 80 e5 8c 96 e9 a3 8e   .// ............
16ef0	e9 99 a9 e8 b4 a1 e7 8c  ae e5 b9 b6 e8 b0 83 e6   ................
16f00	95 b4 e6 9d 83 e9 87 8d  0a 09 74 6f 74 61 6c 52   ..........totalR
16f10	69 73 6b 43 6f 6e 74 72  69 62 75 74 69 6f 6e 20   iskContribution 
16f20	3a 3d 20 30 2e 30 0a 09  66 6f 72 20 5f 2c 20 72   := 0.0..for _, r
16f30	69 73 6b 20 3a 3d 20 72  61 6e 67 65 20 72 69 73   isk := range ris
16f40	6b 43 6f 6e 74 72 69 62  75 74 69 6f 6e 73 20 7b   kContributions {
16f50	0a 09 09 74 6f 74 61 6c  52 69 73 6b 43 6f 6e 74   ...totalRiskCont
16f60	72 69 62 75 74 69 6f 6e  20 2b 3d 20 72 69 73 6b   ribution += risk
16f70	0a 09 7d 0a 0a 09 69 66  20 74 6f 74 61 6c 52 69   ..}...if totalRi
16f80	73 6b 43 6f 6e 74 72 69  62 75 74 69 6f 6e 20 3e   skContribution >
16f90	20 30 20 7b 0a 09 09 74  61 72 67 65 74 52 69 73    0 {...targetRis
16fa0	6b 50 65 72 41 73 73 65  74 20 3a 3d 20 74 6f 74   kPerAsset := tot
16fb0	61 6c 52 69 73 6b 43 6f  6e 74 72 69 62 75 74 69   alRiskContributi
16fc0	6f 6e 20 2f 20 66 6c 6f  61 74 36 34 28 6c 65 6e   on / float64(len
16fd0	28 72 69 73 6b 43 6f 6e  74 72 69 62 75 74 69 6f   (riskContributio
16fe0	6e 73 29 29 0a 0a 09 09  66 6f 72 20 73 79 6d 62   ns))....for symb
16ff0	6f 6c 2c 20 63 75 72 72  65 6e 74 52 69 73 6b 20   ol, currentRisk 
17000	3a 3d 20 72 61 6e 67 65  20 72 69 73 6b 43 6f 6e   := range riskCon
17010	74 72 69 62 75 74 69 6f  6e 73 20 7b 0a 09 09 09   tributions {....
17020	69 66 20 63 75 72 72 65  6e 74 52 69 73 6b 20 3e   if currentRisk >
17030	20 74 61 72 67 65 74 52  69 73 6b 50 65 72 41 73    targetRiskPerAs
17040	73 65 74 20 7b 0a 09 09  09 09 2f 2f 20 e9 a3 8e   set {.....// ...
17050	e9 99 a9 e8 bf 87 e9 ab  98 ef bc 8c e9 99 8d e4   ................
17060	bd 8e e6 9d 83 e9 87 8d  0a 09 09 09 09 72 65 64   .............red
17070	75 63 74 69 6f 6e 46 61  63 74 6f 72 20 3a 3d 20   uctionFactor := 
17080	74 61 72 67 65 74 52 69  73 6b 50 65 72 41 73 73   targetRiskPerAss
17090	65 74 20 2f 20 63 75 72  72 65 6e 74 52 69 73 6b   et / currentRisk
170a0	0a 09 09 09 09 61 64 6a  75 73 74 65 64 57 65 69   .....adjustedWei
170b0	67 68 74 73 5b 73 79 6d  62 6f 6c 5d 20 3d 20 62   ghts[symbol] = b
170c0	61 73 65 57 65 69 67 68  74 73 5b 73 79 6d 62 6f   aseWeights[symbo
170d0	6c 5d 20 2a 20 72 65 64  75 63 74 69 6f 6e 46 61   l] * reductionFa
170e0	63 74 6f 72 0a 09 09 09  7d 20 65 6c 73 65 20 7b   ctor....} else {
170f0	0a 09 09 09 09 2f 2f 20  e9 a3 8e e9 99 a9 e5 81   .....// ........
17100	8f e4 bd 8e ef bc 8c e5  8f af e4 bb a5 e7 95 a5   ................
17110	e5 be ae e5 a2 9e e5 8a  a0 e6 9d 83 e9 87 8d 0a   ................
17120	09 09 09 09 69 6e 63 72  65 61 73 65 46 61 63 74   ....increaseFact
17130	6f 72 20 3a 3d 20 31 2e  30 20 2b 20 28 74 61 72   or := 1.0 + (tar
17140	67 65 74 52 69 73 6b 50  65 72 41 73 73 65 74 2d   getRiskPerAsset-
17150	63 75 72 72 65 6e 74 52  69 73 6b 29 2f 74 6f 74   currentRisk)/tot
17160	61 6c 52 69 73 6b 43 6f  6e 74 72 69 62 75 74 69   alRiskContributi
17170	6f 6e 0a 09 09 09 09 61  64 6a 75 73 74 65 64 57   on.....adjustedW
17180	65 69 67 68 74 73 5b 73  79 6d 62 6f 6c 5d 20 3d   eights[symbol] =
17190	20 62 61 73 65 57 65 69  67 68 74 73 5b 73 79 6d    baseWeights[sym
171a0	62 6f 6c 5d 20 2a 20 6d  61 74 68 2e 4d 69 6e 28   bol] * math.Min(
171b0	69 6e 63 72 65 61 73 65  46 61 63 74 6f 72 2c 20   increaseFactor, 
171c0	31 2e 35 29 0a 09 09 09  7d 0a 09 09 7d 0a 09 7d   1.5)....}...}..}
171d0	20 65 6c 73 65 20 7b 0a  09 09 2f 2f 20 e5 a6 82    else {...// ...
171e0	e6 9e 9c e6 b2 a1 e6 9c  89 e9 a3 8e e9 99 a9 e8   ................
171f0	b4 a1 e7 8c ae ef bc 8c  e4 bd bf e7 94 a8 e5 9f   ................
17200	ba e7 a1 80 e6 9d 83 e9  87 8d 0a 09 09 66 6f 72   .............for
17210	20 73 79 6d 62 6f 6c 2c  20 77 65 69 67 68 74 20    symbol, weight 
17220	3a 3d 20 72 61 6e 67 65  20 62 61 73 65 57 65 69   := range baseWei
17230	67 68 74 73 20 7b 0a 09  09 09 61 64 6a 75 73 74   ghts {....adjust
17240	65 64 57 65 69 67 68 74  73 5b 73 79 6d 62 6f 6c   edWeights[symbol
17250	5d 20 3d 20 77 65 69 67  68 74 0a 09 09 7d 0a 09   ] = weight...}..
17260	7d 0a 0a 09 2f 2f 20 e9  87 8d e6 96 b0 e5 bd 92   }...// .........
17270	e4 b8 80 e5 8c 96 0a 09  74 6f 74 61 6c 41 64 6a   ........totalAdj
17280	75 73 74 65 64 57 65 69  67 68 74 20 3a 3d 20 30   ustedWeight := 0
17290	2e 30 0a 09 66 6f 72 20  5f 2c 20 77 65 69 67 68   .0..for _, weigh
172a0	74 20 3a 3d 20 72 61 6e  67 65 20 61 64 6a 75 73   t := range adjus
172b0	74 65 64 57 65 69 67 68  74 73 20 7b 0a 09 09 74   tedWeights {...t
172c0	6f 74 61 6c 41 64 6a 75  73 74 65 64 57 65 69 67   otalAdjustedWeig
172d0	68 74 20 2b 3d 20 77 65  69 67 68 74 0a 09 7d 0a   ht += weight..}.
172e0	0a 09 69 66 20 74 6f 74  61 6c 41 64 6a 75 73 74   ..if totalAdjust
172f0	65 64 57 65 69 67 68 74  20 3e 20 30 20 7b 0a 09   edWeight > 0 {..
17300	09 66 6f 72 20 73 79 6d  62 6f 6c 20 3a 3d 20 72   .for symbol := r
17310	61 6e 67 65 20 61 64 6a  75 73 74 65 64 57 65 69   ange adjustedWei
17320	67 68 74 73 20 7b 0a 09  09 09 61 64 6a 75 73 74   ghts {....adjust
17330	65 64 57 65 69 67 68 74  73 5b 73 79 6d 62 6f 6c   edWeights[symbol
17340	5d 20 2f 3d 20 74 6f 74  61 6c 41 64 6a 75 73 74   ] /= totalAdjust
17350	65 64 57 65 69 67 68 74  0a 09 09 7d 0a 09 7d 0a   edWeight...}..}.
17360	0a 09 72 65 74 75 72 6e  20 61 64 6a 75 73 74 65   ..return adjuste
17370	64 57 65 69 67 68 74 73  0a 7d 0a 0a 2f 2f 20 64   dWeights.}..// d
17380	65 74 65 63 74 41 72 62  69 74 72 61 67 65 4f 70   etectArbitrageOp
17390	70 6f 72 74 75 6e 69 74  69 65 73 20 e6 a3 80 e6   portunities ....
173a0	b5 8b e5 a5 97 e5 88 a9  e6 9c ba e4 bc 9a 0a 66   ...............f
173b0	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
173c0	74 45 6e 67 69 6e 65 29  20 64 65 74 65 63 74 41   tEngine) detectA
173d0	72 62 69 74 72 61 67 65  4f 70 70 6f 72 74 75 6e   rbitrageOpportun
173e0	69 74 69 65 73 28 73 79  6d 62 6f 6c 53 74 61 74   ities(symbolStat
173f0	65 73 20 6d 61 70 5b 73  74 72 69 6e 67 5d 2a 53   es map[string]*S
17400	79 6d 62 6f 6c 53 74 61  74 65 2c 20 63 6f 72 72   ymbolState, corr
17410	65 6c 61 74 69 6f 6e 4d  61 74 72 69 78 20 6d 61   elationMatrix ma
17420	70 5b 73 74 72 69 6e 67  5d 6d 61 70 5b 73 74 72   p[string]map[str
17430	69 6e 67 5d 66 6c 6f 61  74 36 34 2c 20 63 75 72   ing]float64, cur
17440	72 65 6e 74 49 6e 64 65  78 20 69 6e 74 29 20 5b   rentIndex int) [
17450	5d 2a 41 72 62 69 74 72  61 67 65 4f 70 70 6f 72   ]*ArbitrageOppor
17460	74 75 6e 69 74 79 20 7b  0a 09 76 61 72 20 6f 70   tunity {..var op
17470	70 6f 72 74 75 6e 69 74  69 65 73 20 5b 5d 2a 41   portunities []*A
17480	72 62 69 74 72 61 67 65  4f 70 70 6f 72 74 75 6e   rbitrageOpportun
17490	69 74 79 0a 0a 09 2f 2f  20 3d 3d 3d 20 e7 86 8a   ity...// === ...
174a0	e5 b8 82 e7 8e af e5 a2  83 e6 a3 80 e6 b5 8b 20   ............... 
174b0	3d 3d 3d 0a 09 6d 61 72  6b 65 74 52 65 67 69 6d   ===..marketRegim
174c0	65 20 3a 3d 20 62 65 2e  64 65 74 65 72 6d 69 6e   e := be.determin
174d0	65 4d 75 6c 74 69 53 79  6d 62 6f 6c 4d 61 72 6b   eMultiSymbolMark
174e0	65 74 52 65 67 69 6d 65  28 73 79 6d 62 6f 6c 53   etRegime(symbolS
174f0	74 61 74 65 73 2c 20 63  75 72 72 65 6e 74 49 6e   tates, currentIn
17500	64 65 78 29 0a 09 69 73  42 65 61 72 4d 61 72 6b   dex)..isBearMark
17510	65 74 20 3a 3d 20 73 74  72 69 6e 67 73 2e 43 6f   et := strings.Co
17520	6e 74 61 69 6e 73 28 6d  61 72 6b 65 74 52 65 67   ntains(marketReg
17530	69 6d 65 2c 20 22 62 65  61 72 22 29 0a 0a 09 69   ime, "bear")...i
17540	66 20 69 73 42 65 61 72  4d 61 72 6b 65 74 20 7b   f isBearMarket {
17550	0a 09 09 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   ...log.Printf("[
17560	41 52 42 49 54 52 41 47  45 5f 46 49 4c 54 45 52   ARBITRAGE_FILTER
17570	5d 20 e7 86 8a e5 b8 82  e7 8e af e5 a2 83 28 25   ] ............(%
17580	73 29 ef bc 8c e5 a4 a7  e5 b9 85 e5 87 8f e5 b0   s)..............
17590	91 e5 a5 97 e5 88 a9 e6  9c ba e4 bc 9a e6 a3 80   ................
175a0	e6 b5 8b 22 2c 20 6d 61  72 6b 65 74 52 65 67 69   ...", marketRegi
175b0	6d 65 29 0a 09 7d 0a 0a  09 2f 2f 20 31 2e 20 e7   me)..}...// 1. .
175c0	bb 9f e8 ae a1 e5 a5 97  e5 88 a9 ef bc 9a e6 a3   ................
175d0	80 e6 b5 8b e4 bb b7 e6  a0 bc e4 b8 8e e7 bb 9f   ................
175e0	e8 ae a1 e5 9d 87 e5 80  bc e7 9a 84 e5 81 8f e7   ................
175f0	a6 bb 0a 09 73 74 61 74  41 72 62 4f 70 73 20 3a   ....statArbOps :
17600	3d 20 62 65 2e 64 65 74  65 63 74 53 74 61 74 69   = be.detectStati
17610	73 74 69 63 61 6c 41 72  62 69 74 72 61 67 65 28   sticalArbitrage(
17620	73 79 6d 62 6f 6c 53 74  61 74 65 73 2c 20 63 75   symbolStates, cu
17630	72 72 65 6e 74 49 6e 64  65 78 2c 20 69 73 42 65   rrentIndex, isBe
17640	61 72 4d 61 72 6b 65 74  29 0a 09 6f 70 70 6f 72   arMarket)..oppor
17650	74 75 6e 69 74 69 65 73  20 3d 20 61 70 70 65 6e   tunities = appen
17660	64 28 6f 70 70 6f 72 74  75 6e 69 74 69 65 73 2c   d(opportunities,
17670	20 73 74 61 74 41 72 62  4f 70 73 2e 2e 2e 29 0a    statArbOps...).
17680	0a 09 2f 2f 20 32 2e 20  e7 9b b8 e5 85 b3 e6 80   ..// 2. ........
17690	a7 e5 a5 97 e5 88 a9 ef  bc 9a e6 a3 80 e6 b5 8b   ................
176a0	e7 9b b8 e5 85 b3 e6 80  a7 e5 81 8f e7 a6 bb 0a   ................
176b0	09 63 6f 72 72 41 72 62  4f 70 73 20 3a 3d 20 62   .corrArbOps := b
176c0	65 2e 64 65 74 65 63 74  43 6f 72 72 65 6c 61 74   e.detectCorrelat
176d0	69 6f 6e 41 72 62 69 74  72 61 67 65 28 73 79 6d   ionArbitrage(sym
176e0	62 6f 6c 53 74 61 74 65  73 2c 20 63 6f 72 72 65   bolStates, corre
176f0	6c 61 74 69 6f 6e 4d 61  74 72 69 78 2c 20 63 75   lationMatrix, cu
17700	72 72 65 6e 74 49 6e 64  65 78 2c 20 69 73 42 65   rrentIndex, isBe
17710	61 72 4d 61 72 6b 65 74  29 0a 09 6f 70 70 6f 72   arMarket)..oppor
17720	74 75 6e 69 74 69 65 73  20 3d 20 61 70 70 65 6e   tunities = appen
17730	64 28 6f 70 70 6f 72 74  75 6e 69 74 69 65 73 2c   d(opportunities,
17740	20 63 6f 72 72 41 72 62  4f 70 73 2e 2e 2e 29 0a    corrArbOps...).
17750	0a 09 2f 2f 20 33 2e 20  e8 b7 a8 e6 9c 9f e5 a5   ..// 3. ........
17760	97 e5 88 a9 ef bc 9a e6  a3 80 e6 b5 8b e6 97 b6   ................
17770	e9 97 b4 e5 ba 8f e5 88  97 e5 bc 82 e5 b8 b8 ef   ................
17780	bc 88 e7 86 8a e5 b8 82  e4 b8 ad e5 ae 8c e5 85   ................
17790	a8 e7 a6 81 e6 ad a2 ef  bc 89 0a 09 69 66 20 21   ............if !
177a0	69 73 42 65 61 72 4d 61  72 6b 65 74 20 7b 0a 09   isBearMarket {..
177b0	09 74 65 6d 70 6f 72 61  6c 41 72 62 4f 70 73 20   .temporalArbOps 
177c0	3a 3d 20 62 65 2e 64 65  74 65 63 74 54 65 6d 70   := be.detectTemp
177d0	6f 72 61 6c 41 72 62 69  74 72 61 67 65 28 73 79   oralArbitrage(sy
177e0	6d 62 6f 6c 53 74 61 74  65 73 2c 20 63 75 72 72   mbolStates, curr
177f0	65 6e 74 49 6e 64 65 78  29 0a 09 09 6f 70 70 6f   entIndex)...oppo
17800	72 74 75 6e 69 74 69 65  73 20 3d 20 61 70 70 65   rtunities = appe
17810	6e 64 28 6f 70 70 6f 72  74 75 6e 69 74 69 65 73   nd(opportunities
17820	2c 20 74 65 6d 70 6f 72  61 6c 41 72 62 4f 70 73   , temporalArbOps
17830	2e 2e 2e 29 0a 09 7d 20  65 6c 73 65 20 7b 0a 09   ...)..} else {..
17840	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 41 52   .log.Printf("[AR
17850	42 49 54 52 41 47 45 5f  46 49 4c 54 45 52 5d 20   BITRAGE_FILTER] 
17860	e7 86 8a e5 b8 82 e7 8e  af e5 a2 83 ef bc 8c e7   ................
17870	a6 81 e6 ad a2 e8 b7 a8  e6 9c 9f e5 a5 97 e5 88   ................
17880	a9 e6 a3 80 e6 b5 8b 22  29 0a 09 7d 0a 0a 09 69   .......")..}...i
17890	66 20 6c 65 6e 28 6f 70  70 6f 72 74 75 6e 69 74   f len(opportunit
178a0	69 65 73 29 20 3e 20 30  20 7b 0a 09 09 6c 6f 67   ies) > 0 {...log
178b0	2e 50 72 69 6e 74 66 28  22 5b 41 52 42 49 54 52   .Printf("[ARBITR
178c0	41 47 45 5f 44 45 54 45  43 54 49 4f 4e 5d 20 e6   AGE_DETECTION] .
178d0	a3 80 e6 b5 8b e5 88 b0  25 64 e4 b8 aa e5 a5 97   ........%d......
178e0	e5 88 a9 e6 9c ba e4 bc  9a 22 2c 20 6c 65 6e 28   .........", len(
178f0	6f 70 70 6f 72 74 75 6e  69 74 69 65 73 29 29 0a   opportunities)).
17900	09 7d 20 65 6c 73 65 20  69 66 20 69 73 42 65 61   .} else if isBea
17910	72 4d 61 72 6b 65 74 20  7b 0a 09 09 6c 6f 67 2e   rMarket {...log.
17920	50 72 69 6e 74 66 28 22  5b 41 52 42 49 54 52 41   Printf("[ARBITRA
17930	47 45 5f 44 45 54 45 43  54 49 4f 4e 5d 20 e7 86   GE_DETECTION] ..
17940	8a e5 b8 82 e7 8e af e5  a2 83 ef bc 8c e6 9c aa   ................
17950	e6 a3 80 e6 b5 8b e5 88  b0 e6 9c 89 e6 95 88 e5   ................
17960	a5 97 e5 88 a9 e6 9c ba  e4 bc 9a 22 29 0a 09 7d   ...........")..}
17970	0a 0a 09 72 65 74 75 72  6e 20 6f 70 70 6f 72 74   ...return opport
17980	75 6e 69 74 69 65 73 0a  7d 0a 0a 2f 2f 20 64 65   unities.}..// de
17990	74 65 63 74 53 74 61 74  69 73 74 69 63 61 6c 41   tectStatisticalA
179a0	72 62 69 74 72 61 67 65  20 e6 a3 80 e6 b5 8b e7   rbitrage .......
179b0	bb 9f e8 ae a1 e5 a5 97  e5 88 a9 0a 66 75 6e 63   ............func
179c0	20 28 62 65 20 2a 42 61  63 6b 74 65 73 74 45 6e    (be *BacktestEn
179d0	67 69 6e 65 29 20 64 65  74 65 63 74 53 74 61 74   gine) detectStat
179e0	69 73 74 69 63 61 6c 41  72 62 69 74 72 61 67 65   isticalArbitrage
179f0	28 73 79 6d 62 6f 6c 53  74 61 74 65 73 20 6d 61   (symbolStates ma
17a00	70 5b 73 74 72 69 6e 67  5d 2a 53 79 6d 62 6f 6c   p[string]*Symbol
17a10	53 74 61 74 65 2c 20 63  75 72 72 65 6e 74 49 6e   State, currentIn
17a20	64 65 78 20 69 6e 74 2c  20 69 73 42 65 61 72 4d   dex int, isBearM
17a30	61 72 6b 65 74 20 62 6f  6f 6c 29 20 5b 5d 2a 41   arket bool) []*A
17a40	72 62 69 74 72 61 67 65  4f 70 70 6f 72 74 75 6e   rbitrageOpportun
17a50	69 74 79 20 7b 0a 09 76  61 72 20 6f 70 70 6f 72   ity {..var oppor
17a60	74 75 6e 69 74 69 65 73  20 5b 5d 2a 41 72 62 69   tunities []*Arbi
17a70	74 72 61 67 65 4f 70 70  6f 72 74 75 6e 69 74 79   trageOpportunity
17a80	0a 0a 09 66 6f 72 20 73  79 6d 62 6f 6c 2c 20 73   ...for symbol, s
17a90	74 61 74 65 20 3a 3d 20  72 61 6e 67 65 20 73 79   tate := range sy
17aa0	6d 62 6f 6c 53 74 61 74  65 73 20 7b 0a 09 09 69   mbolStates {...i
17ab0	66 20 63 75 72 72 65 6e  74 49 6e 64 65 78 20 3c   f currentIndex <
17ac0	20 33 30 20 7c 7c 20 63  75 72 72 65 6e 74 49 6e    30 || currentIn
17ad0	64 65 78 20 3e 3d 20 6c  65 6e 28 73 74 61 74 65   dex >= len(state
17ae0	2e 44 61 74 61 29 20 7b  0a 09 09 09 63 6f 6e 74   .Data) {....cont
17af0	69 6e 75 65 0a 09 09 7d  0a 0a 09 09 2f 2f 20 e8   inue...}....// .
17b00	ae a1 e7 ae 97 e7 a7 bb  e5 8a a8 e5 b9 b3 e5 9d   ................
17b10	87 e5 92 8c e6 a0 87 e5  87 86 e5 b7 ae 0a 09 09   ................
17b20	70 72 69 63 65 73 20 3a  3d 20 6d 61 6b 65 28 5b   prices := make([
17b30	5d 66 6c 6f 61 74 36 34  2c 20 33 30 29 0a 09 09   ]float64, 30)...
17b40	66 6f 72 20 69 20 3a 3d  20 30 3b 20 69 20 3c 20   for i := 0; i < 
17b50	33 30 3b 20 69 2b 2b 20  7b 0a 09 09 09 70 72 69   30; i++ {....pri
17b60	63 65 73 5b 69 5d 20 3d  20 73 74 61 74 65 2e 44   ces[i] = state.D
17b70	61 74 61 5b 63 75 72 72  65 6e 74 49 6e 64 65 78   ata[currentIndex
17b80	2d 32 39 2b 69 5d 2e 50  72 69 63 65 0a 09 09 7d   -29+i].Price...}
17b90	0a 0a 09 09 6d 65 61 6e  20 3a 3d 20 30 2e 30 0a   ....mean := 0.0.
17ba0	09 09 66 6f 72 20 5f 2c  20 70 72 69 63 65 20 3a   ..for _, price :
17bb0	3d 20 72 61 6e 67 65 20  70 72 69 63 65 73 20 7b   = range prices {
17bc0	0a 09 09 09 6d 65 61 6e  20 2b 3d 20 70 72 69 63   ....mean += pric
17bd0	65 0a 09 09 7d 0a 09 09  6d 65 61 6e 20 2f 3d 20   e...}...mean /= 
17be0	66 6c 6f 61 74 36 34 28  6c 65 6e 28 70 72 69 63   float64(len(pric
17bf0	65 73 29 29 0a 0a 09 09  76 61 72 69 61 6e 63 65   es))....variance
17c00	20 3a 3d 20 30 2e 30 0a  09 09 66 6f 72 20 5f 2c    := 0.0...for _,
17c10	20 70 72 69 63 65 20 3a  3d 20 72 61 6e 67 65 20    price := range 
17c20	70 72 69 63 65 73 20 7b  0a 09 09 09 64 69 66 66   prices {....diff
17c30	20 3a 3d 20 70 72 69 63  65 20 2d 20 6d 65 61 6e    := price - mean
17c40	0a 09 09 09 76 61 72 69  61 6e 63 65 20 2b 3d 20   ....variance += 
17c50	64 69 66 66 20 2a 20 64  69 66 66 0a 09 09 7d 0a   diff * diff...}.
17c60	09 09 76 61 72 69 61 6e  63 65 20 2f 3d 20 66 6c   ..variance /= fl
17c70	6f 61 74 36 34 28 6c 65  6e 28 70 72 69 63 65 73   oat64(len(prices
17c80	29 29 0a 09 09 73 74 64  44 65 76 20 3a 3d 20 6d   ))...stdDev := m
17c90	61 74 68 2e 53 71 72 74  28 76 61 72 69 61 6e 63   ath.Sqrt(varianc
17ca0	65 29 0a 0a 09 09 63 75  72 72 65 6e 74 50 72 69   e)....currentPri
17cb0	63 65 20 3a 3d 20 73 74  61 74 65 2e 44 61 74 61   ce := state.Data
17cc0	5b 63 75 72 72 65 6e 74  49 6e 64 65 78 5d 2e 50   [currentIndex].P
17cd0	72 69 63 65 0a 09 09 7a  53 63 6f 72 65 20 3a 3d   rice...zScore :=
17ce0	20 28 63 75 72 72 65 6e  74 50 72 69 63 65 20 2d    (currentPrice -
17cf0	20 6d 65 61 6e 29 20 2f  20 28 73 74 64 44 65 76    mean) / (stdDev
17d00	20 2b 20 31 65 2d 38 29  0a 0a 09 09 2f 2f 20 3d    + 1e-8)....// =
17d10	3d 3d 20 e7 86 8a e5 b8  82 e8 bf 87 e6 bb a4 20   == ............ 
17d20	3d 3d 3d 0a 09 09 69 66  20 69 73 42 65 61 72 4d   ===...if isBearM
17d30	61 72 6b 65 74 20 7b 0a  09 09 09 2f 2f 20 e7 86   arket {....// ..
17d40	8a e5 b8 82 e4 b8 ad e5  a4 a7 e5 b9 85 e6 8f 90   ................
17d50	e9 ab 98 e7 bb 9f e8 ae  a1 e5 a5 97 e5 88 a9 e7   ................
17d60	9a 84 e9 98 88 e5 80 bc  ef bc 8c e4 bb 8e 32 2e   ..............2.
17d70	30 e6 8f 90 e9 ab 98 e5  88 b0 33 2e 30 0a 09 09   0.........3.0...
17d80	09 2f 2f 20 e7 86 8a e5  b8 82 e4 b8 ad e5 8f aa   .// ............
17d90	e6 9c 89 e6 9e 81 e7 ab  af e7 9a 84 e7 bb 9f e8   ................
17da0	ae a1 e5 81 8f e7 a6 bb  e6 89 8d e6 9c 89 e6 84   ................
17db0	8f e4 b9 89 0a 09 09 09  69 66 20 6d 61 74 68 2e   ........if math.
17dc0	41 62 73 28 7a 53 63 6f  72 65 29 20 3c 3d 20 33   Abs(zScore) <= 3
17dd0	2e 30 20 7b 0a 09 09 09  09 63 6f 6e 74 69 6e 75   .0 {.....continu
17de0	65 20 2f 2f 20 e8 b7 b3  e8 bf 87 e4 b8 8d e5 a4   e // ...........
17df0	9f e6 9e 81 e7 ab af e7  9a 84 e7 bb 9f e8 ae a1   ................
17e00	e6 9c ba e4 bc 9a 0a 09  09 09 7d 0a 09 09 09 6c   ..........}....l
17e10	6f 67 2e 50 72 69 6e 74  66 28 22 5b 53 54 41 54   og.Printf("[STAT
17e20	5f 41 52 42 5f 46 49 4c  54 45 52 5d 20 25 73 e7   _ARB_FILTER] %s.
17e30	86 8a e5 b8 82 e7 8e af  e5 a2 83 ef bc 8c e7 bb   ................
17e40	9f e8 ae a1 e5 a5 97 e5  88 a9 e9 98 88 e5 80 bc   ................
17e50	e6 8f 90 e9 ab 98 e5 88  b0 33 2e 30 22 2c 20 73   .........3.0", s
17e60	79 6d 62 6f 6c 29 0a 09  09 7d 20 65 6c 73 65 20   ymbol)...} else 
17e70	7b 0a 09 09 09 2f 2f 20  e6 ad a3 e5 b8 b8 e5 b8   {....// ........
17e80	82 e5 9c ba e4 bd bf e7  94 a8 e6 a0 87 e5 87 86   ................
17e90	e9 98 88 e5 80 bc 0a 09  09 09 69 66 20 6d 61 74   ..........if mat
17ea0	68 2e 41 62 73 28 7a 53  63 6f 72 65 29 20 3c 3d   h.Abs(zScore) <=
17eb0	20 32 2e 30 20 7b 0a 09  09 09 09 63 6f 6e 74 69    2.0 {.....conti
17ec0	6e 75 65 0a 09 09 09 7d  0a 09 09 7d 0a 0a 09 09   nue....}...}....
17ed0	64 69 72 65 63 74 69 6f  6e 20 3a 3d 20 22 73 65   direction := "se
17ee0	6c 6c 22 0a 09 09 69 66  20 7a 53 63 6f 72 65 20   ll"...if zScore 
17ef0	3c 20 2d 32 2e 30 20 7b  0a 09 09 09 64 69 72 65   < -2.0 {....dire
17f00	63 74 69 6f 6e 20 3d 20  22 62 75 79 22 0a 09 09   ction = "buy"...
17f10	7d 0a 0a 09 09 2f 2f 20  3d 3d 3d 20 e7 86 8a e5   }....// === ....
17f20	b8 82 e8 b0 83 e6 95 b4  e9 a2 84 e6 9c 9f e6 94   ................
17f30	b6 e7 9b 8a 20 3d 3d 3d  0a 09 09 76 61 72 20 65   .... ===...var e
17f40	78 70 65 63 74 65 64 52  65 74 75 72 6e 20 66 6c   xpectedReturn fl
17f50	6f 61 74 36 34 0a 09 09  69 66 20 69 73 42 65 61   oat64...if isBea
17f60	72 4d 61 72 6b 65 74 20  7b 0a 09 09 09 2f 2f 20   rMarket {....// 
17f70	e7 86 8a e5 b8 82 e4 b8  ad e9 99 8d e4 bd 8e e9   ................
17f80	a2 84 e6 9c 9f e6 94 b6  e7 9b 8a ef bc 8c e5 9b   ................
17f90	a0 e4 b8 ba e5 9d 87 e5  80 bc e5 9b 9e e5 bd 92   ................
17fa0	e6 95 88 e5 8a 9b e5 87  8f e5 bc b1 0a 09 09 09   ................
17fb0	65 78 70 65 63 74 65 64  52 65 74 75 72 6e 20 3d   expectedReturn =
17fc0	20 6d 61 74 68 2e 41 62  73 28 7a 53 63 6f 72 65    math.Abs(zScore
17fd0	29 20 2a 20 30 2e 30 31  35 20 2f 2f 20 e4 bb 8e   ) * 0.015 // ...
17fe0	30 2e 30 33 35 e9 99 8d  e4 bd 8e e5 88 b0 30 2e   0.035.........0.
17ff0	30 31 35 0a 09 09 7d 20  65 6c 73 65 20 7b 0a 09   015...} else {..
18000	09 09 2f 2f 20 e6 ad a3  e5 b8 b8 e5 b8 82 e5 9c   ..// ...........
18010	ba e4 bd bf e7 94 a8 e8  be 83 e9 ab 98 e9 a2 84   ................
18020	e6 9c 9f e6 94 b6 e7 9b  8a 0a 09 09 09 65 78 70   .............exp
18030	65 63 74 65 64 52 65 74  75 72 6e 20 3d 20 6d 61   ectedReturn = ma
18040	74 68 2e 41 62 73 28 7a  53 63 6f 72 65 29 20 2a   th.Abs(zScore) *
18050	20 30 2e 30 33 35 0a 09  09 7d 0a 0a 09 09 2f 2f    0.035...}....//
18060	20 3d 3d 3d 20 e7 86 8a  e5 b8 82 e8 b0 83 e6 95    === ...........
18070	b4 e7 bd ae e4 bf a1 e5  ba a6 20 3d 3d 3d 0a 09   .......... ===..
18080	09 76 61 72 20 63 6f 6e  66 69 64 65 6e 63 65 20   .var confidence 
18090	66 6c 6f 61 74 36 34 0a  09 09 69 66 20 69 73 42   float64...if isB
180a0	65 61 72 4d 61 72 6b 65  74 20 7b 0a 09 09 09 2f   earMarket {..../
180b0	2f 20 e7 86 8a e5 b8 82  e4 b8 ad e9 99 8d e4 bd   / ..............
180c0	8e e7 bd ae e4 bf a1 e5  ba a6 0a 09 09 09 63 6f   ..............co
180d0	6e 66 69 64 65 6e 63 65  20 3d 20 6d 61 74 68 2e   nfidence = math.
180e0	4d 69 6e 28 6d 61 74 68  2e 41 62 73 28 7a 53 63   Min(math.Abs(zSc
180f0	6f 72 65 29 2f 34 2e 35  2c 20 30 2e 38 29 20 2f   ore)/4.5, 0.8) /
18100	2f 20 e9 99 8d e4 bd 8e  e6 9c 80 e5 a4 a7 e7 bd   / ..............
18110	ae e4 bf a1 e5 ba a6 e5  88 b0 38 30 25 0a 09 09   ..........80%...
18120	7d 20 65 6c 73 65 20 7b  0a 09 09 09 63 6f 6e 66   } else {....conf
18130	69 64 65 6e 63 65 20 3d  20 6d 61 74 68 2e 4d 69   idence = math.Mi
18140	6e 28 6d 61 74 68 2e 41  62 73 28 7a 53 63 6f 72   n(math.Abs(zScor
18150	65 29 2f 33 2e 35 2c 20  31 2e 30 29 0a 09 09 7d   e)/3.5, 1.0)...}
18160	0a 0a 09 09 6f 70 70 6f  72 74 75 6e 69 74 79 20   ....opportunity 
18170	3a 3d 20 26 41 72 62 69  74 72 61 67 65 4f 70 70   := &ArbitrageOpp
18180	6f 72 74 75 6e 69 74 79  7b 0a 09 09 09 54 79 70   ortunity{....Typ
18190	65 3a 20 20 20 20 20 20  20 20 20 20 20 22 73 74   e:           "st
181a0	61 74 69 73 74 69 63 61  6c 22 2c 0a 09 09 09 50   atistical",....P
181b0	72 69 6d 61 72 79 53 79  6d 62 6f 6c 3a 20 20 73   rimarySymbol:  s
181c0	79 6d 62 6f 6c 2c 0a 09  09 09 44 69 72 65 63 74   ymbol,....Direct
181d0	69 6f 6e 3a 20 20 20 20  20 20 64 69 72 65 63 74   ion:      direct
181e0	69 6f 6e 2c 0a 09 09 09  45 78 70 65 63 74 65 64   ion,....Expected
181f0	52 65 74 75 72 6e 3a 20  6d 61 74 68 2e 4d 69 6e   Return: math.Min
18200	28 65 78 70 65 63 74 65  64 52 65 74 75 72 6e 2c   (expectedReturn,
18210	20 30 2e 31 35 29 2c 0a  09 09 09 43 6f 6e 66 69    0.15),....Confi
18220	64 65 6e 63 65 3a 20 20  20 20 20 63 6f 6e 66 69   dence:     confi
18230	64 65 6e 63 65 2c 0a 09  09 09 5a 53 63 6f 72 65   dence,....ZScore
18240	3a 20 20 20 20 20 20 20  20 20 7a 53 63 6f 72 65   :         zScore
18250	2c 0a 09 09 09 54 69 6d  65 48 6f 72 69 7a 6f 6e   ,....TimeHorizon
18260	3a 20 20 20 20 33 2c 0a  09 09 09 52 69 73 6b 4c   :    3,....RiskL
18270	65 76 65 6c 3a 20 20 20  20 20 20 22 6d 65 64 69   evel:      "medi
18280	75 6d 22 2c 0a 09 09 7d  0a 0a 09 09 2f 2f 20 3d   um",...}....// =
18290	3d 3d 20 e7 86 8a e5 b8  82 e7 89 b9 e5 88 ab e6   == .............
182a0	a3 80 e6 9f a5 20 3d 3d  3d 0a 09 09 69 66 20 69   ..... ===...if i
182b0	73 42 65 61 72 4d 61 72  6b 65 74 20 26 26 20 64   sBearMarket && d
182c0	69 72 65 63 74 69 6f 6e  20 3d 3d 20 22 62 75 79   irection == "buy
182d0	22 20 7b 0a 09 09 09 2f  2f 20 e7 86 8a e5 b8 82   " {....// ......
182e0	e4 b8 ad e5 af b9 e4 b9  b0 e5 85 a5 e4 bf a1 e5   ................
182f0	8f b7 e8 bf 9b e8 a1 8c  e9 a2 9d e5 a4 96 e4 b8   ................
18300	a5 e6 a0 bc e6 a3 80 e6  9f a5 0a 09 09 09 69 66   ..............if
18310	20 6f 70 70 6f 72 74 75  6e 69 74 79 2e 43 6f 6e    opportunity.Con
18320	66 69 64 65 6e 63 65 20  3c 20 30 2e 36 20 7b 0a   fidence < 0.6 {.
18330	09 09 09 09 6c 6f 67 2e  50 72 69 6e 74 66 28 22   ....log.Printf("
18340	5b 53 54 41 54 5f 41 52  42 5f 46 49 4c 54 45 52   [STAT_ARB_FILTER
18350	5d 20 25 73 e7 86 8a e5  b8 82 e4 b9 b0 e5 85 a5   ] %s............
18360	e4 bf a1 e5 8f b7 e7 bd  ae e4 bf a1 e5 ba a6 e4   ................
18370	b8 8d e8 b6 b3 28 25 2e  32 66 29 ef bc 8c e8 b7   .....(%.2f).....
18380	b3 e8 bf 87 22 2c 20 73  79 6d 62 6f 6c 2c 20 6f   ....", symbol, o
18390	70 70 6f 72 74 75 6e 69  74 79 2e 43 6f 6e 66 69   pportunity.Confi
183a0	64 65 6e 63 65 29 0a 09  09 09 09 63 6f 6e 74 69   dence).....conti
183b0	6e 75 65 0a 09 09 09 7d  0a 09 09 7d 0a 0a 09 09   nue....}...}....
183c0	6f 70 70 6f 72 74 75 6e  69 74 69 65 73 20 3d 20   opportunities = 
183d0	61 70 70 65 6e 64 28 6f  70 70 6f 72 74 75 6e 69   append(opportuni
183e0	74 69 65 73 2c 20 6f 70  70 6f 72 74 75 6e 69 74   ties, opportunit
183f0	79 29 0a 0a 09 09 6c 6f  67 2e 50 72 69 6e 74 66   y)....log.Printf
18400	28 22 5b 53 54 41 54 5f  41 52 42 5d 20 25 73 20   ("[STAT_ARB] %s 
18410	e7 bb 9f e8 ae a1 e5 a5  97 e5 88 a9 e6 9c ba e4   ................
18420	bc 9a 3a 20 5a 2d 53 63  6f 72 65 3d 25 2e 32 66   ..: Z-Score=%.2f
18430	2c 20 e6 96 b9 e5 90 91  3d 25 73 2c 20 e7 bd ae   , ......=%s, ...
18440	e4 bf a1 e5 ba a6 3d 25  2e 32 66 25 73 22 2c 0a   ......=%.2f%s",.
18450	09 09 09 73 79 6d 62 6f  6c 2c 20 7a 53 63 6f 72   ...symbol, zScor
18460	65 2c 20 64 69 72 65 63  74 69 6f 6e 2c 20 6f 70   e, direction, op
18470	70 6f 72 74 75 6e 69 74  79 2e 43 6f 6e 66 69 64   portunity.Confid
18480	65 6e 63 65 2c 20 66 75  6e 63 28 29 20 73 74 72   ence, func() str
18490	69 6e 67 20 7b 0a 09 09  09 09 69 66 20 69 73 42   ing {.....if isB
184a0	65 61 72 4d 61 72 6b 65  74 20 7b 0a 09 09 09 09   earMarket {.....
184b0	09 72 65 74 75 72 6e 20  22 20 5b e7 86 8a e5 b8   .return " [.....
184c0	82 e8 bf 87 e6 bb a4 5d  22 0a 09 09 09 09 7d 0a   .......]".....}.
184d0	09 09 09 09 72 65 74 75  72 6e 20 22 22 0a 09 09   ....return ""...
184e0	09 7d 28 29 29 0a 09 7d  0a 0a 09 72 65 74 75 72   .}())..}...retur
184f0	6e 20 6f 70 70 6f 72 74  75 6e 69 74 69 65 73 0a   n opportunities.
18500	7d 0a 0a 2f 2f 20 64 65  74 65 63 74 43 6f 72 72   }..// detectCorr
18510	65 6c 61 74 69 6f 6e 41  72 62 69 74 72 61 67 65   elationArbitrage
18520	20 e6 a3 80 e6 b5 8b e7  9b b8 e5 85 b3 e6 80 a7    ...............
18530	e5 a5 97 e5 88 a9 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
18540	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
18550	20 64 65 74 65 63 74 43  6f 72 72 65 6c 61 74 69    detectCorrelati
18560	6f 6e 41 72 62 69 74 72  61 67 65 28 73 79 6d 62   onArbitrage(symb
18570	6f 6c 53 74 61 74 65 73  20 6d 61 70 5b 73 74 72   olStates map[str
18580	69 6e 67 5d 2a 53 79 6d  62 6f 6c 53 74 61 74 65   ing]*SymbolState
18590	2c 20 63 6f 72 72 65 6c  61 74 69 6f 6e 4d 61 74   , correlationMat
185a0	72 69 78 20 6d 61 70 5b  73 74 72 69 6e 67 5d 6d   rix map[string]m
185b0	61 70 5b 73 74 72 69 6e  67 5d 66 6c 6f 61 74 36   ap[string]float6
185c0	34 2c 20 63 75 72 72 65  6e 74 49 6e 64 65 78 20   4, currentIndex 
185d0	69 6e 74 2c 20 69 73 42  65 61 72 4d 61 72 6b 65   int, isBearMarke
185e0	74 20 62 6f 6f 6c 29 20  5b 5d 2a 41 72 62 69 74   t bool) []*Arbit
185f0	72 61 67 65 4f 70 70 6f  72 74 75 6e 69 74 79 20   rageOpportunity 
18600	7b 0a 09 76 61 72 20 6f  70 70 6f 72 74 75 6e 69   {..var opportuni
18610	74 69 65 73 20 5b 5d 2a  41 72 62 69 74 72 61 67   ties []*Arbitrag
18620	65 4f 70 70 6f 72 74 75  6e 69 74 79 0a 0a 09 73   eOpportunity...s
18630	79 6d 62 6f 6c 73 20 3a  3d 20 6d 61 6b 65 28 5b   ymbols := make([
18640	5d 73 74 72 69 6e 67 2c  20 30 2c 20 6c 65 6e 28   ]string, 0, len(
18650	63 6f 72 72 65 6c 61 74  69 6f 6e 4d 61 74 72 69   correlationMatri
18660	78 29 29 0a 09 66 6f 72  20 73 79 6d 62 6f 6c 20   x))..for symbol 
18670	3a 3d 20 72 61 6e 67 65  20 63 6f 72 72 65 6c 61   := range correla
18680	74 69 6f 6e 4d 61 74 72  69 78 20 7b 0a 09 09 73   tionMatrix {...s
18690	79 6d 62 6f 6c 73 20 3d  20 61 70 70 65 6e 64 28   ymbols = append(
186a0	73 79 6d 62 6f 6c 73 2c  20 73 79 6d 62 6f 6c 29   symbols, symbol)
186b0	0a 09 7d 0a 0a 09 2f 2f  20 e6 a3 80 e6 9f a5 e6   ..}...// .......
186c0	af 8f e5 af b9 e9 ab 98  e5 ba a6 e7 9b b8 e5 85   ................
186d0	b3 e7 9a 84 e5 b8 81 e7  a7 8d 0a 09 66 6f 72 20   ............for 
186e0	69 20 3a 3d 20 30 3b 20  69 20 3c 20 6c 65 6e 28   i := 0; i < len(
186f0	73 79 6d 62 6f 6c 73 29  3b 20 69 2b 2b 20 7b 0a   symbols); i++ {.
18700	09 09 66 6f 72 20 6a 20  3a 3d 20 69 20 2b 20 31   ..for j := i + 1
18710	3b 20 6a 20 3c 20 6c 65  6e 28 73 79 6d 62 6f 6c   ; j < len(symbol
18720	73 29 3b 20 6a 2b 2b 20  7b 0a 09 09 09 73 79 6d   s); j++ {....sym
18730	62 6f 6c 31 20 3a 3d 20  73 79 6d 62 6f 6c 73 5b   bol1 := symbols[
18740	69 5d 0a 09 09 09 73 79  6d 62 6f 6c 32 20 3a 3d   i]....symbol2 :=
18750	20 73 79 6d 62 6f 6c 73  5b 6a 5d 0a 0a 09 09 09    symbols[j].....
18760	63 6f 72 72 2c 20 65 78  69 73 74 73 20 3a 3d 20   corr, exists := 
18770	63 6f 72 72 65 6c 61 74  69 6f 6e 4d 61 74 72 69   correlationMatri
18780	78 5b 73 79 6d 62 6f 6c  31 5d 5b 73 79 6d 62 6f   x[symbol1][symbo
18790	6c 32 5d 0a 09 09 09 69  66 20 21 65 78 69 73 74   l2]....if !exist
187a0	73 20 7c 7c 20 6d 61 74  68 2e 41 62 73 28 63 6f   s || math.Abs(co
187b0	72 72 29 20 3c 20 30 2e  37 20 7b 20 2f 2f 20 e5   rr) < 0.7 { // .
187c0	8f aa e8 80 83 e8 99 91  e9 ab 98 e5 ba a6 e7 9b   ................
187d0	b8 e5 85 b3 e7 9a 84 e5  af b9 0a 09 09 09 09 63   ...............c
187e0	6f 6e 74 69 6e 75 65 0a  09 09 09 7d 0a 0a 09 09   ontinue....}....
187f0	09 73 74 61 74 65 31 2c  20 65 78 69 73 74 73 31   .state1, exists1
18800	20 3a 3d 20 73 79 6d 62  6f 6c 53 74 61 74 65 73    := symbolStates
18810	5b 73 79 6d 62 6f 6c 31  5d 0a 09 09 09 73 74 61   [symbol1]....sta
18820	74 65 32 2c 20 65 78 69  73 74 73 32 20 3a 3d 20   te2, exists2 := 
18830	73 79 6d 62 6f 6c 53 74  61 74 65 73 5b 73 79 6d   symbolStates[sym
18840	62 6f 6c 32 5d 0a 0a 09  09 09 69 66 20 21 65 78   bol2].....if !ex
18850	69 73 74 73 31 20 7c 7c  20 21 65 78 69 73 74 73   ists1 || !exists
18860	32 20 7c 7c 20 63 75 72  72 65 6e 74 49 6e 64 65   2 || currentInde
18870	78 20 3e 3d 20 6c 65 6e  28 73 74 61 74 65 31 2e   x >= len(state1.
18880	44 61 74 61 29 20 7c 7c  20 63 75 72 72 65 6e 74   Data) || current
18890	49 6e 64 65 78 20 3e 3d  20 6c 65 6e 28 73 74 61   Index >= len(sta
188a0	74 65 32 2e 44 61 74 61  29 20 7b 0a 09 09 09 09   te2.Data) {.....
188b0	63 6f 6e 74 69 6e 75 65  0a 09 09 09 7d 0a 0a 09   continue....}...
188c0	09 09 2f 2f 20 e8 ae a1  e7 ae 97 e8 bf 91 e6 9c   ..// ...........
188d0	9f e6 94 b6 e7 9b 8a e7  8e 87 e5 81 8f e7 a6 bb   ................
188e0	0a 09 09 09 72 65 74 75  72 6e 31 20 3a 3d 20 62   ....return1 := b
188f0	65 2e 63 61 6c 63 75 6c  61 74 65 52 65 63 65 6e   e.calculateRecen
18900	74 52 65 74 75 72 6e 28  73 74 61 74 65 31 2e 44   tReturn(state1.D
18910	61 74 61 2c 20 63 75 72  72 65 6e 74 49 6e 64 65   ata, currentInde
18920	78 2c 20 35 29 0a 09 09  09 72 65 74 75 72 6e 32   x, 5)....return2
18930	20 3a 3d 20 62 65 2e 63  61 6c 63 75 6c 61 74 65    := be.calculate
18940	52 65 63 65 6e 74 52 65  74 75 72 6e 28 73 74 61   RecentReturn(sta
18950	74 65 32 2e 44 61 74 61  2c 20 63 75 72 72 65 6e   te2.Data, curren
18960	74 49 6e 64 65 78 2c 20  35 29 0a 0a 09 09 09 65   tIndex, 5).....e
18970	78 70 65 63 74 65 64 52  65 74 75 72 6e 32 20 3a   xpectedReturn2 :
18980	3d 20 72 65 74 75 72 6e  31 20 2a 20 63 6f 72 72   = return1 * corr
18990	20 2f 2f 20 e5 9f ba e4  ba 8e e7 9b b8 e5 85 b3    // ............
189a0	e6 80 a7 e7 9a 84 e9 a2  84 e6 9c 9f e6 94 b6 e7   ................
189b0	9b 8a e7 8e 87 0a 09 09  09 64 65 76 69 61 74 69   .........deviati
189c0	6f 6e 20 3a 3d 20 72 65  74 75 72 6e 32 20 2d 20   on := return2 - 
189d0	65 78 70 65 63 74 65 64  52 65 74 75 72 6e 32 0a   expectedReturn2.
189e0	0a 09 09 09 2f 2f 20 3d  3d 3d 20 e7 86 8a e5 b8   ....// === .....
189f0	82 e8 bf 87 e6 bb a4 20  3d 3d 3d 0a 09 09 09 76   ....... ===....v
18a00	61 72 20 74 68 72 65 73  68 6f 6c 64 20 66 6c 6f   ar threshold flo
18a10	61 74 36 34 0a 09 09 09  69 66 20 69 73 42 65 61   at64....if isBea
18a20	72 4d 61 72 6b 65 74 20  7b 0a 09 09 09 09 2f 2f   rMarket {.....//
18a30	20 e7 86 8a e5 b8 82 e4  b8 ad e6 8f 90 e9 ab 98    ...............
18a40	e7 9b b8 e5 85 b3 e6 80  a7 e5 a5 97 e5 88 a9 e9   ................
18a50	98 88 e5 80 bc ef bc 8c  e4 bb 8e 30 2e 30 35 e6   ...........0.05.
18a60	8f 90 e9 ab 98 e5 88 b0  30 2e 30 38 0a 09 09 09   ........0.08....
18a70	09 2f 2f 20 e7 86 8a e5  b8 82 e4 b8 ad e7 9b b8   .// ............
18a80	e5 85 b3 e6 80 a7 e5 81  8f e7 a6 bb e6 9b b4 e5   ................
18a90	b8 b8 e8 a7 81 ef bc 8c  e9 9c 80 e8 a6 81 e6 9b   ................
18aa0	b4 e6 98 be e8 91 97 e7  9a 84 e5 81 8f e7 a6 bb   ................
18ab0	e6 89 8d e6 9c 89 e5 a5  97 e5 88 a9 e4 bb b7 e5   ................
18ac0	80 bc 0a 09 09 09 09 74  68 72 65 73 68 6f 6c 64   .......threshold
18ad0	20 3d 20 30 2e 30 38 0a  09 09 09 09 6c 6f 67 2e    = 0.08.....log.
18ae0	50 72 69 6e 74 66 28 22  5b 43 4f 52 52 5f 41 52   Printf("[CORR_AR
18af0	42 5f 46 49 4c 54 45 52  5d 20 25 73 e7 86 8a e5   B_FILTER] %s....
18b00	b8 82 e7 8e af e5 a2 83  ef bc 8c e7 9b b8 e5 85   ................
18b10	b3 e6 80 a7 e5 a5 97 e5  88 a9 e9 98 88 e5 80 bc   ................
18b20	e6 8f 90 e9 ab 98 e5 88  b0 38 25 25 22 2c 20 73   .........8%%", s
18b30	79 6d 62 6f 6c 31 29 0a  09 09 09 7d 20 65 6c 73   ymbol1)....} els
18b40	65 20 7b 0a 09 09 09 09  74 68 72 65 73 68 6f 6c   e {.....threshol
18b50	64 20 3d 20 30 2e 30 35  20 2f 2f 20 e6 ad a3 e5   d = 0.05 // ....
18b60	b8 b8 e5 b8 82 e5 9c ba  e9 98 88 e5 80 bc 0a 09   ................
18b70	09 09 7d 0a 0a 09 09 09  69 66 20 6d 61 74 68 2e   ..}.....if math.
18b80	41 62 73 28 64 65 76 69  61 74 69 6f 6e 29 20 3e   Abs(deviation) >
18b90	20 74 68 72 65 73 68 6f  6c 64 20 7b 0a 09 09 09    threshold {....
18ba0	09 64 69 72 65 63 74 69  6f 6e 20 3a 3d 20 22 62   .direction := "b
18bb0	75 79 22 0a 09 09 09 09  74 61 72 67 65 74 53 79   uy".....targetSy
18bc0	6d 62 6f 6c 20 3a 3d 20  73 79 6d 62 6f 6c 32 0a   mbol := symbol2.
18bd0	09 09 09 09 69 66 20 64  65 76 69 61 74 69 6f 6e   ....if deviation
18be0	20 3e 20 30 20 7b 0a 09  09 09 09 09 64 69 72 65    > 0 {......dire
18bf0	63 74 69 6f 6e 20 3d 20  22 73 65 6c 6c 22 0a 09   ction = "sell"..
18c00	09 09 09 09 74 61 72 67  65 74 53 79 6d 62 6f 6c   ....targetSymbol
18c10	20 3d 20 73 79 6d 62 6f  6c 32 0a 09 09 09 09 7d    = symbol2.....}
18c20	0a 0a 09 09 09 09 2f 2f  20 3d 3d 3d 20 e7 86 8a   ......// === ...
18c30	e5 b8 82 e8 b0 83 e6 95  b4 e9 a2 84 e6 9c 9f e6   ................
18c40	94 b6 e7 9b 8a e5 92 8c  e7 bd ae e4 bf a1 e5 ba   ................
18c50	a6 20 3d 3d 3d 0a 09 09  09 09 76 61 72 20 65 78   . ===.....var ex
18c60	70 65 63 74 65 64 52 65  74 75 72 6e 2c 20 63 6f   pectedReturn, co
18c70	6e 66 69 64 65 6e 63 65  20 66 6c 6f 61 74 36 34   nfidence float64
18c80	0a 09 09 09 09 69 66 20  69 73 42 65 61 72 4d 61   .....if isBearMa
18c90	72 6b 65 74 20 7b 0a 09  09 09 09 09 2f 2f 20 e7   rket {......// .
18ca0	86 8a e5 b8 82 e4 b8 ad  e9 99 8d e4 bd 8e e7 9b   ................
18cb0	b8 e5 85 b3 e6 80 a7 e5  a5 97 e5 88 a9 e7 9a 84   ................
18cc0	e9 a2 84 e6 9c 9f e6 94  b6 e7 9b 8a e5 92 8c e7   ................
18cd0	bd ae e4 bf a1 e5 ba a6  0a 09 09 09 09 09 65 78   ..............ex
18ce0	70 65 63 74 65 64 52 65  74 75 72 6e 20 3d 20 6d   pectedReturn = m
18cf0	61 74 68 2e 41 62 73 28  64 65 76 69 61 74 69 6f   ath.Abs(deviatio
18d00	6e 29 20 2a 20 30 2e 34  20 20 20 20 20 20 20 20   n) * 0.4        
18d10	20 20 20 2f 2f 20 e4 bb  8e 30 2e 38 e9 99 8d e4      // ...0.8....
18d20	bd 8e e5 88 b0 30 2e 34  0a 09 09 09 09 09 63 6f   .....0.4......co
18d30	6e 66 69 64 65 6e 63 65  20 3d 20 6d 61 74 68 2e   nfidence = math.
18d40	4d 69 6e 28 6d 61 74 68  2e 41 62 73 28 64 65 76   Min(math.Abs(dev
18d50	69 61 74 69 6f 6e 29 2f  30 2e 31 35 2c 20 30 2e   iation)/0.15, 0.
18d60	37 29 20 2f 2f 20 e9 99  8d e4 bd 8e e6 9c 80 e5   7) // ..........
18d70	a4 a7 e7 bd ae e4 bf a1  e5 ba a6 e5 88 b0 37 30   ..............70
18d80	25 0a 09 09 09 09 7d 20  65 6c 73 65 20 7b 0a 09   %.....} else {..
18d90	09 09 09 09 65 78 70 65  63 74 65 64 52 65 74 75   ....expectedRetu
18da0	72 6e 20 3d 20 6d 61 74  68 2e 41 62 73 28 64 65   rn = math.Abs(de
18db0	76 69 61 74 69 6f 6e 29  20 2a 20 30 2e 38 0a 09   viation) * 0.8..
18dc0	09 09 09 09 63 6f 6e 66  69 64 65 6e 63 65 20 3d   ....confidence =
18dd0	20 6d 61 74 68 2e 4d 69  6e 28 6d 61 74 68 2e 41    math.Min(math.A
18de0	62 73 28 64 65 76 69 61  74 69 6f 6e 29 2f 30 2e   bs(deviation)/0.
18df0	31 2c 20 31 2e 30 29 0a  09 09 09 09 7d 0a 0a 09   1, 1.0).....}...
18e00	09 09 09 6f 70 70 6f 72  74 75 6e 69 74 79 20 3a   ...opportunity :
18e10	3d 20 26 41 72 62 69 74  72 61 67 65 4f 70 70 6f   = &ArbitrageOppo
18e20	72 74 75 6e 69 74 79 7b  0a 09 09 09 09 09 54 79   rtunity{......Ty
18e30	70 65 3a 20 20 20 20 20  20 20 20 20 20 20 20 22   pe:            "
18e40	63 6f 72 72 65 6c 61 74  69 6f 6e 22 2c 0a 09 09   correlation",...
18e50	09 09 09 50 72 69 6d 61  72 79 53 79 6d 62 6f 6c   ...PrimarySymbol
18e60	3a 20 20 20 74 61 72 67  65 74 53 79 6d 62 6f 6c   :   targetSymbol
18e70	2c 0a 09 09 09 09 09 53  65 63 6f 6e 64 61 72 79   ,......Secondary
18e80	53 79 6d 62 6f 6c 3a 20  73 79 6d 62 6f 6c 31 2c   Symbol: symbol1,
18e90	0a 09 09 09 09 09 44 69  72 65 63 74 69 6f 6e 3a   ......Direction:
18ea0	20 20 20 20 20 20 20 64  69 72 65 63 74 69 6f 6e          direction
18eb0	2c 0a 09 09 09 09 09 45  78 70 65 63 74 65 64 52   ,......ExpectedR
18ec0	65 74 75 72 6e 3a 20 20  65 78 70 65 63 74 65 64   eturn:  expected
18ed0	52 65 74 75 72 6e 2c 0a  09 09 09 09 09 43 6f 6e   Return,......Con
18ee0	66 69 64 65 6e 63 65 3a  20 20 20 20 20 20 63 6f   fidence:      co
18ef0	6e 66 69 64 65 6e 63 65  2c 0a 09 09 09 09 09 43   nfidence,......C
18f00	6f 72 72 65 6c 61 74 69  6f 6e 3a 20 20 20 20 20   orrelation:     
18f10	63 6f 72 72 2c 0a 09 09  09 09 09 54 69 6d 65 48   corr,......TimeH
18f20	6f 72 69 7a 6f 6e 3a 20  20 20 20 20 33 2c 0a 09   orizon:     3,..
18f30	09 09 09 09 52 69 73 6b  4c 65 76 65 6c 3a 20 20   ....RiskLevel:  
18f40	20 20 20 20 20 22 6c 6f  77 22 2c 0a 09 09 09 09        "low",.....
18f50	7d 0a 0a 09 09 09 09 2f  2f 20 3d 3d 3d 20 e7 86   }......// === ..
18f60	8a e5 b8 82 e7 89 b9 e5  88 ab e6 a3 80 e6 9f a5   ................
18f70	20 3d 3d 3d 0a 09 09 09  09 69 66 20 69 73 42 65    ===.....if isBe
18f80	61 72 4d 61 72 6b 65 74  20 26 26 20 64 69 72 65   arMarket && dire
18f90	63 74 69 6f 6e 20 3d 3d  20 22 62 75 79 22 20 7b   ction == "buy" {
18fa0	0a 09 09 09 09 09 2f 2f  20 e7 86 8a e5 b8 82 e4   ......// .......
18fb0	b8 ad e5 af b9 e4 b9 b0  e5 85 a5 e5 a5 97 e5 88   ................
18fc0	a9 e4 bf a1 e5 8f b7 e8  bf 9b e8 a1 8c e9 a2 9d   ................
18fd0	e5 a4 96 e6 a3 80 e6 9f  a5 0a 09 09 09 09 09 69   ...............i
18fe0	66 20 6f 70 70 6f 72 74  75 6e 69 74 79 2e 43 6f   f opportunity.Co
18ff0	6e 66 69 64 65 6e 63 65  20 3c 20 30 2e 35 20 7b   nfidence < 0.5 {
19000	0a 09 09 09 09 09 09 6c  6f 67 2e 50 72 69 6e 74   .......log.Print
19010	66 28 22 5b 43 4f 52 52  5f 41 52 42 5f 46 49 4c   f("[CORR_ARB_FIL
19020	54 45 52 5d 20 25 73 e7  86 8a e5 b8 82 e4 b9 b0   TER] %s.........
19030	e5 85 a5 e5 a5 97 e5 88  a9 e4 bf a1 e5 8f b7 e7   ................
19040	bd ae e4 bf a1 e5 ba a6  e4 b8 8d e8 b6 b3 28 25   ..............(%
19050	2e 32 66 29 ef bc 8c e8  b7 b3 e8 bf 87 22 2c 20   .2f).........", 
19060	74 61 72 67 65 74 53 79  6d 62 6f 6c 2c 20 6f 70   targetSymbol, op
19070	70 6f 72 74 75 6e 69 74  79 2e 43 6f 6e 66 69 64   portunity.Confid
19080	65 6e 63 65 29 0a 09 09  09 09 09 09 63 6f 6e 74   ence).......cont
19090	69 6e 75 65 0a 09 09 09  09 09 7d 0a 09 09 09 09   inue......}.....
190a0	7d 0a 0a 09 09 09 09 6f  70 70 6f 72 74 75 6e 69   }......opportuni
190b0	74 69 65 73 20 3d 20 61  70 70 65 6e 64 28 6f 70   ties = append(op
190c0	70 6f 72 74 75 6e 69 74  69 65 73 2c 20 6f 70 70   portunities, opp
190d0	6f 72 74 75 6e 69 74 79  29 0a 0a 09 09 09 09 6c   ortunity)......l
190e0	6f 67 2e 50 72 69 6e 74  66 28 22 5b 43 4f 52 52   og.Printf("[CORR
190f0	5f 41 52 42 5d 20 e7 9b  b8 e5 85 b3 e6 80 a7 e5   _ARB] ..........
19100	a5 97 e5 88 a9 3a 20 25  73 20 76 73 20 25 73 2c   .....: %s vs %s,
19110	20 e7 9b b8 e5 85 b3 e6  80 a7 3d 25 2e 32 66 2c    .........=%.2f,
19120	20 e5 81 8f e7 a6 bb 3d  25 2e 33 66 2c 20 e6 96    ......=%.3f, ..
19130	b9 e5 90 91 3d 25 73 20  25 73 25 73 22 2c 0a 09   ....=%s %s%s",..
19140	09 09 09 09 73 79 6d 62  6f 6c 31 2c 20 73 79 6d   ....symbol1, sym
19150	62 6f 6c 32 2c 20 63 6f  72 72 2c 20 64 65 76 69   bol2, corr, devi
19160	61 74 69 6f 6e 2c 20 64  69 72 65 63 74 69 6f 6e   ation, direction
19170	2c 20 74 61 72 67 65 74  53 79 6d 62 6f 6c 2c 20   , targetSymbol, 
19180	66 75 6e 63 28 29 20 73  74 72 69 6e 67 20 7b 0a   func() string {.
19190	09 09 09 09 09 09 69 66  20 69 73 42 65 61 72 4d   ......if isBearM
191a0	61 72 6b 65 74 20 7b 0a  09 09 09 09 09 09 09 72   arket {........r
191b0	65 74 75 72 6e 20 22 20  5b e7 86 8a e5 b8 82 e8   eturn " [.......
191c0	bf 87 e6 bb a4 5d 22 0a  09 09 09 09 09 09 7d 0a   .....]".......}.
191d0	09 09 09 09 09 09 72 65  74 75 72 6e 20 22 22 0a   ......return "".
191e0	09 09 09 09 09 7d 28 29  29 0a 09 09 09 7d 0a 09   .....}())....}..
191f0	09 7d 0a 09 7d 0a 0a 09  72 65 74 75 72 6e 20 6f   .}..}...return o
19200	70 70 6f 72 74 75 6e 69  74 69 65 73 0a 7d 0a 0a   pportunities.}..
19210	2f 2f 20 63 61 6c 63 75  6c 61 74 65 52 65 63 65   // calculateRece
19220	6e 74 52 65 74 75 72 6e  20 e8 ae a1 e7 ae 97 e8   ntReturn .......
19230	bf 91 e6 9c 9f e6 94 b6  e7 9b 8a e7 8e 87 0a 66   ...............f
19240	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
19250	74 45 6e 67 69 6e 65 29  20 63 61 6c 63 75 6c 61   tEngine) calcula
19260	74 65 52 65 63 65 6e 74  52 65 74 75 72 6e 28 64   teRecentReturn(d
19270	61 74 61 20 5b 5d 4d 61  72 6b 65 74 44 61 74 61   ata []MarketData
19280	2c 20 63 75 72 72 65 6e  74 49 6e 64 65 78 2c 20   , currentIndex, 
19290	64 61 79 73 20 69 6e 74  29 20 66 6c 6f 61 74 36   days int) float6
192a0	34 20 7b 0a 09 69 66 20  63 75 72 72 65 6e 74 49   4 {..if currentI
192b0	6e 64 65 78 20 3c 20 64  61 79 73 20 7c 7c 20 6c   ndex < days || l
192c0	65 6e 28 64 61 74 61 29  20 3c 3d 20 63 75 72 72   en(data) <= curr
192d0	65 6e 74 49 6e 64 65 78  20 7b 0a 09 09 72 65 74   entIndex {...ret
192e0	75 72 6e 20 30 2e 30 0a  09 7d 0a 0a 09 73 74 61   urn 0.0..}...sta
192f0	72 74 50 72 69 63 65 20  3a 3d 20 64 61 74 61 5b   rtPrice := data[
19300	63 75 72 72 65 6e 74 49  6e 64 65 78 2d 64 61 79   currentIndex-day
19310	73 2b 31 5d 2e 50 72 69  63 65 0a 09 65 6e 64 50   s+1].Price..endP
19320	72 69 63 65 20 3a 3d 20  64 61 74 61 5b 63 75 72   rice := data[cur
19330	72 65 6e 74 49 6e 64 65  78 5d 2e 50 72 69 63 65   rentIndex].Price
19340	0a 0a 09 72 65 74 75 72  6e 20 28 65 6e 64 50 72   ...return (endPr
19350	69 63 65 20 2d 20 73 74  61 72 74 50 72 69 63 65   ice - startPrice
19360	29 20 2f 20 73 74 61 72  74 50 72 69 63 65 0a 7d   ) / startPrice.}
19370	0a 0a 2f 2f 20 64 65 74  65 63 74 54 65 6d 70 6f   ..// detectTempo
19380	72 61 6c 41 72 62 69 74  72 61 67 65 20 e6 a3 80   ralArbitrage ...
19390	e6 b5 8b e6 97 b6 e9 97  b4 e5 ba 8f e5 88 97 e5   ................
193a0	a5 97 e5 88 a9 0a 66 75  6e 63 20 28 62 65 20 2a   ......func (be *
193b0	42 61 63 6b 74 65 73 74  45 6e 67 69 6e 65 29 20   BacktestEngine) 
193c0	64 65 74 65 63 74 54 65  6d 70 6f 72 61 6c 41 72   detectTemporalAr
193d0	62 69 74 72 61 67 65 28  73 79 6d 62 6f 6c 53 74   bitrage(symbolSt
193e0	61 74 65 73 20 6d 61 70  5b 73 74 72 69 6e 67 5d   ates map[string]
193f0	2a 53 79 6d 62 6f 6c 53  74 61 74 65 2c 20 63 75   *SymbolState, cu
19400	72 72 65 6e 74 49 6e 64  65 78 20 69 6e 74 29 20   rrentIndex int) 
19410	5b 5d 2a 41 72 62 69 74  72 61 67 65 4f 70 70 6f   []*ArbitrageOppo
19420	72 74 75 6e 69 74 79 20  7b 0a 09 76 61 72 20 6f   rtunity {..var o
19430	70 70 6f 72 74 75 6e 69  74 69 65 73 20 5b 5d 2a   pportunities []*
19440	41 72 62 69 74 72 61 67  65 4f 70 70 6f 72 74 75   ArbitrageOpportu
19450	6e 69 74 79 0a 0a 09 66  6f 72 20 73 79 6d 62 6f   nity...for symbo
19460	6c 2c 20 73 74 61 74 65  20 3a 3d 20 72 61 6e 67   l, state := rang
19470	65 20 73 79 6d 62 6f 6c  53 74 61 74 65 73 20 7b   e symbolStates {
19480	0a 09 09 69 66 20 63 75  72 72 65 6e 74 49 6e 64   ...if currentInd
19490	65 78 20 3c 20 32 30 20  7c 7c 20 63 75 72 72 65   ex < 20 || curre
194a0	6e 74 49 6e 64 65 78 20  3e 3d 20 6c 65 6e 28 73   ntIndex >= len(s
194b0	74 61 74 65 2e 44 61 74  61 29 20 7b 0a 09 09 09   tate.Data) {....
194c0	63 6f 6e 74 69 6e 75 65  0a 09 09 7d 0a 0a 09 09   continue...}....
194d0	2f 2f 20 e6 a3 80 e6 b5  8b e4 bb b7 e6 a0 bc e5   // .............
194e0	8f 8d e8 bd ac e4 bf a1  e5 8f b7 0a 09 09 70 72   ..............pr
194f0	69 63 65 73 20 3a 3d 20  6d 61 6b 65 28 5b 5d 66   ices := make([]f
19500	6c 6f 61 74 36 34 2c 20  32 30 29 0a 09 09 66 6f   loat64, 20)...fo
19510	72 20 69 20 3a 3d 20 30  3b 20 69 20 3c 20 32 30   r i := 0; i < 20
19520	3b 20 69 2b 2b 20 7b 0a  09 09 09 70 72 69 63 65   ; i++ {....price
19530	73 5b 69 5d 20 3d 20 73  74 61 74 65 2e 44 61 74   s[i] = state.Dat
19540	61 5b 63 75 72 72 65 6e  74 49 6e 64 65 78 2d 31   a[currentIndex-1
19550	39 2b 69 5d 2e 50 72 69  63 65 0a 09 09 7d 0a 0a   9+i].Price...}..
19560	09 09 2f 2f 20 e8 ae a1  e7 ae 97 e5 8a a8 e9 87   ..// ...........
19570	8f e5 92 8c e8 b6 8b e5  8a bf 0a 09 09 73 68 6f   .............sho
19580	72 74 54 65 72 6d 4d 6f  6d 65 6e 74 75 6d 20 3a   rtTermMomentum :
19590	3d 20 62 65 2e 63 61 6c  63 75 6c 61 74 65 50 72   = be.calculatePr
195a0	69 63 65 4d 6f 6d 65 6e  74 75 6d 28 70 72 69 63   iceMomentum(pric
195b0	65 73 5b 6c 65 6e 28 70  72 69 63 65 73 29 2d 35   es[len(prices)-5
195c0	3a 5d 29 0a 09 09 6c 6f  6e 67 54 65 72 6d 54 72   :])...longTermTr
195d0	65 6e 64 20 3a 3d 20 62  65 2e 63 61 6c 63 75 6c   end := be.calcul
195e0	61 74 65 54 72 65 6e 64  28 70 72 69 63 65 73 29   ateTrend(prices)
195f0	0a 0a 09 09 2f 2f 20 e6  a3 80 e6 b5 8b e8 b6 85   ....// .........
19600	e4 b9 b0 e8 b6 85 e5 8d  96 e6 9d a1 e4 bb b6 e7   ................
19610	bb 93 e5 90 88 e8 b6 8b  e5 8a bf e5 8f 8d e8 bd   ................
19620	ac 0a 09 09 72 73 69 20  3a 3d 20 62 65 2e 63 61   ....rsi := be.ca
19630	6c 63 75 6c 61 74 65 52  53 49 46 6f 72 50 72 69   lculateRSIForPri
19640	63 65 73 28 70 72 69 63  65 73 2c 20 31 34 29 0a   ces(prices, 14).
19650	0a 09 09 2f 2f 20 e8 b6  85 e4 b9 b0 20 2b 20 e7   ...// ...... + .
19660	9f ad e6 9c 9f e4 b8 8b  e8 b7 8c e5 8a a8 e9 87   ................
19670	8f 20 e2 86 92 20 e5 8d  96 e5 87 ba e6 9c ba e4   . ... ..........
19680	bc 9a 0a 09 09 69 66 20  72 73 69 20 3e 20 37 30   .....if rsi > 70
19690	20 26 26 20 73 68 6f 72  74 54 65 72 6d 4d 6f 6d    && shortTermMom
196a0	65 6e 74 75 6d 20 3c 20  2d 30 2e 30 32 20 26 26   entum < -0.02 &&
196b0	20 6c 6f 6e 67 54 65 72  6d 54 72 65 6e 64 20 3e    longTermTrend >
196c0	20 30 2e 30 35 20 7b 0a  09 09 09 6f 70 70 6f 72    0.05 {....oppor
196d0	74 75 6e 69 74 79 20 3a  3d 20 26 41 72 62 69 74   tunity := &Arbit
196e0	72 61 67 65 4f 70 70 6f  72 74 75 6e 69 74 79 7b   rageOpportunity{
196f0	0a 09 09 09 09 54 79 70  65 3a 20 20 20 20 20 20   .....Type:      
19700	20 20 20 20 20 22 74 65  6d 70 6f 72 61 6c 5f 72        "temporal_r
19710	65 76 65 72 73 61 6c 22  2c 0a 09 09 09 09 50 72   eversal",.....Pr
19720	69 6d 61 72 79 53 79 6d  62 6f 6c 3a 20 20 73 79   imarySymbol:  sy
19730	6d 62 6f 6c 2c 0a 09 09  09 09 44 69 72 65 63 74   mbol,.....Direct
19740	69 6f 6e 3a 20 20 20 20  20 20 22 73 65 6c 6c 22   ion:      "sell"
19750	2c 0a 09 09 09 09 45 78  70 65 63 74 65 64 52 65   ,.....ExpectedRe
19760	74 75 72 6e 3a 20 30 2e  30 33 2c 20 2f 2f 20 e9   turn: 0.03, // .
19770	a2 84 e6 9c 9f 33 25 e7  9a 84 e5 8f 8d e8 bd ac   .....3%.........
19780	e6 94 b6 e7 9b 8a 0a 09  09 09 09 43 6f 6e 66 69   ...........Confi
19790	64 65 6e 63 65 3a 20 20  20 20 20 30 2e 37 2c 0a   dence:     0.7,.
197a0	09 09 09 09 52 53 49 3a  20 20 20 20 20 20 20 20   ....RSI:        
197b0	20 20 20 20 72 73 69 2c  0a 09 09 09 09 4d 6f 6d       rsi,.....Mom
197c0	65 6e 74 75 6d 3a 20 20  20 20 20 20 20 73 68 6f   entum:       sho
197d0	72 74 54 65 72 6d 4d 6f  6d 65 6e 74 75 6d 2c 0a   rtTermMomentum,.
197e0	09 09 09 09 54 69 6d 65  48 6f 72 69 7a 6f 6e 3a   ....TimeHorizon:
197f0	20 20 20 20 32 2c 0a 09  09 09 09 52 69 73 6b 4c       2,.....RiskL
19800	65 76 65 6c 3a 20 20 20  20 20 20 22 6d 65 64 69   evel:      "medi
19810	75 6d 22 2c 0a 09 09 09  7d 0a 09 09 09 6f 70 70   um",....}....opp
19820	6f 72 74 75 6e 69 74 69  65 73 20 3d 20 61 70 70   ortunities = app
19830	65 6e 64 28 6f 70 70 6f  72 74 75 6e 69 74 69 65   end(opportunitie
19840	73 2c 20 6f 70 70 6f 72  74 75 6e 69 74 79 29 0a   s, opportunity).
19850	09 09 7d 0a 0a 09 09 2f  2f 20 e8 b6 85 e5 8d 96   ..}....// ......
19860	20 2b 20 e7 9f ad e6 9c  9f e4 b8 8a e6 b6 a8 e5    + .............
19870	8a a8 e9 87 8f 20 e2 86  92 20 e4 b9 b0 e5 85 a5   ..... ... ......
19880	e6 9c ba e4 bc 9a 0a 09  09 69 66 20 72 73 69 20   .........if rsi 
19890	3c 20 33 30 20 26 26 20  73 68 6f 72 74 54 65 72   < 30 && shortTer
198a0	6d 4d 6f 6d 65 6e 74 75  6d 20 3e 20 30 2e 30 32   mMomentum > 0.02
198b0	20 26 26 20 6c 6f 6e 67  54 65 72 6d 54 72 65 6e    && longTermTren
198c0	64 20 3c 20 2d 30 2e 30  35 20 7b 0a 09 09 09 6f   d < -0.05 {....o
198d0	70 70 6f 72 74 75 6e 69  74 79 20 3a 3d 20 26 41   pportunity := &A
198e0	72 62 69 74 72 61 67 65  4f 70 70 6f 72 74 75 6e   rbitrageOpportun
198f0	69 74 79 7b 0a 09 09 09  09 54 79 70 65 3a 20 20   ity{.....Type:  
19900	20 20 20 20 20 20 20 20  20 22 74 65 6d 70 6f 72            "tempor
19910	61 6c 5f 72 65 76 65 72  73 61 6c 22 2c 0a 09 09   al_reversal",...
19920	09 09 50 72 69 6d 61 72  79 53 79 6d 62 6f 6c 3a   ..PrimarySymbol:
19930	20 20 73 79 6d 62 6f 6c  2c 0a 09 09 09 09 44 69     symbol,.....Di
19940	72 65 63 74 69 6f 6e 3a  20 20 20 20 20 20 22 62   rection:      "b
19950	75 79 22 2c 0a 09 09 09  09 45 78 70 65 63 74 65   uy",.....Expecte
19960	64 52 65 74 75 72 6e 3a  20 30 2e 30 33 2c 0a 09   dReturn: 0.03,..
19970	09 09 09 43 6f 6e 66 69  64 65 6e 63 65 3a 20 20   ...Confidence:  
19980	20 20 20 30 2e 37 2c 0a  09 09 09 09 52 53 49 3a      0.7,.....RSI:
19990	20 20 20 20 20 20 20 20  20 20 20 20 72 73 69 2c               rsi,
199a0	0a 09 09 09 09 4d 6f 6d  65 6e 74 75 6d 3a 20 20   .....Momentum:  
199b0	20 20 20 20 20 73 68 6f  72 74 54 65 72 6d 4d 6f        shortTermMo
199c0	6d 65 6e 74 75 6d 2c 0a  09 09 09 09 54 69 6d 65   mentum,.....Time
199d0	48 6f 72 69 7a 6f 6e 3a  20 20 20 20 32 2c 0a 09   Horizon:    2,..
199e0	09 09 09 52 69 73 6b 4c  65 76 65 6c 3a 20 20 20   ...RiskLevel:   
199f0	20 20 20 22 6d 65 64 69  75 6d 22 2c 0a 09 09 09      "medium",....
19a00	7d 0a 09 09 09 6f 70 70  6f 72 74 75 6e 69 74 69   }....opportuniti
19a10	65 73 20 3d 20 61 70 70  65 6e 64 28 6f 70 70 6f   es = append(oppo
19a20	72 74 75 6e 69 74 69 65  73 2c 20 6f 70 70 6f 72   rtunities, oppor
19a30	74 75 6e 69 74 79 29 0a  09 09 7d 0a 09 7d 0a 0a   tunity)...}..}..
19a40	09 72 65 74 75 72 6e 20  6f 70 70 6f 72 74 75 6e   .return opportun
19a50	69 74 69 65 73 0a 7d 0a  0a 2f 2f 20 63 6f 6e 76   ities.}..// conv
19a60	65 72 74 41 72 62 69 74  72 61 67 65 54 6f 54 72   ertArbitrageToTr
19a70	61 64 65 4f 70 70 6f 72  74 75 6e 69 74 69 65 73   adeOpportunities
19a80	20 e5 b0 86 e5 a5 97 e5  88 a9 e6 9c ba e4 bc 9a    ...............
19a90	e8 bd ac e6 8d a2 e4 b8  ba e4 ba a4 e6 98 93 e6   ................
19aa0	9c ba e4 bc 9a 0a 66 75  6e 63 20 28 62 65 20 2a   ......func (be *
19ab0	42 61 63 6b 74 65 73 74  45 6e 67 69 6e 65 29 20   BacktestEngine) 
19ac0	63 6f 6e 76 65 72 74 41  72 62 69 74 72 61 67 65   convertArbitrage
19ad0	54 6f 54 72 61 64 65 4f  70 70 6f 72 74 75 6e 69   ToTradeOpportuni
19ae0	74 69 65 73 28 61 72 62  69 74 72 61 67 65 4f 70   ties(arbitrageOp
19af0	70 6f 72 74 75 6e 69 74  69 65 73 20 5b 5d 2a 41   portunities []*A
19b00	72 62 69 74 72 61 67 65  4f 70 70 6f 72 74 75 6e   rbitrageOpportun
19b10	69 74 79 2c 20 73 79 6d  62 6f 6c 53 74 61 74 65   ity, symbolState
19b20	73 20 6d 61 70 5b 73 74  72 69 6e 67 5d 2a 53 79   s map[string]*Sy
19b30	6d 62 6f 6c 53 74 61 74  65 2c 20 63 75 72 72 65   mbolState, curre
19b40	6e 74 49 6e 64 65 78 20  69 6e 74 29 20 5b 5d 2a   ntIndex int) []*
19b50	53 79 6d 62 6f 6c 4f 70  70 6f 72 74 75 6e 69 74   SymbolOpportunit
19b60	79 20 7b 0a 09 76 61 72  20 74 72 61 64 65 4f 70   y {..var tradeOp
19b70	70 6f 72 74 75 6e 69 74  69 65 73 20 5b 5d 2a 53   portunities []*S
19b80	79 6d 62 6f 6c 4f 70 70  6f 72 74 75 6e 69 74 79   ymbolOpportunity
19b90	0a 0a 09 66 6f 72 20 5f  2c 20 61 72 62 4f 70 70   ...for _, arbOpp
19ba0	20 3a 3d 20 72 61 6e 67  65 20 61 72 62 69 74 72    := range arbitr
19bb0	61 67 65 4f 70 70 6f 72  74 75 6e 69 74 69 65 73   ageOpportunities
19bc0	20 7b 0a 09 09 2f 2f 20  e6 94 be e5 ae bd e5 a5    {...// ........
19bd0	97 e5 88 a9 e6 9c ba e4  bc 9a e9 aa 8c e8 af 81   ................
19be0	e6 9d a1 e4 bb b6 ef bc  8c e8 ae a9 e6 9b b4 e5   ................
19bf0	a4 9a e6 9c ba e4 bc 9a  e8 a2 ab e6 89 a7 e8 a1   ................
19c00	8c 0a 09 09 69 66 20 61  72 62 4f 70 70 2e 43 6f   ....if arbOpp.Co
19c10	6e 66 69 64 65 6e 63 65  20 3c 20 30 2e 34 20 7b   nfidence < 0.4 {
19c20	20 2f 2f 20 e9 99 8d e4  bd 8e e7 bd ae e4 bf a1    // ............
19c30	e5 ba a6 e8 a6 81 e6 b1  82 0a 09 09 09 63 6f 6e   .............con
19c40	74 69 6e 75 65 0a 09 09  7d 0a 09 09 69 66 20 61   tinue...}...if a
19c50	72 62 4f 70 70 2e 45 78  70 65 63 74 65 64 52 65   rbOpp.ExpectedRe
19c60	74 75 72 6e 20 3c 20 30  2e 30 30 38 20 7b 20 2f   turn < 0.008 { /
19c70	2f 20 e9 99 8d e4 bd 8e  e9 a2 84 e6 9c 9f e6 94   / ..............
19c80	b6 e7 9b 8a e8 a6 81 e6  b1 82 e5 88 b0 30 2e 38   .............0.8
19c90	25 0a 09 09 09 63 6f 6e  74 69 6e 75 65 0a 09 09   %....continue...
19ca0	7d 0a 0a 09 09 2f 2f 20  e6 a3 80 e6 9f a5 e6 97   }....// ........
19cb0	b6 e9 97 b4 e7 aa 97 e5  8f a3 e6 98 af e5 90 a6   ................
19cc0	e5 90 88 e7 90 86 ef bc  88 e9 81 bf e5 85 8d e8   ................
19cd0	bf 87 e7 9f ad e6 88 96  e8 bf 87 e9 95 bf e7 9a   ................
19ce0	84 e5 a5 97 e5 88 a9 e6  9c ba e4 bc 9a ef bc 89   ................
19cf0	0a 09 09 69 66 20 61 72  62 4f 70 70 2e 54 69 6d   ...if arbOpp.Tim
19d00	65 48 6f 72 69 7a 6f 6e  20 3c 20 31 20 7c 7c 20   eHorizon < 1 || 
19d10	61 72 62 4f 70 70 2e 54  69 6d 65 48 6f 72 69 7a   arbOpp.TimeHoriz
19d20	6f 6e 20 3e 20 37 32 20  7b 20 2f 2f 20 e6 89 a9   on > 72 { // ...
19d30	e5 a4 a7 e6 97 b6 e9 97  b4 e7 aa 97 e5 8f a3 e8   ................
19d40	8c 83 e5 9b b4 0a 09 09  09 63 6f 6e 74 69 6e 75   .........continu
19d50	65 0a 09 09 7d 0a 0a 09  09 2f 2f 20 e6 94 be e5   e...}....// ....
19d60	ae bd e5 a5 97 e5 88 a9  e7 b1 bb e5 9e 8b e9 aa   ................
19d70	8c e8 af 81 e6 9d a1 e4  bb b6 0a 09 09 69 66 20   .............if 
19d80	61 72 62 4f 70 70 2e 54  79 70 65 20 3d 3d 20 22   arbOpp.Type == "
19d90	73 74 61 74 69 73 74 69  63 61 6c 22 20 26 26 20   statistical" && 
19da0	6d 61 74 68 2e 41 62 73  28 61 72 62 4f 70 70 2e   math.Abs(arbOpp.
19db0	5a 53 63 6f 72 65 29 20  3c 20 31 2e 38 20 7b 20   ZScore) < 1.8 { 
19dc0	2f 2f 20 e9 99 8d e4 bd  8e e7 bb 9f e8 ae a1 e5   // .............
19dd0	a5 97 e5 88 a9 5a 2d 53  63 6f 72 65 e8 a6 81 e6   .....Z-Score....
19de0	b1 82 0a 09 09 09 63 6f  6e 74 69 6e 75 65 0a 09   ......continue..
19df0	09 7d 0a 09 09 69 66 20  61 72 62 4f 70 70 2e 54   .}...if arbOpp.T
19e00	79 70 65 20 3d 3d 20 22  63 6f 72 72 65 6c 61 74   ype == "correlat
19e10	69 6f 6e 22 20 26 26 20  6d 61 74 68 2e 41 62 73   ion" && math.Abs
19e20	28 61 72 62 4f 70 70 2e  44 65 76 69 61 74 69 6f   (arbOpp.Deviatio
19e30	6e 29 20 3c 20 30 2e 30  32 20 7b 20 2f 2f 20 e9   n) < 0.02 { // .
19e40	99 8d e4 bd 8e e7 9b b8  e5 85 b3 e6 80 a7 e5 a5   ................
19e50	97 e5 88 a9 e5 81 8f e5  b7 ae e8 a6 81 e6 b1 82   ................
19e60	0a 09 09 09 63 6f 6e 74  69 6e 75 65 0a 09 09 7d   ....continue...}
19e70	0a 0a 09 09 73 74 61 74  65 2c 20 65 78 69 73 74   ....state, exist
19e80	73 20 3a 3d 20 73 79 6d  62 6f 6c 53 74 61 74 65   s := symbolState
19e90	73 5b 61 72 62 4f 70 70  2e 50 72 69 6d 61 72 79   s[arbOpp.Primary
19ea0	53 79 6d 62 6f 6c 5d 0a  09 09 69 66 20 21 65 78   Symbol]...if !ex
19eb0	69 73 74 73 20 7c 7c 20  63 75 72 72 65 6e 74 49   ists || currentI
19ec0	6e 64 65 78 20 3e 3d 20  6c 65 6e 28 73 74 61 74   ndex >= len(stat
19ed0	65 2e 44 61 74 61 29 20  7b 0a 09 09 09 63 6f 6e   e.Data) {....con
19ee0	74 69 6e 75 65 0a 09 09  7d 0a 0a 09 09 2f 2f 20   tinue...}....// 
19ef0	e6 a3 80 e6 9f a5 e6 98  af e5 90 a6 e5 b7 b2 e6   ................
19f00	9c 89 e6 8c 81 e4 bb 93  ef bc 88 e5 a5 97 e5 88   ................
19f10	a9 e6 9c ba e4 bc 9a e5  8f af e8 83 bd e9 9c 80   ................
19f20	e8 a6 81 e4 b8 8d e5 90  8c e7 9a 84 e5 a4 84 e7   ................
19f30	90 86 ef bc 89 0a 09 09  68 61 73 50 6f 73 69 74   ........hasPosit
19f40	69 6f 6e 20 3a 3d 20 73  74 61 74 65 2e 50 6f 73   ion := state.Pos
19f50	69 74 69 6f 6e 20 3e 20  30 0a 09 09 69 66 20 68   ition > 0...if h
19f60	61 73 50 6f 73 69 74 69  6f 6e 20 26 26 20 61 72   asPosition && ar
19f70	62 4f 70 70 2e 44 69 72  65 63 74 69 6f 6e 20 3d   bOpp.Direction =
19f80	3d 20 22 62 75 79 22 20  7b 0a 09 09 09 63 6f 6e   = "buy" {....con
19f90	74 69 6e 75 65 20 2f 2f  20 e5 a6 82 e6 9e 9c e5   tinue // .......
19fa0	b7 b2 e6 9c 89 e6 8c 81  e4 bb 93 ef bc 8c e4 b8   ................
19fb0	8d e5 86 8d e4 b9 b0 e5  85 a5 0a 09 09 7d 0a 09   .............}..
19fc0	09 69 66 20 21 68 61 73  50 6f 73 69 74 69 6f 6e   .if !hasPosition
19fd0	20 26 26 20 61 72 62 4f  70 70 2e 44 69 72 65 63    && arbOpp.Direc
19fe0	74 69 6f 6e 20 3d 3d 20  22 73 65 6c 6c 22 20 7b   tion == "sell" {
19ff0	0a 09 09 09 63 6f 6e 74  69 6e 75 65 20 2f 2f 20   ....continue // 
1a000	e5 a6 82 e6 9e 9c e6 b2  a1 e6 9c 89 e6 8c 81 e4   ................
1a010	bb 93 ef bc 8c e4 b8 8d  e8 83 bd e5 8d 96 e5 87   ................
1a020	ba 0a 09 09 7d 0a 0a 09  09 2f 2f 20 e8 bd ac e6   ....}....// ....
1a030	8d a2 61 63 74 69 6f 6e  0a 09 09 61 63 74 69 6f   ..action...actio
1a040	6e 20 3a 3d 20 22 62 75  79 22 0a 09 09 69 66 20   n := "buy"...if 
1a050	61 72 62 4f 70 70 2e 44  69 72 65 63 74 69 6f 6e   arbOpp.Direction
1a060	20 3d 3d 20 22 73 65 6c  6c 22 20 7b 0a 09 09 09    == "sell" {....
1a070	61 63 74 69 6f 6e 20 3d  20 22 73 65 6c 6c 22 0a   action = "sell".
1a080	09 09 7d 0a 0a 09 09 2f  2f 20 e8 ae a1 e7 ae 97   ..}....// ......
1a090	e6 9c ba e4 bc 9a e8 af  84 e5 88 86 ef bc 88 e5   ................
1a0a0	9f ba e4 ba 8e e9 a2 84  e6 9c 9f e6 94 b6 e7 9b   ................
1a0b0	8a e5 92 8c e7 bd ae e4  bf a1 e5 ba a6 ef bc 89   ................
1a0c0	0a 09 09 73 63 6f 72 65  20 3a 3d 20 61 72 62 4f   ...score := arbO
1a0d0	70 70 2e 45 78 70 65 63  74 65 64 52 65 74 75 72   pp.ExpectedRetur
1a0e0	6e 20 2a 20 61 72 62 4f  70 70 2e 43 6f 6e 66 69   n * arbOpp.Confi
1a0f0	64 65 6e 63 65 20 2a 20  31 30 30 20 2f 2f 20 e6   dence * 100 // .
1a100	94 be e5 a4 a7 e5 88 b0  30 2d 31 30 30 e8 8c 83   ........0-100...
1a110	e5 9b b4 0a 0a 09 09 6f  70 70 6f 72 74 75 6e 69   .......opportuni
1a120	74 79 20 3a 3d 20 26 53  79 6d 62 6f 6c 4f 70 70   ty := &SymbolOpp
1a130	6f 72 74 75 6e 69 74 79  7b 0a 09 09 09 53 79 6d   ortunity{....Sym
1a140	62 6f 6c 3a 20 20 20 20  20 20 20 20 20 61 72 62   bol:         arb
1a150	4f 70 70 2e 50 72 69 6d  61 72 79 53 79 6d 62 6f   Opp.PrimarySymbo
1a160	6c 2c 0a 09 09 09 41 63  74 69 6f 6e 3a 20 20 20   l,....Action:   
1a170	20 20 20 20 20 20 61 63  74 69 6f 6e 2c 0a 09 09         action,...
1a180	09 43 6f 6e 66 69 64 65  6e 63 65 3a 20 20 20 20   .Confidence:    
1a190	20 61 72 62 4f 70 70 2e  43 6f 6e 66 69 64 65 6e    arbOpp.Confiden
1a1a0	63 65 2c 0a 09 09 09 42  61 73 65 53 63 6f 72 65   ce,....BaseScore
1a1b0	3a 20 20 20 20 20 20 73  63 6f 72 65 2c 0a 09 09   :      score,...
1a1c0	09 53 63 6f 72 65 3a 20  20 20 20 20 20 20 20 20   .Score:         
1a1d0	20 73 63 6f 72 65 2c 0a  09 09 09 50 72 69 63 65    score,....Price
1a1e0	3a 20 20 20 20 20 20 20  20 20 20 73 74 61 74 65   :          state
1a1f0	2e 44 61 74 61 5b 63 75  72 72 65 6e 74 49 6e 64   .Data[currentInd
1a200	65 78 5d 2e 50 72 69 63  65 2c 0a 09 09 09 53 74   ex].Price,....St
1a210	61 74 65 3a 20 20 20 20  20 20 20 20 20 20 73 74   ate:          st
1a220	61 74 65 2c 0a 09 09 09  46 65 61 74 75 72 65 73   ate,....Features
1a230	3a 20 20 20 20 20 20 20  6d 61 6b 65 28 6d 61 70   :       make(map
1a240	5b 73 74 72 69 6e 67 5d  66 6c 6f 61 74 36 34 29   [string]float64)
1a250	2c 20 2f 2f 20 e5 a5 97  e5 88 a9 e6 9c ba e4 bc   , // ...........
1a260	9a e5 8f af e8 83 bd e6  b2 a1 e6 9c 89 e5 ae 8c   ................
1a270	e6 95 b4 e7 9a 84 e7 89  b9 e5 be 81 0a 09 09 09   ................
1a280	52 69 73 6b 53 63 6f 72  65 3a 20 20 20 20 20 20   RiskScore:      
1a290	62 65 2e 63 61 6c 63 75  6c 61 74 65 41 72 62 69   be.calculateArbi
1a2a0	74 72 61 67 65 52 69 73  6b 53 63 6f 72 65 28 61   trageRiskScore(a
1a2b0	72 62 4f 70 70 29 2c 0a  09 09 09 4d 61 72 6b 65   rbOpp),....Marke
1a2c0	74 53 63 6f 72 65 3a 20  20 20 20 30 2e 39 2c 20   tScore:    0.9, 
1a2d0	2f 2f 20 e6 8f 90 e9 ab  98 e5 a5 97 e5 88 a9 e6   // .............
1a2e0	9c ba e4 bc 9a e7 9a 84  e5 b8 82 e5 9c ba e9 80   ................
1a2f0	82 e5 ba 94 e6 80 a7 e8  af 84 e5 88 86 0a 09 09   ................
1a300	09 52 69 73 6b 41 64 6a  75 73 74 6d 65 6e 74 3a   .RiskAdjustment:
1a310	20 30 2e 38 2c 20 2f 2f  20 e9 99 8d e4 bd 8e e9    0.8, // .......
1a320	a3 8e e9 99 a9 e8 b0 83  e6 95 b4 e5 9b a0 e5 ad   ................
1a330	90 ef bc 8c e5 a2 9e e5  8a a0 e5 a5 97 e5 88 a9   ................
1a340	e6 9c ba e4 bc 9a e6 9d  83 e9 87 8d 0a 09 09 09   ................
1a350	52 65 61 73 6f 6e 3a 20  20 20 20 20 20 20 20 20   Reason:         
1a360	61 72 62 4f 70 70 2e 54  79 70 65 2c 0a 09 09 7d   arbOpp.Type,...}
1a370	0a 0a 09 09 2f 2f 20 e6  b7 bb e5 8a a0 e5 a5 97   ....// .........
1a380	e5 88 a9 e7 89 b9 e5 ae  9a e7 9a 84 e7 89 b9 e5   ................
1a390	be 81 0a 09 09 6f 70 70  6f 72 74 75 6e 69 74 79   .....opportunity
1a3a0	2e 46 65 61 74 75 72 65  73 5b 22 61 72 62 69 74   .Features["arbit
1a3b0	72 61 67 65 5f 74 79 70  65 22 5d 20 3d 20 62 65   rage_type"] = be
1a3c0	2e 65 6e 63 6f 64 65 41  72 62 69 74 72 61 67 65   .encodeArbitrage
1a3d0	54 79 70 65 28 61 72 62  4f 70 70 2e 54 79 70 65   Type(arbOpp.Type
1a3e0	29 0a 09 09 6f 70 70 6f  72 74 75 6e 69 74 79 2e   )...opportunity.
1a3f0	46 65 61 74 75 72 65 73  5b 22 65 78 70 65 63 74   Features["expect
1a400	65 64 5f 72 65 74 75 72  6e 22 5d 20 3d 20 61 72   ed_return"] = ar
1a410	62 4f 70 70 2e 45 78 70  65 63 74 65 64 52 65 74   bOpp.ExpectedRet
1a420	75 72 6e 0a 09 09 6f 70  70 6f 72 74 75 6e 69 74   urn...opportunit
1a430	79 2e 46 65 61 74 75 72  65 73 5b 22 74 69 6d 65   y.Features["time
1a440	5f 68 6f 72 69 7a 6f 6e  22 5d 20 3d 20 66 6c 6f   _horizon"] = flo
1a450	61 74 36 34 28 61 72 62  4f 70 70 2e 54 69 6d 65   at64(arbOpp.Time
1a460	48 6f 72 69 7a 6f 6e 29  0a 0a 09 09 74 72 61 64   Horizon)....trad
1a470	65 4f 70 70 6f 72 74 75  6e 69 74 69 65 73 20 3d   eOpportunities =
1a480	20 61 70 70 65 6e 64 28  74 72 61 64 65 4f 70 70    append(tradeOpp
1a490	6f 72 74 75 6e 69 74 69  65 73 2c 20 6f 70 70 6f   ortunities, oppo
1a4a0	72 74 75 6e 69 74 79 29  0a 0a 09 09 6c 6f 67 2e   rtunity)....log.
1a4b0	50 72 69 6e 74 66 28 22  5b 41 52 42 49 54 52 41   Printf("[ARBITRA
1a4c0	47 45 5f 43 4f 4e 56 45  52 53 49 4f 4e 5d 20 e8   GE_CONVERSION] .
1a4d0	bd ac e6 8d a2 e5 a5 97  e5 88 a9 e6 9c ba e4 bc   ................
1a4e0	9a 3a 20 25 73 20 25 73  2c 20 e7 b1 bb e5 9e 8b   .: %s %s, ......
1a4f0	3d 25 73 2c 20 e9 a2 84  e6 9c 9f e6 94 b6 e7 9b   =%s, ...........
1a500	8a 3d 25 2e 33 66 2c 20  e7 bd ae e4 bf a1 e5 ba   .=%.3f, ........
1a510	a6 3d 25 2e 33 66 22 2c  0a 09 09 09 61 72 62 4f   .=%.3f",....arbO
1a520	70 70 2e 50 72 69 6d 61  72 79 53 79 6d 62 6f 6c   pp.PrimarySymbol
1a530	2c 20 61 72 62 4f 70 70  2e 44 69 72 65 63 74 69   , arbOpp.Directi
1a540	6f 6e 2c 20 61 72 62 4f  70 70 2e 54 79 70 65 2c   on, arbOpp.Type,
1a550	20 61 72 62 4f 70 70 2e  45 78 70 65 63 74 65 64    arbOpp.Expected
1a560	52 65 74 75 72 6e 2c 20  61 72 62 4f 70 70 2e 43   Return, arbOpp.C
1a570	6f 6e 66 69 64 65 6e 63  65 29 0a 09 7d 0a 0a 09   onfidence)..}...
1a580	72 65 74 75 72 6e 20 74  72 61 64 65 4f 70 70 6f   return tradeOppo
1a590	72 74 75 6e 69 74 69 65  73 0a 7d 0a 0a 2f 2f 20   rtunities.}..// 
1a5a0	65 6e 63 6f 64 65 41 72  62 69 74 72 61 67 65 54   encodeArbitrageT
1a5b0	79 70 65 20 e5 b0 86 e5  a5 97 e5 88 a9 e7 b1 bb   ype ............
1a5c0	e5 9e 8b e7 bc 96 e7 a0  81 e4 b8 ba e6 95 b0 e5   ................
1a5d0	80 bc 0a 66 75 6e 63 20  28 62 65 20 2a 42 61 63   ...func (be *Bac
1a5e0	6b 74 65 73 74 45 6e 67  69 6e 65 29 20 65 6e 63   ktestEngine) enc
1a5f0	6f 64 65 41 72 62 69 74  72 61 67 65 54 79 70 65   odeArbitrageType
1a600	28 61 72 62 54 79 70 65  20 73 74 72 69 6e 67 29   (arbType string)
1a610	20 66 6c 6f 61 74 36 34  20 7b 0a 09 73 77 69 74    float64 {..swit
1a620	63 68 20 61 72 62 54 79  70 65 20 7b 0a 09 63 61   ch arbType {..ca
1a630	73 65 20 22 73 74 61 74  69 73 74 69 63 61 6c 22   se "statistical"
1a640	3a 0a 09 09 72 65 74 75  72 6e 20 31 2e 30 0a 09   :...return 1.0..
1a650	63 61 73 65 20 22 63 6f  72 72 65 6c 61 74 69 6f   case "correlatio
1a660	6e 22 3a 0a 09 09 72 65  74 75 72 6e 20 32 2e 30   n":...return 2.0
1a670	0a 09 63 61 73 65 20 22  74 65 6d 70 6f 72 61 6c   ..case "temporal
1a680	5f 72 65 76 65 72 73 61  6c 22 3a 0a 09 09 72 65   _reversal":...re
1a690	74 75 72 6e 20 33 2e 30  0a 09 64 65 66 61 75 6c   turn 3.0..defaul
1a6a0	74 3a 0a 09 09 72 65 74  75 72 6e 20 30 2e 30 0a   t:...return 0.0.
1a6b0	09 7d 0a 7d 0a 0a 2f 2f  20 63 61 6c 63 75 6c 61   .}.}..// calcula
1a6c0	74 65 41 72 62 69 74 72  61 67 65 52 69 73 6b 53   teArbitrageRiskS
1a6d0	63 6f 72 65 20 e8 ae a1  e7 ae 97 e5 a5 97 e5 88   core ...........
1a6e0	a9 e9 a3 8e e9 99 a9 e8  af 84 e5 88 86 0a 66 75   ..............fu
1a6f0	6e 63 20 28 62 65 20 2a  42 61 63 6b 74 65 73 74   nc (be *Backtest
1a700	45 6e 67 69 6e 65 29 20  63 61 6c 63 75 6c 61 74   Engine) calculat
1a710	65 41 72 62 69 74 72 61  67 65 52 69 73 6b 53 63   eArbitrageRiskSc
1a720	6f 72 65 28 61 72 62 4f  70 70 20 2a 41 72 62 69   ore(arbOpp *Arbi
1a730	74 72 61 67 65 4f 70 70  6f 72 74 75 6e 69 74 79   trageOpportunity
1a740	29 20 66 6c 6f 61 74 36  34 20 7b 0a 09 62 61 73   ) float64 {..bas
1a750	65 52 69 73 6b 20 3a 3d  20 30 2e 33 20 2f 2f 20   eRisk := 0.3 // 
1a760	e5 a5 97 e5 88 a9 e9 80  9a e5 b8 b8 e9 a3 8e e9   ................
1a770	99 a9 e8 be 83 e4 bd 8e  0a 0a 09 2f 2f 20 e6 a0   ...........// ..
1a780	b9 e6 8d ae e9 a3 8e e9  99 a9 e7 ad 89 e7 ba a7   ................
1a790	e8 b0 83 e6 95 b4 0a 09  73 77 69 74 63 68 20 61   ........switch a
1a7a0	72 62 4f 70 70 2e 52 69  73 6b 4c 65 76 65 6c 20   rbOpp.RiskLevel 
1a7b0	7b 0a 09 63 61 73 65 20  22 6c 6f 77 22 3a 0a 09   {..case "low":..
1a7c0	09 62 61 73 65 52 69 73  6b 20 3d 20 30 2e 32 0a   .baseRisk = 0.2.
1a7d0	09 63 61 73 65 20 22 6d  65 64 69 75 6d 22 3a 0a   .case "medium":.
1a7e0	09 09 62 61 73 65 52 69  73 6b 20 3d 20 30 2e 34   ..baseRisk = 0.4
1a7f0	0a 09 63 61 73 65 20 22  68 69 67 68 22 3a 0a 09   ..case "high":..
1a800	09 62 61 73 65 52 69 73  6b 20 3d 20 30 2e 36 0a   .baseRisk = 0.6.
1a810	09 7d 0a 0a 09 2f 2f 20  e6 a0 b9 e6 8d ae e5 a5   .}...// ........
1a820	97 e5 88 a9 e7 b1 bb e5  9e 8b e8 b0 83 e6 95 b4   ................
1a830	0a 09 73 77 69 74 63 68  20 61 72 62 4f 70 70 2e   ..switch arbOpp.
1a840	54 79 70 65 20 7b 0a 09  63 61 73 65 20 22 73 74   Type {..case "st
1a850	61 74 69 73 74 69 63 61  6c 22 3a 0a 09 09 62 61   atistical":...ba
1a860	73 65 52 69 73 6b 20 2a  3d 20 31 2e 32 20 2f 2f   seRisk *= 1.2 //
1a870	20 e7 bb 9f e8 ae a1 e5  a5 97 e5 88 a9 e9 a3 8e    ...............
1a880	e9 99 a9 e7 a8 8d e9 ab  98 0a 09 63 61 73 65 20   ...........case 
1a890	22 63 6f 72 72 65 6c 61  74 69 6f 6e 22 3a 0a 09   "correlation":..
1a8a0	09 62 61 73 65 52 69 73  6b 20 2a 3d 20 30 2e 38   .baseRisk *= 0.8
1a8b0	20 2f 2f 20 e7 9b b8 e5  85 b3 e6 80 a7 e5 a5 97    // ............
1a8c0	e5 88 a9 e9 a3 8e e9 99  a9 e8 be 83 e4 bd 8e 0a   ................
1a8d0	09 63 61 73 65 20 22 74  65 6d 70 6f 72 61 6c 5f   .case "temporal_
1a8e0	72 65 76 65 72 73 61 6c  22 3a 0a 09 09 62 61 73   reversal":...bas
1a8f0	65 52 69 73 6b 20 2a 3d  20 31 2e 30 20 2f 2f 20   eRisk *= 1.0 // 
1a900	e6 97 b6 e9 97 b4 e5 8f  8d e8 bd ac e9 a3 8e e9   ................
1a910	99 a9 e4 b8 ad e7 ad 89  0a 09 7d 0a 0a 09 2f 2f   ..........}...//
1a920	20 e6 a0 b9 e6 8d ae e6  97 b6 e9 97 b4 e8 b7 a8    ...............
1a930	e5 ba a6 e8 b0 83 e6 95  b4 ef bc 88 e6 97 b6 e9   ................
1a940	97 b4 e8 b6 8a e9 95 bf  ef bc 8c e9 a3 8e e9 99   ................
1a950	a9 e8 b6 8a e9 ab 98 ef  bc 89 0a 09 74 69 6d 65   ............time
1a960	52 69 73 6b 20 3a 3d 20  66 6c 6f 61 74 36 34 28   Risk := float64(
1a970	61 72 62 4f 70 70 2e 54  69 6d 65 48 6f 72 69 7a   arbOpp.TimeHoriz
1a980	6f 6e 29 20 2f 20 31 30  2e 30 0a 09 62 61 73 65   on) / 10.0..base
1a990	52 69 73 6b 20 2b 3d 20  74 69 6d 65 52 69 73 6b   Risk += timeRisk
1a9a0	20 2a 20 30 2e 31 0a 0a  09 72 65 74 75 72 6e 20    * 0.1...return 
1a9b0	6d 61 74 68 2e 4d 69 6e  28 62 61 73 65 52 69 73   math.Min(baseRis
1a9c0	6b 2c 20 30 2e 39 29 20  2f 2f 20 e6 9c 80 e5 a4   k, 0.9) // .....
1a9d0	a7 e9 a3 8e e9 99 a9 30  2e 39 0a 7d 0a 0a 2f 2f   .......0.9.}..//
1a9e0	20 73 65 6c 65 63 74 42  65 73 74 4f 76 65 72 61    selectBestOvera
1a9f0	6c 6c 4f 70 70 6f 72 74  75 6e 69 74 79 20 e4 bb   llOpportunity ..
1aa00	8e e6 89 80 e6 9c 89 e6  9c ba e4 bc 9a e4 b8 ad   ................
1aa10	e9 80 89 e6 8b a9 e6 9c  80 e4 bd b3 e7 9a 84 ef   ................
1aa20	bc 88 e5 a2 9e e5 bc ba  e4 b8 80 e8 87 b4 e6 80   ................
1aa30	a7 ef bc 89 0a 66 75 6e  63 20 28 62 65 20 2a 42   .....func (be *B
1aa40	61 63 6b 74 65 73 74 45  6e 67 69 6e 65 29 20 73   acktestEngine) s
1aa50	65 6c 65 63 74 42 65 73  74 4f 76 65 72 61 6c 6c   electBestOverall
1aa60	4f 70 70 6f 72 74 75 6e  69 74 79 28 61 6c 6c 4f   Opportunity(allO
1aa70	70 70 6f 72 74 75 6e 69  74 69 65 73 20 5b 5d 2a   pportunities []*
1aa80	53 79 6d 62 6f 6c 4f 70  70 6f 72 74 75 6e 69 74   SymbolOpportunit
1aa90	79 2c 20 73 79 6d 62 6f  6c 53 74 61 74 65 73 20   y, symbolStates 
1aaa0	6d 61 70 5b 73 74 72 69  6e 67 5d 2a 53 79 6d 62   map[string]*Symb
1aab0	6f 6c 53 74 61 74 65 2c  20 63 6f 6e 66 69 67 20   olState, config 
1aac0	2a 42 61 63 6b 74 65 73  74 43 6f 6e 66 69 67 29   *BacktestConfig)
1aad0	20 2a 54 72 61 64 65 4f  70 70 6f 72 74 75 6e 69    *TradeOpportuni
1aae0	74 79 20 7b 0a 09 69 66  20 6c 65 6e 28 61 6c 6c   ty {..if len(all
1aaf0	4f 70 70 6f 72 74 75 6e  69 74 69 65 73 29 20 3d   Opportunities) =
1ab00	3d 20 30 20 7b 0a 09 09  72 65 74 75 72 6e 20 6e   = 0 {...return n
1ab10	69 6c 0a 09 7d 0a 0a 09  2f 2f 20 31 2e 20 e6 8c   il..}...// 1. ..
1ab20	89 e6 9c 80 e7 bb 88 e5  88 86 e6 95 b0 e6 8e 92   ................
1ab30	e5 ba 8f 0a 09 73 6f 72  74 2e 53 6c 69 63 65 28   .....sort.Slice(
1ab40	61 6c 6c 4f 70 70 6f 72  74 75 6e 69 74 69 65 73   allOpportunities
1ab50	2c 20 66 75 6e 63 28 69  2c 20 6a 20 69 6e 74 29   , func(i, j int)
1ab60	20 62 6f 6f 6c 20 7b 0a  09 09 72 65 74 75 72 6e    bool {...return
1ab70	20 61 6c 6c 4f 70 70 6f  72 74 75 6e 69 74 69 65    allOpportunitie
1ab80	73 5b 69 5d 2e 53 63 6f  72 65 20 3e 20 61 6c 6c   s[i].Score > all
1ab90	4f 70 70 6f 72 74 75 6e  69 74 69 65 73 5b 6a 5d   Opportunities[j]
1aba0	2e 53 63 6f 72 65 0a 09  7d 29 0a 0a 09 2f 2f 20   .Score..})...// 
1abb0	32 2e 20 e8 ae a1 e7 ae  97 e4 b8 80 e8 87 b4 e6   2. .............
1abc0	80 a7 e8 af 84 e5 88 86  ef bc 88 e6 a3 80 e6 9f   ................
1abd0	a5 e5 89 8d 35 e4 b8 aa  e6 9c ba e4 bc 9a e7 9a   ....5...........
1abe0	84 e4 b8 80 e8 87 b4 e6  80 a7 ef bc 89 0a 09 63   ...............c
1abf0	6f 6e 73 69 73 74 65 6e  63 79 42 6f 6e 75 73 20   onsistencyBonus 
1ac00	3a 3d 20 62 65 2e 63 61  6c 63 75 6c 61 74 65 4f   := be.calculateO
1ac10	70 70 6f 72 74 75 6e 69  74 79 43 6f 6e 73 69 73   pportunityConsis
1ac20	74 65 6e 63 79 28 61 6c  6c 4f 70 70 6f 72 74 75   tency(allOpportu
1ac30	6e 69 74 69 65 73 29 0a  0a 09 2f 2f 20 33 2e 20   nities)...// 3. 
1ac40	e9 80 89 e6 8b a9 e6 9c  80 e4 bd b3 e6 9c ba e4   ................
1ac50	bc 9a ef bc 8c e4 bd 86  e8 80 83 e8 99 91 e4 b8   ................
1ac60	80 e8 87 b4 e6 80 a7 0a  09 62 65 73 74 4f 70 70   .........bestOpp
1ac70	20 3a 3d 20 61 6c 6c 4f  70 70 6f 72 74 75 6e 69    := allOpportuni
1ac80	74 69 65 73 5b 30 5d 0a  0a 09 2f 2f 20 e5 a2 9e   ties[0]...// ...
1ac90	e5 bc ba e7 9a 84 e4 b8  80 e8 87 b4 e6 80 a7 e6   ................
1aca0	a3 80 e6 9f a5 e9 80 bb  e8 be 91 0a 09 69 66 20   .............if 
1acb0	6c 65 6e 28 61 6c 6c 4f  70 70 6f 72 74 75 6e 69   len(allOpportuni
1acc0	74 69 65 73 29 20 3e 3d  20 33 20 7b 0a 09 09 2f   ties) >= 3 {.../
1acd0	2f 20 e6 a3 80 e6 9f a5  e6 9c ba e4 bc 9a e7 b1   / ..............
1ace0	bb e5 9e 8b e5 88 86 e5  b8 83 ef bc 88 e6 9c 80   ................
1acf0	e5 a4 9a e6 a3 80 e6 9f  a5 e5 89 8d 35 e4 b8 aa   ............5...
1ad00	ef bc 8c e9 81 bf e5 85  8d e8 b6 8a e7 95 8c ef   ................
1ad10	bc 89 0a 09 09 61 72 62  69 74 72 61 67 65 43 6f   .....arbitrageCo
1ad20	75 6e 74 20 3a 3d 20 30  0a 09 09 72 65 67 75 6c   unt := 0...regul
1ad30	61 72 43 6f 75 6e 74 20  3a 3d 20 30 0a 09 09 63   arCount := 0...c
1ad40	68 65 63 6b 43 6f 75 6e  74 20 3a 3d 20 6c 65 6e   heckCount := len
1ad50	28 61 6c 6c 4f 70 70 6f  72 74 75 6e 69 74 69 65   (allOpportunitie
1ad60	73 29 0a 09 09 69 66 20  63 68 65 63 6b 43 6f 75   s)...if checkCou
1ad70	6e 74 20 3e 20 35 20 7b  0a 09 09 09 63 68 65 63   nt > 5 {....chec
1ad80	6b 43 6f 75 6e 74 20 3d  20 35 0a 09 09 7d 0a 09   kCount = 5...}..
1ad90	09 66 6f 72 20 5f 2c 20  6f 70 70 20 3a 3d 20 72   .for _, opp := r
1ada0	61 6e 67 65 20 61 6c 6c  4f 70 70 6f 72 74 75 6e   ange allOpportun
1adb0	69 74 69 65 73 5b 3a 63  68 65 63 6b 43 6f 75 6e   ities[:checkCoun
1adc0	74 5d 20 7b 20 2f 2f 20  e6 a3 80 e6 9f a5 e5 89   t] { // ........
1add0	8d 63 68 65 63 6b 43 6f  75 6e 74 e4 b8 aa 0a 09   .checkCount.....
1ade0	09 09 69 66 20 73 74 72  69 6e 67 73 2e 43 6f 6e   ..if strings.Con
1adf0	74 61 69 6e 73 28 6f 70  70 2e 52 65 61 73 6f 6e   tains(opp.Reason
1ae00	2c 20 22 61 72 62 69 74  72 61 67 65 22 29 20 7c   , "arbitrage") |
1ae10	7c 20 73 74 72 69 6e 67  73 2e 43 6f 6e 74 61 69   | strings.Contai
1ae20	6e 73 28 6f 70 70 2e 52  65 61 73 6f 6e 2c 20 22   ns(opp.Reason, "
1ae30	73 74 61 74 69 73 74 69  63 61 6c 22 29 20 7c 7c   statistical") ||
1ae40	20 73 74 72 69 6e 67 73  2e 43 6f 6e 74 61 69 6e    strings.Contain
1ae50	73 28 6f 70 70 2e 52 65  61 73 6f 6e 2c 20 22 63   s(opp.Reason, "c
1ae60	6f 72 72 65 6c 61 74 69  6f 6e 22 29 20 7b 0a 09   orrelation") {..
1ae70	09 09 09 61 72 62 69 74  72 61 67 65 43 6f 75 6e   ...arbitrageCoun
1ae80	74 2b 2b 0a 09 09 09 7d  20 65 6c 73 65 20 7b 0a   t++....} else {.
1ae90	09 09 09 09 72 65 67 75  6c 61 72 43 6f 75 6e 74   ....regularCount
1aea0	2b 2b 0a 09 09 09 7d 0a  09 09 7d 0a 0a 09 09 2f   ++....}...}..../
1aeb0	2f 20 e5 a6 82 e6 9e 9c  e5 a5 97 e5 88 a9 e6 9c   / ..............
1aec0	ba e4 bc 9a e5 8d a0 e5  a4 9a e6 95 b0 ef bc 8c   ................
1aed0	e4 bc 98 e5 85 88 e9 80  89 e6 8b a9 e5 a5 97 e5   ................
1aee0	88 a9 e6 9c ba e4 bc 9a  0a 09 09 69 66 20 61 72   ...........if ar
1aef0	62 69 74 72 61 67 65 43  6f 75 6e 74 20 3e 20 72   bitrageCount > r
1af00	65 67 75 6c 61 72 43 6f  75 6e 74 20 26 26 20 63   egularCount && c
1af10	6f 6e 73 69 73 74 65 6e  63 79 42 6f 6e 75 73 20   onsistencyBonus 
1af20	3e 20 30 2e 36 20 7b 0a  09 09 09 66 6f 72 20 5f   > 0.6 {....for _
1af30	2c 20 6f 70 70 20 3a 3d  20 72 61 6e 67 65 20 61   , opp := range a
1af40	6c 6c 4f 70 70 6f 72 74  75 6e 69 74 69 65 73 20   llOpportunities 
1af50	7b 0a 09 09 09 09 69 66  20 73 74 72 69 6e 67 73   {.....if strings
1af60	2e 43 6f 6e 74 61 69 6e  73 28 6f 70 70 2e 52 65   .Contains(opp.Re
1af70	61 73 6f 6e 2c 20 22 61  72 62 69 74 72 61 67 65   ason, "arbitrage
1af80	22 29 20 7c 7c 20 73 74  72 69 6e 67 73 2e 43 6f   ") || strings.Co
1af90	6e 74 61 69 6e 73 28 6f  70 70 2e 52 65 61 73 6f   ntains(opp.Reaso
1afa0	6e 2c 20 22 73 74 61 74  69 73 74 69 63 61 6c 22   n, "statistical"
1afb0	29 20 7c 7c 20 73 74 72  69 6e 67 73 2e 43 6f 6e   ) || strings.Con
1afc0	74 61 69 6e 73 28 6f 70  70 2e 52 65 61 73 6f 6e   tains(opp.Reason
1afd0	2c 20 22 63 6f 72 72 65  6c 61 74 69 6f 6e 22 29   , "correlation")
1afe0	20 7b 0a 09 09 09 09 09  69 66 20 6f 70 70 2e 53    {......if opp.S
1aff0	63 6f 72 65 20 3e 20 62  65 73 74 4f 70 70 2e 53   core > bestOpp.S
1b000	63 6f 72 65 2a 30 2e 38  20 7b 20 2f 2f 20 e5 85   core*0.8 { // ..
1b010	81 e8 ae b8 e4 b8 80 e5  ae 9a e5 88 86 e6 95 b0   ................
1b020	e6 8d 9f e5 a4 b1 0a 09  09 09 09 09 09 62 65 73   .............bes
1b030	74 4f 70 70 20 3d 20 6f  70 70 0a 09 09 09 09 09   tOpp = opp......
1b040	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 43 4f   .log.Printf("[CO
1b050	4e 53 49 53 54 45 4e 43  59 5f 53 45 4c 45 43 54   NSISTENCY_SELECT
1b060	49 4f 4e 5d 20 e4 bc 98  e5 85 88 e9 80 89 e6 8b   ION] ...........
1b070	a9 e5 a5 97 e5 88 a9 e6  9c ba e4 bc 9a 3a 20 25   .............: %
1b080	73 20 28 e7 b1 bb e5 9e  8b 3a 25 73 2c 20 e4 b8   s (......:%s, ..
1b090	80 e8 87 b4 e6 80 a7 3a  25 2e 32 66 29 22 2c 0a   .......:%.2f)",.
1b0a0	09 09 09 09 09 09 09 62  65 73 74 4f 70 70 2e 53   .......bestOpp.S
1b0b0	79 6d 62 6f 6c 2c 20 62  65 73 74 4f 70 70 2e 52   ymbol, bestOpp.R
1b0c0	65 61 73 6f 6e 2c 20 63  6f 6e 73 69 73 74 65 6e   eason, consisten
1b0d0	63 79 42 6f 6e 75 73 29  0a 09 09 09 09 09 09 62   cyBonus).......b
1b0e0	72 65 61 6b 0a 09 09 09  09 09 7d 0a 09 09 09 09   reak......}.....
1b0f0	7d 0a 09 09 09 7d 0a 09  09 7d 20 65 6c 73 65 20   }....}...} else 
1b100	69 66 20 63 6f 6e 73 69  73 74 65 6e 63 79 42 6f   if consistencyBo
1b110	6e 75 73 20 3e 20 30 2e  36 20 7b 20 2f 2f 20 e9   nus > 0.6 { // .
1b120	99 8d e4 bd 8e e4 b8 80  e8 87 b4 e6 80 a7 e8 a6   ................
1b130	81 e6 b1 82 0a 09 09 09  2f 2f 20 e6 99 ae e9 80   ........// .....
1b140	9a e6 9c ba e4 bc 9a e7  9a 84 e4 b8 80 e8 87 b4   ................
1b150	e6 80 a7 e9 80 89 e6 8b  a9 20 2d 20 e5 a2 9e e5   ......... - ....
1b160	8a a0 e7 81 b5 e6 b4 bb  e6 80 a7 0a 09 09 09 73   ...............s
1b170	63 6f 72 65 44 69 66 66  31 20 3a 3d 20 62 65 73   coreDiff1 := bes
1b180	74 4f 70 70 2e 53 63 6f  72 65 20 2d 20 61 6c 6c   tOpp.Score - all
1b190	4f 70 70 6f 72 74 75 6e  69 74 69 65 73 5b 31 5d   Opportunities[1]
1b1a0	2e 53 63 6f 72 65 0a 09  09 09 69 66 20 73 63 6f   .Score....if sco
1b1b0	72 65 44 69 66 66 31 20  3c 20 30 2e 32 20 7b 20   reDiff1 < 0.2 { 
1b1c0	2f 2f 20 e6 94 be e5 ae  bd e5 88 86 e6 95 b0 e6   // .............
1b1d0	8e a5 e8 bf 91 e8 a6 81  e6 b1 82 0a 09 09 09 09   ................
1b1e0	61 6c 74 65 72 6e 61 74  69 76 65 4f 70 70 20 3a   alternativeOpp :
1b1f0	3d 20 62 65 2e 73 65 6c  65 63 74 4d 6f 72 65 53   = be.selectMoreS
1b200	74 61 62 6c 65 4f 70 70  6f 72 74 75 6e 69 74 79   tableOpportunity
1b210	28 61 6c 6c 4f 70 70 6f  72 74 75 6e 69 74 69 65   (allOpportunitie
1b220	73 5b 3a 33 5d 29 0a 09  09 09 09 69 66 20 61 6c   s[:3]).....if al
1b230	74 65 72 6e 61 74 69 76  65 4f 70 70 20 21 3d 20   ternativeOpp != 
1b240	6e 69 6c 20 7b 0a 09 09  09 09 09 62 65 73 74 4f   nil {......bestO
1b250	70 70 20 3d 20 61 6c 74  65 72 6e 61 74 69 76 65   pp = alternative
1b260	4f 70 70 0a 09 09 09 09  09 6c 6f 67 2e 50 72 69   Opp......log.Pri
1b270	6e 74 66 28 22 5b 43 4f  4e 53 49 53 54 45 4e 43   ntf("[CONSISTENC
1b280	59 5f 53 45 4c 45 43 54  49 4f 4e 5d 20 e5 9f ba   Y_SELECTION] ...
1b290	e4 ba 8e e4 b8 80 e8 87  b4 e6 80 a7 e9 80 89 e6   ................
1b2a0	8b a9 e6 9b b4 e7 a8 b3  e5 ae 9a e7 9a 84 e6 9c   ................
1b2b0	ba e4 bc 9a 3a 20 25 73  20 28 e4 b8 80 e8 87 b4   ....: %s (......
1b2c0	e6 80 a7 3a 25 2e 32 66  29 22 2c 0a 09 09 09 09   ...:%.2f)",.....
1b2d0	09 09 62 65 73 74 4f 70  70 2e 53 79 6d 62 6f 6c   ..bestOpp.Symbol
1b2e0	2c 20 63 6f 6e 73 69 73  74 65 6e 63 79 42 6f 6e   , consistencyBon
1b2f0	75 73 29 0a 09 09 09 09  7d 0a 09 09 09 7d 0a 09   us).....}....}..
1b300	7d 0a 0a 09 2f 2f 20 e6  a3 80 e6 9f a5 e6 98 af   }...// .........
1b310	e5 90 a6 e6 bb a1 e8 b6  b3 e6 9c 80 e5 b0 8f e5   ................
1b320	88 86 e6 95 b0 e9 98 88  e5 80 bc 20 2d 20 e5 8a   ........... - ..
1b330	a8 e6 80 81 e9 98 88 e5  80 bc e8 b0 83 e6 95 b4   ................
1b340	0a 09 6d 69 6e 53 63 6f  72 65 54 68 72 65 73 68   ..minScoreThresh
1b350	6f 6c 64 20 3a 3d 20 62  65 2e 63 61 6c 63 75 6c   old := be.calcul
1b360	61 74 65 44 79 6e 61 6d  69 63 4f 70 70 6f 72 74   ateDynamicOpport
1b370	75 6e 69 74 79 54 68 72  65 73 68 6f 6c 64 28 29   unityThreshold()
1b380	0a 0a 09 2f 2f 20 e5 9f  ba e4 ba 8e e9 98 88 e5   ...// ..........
1b390	80 bc e7 9a 84 e9 a2 9d  e5 a4 96 e4 b8 80 e8 87   ................
1b3a0	b4 e6 80 a7 e6 a3 80 e6  9f a5 0a 09 69 66 20 6c   ............if l
1b3b0	65 6e 28 61 6c 6c 4f 70  70 6f 72 74 75 6e 69 74   en(allOpportunit
1b3c0	69 65 73 29 20 3e 3d 20  32 20 26 26 20 63 6f 6e   ies) >= 2 && con
1b3d0	73 69 73 74 65 6e 63 79  42 6f 6e 75 73 20 3e 20   sistencyBonus > 
1b3e0	30 2e 34 20 7b 0a 09 09  2f 2f 20 e6 96 b0 e5 a2   0.4 {...// .....
1b3f0	9e ef bc 9a e4 b8 ad e7  ad 89 e4 b8 80 e8 87 b4   ................
1b400	e6 80 a7 e6 97 b6 e7 9a  84 e6 9c ba e4 bc 9a e9   ................
1b410	80 89 e6 8b a9 0a 09 09  73 63 6f 72 65 44 69 66   ........scoreDif
1b420	66 31 20 3a 3d 20 62 65  73 74 4f 70 70 2e 53 63   f1 := bestOpp.Sc
1b430	6f 72 65 20 2d 20 61 6c  6c 4f 70 70 6f 72 74 75   ore - allOpportu
1b440	6e 69 74 69 65 73 5b 31  5d 2e 53 63 6f 72 65 0a   nities[1].Score.
1b450	09 09 69 66 20 73 63 6f  72 65 44 69 66 66 31 20   ..if scoreDiff1 
1b460	3c 20 30 2e 33 20 26 26  20 62 65 73 74 4f 70 70   < 0.3 && bestOpp
1b470	2e 53 63 6f 72 65 20 3e  20 6d 69 6e 53 63 6f 72   .Score > minScor
1b480	65 54 68 72 65 73 68 6f  6c 64 20 2a 20 31 2e 31   eThreshold * 1.1
1b490	20 7b 0a 09 09 09 6c 6f  67 2e 50 72 69 6e 74 66    {....log.Printf
1b4a0	28 22 5b 43 4f 4e 53 49  53 54 45 4e 43 59 5f 53   ("[CONSISTENCY_S
1b4b0	45 4c 45 43 54 49 4f 4e  5d 20 e4 b8 ad e7 ad 89   ELECTION] ......
1b4c0	e4 b8 80 e8 87 b4 e6 80  a7 e4 b8 8b e9 80 89 e6   ................
1b4d0	8b a9 e9 ab 98 e8 b4 a8  e9 87 8f e6 9c ba e4 bc   ................
1b4e0	9a 3a 20 25 73 20 28 e4  b8 80 e8 87 b4 e6 80 a7   .: %s (.........
1b4f0	3a 25 2e 32 66 2c 20 e5  88 86 e6 95 b0 3a 25 2e   :%.2f, ......:%.
1b500	33 66 29 22 2c 0a 09 09  09 09 62 65 73 74 4f 70   3f)",.....bestOp
1b510	70 2e 53 79 6d 62 6f 6c  2c 20 63 6f 6e 73 69 73   p.Symbol, consis
1b520	74 65 6e 63 79 42 6f 6e  75 73 2c 20 62 65 73 74   tencyBonus, best
1b530	4f 70 70 2e 53 63 6f 72  65 29 0a 09 09 7d 0a 09   Opp.Score)...}..
1b540	7d 0a 09 69 66 20 62 65  73 74 4f 70 70 2e 53 63   }..if bestOpp.Sc
1b550	6f 72 65 20 3c 20 6d 69  6e 53 63 6f 72 65 54 68   ore < minScoreTh
1b560	72 65 73 68 6f 6c 64 20  7b 0a 09 09 6c 6f 67 2e   reshold {...log.
1b570	50 72 69 6e 74 66 28 22  5b 4f 56 45 52 41 4c 4c   Printf("[OVERALL
1b580	5f 53 45 4c 45 43 54 49  4f 4e 5d 20 e6 9c 80 e4   _SELECTION] ....
1b590	bd b3 e6 9c ba e4 bc 9a  e5 88 86 e6 95 b0 25 2e   ..............%.
1b5a0	33 66 e4 bd 8e e4 ba 8e  e5 8a a8 e6 80 81 e9 98   3f..............
1b5b0	88 e5 80 bc 25 2e 33 66  ef bc 8c e8 b7 b3 e8 bf   ....%.3f........
1b5c0	87 e4 ba a4 e6 98 93 22  2c 20 62 65 73 74 4f 70   .......", bestOp
1b5d0	70 2e 53 63 6f 72 65 2c  20 6d 69 6e 53 63 6f 72   p.Score, minScor
1b5e0	65 54 68 72 65 73 68 6f  6c 64 29 0a 09 09 72 65   eThreshold)...re
1b5f0	74 75 72 6e 20 6e 69 6c  0a 09 7d 0a 0a 09 2f 2f   turn nil..}...//
1b600	20 e6 a3 80 e6 9f a5 e8  b5 84 e9 87 91 e9 99 90    ...............
1b610	e5 88 b6 20 2d 20 e5 8a  a8 e6 80 81 e8 b5 84 e9   ... - ..........
1b620	87 91 e5 88 86 e9 85 8d  0a 09 61 76 61 69 6c 61   ..........availa
1b630	62 6c 65 43 61 73 68 20  3a 3d 20 31 30 30 30 30   bleCash := 10000
1b640	30 2e 30 20 20 20 20 20  20 20 20 20 20 20 20 20   0.0             
1b650	20 20 2f 2f 20 e8 bf 99  e9 87 8c e5 ba 94 e8 af     // ...........
1b660	a5 e4 bb 8e e5 ae 9e e9  99 85 e7 9a 84 e5 8f af   ................
1b670	e7 94 a8 e8 b5 84 e9 87  91 e8 8e b7 e5 8f 96 0a   ................
1b680	09 62 61 73 65 50 6f 73  69 74 69 6f 6e 52 61 74   .basePositionRat
1b690	69 6f 20 3a 3d 20 30 2e  30 38 20 20 20 20 20 20   io := 0.08      
1b6a0	20 20 20 20 20 20 20 20  20 2f 2f 20 e5 9f ba e7            // ....
1b6b0	a1 80 e4 bb 93 e4 bd 8d  e6 af 94 e4 be 8b 38 25   ..............8%
1b6c0	0a 0a 09 2f 2f 20 e6 a0  b9 e6 8d ae e6 9c ba e4   ...// ..........
1b6d0	bc 9a e8 b4 a8 e9 87 8f  e5 8a a8 e6 80 81 e8 b0   ................
1b6e0	83 e6 95 b4 e8 b5 84 e9  87 91 e4 bd bf e7 94 a8   ................
1b6f0	0a 09 71 75 61 6c 69 74  79 4d 75 6c 74 69 70 6c   ..qualityMultipl
1b700	69 65 72 20 3a 3d 20 31  2e 30 0a 09 69 66 20 62   ier := 1.0..if b
1b710	65 73 74 4f 70 70 2e 53  63 6f 72 65 20 3e 20 6d   estOpp.Score > m
1b720	69 6e 53 63 6f 72 65 54  68 72 65 73 68 6f 6c 64   inScoreThreshold
1b730	20 2a 20 31 2e 35 20 7b  20 2f 2f 20 e9 ab 98 e8    * 1.5 { // ....
1b740	b4 a8 e9 87 8f e6 9c ba  e4 bc 9a 0a 09 09 71 75   ..............qu
1b750	61 6c 69 74 79 4d 75 6c  74 69 70 6c 69 65 72 20   alityMultiplier 
1b760	3d 20 31 2e 35 20 2f 2f  20 e5 8f af e4 bb a5 e4   = 1.5 // .......
1b770	bd bf e7 94 a8 e6 9b b4  e5 a4 9a e8 b5 84 e9 87   ................
1b780	91 0a 09 7d 20 65 6c 73  65 20 69 66 20 62 65 73   ...} else if bes
1b790	74 4f 70 70 2e 53 63 6f  72 65 20 3e 20 6d 69 6e   tOpp.Score > min
1b7a0	53 63 6f 72 65 54 68 72  65 73 68 6f 6c 64 20 2a   ScoreThreshold *
1b7b0	20 31 2e 32 20 7b 20 2f  2f 20 e4 b8 ad e9 ab 98    1.2 { // ......
1b7c0	e8 b4 a8 e9 87 8f e6 9c  ba e4 bc 9a 0a 09 09 71   ...............q
1b7d0	75 61 6c 69 74 79 4d 75  6c 74 69 70 6c 69 65 72   ualityMultiplier
1b7e0	20 3d 20 31 2e 32 0a 09  7d 0a 0a 09 6d 61 78 50    = 1.2..}...maxP
1b7f0	6f 73 69 74 69 6f 6e 56  61 6c 75 65 20 3a 3d 20   ositionValue := 
1b800	61 76 61 69 6c 61 62 6c  65 43 61 73 68 20 2a 20   availableCash * 
1b810	62 61 73 65 50 6f 73 69  74 69 6f 6e 52 61 74 69   basePositionRati
1b820	6f 20 2a 20 71 75 61 6c  69 74 79 4d 75 6c 74 69   o * qualityMulti
1b830	70 6c 69 65 72 0a 09 6c  6f 67 2e 50 72 69 6e 74   plier..log.Print
1b840	66 28 22 5b 50 4f 53 49  54 49 4f 4e 5f 53 49 5a   f("[POSITION_SIZ
1b850	49 4e 47 5d 20 e6 9c ba  e4 bc 9a e5 88 86 e6 95   ING] ...........
1b860	b0 3a 25 2e 33 66 2c 20  e8 b4 a8 e9 87 8f e5 80   .:%.3f, ........
1b870	8d e6 95 b0 3a 25 2e 31  66 2c 20 e6 9c 80 e5 a4   ....:%.1f, .....
1b880	a7 e4 bb 93 e4 bd 8d 3a  25 2e 30 66 22 2c 0a 09   .......:%.0f",..
1b890	09 62 65 73 74 4f 70 70  2e 53 63 6f 72 65 2c 20   .bestOpp.Score, 
1b8a0	71 75 61 6c 69 74 79 4d  75 6c 74 69 70 6c 69 65   qualityMultiplie
1b8b0	72 2c 20 6d 61 78 50 6f  73 69 74 69 6f 6e 56 61   r, maxPositionVa
1b8c0	6c 75 65 29 0a 0a 09 2f  2f 20 e4 bc b0 e7 ae 97   lue)...// ......
1b8d0	e6 89 80 e9 9c 80 e8 b5  84 e9 87 91 0a 09 70 6f   ..............po
1b8e0	73 69 74 69 6f 6e 53 69  7a 65 20 3a 3d 20 6d 61   sitionSize := ma
1b8f0	78 50 6f 73 69 74 69 6f  6e 56 61 6c 75 65 20 2f   xPositionValue /
1b900	20 62 65 73 74 4f 70 70  2e 50 72 69 63 65 0a 09    bestOpp.Price..
1b910	69 66 20 70 6f 73 69 74  69 6f 6e 53 69 7a 65 20   if positionSize 
1b920	3c 3d 20 30 20 7b 0a 09  09 6c 6f 67 2e 50 72 69   <= 0 {...log.Pri
1b930	6e 74 66 28 22 5b 4f 56  45 52 41 4c 4c 5f 53 45   ntf("[OVERALL_SE
1b940	4c 45 43 54 49 4f 4e 5d  20 e8 ae a1 e7 ae 97 e7   LECTION] .......
1b950	9a 84 e4 bb 93 e4 bd 8d  e5 a4 a7 e5 b0 8f e6 97   ................
1b960	a0 e6 95 88 3a 20 25 2e  36 66 22 2c 20 70 6f 73   ....: %.6f", pos
1b970	69 74 69 6f 6e 53 69 7a  65 29 0a 09 09 72 65 74   itionSize)...ret
1b980	75 72 6e 20 6e 69 6c 0a  09 7d 0a 0a 09 2f 2f 20   urn nil..}...// 
1b990	e5 88 9b e5 bb ba 54 72  61 64 65 4f 70 70 6f 72   ......TradeOppor
1b9a0	74 75 6e 69 74 79 e5 af  b9 e8 b1 a1 0a 09 74 72   tunity........tr
1b9b0	61 64 65 4f 70 70 20 3a  3d 20 26 54 72 61 64 65   adeOpp := &Trade
1b9c0	4f 70 70 6f 72 74 75 6e  69 74 79 7b 0a 09 09 53   Opportunity{...S
1b9d0	79 6d 62 6f 6c 3a 20 20  20 20 20 20 20 20 20 62   ymbol:         b
1b9e0	65 73 74 4f 70 70 2e 53  79 6d 62 6f 6c 2c 0a 09   estOpp.Symbol,..
1b9f0	09 41 63 74 69 6f 6e 3a  20 20 20 20 20 20 20 20   .Action:        
1ba00	20 62 65 73 74 4f 70 70  2e 41 63 74 69 6f 6e 2c    bestOpp.Action,
1ba10	0a 09 09 43 6f 6e 66 69  64 65 6e 63 65 3a 20 20   ...Confidence:  
1ba20	20 20 20 62 65 73 74 4f  70 70 2e 43 6f 6e 66 69      bestOpp.Confi
1ba30	64 65 6e 63 65 2c 0a 09  09 53 63 6f 72 65 3a 20   dence,...Score: 
1ba40	20 20 20 20 20 20 20 20  20 62 65 73 74 4f 70 70            bestOpp
1ba50	2e 53 63 6f 72 65 2c 0a  09 09 50 72 69 63 65 3a   .Score,...Price:
1ba60	20 20 20 20 20 20 20 20  20 20 62 65 73 74 4f 70             bestOp
1ba70	70 2e 50 72 69 63 65 2c  0a 09 09 52 65 61 73 6f   p.Price,...Reaso
1ba80	6e 3a 20 20 20 20 20 20  20 20 20 62 65 2e 67 65   n:         be.ge
1ba90	6e 65 72 61 74 65 4f 70  70 6f 72 74 75 6e 69 74   nerateOpportunit
1baa0	79 52 65 61 73 6f 6e 28  62 65 73 74 4f 70 70 29   yReason(bestOpp)
1bab0	2c 0a 09 09 53 74 61 74  65 3a 20 20 20 20 20 20   ,...State:      
1bac0	20 20 20 20 62 65 73 74  4f 70 70 2e 53 74 61 74       bestOpp.Stat
1bad0	65 2c 0a 09 09 52 69 73  6b 41 64 6a 75 73 74 6d   e,...RiskAdjustm
1bae0	65 6e 74 3a 20 62 65 73  74 4f 70 70 2e 52 69 73   ent: bestOpp.Ris
1baf0	6b 41 64 6a 75 73 74 6d  65 6e 74 2c 0a 09 7d 0a   kAdjustment,..}.
1bb00	0a 09 72 65 74 75 72 6e  20 74 72 61 64 65 4f 70   ..return tradeOp
1bb10	70 0a 7d 0a 0a 2f 2f 20  67 65 6e 65 72 61 74 65   p.}..// generate
1bb20	4f 70 70 6f 72 74 75 6e  69 74 79 52 65 61 73 6f   OpportunityReaso
1bb30	6e 20 e7 94 9f e6 88 90  e6 9c ba e4 bc 9a e5 8e   n ..............
1bb40	9f e5 9b a0 e6 8f 8f e8  bf b0 0a 66 75 6e 63 20   ...........func 
1bb50	28 62 65 20 2a 42 61 63  6b 74 65 73 74 45 6e 67   (be *BacktestEng
1bb60	69 6e 65 29 20 67 65 6e  65 72 61 74 65 4f 70 70   ine) generateOpp
1bb70	6f 72 74 75 6e 69 74 79  52 65 61 73 6f 6e 28 6f   ortunityReason(o
1bb80	70 70 20 2a 53 79 6d 62  6f 6c 4f 70 70 6f 72 74   pp *SymbolOpport
1bb90	75 6e 69 74 79 29 20 73  74 72 69 6e 67 20 7b 0a   unity) string {.
1bba0	09 69 66 20 61 72 62 54  79 70 65 2c 20 65 78 69   .if arbType, exi
1bbb0	73 74 73 20 3a 3d 20 6f  70 70 2e 46 65 61 74 75   sts := opp.Featu
1bbc0	72 65 73 5b 22 61 72 62  69 74 72 61 67 65 5f 74   res["arbitrage_t
1bbd0	79 70 65 22 5d 3b 20 65  78 69 73 74 73 20 7b 0a   ype"]; exists {.
1bbe0	09 09 73 77 69 74 63 68  20 61 72 62 54 79 70 65   ..switch arbType
1bbf0	20 7b 0a 09 09 63 61 73  65 20 31 2e 30 3a 0a 09    {...case 1.0:..
1bc00	09 09 72 65 74 75 72 6e  20 22 e7 bb 9f e8 ae a1   ..return "......
1bc10	e5 a5 97 e5 88 a9 e6 9c  ba e4 bc 9a 22 0a 09 09   ............"...
1bc20	63 61 73 65 20 32 2e 30  3a 0a 09 09 09 72 65 74   case 2.0:....ret
1bc30	75 72 6e 20 22 e7 9b b8  e5 85 b3 e6 80 a7 e5 a5   urn "...........
1bc40	97 e5 88 a9 e6 9c ba e4  bc 9a 22 0a 09 09 63 61   .........."...ca
1bc50	73 65 20 33 2e 30 3a 0a  09 09 09 72 65 74 75 72   se 3.0:....retur
1bc60	6e 20 22 e6 97 b6 e9 97  b4 e5 8f 8d e8 bd ac e5   n ".............
1bc70	a5 97 e5 88 a9 e6 9c ba  e4 bc 9a 22 0a 09 09 7d   ..........."...}
1bc80	0a 09 7d 0a 0a 09 72 65  74 75 72 6e 20 66 6d 74   ..}...return fmt
1bc90	2e 53 70 72 69 6e 74 66  28 22 e5 a4 9a e5 b8 81   .Sprintf("......
1bca0	e7 a7 8d e6 99 ba e8 83  bd e9 80 89 e6 8b a9 20   ............... 
1bcb0	28 e9 a3 8e e9 99 a9 e8  b0 83 e6 95 b4 3a 20 25   (............: %
1bcc0	2e 33 66 29 22 2c 20 6f  70 70 2e 52 69 73 6b 41   .3f)", opp.RiskA
1bcd0	64 6a 75 73 74 6d 65 6e  74 29 0a 7d 0a 0a 2f 2f   djustment).}..//
1bce0	20 63 61 6c 63 75 6c 61  74 65 52 65 63 65 6e 74    calculateRecent
1bcf0	56 6f 6c 61 74 69 6c 69  74 79 20 e8 ae a1 e7 ae   Volatility .....
1bd00	97 e8 bf 91 e6 9c 9f e6  b3 a2 e5 8a a8 e7 8e 87   ................
1bd10	0a 66 75 6e 63 20 28 62  65 20 2a 42 61 63 6b 74   .func (be *Backt
1bd20	65 73 74 45 6e 67 69 6e  65 29 20 63 61 6c 63 75   estEngine) calcu
1bd30	6c 61 74 65 52 65 63 65  6e 74 56 6f 6c 61 74 69   lateRecentVolati
1bd40	6c 69 74 79 28 64 61 74  61 20 5b 5d 4d 61 72 6b   lity(data []Mark
1bd50	65 74 44 61 74 61 2c 20  63 75 72 72 65 6e 74 49   etData, currentI
1bd60	6e 64 65 78 20 69 6e 74  29 20 66 6c 6f 61 74 36   ndex int) float6
1bd70	34 20 7b 0a 09 69 66 20  63 75 72 72 65 6e 74 49   4 {..if currentI
1bd80	6e 64 65 78 20 3c 20 32  30 20 7c 7c 20 6c 65 6e   ndex < 20 || len
1bd90	28 64 61 74 61 29 20 3c  3d 20 63 75 72 72 65 6e   (data) <= curren
1bda0	74 49 6e 64 65 78 20 7b  0a 09 09 72 65 74 75 72   tIndex {...retur
1bdb0	6e 20 30 2e 30 32 20 2f  2f 20 e9 bb 98 e8 ae a4   n 0.02 // ......
1bdc0	e6 b3 a2 e5 8a a8 e7 8e  87 0a 09 7d 0a 0a 09 2f   ...........}.../
1bdd0	2f 20 e8 ae a1 e7 ae 97  e6 9c 80 e8 bf 91 32 30   / ............20
1bde0	e5 a4 a9 e7 9a 84 e6 94  b6 e7 9b 8a e7 8e 87 e6   ................
1bdf0	a0 87 e5 87 86 e5 b7 ae  0a 09 72 65 74 75 72 6e   ..........return
1be00	73 20 3a 3d 20 6d 61 6b  65 28 5b 5d 66 6c 6f 61   s := make([]floa
1be10	74 36 34 2c 20 32 30 29  0a 09 66 6f 72 20 69 20   t64, 20)..for i 
1be20	3a 3d 20 30 3b 20 69 20  3c 20 32 30 3b 20 69 2b   := 0; i < 20; i+
1be30	2b 20 7b 0a 09 09 69 64  78 20 3a 3d 20 63 75 72   + {...idx := cur
1be40	72 65 6e 74 49 6e 64 65  78 20 2d 20 31 39 20 2b   rentIndex - 19 +
1be50	20 69 0a 09 09 69 66 20  69 64 78 2b 31 20 3c 20    i...if idx+1 < 
1be60	6c 65 6e 28 64 61 74 61  29 20 7b 0a 09 09 09 72   len(data) {....r
1be70	65 74 20 3a 3d 20 28 64  61 74 61 5b 69 64 78 2b   et := (data[idx+
1be80	31 5d 2e 50 72 69 63 65  20 2d 20 64 61 74 61 5b   1].Price - data[
1be90	69 64 78 5d 2e 50 72 69  63 65 29 20 2f 20 64 61   idx].Price) / da
1bea0	74 61 5b 69 64 78 5d 2e  50 72 69 63 65 0a 09 09   ta[idx].Price...
1beb0	09 72 65 74 75 72 6e 73  5b 69 5d 20 3d 20 72 65   .returns[i] = re
1bec0	74 0a 09 09 7d 0a 09 7d  0a 0a 09 2f 2f 20 e8 ae   t...}..}...// ..
1bed0	a1 e7 ae 97 e6 a0 87 e5  87 86 e5 b7 ae 0a 09 6d   ...............m
1bee0	65 61 6e 20 3a 3d 20 30  2e 30 0a 09 66 6f 72 20   ean := 0.0..for 
1bef0	5f 2c 20 72 20 3a 3d 20  72 61 6e 67 65 20 72 65   _, r := range re
1bf00	74 75 72 6e 73 20 7b 0a  09 09 6d 65 61 6e 20 2b   turns {...mean +
1bf10	3d 20 72 0a 09 7d 0a 09  6d 65 61 6e 20 2f 3d 20   = r..}..mean /= 
1bf20	66 6c 6f 61 74 36 34 28  6c 65 6e 28 72 65 74 75   float64(len(retu
1bf30	72 6e 73 29 29 0a 0a 09  76 61 72 69 61 6e 63 65   rns))...variance
1bf40	20 3a 3d 20 30 2e 30 0a  09 66 6f 72 20 5f 2c 20    := 0.0..for _, 
1bf50	72 20 3a 3d 20 72 61 6e  67 65 20 72 65 74 75 72   r := range retur
1bf60	6e 73 20 7b 0a 09 09 64  69 66 66 20 3a 3d 20 72   ns {...diff := r
1bf70	20 2d 20 6d 65 61 6e 0a  09 09 76 61 72 69 61 6e    - mean...varian
1bf80	63 65 20 2b 3d 20 64 69  66 66 20 2a 20 64 69 66   ce += diff * dif
1bf90	66 0a 09 7d 0a 09 76 61  72 69 61 6e 63 65 20 2f   f..}..variance /
1bfa0	3d 20 66 6c 6f 61 74 36  34 28 6c 65 6e 28 72 65   = float64(len(re
1bfb0	74 75 72 6e 73 29 20 2d  20 31 29 0a 0a 09 76 6f   turns) - 1)...vo
1bfc0	6c 61 74 69 6c 69 74 79  20 3a 3d 20 6d 61 74 68   latility := math
1bfd0	2e 53 71 72 74 28 76 61  72 69 61 6e 63 65 29 0a   .Sqrt(variance).
1bfe0	09 72 65 74 75 72 6e 20  6d 61 74 68 2e 4d 61 78   .return math.Max
1bff0	28 30 2e 30 30 35 2c 20  6d 61 74 68 2e 4d 69 6e   (0.005, math.Min
1c000	28 76 6f 6c 61 74 69 6c  69 74 79 2c 20 30 2e 35   (volatility, 0.5
1c010	29 29 20 2f 2f 20 e9 99  90 e5 88 b6 e5 9c a8 e5   )) // ..........
1c020	90 88 e7 90 86 e8 8c 83  e5 9b b4 e5 86 85 0a 7d   ...............}
1c030	0a 0a 2f 2f 20 63 61 6c  63 75 6c 61 74 65 50 72   ..// calculatePr
1c040	69 63 65 4d 6f 6d 65 6e  74 75 6d 20 e8 ae a1 e7   iceMomentum ....
1c050	ae 97 e4 bb b7 e6 a0 bc  e5 8a a8 e9 87 8f 0a 66   ...............f
1c060	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
1c070	74 45 6e 67 69 6e 65 29  20 63 61 6c 63 75 6c 61   tEngine) calcula
1c080	74 65 50 72 69 63 65 4d  6f 6d 65 6e 74 75 6d 28   tePriceMomentum(
1c090	70 72 69 63 65 73 20 5b  5d 66 6c 6f 61 74 36 34   prices []float64
1c0a0	29 20 66 6c 6f 61 74 36  34 20 7b 0a 09 69 66 20   ) float64 {..if 
1c0b0	6c 65 6e 28 70 72 69 63  65 73 29 20 3c 20 32 20   len(prices) < 2 
1c0c0	7b 0a 09 09 72 65 74 75  72 6e 20 30 2e 30 0a 09   {...return 0.0..
1c0d0	7d 0a 09 72 65 74 75 72  6e 20 28 70 72 69 63 65   }..return (price
1c0e0	73 5b 6c 65 6e 28 70 72  69 63 65 73 29 2d 31 5d   s[len(prices)-1]
1c0f0	20 2d 20 70 72 69 63 65  73 5b 30 5d 29 20 2f 20    - prices[0]) / 
1c100	70 72 69 63 65 73 5b 30  5d 0a 7d 0a 0a 2f 2f 20   prices[0].}..// 
1c110	63 61 6c 63 75 6c 61 74  65 54 72 65 6e 64 20 e8   calculateTrend .
1c120	ae a1 e7 ae 97 e8 b6 8b  e5 8a bf 0a 66 75 6e 63   ............func
1c130	20 28 62 65 20 2a 42 61  63 6b 74 65 73 74 45 6e    (be *BacktestEn
1c140	67 69 6e 65 29 20 63 61  6c 63 75 6c 61 74 65 54   gine) calculateT
1c150	72 65 6e 64 28 70 72 69  63 65 73 20 5b 5d 66 6c   rend(prices []fl
1c160	6f 61 74 36 34 29 20 66  6c 6f 61 74 36 34 20 7b   oat64) float64 {
1c170	0a 09 69 66 20 6c 65 6e  28 70 72 69 63 65 73 29   ..if len(prices)
1c180	20 3c 20 32 20 7b 0a 09  09 72 65 74 75 72 6e 20    < 2 {...return 
1c190	30 2e 30 0a 09 7d 0a 0a  09 2f 2f 20 e4 bd bf e7   0.0..}...// ....
1c1a0	94 a8 e7 ba bf e6 80 a7  e5 9b 9e e5 bd 92 e8 ae   ................
1c1b0	a1 e7 ae 97 e8 b6 8b e5  8a bf 0a 09 6e 20 3a 3d   ............n :=
1c1c0	20 66 6c 6f 61 74 36 34  28 6c 65 6e 28 70 72 69    float64(len(pri
1c1d0	63 65 73 29 29 0a 09 73  75 6d 58 20 3a 3d 20 6e   ces))..sumX := n
1c1e0	20 2a 20 28 6e 20 2d 20  31 29 20 2f 20 32 0a 09    * (n - 1) / 2..
1c1f0	73 75 6d 59 20 3a 3d 20  30 2e 30 0a 09 73 75 6d   sumY := 0.0..sum
1c200	58 59 20 3a 3d 20 30 2e  30 0a 09 73 75 6d 58 58   XY := 0.0..sumXX
1c210	20 3a 3d 20 30 2e 30 0a  0a 09 66 6f 72 20 69 2c    := 0.0...for i,
1c220	20 70 72 69 63 65 20 3a  3d 20 72 61 6e 67 65 20    price := range 
1c230	70 72 69 63 65 73 20 7b  0a 09 09 78 20 3a 3d 20   prices {...x := 
1c240	66 6c 6f 61 74 36 34 28  69 29 0a 09 09 73 75 6d   float64(i)...sum
1c250	59 20 2b 3d 20 70 72 69  63 65 0a 09 09 73 75 6d   Y += price...sum
1c260	58 59 20 2b 3d 20 78 20  2a 20 70 72 69 63 65 0a   XY += x * price.
1c270	09 09 73 75 6d 58 58 20  2b 3d 20 78 20 2a 20 78   ..sumXX += x * x
1c280	0a 09 7d 0a 0a 09 73 6c  6f 70 65 20 3a 3d 20 28   ..}...slope := (
1c290	6e 2a 73 75 6d 58 59 20  2d 20 73 75 6d 58 2a 73   n*sumXY - sumX*s
1c2a0	75 6d 59 29 20 2f 20 28  6e 2a 73 75 6d 58 58 20   umY) / (n*sumXX 
1c2b0	2d 20 73 75 6d 58 2a 73  75 6d 58 29 0a 09 72 65   - sumX*sumX)..re
1c2c0	74 75 72 6e 20 73 6c 6f  70 65 20 2f 20 70 72 69   turn slope / pri
1c2d0	63 65 73 5b 30 5d 20 2f  2f 20 e5 bd 92 e4 b8 80   ces[0] // ......
1c2e0	e5 8c 96 e8 b6 8b e5 8a  bf 0a 7d 0a 0a 2f 2f 20   ..........}..// 
1c2f0	63 61 6c 63 75 6c 61 74  65 52 53 49 46 6f 72 50   calculateRSIForP
1c300	72 69 63 65 73 20 e8 ae  a1 e7 ae 97 e4 bb b7 e6   rices ..........
1c310	a0 bc e5 ba 8f e5 88 97  e7 9a 84 52 53 49 0a 66   ...........RSI.f
1c320	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
1c330	74 45 6e 67 69 6e 65 29  20 63 61 6c 63 75 6c 61   tEngine) calcula
1c340	74 65 52 53 49 46 6f 72  50 72 69 63 65 73 28 70   teRSIForPrices(p
1c350	72 69 63 65 73 20 5b 5d  66 6c 6f 61 74 36 34 2c   rices []float64,
1c360	20 70 65 72 69 6f 64 20  69 6e 74 29 20 66 6c 6f    period int) flo
1c370	61 74 36 34 20 7b 0a 09  69 66 20 6c 65 6e 28 70   at64 {..if len(p
1c380	72 69 63 65 73 29 20 3c  20 70 65 72 69 6f 64 2b   rices) < period+
1c390	31 20 7b 0a 09 09 72 65  74 75 72 6e 20 35 30 2e   1 {...return 50.
1c3a0	30 0a 09 7d 0a 0a 09 67  61 69 6e 73 20 3a 3d 20   0..}...gains := 
1c3b0	30 2e 30 0a 09 6c 6f 73  73 65 73 20 3a 3d 20 30   0.0..losses := 0
1c3c0	2e 30 0a 0a 09 66 6f 72  20 69 20 3a 3d 20 31 3b   .0...for i := 1;
1c3d0	20 69 20 3c 3d 20 70 65  72 69 6f 64 3b 20 69 2b    i <= period; i+
1c3e0	2b 20 7b 0a 09 09 63 68  61 6e 67 65 20 3a 3d 20   + {...change := 
1c3f0	70 72 69 63 65 73 5b 69  5d 20 2d 20 70 72 69 63   prices[i] - pric
1c400	65 73 5b 69 2d 31 5d 0a  09 09 69 66 20 63 68 61   es[i-1]...if cha
1c410	6e 67 65 20 3e 20 30 20  7b 0a 09 09 09 67 61 69   nge > 0 {....gai
1c420	6e 73 20 2b 3d 20 63 68  61 6e 67 65 0a 09 09 7d   ns += change...}
1c430	20 65 6c 73 65 20 7b 0a  09 09 09 6c 6f 73 73 65    else {....losse
1c440	73 20 2d 3d 20 63 68 61  6e 67 65 0a 09 09 7d 0a   s -= change...}.
1c450	09 7d 0a 0a 09 69 66 20  6c 6f 73 73 65 73 20 3d   .}...if losses =
1c460	3d 20 30 20 7b 0a 09 09  72 65 74 75 72 6e 20 31   = 0 {...return 1
1c470	30 30 2e 30 0a 09 7d 0a  0a 09 72 73 20 3a 3d 20   00.0..}...rs := 
1c480	67 61 69 6e 73 20 2f 20  6c 6f 73 73 65 73 0a 09   gains / losses..
1c490	72 65 74 75 72 6e 20 31  30 30 2e 30 20 2d 20 28   return 100.0 - (
1c4a0	31 30 30 2e 30 20 2f 20  28 31 2e 30 20 2b 20 72   100.0 / (1.0 + r
1c4b0	73 29 29 0a 7d 0a 0a 2f  2f 20 43 6f 72 72 65 6c   s)).}..// Correl
1c4c0	61 74 69 6f 6e 43 6c 75  73 74 65 72 73 20 e7 9b   ationClusters ..
1c4d0	b8 e5 85 b3 e6 80 a7 e8  81 9a e7 b1 bb 0a 74 79   ..............ty
1c4e0	70 65 20 43 6f 72 72 65  6c 61 74 69 6f 6e 43 6c   pe CorrelationCl
1c4f0	75 73 74 65 72 73 20 73  74 72 75 63 74 20 7b 0a   usters struct {.
1c500	09 48 69 67 68 43 6f 72  72 65 6c 61 74 69 6f 6e   .HighCorrelation
1c510	43 6c 75 73 74 65 72 73  20 5b 5d 5b 5d 73 74 72   Clusters [][]str
1c520	69 6e 67 20 20 20 20 20  20 20 20 20 20 20 20 20   ing             
1c530	20 60 6a 73 6f 6e 3a 22  68 69 67 68 5f 63 6f 72    `json:"high_cor
1c540	72 65 6c 61 74 69 6f 6e  5f 63 6c 75 73 74 65 72   relation_cluster
1c550	73 22 60 0a 09 4c 6f 77  43 6f 72 72 65 6c 61 74   s"`..LowCorrelat
1c560	69 6f 6e 43 6c 75 73 74  65 72 73 20 20 5b 5d 5b   ionClusters  [][
1c570	5d 73 74 72 69 6e 67 20  20 20 20 20 20 20 20 20   ]string         
1c580	20 20 20 20 20 60 6a 73  6f 6e 3a 22 6c 6f 77 5f        `json:"low_
1c590	63 6f 72 72 65 6c 61 74  69 6f 6e 5f 63 6c 75 73   correlation_clus
1c5a0	74 65 72 73 22 60 0a 09  43 6c 75 73 74 65 72 53   ters"`..ClusterS
1c5b0	74 61 74 73 20 20 20 20  20 20 20 20 20 20 20 20   tats            
1c5c0	6d 61 70 5b 73 74 72 69  6e 67 5d 43 6c 75 73 74   map[string]Clust
1c5d0	65 72 53 74 61 74 73 20  60 6a 73 6f 6e 3a 22 63   erStats `json:"c
1c5e0	6c 75 73 74 65 72 5f 73  74 61 74 73 22 60 0a 7d   luster_stats"`.}
1c5f0	0a 0a 2f 2f 20 43 6c 75  73 74 65 72 53 74 61 74   ..// ClusterStat
1c600	73 20 e8 81 9a e7 b1 bb  e7 bb 9f e8 ae a1 0a 74   s .............t
1c610	79 70 65 20 43 6c 75 73  74 65 72 53 74 61 74 73   ype ClusterStats
1c620	20 73 74 72 75 63 74 20  7b 0a 09 53 69 7a 65 20    struct {..Size 
1c630	20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20                   
1c640	20 20 20 20 69 6e 74 20  20 20 20 20 60 6a 73 6f       int     `jso
1c650	6e 3a 22 73 69 7a 65 22  60 0a 09 41 76 67 43 6f   n:"size"`..AvgCo
1c660	72 72 65 6c 61 74 69 6f  6e 20 20 20 20 20 20 20   rrelation       
1c670	20 20 20 20 66 6c 6f 61  74 36 34 20 60 6a 73 6f       float64 `jso
1c680	6e 3a 22 61 76 67 5f 63  6f 72 72 65 6c 61 74 69   n:"avg_correlati
1c690	6f 6e 22 60 0a 09 43 6f  72 72 65 6c 61 74 69 6f   on"`..Correlatio
1c6a0	6e 53 74 64 44 65 76 20  20 20 20 20 20 20 20 66   nStdDev        f
1c6b0	6c 6f 61 74 36 34 20 60  6a 73 6f 6e 3a 22 63 6f   loat64 `json:"co
1c6c0	72 72 65 6c 61 74 69 6f  6e 5f 73 74 64 5f 64 65   rrelation_std_de
1c6d0	76 22 60 0a 09 44 69 76  65 72 73 69 66 69 63 61   v"`..Diversifica
1c6e0	74 69 6f 6e 50 6f 74 65  6e 74 69 61 6c 20 66 6c   tionPotential fl
1c6f0	6f 61 74 36 34 20 60 6a  73 6f 6e 3a 22 64 69 76   oat64 `json:"div
1c700	65 72 73 69 66 69 63 61  74 69 6f 6e 5f 70 6f 74   ersification_pot
1c710	65 6e 74 69 61 6c 22 60  0a 7d 0a 0a 2f 2f 20 43   ential"`.}..// C
1c720	6f 72 72 65 6c 61 74 69  6f 6e 52 69 73 6b 4d 65   orrelationRiskMe
1c730	74 72 69 63 73 20 e7 9b  b8 e5 85 b3 e6 80 a7 e9   trics ..........
1c740	a3 8e e9 99 a9 e6 8c 87  e6 a0 87 0a 74 79 70 65   ............type
1c750	20 43 6f 72 72 65 6c 61  74 69 6f 6e 52 69 73 6b    CorrelationRisk
1c760	4d 65 74 72 69 63 73 20  73 74 72 75 63 74 20 7b   Metrics struct {
1c770	0a 09 50 6f 72 74 66 6f  6c 69 6f 43 6f 72 72 65   ..PortfolioCorre
1c780	6c 61 74 69 6f 6e 52 69  73 6b 20 66 6c 6f 61 74   lationRisk float
1c790	36 34 20 60 6a 73 6f 6e  3a 22 70 6f 72 74 66 6f   64 `json:"portfo
1c7a0	6c 69 6f 5f 63 6f 72 72  65 6c 61 74 69 6f 6e 5f   lio_correlation_
1c7b0	72 69 73 6b 22 60 0a 09  43 6f 6e 63 65 6e 74 72   risk"`..Concentr
1c7c0	61 74 69 6f 6e 52 69 73  6b 20 20 20 20 20 20 20   ationRisk       
1c7d0	20 66 6c 6f 61 74 36 34  20 60 6a 73 6f 6e 3a 22    float64 `json:"
1c7e0	63 6f 6e 63 65 6e 74 72  61 74 69 6f 6e 5f 72 69   concentration_ri
1c7f0	73 6b 22 60 0a 09 44 69  76 65 72 73 69 66 69 63   sk"`..Diversific
1c800	61 74 69 6f 6e 42 65 6e  65 66 69 74 20 20 20 66   ationBenefit   f
1c810	6c 6f 61 74 36 34 20 60  6a 73 6f 6e 3a 22 64 69   loat64 `json:"di
1c820	76 65 72 73 69 66 69 63  61 74 69 6f 6e 5f 62 65   versification_be
1c830	6e 65 66 69 74 22 60 0a  09 53 79 73 74 65 6d 69   nefit"`..Systemi
1c840	63 52 69 73 6b 20 20 20  20 20 20 20 20 20 20 20   cRisk           
1c850	20 20 66 6c 6f 61 74 36  34 20 60 6a 73 6f 6e 3a     float64 `json:
1c860	22 73 79 73 74 65 6d 69  63 5f 72 69 73 6b 22 60   "systemic_risk"`
1c870	0a 7d 0a 0a 2f 2f 20 50  6f 73 69 74 69 6f 6e 49   .}..// PositionI
1c880	6e 66 6f 20 e6 8c 81 e4  bb 93 e4 bf a1 e6 81 af   nfo ............
1c890	0a 74 79 70 65 20 50 6f  73 69 74 69 6f 6e 49 6e   .type PositionIn
1c8a0	66 6f 20 73 74 72 75 63  74 20 7b 0a 09 53 79 6d   fo struct {..Sym
1c8b0	62 6f 6c 20 73 74 72 69  6e 67 20 20 60 6a 73 6f   bol string  `jso
1c8c0	6e 3a 22 73 79 6d 62 6f  6c 22 60 0a 09 56 61 6c   n:"symbol"`..Val
1c8d0	75 65 20 20 66 6c 6f 61  74 36 34 20 60 6a 73 6f   ue  float64 `jso
1c8e0	6e 3a 22 76 61 6c 75 65  22 60 0a 09 57 65 69 67   n:"value"`..Weig
1c8f0	68 74 20 66 6c 6f 61 74  36 34 20 60 6a 73 6f 6e   ht float64 `json
1c900	3a 22 77 65 69 67 68 74  22 60 0a 7d 0a 0a 2f 2f   :"weight"`.}..//
1c910	20 41 72 62 69 74 72 61  67 65 4f 70 70 6f 72 74    ArbitrageOpport
1c920	75 6e 69 74 79 20 e5 a5  97 e5 88 a9 e6 9c ba e4   unity ..........
1c930	bc 9a 0a 74 79 70 65 20  41 72 62 69 74 72 61 67   ...type Arbitrag
1c940	65 4f 70 70 6f 72 74 75  6e 69 74 79 20 73 74 72   eOpportunity str
1c950	75 63 74 20 7b 0a 09 54  79 70 65 20 20 20 20 20   uct {..Type     
1c960	20 20 20 20 20 20 20 73  74 72 69 6e 67 20 20 60          string  `
1c970	6a 73 6f 6e 3a 22 74 79  70 65 22 60 0a 09 50 72   json:"type"`..Pr
1c980	69 6d 61 72 79 53 79 6d  62 6f 6c 20 20 20 73 74   imarySymbol   st
1c990	72 69 6e 67 20 20 60 6a  73 6f 6e 3a 22 70 72 69   ring  `json:"pri
1c9a0	6d 61 72 79 5f 73 79 6d  62 6f 6c 22 60 0a 09 53   mary_symbol"`..S
1c9b0	65 63 6f 6e 64 61 72 79  53 79 6d 62 6f 6c 20 73   econdarySymbol s
1c9c0	74 72 69 6e 67 20 20 60  6a 73 6f 6e 3a 22 73 65   tring  `json:"se
1c9d0	63 6f 6e 64 61 72 79 5f  73 79 6d 62 6f 6c 2c 6f   condary_symbol,o
1c9e0	6d 69 74 65 6d 70 74 79  22 60 0a 09 44 69 72 65   mitempty"`..Dire
1c9f0	63 74 69 6f 6e 20 20 20  20 20 20 20 73 74 72 69   ction       stri
1ca00	6e 67 20 20 60 6a 73 6f  6e 3a 22 64 69 72 65 63   ng  `json:"direc
1ca10	74 69 6f 6e 22 60 0a 09  45 78 70 65 63 74 65 64   tion"`..Expected
1ca20	52 65 74 75 72 6e 20 20  66 6c 6f 61 74 36 34 20   Return  float64 
1ca30	60 6a 73 6f 6e 3a 22 65  78 70 65 63 74 65 64 5f   `json:"expected_
1ca40	72 65 74 75 72 6e 22 60  0a 09 43 6f 6e 66 69 64   return"`..Confid
1ca50	65 6e 63 65 20 20 20 20  20 20 66 6c 6f 61 74 36   ence      float6
1ca60	34 20 60 6a 73 6f 6e 3a  22 63 6f 6e 66 69 64 65   4 `json:"confide
1ca70	6e 63 65 22 60 0a 09 5a  53 63 6f 72 65 20 20 20   nce"`..ZScore   
1ca80	20 20 20 20 20 20 20 66  6c 6f 61 74 36 34 20 60          float64 `
1ca90	6a 73 6f 6e 3a 22 7a 5f  73 63 6f 72 65 2c 6f 6d   json:"z_score,om
1caa0	69 74 65 6d 70 74 79 22  60 0a 09 43 6f 72 72 65   itempty"`..Corre
1cab0	6c 61 74 69 6f 6e 20 20  20 20 20 66 6c 6f 61 74   lation     float
1cac0	36 34 20 60 6a 73 6f 6e  3a 22 63 6f 72 72 65 6c   64 `json:"correl
1cad0	61 74 69 6f 6e 2c 6f 6d  69 74 65 6d 70 74 79 22   ation,omitempty"
1cae0	60 0a 09 44 65 76 69 61  74 69 6f 6e 20 20 20 20   `..Deviation    
1caf0	20 20 20 66 6c 6f 61 74  36 34 20 60 6a 73 6f 6e      float64 `json
1cb00	3a 22 64 65 76 69 61 74  69 6f 6e 2c 6f 6d 69 74   :"deviation,omit
1cb10	65 6d 70 74 79 22 60 20  2f 2f 20 e5 81 8f e7 a6   empty"` // .....
1cb20	bb e5 ba a6 ef bc 8c e7  94 a8 e4 ba 8e e7 9b b8   ................
1cb30	e5 85 b3 e6 80 a7 e5 a5  97 e5 88 a9 0a 09 52 53   ..............RS
1cb40	49 20 20 20 20 20 20 20  20 20 20 20 20 20 66 6c   I             fl
1cb50	6f 61 74 36 34 20 60 6a  73 6f 6e 3a 22 72 73 69   oat64 `json:"rsi
1cb60	2c 6f 6d 69 74 65 6d 70  74 79 22 60 0a 09 4d 6f   ,omitempty"`..Mo
1cb70	6d 65 6e 74 75 6d 20 20  20 20 20 20 20 20 66 6c   mentum        fl
1cb80	6f 61 74 36 34 20 60 6a  73 6f 6e 3a 22 6d 6f 6d   oat64 `json:"mom
1cb90	65 6e 74 75 6d 2c 6f 6d  69 74 65 6d 70 74 79 22   entum,omitempty"
1cba0	60 0a 09 54 69 6d 65 48  6f 72 69 7a 6f 6e 20 20   `..TimeHorizon  
1cbb0	20 20 20 69 6e 74 20 20  20 20 20 60 6a 73 6f 6e      int     `json
1cbc0	3a 22 74 69 6d 65 5f 68  6f 72 69 7a 6f 6e 22 60   :"time_horizon"`
1cbd0	0a 09 52 69 73 6b 4c 65  76 65 6c 20 20 20 20 20   ..RiskLevel     
1cbe0	20 20 73 74 72 69 6e 67  20 20 60 6a 73 6f 6e 3a     string  `json:
1cbf0	22 72 69 73 6b 5f 6c 65  76 65 6c 22 60 0a 7d 0a   "risk_level"`.}.
1cc00	0a 2f 2f 20 63 61 6c 63  75 6c 61 74 65 50 72 69   .// calculatePri
1cc10	63 65 43 6f 72 72 65 6c  61 74 69 6f 6e 20 e8 ae   ceCorrelation ..
1cc20	a1 e7 ae 97 e4 b8 a4 e4  b8 aa e4 bb b7 e6 a0 bc   ................
1cc30	e5 ba 8f e5 88 97 e7 9a  84 e7 9b b8 e5 85 b3 e6   ................
1cc40	80 a7 0a 66 75 6e 63 20  28 62 65 20 2a 42 61 63   ...func (be *Bac
1cc50	6b 74 65 73 74 45 6e 67  69 6e 65 29 20 63 61 6c   ktestEngine) cal
1cc60	63 75 6c 61 74 65 50 72  69 63 65 43 6f 72 72 65   culatePriceCorre
1cc70	6c 61 74 69 6f 6e 28 73  65 72 69 65 73 31 2c 20   lation(series1, 
1cc80	73 65 72 69 65 73 32 20  5b 5d 66 6c 6f 61 74 36   series2 []float6
1cc90	34 29 20 66 6c 6f 61 74  36 34 20 7b 0a 09 69 66   4) float64 {..if
1cca0	20 6c 65 6e 28 73 65 72  69 65 73 31 29 20 21 3d    len(series1) !=
1ccb0	20 6c 65 6e 28 73 65 72  69 65 73 32 29 20 7c 7c    len(series2) ||
1ccc0	20 6c 65 6e 28 73 65 72  69 65 73 31 29 20 3d 3d    len(series1) ==
1ccd0	20 30 20 7b 0a 09 09 72  65 74 75 72 6e 20 30 2e    0 {...return 0.
1cce0	30 0a 09 7d 0a 0a 09 6e  20 3a 3d 20 6c 65 6e 28   0..}...n := len(
1ccf0	73 65 72 69 65 73 31 29  0a 09 6d 65 61 6e 31 2c   series1)..mean1,
1cd00	20 6d 65 61 6e 32 20 3a  3d 20 30 2e 30 2c 20 30    mean2 := 0.0, 0
1cd10	2e 30 0a 0a 09 2f 2f 20  e8 ae a1 e7 ae 97 e5 9d   .0...// ........
1cd20	87 e5 80 bc 0a 09 66 6f  72 20 69 20 3a 3d 20 30   ......for i := 0
1cd30	3b 20 69 20 3c 20 6e 3b  20 69 2b 2b 20 7b 0a 09   ; i < n; i++ {..
1cd40	09 6d 65 61 6e 31 20 2b  3d 20 73 65 72 69 65 73   .mean1 += series
1cd50	31 5b 69 5d 0a 09 09 6d  65 61 6e 32 20 2b 3d 20   1[i]...mean2 += 
1cd60	73 65 72 69 65 73 32 5b  69 5d 0a 09 7d 0a 09 6d   series2[i]..}..m
1cd70	65 61 6e 31 20 2f 3d 20  66 6c 6f 61 74 36 34 28   ean1 /= float64(
1cd80	6e 29 0a 09 6d 65 61 6e  32 20 2f 3d 20 66 6c 6f   n)..mean2 /= flo
1cd90	61 74 36 34 28 6e 29 0a  0a 09 2f 2f 20 e8 ae a1   at64(n)...// ...
1cda0	e7 ae 97 e5 8d 8f e6 96  b9 e5 b7 ae e5 92 8c e6   ................
1cdb0	96 b9 e5 b7 ae 0a 09 6e  75 6d 65 72 61 74 6f 72   .......numerator
1cdc0	20 3a 3d 20 30 2e 30 0a  09 76 61 72 31 2c 20 76    := 0.0..var1, v
1cdd0	61 72 32 20 3a 3d 20 30  2e 30 2c 20 30 2e 30 0a   ar2 := 0.0, 0.0.
1cde0	0a 09 66 6f 72 20 69 20  3a 3d 20 30 3b 20 69 20   ..for i := 0; i 
1cdf0	3c 20 6e 3b 20 69 2b 2b  20 7b 0a 09 09 64 69 66   < n; i++ {...dif
1ce00	66 31 20 3a 3d 20 73 65  72 69 65 73 31 5b 69 5d   f1 := series1[i]
1ce10	20 2d 20 6d 65 61 6e 31  0a 09 09 64 69 66 66 32    - mean1...diff2
1ce20	20 3a 3d 20 73 65 72 69  65 73 32 5b 69 5d 20 2d    := series2[i] -
1ce30	20 6d 65 61 6e 32 0a 0a  09 09 6e 75 6d 65 72 61    mean2....numera
1ce40	74 6f 72 20 2b 3d 20 64  69 66 66 31 20 2a 20 64   tor += diff1 * d
1ce50	69 66 66 32 0a 09 09 76  61 72 31 20 2b 3d 20 64   iff2...var1 += d
1ce60	69 66 66 31 20 2a 20 64  69 66 66 31 0a 09 09 76   iff1 * diff1...v
1ce70	61 72 32 20 2b 3d 20 64  69 66 66 32 20 2a 20 64   ar2 += diff2 * d
1ce80	69 66 66 32 0a 09 7d 0a  0a 09 64 65 6e 6f 6d 69   iff2..}...denomi
1ce90	6e 61 74 6f 72 20 3a 3d  20 6d 61 74 68 2e 53 71   nator := math.Sq
1cea0	72 74 28 76 61 72 31 20  2a 20 76 61 72 32 29 0a   rt(var1 * var2).
1ceb0	09 69 66 20 64 65 6e 6f  6d 69 6e 61 74 6f 72 20   .if denominator 
1cec0	3d 3d 20 30 20 7b 0a 09  09 72 65 74 75 72 6e 20   == 0 {...return 
1ced0	30 2e 30 0a 09 7d 0a 0a  09 72 65 74 75 72 6e 20   0.0..}...return 
1cee0	6e 75 6d 65 72 61 74 6f  72 20 2f 20 64 65 6e 6f   numerator / deno
1cef0	6d 69 6e 61 74 6f 72 0a  7d 0a 0a 2f 2f 20 63 61   minator.}..// ca
1cf00	6c 63 75 6c 61 74 65 44  69 76 65 72 73 69 66 69   lculateDiversifi
1cf10	63 61 74 69 6f 6e 53 63  6f 72 65 20 e8 ae a1 e7   cationScore ....
1cf20	ae 97 e5 a4 9a e6 a0 b7  e5 8c 96 e8 af 84 e5 88   ................
1cf30	86 0a 66 75 6e 63 20 28  62 65 20 2a 42 61 63 6b   ..func (be *Back
1cf40	74 65 73 74 45 6e 67 69  6e 65 29 20 63 61 6c 63   testEngine) calc
1cf50	75 6c 61 74 65 44 69 76  65 72 73 69 66 69 63 61   ulateDiversifica
1cf60	74 69 6f 6e 53 63 6f 72  65 28 63 6f 72 72 65 6c   tionScore(correl
1cf70	61 74 69 6f 6e 4d 61 74  72 69 78 20 6d 61 70 5b   ationMatrix map[
1cf80	73 74 72 69 6e 67 5d 6d  61 70 5b 73 74 72 69 6e   string]map[strin
1cf90	67 5d 66 6c 6f 61 74 36  34 29 20 66 6c 6f 61 74   g]float64) float
1cfa0	36 34 20 7b 0a 09 69 66  20 6c 65 6e 28 63 6f 72   64 {..if len(cor
1cfb0	72 65 6c 61 74 69 6f 6e  4d 61 74 72 69 78 29 20   relationMatrix) 
1cfc0	3c 3d 20 31 20 7b 0a 09  09 72 65 74 75 72 6e 20   <= 1 {...return 
1cfd0	30 2e 30 0a 09 7d 0a 0a  09 76 61 72 20 74 6f 74   0.0..}...var tot
1cfe0	61 6c 43 6f 72 72 20 66  6c 6f 61 74 36 34 0a 09   alCorr float64..
1cff0	76 61 72 20 70 61 69 72  43 6f 75 6e 74 20 69 6e   var pairCount in
1d000	74 0a 0a 09 66 6f 72 20  5f 2c 20 63 6f 72 72 65   t...for _, corre
1d010	6c 61 74 69 6f 6e 73 20  3a 3d 20 72 61 6e 67 65   lations := range
1d020	20 63 6f 72 72 65 6c 61  74 69 6f 6e 4d 61 74 72    correlationMatr
1d030	69 78 20 7b 0a 09 09 66  6f 72 20 5f 2c 20 63 6f   ix {...for _, co
1d040	72 72 20 3a 3d 20 72 61  6e 67 65 20 63 6f 72 72   rr := range corr
1d050	65 6c 61 74 69 6f 6e 73  20 7b 0a 09 09 09 69 66   elations {....if
1d060	20 63 6f 72 72 20 3c 20  31 2e 30 20 7b 20 2f 2f    corr < 1.0 { //
1d070	20 e6 8e 92 e9 99 a4 e8  87 aa e7 9b b8 e5 85 b3    ...............
1d080	0a 09 09 09 09 74 6f 74  61 6c 43 6f 72 72 20 2b   .....totalCorr +
1d090	3d 20 6d 61 74 68 2e 41  62 73 28 63 6f 72 72 29   = math.Abs(corr)
1d0a0	20 2f 2f 20 e4 bd bf e7  94 a8 e7 bb 9d e5 af b9    // ............
1d0b0	e5 80 bc ef bc 8c e5 9b  a0 e4 b8 ba e8 b4 9f e7   ................
1d0c0	9b b8 e5 85 b3 e4 b9 9f  e6 98 af e5 a4 9a e6 a0   ................
1d0d0	b7 e5 8c 96 0a 09 09 09  09 70 61 69 72 43 6f 75   .........pairCou
1d0e0	6e 74 2b 2b 0a 09 09 09  7d 0a 09 09 7d 0a 09 7d   nt++....}...}..}
1d0f0	0a 0a 09 69 66 20 70 61  69 72 43 6f 75 6e 74 20   ...if pairCount 
1d100	3d 3d 20 30 20 7b 0a 09  09 72 65 74 75 72 6e 20   == 0 {...return 
1d110	30 2e 30 0a 09 7d 0a 0a  09 61 76 67 43 6f 72 72   0.0..}...avgCorr
1d120	65 6c 61 74 69 6f 6e 20  3a 3d 20 74 6f 74 61 6c   elation := total
1d130	43 6f 72 72 20 2f 20 66  6c 6f 61 74 36 34 28 70   Corr / float64(p
1d140	61 69 72 43 6f 75 6e 74  29 0a 0a 09 2f 2f 20 e5   airCount)...// .
1d150	a4 9a e6 a0 b7 e5 8c 96  e8 af 84 e5 88 86 ef bc   ................
1d160	9a e7 9b b8 e5 85 b3 e6  80 a7 e8 b6 8a e4 bd 8e   ................
1d170	ef bc 8c e5 a4 9a e6 a0  b7 e5 8c 96 e8 b6 8a e5   ................
1d180	a5 bd 0a 09 2f 2f 20 30  2e 30 20 3d 20 e5 ae 8c   ....// 0.0 = ...
1d190	e5 85 a8 e7 9b b8 e5 85  b3 ef bc 8c 31 2e 30 20   ............1.0 
1d1a0	3d 20 e5 ae 8c e5 85 a8  e4 b8 8d e7 9b b8 e5 85   = ..............
1d1b0	b3 0a 09 64 69 76 65 72  73 69 66 69 63 61 74 69   ...diversificati
1d1c0	6f 6e 53 63 6f 72 65 20  3a 3d 20 31 2e 30 20 2d   onScore := 1.0 -
1d1d0	20 6d 61 74 68 2e 41 62  73 28 61 76 67 43 6f 72    math.Abs(avgCor
1d1e0	72 65 6c 61 74 69 6f 6e  29 0a 0a 09 72 65 74 75   relation)...retu
1d1f0	72 6e 20 64 69 76 65 72  73 69 66 69 63 61 74 69   rn diversificati
1d200	6f 6e 53 63 6f 72 65 0a  7d 0a 0a 2f 2f 20 63 61   onScore.}..// ca
1d210	6c 63 75 6c 61 74 65 52  69 73 6b 43 6f 6e 63 65   lculateRiskConce
1d220	6e 74 72 61 74 69 6f 6e  20 e8 ae a1 e7 ae 97 e9   ntration .......
1d230	a3 8e e9 99 a9 e9 9b 86  e4 b8 ad e5 ba a6 0a 66   ...............f
1d240	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
1d250	74 45 6e 67 69 6e 65 29  20 63 61 6c 63 75 6c 61   tEngine) calcula
1d260	74 65 52 69 73 6b 43 6f  6e 63 65 6e 74 72 61 74   teRiskConcentrat
1d270	69 6f 6e 28 73 79 6d 62  6f 6c 53 74 61 74 65 73   ion(symbolStates
1d280	20 6d 61 70 5b 73 74 72  69 6e 67 5d 2a 53 79 6d    map[string]*Sym
1d290	62 6f 6c 53 74 61 74 65  29 20 66 6c 6f 61 74 36   bolState) float6
1d2a0	34 20 7b 0a 09 74 6f 74  61 6c 56 61 6c 75 65 20   4 {..totalValue 
1d2b0	3a 3d 20 30 2e 30 0a 09  76 61 72 20 70 6f 73 69   := 0.0..var posi
1d2c0	74 69 6f 6e 56 61 6c 75  65 73 20 5b 5d 66 6c 6f   tionValues []flo
1d2d0	61 74 36 34 0a 0a 09 66  6f 72 20 5f 2c 20 73 74   at64...for _, st
1d2e0	61 74 65 20 3a 3d 20 72  61 6e 67 65 20 73 79 6d   ate := range sym
1d2f0	62 6f 6c 53 74 61 74 65  73 20 7b 0a 09 09 69 66   bolStates {...if
1d300	20 73 74 61 74 65 2e 50  6f 73 69 74 69 6f 6e 20    state.Position 
1d310	3e 20 30 20 7b 0a 09 09  09 70 6f 73 69 74 69 6f   > 0 {....positio
1d320	6e 56 61 6c 75 65 20 3a  3d 20 73 74 61 74 65 2e   nValue := state.
1d330	50 6f 73 69 74 69 6f 6e  20 2a 20 73 74 61 74 65   Position * state
1d340	2e 44 61 74 61 5b 6c 65  6e 28 73 74 61 74 65 2e   .Data[len(state.
1d350	44 61 74 61 29 2d 31 5d  2e 50 72 69 63 65 0a 09   Data)-1].Price..
1d360	09 09 70 6f 73 69 74 69  6f 6e 56 61 6c 75 65 73   ..positionValues
1d370	20 3d 20 61 70 70 65 6e  64 28 70 6f 73 69 74 69    = append(positi
1d380	6f 6e 56 61 6c 75 65 73  2c 20 70 6f 73 69 74 69   onValues, positi
1d390	6f 6e 56 61 6c 75 65 29  0a 09 09 09 74 6f 74 61   onValue)....tota
1d3a0	6c 56 61 6c 75 65 20 2b  3d 20 70 6f 73 69 74 69   lValue += positi
1d3b0	6f 6e 56 61 6c 75 65 0a  09 09 7d 0a 09 7d 0a 0a   onValue...}..}..
1d3c0	09 69 66 20 74 6f 74 61  6c 56 61 6c 75 65 20 3d   .if totalValue =
1d3d0	3d 20 30 20 7c 7c 20 6c  65 6e 28 70 6f 73 69 74   = 0 || len(posit
1d3e0	69 6f 6e 56 61 6c 75 65  73 29 20 3d 3d 20 30 20   ionValues) == 0 
1d3f0	7b 0a 09 09 72 65 74 75  72 6e 20 30 2e 30 0a 09   {...return 0.0..
1d400	7d 0a 0a 09 2f 2f 20 e8  ae a1 e7 ae 97 e8 b5 ab   }...// .........
1d410	e8 8a ac e8 be be e5 b0  94 2d e8 b5 ab e5 b8 8c   .........-......
1d420	e6 9b bc e6 8c 87 e6 95  b0 ef bc 88 48 48 49 ef   ............HHI.
1d430	bc 89 e6 9d a5 e8 a1 a1  e9 87 8f e9 9b 86 e4 b8   ................
1d440	ad e5 ba a6 0a 09 68 68  69 20 3a 3d 20 30 2e 30   ......hhi := 0.0
1d450	0a 09 66 6f 72 20 5f 2c  20 76 61 6c 75 65 20 3a   ..for _, value :
1d460	3d 20 72 61 6e 67 65 20  70 6f 73 69 74 69 6f 6e   = range position
1d470	56 61 6c 75 65 73 20 7b  0a 09 09 73 68 61 72 65   Values {...share
1d480	20 3a 3d 20 76 61 6c 75  65 20 2f 20 74 6f 74 61    := value / tota
1d490	6c 56 61 6c 75 65 0a 09  09 68 68 69 20 2b 3d 20   lValue...hhi += 
1d4a0	73 68 61 72 65 20 2a 20  73 68 61 72 65 0a 09 7d   share * share..}
1d4b0	0a 0a 09 2f 2f 20 e5 bd  92 e4 b8 80 e5 8c 96 e5   ...// ..........
1d4c0	88 b0 30 2d 31 e8 8c 83  e5 9b b4 ef bc 88 30 3d   ..0-1.........0=
1d4d0	e5 ae 8c e5 85 a8 e5 88  86 e6 95 a3 ef bc 8c 31   ...............1
1d4e0	3d e5 ae 8c e5 85 a8 e9  9b 86 e4 b8 ad ef bc 89   =...............
1d4f0	0a 09 72 65 74 75 72 6e  20 68 68 69 0a 7d 0a 0a   ..return hhi.}..
1d500	2f 2f 20 63 61 6c 63 75  6c 61 74 65 52 69 73 6b   // calculateRisk
1d510	41 64 6a 75 73 74 65 64  53 63 6f 72 65 73 20 e8   AdjustedScores .
1d520	ae a1 e7 ae 97 e9 a3 8e  e9 99 a9 e8 b0 83 e6 95   ................
1d530	b4 e5 90 8e e7 9a 84 e6  9c ba e4 bc 9a e8 af 84   ................
1d540	e5 88 86 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
1d550	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 63 61   cktestEngine) ca
1d560	6c 63 75 6c 61 74 65 52  69 73 6b 41 64 6a 75 73   lculateRiskAdjus
1d570	74 65 64 53 63 6f 72 65  73 28 6f 70 70 6f 72 74   tedScores(opport
1d580	75 6e 69 74 69 65 73 20  5b 5d 2a 53 79 6d 62 6f   unities []*Symbo
1d590	6c 4f 70 70 6f 72 74 75  6e 69 74 79 2c 20 61 6e   lOpportunity, an
1d5a0	61 6c 79 73 69 73 20 2a  4d 75 6c 74 69 53 79 6d   alysis *MultiSym
1d5b0	62 6f 6c 4d 61 72 6b 65  74 41 6e 61 6c 79 73 69   bolMarketAnalysi
1d5c0	73 2c 20 73 79 6d 62 6f  6c 53 74 61 74 65 73 20   s, symbolStates 
1d5d0	6d 61 70 5b 73 74 72 69  6e 67 5d 2a 53 79 6d 62   map[string]*Symb
1d5e0	6f 6c 53 74 61 74 65 29  20 5b 5d 2a 53 79 6d 62   olState) []*Symb
1d5f0	6f 6c 4f 70 70 6f 72 74  75 6e 69 74 79 20 7b 0a   olOpportunity {.
1d600	09 66 6f 72 20 5f 2c 20  6f 70 70 20 3a 3d 20 72   .for _, opp := r
1d610	61 6e 67 65 20 6f 70 70  6f 72 74 75 6e 69 74 69   ange opportuniti
1d620	65 73 20 7b 0a 09 09 2f  2f 20 31 2e 20 e8 ae a1   es {...// 1. ...
1d630	e7 ae 97 e4 b8 aa e4 bd  93 e9 a3 8e e9 99 a9 e8   ................
1d640	af 84 e5 88 86 0a 09 09  6f 70 70 2e 52 69 73 6b   ........opp.Risk
1d650	53 63 6f 72 65 20 3d 20  62 65 2e 63 61 6c 63 75   Score = be.calcu
1d660	6c 61 74 65 49 6e 64 69  76 69 64 75 61 6c 52 69   lateIndividualRi
1d670	73 6b 53 63 6f 72 65 28  6f 70 70 2c 20 73 79 6d   skScore(opp, sym
1d680	62 6f 6c 53 74 61 74 65  73 29 0a 0a 09 09 2f 2f   bolStates)....//
1d690	20 32 2e 20 e8 ae a1 e7  ae 97 e5 b8 82 e5 9c ba    2. ............
1d6a0	e9 80 82 e5 ba 94 e6 80  a7 e8 af 84 e5 88 86 0a   ................
1d6b0	09 09 6f 70 70 2e 4d 61  72 6b 65 74 53 63 6f 72   ..opp.MarketScor
1d6c0	65 20 3d 20 62 65 2e 63  61 6c 63 75 6c 61 74 65   e = be.calculate
1d6d0	4d 61 72 6b 65 74 41 64  61 70 74 61 74 69 6f 6e   MarketAdaptation
1d6e0	53 63 6f 72 65 28 6f 70  70 2c 20 61 6e 61 6c 79   Score(opp, analy
1d6f0	73 69 73 29 0a 0a 09 09  2f 2f 20 33 2e 20 e8 ae   sis)....// 3. ..
1d700	a1 e7 ae 97 e6 9c 80 e7  bb 88 e7 9a 84 e9 a3 8e   ................
1d710	e9 99 a9 e8 b0 83 e6 95  b4 e5 88 86 e6 95 b0 0a   ................
1d720	09 09 72 69 73 6b 41 64  6a 75 73 74 6d 65 6e 74   ..riskAdjustment
1d730	20 3a 3d 20 62 65 2e 63  61 6c 63 75 6c 61 74 65    := be.calculate
1d740	52 69 73 6b 41 64 6a 75  73 74 6d 65 6e 74 46 61   RiskAdjustmentFa
1d750	63 74 6f 72 28 6f 70 70  2c 20 61 6e 61 6c 79 73   ctor(opp, analys
1d760	69 73 29 0a 09 09 6f 70  70 2e 52 69 73 6b 41 64   is)...opp.RiskAd
1d770	6a 75 73 74 6d 65 6e 74  20 3d 20 72 69 73 6b 41   justment = riskA
1d780	64 6a 75 73 74 6d 65 6e  74 0a 0a 09 09 2f 2f 20   djustment....// 
1d790	e6 9c 80 e7 bb 88 e5 88  86 e6 95 b0 20 3d 20 e5   ............ = .
1d7a0	9f ba e7 a1 80 e5 88 86  e6 95 b0 20 2a 20 e9 a3   ........... * ..
1d7b0	8e e9 99 a9 e8 b0 83 e6  95 b4 e5 9b a0 e5 ad 90   ................
1d7c0	20 2a 20 e5 b8 82 e5 9c  ba e9 80 82 e5 ba 94 e5    * .............
1d7d0	9b a0 e5 ad 90 0a 09 09  6f 70 70 2e 53 63 6f 72   ........opp.Scor
1d7e0	65 20 3d 20 6f 70 70 2e  42 61 73 65 53 63 6f 72   e = opp.BaseScor
1d7f0	65 20 2a 20 72 69 73 6b  41 64 6a 75 73 74 6d 65   e * riskAdjustme
1d800	6e 74 20 2a 20 6f 70 70  2e 4d 61 72 6b 65 74 53   nt * opp.MarketS
1d810	63 6f 72 65 0a 0a 09 09  6c 6f 67 2e 50 72 69 6e   core....log.Prin
1d820	74 66 28 22 5b 52 49 53  4b 5f 41 44 4a 55 53 54   tf("[RISK_ADJUST
1d830	4d 45 4e 54 5d 20 25 73  3a 20 e5 9f ba e7 a1 80   MENT] %s: ......
1d840	3d 25 2e 33 66 2c 20 e9  a3 8e e9 99 a9 e8 b0 83   =%.3f, .........
1d850	e6 95 b4 3d 25 2e 33 66  2c 20 e5 b8 82 e5 9c ba   ...=%.3f, ......
1d860	e9 80 82 e5 ba 94 3d 25  2e 33 66 2c 20 e6 9c 80   ......=%.3f, ...
1d870	e7 bb 88 3d 25 2e 33 66  22 2c 0a 09 09 09 6f 70   ...=%.3f",....op
1d880	70 2e 53 79 6d 62 6f 6c  2c 20 6f 70 70 2e 42 61   p.Symbol, opp.Ba
1d890	73 65 53 63 6f 72 65 2c  20 72 69 73 6b 41 64 6a   seScore, riskAdj
1d8a0	75 73 74 6d 65 6e 74 2c  20 6f 70 70 2e 4d 61 72   ustment, opp.Mar
1d8b0	6b 65 74 53 63 6f 72 65  2c 20 6f 70 70 2e 53 63   ketScore, opp.Sc
1d8c0	6f 72 65 29 0a 09 7d 0a  0a 09 72 65 74 75 72 6e   ore)..}...return
1d8d0	20 6f 70 70 6f 72 74 75  6e 69 74 69 65 73 0a 7d    opportunities.}
1d8e0	0a 0a 2f 2f 20 63 61 6c  63 75 6c 61 74 65 49 6e   ..// calculateIn
1d8f0	64 69 76 69 64 75 61 6c  52 69 73 6b 53 63 6f 72   dividualRiskScor
1d900	65 20 e8 ae a1 e7 ae 97  e4 b8 aa e4 bd 93 e9 a3   e ..............
1d910	8e e9 99 a9 e8 af 84 e5  88 86 0a 66 75 6e 63 20   ...........func 
1d920	28 62 65 20 2a 42 61 63  6b 74 65 73 74 45 6e 67   (be *BacktestEng
1d930	69 6e 65 29 20 63 61 6c  63 75 6c 61 74 65 49 6e   ine) calculateIn
1d940	64 69 76 69 64 75 61 6c  52 69 73 6b 53 63 6f 72   dividualRiskScor
1d950	65 28 6f 70 70 20 2a 53  79 6d 62 6f 6c 4f 70 70   e(opp *SymbolOpp
1d960	6f 72 74 75 6e 69 74 79  2c 20 73 79 6d 62 6f 6c   ortunity, symbol
1d970	53 74 61 74 65 73 20 6d  61 70 5b 73 74 72 69 6e   States map[strin
1d980	67 5d 2a 53 79 6d 62 6f  6c 53 74 61 74 65 29 20   g]*SymbolState) 
1d990	66 6c 6f 61 74 36 34 20  7b 0a 09 2f 2f 20 e5 9f   float64 {..// ..
1d9a0	ba e4 ba 8e e6 b3 a2 e5  8a a8 e7 8e 87 e5 92 8c   ................
1d9b0	e6 8c 81 e4 bb 93 e6 97  b6 e9 97 b4 e8 ae a1 e7   ................
1d9c0	ae 97 e9 a3 8e e9 99 a9  0a 09 76 6f 6c 61 74 69   ..........volati
1d9d0	6c 69 74 79 20 3a 3d 20  6f 70 70 2e 46 65 61 74   lity := opp.Feat
1d9e0	75 72 65 73 5b 22 76 6f  6c 61 74 69 6c 69 74 79   ures["volatility
1d9f0	5f 32 30 22 5d 0a 09 69  66 20 76 6f 6c 61 74 69   _20"]..if volati
1da00	6c 69 74 79 20 3c 3d 20  30 20 7b 0a 09 09 76 6f   lity <= 0 {...vo
1da10	6c 61 74 69 6c 69 74 79  20 3d 20 30 2e 30 32 20   latility = 0.02 
1da20	2f 2f 20 e9 bb 98 e8 ae  a4 e6 b3 a2 e5 8a a8 e7   // .............
1da30	8e 87 0a 09 7d 0a 0a 09  2f 2f 20 e6 b3 a2 e5 8a   ....}...// .....
1da40	a8 e7 8e 87 e9 a3 8e e9  99 a9 ef bc 9a e6 b3 a2   ................
1da50	e5 8a a8 e7 8e 87 e8 b6  8a e9 ab 98 ef bc 8c e9   ................
1da60	a3 8e e9 99 a9 e8 b6 8a  e5 a4 a7 0a 09 76 6f 6c   .............vol
1da70	61 74 69 6c 69 74 79 52  69 73 6b 20 3a 3d 20 6d   atilityRisk := m
1da80	61 74 68 2e 4d 69 6e 28  76 6f 6c 61 74 69 6c 69   ath.Min(volatili
1da90	74 79 2f 30 2e 31 2c 20  31 2e 30 29 20 2f 2f 20   ty/0.1, 1.0) // 
1daa0	e6 b3 a2 e5 8a a8 e7 8e  87 e8 b6 85 e8 bf 87 31   ...............1
1dab0	30 25 e4 b8 ba e9 ab 98  e9 a3 8e e9 99 a9 0a 0a   0%..............
1dac0	09 2f 2f 20 e6 97 b6 e6  9c ba e9 a3 8e e9 99 a9   .// ............
1dad0	ef bc 9a e5 b8 82 e5 9c  ba e6 97 b6 e6 9c ba e4   ................
1dae0	b8 8d e4 bd b3 e6 97 b6  e9 a3 8e e9 99 a9 e5 a2   ................
1daf0	9e e5 8a a0 0a 09 74 69  6d 69 6e 67 52 69 73 6b   ......timingRisk
1db00	20 3a 3d 20 62 65 2e 63  61 6c 63 75 6c 61 74 65    := be.calculate
1db10	54 69 6d 69 6e 67 52 69  73 6b 28 6f 70 70 2e 46   TimingRisk(opp.F
1db20	65 61 74 75 72 65 73 29  0a 0a 09 2f 2f 20 e6 b5   eatures)...// ..
1db30	81 e5 8a a8 e6 80 a7 e9  a3 8e e9 99 a9 ef bc 9a   ................
1db40	e6 88 90 e4 ba a4 e9 87  8f e4 bd 8e e6 97 b6 e9   ................
1db50	a3 8e e9 99 a9 e5 a2 9e  e5 8a a0 0a 09 6c 69 71   .............liq
1db60	75 69 64 69 74 79 52 69  73 6b 20 3a 3d 20 31 2e   uidityRisk := 1.
1db70	30 0a 09 69 66 20 76 6f  6c 75 6d 65 2c 20 65 78   0..if volume, ex
1db80	69 73 74 73 20 3a 3d 20  6f 70 70 2e 46 65 61 74   ists := opp.Feat
1db90	75 72 65 73 5b 22 66 65  5f 76 6f 6c 75 6d 65 5f   ures["fe_volume_
1dba0	63 75 72 72 65 6e 74 22  5d 3b 20 65 78 69 73 74   current"]; exist
1dbb0	73 20 26 26 20 76 6f 6c  75 6d 65 20 3e 20 30 20   s && volume > 0 
1dbc0	7b 0a 09 09 6c 69 71 75  69 64 69 74 79 52 69 73   {...liquidityRis
1dbd0	6b 20 3d 20 6d 61 74 68  2e 4d 61 78 28 30 2e 31   k = math.Max(0.1
1dbe0	2c 20 31 2e 30 2d 76 6f  6c 75 6d 65 2f 31 30 30   , 1.0-volume/100
1dbf0	30 30 2e 30 29 20 2f 2f  20 e6 88 90 e4 ba a4 e9   00.0) // .......
1dc00	87 8f e4 bd 8e e6 97 b6  e9 a3 8e e9 99 a9 e9 ab   ................
1dc10	98 0a 09 7d 0a 0a 09 2f  2f 20 e7 bb bc e5 90 88   ...}...// ......
1dc20	e9 a3 8e e9 99 a9 e8 af  84 e5 88 86 ef bc 88 30   ...............0
1dc30	2d 31 ef bc 8c 31 e4 b8  ba e6 9c 80 e9 ab 98 e9   -1...1..........
1dc40	a3 8e e9 99 a9 ef bc 89  0a 09 72 69 73 6b 53 63   ..........riskSc
1dc50	6f 72 65 20 3a 3d 20 28  76 6f 6c 61 74 69 6c 69   ore := (volatili
1dc60	74 79 52 69 73 6b 2a 30  2e 34 20 2b 20 74 69 6d   tyRisk*0.4 + tim
1dc70	69 6e 67 52 69 73 6b 2a  30 2e 33 20 2b 20 6c 69   ingRisk*0.3 + li
1dc80	71 75 69 64 69 74 79 52  69 73 6b 2a 30 2e 33 29   quidityRisk*0.3)
1dc90	0a 0a 09 72 65 74 75 72  6e 20 6d 61 74 68 2e 4d   ...return math.M
1dca0	61 78 28 30 2e 30 2c 20  6d 61 74 68 2e 4d 69 6e   ax(0.0, math.Min
1dcb0	28 31 2e 30 2c 20 72 69  73 6b 53 63 6f 72 65 29   (1.0, riskScore)
1dcc0	29 0a 7d 0a 0a 2f 2f 20  63 61 6c 63 75 6c 61 74   ).}..// calculat
1dcd0	65 54 69 6d 69 6e 67 52  69 73 6b 20 e8 ae a1 e7   eTimingRisk ....
1dce0	ae 97 e6 97 b6 e6 9c ba  e9 a3 8e e9 99 a9 0a 66   ...............f
1dcf0	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
1dd00	74 45 6e 67 69 6e 65 29  20 63 61 6c 63 75 6c 61   tEngine) calcula
1dd10	74 65 54 69 6d 69 6e 67  52 69 73 6b 28 66 65 61   teTimingRisk(fea
1dd20	74 75 72 65 73 20 6d 61  70 5b 73 74 72 69 6e 67   tures map[string
1dd30	5d 66 6c 6f 61 74 36 34  29 20 66 6c 6f 61 74 36   ]float64) float6
1dd40	34 20 7b 0a 09 72 73 69  20 3a 3d 20 66 65 61 74   4 {..rsi := feat
1dd50	75 72 65 73 5b 22 72 73  69 5f 31 34 22 5d 0a 09   ures["rsi_14"]..
1dd60	74 72 65 6e 64 20 3a 3d  20 66 65 61 74 75 72 65   trend := feature
1dd70	73 5b 22 74 72 65 6e 64  5f 32 30 22 5d 0a 0a 09   s["trend_20"]...
1dd80	2f 2f 20 52 53 49 e6 9e  81 e7 ab af e5 80 bc e8   // RSI..........
1dd90	a1 a8 e7 a4 ba e6 97 b6  e6 9c ba e9 a3 8e e9 99   ................
1dda0	a9 0a 09 72 73 69 52 69  73 6b 20 3a 3d 20 30 2e   ...rsiRisk := 0.
1ddb0	30 0a 09 69 66 20 72 73  69 20 3e 20 37 30 20 7c   0..if rsi > 70 |
1ddc0	7c 20 72 73 69 20 3c 20  33 30 20 7b 0a 09 09 72   | rsi < 30 {...r
1ddd0	73 69 52 69 73 6b 20 3d  20 30 2e 35 0a 09 7d 0a   siRisk = 0.5..}.
1dde0	0a 09 2f 2f 20 e8 b6 8b  e5 8a bf e5 8f 8d e8 bd   ..// ...........
1ddf0	ac e9 a3 8e e9 99 a9 0a  09 74 72 65 6e 64 52 69   .........trendRi
1de00	73 6b 20 3a 3d 20 30 2e  30 0a 09 69 66 20 6d 61   sk := 0.0..if ma
1de10	74 68 2e 41 62 73 28 74  72 65 6e 64 29 20 3e 20   th.Abs(trend) > 
1de20	30 2e 30 35 20 7b 0a 09  09 74 72 65 6e 64 52 69   0.05 {...trendRi
1de30	73 6b 20 3d 20 30 2e 33  0a 09 7d 0a 0a 09 72 65   sk = 0.3..}...re
1de40	74 75 72 6e 20 6d 61 74  68 2e 4d 69 6e 28 31 2e   turn math.Min(1.
1de50	30 2c 20 72 73 69 52 69  73 6b 2b 74 72 65 6e 64   0, rsiRisk+trend
1de60	52 69 73 6b 29 0a 7d 0a  0a 2f 2f 20 63 61 6c 63   Risk).}..// calc
1de70	75 6c 61 74 65 4d 61 72  6b 65 74 41 64 61 70 74   ulateMarketAdapt
1de80	61 74 69 6f 6e 53 63 6f  72 65 20 e8 ae a1 e7 ae   ationScore .....
1de90	97 e5 b8 82 e5 9c ba e9  80 82 e5 ba 94 e6 80 a7   ................
1dea0	e8 af 84 e5 88 86 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
1deb0	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
1dec0	20 63 61 6c 63 75 6c 61  74 65 4d 61 72 6b 65 74    calculateMarket
1ded0	41 64 61 70 74 61 74 69  6f 6e 53 63 6f 72 65 28   AdaptationScore(
1dee0	6f 70 70 20 2a 53 79 6d  62 6f 6c 4f 70 70 6f 72   opp *SymbolOppor
1def0	74 75 6e 69 74 79 2c 20  61 6e 61 6c 79 73 69 73   tunity, analysis
1df00	20 2a 4d 75 6c 74 69 53  79 6d 62 6f 6c 4d 61 72    *MultiSymbolMar
1df10	6b 65 74 41 6e 61 6c 79  73 69 73 29 20 66 6c 6f   ketAnalysis) flo
1df20	61 74 36 34 20 7b 0a 09  73 63 6f 72 65 20 3a 3d   at64 {..score :=
1df30	20 31 2e 30 0a 0a 09 2f  2f 20 e6 a0 b9 e6 8d ae    1.0...// ......
1df40	e5 b8 82 e5 9c ba e7 8e  af e5 a2 83 e8 b0 83 e6   ................
1df50	95 b4 e8 af 84 e5 88 86  0a 09 73 77 69 74 63 68   ..........switch
1df60	20 61 6e 61 6c 79 73 69  73 2e 4d 61 72 6b 65 74    analysis.Market
1df70	52 65 67 69 6d 65 20 7b  0a 09 63 61 73 65 20 22   Regime {..case "
1df80	6d 75 6c 74 69 5f 62 75  6c 6c 22 3a 0a 09 09 2f   multi_bull":.../
1df90	2f 20 e5 a4 9a e5 a4 b4  e5 b8 82 e5 9c ba ef bc   / ..............
1dfa0	9a e6 ad a3 e5 90 91 e4  bf a1 e5 8f b7 e6 9b b4   ................
1dfb0	e5 8f af e9 9d a0 0a 09  09 69 66 20 6f 70 70 2e   .........if opp.
1dfc0	43 6f 6e 66 69 64 65 6e  63 65 20 3e 20 30 2e 36   Confidence > 0.6
1dfd0	20 7b 0a 09 09 09 73 63  6f 72 65 20 2a 3d 20 31    {....score *= 1
1dfe0	2e 32 0a 09 09 7d 0a 09  63 61 73 65 20 22 6d 75   .2...}..case "mu
1dff0	6c 74 69 5f 62 65 61 72  22 3a 0a 09 09 2f 2f 20   lti_bear":...// 
1e000	e7 a9 ba e5 a4 b4 e5 b8  82 e5 9c ba ef bc 9a e9   ................
1e010	80 82 e5 ba a6 e8 b0 a8  e6 85 8e ef bc 8c e4 bd   ................
1e020	86 e4 b8 8d e5 ae 8c e5  85 a8 e6 94 be e5 bc 83   ................
1e030	e6 9c ba e4 bc 9a 20 2d  20 e4 bc 98 e5 8c 96 ef   ...... - .......
1e040	bc 9a e5 87 8f e5 b0 91  e7 86 8a e5 b8 82 e6 83   ................
1e050	a9 e7 bd 9a ef bc 8c e4  bb 8e 30 2e 39 e6 8f 90   ..........0.9...
1e060	e9 ab 98 e5 88 b0 30 2e  39 35 0a 09 09 73 63 6f   ......0.95...sco
1e070	72 65 20 2a 3d 20 30 2e  39 35 0a 09 63 61 73 65   re *= 0.95..case
1e080	20 22 6d 75 6c 74 69 5f  73 69 64 65 77 61 79 73    "multi_sideways
1e090	22 3a 0a 09 09 2f 2f 20  e9 9c 87 e8 8d a1 e5 b8   ":...// ........
1e0a0	82 e5 9c ba ef bc 9a e9  99 8d e4 bd 8e e9 a2 91   ................
1e0b0	e7 8e 87 20 2d 20 e4 bc  98 e5 8c 96 ef bc 9a e5   ... - ..........
1e0c0	87 8f e5 b0 91 e9 9c 87  e8 8d a1 e6 83 a9 e7 bd   ................
1e0d0	9a ef bc 8c e4 bb 8e 30  2e 38 e6 8f 90 e9 ab 98   .......0.8......
1e0e0	e5 88 b0 30 2e 39 0a 09  09 73 63 6f 72 65 20 2a   ...0.9...score *
1e0f0	3d 20 30 2e 39 0a 09 63  61 73 65 20 22 6d 69 78   = 0.9..case "mix
1e100	65 64 22 3a 0a 09 09 2f  2f 20 e6 b7 b7 e5 90 88   ed":...// ......
1e110	e5 b8 82 e5 9c ba ef bc  9a e4 bf 9d e6 8c 81 e4   ................
1e120	b8 ad e6 80 a7 0a 09 09  73 63 6f 72 65 20 2a 3d   ........score *=
1e130	20 31 2e 30 0a 09 7d 0a  0a 09 2f 2f 20 e9 ab 98    1.0..}...// ...
1e140	e6 b3 a2 e5 8a a8 e7 8e  af e5 a2 83 e4 b8 8b e7   ................
1e150	9a 84 e8 b0 83 e6 95 b4  0a 09 69 66 20 61 6e 61   ..........if ana
1e160	6c 79 73 69 73 2e 56 6f  6c 61 74 69 6c 69 74 79   lysis.Volatility
1e170	49 6e 64 65 78 20 3e 20  30 2e 30 35 20 7b 0a 09   Index > 0.05 {..
1e180	09 73 63 6f 72 65 20 2a  3d 20 30 2e 39 20 2f 2f   .score *= 0.9 //
1e190	20 e9 ab 98 e6 b3 a2 e5  8a a8 e6 97 b6 e6 9b b4    ...............
1e1a0	e4 bf 9d e5 ae 88 0a 09  7d 0a 0a 09 2f 2f 20 e6   ........}...// .
1e1b0	9c ba e4 bc 9a e5 af 86  e5 ba a6 e8 b0 83 e6 95   ................
1e1c0	b4 0a 09 69 66 20 61 6e  61 6c 79 73 69 73 2e 4f   ...if analysis.O
1e1d0	70 70 6f 72 74 75 6e 69  74 79 44 65 6e 73 69 74   pportunityDensit
1e1e0	79 20 3e 20 30 2e 33 20  7b 0a 09 09 73 63 6f 72   y > 0.3 {...scor
1e1f0	65 20 2a 3d 20 30 2e 39  35 20 2f 2f 20 e6 9c ba   e *= 0.95 // ...
1e200	e4 bc 9a e5 a4 aa e5 a4  9a e6 97 b6 e6 9b b4 e8   ................
1e210	b0 a8 e6 85 8e 0a 09 7d  0a 0a 09 72 65 74 75 72   .......}...retur
1e220	6e 20 6d 61 74 68 2e 4d  61 78 28 30 2e 31 2c 20   n math.Max(0.1, 
1e230	6d 61 74 68 2e 4d 69 6e  28 32 2e 30 2c 20 73 63   math.Min(2.0, sc
1e240	6f 72 65 29 29 0a 7d 0a  0a 2f 2f 20 63 61 6c 63   ore)).}..// calc
1e250	75 6c 61 74 65 52 69 73  6b 41 64 6a 75 73 74 6d   ulateRiskAdjustm
1e260	65 6e 74 46 61 63 74 6f  72 20 e8 ae a1 e7 ae 97   entFactor ......
1e270	e9 a3 8e e9 99 a9 e8 b0  83 e6 95 b4 e5 9b a0 e5   ................
1e280	ad 90 0a 66 75 6e 63 20  28 62 65 20 2a 42 61 63   ...func (be *Bac
1e290	6b 74 65 73 74 45 6e 67  69 6e 65 29 20 63 61 6c   ktestEngine) cal
1e2a0	63 75 6c 61 74 65 52 69  73 6b 41 64 6a 75 73 74   culateRiskAdjust
1e2b0	6d 65 6e 74 46 61 63 74  6f 72 28 6f 70 70 20 2a   mentFactor(opp *
1e2c0	53 79 6d 62 6f 6c 4f 70  70 6f 72 74 75 6e 69 74   SymbolOpportunit
1e2d0	79 2c 20 61 6e 61 6c 79  73 69 73 20 2a 4d 75 6c   y, analysis *Mul
1e2e0	74 69 53 79 6d 62 6f 6c  4d 61 72 6b 65 74 41 6e   tiSymbolMarketAn
1e2f0	61 6c 79 73 69 73 29 20  66 6c 6f 61 74 36 34 20   alysis) float64 
1e300	7b 0a 09 2f 2f 20 e5 9f  ba e7 a1 80 e8 b0 83 e6   {..// ..........
1e310	95 b4 e5 9b a0 e5 ad 90  0a 09 62 61 73 65 46 61   ..........baseFa
1e320	63 74 6f 72 20 3a 3d 20  31 2e 30 0a 0a 09 2f 2f   ctor := 1.0...//
1e330	20 e9 a3 8e e9 99 a9 e5  8e 8c e6 81 b6 e8 b0 83    ...............
1e340	e6 95 b4 ef bc 9a e9 a3  8e e9 99 a9 e8 b6 8a e9   ................
1e350	ab 98 ef bc 8c e8 b0 83  e6 95 b4 e5 9b a0 e5 ad   ................
1e360	90 e8 b6 8a e4 bd 8e 0a  09 72 69 73 6b 41 76 65   .........riskAve
1e370	72 73 69 6f 6e 20 3a 3d  20 31 2e 30 20 2d 20 6f   rsion := 1.0 - o
1e380	70 70 2e 52 69 73 6b 53  63 6f 72 65 2a 30 2e 35   pp.RiskScore*0.5
1e390	0a 0a 09 2f 2f 20 e5 a4  9a e6 a0 b7 e5 8c 96 e5   ...// ..........
1e3a0	a5 96 e5 8a b1 ef bc 9a  e7 9b b8 e5 85 b3 e6 80   ................
1e3b0	a7 e4 bd 8e e6 97 b6 e7  bb 99 e4 ba 88 e5 a5 96   ................
1e3c0	e5 8a b1 0a 09 64 69 76  65 72 73 69 66 69 63 61   .....diversifica
1e3d0	74 69 6f 6e 42 6f 6e 75  73 20 3a 3d 20 31 2e 30   tionBonus := 1.0
1e3e0	0a 09 69 66 20 61 6e 61  6c 79 73 69 73 2e 44 69   ..if analysis.Di
1e3f0	76 65 72 73 69 66 69 63  61 74 69 6f 6e 53 63 6f   versificationSco
1e400	72 65 20 3e 20 30 2e 37  20 7b 0a 09 09 64 69 76   re > 0.7 {...div
1e410	65 72 73 69 66 69 63 61  74 69 6f 6e 42 6f 6e 75   ersificationBonu
1e420	73 20 3d 20 31 2e 31 0a  09 7d 0a 0a 09 2f 2f 20   s = 1.1..}...// 
1e430	e9 9b 86 e4 b8 ad e5 ba  a6 e6 83 a9 e7 bd 9a ef   ................
1e440	bc 9a e6 8c 81 e4 bb 93  e8 bf 87 e4 ba 8e e9 9b   ................
1e450	86 e4 b8 ad e6 97 b6 e6  83 a9 e7 bd 9a 0a 09 63   ...............c
1e460	6f 6e 63 65 6e 74 72 61  74 69 6f 6e 50 65 6e 61   oncentrationPena
1e470	6c 74 79 20 3a 3d 20 31  2e 30 0a 09 69 66 20 61   lty := 1.0..if a
1e480	6e 61 6c 79 73 69 73 2e  52 69 73 6b 43 6f 6e 63   nalysis.RiskConc
1e490	65 6e 74 72 61 74 69 6f  6e 20 3e 20 30 2e 35 20   entration > 0.5 
1e4a0	7b 0a 09 09 63 6f 6e 63  65 6e 74 72 61 74 69 6f   {...concentratio
1e4b0	6e 50 65 6e 61 6c 74 79  20 3d 20 30 2e 39 0a 09   nPenalty = 0.9..
1e4c0	7d 0a 0a 09 2f 2f 20 e8  ae a1 e7 ae 97 e6 9c 80   }...// .........
1e4d0	e7 bb 88 e8 b0 83 e6 95  b4 e5 9b a0 e5 ad 90 0a   ................
1e4e0	09 61 64 6a 75 73 74 6d  65 6e 74 46 61 63 74 6f   .adjustmentFacto
1e4f0	72 20 3a 3d 20 62 61 73  65 46 61 63 74 6f 72 20   r := baseFactor 
1e500	2a 20 72 69 73 6b 41 76  65 72 73 69 6f 6e 20 2a   * riskAversion *
1e510	20 64 69 76 65 72 73 69  66 69 63 61 74 69 6f 6e    diversification
1e520	42 6f 6e 75 73 20 2a 20  63 6f 6e 63 65 6e 74 72   Bonus * concentr
1e530	61 74 69 6f 6e 50 65 6e  61 6c 74 79 0a 0a 09 72   ationPenalty...r
1e540	65 74 75 72 6e 20 6d 61  74 68 2e 4d 61 78 28 30   eturn math.Max(0
1e550	2e 31 2c 20 6d 61 74 68  2e 4d 69 6e 28 32 2e 30   .1, math.Min(2.0
1e560	2c 20 61 64 6a 75 73 74  6d 65 6e 74 46 61 63 74   , adjustmentFact
1e570	6f 72 29 29 0a 7d 0a 0a  2f 2f 20 73 65 6c 65 63   or)).}..// selec
1e580	74 4f 70 74 69 6d 61 6c  50 6f 72 74 66 6f 6c 69   tOptimalPortfoli
1e590	6f 4f 70 70 6f 72 74 75  6e 69 74 79 20 e5 9f ba   oOpportunity ...
1e5a0	e4 ba 8e e6 8a 95 e8 b5  84 e7 bb 84 e5 90 88 e4   ................
1e5b0	bc 98 e5 8c 96 e9 80 89  e6 8b a9 e6 9c 80 e4 bd   ................
1e5c0	b3 e6 9c ba e4 bc 9a 0a  66 75 6e 63 20 28 62 65   ........func (be
1e5d0	20 2a 42 61 63 6b 74 65  73 74 45 6e 67 69 6e 65    *BacktestEngine
1e5e0	29 20 73 65 6c 65 63 74  4f 70 74 69 6d 61 6c 50   ) selectOptimalP
1e5f0	6f 72 74 66 6f 6c 69 6f  4f 70 70 6f 72 74 75 6e   ortfolioOpportun
1e600	69 74 79 28 6f 70 70 6f  72 74 75 6e 69 74 69 65   ity(opportunitie
1e610	73 20 5b 5d 2a 53 79 6d  62 6f 6c 4f 70 70 6f 72   s []*SymbolOppor
1e620	74 75 6e 69 74 79 2c 20  73 79 6d 62 6f 6c 53 74   tunity, symbolSt
1e630	61 74 65 73 20 6d 61 70  5b 73 74 72 69 6e 67 5d   ates map[string]
1e640	2a 53 79 6d 62 6f 6c 53  74 61 74 65 2c 20 63 6f   *SymbolState, co
1e650	6e 66 69 67 20 2a 42 61  63 6b 74 65 73 74 43 6f   nfig *BacktestCo
1e660	6e 66 69 67 29 20 2a 54  72 61 64 65 4f 70 70 6f   nfig) *TradeOppo
1e670	72 74 75 6e 69 74 79 20  7b 0a 09 69 66 20 6c 65   rtunity {..if le
1e680	6e 28 6f 70 70 6f 72 74  75 6e 69 74 69 65 73 29   n(opportunities)
1e690	20 3d 3d 20 30 20 7b 0a  09 09 72 65 74 75 72 6e    == 0 {...return
1e6a0	20 6e 69 6c 0a 09 7d 0a  0a 09 2f 2f 20 e6 8c 89    nil..}...// ...
1e6b0	e9 a3 8e e9 99 a9 e8 b0  83 e6 95 b4 e5 88 86 e6   ................
1e6c0	95 b0 e6 8e 92 e5 ba 8f  0a 09 73 6f 72 74 2e 53   ..........sort.S
1e6d0	6c 69 63 65 28 6f 70 70  6f 72 74 75 6e 69 74 69   lice(opportuniti
1e6e0	65 73 2c 20 66 75 6e 63  28 69 2c 20 6a 20 69 6e   es, func(i, j in
1e6f0	74 29 20 62 6f 6f 6c 20  7b 0a 09 09 72 65 74 75   t) bool {...retu
1e700	72 6e 20 6f 70 70 6f 72  74 75 6e 69 74 69 65 73   rn opportunities
1e710	5b 69 5d 2e 53 63 6f 72  65 20 3e 20 6f 70 70 6f   [i].Score > oppo
1e720	72 74 75 6e 69 74 69 65  73 5b 6a 5d 2e 53 63 6f   rtunities[j].Sco
1e730	72 65 0a 09 7d 29 0a 0a  09 2f 2f 20 e9 80 89 e6   re..})...// ....
1e740	8b a9 e5 88 86 e6 95 b0  e6 9c 80 e9 ab 98 e7 9a   ................
1e750	84 e4 bd 9c e4 b8 ba e5  80 99 e9 80 89 0a 09 62   ...............b
1e760	65 73 74 4f 70 70 20 3a  3d 20 6f 70 70 6f 72 74   estOpp := opport
1e770	75 6e 69 74 69 65 73 5b  30 5d 0a 0a 09 2f 2f 20   unities[0]...// 
1e780	e6 a3 80 e6 9f a5 e6 98  af e5 90 a6 e6 bb a1 e8   ................
1e790	b6 b3 e6 9c 80 e5 b0 8f  e5 88 86 e6 95 b0 e9 98   ................
1e7a0	88 e5 80 bc 0a 09 6d 69  6e 53 63 6f 72 65 54 68   ......minScoreTh
1e7b0	72 65 73 68 6f 6c 64 20  3a 3d 20 30 2e 33 0a 09   reshold := 0.3..
1e7c0	69 66 20 62 65 73 74 4f  70 70 2e 53 63 6f 72 65   if bestOpp.Score
1e7d0	20 3c 20 6d 69 6e 53 63  6f 72 65 54 68 72 65 73    < minScoreThres
1e7e0	68 6f 6c 64 20 7b 0a 09  09 6c 6f 67 2e 50 72 69   hold {...log.Pri
1e7f0	6e 74 66 28 22 5b 50 4f  52 54 46 4f 4c 49 4f 5f   ntf("[PORTFOLIO_
1e800	4f 50 54 49 4d 49 5a 41  54 49 4f 4e 5d 20 e6 9c   OPTIMIZATION] ..
1e810	80 e4 bd b3 e6 9c ba e4  bc 9a e5 88 86 e6 95 b0   ................
1e820	25 2e 33 66 e4 bd 8e e4  ba 8e e9 98 88 e5 80 bc   %.3f............
1e830	25 2e 33 66 ef bc 8c e8  b7 b3 e8 bf 87 e4 ba a4   %.3f............
1e840	e6 98 93 22 2c 20 62 65  73 74 4f 70 70 2e 53 63   ...", bestOpp.Sc
1e850	6f 72 65 2c 20 6d 69 6e  53 63 6f 72 65 54 68 72   ore, minScoreThr
1e860	65 73 68 6f 6c 64 29 0a  09 09 72 65 74 75 72 6e   eshold)...return
1e870	20 6e 69 6c 0a 09 7d 0a  0a 09 2f 2f 20 e5 88 9b    nil..}...// ...
1e880	e5 bb ba 54 72 61 64 65  4f 70 70 6f 72 74 75 6e   ...TradeOpportun
1e890	69 74 79 e5 af b9 e8 b1  a1 0a 09 74 72 61 64 65   ity........trade
1e8a0	4f 70 70 20 3a 3d 20 26  54 72 61 64 65 4f 70 70   Opp := &TradeOpp
1e8b0	6f 72 74 75 6e 69 74 79  7b 0a 09 09 53 79 6d 62   ortunity{...Symb
1e8c0	6f 6c 3a 20 20 20 20 20  20 20 20 20 62 65 73 74   ol:         best
1e8d0	4f 70 70 2e 53 79 6d 62  6f 6c 2c 0a 09 09 41 63   Opp.Symbol,...Ac
1e8e0	74 69 6f 6e 3a 20 20 20  20 20 20 20 20 20 62 65   tion:         be
1e8f0	73 74 4f 70 70 2e 41 63  74 69 6f 6e 2c 0a 09 09   stOpp.Action,...
1e900	43 6f 6e 66 69 64 65 6e  63 65 3a 20 20 20 20 20   Confidence:     
1e910	62 65 73 74 4f 70 70 2e  43 6f 6e 66 69 64 65 6e   bestOpp.Confiden
1e920	63 65 2c 0a 09 09 53 63  6f 72 65 3a 20 20 20 20   ce,...Score:    
1e930	20 20 20 20 20 20 62 65  73 74 4f 70 70 2e 53 63         bestOpp.Sc
1e940	6f 72 65 2c 0a 09 09 50  72 69 63 65 3a 20 20 20   ore,...Price:   
1e950	20 20 20 20 20 20 20 62  65 73 74 4f 70 70 2e 50          bestOpp.P
1e960	72 69 63 65 2c 0a 09 09  52 65 61 73 6f 6e 3a 20   rice,...Reason: 
1e970	20 20 20 20 20 20 20 20  66 6d 74 2e 53 70 72 69           fmt.Spri
1e980	6e 74 66 28 22 e5 a4 9a  e5 b8 81 e7 a7 8d e4 bc   ntf("...........
1e990	98 e5 8c 96 e9 80 89 e6  8b a9 20 28 e9 a3 8e e9   .......... (....
1e9a0	99 a9 e8 b0 83 e6 95 b4  3a 20 25 2e 33 66 29 22   ........: %.3f)"
1e9b0	2c 20 62 65 73 74 4f 70  70 2e 52 69 73 6b 41 64   , bestOpp.RiskAd
1e9c0	6a 75 73 74 6d 65 6e 74  29 2c 0a 09 09 53 74 61   justment),...Sta
1e9d0	74 65 3a 20 20 20 20 20  20 20 20 20 20 62 65 73   te:          bes
1e9e0	74 4f 70 70 2e 53 74 61  74 65 2c 0a 09 09 52 69   tOpp.State,...Ri
1e9f0	73 6b 41 64 6a 75 73 74  6d 65 6e 74 3a 20 62 65   skAdjustment: be
1ea00	73 74 4f 70 70 2e 52 69  73 6b 41 64 6a 75 73 74   stOpp.RiskAdjust
1ea10	6d 65 6e 74 2c 0a 09 7d  0a 0a 09 72 65 74 75 72   ment,..}...retur
1ea20	6e 20 74 72 61 64 65 4f  70 70 0a 7d 0a 0a 2f 2f   n tradeOpp.}..//
1ea30	20 63 6c 65 61 72 46 65  61 74 75 72 65 43 61 63    clearFeatureCac
1ea40	68 65 20 e6 b8 85 e9 99  a4 e6 8c 87 e5 ae 9a e7   he .............
1ea50	ac a6 e5 8f b7 e5 92 8c  e6 97 b6 e9 97 b4 e8 8c   ................
1ea60	83 e5 9b b4 e7 9a 84 e7  89 b9 e5 be 81 e7 bc 93   ................
1ea70	e5 ad 98 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
1ea80	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 63 6c   cktestEngine) cl
1ea90	65 61 72 46 65 61 74 75  72 65 43 61 63 68 65 28   earFeatureCache(
1eaa0	73 79 6d 62 6f 6c 20 73  74 72 69 6e 67 2c 20 73   symbol string, s
1eab0	74 61 72 74 44 61 74 65  2c 20 65 6e 64 44 61 74   tartDate, endDat
1eac0	65 20 74 69 6d 65 2e 54  69 6d 65 29 20 7b 0a 09   e time.Time) {..
1ead0	62 65 2e 63 61 63 68 65  4d 75 74 65 78 2e 4c 6f   be.cacheMutex.Lo
1eae0	63 6b 28 29 0a 09 64 65  66 65 72 20 62 65 2e 63   ck()..defer be.c
1eaf0	61 63 68 65 4d 75 74 65  78 2e 55 6e 6c 6f 63 6b   acheMutex.Unlock
1eb00	28 29 0a 0a 09 6b 65 79  20 3a 3d 20 62 65 2e 67   ()...key := be.g
1eb10	65 74 46 65 61 74 75 72  65 43 61 63 68 65 4b 65   etFeatureCacheKe
1eb20	79 28 73 79 6d 62 6f 6c  2c 20 73 74 61 72 74 44   y(symbol, startD
1eb30	61 74 65 2c 20 65 6e 64  44 61 74 65 29 0a 09 69   ate, endDate)..i
1eb40	66 20 5f 2c 20 65 78 69  73 74 73 20 3a 3d 20 62   f _, exists := b
1eb50	65 2e 66 65 61 74 75 72  65 43 61 63 68 65 5b 6b   e.featureCache[k
1eb60	65 79 5d 3b 20 65 78 69  73 74 73 20 7b 0a 09 09   ey]; exists {...
1eb70	64 65 6c 65 74 65 28 62  65 2e 66 65 61 74 75 72   delete(be.featur
1eb80	65 43 61 63 68 65 2c 20  6b 65 79 29 0a 09 09 6c   eCache, key)...l
1eb90	6f 67 2e 50 72 69 6e 74  66 28 22 5b 43 41 43 48   og.Printf("[CACH
1eba0	45 5f 43 4c 45 41 52 5d  20 43 6c 65 61 72 65 64   E_CLEAR] Cleared
1ebb0	20 66 65 61 74 75 72 65  20 63 61 63 68 65 20 66    feature cache f
1ebc0	6f 72 20 25 73 3a 20 25  73 22 2c 20 73 79 6d 62   or %s: %s", symb
1ebd0	6f 6c 2c 20 6b 65 79 29  0a 09 7d 20 65 6c 73 65   ol, key)..} else
1ebe0	20 7b 0a 09 09 6c 6f 67  2e 50 72 69 6e 74 66 28    {...log.Printf(
1ebf0	22 5b 43 41 43 48 45 5f  43 4c 45 41 52 5d 20 46   "[CACHE_CLEAR] F
1ec00	65 61 74 75 72 65 20 63  61 63 68 65 20 6e 6f 74   eature cache not
1ec10	20 66 6f 75 6e 64 20 66  6f 72 20 25 73 3a 20 25    found for %s: %
1ec20	73 22 2c 20 73 79 6d 62  6f 6c 2c 20 6b 65 79 29   s", symbol, key)
1ec30	0a 09 7d 0a 7d 0a 0a 2f  2f 20 63 6c 65 61 72 4d   ..}.}..// clearM
1ec40	4c 50 72 65 64 69 63 74  69 6f 6e 43 61 63 68 65   LPredictionCache
1ec50	20 e6 b8 85 e9 99 a4 e6  8c 87 e5 ae 9a e7 ac a6    ...............
1ec60	e5 8f b7 e5 92 8c e6 97  b6 e9 97 b4 e8 8c 83 e5   ................
1ec70	9b b4 e7 9a 84 4d 4c e9  a2 84 e6 b5 8b e7 bc 93   .....ML.........
1ec80	e5 ad 98 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
1ec90	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 63 6c   cktestEngine) cl
1eca0	65 61 72 4d 4c 50 72 65  64 69 63 74 69 6f 6e 43   earMLPredictionC
1ecb0	61 63 68 65 28 73 79 6d  62 6f 6c 20 73 74 72 69   ache(symbol stri
1ecc0	6e 67 2c 20 73 74 61 72  74 44 61 74 65 2c 20 65   ng, startDate, e
1ecd0	6e 64 44 61 74 65 20 74  69 6d 65 2e 54 69 6d 65   ndDate time.Time
1ece0	29 20 7b 0a 09 62 65 2e  63 61 63 68 65 4d 75 74   ) {..be.cacheMut
1ecf0	65 78 2e 4c 6f 63 6b 28  29 0a 09 64 65 66 65 72   ex.Lock()..defer
1ed00	20 62 65 2e 63 61 63 68  65 4d 75 74 65 78 2e 55    be.cacheMutex.U
1ed10	6e 6c 6f 63 6b 28 29 0a  0a 09 6b 65 79 20 3a 3d   nlock()...key :=
1ed20	20 62 65 2e 67 65 74 4d  4c 50 72 65 64 69 63 74    be.getMLPredict
1ed30	69 6f 6e 43 61 63 68 65  4b 65 79 28 73 79 6d 62   ionCacheKey(symb
1ed40	6f 6c 2c 20 73 74 61 72  74 44 61 74 65 2c 20 65   ol, startDate, e
1ed50	6e 64 44 61 74 65 29 0a  09 69 66 20 5f 2c 20 65   ndDate)..if _, e
1ed60	78 69 73 74 73 20 3a 3d  20 62 65 2e 6d 6c 50 72   xists := be.mlPr
1ed70	65 64 69 63 74 69 6f 6e  43 61 63 68 65 5b 6b 65   edictionCache[ke
1ed80	79 5d 3b 20 65 78 69 73  74 73 20 7b 0a 09 09 64   y]; exists {...d
1ed90	65 6c 65 74 65 28 62 65  2e 6d 6c 50 72 65 64 69   elete(be.mlPredi
1eda0	63 74 69 6f 6e 43 61 63  68 65 2c 20 6b 65 79 29   ctionCache, key)
1edb0	0a 09 09 6c 6f 67 2e 50  72 69 6e 74 66 28 22 5b   ...log.Printf("[
1edc0	43 41 43 48 45 5f 43 4c  45 41 52 5d 20 43 6c 65   CACHE_CLEAR] Cle
1edd0	61 72 65 64 20 4d 4c 20  70 72 65 64 69 63 74 69   ared ML predicti
1ede0	6f 6e 20 63 61 63 68 65  20 66 6f 72 20 25 73 3a   on cache for %s:
1edf0	20 25 73 22 2c 20 73 79  6d 62 6f 6c 2c 20 6b 65    %s", symbol, ke
1ee00	79 29 0a 09 7d 20 65 6c  73 65 20 7b 0a 09 09 6c   y)..} else {...l
1ee10	6f 67 2e 50 72 69 6e 74  66 28 22 5b 43 41 43 48   og.Printf("[CACH
1ee20	45 5f 43 4c 45 41 52 5d  20 4d 4c 20 70 72 65 64   E_CLEAR] ML pred
1ee30	69 63 74 69 6f 6e 20 63  61 63 68 65 20 6e 6f 74   iction cache not
1ee40	20 66 6f 75 6e 64 20 66  6f 72 20 25 73 3a 20 25    found for %s: %
1ee50	73 22 2c 20 73 79 6d 62  6f 6c 2c 20 6b 65 79 29   s", symbol, key)
1ee60	0a 09 7d 0a 7d 0a 0a 2f  2f 20 63 6c 65 61 72 41   ..}.}..// clearA
1ee70	6c 6c 43 61 63 68 65 73  46 6f 72 53 79 6d 62 6f   llCachesForSymbo
1ee80	6c 20 e6 b8 85 e9 99 a4  e6 8c 87 e5 ae 9a e7 ac   l ..............
1ee90	a6 e5 8f b7 e7 9a 84 e6  89 80 e6 9c 89 e7 9b b8   ................
1eea0	e5 85 b3 e7 bc 93 e5 ad  98 0a 66 75 6e 63 20 28   ..........func (
1eeb0	62 65 20 2a 42 61 63 6b  74 65 73 74 45 6e 67 69   be *BacktestEngi
1eec0	6e 65 29 20 63 6c 65 61  72 41 6c 6c 43 61 63 68   ne) clearAllCach
1eed0	65 73 46 6f 72 53 79 6d  62 6f 6c 28 73 79 6d 62   esForSymbol(symb
1eee0	6f 6c 20 73 74 72 69 6e  67 29 20 7b 0a 09 62 65   ol string) {..be
1eef0	2e 63 61 63 68 65 4d 75  74 65 78 2e 4c 6f 63 6b   .cacheMutex.Lock
1ef00	28 29 0a 09 64 65 66 65  72 20 62 65 2e 63 61 63   ()..defer be.cac
1ef10	68 65 4d 75 74 65 78 2e  55 6e 6c 6f 63 6b 28 29   heMutex.Unlock()
1ef20	0a 0a 09 63 6c 65 61 72  65 64 43 6f 75 6e 74 20   ...clearedCount 
1ef30	3a 3d 20 30 0a 0a 09 2f  2f 20 e6 b8 85 e9 99 a4   := 0...// ......
1ef40	e7 89 b9 e5 be 81 e7 bc  93 e5 ad 98 e4 b8 ad e5   ................
1ef50	8c 85 e5 90 ab e8 af a5  e7 ac a6 e5 8f b7 e7 9a   ................
1ef60	84 e6 89 80 e6 9c 89 e6  9d a1 e7 9b ae 0a 09 66   ...............f
1ef70	6f 72 20 6b 65 79 20 3a  3d 20 72 61 6e 67 65 20   or key := range 
1ef80	62 65 2e 66 65 61 74 75  72 65 43 61 63 68 65 20   be.featureCache 
1ef90	7b 0a 09 09 69 66 20 73  74 72 69 6e 67 73 2e 43   {...if strings.C
1efa0	6f 6e 74 61 69 6e 73 28  6b 65 79 2c 20 73 79 6d   ontains(key, sym
1efb0	62 6f 6c 29 20 7b 0a 09  09 09 64 65 6c 65 74 65   bol) {....delete
1efc0	28 62 65 2e 66 65 61 74  75 72 65 43 61 63 68 65   (be.featureCache
1efd0	2c 20 6b 65 79 29 0a 09  09 09 63 6c 65 61 72 65   , key)....cleare
1efe0	64 43 6f 75 6e 74 2b 2b  0a 09 09 7d 0a 09 7d 0a   dCount++...}..}.
1eff0	0a 09 2f 2f 20 e6 b8 85  e9 99 a4 4d 4c e9 a2 84   ..// ......ML...
1f000	e6 b5 8b e7 bc 93 e5 ad  98 e4 b8 ad e5 8c 85 e5   ................
1f010	90 ab e8 af a5 e7 ac a6  e5 8f b7 e7 9a 84 e6 89   ................
1f020	80 e6 9c 89 e6 9d a1 e7  9b ae 0a 09 66 6f 72 20   ............for 
1f030	6b 65 79 20 3a 3d 20 72  61 6e 67 65 20 62 65 2e   key := range be.
1f040	6d 6c 50 72 65 64 69 63  74 69 6f 6e 43 61 63 68   mlPredictionCach
1f050	65 20 7b 0a 09 09 69 66  20 73 74 72 69 6e 67 73   e {...if strings
1f060	2e 43 6f 6e 74 61 69 6e  73 28 6b 65 79 2c 20 73   .Contains(key, s
1f070	79 6d 62 6f 6c 29 20 7b  0a 09 09 09 64 65 6c 65   ymbol) {....dele
1f080	74 65 28 62 65 2e 6d 6c  50 72 65 64 69 63 74 69   te(be.mlPredicti
1f090	6f 6e 43 61 63 68 65 2c  20 6b 65 79 29 0a 09 09   onCache, key)...
1f0a0	09 63 6c 65 61 72 65 64  43 6f 75 6e 74 2b 2b 0a   .clearedCount++.
1f0b0	09 09 7d 0a 09 7d 0a 0a  09 69 66 20 63 6c 65 61   ..}..}...if clea
1f0c0	72 65 64 43 6f 75 6e 74  20 3e 20 30 20 7b 0a 09   redCount > 0 {..
1f0d0	09 6c 6f 67 2e 50 72 69  6e 74 66 28 22 5b 43 41   .log.Printf("[CA
1f0e0	43 48 45 5f 43 4c 45 41  52 5d 20 43 6c 65 61 72   CHE_CLEAR] Clear
1f0f0	65 64 20 25 64 20 63 61  63 68 65 20 65 6e 74 72   ed %d cache entr
1f100	69 65 73 20 66 6f 72 20  73 79 6d 62 6f 6c 20 25   ies for symbol %
1f110	73 22 2c 20 63 6c 65 61  72 65 64 43 6f 75 6e 74   s", clearedCount
1f120	2c 20 73 79 6d 62 6f 6c  29 0a 09 7d 20 65 6c 73   , symbol)..} els
1f130	65 20 7b 0a 09 09 6c 6f  67 2e 50 72 69 6e 74 66   e {...log.Printf
1f140	28 22 5b 43 41 43 48 45  5f 43 4c 45 41 52 5d 20   ("[CACHE_CLEAR] 
1f150	4e 6f 20 63 61 63 68 65  20 65 6e 74 72 69 65 73   No cache entries
1f160	20 66 6f 75 6e 64 20 66  6f 72 20 73 79 6d 62 6f    found for symbo
1f170	6c 20 25 73 22 2c 20 73  79 6d 62 6f 6c 29 0a 09   l %s", symbol)..
1f180	7d 0a 7d 0a 0a 2f 2f 20  63 61 6c 63 75 6c 61 74   }.}..// calculat
1f190	65 50 72 69 63 65 56 6f  6c 61 74 69 6c 69 74 79   ePriceVolatility
1f1a0	20 e8 ae a1 e7 ae 97 e4  bb b7 e6 a0 bc e6 b3 a2    ...............
1f1b0	e5 8a a8 e7 8e 87 0a 66  75 6e 63 20 63 61 6c 63   .......func calc
1f1c0	75 6c 61 74 65 50 72 69  63 65 56 6f 6c 61 74 69   ulatePriceVolati
1f1d0	6c 69 74 79 28 70 72 69  63 65 73 20 5b 5d 66 6c   lity(prices []fl
1f1e0	6f 61 74 36 34 29 20 66  6c 6f 61 74 36 34 20 7b   oat64) float64 {
1f1f0	0a 09 69 66 20 6c 65 6e  28 70 72 69 63 65 73 29   ..if len(prices)
1f200	20 3c 20 32 20 7b 0a 09  09 72 65 74 75 72 6e 20    < 2 {...return 
1f210	30 2e 30 0a 09 7d 0a 0a  09 2f 2f 20 e8 ae a1 e7   0.0..}...// ....
1f220	ae 97 e6 94 b6 e7 9b 8a  e7 8e 87 0a 09 72 65 74   .............ret
1f230	75 72 6e 73 20 3a 3d 20  6d 61 6b 65 28 5b 5d 66   urns := make([]f
1f240	6c 6f 61 74 36 34 2c 20  6c 65 6e 28 70 72 69 63   loat64, len(pric
1f250	65 73 29 2d 31 29 0a 09  66 6f 72 20 69 20 3a 3d   es)-1)..for i :=
1f260	20 31 3b 20 69 20 3c 20  6c 65 6e 28 70 72 69 63    1; i < len(pric
1f270	65 73 29 3b 20 69 2b 2b  20 7b 0a 09 09 72 65 74   es); i++ {...ret
1f280	75 72 6e 73 5b 69 2d 31  5d 20 3d 20 28 70 72 69   urns[i-1] = (pri
1f290	63 65 73 5b 69 5d 20 2d  20 70 72 69 63 65 73 5b   ces[i] - prices[
1f2a0	69 2d 31 5d 29 20 2f 20  70 72 69 63 65 73 5b 69   i-1]) / prices[i
1f2b0	2d 31 5d 0a 09 7d 0a 0a  09 2f 2f 20 e8 ae a1 e7   -1]..}...// ....
1f2c0	ae 97 e6 b3 a2 e5 8a a8  e7 8e 87 ef bc 88 e6 a0   ................
1f2d0	87 e5 87 86 e5 b7 ae ef  bc 89 0a 09 6d 65 61 6e   ............mean
1f2e0	20 3a 3d 20 30 2e 30 0a  09 66 6f 72 20 5f 2c 20    := 0.0..for _, 
1f2f0	72 65 74 20 3a 3d 20 72  61 6e 67 65 20 72 65 74   ret := range ret
1f300	75 72 6e 73 20 7b 0a 09  09 6d 65 61 6e 20 2b 3d   urns {...mean +=
1f310	20 72 65 74 0a 09 7d 0a  09 6d 65 61 6e 20 2f 3d    ret..}..mean /=
1f320	20 66 6c 6f 61 74 36 34  28 6c 65 6e 28 72 65 74    float64(len(ret
1f330	75 72 6e 73 29 29 0a 0a  09 76 61 72 69 61 6e 63   urns))...varianc
1f340	65 20 3a 3d 20 30 2e 30  0a 09 66 6f 72 20 5f 2c   e := 0.0..for _,
1f350	20 72 65 74 20 3a 3d 20  72 61 6e 67 65 20 72 65    ret := range re
1f360	74 75 72 6e 73 20 7b 0a  09 09 76 61 72 69 61 6e   turns {...varian
1f370	63 65 20 2b 3d 20 28 72  65 74 20 2d 20 6d 65 61   ce += (ret - mea
1f380	6e 29 20 2a 20 28 72 65  74 20 2d 20 6d 65 61 6e   n) * (ret - mean
1f390	29 0a 09 7d 0a 09 76 61  72 69 61 6e 63 65 20 2f   )..}..variance /
1f3a0	3d 20 66 6c 6f 61 74 36  34 28 6c 65 6e 28 72 65   = float64(len(re
1f3b0	74 75 72 6e 73 29 29 0a  0a 09 72 65 74 75 72 6e   turns))...return
1f3c0	20 6d 61 74 68 2e 53 71  72 74 28 76 61 72 69 61    math.Sqrt(varia
1f3d0	6e 63 65 29 0a 7d 0a 0a  2f 2f 20 63 61 6c 63 75   nce).}..// calcu
1f3e0	6c 61 74 65 4f 70 70 6f  72 74 75 6e 69 74 79 43   lateOpportunityC
1f3f0	6f 6e 73 69 73 74 65 6e  63 79 20 e8 ae a1 e7 ae   onsistency .....
1f400	97 e6 9c ba e4 bc 9a e4  b8 80 e8 87 b4 e6 80 a7   ................
1f410	e8 af 84 e5 88 86 0a 66  75 6e 63 20 28 62 65 20   .......func (be 
1f420	2a 42 61 63 6b 74 65 73  74 45 6e 67 69 6e 65 29   *BacktestEngine)
1f430	20 63 61 6c 63 75 6c 61  74 65 4f 70 70 6f 72 74    calculateOpport
1f440	75 6e 69 74 79 43 6f 6e  73 69 73 74 65 6e 63 79   unityConsistency
1f450	28 6f 70 70 6f 72 74 75  6e 69 74 69 65 73 20 5b   (opportunities [
1f460	5d 2a 53 79 6d 62 6f 6c  4f 70 70 6f 72 74 75 6e   ]*SymbolOpportun
1f470	69 74 79 29 20 66 6c 6f  61 74 36 34 20 7b 0a 09   ity) float64 {..
1f480	69 66 20 6c 65 6e 28 6f  70 70 6f 72 74 75 6e 69   if len(opportuni
1f490	74 69 65 73 29 20 3c 20  32 20 7b 0a 09 09 72 65   ties) < 2 {...re
1f4a0	74 75 72 6e 20 31 2e 30  0a 09 7d 0a 0a 09 2f 2f   turn 1.0..}...//
1f4b0	20 e8 ae a1 e7 ae 97 e5  89 8d e5 87 a0 e4 b8 aa    ...............
1f4c0	e6 9c ba e4 bc 9a e7 9a  84 e5 b9 b3 e5 9d 87 e5   ................
1f4d0	88 86 e6 95 b0 e5 b7 ae  e5 bc 82 0a 09 74 6f 70   .............top
1f4e0	4f 70 70 6f 72 74 75 6e  69 74 69 65 73 20 3a 3d   Opportunities :=
1f4f0	20 6f 70 70 6f 72 74 75  6e 69 74 69 65 73 0a 09    opportunities..
1f500	69 66 20 6c 65 6e 28 6f  70 70 6f 72 74 75 6e 69   if len(opportuni
1f510	74 69 65 73 29 20 3e 20  35 20 7b 0a 09 09 74 6f   ties) > 5 {...to
1f520	70 4f 70 70 6f 72 74 75  6e 69 74 69 65 73 20 3d   pOpportunities =
1f530	20 6f 70 70 6f 72 74 75  6e 69 74 69 65 73 5b 3a    opportunities[:
1f540	35 5d 0a 09 7d 0a 0a 09  74 6f 74 61 6c 53 63 6f   5]..}...totalSco
1f550	72 65 20 3a 3d 20 30 2e  30 0a 09 66 6f 72 20 5f   re := 0.0..for _
1f560	2c 20 6f 70 70 20 3a 3d  20 72 61 6e 67 65 20 74   , opp := range t
1f570	6f 70 4f 70 70 6f 72 74  75 6e 69 74 69 65 73 20   opOpportunities 
1f580	7b 0a 09 09 74 6f 74 61  6c 53 63 6f 72 65 20 2b   {...totalScore +
1f590	3d 20 6f 70 70 2e 53 63  6f 72 65 0a 09 7d 0a 09   = opp.Score..}..
1f5a0	61 76 67 53 63 6f 72 65  20 3a 3d 20 74 6f 74 61   avgScore := tota
1f5b0	6c 53 63 6f 72 65 20 2f  20 66 6c 6f 61 74 36 34   lScore / float64
1f5c0	28 6c 65 6e 28 74 6f 70  4f 70 70 6f 72 74 75 6e   (len(topOpportun
1f5d0	69 74 69 65 73 29 29 0a  0a 09 2f 2f 20 e8 ae a1   ities))...// ...
1f5e0	e7 ae 97 e6 a0 87 e5 87  86 e5 b7 ae 0a 09 76 61   ..............va
1f5f0	72 69 61 6e 63 65 20 3a  3d 20 30 2e 30 0a 09 66   riance := 0.0..f
1f600	6f 72 20 5f 2c 20 6f 70  70 20 3a 3d 20 72 61 6e   or _, opp := ran
1f610	67 65 20 74 6f 70 4f 70  70 6f 72 74 75 6e 69 74   ge topOpportunit
1f620	69 65 73 20 7b 0a 09 09  76 61 72 69 61 6e 63 65   ies {...variance
1f630	20 2b 3d 20 28 6f 70 70  2e 53 63 6f 72 65 20 2d    += (opp.Score -
1f640	20 61 76 67 53 63 6f 72  65 29 20 2a 20 28 6f 70    avgScore) * (op
1f650	70 2e 53 63 6f 72 65 20  2d 20 61 76 67 53 63 6f   p.Score - avgSco
1f660	72 65 29 0a 09 7d 0a 09  76 61 72 69 61 6e 63 65   re)..}..variance
1f670	20 2f 3d 20 66 6c 6f 61  74 36 34 28 6c 65 6e 28    /= float64(len(
1f680	74 6f 70 4f 70 70 6f 72  74 75 6e 69 74 69 65 73   topOpportunities
1f690	29 29 0a 09 73 74 64 44  65 76 20 3a 3d 20 6d 61   ))..stdDev := ma
1f6a0	74 68 2e 53 71 72 74 28  76 61 72 69 61 6e 63 65   th.Sqrt(variance
1f6b0	29 0a 0a 09 2f 2f 20 e4  b8 80 e8 87 b4 e6 80 a7   )...// .........
1f6c0	e8 af 84 e5 88 86 ef bc  9a e6 a0 87 e5 87 86 e5   ................
1f6d0	b7 ae e8 b6 8a e5 b0 8f  ef bc 8c e4 b8 80 e8 87   ................
1f6e0	b4 e6 80 a7 e8 b6 8a e9  ab 98 0a 09 63 6f 6e 73   ............cons
1f6f0	69 73 74 65 6e 63 79 20  3a 3d 20 31 2e 30 20 2d   istency := 1.0 -
1f700	20 6d 61 74 68 2e 4d 69  6e 28 73 74 64 44 65 76    math.Min(stdDev
1f710	2f 61 76 67 53 63 6f 72  65 2c 20 31 2e 30 29 0a   /avgScore, 1.0).
1f720	0a 09 72 65 74 75 72 6e  20 6d 61 74 68 2e 4d 61   ..return math.Ma
1f730	78 28 30 2e 30 2c 20 63  6f 6e 73 69 73 74 65 6e   x(0.0, consisten
1f740	63 79 29 0a 7d 0a 0a 2f  2f 20 73 65 6c 65 63 74   cy).}..// select
1f750	4d 6f 72 65 53 74 61 62  6c 65 4f 70 70 6f 72 74   MoreStableOpport
1f760	75 6e 69 74 79 20 e4 bb  8e e6 9c ba e4 bc 9a e5   unity ..........
1f770	88 97 e8 a1 a8 e4 b8 ad  e9 80 89 e6 8b a9 e6 9b   ................
1f780	b4 e7 a8 b3 e5 ae 9a e7  9a 84 e6 9c ba e4 bc 9a   ................
1f790	0a 66 75 6e 63 20 28 62  65 20 2a 42 61 63 6b 74   .func (be *Backt
1f7a0	65 73 74 45 6e 67 69 6e  65 29 20 73 65 6c 65 63   estEngine) selec
1f7b0	74 4d 6f 72 65 53 74 61  62 6c 65 4f 70 70 6f 72   tMoreStableOppor
1f7c0	74 75 6e 69 74 79 28 6f  70 70 6f 72 74 75 6e 69   tunity(opportuni
1f7d0	74 69 65 73 20 5b 5d 2a  53 79 6d 62 6f 6c 4f 70   ties []*SymbolOp
1f7e0	70 6f 72 74 75 6e 69 74  79 29 20 2a 53 79 6d 62   portunity) *Symb
1f7f0	6f 6c 4f 70 70 6f 72 74  75 6e 69 74 79 20 7b 0a   olOpportunity {.
1f800	09 69 66 20 6c 65 6e 28  6f 70 70 6f 72 74 75 6e   .if len(opportun
1f810	69 74 69 65 73 29 20 3d  3d 20 30 20 7b 0a 09 09   ities) == 0 {...
1f820	72 65 74 75 72 6e 20 6e  69 6c 0a 09 7d 0a 0a 09   return nil..}...
1f830	62 65 73 74 4f 70 70 20  3a 3d 20 6f 70 70 6f 72   bestOpp := oppor
1f840	74 75 6e 69 74 69 65 73  5b 30 5d 0a 09 62 65 73   tunities[0]..bes
1f850	74 53 74 61 62 69 6c 69  74 79 20 3a 3d 20 30 2e   tStability := 0.
1f860	30 0a 0a 09 66 6f 72 20  5f 2c 20 6f 70 70 20 3a   0...for _, opp :
1f870	3d 20 72 61 6e 67 65 20  6f 70 70 6f 72 74 75 6e   = range opportun
1f880	69 74 69 65 73 20 7b 0a  09 09 2f 2f 20 e8 ae a1   ities {...// ...
1f890	e7 ae 97 e7 a8 b3 e5 ae  9a e6 80 a7 e8 af 84 e5   ................
1f8a0	88 86 ef bc 9a e7 bd ae  e4 bf a1 e5 ba a6 20 2a   .............. *
1f8b0	20 28 31 20 2d 20 e9 a3  8e e9 99 a9 e8 b0 83 e6    (1 - ..........
1f8c0	95 b4 e5 9b a0 e5 ad 90  29 20 2a 20 e5 88 86 e6   ........) * ....
1f8d0	95 b0 0a 09 09 73 74 61  62 69 6c 69 74 79 20 3a   .....stability :
1f8e0	3d 20 6f 70 70 2e 43 6f  6e 66 69 64 65 6e 63 65   = opp.Confidence
1f8f0	20 2a 20 28 31 2e 30 20  2d 20 6f 70 70 2e 52 69    * (1.0 - opp.Ri
1f900	73 6b 41 64 6a 75 73 74  6d 65 6e 74 29 20 2a 20   skAdjustment) * 
1f910	6f 70 70 2e 53 63 6f 72  65 0a 0a 09 09 2f 2f 20   opp.Score....// 
1f920	e5 9f ba e4 ba 8e e5 b8  82 e5 9c ba e8 af 84 e5   ................
1f930	88 86 e8 bf 9b e8 a1 8c  e8 b0 83 e6 95 b4 0a 09   ................
1f940	09 73 74 61 62 69 6c 69  74 79 20 2a 3d 20 6f 70   .stability *= op
1f950	70 2e 4d 61 72 6b 65 74  53 63 6f 72 65 0a 0a 09   p.MarketScore...
1f960	09 2f 2f 20 e8 80 83 e8  99 91 e6 9c ba e4 bc 9a   .// ............
1f970	e7 b1 bb e5 9e 8b e7 9a  84 e7 a8 b3 e5 ae 9a e6   ................
1f980	80 a7 0a 09 09 73 77 69  74 63 68 20 7b 0a 09 09   .....switch {...
1f990	63 61 73 65 20 73 74 72  69 6e 67 73 2e 43 6f 6e   case strings.Con
1f9a0	74 61 69 6e 73 28 6f 70  70 2e 52 65 61 73 6f 6e   tains(opp.Reason
1f9b0	2c 20 22 73 74 61 74 69  73 74 69 63 61 6c 22 29   , "statistical")
1f9c0	3a 0a 09 09 09 73 74 61  62 69 6c 69 74 79 20 2a   :....stability *
1f9d0	3d 20 31 2e 33 20 2f 2f  20 e7 bb 9f e8 ae a1 e5   = 1.3 // .......
1f9e0	a5 97 e5 88 a9 e6 9c 80  e7 a8 b3 e5 ae 9a 0a 09   ................
1f9f0	09 63 61 73 65 20 73 74  72 69 6e 67 73 2e 43 6f   .case strings.Co
1fa00	6e 74 61 69 6e 73 28 6f  70 70 2e 52 65 61 73 6f   ntains(opp.Reaso
1fa10	6e 2c 20 22 63 6f 72 72  65 6c 61 74 69 6f 6e 22   n, "correlation"
1fa20	29 3a 0a 09 09 09 73 74  61 62 69 6c 69 74 79 20   ):....stability 
1fa30	2a 3d 20 31 2e 32 20 2f  2f 20 e7 9b b8 e5 85 b3   *= 1.2 // ......
1fa40	e6 80 a7 e5 a5 97 e5 88  a9 e8 be 83 e7 a8 b3 e5   ................
1fa50	ae 9a 0a 09 09 63 61 73  65 20 73 74 72 69 6e 67   .....case string
1fa60	73 2e 43 6f 6e 74 61 69  6e 73 28 6f 70 70 2e 52   s.Contains(opp.R
1fa70	65 61 73 6f 6e 2c 20 22  61 72 62 69 74 72 61 67   eason, "arbitrag
1fa80	65 22 29 3a 0a 09 09 09  73 74 61 62 69 6c 69 74   e"):....stabilit
1fa90	79 20 2a 3d 20 31 2e 31  20 2f 2f 20 e4 b8 80 e8   y *= 1.1 // ....
1faa0	88 ac e5 a5 97 e5 88 a9  e6 9c ba e4 bc 9a 0a 09   ................
1fab0	09 63 61 73 65 20 73 74  72 69 6e 67 73 2e 43 6f   .case strings.Co
1fac0	6e 74 61 69 6e 73 28 6f  70 70 2e 52 65 61 73 6f   ntains(opp.Reaso
1fad0	6e 2c 20 22 74 72 61 64  69 6e 67 5f 73 69 67 6e   n, "trading_sign
1fae0	61 6c 22 29 3a 0a 09 09  09 73 74 61 62 69 6c 69   al"):....stabili
1faf0	74 79 20 2a 3d 20 30 2e  39 20 2f 2f 20 e6 99 ae   ty *= 0.9 // ...
1fb00	e9 80 9a e4 ba a4 e6 98  93 e4 bf a1 e5 8f b7 e8   ................
1fb10	be 83 e4 b8 8d e7 a8 b3  e5 ae 9a 0a 09 09 7d 0a   ..............}.
1fb20	0a 09 09 2f 2f 20 e8 80  83 e8 99 91 e5 b8 81 e7   ...// ..........
1fb30	a7 8d e7 9a 84 e6 b3 a2  e5 8a a8 e6 80 a7 ef bc   ................
1fb40	88 e5 a6 82 e6 9e 9c e6  9c 89 e5 8e 86 e5 8f b2   ................
1fb50	e6 95 b0 e6 8d ae ef bc  89 0a 09 09 69 66 20 6f   ............if o
1fb60	70 70 2e 53 74 61 74 65  20 21 3d 20 6e 69 6c 20   pp.State != nil 
1fb70	26 26 20 6c 65 6e 28 6f  70 70 2e 53 74 61 74 65   && len(opp.State
1fb80	2e 44 61 74 61 29 20 3e  20 32 30 20 7b 0a 09 09   .Data) > 20 {...
1fb90	09 72 65 63 65 6e 74 50  72 69 63 65 73 20 3a 3d   .recentPrices :=
1fba0	20 6d 61 6b 65 28 5b 5d  66 6c 6f 61 74 36 34 2c    make([]float64,
1fbb0	20 30 2c 20 32 30 29 0a  09 09 09 66 6f 72 20 69    0, 20)....for i
1fbc0	20 3a 3d 20 6c 65 6e 28  6f 70 70 2e 53 74 61 74    := len(opp.Stat
1fbd0	65 2e 44 61 74 61 29 20  2d 20 32 30 3b 20 69 20   e.Data) - 20; i 
1fbe0	3c 20 6c 65 6e 28 6f 70  70 2e 53 74 61 74 65 2e   < len(opp.State.
1fbf0	44 61 74 61 29 3b 20 69  2b 2b 20 7b 0a 09 09 09   Data); i++ {....
1fc00	09 72 65 63 65 6e 74 50  72 69 63 65 73 20 3d 20   .recentPrices = 
1fc10	61 70 70 65 6e 64 28 72  65 63 65 6e 74 50 72 69   append(recentPri
1fc20	63 65 73 2c 20 6f 70 70  2e 53 74 61 74 65 2e 44   ces, opp.State.D
1fc30	61 74 61 5b 69 5d 2e 50  72 69 63 65 29 0a 09 09   ata[i].Price)...
1fc40	09 7d 0a 09 09 09 69 66  20 6c 65 6e 28 72 65 63   .}....if len(rec
1fc50	65 6e 74 50 72 69 63 65  73 29 20 3e 3d 20 31 30   entPrices) >= 10
1fc60	20 7b 0a 09 09 09 09 76  6f 6c 61 74 69 6c 69 74    {.....volatilit
1fc70	79 20 3a 3d 20 63 61 6c  63 75 6c 61 74 65 50 72   y := calculatePr
1fc80	69 63 65 56 6f 6c 61 74  69 6c 69 74 79 28 72 65   iceVolatility(re
1fc90	63 65 6e 74 50 72 69 63  65 73 29 0a 09 09 09 09   centPrices).....
1fca0	2f 2f 20 e4 bd 8e e6 b3  a2 e5 8a a8 e5 b8 81 e7   // .............
1fcb0	a7 8d e6 9b b4 e7 a8 b3  e5 ae 9a 0a 09 09 09 09   ................
1fcc0	69 66 20 76 6f 6c 61 74  69 6c 69 74 79 20 3c 20   if volatility < 
1fcd0	30 2e 30 32 20 7b 0a 09  09 09 09 09 73 74 61 62   0.02 {......stab
1fce0	69 6c 69 74 79 20 2a 3d  20 31 2e 31 0a 09 09 09   ility *= 1.1....
1fcf0	09 7d 20 65 6c 73 65 20  69 66 20 76 6f 6c 61 74   .} else if volat
1fd00	69 6c 69 74 79 20 3e 20  30 2e 30 35 20 7b 0a 09   ility > 0.05 {..
1fd10	09 09 09 09 73 74 61 62  69 6c 69 74 79 20 2a 3d   ....stability *=
1fd20	20 30 2e 39 0a 09 09 09  09 7d 0a 09 09 09 7d 0a    0.9.....}....}.
1fd30	09 09 7d 0a 0a 09 09 69  66 20 73 74 61 62 69 6c   ..}....if stabil
1fd40	69 74 79 20 3e 20 62 65  73 74 53 74 61 62 69 6c   ity > bestStabil
1fd50	69 74 79 20 7b 0a 09 09  09 62 65 73 74 53 74 61   ity {....bestSta
1fd60	62 69 6c 69 74 79 20 3d  20 73 74 61 62 69 6c 69   bility = stabili
1fd70	74 79 0a 09 09 09 62 65  73 74 4f 70 70 20 3d 20   ty....bestOpp = 
1fd80	6f 70 70 0a 09 09 7d 0a  09 7d 0a 0a 09 6c 6f 67   opp...}..}...log
1fd90	2e 50 72 69 6e 74 66 28  22 5b 43 4f 4e 53 49 53   .Printf("[CONSIS
1fda0	54 45 4e 43 59 5f 53 45  4c 45 43 54 49 4f 4e 5d   TENCY_SELECTION]
1fdb0	20 e9 80 89 e6 8b a9 e6  9c 80 e7 a8 b3 e5 ae 9a    ...............
1fdc0	e6 9c ba e4 bc 9a 3a 20  25 73 20 25 73 2c 20 e7   ......: %s %s, .
1fdd0	a8 b3 e5 ae 9a e6 80 a7  e8 af 84 e5 88 86 3a 20   ..............: 
1fde0	25 2e 33 66 2c 20 e7 b1  bb e5 9e 8b 3a 20 25 73   %.3f, ......: %s
1fdf0	22 2c 0a 09 09 62 65 73  74 4f 70 70 2e 53 79 6d   ",...bestOpp.Sym
1fe00	62 6f 6c 2c 20 62 65 73  74 4f 70 70 2e 41 63 74   bol, bestOpp.Act
1fe10	69 6f 6e 2c 20 62 65 73  74 53 74 61 62 69 6c 69   ion, bestStabili
1fe20	74 79 2c 20 62 65 73 74  4f 70 70 2e 52 65 61 73   ty, bestOpp.Reas
1fe30	6f 6e 29 0a 0a 09 72 65  74 75 72 6e 20 62 65 73   on)...return bes
1fe40	74 4f 70 70 0a 7d 0a 0a  2f 2f 20 3d 3d 3d 20 e7   tOpp.}..// === .
1fe50	86 8a e5 b8 82 e7 8e af  e5 a2 83 e9 80 82 e5 ba   ................
1fe60	94 e6 80 a7 e5 87 bd e6  95 b0 20 3d 3d 3d 0a 0a   .......... ===..
1fe70	2f 2f 20 64 65 74 65 63  74 42 65 61 72 4d 61 72   // detectBearMar
1fe80	6b 65 74 46 6f 72 53 79  6d 62 6f 6c 20 e6 a3 80   ketForSymbol ...
1fe90	e6 b5 8b e5 8d 95 e4 b8  aa e5 b8 81 e7 a7 8d e7   ................
1fea0	9a 84 e7 86 8a e5 b8 82  e7 8e af e5 a2 83 0a 66   ...............f
1feb0	75 6e 63 20 28 62 65 20  2a 42 61 63 6b 74 65 73   unc (be *Backtes
1fec0	74 45 6e 67 69 6e 65 29  20 64 65 74 65 63 74 42   tEngine) detectB
1fed0	65 61 72 4d 61 72 6b 65  74 46 6f 72 53 79 6d 62   earMarketForSymb
1fee0	6f 6c 28 64 61 74 61 20  5b 5d 4d 61 72 6b 65 74   ol(data []Market
1fef0	44 61 74 61 2c 20 63 75  72 72 65 6e 74 49 6e 64   Data, currentInd
1ff00	65 78 20 69 6e 74 29 20  62 6f 6f 6c 20 7b 0a 09   ex int) bool {..
1ff10	69 66 20 63 75 72 72 65  6e 74 49 6e 64 65 78 20   if currentIndex 
1ff20	3c 20 32 30 20 7c 7c 20  6c 65 6e 28 64 61 74 61   < 20 || len(data
1ff30	29 20 3c 3d 20 63 75 72  72 65 6e 74 49 6e 64 65   ) <= currentInde
1ff40	78 20 7b 0a 09 09 72 65  74 75 72 6e 20 66 61 6c   x {...return fal
1ff50	73 65 0a 09 7d 0a 0a 09  2f 2f 20 e8 ae a1 e7 ae   se..}...// .....
1ff60	97 e6 9c 80 e8 bf 91 32  30 e5 91 a8 e6 9c 9f e7   .......20.......
1ff70	9a 84 e8 b6 8b e5 8a bf  0a 09 72 65 63 65 6e 74   ..........recent
1ff80	50 72 69 63 65 73 20 3a  3d 20 64 61 74 61 5b 63   Prices := data[c
1ff90	75 72 72 65 6e 74 49 6e  64 65 78 2d 31 39 20 3a   urrentIndex-19 :
1ffa0	20 63 75 72 72 65 6e 74  49 6e 64 65 78 2b 31 5d    currentIndex+1]
1ffb0	0a 09 69 66 20 6c 65 6e  28 72 65 63 65 6e 74 50   ..if len(recentP
1ffc0	72 69 63 65 73 29 20 3c  20 31 30 20 7b 0a 09 09   rices) < 10 {...
1ffd0	72 65 74 75 72 6e 20 66  61 6c 73 65 0a 09 7d 0a   return false..}.
1ffe0	0a 09 2f 2f 20 e8 ae a1  e7 ae 97 e8 b6 8b e5 8a   ..// ...........
1fff0	bf e5 bc ba e5 ba a6 0a  09 74 72 65 6e 64 20 3a   .........trend :
20000	3d 20 62 65 2e 63 61 6c  63 75 6c 61 74 65 50 72   = be.calculatePr
20010	69 63 65 54 72 65 6e 64  28 72 65 63 65 6e 74 50   iceTrend(recentP
20020	72 69 63 65 73 29 0a 0a  09 2f 2f 20 e8 ae a1 e7   rices)...// ....
20030	ae 97 52 53 49 ef bc 88  e7 ae 80 e5 8c 96 e7 89   ..RSI...........
20040	88 ef bc 89 0a 09 72 73  69 20 3a 3d 20 62 65 2e   ......rsi := be.
20050	63 61 6c 63 75 6c 61 74  65 53 69 6d 70 6c 65 52   calculateSimpleR
20060	53 49 28 72 65 63 65 6e  74 50 72 69 63 65 73 2c   SI(recentPrices,
20070	20 31 34 29 0a 0a 09 2f  2f 20 e8 ae a1 e7 ae 97    14)...// ......
20080	e5 8a a8 e9 87 8f ef bc  88 e7 ae 80 e5 8c 96 e7   ................
20090	89 88 ef bc 89 0a 09 6d  6f 6d 65 6e 74 75 6d 20   .......momentum 
200a0	3a 3d 20 62 65 2e 63 61  6c 63 75 6c 61 74 65 53   := be.calculateS
200b0	69 6d 70 6c 65 4d 6f 6d  65 6e 74 75 6d 28 72 65   impleMomentum(re
200c0	63 65 6e 74 50 72 69 63  65 73 2c 20 31 30 29 0a   centPrices, 10).
200d0	0a 09 2f 2f 20 e7 86 8a  e5 b8 82 e5 88 a4 e6 96   ..// ...........
200e0	ad e6 9d a1 e4 bb b6 ef  bc 9a 0a 09 2f 2f 20 31   ............// 1
200f0	2e 20 e4 b8 8b e8 b7 8c  e8 b6 8b e5 8a bf e6 98   . ..............
20100	8e e6 98 be ef bc 88 74  72 65 6e 64 20 3c 20 2d   .......trend < -
20110	30 2e 30 32 ef bc 89 0a  09 2f 2f 20 32 2e 20 52   0.02.....// 2. R
20120	53 49 e7 9b b8 e5 af b9  e8 be 83 e4 bd 8e ef bc   SI..............
20130	88 3c 20 34 35 ef bc 89  e6 88 96 e6 9e 81 e5 ba   .< 45...........
20140	a6 e8 b6 85 e5 8d 96 ef  bc 88 3c 20 33 30 ef bc   ..........< 30..
20150	89 0a 09 2f 2f 20 33 2e  20 e8 b4 9f e5 8a a8 e9   ...// 3. .......
20160	87 8f ef bc 88 3c 20 2d  30 2e 30 32 ef bc 89 0a   .....< -0.02....
20170	0a 09 62 65 61 72 69 73  68 43 6f 6e 64 69 74 69   ..bearishConditi
20180	6f 6e 73 20 3a 3d 20 30  0a 09 74 6f 74 61 6c 43   ons := 0..totalC
20190	6f 6e 64 69 74 69 6f 6e  73 20 3a 3d 20 33 0a 0a   onditions := 3..
201a0	09 69 66 20 74 72 65 6e  64 20 3c 20 2d 30 2e 30   .if trend < -0.0
201b0	32 20 7b 0a 09 09 62 65  61 72 69 73 68 43 6f 6e   2 {...bearishCon
201c0	64 69 74 69 6f 6e 73 2b  2b 0a 09 7d 0a 0a 09 69   ditions++..}...i
201d0	66 20 72 73 69 20 3c 20  34 35 20 7b 0a 09 09 62   f rsi < 45 {...b
201e0	65 61 72 69 73 68 43 6f  6e 64 69 74 69 6f 6e 73   earishConditions
201f0	2b 2b 0a 09 7d 0a 0a 09  69 66 20 6d 6f 6d 65 6e   ++..}...if momen
20200	74 75 6d 20 3c 20 2d 30  2e 30 32 20 7b 0a 09 09   tum < -0.02 {...
20210	62 65 61 72 69 73 68 43  6f 6e 64 69 74 69 6f 6e   bearishCondition
20220	73 2b 2b 0a 09 7d 0a 0a  09 2f 2f 20 e5 a6 82 e6   s++..}...// ....
20230	9e 9c e7 86 8a e5 b8 82  e6 9d a1 e4 bb b6 e5 8d   ................
20240	a0 e6 af 94 e8 b6 85 e8  bf 87 35 30 25 ef bc 8c   ..........50%...
20250	e8 ae a4 e4 b8 ba e6 98  af e7 86 8a e5 b8 82 0a   ................
20260	09 72 65 74 75 72 6e 20  66 6c 6f 61 74 36 34 28   .return float64(
20270	62 65 61 72 69 73 68 43  6f 6e 64 69 74 69 6f 6e   bearishCondition
20280	73 29 2f 66 6c 6f 61 74  36 34 28 74 6f 74 61 6c   s)/float64(total
20290	43 6f 6e 64 69 74 69 6f  6e 73 29 20 3e 20 30 2e   Conditions) > 0.
202a0	35 0a 7d 0a 0a 2f 2f 20  63 61 6c 63 75 6c 61 74   5.}..// calculat
202b0	65 53 69 6d 70 6c 65 52  53 49 20 e8 ae a1 e7 ae   eSimpleRSI .....
202c0	97 e7 ae 80 e5 8c 96 e7  9a 84 52 53 49 e6 8c 87   ..........RSI...
202d0	e6 a0 87 0a 66 75 6e 63  20 28 62 65 20 2a 42 61   ....func (be *Ba
202e0	63 6b 74 65 73 74 45 6e  67 69 6e 65 29 20 63 61   cktestEngine) ca
202f0	6c 63 75 6c 61 74 65 53  69 6d 70 6c 65 52 53 49   lculateSimpleRSI
20300	28 70 72 69 63 65 73 20  5b 5d 4d 61 72 6b 65 74   (prices []Market
20310	44 61 74 61 2c 20 70 65  72 69 6f 64 20 69 6e 74   Data, period int
20320	29 20 66 6c 6f 61 74 36  34 20 7b 0a 09 69 66 20   ) float64 {..if 
20330	6c 65 6e 28 70 72 69 63  65 73 29 20 3c 20 70 65   len(prices) < pe
20340	72 69 6f 64 2b 31 20 7b  0a 09 09 72 65 74 75 72   riod+1 {...retur
20350	6e 20 35 30 2e 30 20 2f  2f 20 e9 bb 98 e8 ae a4   n 50.0 // ......
20360	e4 b8 ad e6 80 a7 e5 80  bc 0a 09 7d 0a 0a 09 67   ...........}...g
20370	61 69 6e 73 20 3a 3d 20  30 2e 30 0a 09 6c 6f 73   ains := 0.0..los
20380	73 65 73 20 3a 3d 20 30  2e 30 0a 0a 09 66 6f 72   ses := 0.0...for
20390	20 69 20 3a 3d 20 31 3b  20 69 20 3c 3d 20 70 65    i := 1; i <= pe
203a0	72 69 6f 64 3b 20 69 2b  2b 20 7b 0a 09 09 63 68   riod; i++ {...ch
203b0	61 6e 67 65 20 3a 3d 20  70 72 69 63 65 73 5b 6c   ange := prices[l
203c0	65 6e 28 70 72 69 63 65  73 29 2d 69 5d 2e 50 72   en(prices)-i].Pr
203d0	69 63 65 20 2d 20 70 72  69 63 65 73 5b 6c 65 6e   ice - prices[len
203e0	28 70 72 69 63 65 73 29  2d 69 2d 31 5d 2e 50 72   (prices)-i-1].Pr
203f0	69 63 65 0a 09 09 69 66  20 63 68 61 6e 67 65 20   ice...if change 
20400	3e 20 30 20 7b 0a 09 09  09 67 61 69 6e 73 20 2b   > 0 {....gains +
20410	3d 20 63 68 61 6e 67 65  0a 09 09 7d 20 65 6c 73   = change...} els
20420	65 20 7b 0a 09 09 09 6c  6f 73 73 65 73 20 2d 3d   e {....losses -=
20430	20 63 68 61 6e 67 65 0a  09 09 7d 0a 09 7d 0a 0a    change...}..}..
20440	09 69 66 20 6c 6f 73 73  65 73 20 3d 3d 20 30 20   .if losses == 0 
20450	7b 0a 09 09 72 65 74 75  72 6e 20 31 30 30 2e 30   {...return 100.0
20460	0a 09 7d 0a 0a 09 72 73  20 3a 3d 20 67 61 69 6e   ..}...rs := gain
20470	73 20 2f 20 6c 6f 73 73  65 73 0a 09 72 65 74 75   s / losses..retu
20480	72 6e 20 31 30 30 2e 30  20 2d 20 28 31 30 30 2e   rn 100.0 - (100.
20490	30 20 2f 20 28 31 2e 30  20 2b 20 72 73 29 29 0a   0 / (1.0 + rs)).
204a0	7d 0a 0a 2f 2f 20 63 61  6c 63 75 6c 61 74 65 53   }..// calculateS
204b0	69 6d 70 6c 65 4d 6f 6d  65 6e 74 75 6d 20 e8 ae   impleMomentum ..
204c0	a1 e7 ae 97 e7 ae 80 e5  8c 96 e7 9a 84 e5 8a a8   ................
204d0	e9 87 8f e6 8c 87 e6 a0  87 0a 66 75 6e 63 20 28   ..........func (
204e0	62 65 20 2a 42 61 63 6b  74 65 73 74 45 6e 67 69   be *BacktestEngi
204f0	6e 65 29 20 63 61 6c 63  75 6c 61 74 65 53 69 6d   ne) calculateSim
20500	70 6c 65 4d 6f 6d 65 6e  74 75 6d 28 70 72 69 63   pleMomentum(pric
20510	65 73 20 5b 5d 4d 61 72  6b 65 74 44 61 74 61 2c   es []MarketData,
20520	20 70 65 72 69 6f 64 20  69 6e 74 29 20 66 6c 6f    period int) flo
20530	61 74 36 34 20 7b 0a 09  69 66 20 6c 65 6e 28 70   at64 {..if len(p
20540	72 69 63 65 73 29 20 3c  20 70 65 72 69 6f 64 2b   rices) < period+
20550	31 20 7b 0a 09 09 72 65  74 75 72 6e 20 30 2e 30   1 {...return 0.0
20560	0a 09 7d 0a 0a 09 63 75  72 72 65 6e 74 50 72 69   ..}...currentPri
20570	63 65 20 3a 3d 20 70 72  69 63 65 73 5b 6c 65 6e   ce := prices[len
20580	28 70 72 69 63 65 73 29  2d 31 5d 2e 50 72 69 63   (prices)-1].Pric
20590	65 0a 09 70 61 73 74 50  72 69 63 65 20 3a 3d 20   e..pastPrice := 
205a0	70 72 69 63 65 73 5b 6c  65 6e 28 70 72 69 63 65   prices[len(price
205b0	73 29 2d 70 65 72 69 6f  64 2d 31 5d 2e 50 72 69   s)-period-1].Pri
205c0	63 65 0a 0a 09 72 65 74  75 72 6e 20 28 63 75 72   ce...return (cur
205d0	72 65 6e 74 50 72 69 63  65 20 2d 20 70 61 73 74   rentPrice - past
205e0	50 72 69 63 65 29 20 2f  20 70 61 73 74 50 72 69   Price) / pastPri
205f0	63 65 0a 7d 0a                                     ce.}.
